model ChatbotSession {
  id                      String           @id @default(uuid())
  sessionId               String           @unique // External session ID for API
  userId                  String? // Optional - allows anonymous sessions
  clientId                String? // Optional - allows anonymous sessions
  startedAt               DateTime         @default(now())
  completedAt             DateTime?
  isComplete              Boolean          @default(false)
  currentQuestionnaire    String? // Current questionnaire being administered
  completedQuestionnaires String[]         @default([]) // List of completed questionnaire names
  presentedQuestionnaires String[]         @default([]) // List of questionnaires shown as forms
  collectedAnswers        Json // Record<string, number[]> - questionnaire -> answers
  structuredAnswers       Json? // Record<string, number> - questionId -> answer for tool call questions
  conversationInsights    Json? // Extracted insights for matching
  completionReason        String? // Why conversation ended
  completionConfidence    Float? // AI confidence in completion (0-1)
  lastActivity            DateTime         @default(now())
  createdAt               DateTime         @default(now())
  updatedAt               DateTime         @updatedAt
  client                  Client?          @relation(fields: [clientId], references: [userId], onDelete: Cascade)
  preAssessment           PreAssessment?
  messages                ChatbotMessage[]

  @@index([userId])
  @@index([clientId])
  @@index([sessionId])
  @@index([isComplete])
  @@index([lastActivity])
  @@index([clientId, isComplete])
  @@index([userId, isComplete])
}

model ChatbotMessage {
  id                   String             @id @default(uuid())
  sessionId            String
  role                 ChatbotMessageRole
  content              String             @db.Text
  questionnaireContext String? // Which questionnaire this message relates to
  extractedAnswer      Int? // Structured answer if extracted (0-4 scale typically)
  timestamp            DateTime           @default(now())
  createdAt            DateTime           @default(now())
  session              ChatbotSession     @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([sessionId, timestamp])
  @@index([role])
  @@index([timestamp])
}

enum ChatbotMessageRole {
  SYSTEM
  USER
  ASSISTANT
}
