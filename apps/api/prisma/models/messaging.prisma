model Conversation {
  id            String                    @id @default(uuid())
  type          ConversationType          @default(DIRECT)
  title         String?
  isActive      Boolean                   @default(true)
  lastMessageAt DateTime?
  createdAt     DateTime                  @default(now())
  updatedAt     DateTime                  @updatedAt
  participants  ConversationParticipant[]
  messages      Message[]

  @@index([lastMessageAt])
  @@index([isActive])
  @@index([type])
  @@index([type, lastMessageAt])
  @@index([type, isActive, lastMessageAt])
  @@index([createdAt])
  @@index([isActive, lastMessageAt])
}

model ConversationParticipant {
  id             String          @id @default(uuid())
  conversationId String
  userId         String
  joinedAt       DateTime        @default(now())
  lastReadAt     DateTime?
  role           ParticipantRole @default(MEMBER)
  isActive       Boolean         @default(true)
  isMuted        Boolean         @default(false)
  conversation   Conversation    @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user           User            @relation("UserConversations", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([conversationId, userId])
  @@index([userId])
  @@index([conversationId])
  @@index([isActive])
}

model Message {
  id              String               @id @default(uuid())
  conversationId  String
  senderId        String
  content         String
  messageType     MessageType          @default(TEXT)
  attachmentUrls  String[]             @default([])
  attachmentNames String[]             @default([])
  attachmentSizes Int[]                @default([])
  replyToId       String?
  isEdited        Boolean              @default(false)
  isDeleted       Boolean              @default(false)
  editedAt        DateTime?
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt
  conversation    Conversation         @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  replyTo         Message?             @relation("MessageReplies", fields: [replyToId], references: [id])
  replies         Message[]            @relation("MessageReplies")
  sender          User                 @relation("UserMessages", fields: [senderId], references: [id], onDelete: Cascade)
  reactions       MessageReaction[]
  readReceipts    MessageReadReceipt[]

  @@index([conversationId, createdAt, isDeleted])
  @@index([senderId])
  @@index([messageType])
  @@index([isDeleted])
  @@index([senderId, createdAt])
  @@index([conversationId, senderId, createdAt])
  @@index([replyToId])
  @@index([conversationId, messageType])
}

model MessageReadReceipt {
  id        String   @id @default(uuid())
  messageId String
  userId    String
  readAt    DateTime @default(now())
  message   Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user      User     @relation("UserReadReceipts", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([messageId, userId])
  @@index([messageId])
  @@index([userId])
}

model MessageReaction {
  id        String   @id @default(uuid())
  messageId String
  userId    String
  emoji     String
  createdAt DateTime @default(now())
  message   Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user      User     @relation("UserMessageReactions", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([messageId, userId, emoji])
  @@index([messageId])
  @@index([userId])
}

model TypingIndicator {
  id             String   @id @default(uuid())
  conversationId String
  userId         String
  isTyping       Boolean  @default(true)
  lastTypingAt   DateTime @default(now())

  @@unique([conversationId, userId])
  @@index([conversationId])
  @@index([lastTypingAt])
}

model UserBlock {
  id        String   @id @default(uuid())
  blockerId String
  blockedId String
  reason    String?
  createdAt DateTime @default(now())
  blocked   User     @relation("UserBlocked", fields: [blockedId], references: [id], onDelete: Cascade)
  blocker   User     @relation("UserBlocking", fields: [blockerId], references: [id], onDelete: Cascade)

  @@unique([blockerId, blockedId])
  @@index([blockerId])
  @@index([blockedId])
}

enum ConversationType {
  DIRECT
  GROUP
  SESSION
  SUPPORT
}

enum ParticipantRole {
  MEMBER
  ADMIN
}

enum MessageType {
  TEXT
  IMAGE
  AUDIO
  VIDEO
  SYSTEM
}
