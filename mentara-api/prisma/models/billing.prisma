// Billing and Payment Models
// This file contains models for subscription management, payments, and billing

model Subscription {
  id     String @id @default(uuid())
  userId String @unique

  // Subscription details
  planId String
  status SubscriptionStatus @default(ACTIVE)
  tier   SubscriptionTier

  // Billing cycle
  billingCycle BillingCycle @default(MONTHLY)
  amount       Decimal      @db.Decimal(10, 2)
  currency     String       @default("USD")

  // Dates
  startedAt          DateTime  @default(now())
  currentPeriodStart DateTime
  currentPeriodEnd   DateTime
  trialStart         DateTime?
  trialEnd           DateTime?
  canceledAt         DateTime?
  endedAt            DateTime?

  // Payment method
  defaultPaymentMethodId String?

  // Metadata
  metadata     Json?
  cancelReason String?
  canceledBy   String? // User ID who canceled

  // Relations
  user                 User             @relation("UserSubscription", fields: [userId], references: [id], onDelete: Cascade)
  plan                 SubscriptionPlan @relation(fields: [planId], references: [id])
  defaultPaymentMethod PaymentMethod?   @relation(fields: [defaultPaymentMethodId], references: [id], onDelete: SetNull)
  invoices             Invoice[]
  usageRecords         UsageRecord[]
  payments             Payment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([planId])
  @@index([status])
  @@index([currentPeriodEnd])
}

model SubscriptionPlan {
  id String @id @default(uuid())

  // Plan details
  name        String           @unique
  description String?          @db.Text
  tier        SubscriptionTier
  isActive    Boolean          @default(true)

  // Pricing
  monthlyPrice Decimal  @db.Decimal(10, 2)
  yearlyPrice  Decimal? @db.Decimal(10, 2)
  currency     String   @default("USD")

  // Plan features
  features Json // Array of feature objects
  limits   Json // Usage limits and restrictions

  // Trial configuration
  trialDays Int? // Free trial period in days

  // External IDs (for payment providers)
  stripeProductId String? @unique
  stripePriceIds  Json? // Monthly/yearly price IDs

  // Relations
  subscriptions Subscription[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tier])
  @@index([isActive])
}

model PaymentMethod {
  id     String @id @default(uuid())
  userId String

  // Payment method details
  type     PaymentMethodType
  provider PaymentProvider   @default(STRIPE)

  // Card details (if applicable)
  cardLast4    String?
  cardBrand    String?
  cardExpMonth Int?
  cardExpYear  Int?

  // External IDs
  stripePaymentMethodId String? @unique

  // Status
  isDefault Boolean @default(false)
  isActive  Boolean @default(true)

  // Metadata
  metadata Json?

  // Relations
  user          User           @relation("UserPaymentMethods", fields: [userId], references: [id], onDelete: Cascade)
  subscriptions Subscription[]
  payments      Payment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([type])
  @@index([isDefault])
}

model Payment {
  id String @id @default(uuid())

  // Payment details
  amount          Decimal       @db.Decimal(10, 2)
  currency        String        @default("USD")
  status          PaymentStatus @default(PENDING)
  paymentMethodId String?

  // Related entities
  subscriptionId String?
  invoiceId      String?
  meetingId      String? // For session-based payments

  // Payment provider details
  provider          PaymentProvider @default(STRIPE)
  providerPaymentId String?         @unique
  providerFee       Decimal?        @db.Decimal(10, 2)

  // Processing details
  processedAt  DateTime?
  failedAt     DateTime?
  refundedAt   DateTime?
  refundAmount Decimal?  @db.Decimal(10, 2)

  // Failure information
  failureCode    String?
  failureMessage String?

  // Metadata
  description String?
  metadata    Json?

  // Relations
  paymentMethod PaymentMethod? @relation(fields: [paymentMethodId], references: [id], onDelete: SetNull)
  subscription  Subscription?  @relation(fields: [subscriptionId], references: [id], onDelete: SetNull)
  invoice       Invoice?       @relation(fields: [invoiceId], references: [id], onDelete: SetNull)
  meeting       Meeting?       @relation(fields: [meetingId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([subscriptionId])
  @@index([invoiceId])
  @@index([processedAt])
}

model Invoice {
  id             String @id @default(uuid())
  subscriptionId String

  // Invoice details
  number String        @unique // Human-readable invoice number
  status InvoiceStatus @default(DRAFT)

  // Amounts
  subtotal       Decimal  @db.Decimal(10, 2)
  taxAmount      Decimal? @db.Decimal(10, 2)
  discountAmount Decimal? @db.Decimal(10, 2)
  total          Decimal  @db.Decimal(10, 2)
  amountPaid     Decimal  @default(0) @db.Decimal(10, 2)
  amountDue      Decimal  @db.Decimal(10, 2)
  currency       String   @default("USD")

  // Dates
  issueDate DateTime  @default(now())
  dueDate   DateTime
  paidAt    DateTime?
  voidedAt  DateTime?

  // Billing details
  billingAddress Json? // Billing address object
  taxIds         Json? // Tax identification numbers

  // External references
  stripeInvoiceId String? @unique

  // Relations
  subscription Subscription      @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  lineItems    InvoiceLineItem[]
  payments     Payment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([subscriptionId])
  @@index([status])
  @@index([dueDate])
  @@index([number])
}

model InvoiceLineItem {
  id        String @id @default(uuid())
  invoiceId String

  // Line item details
  description String
  quantity    Int     @default(1)
  unitPrice   Decimal @db.Decimal(10, 2)
  amount      Decimal @db.Decimal(10, 2)

  // Product/service details
  productId   String?
  productName String?

  // Period this line item covers
  periodStart DateTime?
  periodEnd   DateTime?

  // Relations
  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
}

model UsageRecord {
  id             String @id @default(uuid())
  subscriptionId String

  // Usage details
  feature  String // What feature was used
  quantity Int // How much was used
  unit     String // Unit of measurement

  // Timing
  usageDate  DateTime
  recordedAt DateTime @default(now())

  // Metadata
  metadata Json?

  // Relations
  subscription Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@index([subscriptionId])
  @@index([feature])
  @@index([usageDate])
}

model Discount {
  id String @id @default(uuid())

  // Discount details
  code        String?      @unique // Promo code
  name        String
  description String?      @db.Text
  type        DiscountType

  // Discount value
  percentOff Decimal? @db.Decimal(5, 2) // 0.00 to 100.00
  amountOff  Decimal? @db.Decimal(10, 2)
  currency   String?  @default("USD")

  // Validity
  isActive   Boolean   @default(true)
  validFrom  DateTime  @default(now())
  validUntil DateTime?

  // Usage limits
  maxUses        Int? // Maximum total uses
  maxUsesPerUser Int? // Maximum uses per user
  currentUses    Int  @default(0)

  // Applicable plans
  applicableTiers SubscriptionTier[]
  minAmount       Decimal?           @db.Decimal(10, 2) // Minimum order amount

  // Relations
  redemptions DiscountRedemption[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([code])
  @@index([isActive])
  @@index([validFrom, validUntil])
}

model DiscountRedemption {
  id         String @id @default(uuid())
  discountId String
  userId     String

  // Redemption details
  amountSaved Decimal @db.Decimal(10, 2)
  currency    String  @default("USD")

  // Relations
  discount Discount @relation(fields: [discountId], references: [id], onDelete: Cascade)
  user     User     @relation("UserDiscountRedemptions", fields: [userId], references: [id], onDelete: Cascade)

  redeemedAt DateTime @default(now())

  @@unique([discountId, userId])
  @@index([discountId])
  @@index([userId])
}

// Enums
enum SubscriptionStatus {
  ACTIVE
  TRIALING
  PAST_DUE
  CANCELED
  UNPAID
  INCOMPLETE
  INCOMPLETE_EXPIRED
  PAUSED
}

enum SubscriptionTier {
  FREE
  BASIC
  PREMIUM
  PROFESSIONAL
  ENTERPRISE
}

enum BillingCycle {
  MONTHLY
  QUARTERLY
  YEARLY
}

enum PaymentMethodType {
  CARD
  BANK_ACCOUNT
  DIGITAL_WALLET
  CRYPTO
}

enum PaymentProvider {
  STRIPE
  PAYPAL
  SQUARE
  BANK_TRANSFER
}

enum PaymentStatus {
  PENDING
  PROCESSING
  SUCCEEDED
  FAILED
  CANCELED
  REFUNDED
  PARTIALLY_REFUNDED
}

enum InvoiceStatus {
  DRAFT
  OPEN
  PAID
  UNCOLLECTIBLE
  VOID
}

enum DiscountType {
  PERCENTAGE
  FIXED_AMOUNT
  FREE_TRIAL_EXTENSION
}
