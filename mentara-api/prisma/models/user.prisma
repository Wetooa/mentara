model User {
    id         String    @id @unique @default(uuid()) // Local user ID for authentication
    email      String    @unique // User's email address
    firstName  String
    middleName String?
    lastName   String
    birthDate  DateTime?
    address    String?
    avatarUrl  String? // Profile image URL
    role       String    @default("client") // client, therapist, moderator, admin
    createdAt  DateTime  @default(now())
    updatedAt  DateTime  @updatedAt

    // Authentication fields for local auth
    password              String? // Hashed password (nullable for migration compatibility)
    emailVerified         Boolean   @default(false) // Email verification status
    emailVerifyToken      String?   @unique // Token for email verification
    emailVerifyTokenExp   DateTime? // Email verification token expiry
    resetToken            String?   @unique // Password reset token
    resetTokenExpiry      DateTime? // Password reset token expiry
    lastLoginAt           DateTime? // Last successful login
    failedLoginCount      Int       @default(0) // Failed login attempts
    lockoutUntil          DateTime? // Account lockout until timestamp
    twoFactorEnabled      Boolean   @default(false) // Two-factor authentication
    twoFactorSecret       String? // 2FA secret key

    // Account status and deactivation
    deactivatedAt         DateTime? // When account was deactivated
    deactivatedBy         String? // Who deactivated the account
    deactivationReason    String? // Reason for deactivation

    // Profile and verification
    bio           String?
    coverImageUrl String?
    isActive      Boolean @default(true)
    isVerified    Boolean @default(false)

    // Contact information
    phoneNumber   String?
    phoneVerified Boolean @default(false)

    // Preferences
    timezone String? @default("UTC")
    language String? @default("en")
    theme    String? @default("light")

    // Privacy settings
    profileVisibility String @default("private") // public, private, therapists_only
    allowMessagesFrom String @default("therapists") // all, therapists, none

    // Account status
    lastActiveAt     DateTime?
    suspendedAt      DateTime?
    suspendedBy      String?
    suspensionReason String?

    // Community and content relations (available to all users)
    memberships   Membership[]
    posts         Post[]
    comments      Comment[]
    postHearts    PostHeart[]
    commentHearts CommentHeart[]
    
    // Community recommendation system relations
    communityRecommendations CommunityRecommendation[] @relation("UserCommunityRecommendations")
    joinRequests            CommunityJoinRequest[]     @relation("UserJoinRequests")
    moderatedJoinRequests   CommunityJoinRequest[]     @relation("ModeratedJoinRequests")

    // Role-specific relations
    client    Client?    @relation("UserClient")
    therapist Therapist? @relation("UserTherapist")
    moderator Moderator? @relation("UserModerator")
    admin     Admin?     @relation("UserAdmin")

    replies        Reply[]
    replyHearts    ReplyHeart[]
    reviewsHelpful ReviewHelpful[]

    // Messaging relations
    conversations       ConversationParticipant[] @relation("UserConversations")
    sentMessages        Message[]                 @relation("UserMessages")
    messageReadReceipts MessageReadReceipt[]      @relation("UserReadReceipts")
    messageReactions    MessageReaction[]         @relation("UserMessageReactions")
    blocking            UserBlock[]               @relation("UserBlocking")
    blockedBy           UserBlock[]               @relation("UserBlocked")

    // Notification relations
    notifications        Notification[]        @relation("UserNotifications")
    notificationSettings NotificationSettings? @relation("UserNotificationSettings")

    // Audit and activity relations
    auditLogs  AuditLog[]     @relation("UserAuditLogs")
    activities UserActivity[] @relation("UserActivities")

    // File relations
    uploadedFiles File[]         @relation("UserUploadedFiles")
    fileVersions  FileVersion[]  @relation("UserFileVersions")
    fileShares    FileShare[]    @relation("UserFileShares")
    fileDownloads FileDownload[] @relation("UserFileDownloads")

    // Billing relations
    subscription        Subscription?        @relation("UserSubscription")
    paymentMethods      PaymentMethod[]      @relation("UserPaymentMethods")
    discountRedemptions DiscountRedemption[] @relation("UserDiscountRedemptions")
    stripeCustomerId    String?              @unique // Stripe customer ID

    // Authentication relations
    refreshTokens RefreshToken[] @relation("UserRefreshTokens")

    // Push notification relations
    deviceTokens             DeviceToken[]             @relation("UserDeviceTokens")
    scheduledNotifications   ScheduledNotification[]   @relation("UserScheduledNotifications")

    // Reddit-like features relations
    postVotes                PostVote[]                @relation("UserPostVotes")
    commentVotes             CommentVote[]             @relation("UserCommentVotes")
    givenAwards              PostAward[]               @relation("UserGivenAwards")
    givenCommentAwards       CommentAward[]            @relation("UserGivenCommentAwards")
    reports                  ContentReport[]           @relation("UserReports")
    moderatedReports         ContentReport[]           @relation("UserModeratedReports")
    savedContent             SavedContent[]            @relation("UserSavedContent")
    karma                    UserKarma?                @relation("UserKarma")

    @@index([email])
    @@index([role])
    @@index([emailVerifyToken])
    @@index([resetToken])
    @@index([deactivatedAt])
}

model Client {
    userId String @unique
    user   User   @relation("UserClient", fields: [userId], references: [id], onDelete: Cascade)

    // Patient-specific relations
    worksheets             Worksheet[]
    preAssessment          PreAssessment?
    worksheetSubmissions   WorksheetSubmission[]
    clientMedicalHistory   ClientMedicalHistory[]
    clientPreferences      ClientPreference[]
    assignedTherapists     ClientTherapist[]
    sentRequests           ClientTherapistRequest[] // Therapist requests sent by this client
    meetings               Meeting[]               @relation("ClientMeetings")
    reviews                Review[] // Reviews written by this client
    sessionLogs            SessionLog[]
    therapyProgress        TherapyProgress[]
    assessments            Assessment[]
    mentalHealthIndicators MentalHealthIndicator[]

    // Matching analytics relations
    matchHistory            MatchHistory[]
    clientCompatibility     ClientCompatibility[]
    recommendationFeedback  RecommendationFeedback[]

    hasSeenTherapistRecommendations Boolean @default(false)

    createdAt DateTime @default(now())
    updatedAt DateTime @default(now())

    @@index([userId])
}

model Moderator {
    userId String @unique
    user   User   @relation("UserModerator", fields: [userId], references: [id], onDelete: Cascade)

    // Moderator-specific fields
    permissions         String[] // Array of moderator permissions
    assignedCommunities Json? // Communities they moderate

    createdAt            DateTime             @default(now())
    updatedAt            DateTime             @updatedAt
    moderatorCommunities ModeratorCommunity[]

    @@index([userId])
}

model Admin {
    userId String @unique
    user   User   @relation("UserAdmin", fields: [userId], references: [id], onDelete: Cascade)

    // Admin-specific fields
    permissions         String[] // Array of admin permissions
    adminLevel          String      @default("admin") // admin, super_admin, etc.
    processedTherapists Therapist[]

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@index([userId])
}
