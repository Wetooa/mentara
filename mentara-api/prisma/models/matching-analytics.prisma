// Matching Analytics Models for tracking therapist recommendation performance

model MatchingWeight {
    id   String @id @default(uuid())
    name String @unique // e.g., "conditionMatch", "approachCompatibility"
    
    weight      Float   @db.DoublePrecision // Weight value (0.0 to 1.0)
    description String? // Description of what this weight represents
    
    isActive  Boolean @default(true)
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
    
    @@index([name])
    @@index([isActive])
}

model MatchHistory {
    id         String @id @default(uuid())
    clientId   String
    therapistId String
    
    // Matching scores
    totalScore              Int
    conditionScore          Int
    approachScore           Int
    experienceScore         Int
    reviewScore             Int
    logisticsScore          Int
    compatibilityScore      Int?
    
    // Match explanation data
    primaryMatches          String[] // Matched primary conditions
    secondaryMatches        String[] // Matched secondary conditions
    approachMatches         String[] // Matched therapeutic approaches
    
    // Recommendation context
    recommendationRank      Int      // Position in recommendation list (1st, 2nd, etc.)
    totalRecommendations    Int      // Total therapists recommended
    
    // Outcome tracking
    wasViewed               Boolean  @default(false)
    wasContacted            Boolean  @default(false)
    becameClient            Boolean  @default(false)
    sessionCount            Int      @default(0)
    clientSatisfactionScore Int?     // 1-5 rating after sessions
    
    // Metadata
    recommendationAlgorithm String   @default("advanced") // "basic", "advanced", "ml"
    userAgent               String?  // For tracking recommendation source
    
    client    Client    @relation(fields: [clientId], references: [userId], onDelete: Cascade)
    therapist Therapist @relation(fields: [therapistId], references: [userId], onDelete: Cascade)
    feedback  RecommendationFeedback[]
    
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
    
    @@unique([clientId, therapistId, createdAt])
    @@index([clientId])
    @@index([therapistId])
    @@index([totalScore])
    @@index([recommendationRank])
    @@index([becameClient])
    @@index([createdAt])
}

model ClientCompatibility {
    id          String @id @default(uuid())
    clientId    String
    therapistId String
    
    // Compatibility scores (0-100)
    personalityCompatibility  Int
    sessionCompatibility      Int
    demographicCompatibility  Int
    overallCompatibility      Int
    
    // Detailed compatibility breakdown
    communicationStyleScore   Int
    personalityMatchScore     Int
    culturalCompatibilityScore Int
    formatMatchScore          Int
    durationMatchScore        Int
    frequencyMatchScore       Int
    schedulingCompatibilityScore Int
    ageCompatibilityScore     Int
    genderCompatibilityScore  Int
    languageCompatibilityScore Int
    
    // Compatibility factors
    strengths       String[] // Array of compatibility strengths
    concerns        String[] // Array of compatibility concerns
    recommendations String[] // Array of recommendations
    
    // Metadata
    analysisVersion String   @default("1.0") // Version of compatibility algorithm
    
    client    Client    @relation(fields: [clientId], references: [userId], onDelete: Cascade)
    therapist Therapist @relation(fields: [therapistId], references: [userId], onDelete: Cascade)
    
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
    
    @@unique([clientId, therapistId])
    @@index([clientId])
    @@index([therapistId])
    @@index([overallCompatibility])
    @@index([createdAt])
}

model RecommendationFeedback {
    id                  String @id @default(uuid())
    clientId            String
    therapistId         String
    matchHistoryId      String?
    
    // Feedback scores (1-5)
    relevanceScore      Int     // How relevant was this recommendation?
    accuracyScore       Int     // How accurate was the match prediction?
    helpfulnessScore    Int     // How helpful was the recommendation?
    
    // Feedback details
    feedbackText        String? @db.Text
    selectedTherapist   Boolean @default(false) // Did they choose this therapist?
    reasonNotSelected   String? // Why they didn't select this therapist
    
    // Follow-up outcomes
    hadInitialSession   Boolean @default(false)
    continuedTherapy    Boolean @default(false)
    overallSatisfaction Int?    // 1-5 rating of overall experience
    
    client      Client       @relation(fields: [clientId], references: [userId], onDelete: Cascade)
    therapist   Therapist    @relation(fields: [therapistId], references: [userId], onDelete: Cascade)
    matchHistory MatchHistory? @relation(fields: [matchHistoryId], references: [id], onDelete: SetNull)
    
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
    
    @@index([clientId])
    @@index([therapistId])
    @@index([selectedTherapist])
    @@index([createdAt])
}

model AlgorithmPerformance {
    id              String @id @default(uuid())
    algorithmName   String // "basic", "advanced", "ml_v1", etc.
    version         String @default("1.0")
    
    // Performance metrics
    totalRecommendations    Int
    successfulMatches       Int     // Became actual client-therapist pairs
    averageMatchScore       Float   @db.DoublePrecision
    averageSatisfactionScore Float? @db.DoublePrecision
    
    // Time period for these metrics
    periodStart     DateTime
    periodEnd       DateTime
    
    // Additional metrics
    clickThroughRate    Float @db.DoublePrecision // Percentage viewed
    conversionRate      Float @db.DoublePrecision // Percentage that became clients
    retentionRate       Float @db.DoublePrecision // Percentage that continued therapy
    
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
    
    @@index([algorithmName])
    @@index([version])
    @@index([periodStart, periodEnd])
    @@index([createdAt])
}

