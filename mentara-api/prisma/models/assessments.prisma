// Assessment and Questionnaire Models
// This file contains normalized models for mental health assessments

model Assessment {
  id       String @id @default(uuid())
  clientId String @unique

  // Assessment metadata
  status      AssessmentStatus @default(IN_PROGRESS)
  startedAt   DateTime         @default(now())
  completedAt DateTime?

  // AI Analysis results
  overallRisk     RiskLevel?
  primaryConcerns String[] // Top identified concerns
  recommendations String[] // AI recommendations
  confidenceScore Decimal?   @db.Decimal(5, 2) // 0.00 to 100.00

  // Relations
  client         Client                    @relation(fields: [clientId], references: [userId], onDelete: Cascade)
  questionnaires AssessmentQuestionnaire[]
  scores         AssessmentScore[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([clientId])
  @@index([status])
  @@index([completedAt])
}

model Questionnaire {
  id String @id @default(uuid())

  // Questionnaire details
  name        String                @unique
  displayName String
  description String?               @db.Text
  category    QuestionnaireCategory
  version     String                @default("1.0")

  // Configuration
  isActive  Boolean @default(true)
  timeLimit Int? // Time limit in minutes

  // Scoring configuration
  scoringType ScoringType @default(SUM)
  minScore    Int?
  maxScore    Int?

  // Relations
  questions   Question[]
  assessments AssessmentQuestionnaire[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([category])
  @@index([isActive])
}

model Question {
  id              String @id @default(uuid())
  questionnaireId String

  // Question details
  text         String       @db.Text
  questionType QuestionType
  isRequired   Boolean      @default(true)
  order        Int

  // Validation rules
  validation Json? // Validation rules as JSON

  // Relations
  questionnaire Questionnaire    @relation(fields: [questionnaireId], references: [id], onDelete: Cascade)
  options       QuestionOption[]
  answers       Answer[]

  @@index([questionnaireId])
  @@index([order])
}

model QuestionOption {
  id         String @id @default(uuid())
  questionId String

  // Option details
  text  String
  value String // The actual value stored when selected
  order Int
  score Int? // Score weight for this option

  // Relations
  question Question @relation(fields: [questionId], references: [id], onDelete: Cascade)
  answers  Answer[]

  @@index([questionId])
  @@index([order])
}

model AssessmentQuestionnaire {
  id              String @id @default(uuid())
  assessmentId    String
  questionnaireId String

  // Completion tracking
  status      QuestionnaireStatus @default(NOT_STARTED)
  startedAt   DateTime?
  completedAt DateTime?
  timeSpent   Int? // Time spent in seconds

  // Relations
  assessment    Assessment    @relation(fields: [assessmentId], references: [id], onDelete: Cascade)
  questionnaire Questionnaire @relation(fields: [questionnaireId], references: [id], onDelete: Cascade)
  answers       Answer[]

  @@unique([assessmentId, questionnaireId])
  @@index([assessmentId])
  @@index([questionnaireId])
  @@index([status])
}

model Answer {
  id                        String @id @default(uuid())
  assessmentQuestionnaireId String
  questionId                String

  // Answer data
  selectedOptionId     String?
  textResponse         String?   @db.Text
  numericResponse      Decimal?  @db.Decimal(10, 2)
  dateResponse         DateTime?
  booleanResponse      Boolean?
  multiSelectResponses String[] // For multi-select questions

  // Metadata
  responseTime Int? // Time taken to answer in seconds
  wasSkipped   Boolean @default(false)

  // Relations
  assessmentQuestionnaire AssessmentQuestionnaire @relation(fields: [assessmentQuestionnaireId], references: [id], onDelete: Cascade)
  question                Question                @relation(fields: [questionId], references: [id], onDelete: Cascade)
  selectedOption          QuestionOption?         @relation(fields: [selectedOptionId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([assessmentQuestionnaireId, questionId])
  @@index([assessmentQuestionnaireId])
  @@index([questionId])
  @@index([selectedOptionId])
}

model AssessmentScore {
  id           String @id @default(uuid())
  assessmentId String

  // Score details
  category        String // What this score measures (e.g., "depression", "anxiety")
  rawScore        Decimal       @db.Decimal(10, 2)
  normalizedScore Decimal       @db.Decimal(5, 2) // 0.00 to 100.00
  severityLevel   SeverityLevel

  // Score metadata
  calculatedBy String // Algorithm or questionnaire that calculated this
  confidence   Decimal? @db.Decimal(5, 2) // Confidence in this score

  // Interpretation
  interpretation  String?  @db.Text
  recommendations String[]

  // Relations
  assessment Assessment @relation(fields: [assessmentId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([assessmentId])
  @@index([category])
  @@index([severityLevel])
}

model MentalHealthIndicator {
  id       String @id @default(uuid())
  clientId String

  // Indicator details
  indicator IndicatorType
  value     Decimal       @db.Decimal(10, 2)
  unit      String? // Unit of measurement

  // Context
  source IndicatorSource
  notes  String?         @db.Text

  // Relations
  client Client @relation(fields: [clientId], references: [userId], onDelete: Cascade)

  recordedAt DateTime @default(now())

  @@index([clientId])
  @@index([indicator])
  @@index([recordedAt])
}

// Enums
enum AssessmentStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
  ABANDONED
  EXPIRED
}

enum QuestionnaireCategory {
  DEPRESSION
  ANXIETY
  STRESS
  TRAUMA_PTSD
  SUBSTANCE_USE
  EATING_DISORDERS
  SLEEP_DISORDERS
  ADHD
  BIPOLAR
  PERSONALITY
  SOCIAL_ANXIETY
  PANIC_DISORDER
  OCD
  GENERAL_WELLBEING
}

enum QuestionType {
  SINGLE_CHOICE // Radio buttons
  MULTIPLE_CHOICE // Checkboxes
  TEXT_SHORT // Short text input
  TEXT_LONG // Long text area
  NUMERIC // Number input
  SCALE // Likert scale (1-5, 1-10, etc.)
  DATE // Date picker
  BOOLEAN // Yes/No, True/False
  SLIDER // Slider input
  RANKING // Rank items in order
}

enum ScoringType {
  SUM // Sum of all scores
  AVERAGE // Average of all scores
  WEIGHTED // Weighted average
  CUSTOM // Custom scoring algorithm
}

enum QuestionnaireStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
  SKIPPED
  TIMEOUT
}

enum RiskLevel {
  MINIMAL
  MILD
  MODERATE
  MODERATELY_SEVERE
  SEVERE
  CRITICAL
}

enum SeverityLevel {
  NONE
  MINIMAL
  MILD
  MODERATE
  SEVERE
  EXTREME
}

enum IndicatorType {
  MOOD_RATING
  ANXIETY_LEVEL
  SLEEP_QUALITY
  ENERGY_LEVEL
  SOCIAL_FUNCTIONING
  WORK_PERFORMANCE
  APPETITE
  CONCENTRATION
  MEDICATION_ADHERENCE
  EXERCISE_FREQUENCY
  SUBSTANCE_USE
  SELF_HARM_THOUGHTS
  SUICIDAL_IDEATION
}

enum IndicatorSource {
  SELF_REPORT
  THERAPIST_ASSESSMENT
  AUTOMATED_TRACKING
  FAMILY_REPORT
  MEDICAL_RECORD
  WEARABLE_DEVICE
}
