// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id          String       @id @default(uuid())
  clerkId     String?      @unique
  firstName   String
  middleName  String?
  lastName    String
  email       String?
  birthDate   DateTime
  address     String
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  avatarUrl   String?
  
  // Relations
  posts       Post[]
  comments    Comment[]
  memberships Membership[]
  worksheets  Worksheet[]

  @@index([clerkId])
}

model Community {
  id          String       @id @default(uuid())
  name        String
  description String
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  
  // Relations
  members     Membership[]
  posts       Post[]
}

model Membership {
  id          String    @id @default(uuid())
  userId      String
  communityId String
  role        String // You can add roles like 'Member', 'Admin', etc.
  joinedAt    DateTime  @default(now())
  
  // Relations
  community   Community @relation(fields: [communityId], references: [id])
  user        User      @relation(fields: [userId], references: [id])
}

model PostFile {
  id     String @id @default(uuid())
  url    String
  postId String
  
  // Relations
  post   Post   @relation(fields: [postId], references: [id])
}

model CommentFile {
  id        String  @id @default(uuid())
  url       String
  commentId String
  
  // Relations
  comment   Comment @relation(fields: [commentId], references: [id])
}

model Post {
  id          String     @id @default(uuid())
  title       String
  content     String
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  userId      String
  communityId String
  
  // Relations
  comments    Comment[]
  community   Community  @relation(fields: [communityId], references: [id])
  user        User       @relation(fields: [userId], references: [id])
  files       PostFile[]
}

model Comment {
  id        String        @id @default(uuid())
  content   String
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  postId    String
  userId    String
  parentId  String?
  
  // Relations
  parent    Comment?      @relation("CommentHierarchy", fields: [parentId], references: [id])
  replies   Comment[]     @relation("CommentHierarchy")
  post      Post          @relation(fields: [postId], references: [id])
  user      User          @relation(fields: [userId], references: [id])
  files     CommentFile[]
}

// Admin user model to store admin privileges
model AdminUser {
  id          String   @id @default(uuid())
  clerkUserId String   @unique // The ID from Clerk
  email       String   @unique
  role        String   @default("admin") // Could be "admin", "super_admin", etc.
  permissions String[] // Array of permissions
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([clerkUserId])
}

// Therapist application model
model TherapistApplication {
  id                                 String     @id @default(uuid())
  clerkUserId                        String?    @unique // Optional: Will be assigned if created from an authenticated user
  status                             String     @default("pending") // pending, approved, rejected
  submissionDate                     DateTime   @default(now())
  processingDate                     DateTime? // When the application was processed (approved/rejected)
  processedBy                        String? // Admin who processed the application
  applicationData                    Json // Store all application form data as JSON

  // Personal Info
  firstName                          String
  lastName                           String
  email                              String
  mobile                             String
  province                           String

  // Professional Info
  providerType                       String
  professionalLicenseType            String
  isPRCLicensed                      String
  prcLicenseNumber                   String
  expirationDateOfLicense            DateTime?
  isLicenseActive                    String
  yearsOfExperience                  String
  areasOfExpertise                   Json
  assessmentTools                    Json
  therapeuticApproachesUsedList      Json
  languagesOffered                   Json

  // Practice Details
  providedOnlineTherapyBefore        String
  comfortableUsingVideoConferencing  String
  weeklyAvailability                 String
  preferredSessionLength             String
  accepts                            Json

  // Compliance
  privateConfidentialSpace           String
  compliesWithDataPrivacyAct         String
  professionalLiabilityInsurance     String
  complaintsOrDisciplinaryActions    String
  willingToAbideByPlatformGuidelines String

  // Documents - Store file references
  uploadedDocuments                  Json?

  // If approved, reference to created therapist account
  therapist                          Therapist?

  createdAt                          DateTime   @default(now())
  updatedAt                          DateTime   @updatedAt

  @@index([status])
  @@index([email])
}

// Therapist model
model Therapist {
  id                      String                @id @default(uuid())
  clerkUserId             String                @unique
  email                   String                @unique
  firstName               String
  lastName                String
  mobile                  String
  province                String
  providerType            String
  professionalLicenseType String
  prcLicenseNumber        String?
  licensedSince           DateTime?
  licenseExpiration       DateTime?
  yearsOfExperience       Int?
  areasOfExpertise        Json
  therapeuticApproaches   Json
  languages               Json
  weeklyAvailability      String?
  sessionLength           String?
  accepts                 Json?
  profileComplete         Boolean               @default(false)
  applicationId           String?               @unique
  bio                     String?               @db.Text
  profileImageUrl         String?
  hourlyRate              Decimal?              @db.Decimal(10, 2)
  isActive                Boolean               @default(true)
  isVerified              Boolean               @default(false)
  createdAt               DateTime              @default(now())
  updatedAt               DateTime              @updatedAt
  
  // Relations
  application             TherapistApplication? @relation(fields: [applicationId], references: [id])
  worksheets              Worksheet[]

  @@index([clerkUserId])
}

// File upload model for storing uploaded file information
model FileUpload {
  id                     String   @id @default(uuid())
  fileName               String
  fileSize               Int
  fileType               String
  fileUrl                String
  docType                String
  uploadedBy             String? // Optional: Clerk user ID who uploaded the file
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt
  therapistApplicationId String?

  @@index([docType])
  @@index([uploadedBy])
}

model Worksheet {
  id           String                @id @default(uuid())
  title        String
  instructions String?
  assignedDate DateTime              @default(now())
  dueDate      DateTime
  status       String                @default("upcoming")
  isCompleted  Boolean               @default(false)
  submittedAt  DateTime?
  feedback     String?
  userId       String
  therapistId  String
  createdAt    DateTime              @default(now())
  updatedAt    DateTime              @updatedAt
  
  // Relations
  therapist    Therapist             @relation(fields: [therapistId], references: [id])
  user         User                  @relation(fields: [userId], references: [id])
  materials    WorksheetMaterial[]
  submissions  WorksheetSubmission[]

  @@index([userId])
  @@index([therapistId])
  @@index([status])
}

model WorksheetMaterial {
  id          String    @id @default(uuid())
  filename    String
  url         String
  fileSize    Int?
  fileType    String?
  worksheetId String
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  // Relations
  worksheet   Worksheet @relation(fields: [worksheetId], references: [id], onDelete: Cascade)

  @@index([worksheetId])
}

model WorksheetSubmission {
  id          String    @id @default(uuid())
  filename    String
  url         String
  fileSize    Int?
  fileType    String?
  worksheetId String
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  // Relations
  worksheet   Worksheet @relation(fields: [worksheetId], references: [id], onDelete: Cascade)

  @@index([worksheetId])
}