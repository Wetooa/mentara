{
  "info": {
    "name": "Mentara - Billing",
    "description": "Billing module endpoints for subscription management, payment processing, invoicing, and billing analytics for the Mentara mental health platform.",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json",
    "_exporter_id": "mentara-billing"
  },
  "auth": {
    "type": "bearer",
    "bearer": [
      {
        "key": "token",
        "value": "{{accessToken}}",
        "type": "string"
      }
    ]
  },
  "event": [
    {
      "listen": "prerequest",
      "script": {
        "type": "text/javascript",
        "exec": [
          "// Set Bearer token for authenticated requests",
          "if (pm.environment.get('accessToken') && !pm.request.headers.has('Authorization')) {",
          "    pm.request.headers.add({",
          "        key: 'Authorization',",
          "        value: 'Bearer ' + pm.environment.get('accessToken')",
          "    });",
          "}"
        ]
      }
    },
    {
      "listen": "test",
      "script": {
        "type": "text/javascript",
        "exec": [
          "// Global error handling for all requests",
          "pm.test('Response time is acceptable', function () {",
          "    pm.expect(pm.response.responseTime).to.be.below(5000);",
          "});",
          "",
          "// Auto-handle Zod validation errors",
          "if (pm.response.code === 400) {",
          "    try {",
          "        const responseJson = pm.response.json();",
          "        if (responseJson.issues && Array.isArray(responseJson.issues)) {",
          "            responseJson.issues.forEach(issue => {",
          "                console.error('❌ Validation Error: ' + issue.message + ' (' + issue.path.join('.') + ');',
          "            });"",
          "        }",
          "    } catch (e) {",
          "        console.error('❌ Failed to parse validation error response');",
          "    }",
          "}"
        ]
      }
    }
  ],
  "variable": [
    {
      "key": "baseUrl",
      "value": "http://localhost:3001/api",
      "type": "string"
    }
  ],
  "item": [
    {
      "name": "Subscription Management",
      "item": [
        {
          "name": "Get Current Subscription",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Subscription retrieved successfully', function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test('Subscription has required fields', function () {",
                  "    const responseJson = pm.response.json();",
                  "    pm.expect(responseJson).to.have.property('id');",
                  "    pm.expect(responseJson).to.have.property('plan');",
                  "    pm.expect(responseJson).to.have.property('status');",
                  "    pm.expect(responseJson).to.have.property('currentPeriodEnd');",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/billing/subscription",
              "host": ["{{baseUrl}}"],
              "path": ["billing", "subscription"]
            },
            "description": "Get current user subscription details"
          },
          "response": []
        },
        {
          "name": "Create Subscription",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Subscription created successfully', function () {",
                  "    pm.response.to.have.status(201);",
                  "});",
                  "",
                  "pm.test('Response has subscription ID', function () {",
                  "    const responseJson = pm.response.json();",
                  "    pm.expect(responseJson).to.have.property('subscriptionId');",
                  "    pm.environment.set('subscriptionId', responseJson.subscriptionId);",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"planId\": \"premium_monthly\",\n  \"paymentMethodId\": \"{{paymentMethodId}}\",\n  \"couponCode\": \"WELCOME10\",\n  \"billingAddress\": {\n    \"line1\": \"123 Main Street\",\n    \"line2\": \"Apt 4B\",\n    \"city\": \"New York\",\n    \"state\": \"NY\",\n    \"postalCode\": \"10001\",\n    \"country\": \"US\"\n  },\n  \"taxId\": \"12-3456789\",\n  \"startDate\": \"2024-01-01T00:00:00.000Z\",\n  \"trialPeriodDays\": 14\n}"
            },
            "url": {
              "raw": "{{baseUrl}}/billing/subscription",
              "host": ["{{baseUrl}}"],
              "path": ["billing", "subscription"]
            },
            "description": "Create new subscription"
          },
          "response": []
        },
        {
          "name": "Update Subscription",
          "request": {
            "method": "PUT",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"planId\": \"premium_annual\",\n  \"prorationBehavior\": \"always_invoice\",\n  \"billingCycleAnchor\": \"now\",\n  \"couponCode\": \"UPGRADE20\"\n}"
            },
            "url": {
              "raw": "{{baseUrl}}/billing/subscription/{{subscriptionId}}",
              "host": ["{{baseUrl}}"],
              "path": ["billing", "subscription", "{{subscriptionId}}"]
            },
            "description": "Update existing subscription"
          },
          "response": []
        },
        {
          "name": "Cancel Subscription",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"reason\": \"too_expensive\",\n  \"feedback\": \"The premium plan is outside my budget right now, but I may return in the future.\",\n  \"cancelAtPeriodEnd\": true,\n  \"sendConfirmation\": true\n}"
            },
            "url": {
              "raw": "{{baseUrl}}/billing/subscription/{{subscriptionId}}/cancel",
              "host": ["{{baseUrl}}"],
              "path": ["billing", "subscription", "{{subscriptionId}}", "cancel"]
            },
            "description": "Cancel subscription"
          },
          "response": []
        },
        {
          "name": "Resume Subscription",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"reason\": \"user_request\",\n  \"restoreFeatures\": true\n}"
            },
            "url": {
              "raw": "{{baseUrl}}/billing/subscription/{{subscriptionId}}/resume",
              "host": ["{{baseUrl}}"],
              "path": ["billing", "subscription", "{{subscriptionId}}", "resume"]
            },
            "description": "Resume canceled subscription"
          },
          "response": []
        },
        {
          "name": "Get Subscription History",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/billing/subscription/history?page=1&limit=20",
              "host": ["{{baseUrl}}"],
              "path": ["billing", "subscription", "history"],
              "query": [
                {
                  "key": "page",
                  "value": "1"
                },
                {
                  "key": "limit",
                  "value": "20"
                }
              ]
            },
            "description": "Get subscription change history"
          },
          "response": []
        }
      ]
    },
    {
      "name": "Payment Methods",
      "item": [
        {
          "name": "Get Payment Methods",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/billing/payment-methods",
              "host": ["{{baseUrl}}"],
              "path": ["billing", "payment-methods"]
            },
            "description": "Get user's payment methods"
          },
          "response": []
        },
        {
          "name": "Add Payment Method",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Payment method added successfully', function () {",
                  "    pm.response.to.have.status(201);",
                  "});",
                  "",
                  "pm.test('Response has payment method ID', function () {",
                  "    const responseJson = pm.response.json();",
                  "    pm.expect(responseJson).to.have.property('id');",
                  "    pm.environment.set('paymentMethodId', responseJson.id);",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"type\": \"card\",\n  \"cardToken\": \"tok_visa\",\n  \"billingAddress\": {\n    \"line1\": \"123 Main Street\",\n    \"line2\": \"Apt 4B\",\n    \"city\": \"New York\",\n    \"state\": \"NY\",\n    \"postalCode\": \"10001\",\n    \"country\": \"US\"\n  },\n  \"setAsDefault\": true\n}"
            },
            "url": {
              "raw": "{{baseUrl}}/billing/payment-methods",
              "host": ["{{baseUrl}}"],
              "path": ["billing", "payment-methods"]
            },
            "description": "Add new payment method"
          },
          "response": []
        },
        {
          "name": "Update Payment Method",
          "request": {
            "method": "PUT",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"billingAddress\": {\n    \"line1\": \"456 Oak Avenue\",\n    \"line2\": \"Unit 2A\",\n    \"city\": \"Boston\",\n    \"state\": \"MA\",\n    \"postalCode\": \"02101\",\n    \"country\": \"US\"\n  },\n  \"expiryMonth\": 12,\n  \"expiryYear\": 2025\n}"
            },
            "url": {
              "raw": "{{baseUrl}}/billing/payment-methods/{{paymentMethodId}}",
              "host": ["{{baseUrl}}"],
              "path": ["billing", "payment-methods", "{{paymentMethodId}}"]
            },
            "description": "Update payment method details"
          },
          "response": []
        },
        {
          "name": "Set Default Payment Method",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"paymentMethodId\": \"{{paymentMethodId}}\"\n}"
            },
            "url": {
              "raw": "{{baseUrl}}/billing/payment-methods/default",
              "host": ["{{baseUrl}}"],
              "path": ["billing", "payment-methods", "default"]
            },
            "description": "Set default payment method"
          },
          "response": []
        },
        {
          "name": "Delete Payment Method",
          "request": {
            "method": "DELETE",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/billing/payment-methods/{{paymentMethodId}}",
              "host": ["{{baseUrl}}"],
              "path": ["billing", "payment-methods", "{{paymentMethodId}}"]
            },
            "description": "Delete payment method"
          },
          "response": []
        }
      ]
    },
    {
      "name": "Invoices",
      "item": [
        {
          "name": "Get Invoices",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Invoices retrieved successfully', function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test('Response has invoices array', function () {",
                  "    const responseJson = pm.response.json();",
                  "    pm.expect(responseJson).to.have.property('invoices');",
                  "    pm.expect(responseJson.invoices).to.be.an('array');",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/billing/invoices?status=paid&page=1&limit=20&sortBy=createdAt&sortOrder=desc",
              "host": ["{{baseUrl}}"],
              "path": ["billing", "invoices"],
              "query": [
                {
                  "key": "status",
                  "value": "paid"
                },
                {
                  "key": "page",
                  "value": "1"
                },
                {
                  "key": "limit",
                  "value": "20"
                },
                {
                  "key": "sortBy",
                  "value": "createdAt"
                },
                {
                  "key": "sortOrder",
                  "value": "desc"
                }
              ]
            },
            "description": "Get user invoices with filtering"
          },
          "response": []
        },
        {
          "name": "Get Invoice by ID",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/billing/invoices/{{invoiceId}}",
              "host": ["{{baseUrl}}"],
              "path": ["billing", "invoices", "{{invoiceId}}"]
            },
            "description": "Get specific invoice details"
          },
          "response": []
        },
        {
          "name": "Download Invoice PDF",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/billing/invoices/{{invoiceId}}/download",
              "host": ["{{baseUrl}}"],
              "path": ["billing", "invoices", "{{invoiceId}}", "download"]
            },
            "description": "Download invoice as PDF"
          },
          "response": []
        },
        {
          "name": "Pay Invoice",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Invoice payment initiated', function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test('Payment status returned', function () {",
                  "    const responseJson = pm.response.json();",
                  "    pm.expect(responseJson).to.have.property('paymentStatus');",
                  "    pm.expect(responseJson).to.have.property('paymentIntentId');",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"paymentMethodId\": \"{{paymentMethodId}}\",\n  \"confirmPayment\": true\n}"
            },
            "url": {
              "raw": "{{baseUrl}}/billing/invoices/{{invoiceId}}/pay",
              "host": ["{{baseUrl}}"],
              "path": ["billing", "invoices", "{{invoiceId}}", "pay"]
            },
            "description": "Pay outstanding invoice"
          },
          "response": []
        },
        {
          "name": "Request Invoice Refund",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"reason\": \"service_not_as_described\",\n  \"description\": \"The premium features were not working as advertised during the billing period.\",\n  \"refundAmount\": 4999,\n  \"refundType\": \"partial\"\n}"
            },
            "url": {
              "raw": "{{baseUrl}}/billing/invoices/{{invoiceId}}/refund",
              "host": ["{{baseUrl}}"],
              "path": ["billing", "invoices", "{{invoiceId}}", "refund"]
            },
            "description": "Request refund for invoice"
          },
          "response": []
        }
      ]
    },
    {
      "name": "Billing Plans",
      "item": [
        {
          "name": "Get Available Plans",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/billing/plans?active=true&userType=client",
              "host": ["{{baseUrl}}"],
              "path": ["billing", "plans"],
              "query": [
                {
                  "key": "active",
                  "value": "true"
                },
                {
                  "key": "userType",
                  "value": "client"
                }
              ]
            },
            "description": "Get available billing plans"
          },
          "response": []
        },
        {
          "name": "Get Plan Details",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/billing/plans/{{planId}}",
              "host": ["{{baseUrl}}"],
              "path": ["billing", "plans", "{{planId}}"]
            },
            "description": "Get specific plan details"
          },
          "response": []
        },
        {
          "name": "Calculate Plan Pricing",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"planId\": \"premium_monthly\",\n  \"couponCode\": \"WELCOME10\",\n  \"billingAddress\": {\n    \"country\": \"US\",\n    \"state\": \"NY\",\n    \"postalCode\": \"10001\"\n  },\n  \"addons\": [\n    {\n      \"id\": \"extra_sessions\",\n      \"quantity\": 2\n    }\n  ]\n}"
            },
            "url": {
              "raw": "{{baseUrl}}/billing/plans/calculate-pricing",
              "host": ["{{baseUrl}}"],
              "path": ["billing", "plans", "calculate-pricing"]
            },
            "description": "Calculate plan pricing with taxes and discounts"
          },
          "response": []
        }
      ]
    },
    {
      "name": "Coupons & Discounts",
      "item": [
        {
          "name": "Validate Coupon",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"couponCode\": \"WELCOME10\",\n  \"planId\": \"premium_monthly\"\n}"
            },
            "url": {
              "raw": "{{baseUrl}}/billing/coupons/validate",
              "host": ["{{baseUrl}}"],
              "path": ["billing", "coupons", "validate"]
            },
            "description": "Validate coupon code"
          },
          "response": []
        },
        {
          "name": "Apply Coupon",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"couponCode\": \"WELCOME10\",\n  \"subscriptionId\": \"{{subscriptionId}}\"\n}"
            },
            "url": {
              "raw": "{{baseUrl}}/billing/coupons/apply",
              "host": ["{{baseUrl}}"],
              "path": ["billing", "coupons", "apply"]
            },
            "description": "Apply coupon to subscription"
          },
          "response": []
        },
        {
          "name": "Remove Coupon",
          "request": {
            "method": "DELETE",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/billing/subscriptions/{{subscriptionId}}/coupon",
              "host": ["{{baseUrl}}"],
              "path": ["billing", "subscriptions", "{{subscriptionId}}", "coupon"]
            },
            "description": "Remove coupon from subscription"
          },
          "response": []
        },
        {
          "name": "Get User Coupons",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/billing/coupons?status=active&page=1&limit=10",
              "host": ["{{baseUrl}}"],
              "path": ["billing", "coupons"],
              "query": [
                {
                  "key": "status",
                  "value": "active"
                },
                {
                  "key": "page",
                  "value": "1"
                },
                {
                  "key": "limit",
                  "value": "10"
                }
              ]
            },
            "description": "Get user's available coupons"
          },
          "response": []
        }
      ]
    },
    {
      "name": "Billing Analytics",
      "item": [
        {
          "name": "Get Spending Summary",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/billing/analytics/spending?period=year&includeProjections=true",
              "host": ["{{baseUrl}}"],
              "path": ["billing", "analytics", "spending"],
              "query": [
                {
                  "key": "period",
                  "value": "year"
                },
                {
                  "key": "includeProjections",
                  "value": "true"
                }
              ]
            },
            "description": "Get user spending summary"
          },
          "response": []
        },
        {
          "name": "Get Usage Analytics",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/billing/analytics/usage?period=month&includeDetails=true",
              "host": ["{{baseUrl}}"],
              "path": ["billing", "analytics", "usage"],
              "query": [
                {
                  "key": "period",
                  "value": "month"
                },
                {
                  "key": "includeDetails",
                  "value": "true"
                }
              ]
            },
            "description": "Get service usage analytics"
          },
          "response": []
        },
        {
          "name": "Get Cost Breakdown",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/billing/analytics/cost-breakdown?period=quarter&groupBy=service",
              "host": ["{{baseUrl}}"],
              "path": ["billing", "analytics", "cost-breakdown"],
              "query": [
                {
                  "key": "period",
                  "value": "quarter"
                },
                {
                  "key": "groupBy",
                  "value": "service"
                }
              ]
            },
            "description": "Get detailed cost breakdown"
          },
          "response": []
        }
      ]
    },
    {
      "name": "Webhooks & Events",
      "item": [
        {
          "name": "Get Billing Events",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/billing/events?type=all&page=1&limit=20&sortBy=createdAt&sortOrder=desc",
              "host": ["{{baseUrl}}"],
              "path": ["billing", "events"],
              "query": [
                {
                  "key": "type",
                  "value": "all"
                },
                {
                  "key": "page",
                  "value": "1"
                },
                {
                  "key": "limit",
                  "value": "20"
                },
                {
                  "key": "sortBy",
                  "value": "createdAt"
                },
                {
                  "key": "sortOrder",
                  "value": "desc"
                }
              ]
            },
            "description": "Get billing events history"
          },
          "response": []
        },
        {
          "name": "Get Payment Status",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/billing/payments/{{paymentIntentId}}/status",
              "host": ["{{baseUrl}}"],
              "path": ["billing", "payments", "{{paymentIntentId}}", "status"]
            },
            "description": "Get payment processing status"
          },
          "response": []
        },
        {
          "name": "Handle Payment Webhook",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Stripe-Signature",
                "value": "{{stripeSignature}}"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"id\": \"evt_1234567890\",\n  \"object\": \"event\",\n  \"type\": \"payment_intent.succeeded\",\n  \"data\": {\n    \"object\": {\n      \"id\": \"pi_1234567890\",\n      \"amount\": 4999,\n      \"currency\": \"usd\",\n      \"status\": \"succeeded\"\n    }\n  }\n}"
            },
            "url": {
              "raw": "{{baseUrl}}/billing/webhooks/stripe",
              "host": ["{{baseUrl}}"],
              "path": ["billing", "webhooks", "stripe"]
            },
            "description": "Handle Stripe webhook events"
          },
          "response": []
        }
      ]
    },
    {
      "name": "Tax & Compliance",
      "item": [
        {
          "name": "Get Tax Information",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/billing/tax-info",
              "host": ["{{baseUrl}}"],
              "path": ["billing", "tax-info"]
            },
            "description": "Get user tax information"
          },
          "response": []
        },
        {
          "name": "Update Tax Information",
          "request": {
            "method": "PUT",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"taxId\": \"12-3456789\",\n  \"taxIdType\": \"ein\",\n  \"businessName\": \"Smith Therapy Practice LLC\",\n  \"address\": {\n    \"line1\": \"123 Main Street\",\n    \"city\": \"New York\",\n    \"state\": \"NY\",\n    \"postalCode\": \"10001\",\n    \"country\": \"US\"\n  },\n  \"taxExempt\": false\n}"
            },
            "url": {
              "raw": "{{baseUrl}}/billing/tax-info",
              "host": ["{{baseUrl}}"],
              "path": ["billing", "tax-info"]
            },
            "description": "Update tax information"
          },
          "response": []
        },
        {
          "name": "Calculate Tax",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"amount\": 4999,\n  \"address\": {\n    \"line1\": \"123 Main Street\",\n    \"city\": \"New York\",\n    \"state\": \"NY\",\n    \"postalCode\": \"10001\",\n    \"country\": \"US\"\n  },\n  \"lineItems\": [\n    {\n      \"id\": \"premium_monthly\",\n      \"amount\": 4999,\n      \"description\": \"Premium Monthly Subscription\"\n    }\n  ]\n}"
            },
            "url": {
              "raw": "{{baseUrl}}/billing/tax/calculate",
              "host": ["{{baseUrl}}"],
              "path": ["billing", "tax", "calculate"]
            },
            "description": "Calculate tax for transaction"
          },
          "response": []
        }
      ]
    },
    {
      "name": "Error Handling & Validation",
      "item": [
        {
          "name": "Create Subscription - Invalid Payment Method",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Returns 400 for invalid payment method', function () {",
                  "    pm.response.to.have.status(400);",
                  "});",
                  "",
                  "pm.test('Error message mentions payment method', function () {",
                  "    const responseJson = pm.response.json();",
                  "    pm.expect(responseJson.message).to.include('payment method');",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"planId\": \"premium_monthly\",\n  \"paymentMethodId\": \"invalid_payment_method\"\n}"
            },
            "url": {
              "raw": "{{baseUrl}}/billing/subscription",
              "host": ["{{baseUrl}}"],
              "path": ["billing", "subscription"]
            },
            "description": "Test subscription creation with invalid payment method"
          },
          "response": []
        },
        {
          "name": "Pay Invoice - Insufficient Funds",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Returns 402 for insufficient funds', function () {",
                  "    pm.response.to.have.status(402);",
                  "});",
                  "",
                  "pm.test('Error message mentions insufficient funds', function () {",
                  "    const responseJson = pm.response.json();",
                  "    pm.expect(responseJson.message).to.include('insufficient');",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"paymentMethodId\": \"pm_card_chargeDeclined\",\n  \"confirmPayment\": true\n}"
            },
            "url": {
              "raw": "{{baseUrl}}/billing/invoices/{{invoiceId}}/pay",
              "host": ["{{baseUrl}}"],
              "path": ["billing", "invoices", "{{invoiceId}}", "pay"]
            },
            "description": "Test payment with insufficient funds"
          },
          "response": []
        },
        {
          "name": "Access Unauthorized Invoice",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Returns 403 for unauthorized access', function () {",
                  "    pm.response.to.have.status(403);",
                  "});",
                  "",
                  "pm.test('Error message mentions permissions', function () {",
                  "    const responseJson = pm.response.json();",
                  "    pm.expect(responseJson.message).to.include('permission');",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/billing/invoices/{{otherUserInvoiceId}}",
              "host": ["{{baseUrl}}"],
              "path": ["billing", "invoices", "{{otherUserInvoiceId}}"]
            },
            "description": "Test access to unauthorized invoice"
          },
          "response": []
        }
      ]
    }
  ]
}