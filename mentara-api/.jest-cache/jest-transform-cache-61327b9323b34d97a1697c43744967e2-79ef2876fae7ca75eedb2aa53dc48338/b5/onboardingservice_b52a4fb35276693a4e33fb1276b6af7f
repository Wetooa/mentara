d82c3de5102fd1dde01ee1efdc1399f2
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var OnboardingService_1;
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
exports.OnboardingService = void 0;
const common_1 = require("@nestjs/common");
const prisma_client_provider_1 = require("../providers/prisma-client.provider");
let OnboardingService = OnboardingService_1 = class OnboardingService {
    prisma;
    logger = new common_1.Logger(OnboardingService_1.name);
    constructor(prisma) {
        this.prisma = prisma;
    }
    getRequiredStepsForRole(role) {
        const baseSteps = ['profile_setup', 'email_verification'];
        switch (role) {
            case 'client':
                return [...baseSteps, 'pre_assessment', 'community_assignment'];
            case 'therapist':
                return [
                    ...baseSteps,
                    'license_verification',
                    'profile_completion',
                    'availability_setup',
                ];
            case 'admin':
                return [...baseSteps, 'admin_training'];
            case 'moderator':
                return [...baseSteps, 'moderation_training', 'community_assignment'];
            default:
                return baseSteps;
        }
    }
    async getOnboardingStatus(userId) {
        try {
            const user = await this.prisma.user.findUnique({
                where: { id: userId },
                include: {
                    client: {
                        include: {
                            preAssessment: true,
                        },
                    },
                    memberships: true,
                    therapist: true,
                    admin: true,
                    moderator: true,
                },
            });
            if (!user) {
                throw new common_1.NotFoundException('User not found');
            }
            const requiredSteps = this.getRequiredStepsForRole(user.role);
            const steps = [];
            // Check each required step
            for (const stepName of requiredSteps) {
                const stepStatus = await this.checkStepCompletion(user, stepName);
                steps.push({
                    step: stepName,
                    completed: stepStatus.completed,
                    completedAt: stepStatus.completedAt,
                    required: true,
                });
            }
            const completedSteps = steps.filter((s) => s.completed).length;
            const overallProgress = Math.round((completedSteps / steps.length) * 100);
            const isComplete = completedSteps === steps.length;
            const nextStep = steps.find((s) => !s.completed)?.step;
            return {
                userId,
                role: user.role,
                overallProgress,
                steps,
                isComplete,
                nextStep,
            };
        }
        catch (error) {
            this.logger.error(`Failed to get onboarding status for user ${userId}:`, error);
            throw error;
        }
    }
    async checkStepCompletion(user, stepName) {
        switch (stepName) {
            case 'profile_setup': {
                const hasBasicInfo = user.firstName && user.lastName && user.email;
                return {
                    completed: hasBasicInfo,
                    completedAt: hasBasicInfo ? user.updatedAt : undefined,
                };
            }
            case 'email_verification': {
                return {
                    completed: user.emailVerified,
                    completedAt: user.emailVerified ? user.updatedAt : undefined,
                };
            }
            case 'pre_assessment': {
                const hasPreAssessment = user.client?.preAssessment;
                return {
                    completed: !!hasPreAssessment,
                    completedAt: hasPreAssessment
                        ? user.client.preAssessment.createdAt
                        : undefined,
                };
            }
            case 'community_assignment': {
                const hasCommunityMemberships = user.memberships?.length > 0;
                return {
                    completed: hasCommunityMemberships,
                    completedAt: hasCommunityMemberships
                        ? user.memberships[0].joinedAt
                        : undefined,
                };
            }
            case 'license_verification': {
                const hasVerifiedLicense = user.therapist?.licenseVerified;
                return {
                    completed: !!hasVerifiedLicense,
                    completedAt: hasVerifiedLicense
                        ? user.therapist.licenseVerifiedAt
                        : undefined,
                };
            }
            case 'profile_completion': {
                const hasCompleteProfile = user.therapist &&
                    user.therapist.areasOfExpertise?.length > 0 &&
                    user.therapist.therapeuticApproachesUsedList?.length > 0;
                return {
                    completed: !!hasCompleteProfile,
                    completedAt: hasCompleteProfile
                        ? user.therapist.updatedAt
                        : undefined,
                };
            }
            case 'availability_setup': {
                const hasAvailability = await this.prisma.therapistAvailability.findFirst({
                    where: { therapistId: user.id },
                });
                return {
                    completed: !!hasAvailability,
                    completedAt: hasAvailability ? hasAvailability.createdAt : undefined,
                };
            }
            case 'admin_training': {
                // For now, assume admin training is complete if they have admin permissions
                return {
                    completed: !!user.admin,
                    completedAt: user.admin ? user.admin.createdAt : undefined,
                };
            }
            case 'moderation_training': {
                // For now, assume moderation training is complete if they have moderator permissions
                return {
                    completed: !!user.moderator,
                    completedAt: user.moderator ? user.moderator.createdAt : undefined,
                };
            }
            default:
                return { completed: false };
        }
    }
    async markStepCompleted(userId, stepName) {
        try {
            // In a real implementation, you might want to validate that the step is actually completed
            // before marking it as such. For now, we'll just recalculate the status.
            this.logger.log(`Marking step ${stepName} as completed for user ${userId}`);
            // Log onboarding step completion (alternative to audit log)
            this.logger.log(`Onboarding step completed - userId: ${userId}, step: ${stepName}, timestamp: ${new Date().toISOString()}`, 'OnboardingAudit');
            return await this.getOnboardingStatus(userId);
        }
        catch (error) {
            this.logger.error(`Failed to mark step ${stepName} as completed for user ${userId}:`, error);
            throw error;
        }
    }
    async validateOnboardingCompleteness(userId) {
        try {
            const status = await this.getOnboardingStatus(userId);
            const missingSteps = status.steps
                .filter((step) => step.required && !step.completed)
                .map((step) => step.step);
            const canProceed = status.overallProgress >= 80; // Allow some flexibility
            return {
                isComplete: status.isComplete,
                missingSteps,
                canProceed,
            };
        }
        catch (error) {
            this.logger.error(`Failed to validate onboarding completeness for user ${userId}:`, error);
            throw error;
        }
    }
    async getOnboardingInsights() {
        try {
            const allUsers = await this.prisma.user.findMany({
                include: {
                    client: {
                        include: {
                            preAssessment: true,
                        },
                    },
                    memberships: true,
                    therapist: true,
                    admin: true,
                    moderator: true,
                },
            });
            let totalProgress = 0;
            let completeCount = 0;
            const stepCompletionCounts = {};
            for (const user of allUsers) {
                const status = await this.getOnboardingStatus(user.id);
                totalProgress += status.overallProgress;
                if (status.isComplete) {
                    completeCount++;
                }
                // Track step completion for dropout analysis
                for (const step of status.steps) {
                    if (!stepCompletionCounts[step.step]) {
                        stepCompletionCounts[step.step] = 0;
                    }
                    if (step.completed) {
                        stepCompletionCounts[step.step]++;
                    }
                }
            }
            const averageProgress = allUsers.length > 0 ? totalProgress / allUsers.length : 0;
            // Find steps with lowest completion rates (potential dropoff points)
            const commonDropoffSteps = Object.entries(stepCompletionCounts)
                .sort(([, a], [, b]) => a - b)
                .slice(0, 3)
                .map(([step]) => step);
            return {
                totalUsers: allUsers.length,
                completeOnboarding: completeCount,
                incompleteOnboarding: allUsers.length - completeCount,
                averageProgress,
                commonDropoffSteps,
            };
        }
        catch (error) {
            this.logger.error('Failed to get onboarding insights:', error);
            throw error;
        }
    }
};
exports.OnboardingService = OnboardingService;
exports.OnboardingService = OnboardingService = OnboardingService_1 = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [typeof (_a = typeof prisma_client_provider_1.PrismaService !== "undefined" && prisma_client_provider_1.PrismaService) === "function" ? _a : Object])
], OnboardingService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL29uYm9hcmRpbmcvb25ib2FyZGluZy5zZXJ2aWNlLnRzIiwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7O0FBQUEsMkNBQXVFO0FBQ3ZFLGdGQUFvRTtBQW1CN0QsSUFBTSxpQkFBaUIseUJBQXZCLE1BQU0saUJBQWlCO0lBR0M7SUFGWixNQUFNLEdBQUcsSUFBSSxlQUFNLENBQUMsbUJBQWlCLENBQUMsSUFBSSxDQUFDLENBQUM7SUFFN0QsWUFBNkIsTUFBcUI7UUFBckIsV0FBTSxHQUFOLE1BQU0sQ0FBZTtJQUFHLENBQUM7SUFFOUMsdUJBQXVCLENBQUMsSUFBWTtRQUMxQyxNQUFNLFNBQVMsR0FBRyxDQUFDLGVBQWUsRUFBRSxvQkFBb0IsQ0FBQyxDQUFDO1FBRTFELFFBQVEsSUFBSSxFQUFFLENBQUM7WUFDYixLQUFLLFFBQVE7Z0JBQ1gsT0FBTyxDQUFDLEdBQUcsU0FBUyxFQUFFLGdCQUFnQixFQUFFLHNCQUFzQixDQUFDLENBQUM7WUFDbEUsS0FBSyxXQUFXO2dCQUNkLE9BQU87b0JBQ0wsR0FBRyxTQUFTO29CQUNaLHNCQUFzQjtvQkFDdEIsb0JBQW9CO29CQUNwQixvQkFBb0I7aUJBQ3JCLENBQUM7WUFDSixLQUFLLE9BQU87Z0JBQ1YsT0FBTyxDQUFDLEdBQUcsU0FBUyxFQUFFLGdCQUFnQixDQUFDLENBQUM7WUFDMUMsS0FBSyxXQUFXO2dCQUNkLE9BQU8sQ0FBQyxHQUFHLFNBQVMsRUFBRSxxQkFBcUIsRUFBRSxzQkFBc0IsQ0FBQyxDQUFDO1lBQ3ZFO2dCQUNFLE9BQU8sU0FBUyxDQUFDO1FBQ3JCLENBQUM7SUFDSCxDQUFDO0lBRUQsS0FBSyxDQUFDLG1CQUFtQixDQUFDLE1BQWM7UUFDdEMsSUFBSSxDQUFDO1lBQ0gsTUFBTSxJQUFJLEdBQUcsTUFBTSxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUM7Z0JBQzdDLEtBQUssRUFBRSxF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Q0FBQyxDQUFDO1lBQy9ELE1BQU0sS0FBSyxDQUFDO1FBQ2QsQ0FBQztJQUNILENBQUM7Q0FDRixDQUFBO0FBNVNZLDhDQUFpQjs0QkFBakIsaUJBQWlCO0lBRDdCLElBQUEsbUJBQVUsR0FBRTt5REFJMEIsc0NBQWEsb0JBQWIsc0NBQWE7R0FIdkMsaUJBQWlCLENBNFM3QiIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvaG9tZS93ZXRvb2EvRG9jdW1lbnRzL2NvZGUvcHJvamVjdHMvbWVudGFyYS9tZW50YXJhLWFwaS9zcmMvb25ib2FyZGluZy9vbmJvYXJkaW5nLnNlcnZpY2UudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSwgTG9nZ2VyLCBOb3RGb3VuZEV4Y2VwdGlvbiB9IGZyb20gJ0BuZXN0anMvY29tbW9uJztcbmltcG9ydCB7IFByaXNtYVNlcnZpY2UgfSBmcm9tICcuLi9wcm92aWRlcnMvcHJpc21hLWNsaWVudC5wcm92aWRlcic7XG5cbmV4cG9ydCBpbnRlcmZhY2UgT25ib2FyZGluZ1N0ZXAge1xuICBzdGVwOiBzdHJpbmc7XG4gIGNvbXBsZXRlZDogYm9vbGVhbjtcbiAgY29tcGxldGVkQXQ/OiBEYXRlO1xuICByZXF1aXJlZDogYm9vbGVhbjtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBPbmJvYXJkaW5nU3RhdHVzIHtcbiAgdXNlcklkOiBzdHJpbmc7XG4gIHJvbGU6IHN0cmluZztcbiAgb3ZlcmFsbFByb2dyZXNzOiBudW1iZXI7XG4gIHN0ZXBzOiBPbmJvYXJkaW5nU3RlcFtdO1xuICBpc0NvbXBsZXRlOiBib29sZWFuO1xuICBuZXh0U3RlcD86IHN0cmluZztcbn1cblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIE9uYm9hcmRpbmdTZXJ2aWNlIHtcbiAgcHJpdmF0ZSByZWFkb25seSBsb2dnZXIgPSBuZXcgTG9nZ2VyKE9uYm9hcmRpbmdTZXJ2aWNlLm5hbWUpO1xuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgcmVhZG9ubHkgcHJpc21hOiBQcmlzbWFTZXJ2aWNlKSB7fVxuXG4gIHByaXZhdGUgZ2V0UmVxdWlyZWRTdGVwc0ZvclJvbGUocm9sZTogc3RyaW5nKTogc3RyaW5nW10ge1xuICAgIGNvbnN0IGJhc2VTdGVwcyA9IFsncHJvZmlsZV9zZXR1cCcsICdlbWFpbF92ZXJpZmljYXRpb24nXTtcblxuICAgIHN3aXRjaCAocm9sZSkge1xuICAgICAgY2FzZSAnY2xpZW50JzpcbiAgICAgICAgcmV0dXJuIFsuLi5iYXNlU3RlcHMsICdwcmVfYXNzZXNzbWVudCcsICdjb21tdW5pdHlfYXNzaWdubWVudCddO1xuICAgICAgY2FzZSAndGhlcmFwaXN0JzpcbiAgICAgICAgcmV0dXJuIFtcbiAgICAgICAgICAuLi5iYXNlU3RlcHMsXG4gICAgICAgICAgJ2xpY2Vuc2VfdmVyaWZpY2F0aW9uJyxcbiAgICAgICAgICAncHJvZmlsZV9jb21wbGV0aW9uJyxcbiAgICAgICAgICAnYXZhaWxhYmlsaXR5X3NldHVwJyxcbiAgICAgICAgXTtcbiAgICAgIGNhc2UgJ2FkbWluJzpcbiAgICAgICAgcmV0dXJuIFsuLi5iYXNlU3RlcHMsICdhZG1pbl90cmFpbmluZyddO1xuICAgICAgY2FzZSAnbW9kZXJhdG9yJzpcbiAgICAgICAgcmV0dXJuIFsuLi5iYXNlU3RlcHMsICdtb2RlcmF0aW9uX3RyYWluaW5nJywgJ2NvbW11bml0eV9hc3NpZ25tZW50J107XG4gICAgICBkZWZhdWx0OlxuICAgICAgICByZXR1cm4gYmFzZVN0ZXBzO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGdldE9uYm9hcmRpbmdTdGF0dXModXNlcklkOiBzdHJpbmcpOiBQcm9taXNlPE9uYm9hcmRpbmdTdGF0dXM+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgdXNlciA9IGF3YWl0IHRoaXMucHJpc21hLnVzZXIuZmluZFVuaXF1ZSh7XG4gICAgICAgIHdoZXJlOiB7IGlkOiB1c2VySWQgfSxcbiAgICAgICAgaW5jbHVkZToge1xuICAgICAgICAgIGNsaWVudDoge1xuICAgICAgICAgICAgaW5jbHVkZToge1xuICAgICAgICAgICAgICBwcmVBc3Nlc3NtZW50OiB0cnVlLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9LFxuICAgICAgICAgIG1lbWJlcnNoaXBzOiB0cnVlLFxuICAgICAgICAgIHRoZXJhcGlzdDogdHJ1ZSxcbiAgICAgICAgICBhZG1pbjogdHJ1ZSxcbiAgICAgICAgICBtb2RlcmF0b3I6IHRydWUsXG4gICAgICAgIH0sXG4gICAgICB9KTtcblxuICAgICAgaWYgKCF1c2VyKSB7XG4gICAgICAgIHRocm93IG5ldyBOb3RGb3VuZEV4Y2VwdGlvbignVXNlciBub3QgZm91bmQnKTtcbiAgICAgIH1cblxuICAgICAgY29uc3QgcmVxdWlyZWRTdGVwcyA9IHRoaXMuZ2V0UmVxdWlyZWRTdGVwc0ZvclJvbGUodXNlci5yb2xlKTtcbiAgICAgIGNvbnN0IHN0ZXBzOiBPbmJvYXJkaW5nU3RlcFtdID0gW107XG5cbiAgICAgIC8vIENoZWNrIGVhY2ggcmVxdWlyZWQgc3RlcFxuICAgICAgZm9yIChjb25zdCBzdGVwTmFtZSBvZiByZXF1aXJlZFN0ZXBzKSB7XG4gICAgICAgIGNvbnN0IHN0ZXBTdGF0dXMgPSBhd2FpdCB0aGlzLmNoZWNrU3RlcENvbXBsZXRpb24odXNlciwgc3RlcE5hbWUpO1xuICAgICAgICBzdGVwcy5wdXNoKHtcbiAgICAgICAgICBzdGVwOiBzdGVwTmFtZSxcbiAgICAgICAgICBjb21wbGV0ZWQ6IHN0ZXBTdGF0dXMuY29tcGxldGVkLFxuICAgICAgICAgIGNvbXBsZXRlZEF0OiBzdGVwU3RhdHVzLmNvbXBsZXRlZEF0LFxuICAgICAgICAgIHJlcXVpcmVkOiB0cnVlLFxuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgY29uc3QgY29tcGxldGVkU3RlcHMgPSBzdGVwcy5maWx0ZXIoKHMpID0+IHMuY29tcGxldGVkKS5sZW5ndGg7XG4gICAgICBjb25zdCBvdmVyYWxsUHJvZ3Jlc3MgPSBNYXRoLnJvdW5kKChjb21wbGV0ZWRTdGVwcyAvIHN0ZXBzLmxlbmd0aCkgKiAxMDApO1xuICAgICAgY29uc3QgaXNDb21wbGV0ZSA9IGNvbXBsZXRlZFN0ZXBzID09PSBzdGVwcy5sZW5ndGg7XG4gICAgICBjb25zdCBuZXh0U3RlcCA9IHN0ZXBzLmZpbmQoKHMpID0+ICFzLmNvbXBsZXRlZCk/LnN0ZXA7XG5cbiAgICAgIHJldHVybiB7XG4gICAgICAgIHVzZXJJZCxcbiAgICAgICAgcm9sZTogdXNlci5yb2xlLFxuICAgICAgICBvdmVyYWxsUHJvZ3Jlc3MsXG4gICAgICAgIHN0ZXBzLFxuICAgICAgICBpc0NvbXBsZXRlLFxuICAgICAgICBuZXh0U3RlcCxcbiAgICAgIH07XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRoaXMubG9nZ2VyLmVycm9yKFxuICAgICAgICBgRmFpbGVkIHRvIGdldCBvbmJvYXJkaW5nIHN0YXR1cyBmb3IgdXNlciAke3VzZXJJZH06YCxcbiAgICAgICAgZXJyb3IsXG4gICAgICApO1xuICAgICAgdGhyb3cgZXJyb3I7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBjaGVja1N0ZXBDb21wbGV0aW9uKFxuICAgIHVzZXI6IGFueSxcbiAgICBzdGVwTmFtZTogc3RyaW5nLFxuICApOiBQcm9taXNlPHsgY29tcGxldGVkOiBib29sZWFuOyBjb21wbGV0ZWRBdD86IERhdGUgfT4ge1xuICAgIHN3aXRjaCAoc3RlcE5hbWUpIHtcbiAgICAgIGNhc2UgJ3Byb2ZpbGVfc2V0dXAnOiB7XG4gICAgICAgIGNvbnN0IGhhc0Jhc2ljSW5mbyA9IHVzZXIuZmlyc3ROYW1lICYmIHVzZXIubGFzdE5hbWUgJiYgdXNlci5lbWFpbDtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBjb21wbGV0ZWQ6IGhhc0Jhc2ljSW5mbyxcbiAgICAgICAgICBjb21wbGV0ZWRBdDogaGFzQmFzaWNJbmZvID8gdXNlci51cGRhdGVkQXQgOiB1bmRlZmluZWQsXG4gICAgICAgIH07XG4gICAgICB9XG5cbiAgICAgIGNhc2UgJ2VtYWlsX3ZlcmlmaWNhdGlvbic6IHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBjb21wbGV0ZWQ6IHVzZXIuZW1haWxWZXJpZmllZCxcbiAgICAgICAgICBjb21wbGV0ZWRBdDogdXNlci5lbWFpbFZlcmlmaWVkID8gdXNlci51cGRhdGVkQXQgOiB1bmRlZmluZWQsXG4gICAgICAgIH07XG4gICAgICB9XG5cbiAgICAgIGNhc2UgJ3ByZV9hc3Nlc3NtZW50Jzoge1xuICAgICAgICBjb25zdCBoYXNQcmVBc3Nlc3NtZW50ID0gdXNlci5jbGllbnQ/LnByZUFzc2Vzc21lbnQ7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgY29tcGxldGVkOiAhIWhhc1ByZUFzc2Vzc21lbnQsXG4gICAgICAgICAgY29tcGxldGVkQXQ6IGhhc1ByZUFzc2Vzc21lbnRcbiAgICAgICAgICAgID8gdXNlci5jbGllbnQucHJlQXNzZXNzbWVudC5jcmVhdGVkQXRcbiAgICAgICAgICAgIDogdW5kZWZpbmVkLFxuICAgICAgICB9O1xuICAgICAgfVxuXG4gICAgICBjYXNlICdjb21tdW5pdHlfYXNzaWdubWVudCc6IHtcbiAgICAgICAgY29uc3QgaGFzQ29tbXVuaXR5TWVtYmVyc2hpcHMgPSB1c2VyLm1lbWJlcnNoaXBzPy5sZW5ndGggPiAwO1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIGNvbXBsZXRlZDogaGFzQ29tbXVuaXR5TWVtYmVyc2hpcHMsXG4gICAgICAgICAgY29tcGxldGVkQXQ6IGhhc0NvbW11bml0eU1lbWJlcnNoaXBzXG4gICAgICAgICAgICA/IHVzZXIubWVtYmVyc2hpcHNbMF0uam9pbmVkQXRcbiAgICAgICAgICAgIDogdW5kZWZpbmVkLFxuICAgICAgICB9O1xuICAgICAgfVxuXG4gICAgICBjYXNlICdsaWNlbnNlX3ZlcmlmaWNhdGlvbic6IHtcbiAgICAgICAgY29uc3QgaGFzVmVyaWZpZWRMaWNlbnNlID0gdXNlci50aGVyYXBpc3Q/LmxpY2Vuc2VWZXJpZmllZDtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBjb21wbGV0ZWQ6ICEhaGFzVmVyaWZpZWRMaWNlbnNlLFxuICAgICAgICAgIGNvbXBsZXRlZEF0OiBoYXNWZXJpZmllZExpY2Vuc2VcbiAgICAgICAgICAgID8gdXNlci50aGVyYXBpc3QubGljZW5zZVZlcmlmaWVkQXRcbiAgICAgICAgICAgIDogdW5kZWZpbmVkLFxuICAgICAgICB9O1xuICAgICAgfVxuXG4gICAgICBjYXNlICdwcm9maWxlX2NvbXBsZXRpb24nOiB7XG4gICAgICAgIGNvbnN0IGhhc0NvbXBsZXRlUHJvZmlsZSA9XG4gICAgICAgICAgdXNlci50aGVyYXBpc3QgJiZcbiAgICAgICAgICB1c2VyLnRoZXJhcGlzdC5hcmVhc09mRXhwZXJ0aXNlPy5sZW5ndGggPiAwICYmXG4gICAgICAgICAgdXNlci50aGVyYXBpc3QudGhlcmFwZXV0aWNBcHByb2FjaGVzVXNlZExpc3Q/Lmxlbmd0aCA+IDA7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgY29tcGxldGVkOiAhIWhhc0NvbXBsZXRlUHJvZmlsZSxcbiAgICAgICAgICBjb21wbGV0ZWRBdDogaGFzQ29tcGxldGVQcm9maWxlXG4gICAgICAgICAgICA/IHVzZXIudGhlcmFwaXN0LnVwZGF0ZWRBdFxuICAgICAgICAgICAgOiB1bmRlZmluZWQsXG4gICAgICAgIH07XG4gICAgICB9XG5cbiAgICAgIGNhc2UgJ2F2YWlsYWJpbGl0eV9zZXR1cCc6IHtcbiAgICAgICAgY29uc3QgaGFzQXZhaWxhYmlsaXR5ID1cbiAgICAgICAgICBhd2FpdCB0aGlzLnByaXNtYS50aGVyYXBpc3RBdmFpbGFiaWxpdHkuZmluZEZpcnN0KHtcbiAgICAgICAgICAgIHdoZXJlOiB7IHRoZXJhcGlzdElkOiB1c2VyLmlkIH0sXG4gICAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgY29tcGxldGVkOiAhIWhhc0F2YWlsYWJpbGl0eSxcbiAgICAgICAgICBjb21wbGV0ZWRBdDogaGFzQXZhaWxhYmlsaXR5ID8gaGFzQXZhaWxhYmlsaXR5LmNyZWF0ZWRBdCA6IHVuZGVmaW5lZCxcbiAgICAgICAgfTtcbiAgICAgIH1cblxuICAgICAgY2FzZSAnYWRtaW5fdHJhaW5pbmcnOiB7XG4gICAgICAgIC8vIEZvciBub3csIGFzc3VtZSBhZG1pbiB0cmFpbmluZyBpcyBjb21wbGV0ZSBpZiB0aGV5IGhhdmUgYWRtaW4gcGVybWlzc2lvbnNcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBjb21wbGV0ZWQ6ICEhdXNlci5hZG1pbixcbiAgICAgICAgICBjb21wbGV0ZWRBdDogdXNlci5hZG1pbiA/IHVzZXIuYWRtaW4uY3JlYXRlZEF0IDogdW5kZWZpbmVkLFxuICAgICAgICB9O1xuICAgICAgfVxuXG4gICAgICBjYXNlICdtb2RlcmF0aW9uX3RyYWluaW5nJzoge1xuICAgICAgICAvLyBGb3Igbm93LCBhc3N1bWUgbW9kZXJhdGlvbiB0cmFpbmluZyBpcyBjb21wbGV0ZSBpZiB0aGV5IGhhdmUgbW9kZXJhdG9yIHBlcm1pc3Npb25zXG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgY29tcGxldGVkOiAhIXVzZXIubW9kZXJhdG9yLFxuICAgICAgICAgIGNvbXBsZXRlZEF0OiB1c2VyLm1vZGVyYXRvciA/IHVzZXIubW9kZXJhdG9yLmNyZWF0ZWRBdCA6IHVuZGVmaW5lZCxcbiAgICAgICAgfTtcbiAgICAgIH1cblxuICAgICAgZGVmYXVsdDpcbiAgICAgICAgcmV0dXJuIHsgY29tcGxldGVkOiBmYWxzZSB9O1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIG1hcmtTdGVwQ29tcGxldGVkKFxuICAgIHVzZXJJZDogc3RyaW5nLFxuICAgIHN0ZXBOYW1lOiBzdHJpbmcsXG4gICk6IFByb21pc2U8T25ib2FyZGluZ1N0YXR1cz4ge1xuICAgIHRyeSB7XG4gICAgICAvLyBJbiBhIHJlYWwgaW1wbGVtZW50YXRpb24sIHlvdSBtaWdodCB3YW50IHRvIHZhbGlkYXRlIHRoYXQgdGhlIHN0ZXAgaXMgYWN0dWFsbHkgY29tcGxldGVkXG4gICAgICAvLyBiZWZvcmUgbWFya2luZyBpdCBhcyBzdWNoLiBGb3Igbm93LCB3ZSdsbCBqdXN0IHJlY2FsY3VsYXRlIHRoZSBzdGF0dXMuXG5cbiAgICAgIHRoaXMubG9nZ2VyLmxvZyhcbiAgICAgICAgYE1hcmtpbmcgc3RlcCAke3N0ZXBOYW1lfSBhcyBjb21wbGV0ZWQgZm9yIHVzZXIgJHt1c2VySWR9YCxcbiAgICAgICk7XG5cbiAgICAgIC8vIExvZyBvbmJvYXJkaW5nIHN0ZXAgY29tcGxldGlvbiAoYWx0ZXJuYXRpdmUgdG8gYXVkaXQgbG9nKVxuICAgICAgdGhpcy5sb2dnZXIubG9nKFxuICAgICAgICBgT25ib2FyZGluZyBzdGVwIGNvbXBsZXRlZCAtIHVzZXJJZDogJHt1c2VySWR9LCBzdGVwOiAke3N0ZXBOYW1lfSwgdGltZXN0YW1wOiAke25ldyBEYXRlKCkudG9JU09TdHJpbmcoKX1gLFxuICAgICAgICAnT25ib2FyZGluZ0F1ZGl0J1xuICAgICAgKTtcblxuICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuZ2V0T25ib2FyZGluZ1N0YXR1cyh1c2VySWQpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aGlzLmxvZ2dlci5lcnJvcihcbiAgICAgICAgYEZhaWxlZCB0byBtYXJrIHN0ZXAgJHtzdGVwTmFtZX0gYXMgY29tcGxldGVkIGZvciB1c2VyICR7dXNlcklkfTpgLFxuICAgICAgICBlcnJvcixcbiAgICAgICk7XG4gICAgICB0aHJvdyBlcnJvcjtcbiAgICB9XG4gIH1cblxuICBhc3luYyB2YWxpZGF0ZU9uYm9hcmRpbmdDb21wbGV0ZW5lc3ModXNlcklkOiBzdHJpbmcpOiBQcm9taXNlPHtcbiAgICBpc0NvbXBsZXRlOiBib29sZWFuO1xuICAgIG1pc3NpbmdTdGVwczogc3RyaW5nW107XG4gICAgY2FuUHJvY2VlZDogYm9vbGVhbjtcbiAgfT4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBzdGF0dXMgPSBhd2FpdCB0aGlzLmdldE9uYm9hcmRpbmdTdGF0dXModXNlcklkKTtcbiAgICAgIGNvbnN0IG1pc3NpbmdTdGVwcyA9IHN0YXR1cy5zdGVwc1xuICAgICAgICAuZmlsdGVyKChzdGVwKSA9PiBzdGVwLnJlcXVpcmVkICYmICFzdGVwLmNvbXBsZXRlZClcbiAgICAgICAgLm1hcCgoc3RlcCkgPT4gc3RlcC5zdGVwKTtcblxuICAgICAgY29uc3QgY2FuUHJvY2VlZCA9IHN0YXR1cy5vdmVyYWxsUHJvZ3Jlc3MgPj0gODA7IC8vIEFsbG93IHNvbWUgZmxleGliaWxpdHlcblxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgaXNDb21wbGV0ZTogc3RhdHVzLmlzQ29tcGxldGUsXG4gICAgICAgIG1pc3NpbmdTdGVwcyxcbiAgICAgICAgY2FuUHJvY2VlZCxcbiAgICAgIH07XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRoaXMubG9nZ2VyLmVycm9yKFxuICAgICAgICBgRmFpbGVkIHRvIHZhbGlkYXRlIG9uYm9hcmRpbmcgY29tcGxldGVuZXNzIGZvciB1c2VyICR7dXNlcklkfTpgLFxuICAgICAgICBlcnJvcixcbiAgICAgICk7XG4gICAgICB0aHJvdyBlcnJvcjtcbiAgICB9XG4gIH1cblxuICBhc3luYyBnZXRPbmJvYXJkaW5nSW5zaWdodHMoKTogUHJvbWlzZTx7XG4gICAgdG90YWxVc2VyczogbnVtYmVyO1xuICAgIGNvbXBsZXRlT25ib2FyZGluZzogbnVtYmVyO1xuICAgIGluY29tcGxldGVPbmJvYXJkaW5nOiBudW1iZXI7XG4gICAgYXZlcmFnZVByb2dyZXNzOiBudW1iZXI7XG4gICAgY29tbW9uRHJvcG9mZlN0ZXBzOiBzdHJpbmdbXTtcbiAgfT4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBhbGxVc2VycyA9IGF3YWl0IHRoaXMucHJpc21hLnVzZXIuZmluZE1hbnkoe1xuICAgICAgICBpbmNsdWRlOiB7XG4gICAgICAgICAgY2xpZW50OiB7XG4gICAgICAgICAgICBpbmNsdWRlOiB7XG4gICAgICAgICAgICAgIHByZUFzc2Vzc21lbnQ6IHRydWUsXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0sXG4gICAgICAgICAgbWVtYmVyc2hpcHM6IHRydWUsXG4gICAgICAgICAgdGhlcmFwaXN0OiB0cnVlLFxuICAgICAgICAgIGFkbWluOiB0cnVlLFxuICAgICAgICAgIG1vZGVyYXRvcjogdHJ1ZSxcbiAgICAgICAgfSxcbiAgICAgIH0pO1xuXG4gICAgICBsZXQgdG90YWxQcm9ncmVzcyA9IDA7XG4gICAgICBsZXQgY29tcGxldGVDb3VudCA9IDA7XG4gICAgICBjb25zdCBzdGVwQ29tcGxldGlvbkNvdW50czogUmVjb3JkPHN0cmluZywgbnVtYmVyPiA9IHt9O1xuXG4gICAgICBmb3IgKGNvbnN0IHVzZXIgb2YgYWxsVXNlcnMpIHtcbiAgICAgICAgY29uc3Qgc3RhdHVzID0gYXdhaXQgdGhpcy5nZXRPbmJvYXJkaW5nU3RhdHVzKHVzZXIuaWQpO1xuICAgICAgICB0b3RhbFByb2dyZXNzICs9IHN0YXR1cy5vdmVyYWxsUHJvZ3Jlc3M7XG5cbiAgICAgICAgaWYgKHN0YXR1cy5pc0NvbXBsZXRlKSB7XG4gICAgICAgICAgY29tcGxldGVDb3VudCsrO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gVHJhY2sgc3RlcCBjb21wbGV0aW9uIGZvciBkcm9wb3V0IGFuYWx5c2lzXG4gICAgICAgIGZvciAoY29uc3Qgc3RlcCBvZiBzdGF0dXMuc3RlcHMpIHtcbiAgICAgICAgICBpZiAoIXN0ZXBDb21wbGV0aW9uQ291bnRzW3N0ZXAuc3RlcF0pIHtcbiAgICAgICAgICAgIHN0ZXBDb21wbGV0aW9uQ291bnRzW3N0ZXAuc3RlcF0gPSAwO1xuICAgICAgICAgIH1cbiAgICAgICAgICBpZiAoc3RlcC5jb21wbGV0ZWQpIHtcbiAgICAgICAgICAgIHN0ZXBDb21wbGV0aW9uQ291bnRzW3N0ZXAuc3RlcF0rKztcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgY29uc3QgYXZlcmFnZVByb2dyZXNzID1cbiAgICAgICAgYWxsVXNlcnMubGVuZ3RoID4gMCA/IHRvdGFsUHJvZ3Jlc3MgLyBhbGxVc2Vycy5sZW5ndGggOiAwO1xuXG4gICAgICAvLyBGaW5kIHN0ZXBzIHdpdGggbG93ZXN0IGNvbXBsZXRpb24gcmF0ZXMgKHBvdGVudGlhbCBkcm9wb2ZmIHBvaW50cylcbiAgICAgIGNvbnN0IGNvbW1vbkRyb3BvZmZTdGVwcyA9IE9iamVjdC5lbnRyaWVzKHN0ZXBDb21wbGV0aW9uQ291bnRzKVxuICAgICAgICAuc29ydCgoWywgYV0sIFssIGJdKSA9PiBhIC0gYilcbiAgICAgICAgLnNsaWNlKDAsIDMpXG4gICAgICAgIC5tYXAoKFtzdGVwXSkgPT4gc3RlcCk7XG5cbiAgICAgIHJldHVybiB7XG4gICAgICAgIHRvdGFsVXNlcnM6IGFsbFVzZXJzLmxlbmd0aCxcbiAgICAgICAgY29tcGxldGVPbmJvYXJkaW5nOiBjb21wbGV0ZUNvdW50LFxuICAgICAgICBpbmNvbXBsZXRlT25ib2FyZGluZzogYWxsVXNlcnMubGVuZ3RoIC0gY29tcGxldGVDb3VudCxcbiAgICAgICAgYXZlcmFnZVByb2dyZXNzLFxuICAgICAgICBjb21tb25Ecm9wb2ZmU3RlcHMsXG4gICAgICB9O1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aGlzLmxvZ2dlci5lcnJvcignRmFpbGVkIHRvIGdldCBvbmJvYXJkaW5nIGluc2lnaHRzOicsIGVycm9yKTtcbiAgICAgIHRocm93IGVycm9yO1xuICAgIH1cbiAgfVxufVxuIl0sInZlcnNpb24iOjN9