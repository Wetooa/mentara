{"version":3,"names":["cov_2khujb3ztu","actualCoverage","common_1","s","require","prisma_client_provider_1","email_service_1","token_service_1","crypto","PasswordResetService","prisma","emailService","tokenService","constructor","f","requestPasswordReset","email","user","findUnique","where","select","id","firstName","deactivatedAt","resetToken","resetTokenExpiry","b","BadRequestException","Date","timeDiff","getTime","token","hashedToken","expiresAt","generatePasswordResetToken","update","data","sendPasswordResetEmail","resetPassword","newPassword","validatePasswordStrength","createHash","digest","password","isSamePassword","comparePassword","hashedPassword","hashPassword","failedLoginCount","lockoutUntil","logout","sendPasswordResetConfirmationEmail","success","message","validateResetToken","valid","minLength","parseInt","process","env","MIN_PASSWORD_LENGTH","length","test","commonPasswords","includes","toLowerCase","resetUrl","FRONTEND_URL","html","SUPPORT_EMAIL","sendPasswordReset","error","console","sendPasswordResetSuccess","cleanupExpiredTokens","updateMany","lt","exports","__decorate","Injectable","PrismaService","_a","Object","_b","EmailService","_c","TokenService"],"sources":["/home/wetooa/Documents/code/projects/mentara/mentara-api/src/auth/services/password-reset.service.ts"],"sourcesContent":["import {\n  Injectable,\n  BadRequestException,\n  NotFoundException,\n} from '@nestjs/common';\nimport { PrismaService } from '../../providers/prisma-client.provider';\nimport { EmailService } from '../../email/email.service';\nimport { TokenService } from './token.service';\nimport * as crypto from 'crypto';\n\n@Injectable()\nexport class PasswordResetService {\n  constructor(\n    private readonly prisma: PrismaService,\n    private readonly emailService: EmailService,\n    private readonly tokenService: TokenService,\n  ) {}\n\n  async requestPasswordReset(email: string): Promise<void> {\n    const user = await this.prisma.user.findUnique({\n      where: { email },\n      select: {\n        id: true,\n        email: true,\n        firstName: true,\n        deactivatedAt: true,\n        resetToken: true,\n        resetTokenExpiry: true,\n      },\n    });\n\n    if (!user) {\n      // Don't reveal if email exists for security\n      return;\n    }\n\n    if (user.deactivatedAt) {\n      throw new BadRequestException('Account is deactivated');\n    }\n\n    // Check if there's an existing valid token (prevent spam)\n    if (\n      user.resetToken &&\n      user.resetTokenExpiry &&\n      user.resetTokenExpiry > new Date()\n    ) {\n      const timeDiff = user.resetTokenExpiry.getTime() - new Date().getTime();\n      if (timeDiff > 50 * 60 * 1000) {\n        // More than 50 minutes remaining\n        throw new BadRequestException(\n          'Password reset email already sent. Please check your email or wait before requesting again.',\n        );\n      }\n    }\n\n    // Generate new reset token\n    const { token, hashedToken, expiresAt } =\n      await this.tokenService.generatePasswordResetToken();\n\n    // Update user with reset token\n    await this.prisma.user.update({\n      where: { id: user.id },\n      data: {\n        resetToken: hashedToken,\n        resetTokenExpiry: expiresAt,\n      },\n    });\n\n    // Send password reset email\n    await this.sendPasswordResetEmail(user.email, user.firstName, token);\n  }\n\n  async resetPassword(\n    token: string,\n    newPassword: string,\n  ): Promise<{ success: boolean; message: string }> {\n    if (!token || !newPassword) {\n      throw new BadRequestException(\n        'Reset token and new password are required',\n      );\n    }\n\n    // Validate password strength\n    this.validatePasswordStrength(newPassword);\n\n    const hashedToken = crypto.createHash('sha256').update(token).digest('hex');\n\n    const user = await this.prisma.user.findUnique({\n      where: { resetToken: hashedToken },\n      select: {\n        id: true,\n        email: true,\n        resetTokenExpiry: true,\n        deactivatedAt: true,\n        password: true,\n      },\n    });\n\n    if (!user) {\n      throw new BadRequestException('Invalid or expired reset token');\n    }\n\n    if (user.deactivatedAt) {\n      throw new BadRequestException('Account is deactivated');\n    }\n\n    if (!user.resetTokenExpiry || user.resetTokenExpiry < new Date()) {\n      // Clean up expired token\n      await this.prisma.user.update({\n        where: { id: user.id },\n        data: {\n          resetToken: null,\n          resetTokenExpiry: null,\n        },\n      });\n      throw new BadRequestException('Reset token has expired');\n    }\n\n    // Check if new password is different from current (if user has one)\n    if (user.password) {\n      const isSamePassword = await this.tokenService.comparePassword(\n        newPassword,\n        user.password,\n      );\n      if (isSamePassword) {\n        throw new BadRequestException(\n          'New password must be different from current password',\n        );\n      }\n    }\n\n    // Hash new password\n    const hashedPassword = await this.tokenService.hashPassword(newPassword);\n\n    // Update password and clear reset token\n    await this.prisma.user.update({\n      where: { id: user.id },\n      data: {\n        password: hashedPassword,\n        resetToken: null,\n        resetTokenExpiry: null,\n        failedLoginCount: 0, // Reset failed login attempts\n        lockoutUntil: null, // Clear any lockout\n      },\n    });\n\n    // Simple logout for security after password reset\n    await this.tokenService.logout(user.id);\n\n    // Send confirmation email\n    await this.sendPasswordResetConfirmationEmail(user.email);\n\n    return {\n      success: true,\n      message: 'Password reset successfully',\n    };\n  }\n\n  async validateResetToken(\n    token: string,\n  ): Promise<{ valid: boolean; email?: string }> {\n    if (!token) {\n      return { valid: false };\n    }\n\n    const hashedToken = crypto.createHash('sha256').update(token).digest('hex');\n\n    const user = await this.prisma.user.findUnique({\n      where: { resetToken: hashedToken },\n      select: {\n        email: true,\n        resetTokenExpiry: true,\n        deactivatedAt: true,\n      },\n    });\n\n    if (!user || user.deactivatedAt) {\n      return { valid: false };\n    }\n\n    if (!user.resetTokenExpiry || user.resetTokenExpiry < new Date()) {\n      return { valid: false };\n    }\n\n    return {\n      valid: true,\n      email: user.email,\n    };\n  }\n\n  private validatePasswordStrength(password: string): void {\n    const minLength = parseInt(process.env.MIN_PASSWORD_LENGTH || '8');\n\n    if (password.length < minLength) {\n      throw new BadRequestException(\n        `Password must be at least ${minLength} characters long`,\n      );\n    }\n\n    // Check for at least one uppercase letter\n    if (!/[A-Z]/.test(password)) {\n      throw new BadRequestException(\n        'Password must contain at least one uppercase letter',\n      );\n    }\n\n    // Check for at least one lowercase letter\n    if (!/[a-z]/.test(password)) {\n      throw new BadRequestException(\n        'Password must contain at least one lowercase letter',\n      );\n    }\n\n    // Check for at least one number\n    if (!/\\d/.test(password)) {\n      throw new BadRequestException(\n        'Password must contain at least one number',\n      );\n    }\n\n    // Check for at least one special character\n    if (!/[!@#$%^&*()_+\\-=\\[\\]{};':\"\\\\|,.<>\\/?]/.test(password)) {\n      throw new BadRequestException(\n        'Password must contain at least one special character',\n      );\n    }\n\n    // Check for common weak passwords\n    const commonPasswords = [\n      'password',\n      'password123',\n      '123456',\n      'qwerty',\n      'abc123',\n      'letmein',\n      'welcome',\n      'monkey',\n      '1234567890',\n      'admin',\n    ];\n\n    if (commonPasswords.includes(password.toLowerCase())) {\n      throw new BadRequestException(\n        'Password is too common. Please choose a more secure password',\n      );\n    }\n  }\n\n  private async sendPasswordResetEmail(\n    email: string,\n    firstName: string,\n    token: string,\n  ): Promise<void> {\n    const resetUrl = `${process.env.FRONTEND_URL}/reset-password?token=${token}`;\n\n    try {\n      const html = `\n        <div style=\"font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;\">\n          <h2 style=\"color: #8B5CF6;\">Reset Your Mentara Password</h2>\n          <p>Hello ${firstName},</p>\n          <p>We received a request to reset your password for your Mentara account. Click the button below to reset your password.</p>\n          <div style=\"text-align: center; margin: 30px 0;\">\n            <a href=\"${resetUrl}\" style=\"background-color: #8B5CF6; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; display: inline-block;\">\n              Reset Password\n            </a>\n          </div>\n          <p>This link will expire in 1 hour for security reasons.</p>\n          <p>If you didn't request a password reset, you can safely ignore this email. Your password will not be changed.</p>\n          <p>If you have any questions, please contact us at ${process.env.SUPPORT_EMAIL || 'support@mentara.com'}</p>\n          <hr style=\"border: none; border-top: 1px solid #eee; margin: 30px 0;\">\n          <p style=\"color: #666; font-size: 12px;\">\n            This is an automated message from Mentara. Please do not reply to this email.\n          </p>\n        </div>\n      `;\n\n      await this.emailService.sendPasswordReset(\n        email,\n        firstName,\n        'Reset Your Mentara Password',\n        resetUrl\n      );\n    } catch (error) {\n      console.error('Failed to send password reset email:', error);\n      throw new BadRequestException('Failed to send password reset email');\n    }\n  }\n\n  private async sendPasswordResetConfirmationEmail(\n    email: string,\n  ): Promise<void> {\n    try {\n      const html = `\n        <div style=\"font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;\">\n          <h2 style=\"color: #10B981;\">Password Reset Successful</h2>\n          <p>Your password has been successfully reset for your Mentara account.</p>\n          <p>If you didn't make this change, please contact our support team immediately at ${process.env.SUPPORT_EMAIL || 'support@mentara.com'}.</p>\n          <div style=\"text-align: center; margin: 30px 0;\">\n            <a href=\"${process.env.FRONTEND_URL}/login\" style=\"background-color: #8B5CF6; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; display: inline-block;\">\n              Login to Your Account\n            </a>\n          </div>\n          <hr style=\"border: none; border-top: 1px solid #eee; margin: 30px 0;\">\n          <p style=\"color: #666; font-size: 12px;\">\n            This is an automated message from Mentara. Please do not reply to this email.\n          </p>\n        </div>\n      `;\n\n      await this.emailService.sendPasswordResetSuccess(\n        email,\n        'User',\n        'Password Reset Successful'\n      );\n    } catch (error) {\n      console.error('Failed to send password reset confirmation email:', error);\n      // Don't throw error here as password reset was successful\n    }\n  }\n\n  async cleanupExpiredTokens(): Promise<void> {\n    await this.prisma.user.updateMany({\n      where: {\n        resetTokenExpiry: {\n          lt: new Date(),\n        },\n      },\n      data: {\n        resetToken: null,\n        resetTokenExpiry: null,\n      },\n    });\n  }\n}\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;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","ignoreList":[]}