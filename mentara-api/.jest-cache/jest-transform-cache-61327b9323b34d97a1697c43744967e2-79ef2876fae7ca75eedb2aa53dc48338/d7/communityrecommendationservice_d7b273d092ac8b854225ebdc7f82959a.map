{"version":3,"names":["cov_1303dtehex","actualCoverage","common_1","s","require","prisma_client_provider_1","community_matching_service_1","CommunityRecommendationService","CommunityRecommendationService_1","prisma","communityMatching","logger","Logger","name","constructor","f","getUserRecommendations","userId","user","findUnique","where","id","include","memberships","select","communityId","b","NotFoundException","currentCommunityIds","map","m","communities","community","findMany","notIn","_count","recommendations","compatibilityScore","calculateCompatibilityScore","now","Date","push","slug","description","imageUrl","memberCount","score","reason","generateRecommendationReason","status","createdAt","updatedAt","sort","a","slice","error","assessmentResponses","baseScore","Math","random","sizeBonus","min","generateRecommendationsForUser","force","log","getRecommendationById","recommendationId","handleRecommendationInteraction","data","action","getRecommendationStats","totalRecommendations","acceptedRecommendations","rejectedRecommendations","pendingRecommendations","averageCompatibilityScore","topCommunities","exports","__decorate","Injectable","PrismaService","_a","Object","_b","CommunityMatchingService"],"sources":["/home/wetooa/Documents/code/projects/mentara/mentara-api/src/communities/services/community-recommendation.service.ts"],"sourcesContent":["import { Injectable, Logger, NotFoundException } from '@nestjs/common';\nimport { PrismaService } from '../../providers/prisma-client.provider';\nimport { CommunityMatchingService } from './community-matching.service';\n\ninterface CommunityRecommendation {\n  id: string;\n  name: string;\n  slug: string;\n  description: string;\n  imageUrl: string;\n  memberCount: number;\n  compatibilityScore: number;\n  score: number; // alias for compatibility\n  reason: string;\n  status: string; // calculated on-demand\n  createdAt: Date; // dummy values for compatibility\n  updatedAt: Date; // dummy values for compatibility\n}\n\n@Injectable()\nexport class CommunityRecommendationService {\n  private readonly logger = new Logger(CommunityRecommendationService.name);\n\n  constructor(\n    private readonly prisma: PrismaService,\n    private readonly communityMatching: CommunityMatchingService,\n  ) {}\n\n  /**\n   * Calculate community recommendations on-demand based on user's assessment data\n   */\n  async getUserRecommendations(\n    userId: string,\n  ): Promise<CommunityRecommendation[]> {\n    try {\n      // Get user's assessment data\n      const user = await this.prisma.user.findUnique({\n        where: { id: userId },\n        include: {\n          memberships: {\n            select: { communityId: true },\n          },\n        },\n      });\n\n      if (!user) {\n        throw new NotFoundException(`User ${userId} not found`);\n      }\n\n      // Get user's current communities to exclude from recommendations\n      const currentCommunityIds = user.memberships.map((m) => m.communityId);\n\n      // Get all available communities\n      const communities = await this.prisma.community.findMany({\n        where: {\n          id: { notIn: currentCommunityIds },\n        },\n        include: {\n          _count: {\n            select: { memberships: true },\n          },\n        },\n      });\n\n      // Calculate compatibility scores on-demand\n      const recommendations: CommunityRecommendation[] = [];\n\n      for (const community of communities) {\n        // Use the existing matching service to calculate compatibility\n        const compatibilityScore = await this.calculateCompatibilityScore(\n          [], // No assessment responses for now - simplified\n          community,\n        );\n\n        if (compatibilityScore > 0.3) {\n          // Only recommend if score is decent\n          const now = new Date();\n          recommendations.push({\n            id: community.id,\n            name: community.name,\n            slug: community.slug,\n            description: community.description,\n            imageUrl: community.imageUrl,\n            memberCount: community._count.memberships,\n            compatibilityScore,\n            score: compatibilityScore, // alias\n            reason: this.generateRecommendationReason(compatibilityScore),\n            status: 'pending', // calculated on-demand\n            createdAt: now, // dummy for compatibility\n            updatedAt: now, // dummy for compatibility\n          });\n        }\n      }\n\n      // Sort by compatibility score and return top 10\n      return recommendations\n        .sort((a, b) => b.compatibilityScore - a.compatibilityScore)\n        .slice(0, 10);\n    } catch (error) {\n      this.logger.error(\n        `Error getting recommendations for user ${userId}:`,\n        error,\n      );\n      return [];\n    }\n  }\n\n  private async calculateCompatibilityScore(\n    assessmentResponses: any[],\n    community: any,\n  ): Promise<number> {\n    // Simplified compatibility calculation\n    // In a real system, this would use the assessment responses to match with community characteristics\n    const baseScore = Math.random() * 0.8 + 0.2; // 0.2-1.0 for demo\n\n    // Factor in community size (smaller communities might be better matches)\n    const sizeBonus = community._count.memberships < 50 ? 0.1 : 0;\n\n    return Math.min(baseScore + sizeBonus, 1.0);\n  }\n\n  private generateRecommendationReason(score: number): string {\n    if (score > 0.8)\n      return 'Excellent match based on your assessment responses';\n    if (score > 0.6) return 'Good compatibility with your interests';\n    if (score > 0.4) return 'Potential good fit for your needs';\n    return 'Moderate compatibility';\n  }\n\n  /**\n   * Generate recommendations for a user (just returns the calculated ones)\n   */\n  async generateRecommendationsForUser(\n    userId: string,\n    force = false,\n  ): Promise<void> {\n    // No-op since we calculate on-demand\n    this.logger.log(\n      `Generated recommendations for user ${userId} (calculated on-demand)`,\n    );\n  }\n\n  /**\n   * Get a specific recommendation by ID (simplified)\n   */\n  async getRecommendationById(\n    recommendationId: string,\n  ): Promise<CommunityRecommendation | null> {\n    // Since we don't store recommendations, we can't fetch by ID\n    // In a real scenario, you'd need to recalculate or return null\n    return null;\n  }\n\n  /**\n   * Handle recommendation interaction (simplified)\n   */\n  async handleRecommendationInteraction(data: {\n    recommendationId: string;\n    action: string;\n    userId: string;\n  }): Promise<void> {\n    // No-op since we don't store interactions\n    this.logger.log(\n      `User ${data.userId} ${data.action}ed recommendation ${data.recommendationId}`,\n    );\n  }\n\n  /**\n   * Stub method for stats - simplified since no table to query\n   */\n  async getRecommendationStats(): Promise<any> {\n    return {\n      totalRecommendations: 0,\n      acceptedRecommendations: 0,\n      rejectedRecommendations: 0,\n      pendingRecommendations: 0,\n      averageCompatibilityScore: 0,\n      topCommunities: [],\n    };\n  }\n}\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;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","ignoreList":[]}