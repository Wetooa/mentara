d796ba926bd876157d5dd51207b1ce1a
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
exports.AuditLogsService = void 0;
const common_1 = require("@nestjs/common");
const prisma_client_provider_1 = require("src/providers/prisma-client.provider");
const client_1 = require("@prisma/client");
let AuditLogsService = class AuditLogsService {
    prisma;
    constructor(prisma) {
        this.prisma = prisma;
    }
    async createAuditLog(data) {
        return this.prisma.auditLog.create({
            data,
            include: {
                user: {
                    select: {
                        id: true,
                        firstName: true,
                        lastName: true,
                        email: true,
                        role: true,
                    },
                },
            },
        });
    }
    async findAuditLogs(userId, action, entity, entityId, startDate, endDate, limit = 100) {
        const where = {};
        if (userId)
            where.userId = userId;
        if (action)
            where.action = action;
        if (entity)
            where.entity = entity;
        if (entityId)
            where.entityId = entityId;
        if (startDate)
            where.createdAt = { ...where.createdAt, gte: startDate };
        if (endDate)
            where.createdAt = { ...where.createdAt, lte: endDate };
        return this.prisma.auditLog.findMany({
            where,
            include: {
                user: {
                    select: {
                        id: true,
                        firstName: true,
                        lastName: true,
                        email: true,
                        role: true,
                    },
                },
            },
            orderBy: { createdAt: 'desc' },
            take: limit,
        });
    }
    async createSystemEvent(data) {
        return this.prisma.systemEvent.create({
            data,
        });
    }
    async findSystemEvents(eventType, severity, component, isResolved, startDate, endDate, limit = 100) {
        const where = {};
        if (eventType)
            where.eventType = eventType;
        if (severity)
            where.severity = severity;
        if (component)
            where.component = component;
        if (isResolved !== undefined)
            where.isResolved = isResolved;
        if (startDate)
            where.createdAt = { ...where.createdAt, gte: startDate };
        if (endDate)
            where.createdAt = { ...where.createdAt, lte: endDate };
        return this.prisma.systemEvent.findMany({
            where,
            orderBy: { createdAt: 'desc' },
            take: limit,
        });
    }
    async resolveSystemEvent(id, resolvedBy, resolution) {
        return this.prisma.systemEvent.update({
            where: { id },
            data: {
                isResolved: true,
                resolvedAt: new Date(),
                resolvedBy,
                resolution,
            },
        });
    }
    async createDataChangeLog(data) {
        return this.prisma.dataChangeLog.create({
            data: {
                ...data,
                dataClass: data.dataClass || client_1.DataClassification.INTERNAL,
            },
        });
    }
    async findDataChangeLogs(tableName, recordId, operation, changedBy, startDate, endDate, limit = 100) {
        const where = {};
        if (tableName)
            where.tableName = tableName;
        if (recordId)
            where.recordId = recordId;
        if (operation)
            where.operation = operation;
        if (changedBy)
            where.changedBy = changedBy;
        if (startDate)
            where.createdAt = { ...where.createdAt, gte: startDate };
        if (endDate)
            where.createdAt = { ...where.createdAt, lte: endDate };
        return this.prisma.dataChangeLog.findMany({
            where,
            orderBy: { createdAt: 'desc' },
            take: limit,
        });
    }
    // Helper methods for common audit scenarios
    async logUserLogin(userId, ipAddress, userAgent) {
        return this.createAuditLog({
            action: client_1.AuditAction.USER_LOGIN,
            entity: 'User',
            entityId: userId,
            userId,
            description: 'User logged in',
            ipAddress,
            userAgent,
        });
    }
    async logUserLogout(userId, ipAddress, userAgent) {
        return this.createAuditLog({
            action: client_1.AuditAction.USER_LOGOUT,
            entity: 'User',
            entityId: userId,
            userId,
            description: 'User logged out',
            ipAddress,
            userAgent,
        });
    }
    async logProfileUpdate(userId, oldValues, newValues, ipAddress, userAgent) {
        return this.createAuditLog({
            action: client_1.AuditAction.USER_UPDATE_PROFILE,
            entity: 'User',
            entityId: userId,
            userId,
            oldValues,
            newValues,
            description: 'User updated profile',
            ipAddress,
            userAgent,
        });
    }
    async logTherapistApplicationSubmit(userId, applicationData, ipAddress, userAgent) {
        return this.createAuditLog({
            action: client_1.AuditAction.THERAPIST_APPLICATION_SUBMIT,
            entity: 'Therapist',
            entityId: userId,
            userId,
            newValues: applicationData,
            description: 'Therapist application submitted',
            ipAddress,
            userAgent,
        });
    }
    async logTherapistApplicationReview(therapistId, reviewedBy, status, oldStatus, ipAddress, userAgent) {
        const action = status === 'approved'
            ? client_1.AuditAction.THERAPIST_APPLICATION_APPROVE
            : client_1.AuditAction.THERAPIST_APPLICATION_REJECT;
        return this.createAuditLog({
            action,
            entity: 'Therapist',
            entityId: therapistId,
            userId: reviewedBy,
            oldValues: { status: oldStatus },
            newValues: { status },
            description: `Therapist application ${status}`,
            ipAddress,
            userAgent,
        });
    }
    async logMeetingCreate(meetingId, createdBy, meetingData, ipAddress, userAgent) {
        return this.createAuditLog({
            action: client_1.AuditAction.MEETING_CREATE,
            entity: 'Meeting',
            entityId: meetingId,
            userId: createdBy,
            newValues: meetingData,
            description: 'Meeting created',
            ipAddress,
            userAgent,
        });
    }
    async logMeetingUpdate(meetingId, updatedBy, oldValues, newValues, ipAddress, userAgent) {
        return this.createAuditLog({
            action: client_1.AuditAction.MEETING_UPDATE,
            entity: 'Meeting',
            entityId: meetingId,
            userId: updatedBy,
            oldValues,
            newValues,
            description: 'Meeting updated',
            ipAddress,
            userAgent,
        });
    }
    async logSystemError(component, error, metadata) {
        return this.createSystemEvent({
            eventType: client_1.SystemEventType.THIRD_PARTY_API_ERROR,
            severity: client_1.EventSeverity.ERROR,
            title: `Error in ${component}`,
            description: error.message,
            component,
            metadata: {
                ...metadata,
                errorName: error.name,
            },
            stackTrace: error.stack,
        });
    }
    async getAuditStatistics(startDate, endDate) {
        const where = {};
        if (startDate)
            where.createdAt = { ...where.createdAt, gte: startDate };
        if (endDate)
            where.createdAt = { ...where.createdAt, lte: endDate };
        const [totalLogs, actionStats, entityStats, userStats] = await Promise.all([
            this.prisma.auditLog.count({ where }),
            this.prisma.auditLog.groupBy({
                by: ['action'],
                where,
                _count: { action: true },
            }),
            this.prisma.auditLog.groupBy({
                by: ['entity'],
                where,
                _count: { entity: true },
            }),
            this.prisma.auditLog.groupBy({
                by: ['userId'],
                where: { ...where, userId: { not: null } },
                _count: { userId: true },
                take: 10,
                orderBy: { _count: { userId: 'desc' } },
            }),
        ]);
        return {
            totalLogs,
            actionStats,
            entityStats,
            topUsers: userStats,
        };
    }
};
exports.AuditLogsService = AuditLogsService;
exports.AuditLogsService = AuditLogsService = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [typeof (_a = typeof prisma_client_provider_1.PrismaService !== "undefined" && prisma_client_provider_1.PrismaService) === "function" ? _a : Object])
], AuditLogsService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL2F1ZGl0LWxvZ3MvYXVkaXQtbG9ncy5zZXJ2aWNlLnRzIiwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7QUFBQSwyQ0FBNEM7QUFDNUMsaUZBQXFFO0FBQ3JFLDJDQUt3QjtBQUdqQixJQUFNLGdCQUFnQixHQUF0QixNQUFNLGdCQUFnQjtJQUNFO0lBQTdCLFlBQTZCLE1BQXFCO1FBQXJCLFdBQU0sR0FBTixNQUFNLENBQWU7SUFBRyxDQUFDO0lBRXRELEtBQUssQ0FBQyxjQUFjLENBQUMsSUFhcEI7UUFDQyxPQUFPLElBQUksQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQztZQUNqQyxJQUFJO1lBQ0osT0FBTyxFQUFFO2dCQUNQLElBQUksRUFBRTtvQkFDSixNQUFNLEVBQUU7d0JBQ04sRUFBRSxFQUFFLElBQUk7d0JBQ1IsU0FBUyxFQUFFLElBQUk7d0JBQ2YsUUFBUSxFQUFFLElBQUk7d0JBQ2QsS0FBSyxFQUFFLElBQUk7d0JBQ1gsSUFBSSxFQUFFLElBQUk7cUJBQ1g7aUJBQ0Y7YUFDRjtTQUNGLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFRCxLQUFLLENBQUMsYUFBYSxDQUNqQixNQUFlLEVBQ2YsTUFBb0IsRUFDcEIsTUFBZSxFQUNmLFFBQWlCLEVBQ2pCLFNBQWdCLEVBQ2hCLE9BQWMsRUFDZCxLQUFLLEdBQUcsR0FBRztRQUVYLE1BQU0sS0FBSyxHQUFRLEVBQUUsQ0FBQztRQUV0QixJQUFJLE1BQU07WUFBRSxLQUFLLENBQUMsTUFBTSxHQUFHLE1BQU0sQ0FBQztRQUNsQyxJQUFJLE1BQU07WUFBRSxLQUFLLENBQUMsTUFBTSxHQUFHLE1BQU0sQ0FBQztRQUNsQyxJQUFJLE1BQU07WUFBRSxLQUFLLENBQUMsTUFBTSxHQUFHLE1BQU0sQ0FBQztRQUNsQyxJQUFJLFFBQVE7WUFBRSxLQUFLLENBQUMsUUFBUSxHQUFHLFFBQVEsQ0FBQztRQUN4QyxJQUFJ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O2dCQUNkLEtBQUs7Z0JBQ0wsTUFBTSxFQUFFLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRTthQUN6QixDQUFDO1lBQ0YsSUFBSSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDO2dCQUMzQixFQUFFLEVBQUUsQ0FBQyxRQUFRLENBQUM7Z0JBQ2QsS0FBSztnQkFDTCxNQUFNLEVBQUUsRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFO2FBQ3pCLENBQUM7WUFDRixJQUFJLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUM7Z0JBQzNCLEVBQUUsRUFBRSxDQUFDLFFBQVEsQ0FBQztnQkFDZCxLQUFLLEVBQUUsRUFBRSxHQUFHLEtBQUssRUFBRSxNQUFNLEVBQUUsRUFBRSxHQUFHLEVBQUUsSUFBSSxFQUFFLEVBQUU7Z0JBQzFDLE1BQU0sRUFBRSxFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUU7Z0JBQ3hCLElBQUksRUFBRSxFQUFFO2dCQUNSLE9BQU8sRUFBRSxFQUFFLE1BQU0sRUFBRSxFQUFFLE1BQU0sRUFBRSxNQUFNLEVBQUUsRUFBRTthQUN4QyxDQUFDO1NBQ0gsQ0FBQyxDQUFDO1FBRUgsT0FBTztZQUNMLFNBQVM7WUFDVCxXQUFXO1lBQ1gsV0FBVztZQUNYLFFBQVEsRUFBRSxTQUFTO1NBQ3BCLENBQUM7SUFDSixDQUFDO0NBQ0YsQ0FBQTtBQXZWWSw0Q0FBZ0I7MkJBQWhCLGdCQUFnQjtJQUQ1QixJQUFBLG1CQUFVLEdBQUU7eURBRTBCLHNDQUFhLG9CQUFiLHNDQUFhO0dBRHZDLGdCQUFnQixDQXVWNUIiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL2F1ZGl0LWxvZ3MvYXVkaXQtbG9ncy5zZXJ2aWNlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAbmVzdGpzL2NvbW1vbic7XG5pbXBvcnQgeyBQcmlzbWFTZXJ2aWNlIH0gZnJvbSAnc3JjL3Byb3ZpZGVycy9wcmlzbWEtY2xpZW50LnByb3ZpZGVyJztcbmltcG9ydCB7XG4gIEF1ZGl0QWN0aW9uLFxuICBFdmVudFNldmVyaXR5LFxuICBTeXN0ZW1FdmVudFR5cGUsXG4gIERhdGFDbGFzc2lmaWNhdGlvbixcbn0gZnJvbSAnQHByaXNtYS9jbGllbnQnO1xuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgQXVkaXRMb2dzU2VydmljZSB7XG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgcmVhZG9ubHkgcHJpc21hOiBQcmlzbWFTZXJ2aWNlKSB7fVxuXG4gIGFzeW5jIGNyZWF0ZUF1ZGl0TG9nKGRhdGE6IHtcbiAgICBhY3Rpb246IEF1ZGl0QWN0aW9uO1xuICAgIGVudGl0eTogc3RyaW5nO1xuICAgIGVudGl0eUlkOiBzdHJpbmc7XG4gICAgdXNlcklkPzogc3RyaW5nO1xuICAgIHVzZXJSb2xlPzogc3RyaW5nO1xuICAgIG9sZFZhbHVlcz86IGFueTtcbiAgICBuZXdWYWx1ZXM/OiBhbnk7XG4gICAgZGVzY3JpcHRpb24/OiBzdHJpbmc7XG4gICAgbWV0YWRhdGE/OiBhbnk7XG4gICAgaXBBZGRyZXNzPzogc3RyaW5nO1xuICAgIHVzZXJBZ2VudD86IHN0cmluZztcbiAgICByZXF1ZXN0SWQ/OiBzdHJpbmc7XG4gIH0pIHtcbiAgICByZXR1cm4gdGhpcy5wcmlzbWEuYXVkaXRMb2cuY3JlYXRlKHtcbiAgICAgIGRhdGEsXG4gICAgICBpbmNsdWRlOiB7XG4gICAgICAgIHVzZXI6IHtcbiAgICAgICAgICBzZWxlY3Q6IHtcbiAgICAgICAgICAgIGlkOiB0cnVlLFxuICAgICAgICAgICAgZmlyc3ROYW1lOiB0cnVlLFxuICAgICAgICAgICAgbGFzdE5hbWU6IHRydWUsXG4gICAgICAgICAgICBlbWFpbDogdHJ1ZSxcbiAgICAgICAgICAgIHJvbGU6IHRydWUsXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgIH0sXG4gICAgfSk7XG4gIH1cblxuICBhc3luYyBmaW5kQXVkaXRMb2dzKFxuICAgIHVzZXJJZD86IHN0cmluZyxcbiAgICBhY3Rpb24/OiBBdWRpdEFjdGlvbixcbiAgICBlbnRpdHk/OiBzdHJpbmcsXG4gICAgZW50aXR5SWQ/OiBzdHJpbmcsXG4gICAgc3RhcnREYXRlPzogRGF0ZSxcbiAgICBlbmREYXRlPzogRGF0ZSxcbiAgICBsaW1pdCA9IDEwMCxcbiAgKSB7XG4gICAgY29uc3Qgd2hlcmU6IGFueSA9IHt9O1xuXG4gICAgaWYgKHVzZXJJZCkgd2hlcmUudXNlcklkID0gdXNlcklkO1xuICAgIGlmIChhY3Rpb24pIHdoZXJlLmFjdGlvbiA9IGFjdGlvbjtcbiAgICBpZiAoZW50aXR5KSB3aGVyZS5lbnRpdHkgPSBlbnRpdHk7XG4gICAgaWYgKGVudGl0eUlkKSB3aGVyZS5lbnRpdHlJZCA9IGVudGl0eUlkO1xuICAgIGlmIChzdGFydERhdGUpIHdoZXJlLmNyZWF0ZWRBdCA9IHsgLi4ud2hlcmUuY3JlYXRlZEF0LCBndGU6IHN0YXJ0RGF0ZSB9O1xuICAgIGlmIChlbmREYXRlKSB3aGVyZS5jcmVhdGVkQXQgPSB7IC4uLndoZXJlLmNyZWF0ZWRBdCwgbHRlOiBlbmREYXRlIH07XG5cbiAgICByZXR1cm4gdGhpcy5wcmlzbWEuYXVkaXRMb2cuZmluZE1hbnkoe1xuICAgICAgd2hlcmUsXG4gICAgICBpbmNsdWRlOiB7XG4gICAgICAgIHVzZXI6IHtcbiAgICAgICAgICBzZWxlY3Q6IHtcbiAgICAgICAgICAgIGlkOiB0cnVlLFxuICAgICAgICAgICAgZmlyc3ROYW1lOiB0cnVlLFxuICAgICAgICAgICAgbGFzdE5hbWU6IHRydWUsXG4gICAgICAgICAgICBlbWFpbDogdHJ1ZSxcbiAgICAgICAgICAgIHJvbGU6IHRydWUsXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgIH0sXG4gICAgICBvcmRlckJ5OiB7IGNyZWF0ZWRBdDogJ2Rlc2MnIH0sXG4gICAgICB0YWtlOiBsaW1pdCxcbiAgICB9KTtcbiAgfVxuXG4gIGFzeW5jIGNyZWF0ZVN5c3RlbUV2ZW50KGRhdGE6IHtcbiAgICBldmVudFR5cGU6IFN5c3RlbUV2ZW50VHlwZTtcbiAgICBzZXZlcml0eTogRXZlbnRTZXZlcml0eTtcbiAgICB0aXRsZTogc3RyaW5nO1xuICAgIGRlc2NyaXB0aW9uOiBzdHJpbmc7XG4gICAgY29tcG9uZW50Pzogc3RyaW5nO1xuICAgIG1ldGFkYXRhPzogYW55O1xuICAgIGVycm9yQ29kZT86IHN0cmluZztcbiAgICBzdGFja1RyYWNlPzogc3RyaW5nO1xuICB9KSB7XG4gICAgcmV0dXJuIHRoaXMucHJpc21hLnN5c3RlbUV2ZW50LmNyZWF0ZSh7XG4gICAgICBkYXRhLFxuICAgIH0pO1xuICB9XG5cbiAgYXN5bmMgZmluZFN5c3RlbUV2ZW50cyhcbiAgICBldmVudFR5cGU/OiBTeXN0ZW1FdmVudFR5cGUsXG4gICAgc2V2ZXJpdHk/OiBFdmVudFNldmVyaXR5LFxuICAgIGNvbXBvbmVudD86IHN0cmluZyxcbiAgICBpc1Jlc29sdmVkPzogYm9vbGVhbixcbiAgICBzdGFydERhdGU/OiBEYXRlLFxuICAgIGVuZERhdGU/OiBEYXRlLFxuICAgIGxpbWl0ID0gMTAwLFxuICApIHtcbiAgICBjb25zdCB3aGVyZTogYW55ID0ge307XG5cbiAgICBpZiAoZXZlbnRUeXBlKSB3aGVyZS5ldmVudFR5cGUgPSBldmVudFR5cGU7XG4gICAgaWYgKHNldmVyaXR5KSB3aGVyZS5zZXZlcml0eSA9IHNldmVyaXR5O1xuICAgIGlmIChjb21wb25lbnQpIHdoZXJlLmNvbXBvbmVudCA9IGNvbXBvbmVudDtcbiAgICBpZiAoaXNSZXNvbHZlZCAhPT0gdW5kZWZpbmVkKSB3aGVyZS5pc1Jlc29sdmVkID0gaXNSZXNvbHZlZDtcbiAgICBpZiAoc3RhcnREYXRlKSB3aGVyZS5jcmVhdGVkQXQgPSB7IC4uLndoZXJlLmNyZWF0ZWRBdCwgZ3RlOiBzdGFydERhdGUgfTtcbiAgICBpZiAoZW5kRGF0ZSkgd2hlcmUuY3JlYXRlZEF0ID0geyAuLi53aGVyZS5jcmVhdGVkQXQsIGx0ZTogZW5kRGF0ZSB9O1xuXG4gICAgcmV0dXJuIHRoaXMucHJpc21hLnN5c3RlbUV2ZW50LmZpbmRNYW55KHtcbiAgICAgIHdoZXJlLFxuICAgICAgb3JkZXJCeTogeyBjcmVhdGVkQXQ6ICdkZXNjJyB9LFxuICAgICAgdGFrZTogbGltaXQsXG4gICAgfSk7XG4gIH1cblxuICBhc3luYyByZXNvbHZlU3lzdGVtRXZlbnQoaWQ6IHN0cmluZywgcmVzb2x2ZWRCeTogc3RyaW5nLCByZXNvbHV0aW9uOiBzdHJpbmcpIHtcbiAgICByZXR1cm4gdGhpcy5wcmlzbWEuc3lzdGVtRXZlbnQudXBkYXRlKHtcbiAgICAgIHdoZXJlOiB7IGlkIH0sXG4gICAgICBkYXRhOiB7XG4gICAgICAgIGlzUmVzb2x2ZWQ6IHRydWUsXG4gICAgICAgIHJlc29sdmVkQXQ6IG5ldyBEYXRlKCksXG4gICAgICAgIHJlc29sdmVkQnksXG4gICAgICAgIHJlc29sdXRpb24sXG4gICAgICB9LFxuICAgIH0pO1xuICB9XG5cbiAgYXN5bmMgY3JlYXRlRGF0YUNoYW5nZUxvZyhkYXRhOiB7XG4gICAgdGFibGVOYW1lOiBzdHJpbmc7XG4gICAgcmVjb3JkSWQ6IHN0cmluZztcbiAgICBvcGVyYXRpb246ICdJTlNFUlQnIHwgJ1VQREFURScgfCAnREVMRVRFJztcbiAgICBjaGFuZ2VkRmllbGRzPzogc3RyaW5nW107XG4gICAgb2xkRGF0YT86IGFueTtcbiAgICBuZXdEYXRhPzogYW55O1xuICAgIGNoYW5nZWRCeT86IHN0cmluZztcbiAgICByZWFzb24/OiBzdHJpbmc7XG4gICAgZGF0YUNsYXNzPzogRGF0YUNsYXNzaWZpY2F0aW9uO1xuICB9KSB7XG4gICAgcmV0dXJuIHRoaXMucHJpc21hLmRhdGFDaGFuZ2VMb2cuY3JlYXRlKHtcbiAgICAgIGRhdGE6IHtcbiAgICAgICAgLi4uZGF0YSxcbiAgICAgICAgZGF0YUNsYXNzOiBkYXRhLmRhdGFDbGFzcyB8fCBEYXRhQ2xhc3NpZmljYXRpb24uSU5URVJOQUwsXG4gICAgICB9LFxuICAgIH0pO1xuICB9XG5cbiAgYXN5bmMgZmluZERhdGFDaGFuZ2VMb2dzKFxuICAgIHRhYmxlTmFtZT86IHN0cmluZyxcbiAgICByZWNvcmRJZD86IHN0cmluZyxcbiAgICBvcGVyYXRpb24/OiBzdHJpbmcsXG4gICAgY2hhbmdlZEJ5Pzogc3RyaW5nLFxuICAgIHN0YXJ0RGF0ZT86IERhdGUsXG4gICAgZW5kRGF0ZT86IERhdGUsXG4gICAgbGltaXQgPSAxMDAsXG4gICkge1xuICAgIGNvbnN0IHdoZXJlOiBhbnkgPSB7fTtcblxuICAgIGlmICh0YWJsZU5hbWUpIHdoZXJlLnRhYmxlTmFtZSA9IHRhYmxlTmFtZTtcbiAgICBpZiAocmVjb3JkSWQpIHdoZXJlLnJlY29yZElkID0gcmVjb3JkSWQ7XG4gICAgaWYgKG9wZXJhdGlvbikgd2hlcmUub3BlcmF0aW9uID0gb3BlcmF0aW9uO1xuICAgIGlmIChjaGFuZ2VkQnkpIHdoZXJlLmNoYW5nZWRCeSA9IGNoYW5nZWRCeTtcbiAgICBpZiAoc3RhcnREYXRlKSB3aGVyZS5jcmVhdGVkQXQgPSB7IC4uLndoZXJlLmNyZWF0ZWRBdCwgZ3RlOiBzdGFydERhdGUgfTtcbiAgICBpZiAoZW5kRGF0ZSkgd2hlcmUuY3JlYXRlZEF0ID0geyAuLi53aGVyZS5jcmVhdGVkQXQsIGx0ZTogZW5kRGF0ZSB9O1xuXG4gICAgcmV0dXJuIHRoaXMucHJpc21hLmRhdGFDaGFuZ2VMb2cuZmluZE1hbnkoe1xuICAgICAgd2hlcmUsXG4gICAgICBvcmRlckJ5OiB7IGNyZWF0ZWRBdDogJ2Rlc2MnIH0sXG4gICAgICB0YWtlOiBsaW1pdCxcbiAgICB9KTtcbiAgfVxuXG4gIC8vIEhlbHBlciBtZXRob2RzIGZvciBjb21tb24gYXVkaXQgc2NlbmFyaW9zXG5cbiAgYXN5bmMgbG9nVXNlckxvZ2luKHVzZXJJZDogc3RyaW5nLCBpcEFkZHJlc3M/OiBzdHJpbmcsIHVzZXJBZ2VudD86IHN0cmluZykge1xuICAgIHJldHVybiB0aGlzLmNyZWF0ZUF1ZGl0TG9nKHtcbiAgICAgIGFjdGlvbjogQXVkaXRBY3Rpb24uVVNFUl9MT0dJTixcbiAgICAgIGVudGl0eTogJ1VzZXInLFxuICAgICAgZW50aXR5SWQ6IHVzZXJJZCxcbiAgICAgIHVzZXJJZCxcbiAgICAgIGRlc2NyaXB0aW9uOiAnVXNlciBsb2dnZWQgaW4nLFxuICAgICAgaXBBZGRyZXNzLFxuICAgICAgdXNlckFnZW50LFxuICAgIH0pO1xuICB9XG5cbiAgYXN5bmMgbG9nVXNlckxvZ291dCh1c2VySWQ6IHN0cmluZywgaXBBZGRyZXNzPzogc3RyaW5nLCB1c2VyQWdlbnQ/OiBzdHJpbmcpIHtcbiAgICByZXR1cm4gdGhpcy5jcmVhdGVBdWRpdExvZyh7XG4gICAgICBhY3Rpb246IEF1ZGl0QWN0aW9uLlVTRVJfTE9HT1VULFxuICAgICAgZW50aXR5OiAnVXNlcicsXG4gICAgICBlbnRpdHlJZDogdXNlcklkLFxuICAgICAgdXNlcklkLFxuICAgICAgZGVzY3JpcHRpb246ICdVc2VyIGxvZ2dlZCBvdXQnLFxuICAgICAgaXBBZGRyZXNzLFxuICAgICAgdXNlckFnZW50LFxuICAgIH0pO1xuICB9XG5cbiAgYXN5bmMgbG9nUHJvZmlsZVVwZGF0ZShcbiAgICB1c2VySWQ6IHN0cmluZyxcbiAgICBvbGRWYWx1ZXM6IGFueSxcbiAgICBuZXdWYWx1ZXM6IGFueSxcbiAgICBpcEFkZHJlc3M/OiBzdHJpbmcsXG4gICAgdXNlckFnZW50Pzogc3RyaW5nLFxuICApIHtcbiAgICByZXR1cm4gdGhpcy5jcmVhdGVBdWRpdExvZyh7XG4gICAgICBhY3Rpb246IEF1ZGl0QWN0aW9uLlVTRVJfVVBEQVRFX1BST0ZJTEUsXG4gICAgICBlbnRpdHk6ICdVc2VyJyxcbiAgICAgIGVudGl0eUlkOiB1c2VySWQsXG4gICAgICB1c2VySWQsXG4gICAgICBvbGRWYWx1ZXMsXG4gICAgICBuZXdWYWx1ZXMsXG4gICAgICBkZXNjcmlwdGlvbjogJ1VzZXIgdXBkYXRlZCBwcm9maWxlJyxcbiAgICAgIGlwQWRkcmVzcyxcbiAgICAgIHVzZXJBZ2VudCxcbiAgICB9KTtcbiAgfVxuXG4gIGFzeW5jIGxvZ1RoZXJhcGlzdEFwcGxpY2F0aW9uU3VibWl0KFxuICAgIHVzZXJJZDogc3RyaW5nLFxuICAgIGFwcGxpY2F0aW9uRGF0YTogYW55LFxuICAgIGlwQWRkcmVzcz86IHN0cmluZyxcbiAgICB1c2VyQWdlbnQ/OiBzdHJpbmcsXG4gICkge1xuICAgIHJldHVybiB0aGlzLmNyZWF0ZUF1ZGl0TG9nKHtcbiAgICAgIGFjdGlvbjogQXVkaXRBY3Rpb24uVEhFUkFQSVNUX0FQUExJQ0FUSU9OX1NVQk1JVCxcbiAgICAgIGVudGl0eTogJ1RoZXJhcGlzdCcsXG4gICAgICBlbnRpdHlJZDogdXNlcklkLFxuICAgICAgdXNlcklkLFxuICAgICAgbmV3VmFsdWVzOiBhcHBsaWNhdGlvbkRhdGEsXG4gICAgICBkZXNjcmlwdGlvbjogJ1RoZXJhcGlzdCBhcHBsaWNhdGlvbiBzdWJtaXR0ZWQnLFxuICAgICAgaXBBZGRyZXNzLFxuICAgICAgdXNlckFnZW50LFxuICAgIH0pO1xuICB9XG5cbiAgYXN5bmMgbG9nVGhlcmFwaXN0QXBwbGljYXRpb25SZXZpZXcoXG4gICAgdGhlcmFwaXN0SWQ6IHN0cmluZyxcbiAgICByZXZpZXdlZEJ5OiBzdHJpbmcsXG4gICAgc3RhdHVzOiAnYXBwcm92ZWQnIHwgJ3JlamVjdGVkJyxcbiAgICBvbGRTdGF0dXM6IHN0cmluZyxcbiAgICBpcEFkZHJlc3M/OiBzdHJpbmcsXG4gICAgdXNlckFnZW50Pzogc3RyaW5nLFxuICApIHtcbiAgICBjb25zdCBhY3Rpb24gPVxuICAgICAgc3RhdHVzID09PSAnYXBwcm92ZWQnXG4gICAgICAgID8gQXVkaXRBY3Rpb24uVEhFUkFQSVNUX0FQUExJQ0FUSU9OX0FQUFJPVkVcbiAgICAgICAgOiBBdWRpdEFjdGlvbi5USEVSQVBJU1RfQVBQTElDQVRJT05fUkVKRUNUO1xuXG4gICAgcmV0dXJuIHRoaXMuY3JlYXRlQXVkaXRMb2coe1xuICAgICAgYWN0aW9uLFxuICAgICAgZW50aXR5OiAnVGhlcmFwaXN0JyxcbiAgICAgIGVudGl0eUlkOiB0aGVyYXBpc3RJZCxcbiAgICAgIHVzZXJJZDogcmV2aWV3ZWRCeSxcbiAgICAgIG9sZFZhbHVlczogeyBzdGF0dXM6IG9sZFN0YXR1cyB9LFxuICAgICAgbmV3VmFsdWVzOiB7IHN0YXR1cyB9LFxuICAgICAgZGVzY3JpcHRpb246IGBUaGVyYXBpc3QgYXBwbGljYXRpb24gJHtzdGF0dXN9YCxcbiAgICAgIGlwQWRkcmVzcyxcbiAgICAgIHVzZXJBZ2VudCxcbiAgICB9KTtcbiAgfVxuXG4gIGFzeW5jIGxvZ01lZXRpbmdDcmVhdGUoXG4gICAgbWVldGluZ0lkOiBzdHJpbmcsXG4gICAgY3JlYXRlZEJ5OiBzdHJpbmcsXG4gICAgbWVldGluZ0RhdGE6IGFueSxcbiAgICBpcEFkZHJlc3M/OiBzdHJpbmcsXG4gICAgdXNlckFnZW50Pzogc3RyaW5nLFxuICApIHtcbiAgICByZXR1cm4gdGhpcy5jcmVhdGVBdWRpdExvZyh7XG4gICAgICBhY3Rpb246IEF1ZGl0QWN0aW9uLk1FRVRJTkdfQ1JFQVRFLFxuICAgICAgZW50aXR5OiAnTWVldGluZycsXG4gICAgICBlbnRpdHlJZDogbWVldGluZ0lkLFxuICAgICAgdXNlcklkOiBjcmVhdGVkQnksXG4gICAgICBuZXdWYWx1ZXM6IG1lZXRpbmdEYXRhLFxuICAgICAgZGVzY3JpcHRpb246ICdNZWV0aW5nIGNyZWF0ZWQnLFxuICAgICAgaXBBZGRyZXNzLFxuICAgICAgdXNlckFnZW50LFxuICAgIH0pO1xuICB9XG5cbiAgYXN5bmMgbG9nTWVldGluZ1VwZGF0ZShcbiAgICBtZWV0aW5nSWQ6IHN0cmluZyxcbiAgICB1cGRhdGVkQnk6IHN0cmluZyxcbiAgICBvbGRWYWx1ZXM6IGFueSxcbiAgICBuZXdWYWx1ZXM6IGFueSxcbiAgICBpcEFkZHJlc3M/OiBzdHJpbmcsXG4gICAgdXNlckFnZW50Pzogc3RyaW5nLFxuICApIHtcbiAgICByZXR1cm4gdGhpcy5jcmVhdGVBdWRpdExvZyh7XG4gICAgICBhY3Rpb246IEF1ZGl0QWN0aW9uLk1FRVRJTkdfVVBEQVRFLFxuICAgICAgZW50aXR5OiAnTWVldGluZycsXG4gICAgICBlbnRpdHlJZDogbWVldGluZ0lkLFxuICAgICAgdXNlcklkOiB1cGRhdGVkQnksXG4gICAgICBvbGRWYWx1ZXMsXG4gICAgICBuZXdWYWx1ZXMsXG4gICAgICBkZXNjcmlwdGlvbjogJ01lZXRpbmcgdXBkYXRlZCcsXG4gICAgICBpcEFkZHJlc3MsXG4gICAgICB1c2VyQWdlbnQsXG4gICAgfSk7XG4gIH1cblxuICBhc3luYyBsb2dTeXN0ZW1FcnJvcihjb21wb25lbnQ6IHN0cmluZywgZXJyb3I6IEVycm9yLCBtZXRhZGF0YT86IGFueSkge1xuICAgIHJldHVybiB0aGlzLmNyZWF0ZVN5c3RlbUV2ZW50KHtcbiAgICAgIGV2ZW50VHlwZTogU3lzdGVtRXZlbnRUeXBlLlRISVJEX1BBUlRZX0FQSV9FUlJPUixcbiAgICAgIHNldmVyaXR5OiBFdmVudFNldmVyaXR5LkVSUk9SLFxuICAgICAgdGl0bGU6IGBFcnJvciBpbiAke2NvbXBvbmVudH1gLFxuICAgICAgZGVzY3JpcHRpb246IGVycm9yLm1lc3NhZ2UsXG4gICAgICBjb21wb25lbnQsXG4gICAgICBtZXRhZGF0YToge1xuICAgICAgICAuLi5tZXRhZGF0YSxcbiAgICAgICAgZXJyb3JOYW1lOiBlcnJvci5uYW1lLFxuICAgICAgfSxcbiAgICAgIHN0YWNrVHJhY2U6IGVycm9yLnN0YWNrLFxuICAgIH0pO1xuICB9XG5cbiAgYXN5bmMgZ2V0QXVkaXRTdGF0aXN0aWNzKHN0YXJ0RGF0ZT86IERhdGUsIGVuZERhdGU/OiBEYXRlKSB7XG4gICAgY29uc3Qgd2hlcmU6IGFueSA9IHt9O1xuICAgIGlmIChzdGFydERhdGUpIHdoZXJlLmNyZWF0ZWRBdCA9IHsgLi4ud2hlcmUuY3JlYXRlZEF0LCBndGU6IHN0YXJ0RGF0ZSB9O1xuICAgIGlmIChlbmREYXRlKSB3aGVyZS5jcmVhdGVkQXQgPSB7IC4uLndoZXJlLmNyZWF0ZWRBdCwgbHRlOiBlbmREYXRlIH07XG5cbiAgICBjb25zdCBbdG90YWxMb2dzLCBhY3Rpb25TdGF0cywgZW50aXR5U3RhdHMsIHVzZXJTdGF0c10gPSBhd2FpdCBQcm9taXNlLmFsbChbXG4gICAgICB0aGlzLnByaXNtYS5hdWRpdExvZy5jb3VudCh7IHdoZXJlIH0pLFxuICAgICAgdGhpcy5wcmlzbWEuYXVkaXRMb2cuZ3JvdXBCeSh7XG4gICAgICAgIGJ5OiBbJ2FjdGlvbiddLFxuICAgICAgICB3aGVyZSxcbiAgICAgICAgX2NvdW50OiB7IGFjdGlvbjogdHJ1ZSB9LFxuICAgICAgfSksXG4gICAgICB0aGlzLnByaXNtYS5hdWRpdExvZy5ncm91cEJ5KHtcbiAgICAgICAgYnk6IFsnZW50aXR5J10sXG4gICAgICAgIHdoZXJlLFxuICAgICAgICBfY291bnQ6IHsgZW50aXR5OiB0cnVlIH0sXG4gICAgICB9KSxcbiAgICAgIHRoaXMucHJpc21hLmF1ZGl0TG9nLmdyb3VwQnkoe1xuICAgICAgICBieTogWyd1c2VySWQnXSxcbiAgICAgICAgd2hlcmU6IHsgLi4ud2hlcmUsIHVzZXJJZDogeyBub3Q6IG51bGwgfSB9LFxuICAgICAgICBfY291bnQ6IHsgdXNlcklkOiB0cnVlIH0sXG4gICAgICAgIHRha2U6IDEwLFxuICAgICAgICBvcmRlckJ5OiB7IF9jb3VudDogeyB1c2VySWQ6ICdkZXNjJyB9IH0sXG4gICAgICB9KSxcbiAgICBdKTtcblxuICAgIHJldHVybiB7XG4gICAgICB0b3RhbExvZ3MsXG4gICAgICBhY3Rpb25TdGF0cyxcbiAgICAgIGVudGl0eVN0YXRzLFxuICAgICAgdG9wVXNlcnM6IHVzZXJTdGF0cyxcbiAgICB9O1xuICB9XG59XG4iXSwidmVyc2lvbiI6M30=