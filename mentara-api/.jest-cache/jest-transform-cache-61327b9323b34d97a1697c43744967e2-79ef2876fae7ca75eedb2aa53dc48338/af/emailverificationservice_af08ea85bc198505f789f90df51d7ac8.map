{"version":3,"names":["cov_1e7hd6o1d4","actualCoverage","common_1","s","require","prisma_client_provider_1","email_service_1","EmailVerificationService","prisma","emailService","constructor","f","sendVerificationEmail","userId","user","findUnique","where","id","b","BadRequestException","emailVerified","otpCode","generateOtp","expiresAt","Date","now","update","data","emailVerifyToken","emailVerifyTokenExp","sendOTP","email","firstName","verifyEmail","token","findFirst","gt","success","message","resendVerificationEmail","exports","__decorate","Injectable","PrismaService","_a","Object","_b","EmailService"],"sources":["/home/wetooa/Documents/code/projects/mentara/mentara-api/src/auth/services/email-verification.service.ts"],"sourcesContent":["import { Injectable, BadRequestException } from '@nestjs/common';\nimport { PrismaService } from '../../providers/prisma-client.provider';\nimport { EmailService } from '../../email/email.service';\nimport * as crypto from 'crypto';\n\n@Injectable()\nexport class EmailVerificationService {\n  constructor(\n    private readonly prisma: PrismaService,\n    private readonly emailService: EmailService,\n  ) {}\n\n  /**\n   * Send verification email to user\n   * @param userId - User ID to send verification email to\n   */\n  async sendVerificationEmail(userId: string): Promise<void> {\n    const user = await this.prisma.user.findUnique({\n      where: { id: userId },\n    });\n\n    if (!user) {\n      throw new BadRequestException('User not found');\n    }\n\n    if (user.emailVerified) {\n      throw new BadRequestException('Email is already verified');\n    }\n\n    // Generate raw OTP code\n    const otpCode = this.emailService.generateOtp(6);\n    const expiresAt = new Date(Date.now() + 24 * 60 * 60 * 1000); // 24 hours\n\n    // Store raw OTP in database\n    await this.prisma.user.update({\n      where: { id: userId },\n      data: {\n        emailVerifyToken: otpCode, // Store raw OTP instead of crypto token\n        emailVerifyTokenExp: expiresAt,\n      },\n    });\n\n    // Send the same OTP code via email\n    await this.emailService.sendOTP(\n      user.email,\n      user.firstName || 'User',\n      'Verify Your Mentara Email Address',\n      otpCode, // Pass the generated OTP code\n      '24 hours',\n    );\n  }\n\n  /**\n   * Verify email with verification token\n   * @param token - Verification token\n   * @returns Verification result\n   */\n  async verifyEmail(\n    token: string,\n  ): Promise<{ success: boolean; message: string }> {\n    const user = await this.prisma.user.findFirst({\n      where: {\n        emailVerifyToken: token, // Direct comparison with raw OTP\n        emailVerifyTokenExp: {\n          gt: new Date(),\n        },\n      },\n    });\n\n    if (!user) {\n      return {\n        success: false,\n        message: 'Invalid or expired verification token',\n      };\n    }\n\n    // Mark email as verified and clear token\n    await this.prisma.user.update({\n      where: { id: user.id },\n      data: {\n        emailVerified: true,\n        emailVerifyToken: null,\n        emailVerifyTokenExp: null,\n      },\n    });\n\n    return {\n      success: true,\n      message: 'Email verified successfully',\n    };\n  }\n\n  /**\n   * Resend verification email\n   * @param email - User email to resend verification to\n   */\n  async resendVerificationEmail(email: string): Promise<void> {\n    const user = await this.prisma.user.findUnique({\n      where: { email },\n    });\n\n    if (!user) {\n      throw new BadRequestException('User not found');\n    }\n\n    if (user.emailVerified) {\n      throw new BadRequestException('Email is already verified');\n    }\n\n    // Reuse the sendVerificationEmail method\n    await this.sendVerificationEmail(user.id);\n  }\n}\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;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","ignoreList":[]}