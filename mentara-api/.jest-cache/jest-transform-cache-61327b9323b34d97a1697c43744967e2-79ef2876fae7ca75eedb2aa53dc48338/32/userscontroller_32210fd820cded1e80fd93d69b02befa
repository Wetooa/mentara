37707832f94d86109c4834af2d98543e
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var __param = (this && this.__param) || function (paramIndex, decorator) {
    return function (target, key) { decorator(target, key, paramIndex); }
};
var UsersController_1;
Object.defineProperty(exports, "__esModule", { value: true });
exports.UsersController = void 0;
const common_1 = require("@nestjs/common");
const client_1 = require("@prisma/client");
const clerk_auth_guard_1 = require("src/guards/clerk-auth.guard");
const admin_auth_guard_1 = require("src/guards/admin-auth.guard");
const admin_only_decorator_1 = require("src/decorators/admin-only.decorator");
const current_user_id_decorator_1 = require("src/decorators/current-user-id.decorator");
const users_service_1 = require("./users.service");
const role_utils_1 = require("src/utils/role-utils");
let UsersController = UsersController_1 = class UsersController {
    usersService;
    roleUtils;
    logger = new common_1.Logger(UsersController_1.name);
    constructor(usersService, roleUtils) {
        this.usersService = usersService;
        this.roleUtils = roleUtils;
    }
    async findAll(currentUserId) {
        try {
            this.logger.log(`Admin ${currentUserId} retrieving all users`);
            return await this.usersService.findAll();
        }
        catch (error) {
            this.logger.error('Failed to fetch users:', error);
            throw new common_1.HttpException(`Failed to fetch users: ${error instanceof Error ? error.message : 'Unknown error'}`, common_1.HttpStatus.INTERNAL_SERVER_ERROR);
        }
    }
    async findAllIncludeInactive(currentUserId) {
        try {
            this.logger.log(`Admin ${currentUserId} retrieving all users including inactive`);
            return await this.usersService.findAllIncludeInactive();
        }
        catch (error) {
            this.logger.error('Failed to fetch all users:', error);
            throw new common_1.HttpException(`Failed to fetch users: ${error instanceof Error ? error.message : 'Unknown error'}`, common_1.HttpStatus.INTERNAL_SERVER_ERROR);
        }
    }
    async findOne(id, currentUserId) {
        try {
            // Users can only view their own profile unless they're admin
            const isAdmin = await this.roleUtils.isUserAdmin(currentUserId);
            if (!isAdmin && id !== currentUserId) {
                throw new common_1.ForbiddenException('You can only access your own profile');
            }
            const user = isAdmin
                ? await this.usersService.findOneIncludeInactive(id)
                : await this.usersService.findOne(id);
            if (!user) {
                throw new common_1.HttpException('User not found', common_1.HttpStatus.NOT_FOUND);
            }
            return user;
        }
        catch (error) {
            if (error instanceof common_1.ForbiddenException ||
                error instanceof common_1.HttpException) {
                throw error;
            }
            this.logger.error('Failed to fetch user:', error);
            throw new common_1.HttpException(`Failed to fetch user: ${error instanceof Error ? error.message : 'Unknown error'}`, common_1.HttpStatus.INTERNAL_SERVER_ERROR);
        }
    }
    async update(id, userData, currentUserId) {
        try {
            // Users can only update their own profile unless they're admin
            const isAdmin = await this.roleUtils.isUserAdmin(currentUserId);
            if (!isAdmin && id !== currentUserId) {
                throw new common_1.ForbiddenException('You can only update your own profile');
            }
            // Prevent non-admins from changing sensitive fields
            if (!isAdmin) {
                const allowedFields = [
                    'firstName',
                    'lastName',
                    'bio',
                    'avatarUrl',
                    'phoneNumber',
                    'timezone',
                    'language',
                    'theme',
                ];
                const sanitizedData = {};
                for (const field of allowedFields) {
                    if (userData[field] !== undefined) {
                        sanitizedData[field] = userData[field];
                    }
                }
                userData = sanitizedData;
            }
            return await this.usersService.update(id, userData);
        }
        catch (error) {
            if (error instanceof common_1.ForbiddenException) {
                throw error;
            }
            this.logger.error('Failed to update user:', error);
            throw new common_1.HttpException(`Failed to update user: ${error instanceof Error ? error.message : 'Unknown error'}`, common_1.HttpStatus.INTERNAL_SERVER_ERROR);
        }
    }
    async remove(id, currentUserId) {
        try {
            // Users can only deactivate their own account unless they're admin
            const isAdmin = await this.roleUtils.isUserAdmin(currentUserId);
            if (!isAdmin && id !== currentUserId) {
                throw new common_1.ForbiddenException('You can only deactivate your own account');
            }
            this.logger.log(`User/Admin ${currentUserId} deactivating user ${id}`);
            await this.usersService.remove(id);
            return { message: 'User account deactivated successfully' };
        }
        catch (error) {
            if (error instanceof common_1.ForbiddenException) {
                throw error;
            }
            this.logger.error('Failed to deactivate user:', error);
            throw new common_1.HttpException(`Failed to deactivate user: ${error instanceof Error ? error.message : 'Unknown error'}`, common_1.HttpStatus.INTERNAL_SERVER_ERROR);
        }
    }
    async deactivateUser(id, body, currentUserId) {
        try {
            this.logger.log(`Admin ${currentUserId} deactivating user ${id} with reason: ${body.reason}`);
            await this.usersService.deactivate(id, body.reason, currentUserId);
            return { message: 'User account deactivated by administrator' };
        }
        catch (error) {
            this.logger.error('Failed to deactivate user:', error);
            throw new common_1.HttpException(`Failed to deactivate user: ${error instanceof Error ? error.message : 'Unknown error'}`, common_1.HttpStatus.INTERNAL_SERVER_ERROR);
        }
    }
    async reactivateUser(id, currentUserId) {
        try {
            this.logger.log(`Admin ${currentUserId} reactivating user ${id}`);
            await this.usersService.reactivate(id);
            return { message: 'User account reactivated successfully' };
        }
        catch (error) {
            this.logger.error('Failed to reactivate user:', error);
            throw new common_1.HttpException(`Failed to reactivate user: ${error instanceof Error ? error.message : 'Unknown error'}`, common_1.HttpStatus.INTERNAL_SERVER_ERROR);
        }
    }
};
exports.UsersController = UsersController;
__decorate([
    (0, common_1.Get)(),
    (0, common_1.UseGuards)(admin_auth_guard_1.AdminAuthGuard),
    (0, admin_only_decorator_1.AdminOnly)(),
    __param(0, (0, current_user_id_decorator_1.CurrentUserId)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [String]),
    __metadata("design:returntype", Promise)
], UsersController.prototype, "findAll", null);
__decorate([
    (0, common_1.Get)('all-including-inactive'),
    (0, common_1.UseGuards)(admin_auth_guard_1.AdminAuthGuard),
    (0, admin_only_decorator_1.AdminOnly)(),
    __param(0, (0, current_user_id_decorator_1.CurrentUserId)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [String]),
    __metadata("design:returntype", Promise)
], UsersController.prototype, "findAllIncludeInactive", null);
__decorate([
    (0, common_1.Get)(':id'),
    __param(0, (0, common_1.Param)('id')),
    __param(1, (0, current_user_id_decorator_1.CurrentUserId)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [String, String]),
    __metadata("design:returntype", Promise)
], UsersController.prototype, "findOne", null);
__decorate([
    (0, common_1.Put)(':id'),
    __param(0, (0, common_1.Param)('id')),
    __param(1, (0, common_1.Body)()),
    __param(2, (0, current_user_id_decorator_1.CurrentUserId)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [String, Object, String]),
    __metadata("design:returntype", Promise)
], UsersController.prototype, "update", null);
__decorate([
    (0, common_1.Delete)(':id'),
    __param(0, (0, common_1.Param)('id')),
    __param(1, (0, current_user_id_decorator_1.CurrentUserId)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [String, String]),
    __metadata("design:returntype", Promise)
], UsersController.prototype, "remove", null);
__decorate([
    (0, common_1.Post)(':id/deactivate'),
    (0, common_1.UseGuards)(admin_auth_guard_1.AdminAuthGuard),
    (0, admin_only_decorator_1.AdminOnly)(),
    __param(0, (0, common_1.Param)('id')),
    __param(1, (0, common_1.Body)()),
    __param(2, (0, current_user_id_decorator_1.CurrentUserId)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [String, Object, String]),
    __metadata("design:returntype", Promise)
], UsersController.prototype, "deactivateUser", null);
__decorate([
    (0, common_1.Post)(':id/reactivate'),
    (0, common_1.UseGuards)(admin_auth_guard_1.AdminAuthGuard),
    (0, admin_only_decorator_1.AdminOnly)(),
    __param(0, (0, common_1.Param)('id')),
    __param(1, (0, current_user_id_decorator_1.CurrentUserId)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [String, String]),
    __metadata("design:returntype", Promise)
], UsersController.prototype, "reactivateUser", null);
exports.UsersController = UsersController = UsersController_1 = __decorate([
    (0, common_1.Controller)('users'),
    (0, common_1.UseGuards)(clerk_auth_guard_1.ClerkAuthGuard),
    __metadata("design:paramtypes", [users_service_1.UsersService,
        role_utils_1.RoleUtils])
], UsersController);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL3VzZXJzL3VzZXJzLmNvbnRyb2xsZXIudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLDJDQWF3QjtBQUN4QiwyQ0FBOEM7QUFDOUMsa0VBQTZEO0FBQzdELGtFQUE2RDtBQUM3RCw4RUFBZ0U7QUFDaEUsd0ZBQXlFO0FBQ3pFLG1EQUErQztBQUMvQyxxREFBaUQ7QUFJMUMsSUFBTSxlQUFlLHVCQUFyQixNQUFNLGVBQWU7SUFJUDtJQUNBO0lBSkYsTUFBTSxHQUFHLElBQUksZUFBTSxDQUFDLGlCQUFlLENBQUMsSUFBSSxDQUFDLENBQUM7SUFFM0QsWUFDbUIsWUFBMEIsRUFDMUIsU0FBb0I7UUFEcEIsaUJBQVksR0FBWixZQUFZLENBQWM7UUFDMUIsY0FBUyxHQUFULFNBQVMsQ0FBVztJQUNwQyxDQUFDO0lBS0UsQUFBTixLQUFLLENBQUMsT0FBTyxDQUFrQixhQUFxQjtRQUNsRCxJQUFJLENBQUM7WUFDSCxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxTQUFTLGFBQWEsdUJBQXVCLENBQUMsQ0FBQztZQUMvRCxPQUFPLE1BQU0sSUFBSSxDQUFDLFlBQVksQ0FBQyxPQUFPLEVBQUUsQ0FBQztRQUMzQyxDQUFDO1FBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztZQUNmLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLHdCQUF3QixFQUFFLEtBQUssQ0FBQyxDQUFDO1lBQ25ELE1BQU0sSUFBSSxzQkFBYSxDQUNyQiwwQkFBMEIsS0FBSyxZQUFZLEtBQUssQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsZUFBZSxFQUFFLEVBQ3BGLG1CQUFVLENBQUMscUJBQXFCLENBQ2pDLENBQUM7UUFDSixDQUFDO0lBQ0gsQ0FBQztJQUtLLEFBQU4sS0FBSyxDQUFDLHNCQUFzQixDQUNULGFBQXFCO1FBRXRDLElBQUksQ0FBQztZ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LENBQUE7Ozs7OENBK0JqQjtBQUdLO0lBREwsSUFBQSxZQUFHLEVBQUMsS0FBSyxDQUFDO0lBRVIsV0FBQSxJQUFBLGNBQUssRUFBQyxJQUFJLENBQUMsQ0FBQTtJQUNYLFdBQUEsSUFBQSxhQUFJLEdBQUUsQ0FBQTtJQUNOLFdBQUEsSUFBQSx5Q0FBYSxHQUFFLENBQUE7Ozs7NkNBMkNqQjtBQUdLO0lBREwsSUFBQSxlQUFNLEVBQUMsS0FBSyxDQUFDO0lBRVgsV0FBQSxJQUFBLGNBQUssRUFBQyxJQUFJLENBQUMsQ0FBQTtJQUNYLFdBQUEsSUFBQSx5Q0FBYSxHQUFFLENBQUE7Ozs7NkNBMEJqQjtBQUtLO0lBSEwsSUFBQSxhQUFJLEVBQUMsZ0JBQWdCLENBQUM7SUFDdEIsSUFBQSxrQkFBUyxFQUFDLGlDQUFjLENBQUM7SUFDekIsSUFBQSxnQ0FBUyxHQUFFO0lBRVQsV0FBQSxJQUFBLGNBQUssRUFBQyxJQUFJLENBQUMsQ0FBQTtJQUNYLFdBQUEsSUFBQSxhQUFJLEdBQUUsQ0FBQTtJQUNOLFdBQUEsSUFBQSx5Q0FBYSxHQUFFLENBQUE7Ozs7cURBZ0JqQjtBQUtLO0lBSEwsSUFBQSxhQUFJLEVBQUMsZ0JBQWdCLENBQUM7SUFDdEIsSUFBQSxrQkFBUyxFQUFDLGlDQUFjLENBQUM7SUFDekIsSUFBQSxnQ0FBUyxHQUFFO0lBRVQsV0FBQSxJQUFBLGNBQUssRUFBQyxJQUFJLENBQUMsQ0FBQTtJQUNYLFdBQUEsSUFBQSx5Q0FBYSxHQUFFLENBQUE7Ozs7cURBY2pCOzBCQTNNVSxlQUFlO0lBRjNCLElBQUEsbUJBQVUsRUFBQyxPQUFPLENBQUM7SUFDbkIsSUFBQSxrQkFBUyxFQUFDLGlDQUFjLENBQUM7cUNBS1MsNEJBQVk7UUFDZixzQkFBUztHQUw1QixlQUFlLENBNE0zQiIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvaG9tZS93ZXRvb2EvRG9jdW1lbnRzL2NvZGUvcHJvamVjdHMvbWVudGFyYS9tZW50YXJhLWFwaS9zcmMvdXNlcnMvdXNlcnMuY29udHJvbGxlci50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBCb2R5LFxuICBDb250cm9sbGVyLFxuICBEZWxldGUsXG4gIEdldCxcbiAgSHR0cEV4Y2VwdGlvbixcbiAgSHR0cFN0YXR1cyxcbiAgUGFyYW0sXG4gIFB1dCxcbiAgUG9zdCxcbiAgVXNlR3VhcmRzLFxuICBMb2dnZXIsXG4gIEZvcmJpZGRlbkV4Y2VwdGlvbixcbn0gZnJvbSAnQG5lc3Rqcy9jb21tb24nO1xuaW1wb3J0IHsgUHJpc21hLCBVc2VyIH0gZnJvbSAnQHByaXNtYS9jbGllbnQnO1xuaW1wb3J0IHsgQ2xlcmtBdXRoR3VhcmQgfSBmcm9tICdzcmMvZ3VhcmRzL2NsZXJrLWF1dGguZ3VhcmQnO1xuaW1wb3J0IHsgQWRtaW5BdXRoR3VhcmQgfSBmcm9tICdzcmMvZ3VhcmRzL2FkbWluLWF1dGguZ3VhcmQnO1xuaW1wb3J0IHsgQWRtaW5Pbmx5IH0gZnJvbSAnc3JjL2RlY29yYXRvcnMvYWRtaW4tb25seS5kZWNvcmF0b3InO1xuaW1wb3J0IHsgQ3VycmVudFVzZXJJZCB9IGZyb20gJ3NyYy9kZWNvcmF0b3JzL2N1cnJlbnQtdXNlci1pZC5kZWNvcmF0b3InO1xuaW1wb3J0IHsgVXNlcnNTZXJ2aWNlIH0gZnJvbSAnLi91c2Vycy5zZXJ2aWNlJztcbmltcG9ydCB7IFJvbGVVdGlscyB9IGZyb20gJ3NyYy91dGlscy9yb2xlLXV0aWxzJztcblxuQENvbnRyb2xsZXIoJ3VzZXJzJylcbkBVc2VHdWFyZHMoQ2xlcmtBdXRoR3VhcmQpXG5leHBvcnQgY2xhc3MgVXNlcnNDb250cm9sbGVyIHtcbiAgcHJpdmF0ZSByZWFkb25seSBsb2dnZXIgPSBuZXcgTG9nZ2VyKFVzZXJzQ29udHJvbGxlci5uYW1lKTtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHJlYWRvbmx5IHVzZXJzU2VydmljZTogVXNlcnNTZXJ2aWNlLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgcm9sZVV0aWxzOiBSb2xlVXRpbHMsXG4gICkge31cblxuICBAR2V0KClcbiAgQFVzZUd1YXJkcyhBZG1pbkF1dGhHdWFyZClcbiAgQEFkbWluT25seSgpXG4gIGFzeW5jIGZpbmRBbGwoQEN1cnJlbnRVc2VySWQoKSBjdXJyZW50VXNlcklkOiBzdHJpbmcpOiBQcm9taXNlPFVzZXJbXT4ge1xuICAgIHRyeSB7XG4gICAgICB0aGlzLmxvZ2dlci5sb2coYEFkbWluICR7Y3VycmVudFVzZXJJZH0gcmV0cmlldmluZyBhbGwgdXNlcnNgKTtcbiAgICAgIHJldHVybiBhd2FpdCB0aGlzLnVzZXJzU2VydmljZS5maW5kQWxsKCk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRoaXMubG9nZ2VyLmVycm9yKCdGYWlsZWQgdG8gZmV0Y2ggdXNlcnM6JywgZXJyb3IpO1xuICAgICAgdGhyb3cgbmV3IEh0dHBFeGNlcHRpb24oXG4gICAgICAgIGBGYWlsZWQgdG8gZmV0Y2ggdXNlcnM6ICR7ZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiAnVW5rbm93biBlcnJvcid9YCxcbiAgICAgICAgSHR0cFN0YXR1cy5JTlRFUk5BTF9TRVJWRVJfRVJST1IsXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIEBHZXQoJ2FsbC1pbmNsdWRpbmctaW5hY3RpdmUnKVxuICBAVXNlR3VhcmRzKEFkbWluQXV0aEd1YXJkKVxuICBAQWRtaW5Pbmx5KClcbiAgYXN5bmMgZmluZEFsbEluY2x1ZGVJbmFjdGl2ZShcbiAgICBAQ3VycmVudFVzZXJJZCgpIGN1cnJlbnRVc2VySWQ6IHN0cmluZyxcbiAgKTogUHJvbWlzZTxVc2VyW10+IHtcbiAgICB0cnkge1xuICAgICAgdGhpcy5sb2dnZXIubG9nKFxuICAgICAgICBgQWRtaW4gJHtjdXJyZW50VXNlcklkfSByZXRyaWV2aW5nIGFsbCB1c2VycyBpbmNsdWRpbmcgaW5hY3RpdmVgLFxuICAgICAgKTtcbiAgICAgIHJldHVybiBhd2FpdCB0aGlzLnVzZXJzU2VydmljZS5maW5kQWxsSW5jbHVkZUluYWN0aXZlKCk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRoaXMubG9nZ2VyLmVycm9yKCdGYWlsZWQgdG8gZmV0Y2ggYWxsIHVzZXJzOicsIGVycm9yKTtcbiAgICAgIHRocm93IG5ldyBIdHRwRXhjZXB0aW9uKFxuICAgICAgICBgRmFpbGVkIHRvIGZldGNoIHVzZXJzOiAke2Vycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogJ1Vua25vd24gZXJyb3InfWAsXG4gICAgICAgIEh0dHBTdGF0dXMuSU5URVJOQUxfU0VSVkVSX0VSUk9SLFxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICBAR2V0KCc6aWQnKVxuICBhc3luYyBmaW5kT25lKFxuICAgIEBQYXJhbSgnaWQnKSBpZDogc3RyaW5nLFxuICAgIEBDdXJyZW50VXNlcklkKCkgY3VycmVudFVzZXJJZDogc3RyaW5nLFxuICApOiBQcm9taXNlPFVzZXI+IHtcbiAgICB0cnkge1xuICAgICAgLy8gVXNlcnMgY2FuIG9ubHkgdmlldyB0aGVpciBvd24gcHJvZmlsZSB1bmxlc3MgdGhleSdyZSBhZG1pblxuICAgICAgY29uc3QgaXNBZG1pbiA9IGF3YWl0IHRoaXMucm9sZVV0aWxzLmlzVXNlckFkbWluKGN1cnJlbnRVc2VySWQpO1xuXG4gICAgICBpZiAoIWlzQWRtaW4gJiYgaWQgIT09IGN1cnJlbnRVc2VySWQpIHtcbiAgICAgICAgdGhyb3cgbmV3IEZvcmJpZGRlbkV4Y2VwdGlvbignWW91IGNhbiBvbmx5IGFjY2VzcyB5b3VyIG93biBwcm9maWxlJyk7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHVzZXIgPSBpc0FkbWluXG4gICAgICAgID8gYXdhaXQgdGhpcy51c2Vyc1NlcnZpY2UuZmluZE9uZUluY2x1ZGVJbmFjdGl2ZShpZClcbiAgICAgICAgOiBhd2FpdCB0aGlzLnVzZXJzU2VydmljZS5maW5kT25lKGlkKTtcblxuICAgICAgaWYgKCF1c2VyKSB7XG4gICAgICAgIHRocm93IG5ldyBIdHRwRXhjZXB0aW9uKCdVc2VyIG5vdCBmb3VuZCcsIEh0dHBTdGF0dXMuTk9UX0ZPVU5EKTtcbiAgICAgIH1cbiAgICAgIHJldHVybiB1c2VyO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBpZiAoXG4gICAgICAgIGVycm9yIGluc3RhbmNlb2YgRm9yYmlkZGVuRXhjZXB0aW9uIHx8XG4gICAgICAgIGVycm9yIGluc3RhbmNlb2YgSHR0cEV4Y2VwdGlvblxuICAgICAgKSB7XG4gICAgICAgIHRocm93IGVycm9yO1xuICAgICAgfVxuICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoJ0ZhaWxlZCB0byBmZXRjaCB1c2VyOicsIGVycm9yKTtcbiAgICAgIHRocm93IG5ldyBIdHRwRXhjZXB0aW9uKFxuICAgICAgICBgRmFpbGVkIHRvIGZldGNoIHVzZXI6ICR7ZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiAnVW5rbm93biBlcnJvcid9YCxcbiAgICAgICAgSHR0cFN0YXR1cy5JTlRFUk5BTF9TRVJWRVJfRVJST1IsXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIEBQdXQoJzppZCcpXG4gIGFzeW5jIHVwZGF0ZShcbiAgICBAUGFyYW0oJ2lkJykgaWQ6IHN0cmluZyxcbiAgICBAQm9keSgpIHVzZXJEYXRhOiBQcmlzbWEuVXNlclVwZGF0ZUlucHV0LFxuICAgIEBDdXJyZW50VXNlcklkKCkgY3VycmVudFVzZXJJZDogc3RyaW5nLFxuICApOiBQcm9taXNlPFVzZXI+IHtcbiAgICB0cnkge1xuICAgICAgLy8gVXNlcnMgY2FuIG9ubHkgdXBkYXRlIHRoZWlyIG93biBwcm9maWxlIHVubGVzcyB0aGV5J3JlIGFkbWluXG4gICAgICBjb25zdCBpc0FkbWluID0gYXdhaXQgdGhpcy5yb2xlVXRpbHMuaXNVc2VyQWRtaW4oY3VycmVudFVzZXJJZCk7XG5cbiAgICAgIGlmICghaXNBZG1pbiAmJiBpZCAhPT0gY3VycmVudFVzZXJJZCkge1xuICAgICAgICB0aHJvdyBuZXcgRm9yYmlkZGVuRXhjZXB0aW9uKCdZb3UgY2FuIG9ubHkgdXBkYXRlIHlvdXIgb3duIHByb2ZpbGUnKTtcbiAgICAgIH1cblxuICAgICAgLy8gUHJldmVudCBub24tYWRtaW5zIGZyb20gY2hhbmdpbmcgc2Vuc2l0aXZlIGZpZWxkc1xuICAgICAgaWYgKCFpc0FkbWluKSB7XG4gICAgICAgIGNvbnN0IGFsbG93ZWRGaWVsZHMgPSBbXG4gICAgICAgICAgJ2ZpcnN0TmFtZScsXG4gICAgICAgICAgJ2xhc3ROYW1lJyxcbiAgICAgICAgICAnYmlvJyxcbiAgICAgICAgICAnYXZhdGFyVXJsJyxcbiAgICAgICAgICAncGhvbmVOdW1iZXInLFxuICAgICAgICAgICd0aW1lem9uZScsXG4gICAgICAgICAgJ2xhbmd1YWdlJyxcbiAgICAgICAgICAndGhlbWUnLFxuICAgICAgICBdO1xuICAgICAgICBjb25zdCBzYW5pdGl6ZWREYXRhOiBQcmlzbWEuVXNlclVwZGF0ZUlucHV0ID0ge307XG5cbiAgICAgICAgZm9yIChjb25zdCBmaWVsZCBvZiBhbGxvd2VkRmllbGRzKSB7XG4gICAgICAgICAgaWYgKHVzZXJEYXRhW2ZpZWxkXSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICBzYW5pdGl6ZWREYXRhW2ZpZWxkXSA9IHVzZXJEYXRhW2ZpZWxkXTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgdXNlckRhdGEgPSBzYW5pdGl6ZWREYXRhO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy51c2Vyc1NlcnZpY2UudXBkYXRlKGlkLCB1c2VyRGF0YSk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGlmIChlcnJvciBpbnN0YW5jZW9mIEZvcmJpZGRlbkV4Y2VwdGlvbikge1xuICAgICAgICB0aHJvdyBlcnJvcjtcbiAgICAgIH1cbiAgICAgIHRoaXMubG9nZ2VyLmVycm9yKCdGYWlsZWQgdG8gdXBkYXRlIHVzZXI6JywgZXJyb3IpO1xuICAgICAgdGhyb3cgbmV3IEh0dHBFeGNlcHRpb24oXG4gICAgICAgIGBGYWlsZWQgdG8gdXBkYXRlIHVzZXI6ICR7ZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiAnVW5rbm93biBlcnJvcid9YCxcbiAgICAgICAgSHR0cFN0YXR1cy5JTlRFUk5BTF9TRVJWRVJfRVJST1IsXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIEBEZWxldGUoJzppZCcpXG4gIGFzeW5jIHJlbW92ZShcbiAgICBAUGFyYW0oJ2lkJykgaWQ6IHN0cmluZyxcbiAgICBAQ3VycmVudFVzZXJJZCgpIGN1cnJlbnRVc2VySWQ6IHN0cmluZyxcbiAgKTogUHJvbWlzZTx7IG1lc3NhZ2U6IHN0cmluZyB9PiB7XG4gICAgdHJ5IHtcbiAgICAgIC8vIFVzZXJzIGNhbiBvbmx5IGRlYWN0aXZhdGUgdGhlaXIgb3duIGFjY291bnQgdW5sZXNzIHRoZXkncmUgYWRtaW5cbiAgICAgIGNvbnN0IGlzQWRtaW4gPSBhd2FpdCB0aGlzLnJvbGVVdGlscy5pc1VzZXJBZG1pbihjdXJyZW50VXNlcklkKTtcblxuICAgICAgaWYgKCFpc0FkbWluICYmIGlkICE9PSBjdXJyZW50VXNlcklkKSB7XG4gICAgICAgIHRocm93IG5ldyBGb3JiaWRkZW5FeGNlcHRpb24oXG4gICAgICAgICAgJ1lvdSBjYW4gb25seSBkZWFjdGl2YXRlIHlvdXIgb3duIGFjY291bnQnLFxuICAgICAgICApO1xuICAgICAgfVxuXG4gICAgICB0aGlzLmxvZ2dlci5sb2coYFVzZXIvQWRtaW4gJHtjdXJyZW50VXNlcklkfSBkZWFjdGl2YXRpbmcgdXNlciAke2lkfWApO1xuICAgICAgYXdhaXQgdGhpcy51c2Vyc1NlcnZpY2UucmVtb3ZlKGlkKTtcblxuICAgICAgcmV0dXJuIHsgbWVzc2FnZTogJ1VzZXIgYWNjb3VudCBkZWFjdGl2YXRlZCBzdWNjZXNzZnVsbHknIH07XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGlmIChlcnJvciBpbnN0YW5jZW9mIEZvcmJpZGRlbkV4Y2VwdGlvbikge1xuICAgICAgICB0aHJvdyBlcnJvcjtcbiAgICAgIH1cbiAgICAgIHRoaXMubG9nZ2VyLmVycm9yKCdGYWlsZWQgdG8gZGVhY3RpdmF0ZSB1c2VyOicsIGVycm9yKTtcbiAgICAgIHRocm93IG5ldyBIdHRwRXhjZXB0aW9uKFxuICAgICAgICBgRmFpbGVkIHRvIGRlYWN0aXZhdGUgdXNlcjogJHtlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6ICdVbmtub3duIGVycm9yJ31gLFxuICAgICAgICBIdHRwU3RhdHVzLklOVEVSTkFMX1NFUlZFUl9FUlJPUixcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgQFBvc3QoJzppZC9kZWFjdGl2YXRlJylcbiAgQFVzZUd1YXJkcyhBZG1pbkF1dGhHdWFyZClcbiAgQEFkbWluT25seSgpXG4gIGFzeW5jIGRlYWN0aXZhdGVVc2VyKFxuICAgIEBQYXJhbSgnaWQnKSBpZDogc3RyaW5nLFxuICAgIEBCb2R5KCkgYm9keTogeyByZWFzb24/OiBzdHJpbmcgfSxcbiAgICBAQ3VycmVudFVzZXJJZCgpIGN1cnJlbnRVc2VySWQ6IHN0cmluZyxcbiAgKTogUHJvbWlzZTx7IG1lc3NhZ2U6IHN0cmluZyB9PiB7XG4gICAgdHJ5IHtcbiAgICAgIHRoaXMubG9nZ2VyLmxvZyhcbiAgICAgICAgYEFkbWluICR7Y3VycmVudFVzZXJJZH0gZGVhY3RpdmF0aW5nIHVzZXIgJHtpZH0gd2l0aCByZWFzb246ICR7Ym9keS5yZWFzb259YCxcbiAgICAgICk7XG4gICAgICBhd2FpdCB0aGlzLnVzZXJzU2VydmljZS5kZWFjdGl2YXRlKGlkLCBib2R5LnJlYXNvbiwgY3VycmVudFVzZXJJZCk7XG5cbiAgICAgIHJldHVybiB7IG1lc3NhZ2U6ICdVc2VyIGFjY291bnQgZGVhY3RpdmF0ZWQgYnkgYWRtaW5pc3RyYXRvcicgfTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoJ0ZhaWxlZCB0byBkZWFjdGl2YXRlIHVzZXI6JywgZXJyb3IpO1xuICAgICAgdGhyb3cgbmV3IEh0dHBFeGNlcHRpb24oXG4gICAgICAgIGBGYWlsZWQgdG8gZGVhY3RpdmF0ZSB1c2VyOiAke2Vycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogJ1Vua25vd24gZXJyb3InfWAsXG4gICAgICAgIEh0dHBTdGF0dXMuSU5URVJOQUxfU0VSVkVSX0VSUk9SLFxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICBAUG9zdCgnOmlkL3JlYWN0aXZhdGUnKVxuICBAVXNlR3VhcmRzKEFkbWluQXV0aEd1YXJkKVxuICBAQWRtaW5Pbmx5KClcbiAgYXN5bmMgcmVhY3RpdmF0ZVVzZXIoXG4gICAgQFBhcmFtKCdpZCcpIGlkOiBzdHJpbmcsXG4gICAgQEN1cnJlbnRVc2VySWQoKSBjdXJyZW50VXNlcklkOiBzdHJpbmcsXG4gICk6IFByb21pc2U8eyBtZXNzYWdlOiBzdHJpbmcgfT4ge1xuICAgIHRyeSB7XG4gICAgICB0aGlzLmxvZ2dlci5sb2coYEFkbWluICR7Y3VycmVudFVzZXJJZH0gcmVhY3RpdmF0aW5nIHVzZXIgJHtpZH1gKTtcbiAgICAgIGF3YWl0IHRoaXMudXNlcnNTZXJ2aWNlLnJlYWN0aXZhdGUoaWQpO1xuXG4gICAgICByZXR1cm4geyBtZXNzYWdlOiAnVXNlciBhY2NvdW50IHJlYWN0aXZhdGVkIHN1Y2Nlc3NmdWxseScgfTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoJ0ZhaWxlZCB0byByZWFjdGl2YXRlIHVzZXI6JywgZXJyb3IpO1xuICAgICAgdGhyb3cgbmV3IEh0dHBFeGNlcHRpb24oXG4gICAgICAgIGBGYWlsZWQgdG8gcmVhY3RpdmF0ZSB1c2VyOiAke2Vycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogJ1Vua25vd24gZXJyb3InfWAsXG4gICAgICAgIEh0dHBTdGF0dXMuSU5URVJOQUxfU0VSVkVSX0VSUk9SLFxuICAgICAgKTtcbiAgICB9XG4gIH1cbn1cbiJdLCJ2ZXJzaW9uIjozfQ==