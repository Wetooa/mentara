{"file":"/home/wetooa/Documents/code/projects/mentara/mentara-api/src/users/users.controller.ts","mappings":"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","names":[],"sources":["/home/wetooa/Documents/code/projects/mentara/mentara-api/src/users/users.controller.ts"],"sourcesContent":["import {\n  Body,\n  Controller,\n  Delete,\n  Get,\n  HttpException,\n  HttpStatus,\n  Param,\n  Put,\n  Post,\n  UseGuards,\n  Logger,\n  ForbiddenException,\n} from '@nestjs/common';\nimport { Prisma, User } from '@prisma/client';\nimport { ClerkAuthGuard } from 'src/guards/clerk-auth.guard';\nimport { AdminAuthGuard } from 'src/guards/admin-auth.guard';\nimport { AdminOnly } from 'src/decorators/admin-only.decorator';\nimport { CurrentUserId } from 'src/decorators/current-user-id.decorator';\nimport { UsersService } from './users.service';\nimport { RoleUtils } from 'src/utils/role-utils';\n\n@Controller('users')\n@UseGuards(ClerkAuthGuard)\nexport class UsersController {\n  private readonly logger = new Logger(UsersController.name);\n\n  constructor(\n    private readonly usersService: UsersService,\n    private readonly roleUtils: RoleUtils,\n  ) {}\n\n  @Get()\n  @UseGuards(AdminAuthGuard)\n  @AdminOnly()\n  async findAll(@CurrentUserId() currentUserId: string): Promise<User[]> {\n    try {\n      this.logger.log(`Admin ${currentUserId} retrieving all users`);\n      return await this.usersService.findAll();\n    } catch (error) {\n      this.logger.error('Failed to fetch users:', error);\n      throw new HttpException(\n        `Failed to fetch users: ${error instanceof Error ? error.message : 'Unknown error'}`,\n        HttpStatus.INTERNAL_SERVER_ERROR,\n      );\n    }\n  }\n\n  @Get('all-including-inactive')\n  @UseGuards(AdminAuthGuard)\n  @AdminOnly()\n  async findAllIncludeInactive(\n    @CurrentUserId() currentUserId: string,\n  ): Promise<User[]> {\n    try {\n      this.logger.log(\n        `Admin ${currentUserId} retrieving all users including inactive`,\n      );\n      return await this.usersService.findAllIncludeInactive();\n    } catch (error) {\n      this.logger.error('Failed to fetch all users:', error);\n      throw new HttpException(\n        `Failed to fetch users: ${error instanceof Error ? error.message : 'Unknown error'}`,\n        HttpStatus.INTERNAL_SERVER_ERROR,\n      );\n    }\n  }\n\n  @Get(':id')\n  async findOne(\n    @Param('id') id: string,\n    @CurrentUserId() currentUserId: string,\n  ): Promise<User> {\n    try {\n      // Users can only view their own profile unless they're admin\n      const isAdmin = await this.roleUtils.isUserAdmin(currentUserId);\n\n      if (!isAdmin && id !== currentUserId) {\n        throw new ForbiddenException('You can only access your own profile');\n      }\n\n      const user = isAdmin\n        ? await this.usersService.findOneIncludeInactive(id)\n        : await this.usersService.findOne(id);\n\n      if (!user) {\n        throw new HttpException('User not found', HttpStatus.NOT_FOUND);\n      }\n      return user;\n    } catch (error) {\n      if (\n        error instanceof ForbiddenException ||\n        error instanceof HttpException\n      ) {\n        throw error;\n      }\n      this.logger.error('Failed to fetch user:', error);\n      throw new HttpException(\n        `Failed to fetch user: ${error instanceof Error ? error.message : 'Unknown error'}`,\n        HttpStatus.INTERNAL_SERVER_ERROR,\n      );\n    }\n  }\n\n  @Put(':id')\n  async update(\n    @Param('id') id: string,\n    @Body() userData: Prisma.UserUpdateInput,\n    @CurrentUserId() currentUserId: string,\n  ): Promise<User> {\n    try {\n      // Users can only update their own profile unless they're admin\n      const isAdmin = await this.roleUtils.isUserAdmin(currentUserId);\n\n      if (!isAdmin && id !== currentUserId) {\n        throw new ForbiddenException('You can only update your own profile');\n      }\n\n      // Prevent non-admins from changing sensitive fields\n      if (!isAdmin) {\n        const allowedFields = [\n          'firstName',\n          'lastName',\n          'bio',\n          'avatarUrl',\n          'phoneNumber',\n          'timezone',\n          'language',\n          'theme',\n        ];\n        const sanitizedData: Prisma.UserUpdateInput = {};\n\n        for (const field of allowedFields) {\n          if (userData[field] !== undefined) {\n            sanitizedData[field] = userData[field];\n          }\n        }\n        userData = sanitizedData;\n      }\n\n      return await this.usersService.update(id, userData);\n    } catch (error) {\n      if (error instanceof ForbiddenException) {\n        throw error;\n      }\n      this.logger.error('Failed to update user:', error);\n      throw new HttpException(\n        `Failed to update user: ${error instanceof Error ? error.message : 'Unknown error'}`,\n        HttpStatus.INTERNAL_SERVER_ERROR,\n      );\n    }\n  }\n\n  @Delete(':id')\n  async remove(\n    @Param('id') id: string,\n    @CurrentUserId() currentUserId: string,\n  ): Promise<{ message: string }> {\n    try {\n      // Users can only deactivate their own account unless they're admin\n      const isAdmin = await this.roleUtils.isUserAdmin(currentUserId);\n\n      if (!isAdmin && id !== currentUserId) {\n        throw new ForbiddenException(\n          'You can only deactivate your own account',\n        );\n      }\n\n      this.logger.log(`User/Admin ${currentUserId} deactivating user ${id}`);\n      await this.usersService.remove(id);\n\n      return { message: 'User account deactivated successfully' };\n    } catch (error) {\n      if (error instanceof ForbiddenException) {\n        throw error;\n      }\n      this.logger.error('Failed to deactivate user:', error);\n      throw new HttpException(\n        `Failed to deactivate user: ${error instanceof Error ? error.message : 'Unknown error'}`,\n        HttpStatus.INTERNAL_SERVER_ERROR,\n      );\n    }\n  }\n\n  @Post(':id/deactivate')\n  @UseGuards(AdminAuthGuard)\n  @AdminOnly()\n  async deactivateUser(\n    @Param('id') id: string,\n    @Body() body: { reason?: string },\n    @CurrentUserId() currentUserId: string,\n  ): Promise<{ message: string }> {\n    try {\n      this.logger.log(\n        `Admin ${currentUserId} deactivating user ${id} with reason: ${body.reason}`,\n      );\n      await this.usersService.deactivate(id, body.reason, currentUserId);\n\n      return { message: 'User account deactivated by administrator' };\n    } catch (error) {\n      this.logger.error('Failed to deactivate user:', error);\n      throw new HttpException(\n        `Failed to deactivate user: ${error instanceof Error ? error.message : 'Unknown error'}`,\n        HttpStatus.INTERNAL_SERVER_ERROR,\n      );\n    }\n  }\n\n  @Post(':id/reactivate')\n  @UseGuards(AdminAuthGuard)\n  @AdminOnly()\n  async reactivateUser(\n    @Param('id') id: string,\n    @CurrentUserId() currentUserId: string,\n  ): Promise<{ message: string }> {\n    try {\n      this.logger.log(`Admin ${currentUserId} reactivating user ${id}`);\n      await this.usersService.reactivate(id);\n\n      return { message: 'User account reactivated successfully' };\n    } catch (error) {\n      this.logger.error('Failed to reactivate user:', error);\n      throw new HttpException(\n        `Failed to reactivate user: ${error instanceof Error ? error.message : 'Unknown error'}`,\n        HttpStatus.INTERNAL_SERVER_ERROR,\n      );\n    }\n  }\n}\n"],"version":3}