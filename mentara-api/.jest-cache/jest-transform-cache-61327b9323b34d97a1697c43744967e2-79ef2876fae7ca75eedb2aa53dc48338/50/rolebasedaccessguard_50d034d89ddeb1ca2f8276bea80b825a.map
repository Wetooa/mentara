{"version":3,"names":["cov_6kmhqp7yk","actualCoverage","common_1","s","require","core_1","prisma_client_provider_1","ROLE_HIERARCHY","client","therapist","moderator","admin","ROLE_PERMISSIONS","RequirePermissions","permissions","f","Reflect","defineMetadata","exports","RequireRole","role","AllowResourceOwner","resourceIdParam","b","RoleBasedAccessGuard","reflector","prisma","constructor","canActivate","context","request","switchToHttp","getRequest","user","userRole","userId","requiredPermissions","getAllAndOverride","getHandler","getClass","hasPermission","checkPermissions","ForbiddenException","minimumRole","hasRole","checkRole","resourceOwnerParam","resourceId","params","isOwner","checkResourceOwnership","clientId","body","isValidRelationship","validateTherapistClientRelationship","some","permission","allowedRoles","includes","userRoleLevel","minimumRoleLevel","undefined","path","therapistId","relationship","clientTherapist","findFirst","where","error","console","getUserPermissions","Object","entries","filter","_","roles","map","canAccessResource","resourceOwnerId","hasRolePermission","__decorate","Injectable","Reflector","_a","_b","PrismaService"],"sources":["/home/wetooa/Documents/code/projects/mentara/mentara-api/src/auth/guards/role-based-access.guard.ts"],"sourcesContent":["import {\n  Injectable,\n  CanActivate,\n  ExecutionContext,\n  ForbiddenException,\n} from '@nestjs/common';\nimport { Reflector } from '@nestjs/core';\nimport { PrismaService } from 'src/providers/prisma-client.provider';\n\n// Define role hierarchy - higher numbers have more permissions\nconst ROLE_HIERARCHY = {\n  client: 0,\n  therapist: 1,\n  moderator: 2,\n  admin: 3,\n};\n\n// Define role-based permissions for different resources\nconst ROLE_PERMISSIONS = {\n  // User management\n  'users:create': ['admin'],\n  'users:read:all': ['admin', 'moderator'],\n  'users:read:own': ['client', 'therapist', 'moderator', 'admin'],\n  'users:update:own': ['client', 'therapist', 'moderator', 'admin'],\n  'users:update:others': ['admin'],\n  'users:delete': ['admin'],\n  'users:deactivate': ['admin', 'moderator'],\n\n  // Therapist management\n  'therapists:create': ['admin'],\n  'therapists:read:all': ['admin', 'moderator'],\n  'therapists:read:public': ['client', 'therapist', 'moderator', 'admin'],\n  'therapists:update:own': ['therapist', 'admin'],\n  'therapists:update:others': ['admin'],\n  'therapists:approve': ['admin'],\n  'therapists:assign': ['admin', 'moderator'],\n\n  // Client management\n  'clients:create': ['admin'],\n  'clients:read:all': ['admin', 'moderator'],\n  'clients:read:assigned': ['therapist'],\n  'clients:read:own': ['client', 'admin'],\n  'clients:update:own': ['client', 'admin'],\n  'clients:update:assigned': ['therapist', 'admin'],\n\n  // Assessment management\n  'assessments:create:own': ['client'],\n  'assessments:read:own': ['client', 'admin'],\n  'assessments:read:assigned': ['therapist'],\n  'assessments:read:all': ['admin', 'moderator'],\n  'assessments:update:own': ['client'],\n  'assessments:delete:own': ['client', 'admin'],\n  'assessments:delete:all': ['admin'],\n\n  // Session management\n  'sessions:create': ['therapist', 'admin'],\n  'sessions:read:own': ['client', 'therapist'],\n  'sessions:read:all': ['admin', 'moderator'],\n  'sessions:update:own': ['therapist'],\n  'sessions:cancel:own': ['client', 'therapist'],\n  'sessions:cancel:all': ['admin'],\n\n  // Messaging\n  'messages:create': ['client', 'therapist'],\n  'messages:read:own': ['client', 'therapist'],\n  'messages:read:all': ['admin', 'moderator'],\n  'messages:moderate': ['moderator', 'admin'],\n\n  // Community management\n  'communities:create': ['admin'],\n  'communities:read:all': ['client', 'therapist', 'moderator', 'admin'],\n  'communities:update': ['admin', 'moderator'],\n  'communities:moderate': ['moderator', 'admin'],\n  'communities:join': ['client', 'therapist'],\n\n  // Content management\n  'posts:create': ['client', 'therapist'],\n  'posts:read:all': ['client', 'therapist', 'moderator', 'admin'],\n  'posts:update:own': ['client', 'therapist'],\n  'posts:delete:own': ['client', 'therapist'],\n  'posts:moderate': ['moderator', 'admin'],\n\n  // File management\n  'files:upload:own': ['client', 'therapist'],\n  'files:read:own': ['client', 'therapist'],\n  'files:read:assigned': ['therapist'],\n  'files:read:all': ['admin'],\n  'files:delete:own': ['client', 'therapist', 'admin'],\n  'files:delete:all': ['admin'],\n\n  // Admin functions\n  'admin:access': ['admin'],\n  'admin:analytics': ['admin', 'moderator'],\n  'admin:system-config': ['admin'],\n\n  // Billing\n  'billing:create': ['admin'],\n  'billing:read:own': ['client', 'therapist'],\n  'billing:read:all': ['admin'],\n  'billing:update': ['admin'],\n\n  // Notifications\n  'notifications:create': ['admin', 'moderator'],\n  'notifications:read:own': ['client', 'therapist', 'moderator', 'admin'],\n  'notifications:update:own': ['client', 'therapist', 'moderator', 'admin'],\n};\n\n// Decorator to define required permissions\nexport const RequirePermissions = (...permissions: string[]) =>\n  Reflect.defineMetadata('permissions', permissions, Reflect);\n\n// Decorator to define minimum role required\nexport const RequireRole = (role: keyof typeof ROLE_HIERARCHY) =>\n  Reflect.defineMetadata('min_role', role, Reflect);\n\n// Decorator to allow resource owner access\nexport const AllowResourceOwner = (resourceIdParam: string = 'id') =>\n  Reflect.defineMetadata('resource_owner_param', resourceIdParam, Reflect);\n\n@Injectable()\nexport class RoleBasedAccessGuard implements CanActivate {\n  constructor(\n    private reflector: Reflector,\n    private prisma: PrismaService,\n  ) {}\n\n  async canActivate(context: ExecutionContext): Promise<boolean> {\n    const request = context.switchToHttp().getRequest();\n    const user = request.user;\n    const userRole = request.userRole || user?.role;\n    const userId = request.userId || user?.userId;\n\n    if (!userRole || !userId) {\n      // If no role or user ID, deny access (unless it's a public route)\n      return false;\n    }\n\n    // Check for required permissions\n    const requiredPermissions = this.reflector.getAllAndOverride<string[]>(\n      'permissions',\n      [context.getHandler(), context.getClass()],\n    );\n\n    if (requiredPermissions) {\n      const hasPermission = this.checkPermissions(\n        userRole,\n        requiredPermissions,\n      );\n      if (!hasPermission) {\n        throw new ForbiddenException('Insufficient permissions');\n      }\n    }\n\n    // Check for minimum role requirement\n    const minimumRole = this.reflector.getAllAndOverride<\n      keyof typeof ROLE_HIERARCHY\n    >('min_role', [context.getHandler(), context.getClass()]);\n\n    if (minimumRole) {\n      const hasRole = this.checkRole(userRole, minimumRole);\n      if (!hasRole) {\n        throw new ForbiddenException(`Minimum role '${minimumRole}' required`);\n      }\n    }\n\n    // Check for resource owner access\n    const resourceOwnerParam = this.reflector.getAllAndOverride<string>(\n      'resource_owner_param',\n      [context.getHandler(), context.getClass()],\n    );\n\n    if (resourceOwnerParam) {\n      const resourceId = request.params[resourceOwnerParam];\n      const isOwner = this.checkResourceOwnership(\n        userId,\n        resourceId,\n        userRole,\n        request,\n      );\n      if (!isOwner) {\n        throw new ForbiddenException('Access denied - not resource owner');\n      }\n    }\n\n    // Special validation for therapist-client relationships\n    if (userRole === 'therapist') {\n      const clientId = request.params.clientId || request.body?.clientId;\n      if (clientId) {\n        const isValidRelationship = await this.validateTherapistClientRelationship(\n          userId,\n          clientId,\n        );\n        if (!isValidRelationship) {\n          throw new ForbiddenException(\n            'Access denied - no active therapist-client relationship',\n          );\n        }\n      }\n    }\n\n    return true;\n  }\n\n  private checkPermissions(\n    userRole: string,\n    requiredPermissions: string[],\n  ): boolean {\n    return requiredPermissions.some((permission) => {\n      const allowedRoles = ROLE_PERMISSIONS[permission] || [];\n      return allowedRoles.includes(userRole);\n    });\n  }\n\n  private checkRole(\n    userRole: string,\n    minimumRole: keyof typeof ROLE_HIERARCHY,\n  ): boolean {\n    const userRoleLevel =\n      ROLE_HIERARCHY[userRole as keyof typeof ROLE_HIERARCHY];\n    const minimumRoleLevel = ROLE_HIERARCHY[minimumRole];\n\n    return userRoleLevel !== undefined && userRoleLevel >= minimumRoleLevel;\n  }\n\n  private checkResourceOwnership(\n    userId: string,\n    resourceId: string,\n    userRole: string,\n    request: any,\n  ): boolean {\n    // If no resource ID specified, allow access\n    if (!resourceId) return true;\n\n    // Admin can access any resource\n    if (userRole === 'admin') return true;\n\n    // Check if the resource ID matches the user ID\n    if (resourceId === userId) return true;\n\n    // For therapists, deny access here - specific therapist-client validation \n    // is handled in the main canActivate method above\n    if (userRole === 'therapist') {\n      return false;\n    }\n\n    // For moderators, allow access to community resources\n    if (userRole === 'moderator') {\n      const path = request.path;\n      if (\n        path.includes('/communities') ||\n        path.includes('/posts') ||\n        path.includes('/comments')\n      ) {\n        return true;\n      }\n    }\n\n    return false;\n  }\n\n  /**\n   * Validate that a therapist has an active relationship with a client\n   */\n  private async validateTherapistClientRelationship(\n    therapistId: string,\n    clientId: string,\n  ): Promise<boolean> {\n    try {\n      const relationship = await this.prisma.clientTherapist.findFirst({\n        where: {\n          therapistId,\n          clientId,\n        },\n      });\n\n      return !!relationship;\n    } catch (error) {\n      // Log error and deny access on database errors for security\n      console.error('Error validating therapist-client relationship:', error);\n      return false;\n    }\n  }\n\n  // Helper method to get user permissions for debugging\n  static getUserPermissions(userRole: string): string[] {\n    return Object.entries(ROLE_PERMISSIONS)\n      .filter(([_, roles]) => roles.includes(userRole))\n      .map(([permission]) => permission);\n  }\n\n  // Helper method to check if a user can access a specific resource\n  static canAccessResource(\n    userRole: string,\n    permission: string,\n    userId?: string,\n    resourceOwnerId?: string,\n  ): boolean {\n    const allowedRoles = ROLE_PERMISSIONS[permission] || [];\n    const hasRolePermission = allowedRoles.includes(userRole);\n\n    if (hasRolePermission) return true;\n\n    // Check resource ownership\n    if (userId && resourceOwnerId && userId === resourceOwnerId) {\n      return true;\n    }\n\n    return false;\n  }\n}\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;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","ignoreList":[]}