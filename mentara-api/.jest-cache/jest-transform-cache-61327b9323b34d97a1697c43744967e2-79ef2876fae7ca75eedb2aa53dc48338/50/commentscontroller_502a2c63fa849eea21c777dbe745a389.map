{"file":"/home/wetooa/Documents/code/projects/mentara/mentara-api/src/comments/comments.controller.ts","mappings":"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","names":[],"sources":["/home/wetooa/Documents/code/projects/mentara/mentara-api/src/comments/comments.controller.ts"],"sourcesContent":["import {\n  Controller,\n  Get,\n  Post,\n  Body,\n  Param,\n  Put,\n  Delete,\n  HttpException,\n  HttpStatus,\n  UseGuards,\n  UseInterceptors,\n  UploadedFiles,\n} from '@nestjs/common';\nimport { FilesInterceptor } from '@nestjs/platform-express';\nimport { JwtAuthGuard } from 'src/auth/guards/jwt-auth.guard';\nimport {\n  CommunityAccessGuard,\n  RequireRoomAccess,\n} from 'src/auth/guards/community-access.guard';\nimport { CurrentUserId } from 'src/auth/decorators/current-user-id.decorator';\nimport {\n  SupabaseStorageService,\n  FileUploadResult,\n} from 'src/common/services/supabase-storage.service';\nimport { CommentsService } from './comments.service';\nimport { Comment } from '@prisma/client';\nimport type { CommentCreateInputDto, CommentUpdateInputDto } from './types';\n\n@Controller('comments')\n@UseGuards(JwtAuthGuard, CommunityAccessGuard)\nexport class CommentsController {\n  constructor(\n    private readonly commentsService: CommentsService,\n    private readonly supabaseStorageService: SupabaseStorageService,\n  ) {}\n\n  @Get()\n  async findAll(@CurrentUserId() id: string): Promise<Comment[]> {\n    try {\n      return await this.commentsService.findAll(id);\n    } catch (error) {\n      throw new HttpException(\n        `Failed to fetch comments: ${error instanceof Error ? error.message : 'Unknown error'}`,\n        HttpStatus.INTERNAL_SERVER_ERROR,\n      );\n    }\n  }\n\n  @Get(':id')\n  @RequireRoomAccess()\n  async findOne(@Param('id') id: string): Promise<Comment> {\n    try {\n      const comment = await this.commentsService.findOne(id);\n      if (!comment) {\n        throw new HttpException('Comment not found', HttpStatus.NOT_FOUND);\n      }\n      return comment;\n    } catch (error) {\n      throw new HttpException(\n        `Failed to fetch comment: ${error instanceof Error ? error.message : 'Unknown error'}`,\n        HttpStatus.INTERNAL_SERVER_ERROR,\n      );\n    }\n  }\n\n  @Get('post/:postId')\n  @RequireRoomAccess()\n  async findByPostId(\n    @Param('postId') postId: string,\n    @CurrentUserId() userId: string,\n  ): Promise<Comment[]> {\n    try {\n      return await this.commentsService.findByPostId(postId, userId);\n    } catch (error) {\n      throw new HttpException(\n        `Failed to fetch comments for post: ${error instanceof Error ? error.message : 'Unknown error'}`,\n        HttpStatus.INTERNAL_SERVER_ERROR,\n      );\n    }\n  }\n\n  @Post()\n  @RequireRoomAccess()\n  @UseInterceptors(FilesInterceptor('files', 5)) // Support up to 5 files\n  async create(\n    @CurrentUserId() userId: string,\n    @Body() commentData: CommentCreateInputDto,\n    @UploadedFiles() files: Express.Multer.File[] = [], // Optional files\n  ): Promise<Comment> {\n    try {\n      // Validate and upload files if provided\n      const fileResults: FileUploadResult[] = [];\n      if (files && files.length > 0) {\n        for (const file of files) {\n          const validation = this.supabaseStorageService.validateFile(file);\n          if (!validation.isValid) {\n            throw new HttpException(\n              `File validation failed: ${validation.error}`,\n              HttpStatus.BAD_REQUEST,\n            );\n          }\n        }\n\n        // Upload files to Supabase\n        const uploadResults = await this.supabaseStorageService.uploadFiles(\n          files,\n          SupabaseStorageService.getSupportedBuckets().POST_ATTACHMENTS,\n        );\n        fileResults.push(...uploadResults);\n      }\n\n      return await this.commentsService.create(\n        commentData,\n        userId,\n        fileResults.map((f) => f.url),\n        fileResults.map((f) => f.filename),\n        files.map((f) => f.size),\n      );\n    } catch (error) {\n      throw new HttpException(\n        `Failed to create comment: ${error instanceof Error ? error.message : 'Unknown error'}`,\n        HttpStatus.INTERNAL_SERVER_ERROR,\n      );\n    }\n  }\n\n  @Put(':id')\n  @RequireRoomAccess()\n  async update(\n    @CurrentUserId() userId: string,\n    @Param('id') id: string,\n    @Body() commentData: CommentUpdateInputDto,\n  ): Promise<Comment> {\n    try {\n      return await this.commentsService.update(id, commentData, userId);\n    } catch (error) {\n      throw new HttpException(\n        `Failed to update comment: ${error instanceof Error ? error.message : 'Unknown error'}`,\n        HttpStatus.INTERNAL_SERVER_ERROR,\n      );\n    }\n  }\n\n  @Delete(':id')\n  @RequireRoomAccess()\n  async remove(\n    @CurrentUserId() userId: string,\n    @Param('id') id: string,\n  ): Promise<Comment> {\n    try {\n      return await this.commentsService.remove(id, userId);\n    } catch (error) {\n      throw new HttpException(\n        `Failed to delete comment: ${error instanceof Error ? error.message : 'Unknown error'}`,\n        HttpStatus.INTERNAL_SERVER_ERROR,\n      );\n    }\n  }\n\n  // Heart functionality\n  @Post(':id/heart')\n  @RequireRoomAccess()\n  async heartComment(\n    @CurrentUserId() userId: string,\n    @Param('id') commentId: string,\n  ): Promise<{ hearted: boolean }> {\n    try {\n      return await this.commentsService.heartComment(commentId, userId);\n    } catch (error) {\n      throw new HttpException(\n        `Failed to heart comment: ${error instanceof Error ? error.message : 'Unknown error'}`,\n        HttpStatus.INTERNAL_SERVER_ERROR,\n      );\n    }\n  }\n\n  @Get(':id/hearted')\n  async isCommentHearted(\n    @CurrentUserId() userId: string,\n    @Param('id') commentId: string,\n  ): Promise<{ hearted: boolean }> {\n    try {\n      const hearted = await this.commentsService.isCommentHeartedByUser(\n        commentId,\n        userId,\n      );\n      return { hearted };\n    } catch (error) {\n      throw new HttpException(\n        `Failed to check comment heart status: ${error instanceof Error ? error.message : 'Unknown error'}`,\n        HttpStatus.INTERNAL_SERVER_ERROR,\n      );\n    }\n  }\n\n  @Post(':id/report')\n  @RequireRoomAccess()\n  async reportComment(\n    @CurrentUserId() userId: string,\n    @Param('id') commentId: string,\n    @Body() reportData: { reason: string; content?: string },\n  ): Promise<{ success: boolean; reportId: string }> {\n    try {\n      const reportId = await this.commentsService.reportComment(\n        commentId,\n        userId,\n        reportData.reason,\n        reportData.content,\n      );\n      return { success: true, reportId };\n    } catch (error) {\n      throw new HttpException(\n        `Failed to report comment: ${error instanceof Error ? error.message : 'Unknown error'}`,\n        HttpStatus.INTERNAL_SERVER_ERROR,\n      );\n    }\n  }\n}\n"],"version":3}