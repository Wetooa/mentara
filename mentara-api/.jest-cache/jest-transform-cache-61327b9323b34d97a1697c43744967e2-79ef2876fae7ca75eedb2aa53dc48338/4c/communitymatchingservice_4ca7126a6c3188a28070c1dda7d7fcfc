7f28d4f5658afb83601b7f2483ae83cf
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var CommunityMatchingService_1;
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
exports.CommunityMatchingService = void 0;
const common_1 = require("@nestjs/common");
const prisma_client_provider_1 = require("../../providers/prisma-client.provider");
let CommunityMatchingService = CommunityMatchingService_1 = class CommunityMatchingService {
    prisma;
    logger = new common_1.Logger(CommunityMatchingService_1.name);
    constructor(prisma) {
        this.prisma = prisma;
    }
    /**
     * Core assessment-to-community mapping configuration
     * This defines which communities are appropriate for different assessment score ranges
     */
    getAssessmentCommunityMappings() {
        return {
            // PHQ-9 Depression Scale (0-27)
            phq9: {
                score: 0,
                communities: [
                    'general-support',
                    'depression-support',
                    'anxiety-depression',
                    'mental-wellness',
                    'recovery-journey',
                    'therapy-discussion',
                ],
                weight: 0.8, // High weight for depression matching
            },
            // GAD-7 Anxiety Scale (0-21)
            gad7: {
                score: 0,
                communities: [
                    'anxiety-support',
                    'panic-disorder',
                    'social-anxiety',
                    'anxiety-depression',
                    'mindfulness-meditation',
                    'coping-strategies',
                ],
                weight: 0.7,
            },
            // PTSD-5 Scale (0-20)
            ptsd5: {
                score: 0,
                communities: [
                    'ptsd-support',
                    'trauma-recovery',
                    'veterans-support',
                    'complex-trauma',
                    'healing-journey',
                    'therapy-discussion',
                ],
                weight: 0.9, // Very high weight for PTSD matching
            },
            // Additional assessments can be added here
            // bipolar: { score: 0, communities: ['bipolar-support', 'mood-disorders'], weight: 0.8 },
            // ocd: { score: 0, communities: ['ocd-support', 'anxiety-disorders'], weight: 0.7 },
        };
    }
    /**
     * Calculate compatibility score between user and community based on assessment scores
     */
    async calculateCompatibilityScore(userAssessmentProfile, communitySlug) {
        const mappings = this.getAssessmentCommunityMappings();
        let totalScore = 0;
        let totalWeight = 0;
        const matchingFactors = [];
        const assessmentContributions = {};
        // Get community information
        const community = await this.prisma.community.findUnique({
            where: { slug: communitySlug },
            select: { id: true, name: true, slug: true },
        });
        if (!community) {
            throw new Error(`Community not found: ${communitySlug}`);
        }
        // Calculate contribution from each assessment
        for (const [assessmentType, assessmentData] of Object.entries(userAssessmentProfile.assessments)) {
            const mapping = mappings[assessmentType];
            if (!mapping)
                continue;
            const userScore = assessmentData.score;
            const isRelevantCommunity = mapping.communities.includes(communitySlug);
            if (isRelevantCommunity) {
                // Calculate compatibility based on severity and community focus
                const severityMultiplier = this.getSeverityMultiplier(assessmentType, userScore);
                const communitySpecificityBonus = this.getCommunitySpecificityBonus(communitySlug, assessmentType);
                const contribution = severityMultiplier * communitySpecificityBonus * mapping.weight;
                totalScore += contribution;
                totalWeight += mapping.weight;
                matchingFactors.push(`${assessmentType.toUpperCase()} (${assessmentData.severity})`);
                assessmentContributions[assessmentType] = {
                    score: userScore,
                    weight: mapping.weight,
                    contribution: contribution,
                };
            }
        }
        // Normalize score to 0-1 range
        const compatibilityScore = totalWeight > 0 ? Math.min(totalScore / totalWeight, 1.0) : 0;
        // Generate reasoning text
        const reasoning = this.generateReasoningText(community.name, matchingFactors, compatibilityScore, assessmentContributions);
        return {
            communityId: community.id,
            communitySlug: community.slug,
            compatibilityScore,
            reasoning,
            matchingFactors,
            assessmentContributions,
        };
    }
    /**
     * Get severity multiplier based on assessment type and score
     */
    getSeverityMultiplier(assessmentType, score) {
        switch (assessmentType) {
            case 'phq9':
                // PHQ-9: 0-4 minimal, 5-9 mild, 10-14 moderate, 15-19 moderately severe, 20-27 severe
                if (score <= 4)
                    return 0.3; // Minimal depression - low community need
                if (score <= 9)
                    return 0.6; // Mild depression - moderate community benefit
                if (score <= 14)
                    return 0.9; // Moderate depression - high community benefit
                if (score <= 19)
                    return 1.0; // Moderately severe - maximum community benefit
                return 1.0; // Severe depression - maximum community benefit
            case 'gad7':
                // GAD-7: 0-4 minimal, 5-9 mild, 10-14 moderate, 15-21 severe
                if (score <= 4)
                    return 0.3;
                if (score <= 9)
                    return 0.6;
                if (score <= 14)
                    return 0.9;
                return 1.0;
            case 'ptsd5':
                // PTSD-5: 0-2 minimal, 3-7 mild, 8-14 moderate, 15-20 severe
                if (score <= 2)
                    return 0.3;
                if (score <= 7)
                    return 0.6;
                if (score <= 14)
                    return 0.9;
                return 1.0;
            default:
                return 0.5; // Default multiplier for unknown assessment types
        }
    }
    /**
     * Get bonus for community-specific focus
     */
    getCommunitySpecificityBonus(communitySlug, assessmentType) {
        // Bonus for highly specific communities
        const specificCommunities = {
            'depression-support': ['phq9'],
            'anxiety-support': ['gad7'],
            'ptsd-support': ['ptsd5'],
            'trauma-recovery': ['ptsd5'],
            'panic-disorder': ['gad7'],
            'social-anxiety': ['gad7'],
        };
        const communityAssessments = specificCommunities[communitySlug];
        if (communityAssessments && communityAssessments.includes(assessmentType)) {
            return 1.2; // 20% bonus for highly specific matches
        }
        // General communities get no bonus
        const generalCommunities = [
            'general-support',
            'mental-wellness',
            'therapy-discussion',
        ];
        if (generalCommunities.includes(communitySlug)) {
            return 0.8; // Slight reduction for general communities
        }
        return 1.0; // No bonus/penalty for other communities
    }
    /**
     * Generate human-readable reasoning text
     */
    generateReasoningText(communityName, matchingFactors, compatibilityScore, assessmentContributions) {
        const scorePercentage = Math.round(compatibilityScore * 100);
        let reasoning = `Based on your assessment results, you have a ${scorePercentage}% compatibility with ${communityName}. `;
        if (matchingFactors.length > 0) {
            reasoning += `This recommendation is based on your ${matchingFactors.join(', ')} scores. `;
        }
        if (compatibilityScore >= 0.8) {
            reasoning +=
                'This community appears to be an excellent match for your current needs and may provide valuable support and resources.';
        }
        else if (compatibilityScore >= 0.6) {
            reasoning +=
                'This community could be a good fit and may offer helpful support for your situation.';
        }
        else if (compatibilityScore >= 0.4) {
            reasoning +=
                'This community may provide some relevant support, though it might not be the most targeted for your specific needs.';
        }
        else {
            reasoning +=
                'While this community offers general support, there may be other communities that are more specifically aligned with your assessment results.';
        }
        return reasoning;
    }
    /**
     * Get comprehensive community recommendations for a user
     */
    async getRecommendationsForUser(userId) {
        try {
            // Get user's latest assessment scores
            const userAssessmentProfile = await this.getUserAssessmentProfile(userId);
            if (!userAssessmentProfile ||
                Object.keys(userAssessmentProfile.assessments).length === 0) {
                this.logger.warn(`No assessment data found for user ${userId}`);
                return [];
            }
            // Get all available communities
            const communities = await this.prisma.community.findMany({
                select: { slug: true, name: true },
            });
            // Calculate compatibility for each community
            const recommendations = [];
            for (const community of communities) {
                try {
                    const compatibility = await this.calculateCompatibilityScore(userAssessmentProfile, community.slug);
                    // Only include communities with meaningful compatibility (>20%)
                    if (compatibility.compatibilityScore > 0.2) {
                        recommendations.push(compatibility);
                    }
                }
                catch (error) {
                    this.logger.error(`Error calculating compatibility for ${community.slug}:`, error);
                }
            }
            // Sort by compatibility score (highest first)
            recommendations.sort((a, b) => b.compatibilityScore - a.compatibilityScore);
            // Return top 10 recommendations
            return recommendations.slice(0, 10);
        }
        catch (error) {
            this.logger.error(`Error getting recommendations for user ${userId}:`, error);
            throw error;
        }
    }
    /**
     * Get user's assessment profile from database
     */
    async getUserAssessmentProfile(userId) {
        try {
            // Get user's pre-assessment data
            const preAssessment = await this.prisma.preAssessment.findUnique({
                where: { clientId: userId },
                select: {
                    answers: true,
                    createdAt: true,
                },
            });
            if (!preAssessment) {
                return null;
            }
            // Extract data from answers JSON
            const assessmentData = preAssessment.answers;
            if (!assessmentData || typeof assessmentData !== 'object') {
                this.logger.warn(`Invalid assessment data for user ${userId}`);
                return null;
            }
            const scores = assessmentData.scores;
            const severityLevels = assessmentData.severityLevels;
            if (!scores) {
                this.logger.warn(`No scores found in assessment data for user ${userId}`);
                return null;
            }
            const assessments = {};
            // Map PHQ-9 score from JSON data
            if (scores?.phq9Score !== null && scores?.phq9Score !== undefined) {
                assessments.phq9 = {
                    score: scores.phq9Score,
                    severity: this.getDepressionSeverity(scores.phq9Score),
                    date: preAssessment.createdAt,
                };
            }
            // Map GAD-7 score from JSON data
            if (scores?.gad7Score !== null && scores?.gad7Score !== undefined) {
                assessments.gad7 = {
                    score: scores.gad7Score,
                    severity: this.getAnxietySeverity(scores.gad7Score),
                    date: preAssessment.createdAt,
                };
            }
            // Map PTSD-5 score from JSON data
            if (scores?.ptsd5Score !== null && scores?.ptsd5Score !== undefined) {
                assessments.ptsd5 = {
                    score: scores.ptsd5Score,
                    severity: this.getPTSDSeverity(scores.ptsd5Score),
                    date: preAssessment.createdAt,
                };
            }
            return {
                userId,
                assessments,
            };
        }
        catch (error) {
            this.logger.error(`Error getting assessment profile for user ${userId}:`, error);
            return null;
        }
    }
    /**
     * Get depression severity label from PHQ-9 score
     */
    getDepressionSeverity(score) {
        if (score <= 4)
            return 'minimal';
        if (score <= 9)
            return 'mild';
        if (score <= 14)
            return 'moderate';
        if (score <= 19)
            return 'moderately severe';
        return 'severe';
    }
    /**
     * Get anxiety severity label from GAD-7 score
     */
    getAnxietySeverity(score) {
        if (score <= 4)
            return 'minimal';
        if (score <= 9)
            return 'mild';
        if (score <= 14)
            return 'moderate';
        return 'severe';
    }
    /**
     * Get PTSD severity label from PTSD-5 score
     */
    getPTSDSeverity(score) {
        if (score <= 2)
            return 'minimal';
        if (score <= 7)
            return 'mild';
        if (score <= 14)
            return 'moderate';
        return 'severe';
    }
    /**
     * Detect when user's assessments have changed and trigger recommendation refresh
     */
    async handleAssessmentChange(userId, assessmentType) {
        try {
            this.logger.log(`Assessment change detected for user ${userId}: ${assessmentType}`);
            // Get new recommendations
            const newRecommendations = await this.getRecommendationsForUser(userId);
            // Store recommendations in database (will be handled by CommunityRecommendationService)
            // For now, just log the change
            this.logger.log(`Generated ${newRecommendations.length} new recommendations for user ${userId}`);
            // TODO: Trigger notification to user about new community matches
            // TODO: Update existing recommendations if they exist
        }
        catch (error) {
            this.logger.error(`Error handling assessment change for user ${userId}:`, error);
        }
    }
};
exports.CommunityMatchingService = CommunityMatchingService;
exports.CommunityMatchingService = CommunityMatchingService = CommunityMatchingService_1 = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [typeof (_a = typeof prisma_client_provider_1.PrismaService !== "undefined" && prisma_client_provider_1.PrismaService) === "function" ? _a : Object])
], CommunityMatchingService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL2NvbW11bml0aWVzL3NlcnZpY2VzL2NvbW11bml0eS1tYXRjaGluZy5zZXJ2aWNlLnRzIiwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7O0FBQUEsMkNBQW9EO0FBQ3BELG1GQUF1RTtBQXlEaEUsSUFBTSx3QkFBd0IsZ0NBQTlCLE1BQU0sd0JBQXdCO0lBR047SUFGWixNQUFNLEdBQUcsSUFBSSxlQUFNLENBQUMsMEJBQXdCLENBQUMsSUFBSSxDQUFDLENBQUM7SUFFcEUsWUFBNkIsTUFBcUI7UUFBckIsV0FBTSxHQUFOLE1BQU0sQ0FBZTtJQUFHLENBQUM7SUFFdEQ7OztPQUdHO0lBQ0ssOEJBQThCO1FBQ3BDLE9BQU87WUFDTCxnQ0FBZ0M7WUFDaEMsSUFBSSxFQUFFO2dCQUNKLEtBQUssRUFBRSxDQUFDO2dCQUNSLFdBQVcsRUFBRTtvQkFDWCxpQkFBaUI7b0JBQ2pCLG9CQUFvQjtvQkFDcEIsb0JBQW9CO29CQUNwQixpQkFBaUI7b0JBQ2pCLGtCQUFrQjtvQkFDbEIsb0JBQW9CO2lCQUNyQjtnQkFDRCxNQUFNLEVBQUUsR0FBRyxFQUFFLHNDQUFzQzthQUNwRDtZQUVELDZCQUE2QjtZQUM3QixJQUFJLEVBQUU7Z0JBQ0osS0FBSyxFQUFFLENBQUM7Z0JBQ1IsV0FBVyxFQUFFO29CQUNYLGlCQUFpQjtvQkFDakIsZ0JBQWdCO29CQUNoQixnQkFBZ0I7b0JBQ2hCLG9CQUFvQjtvQkFDcEIsd0JBQXdCO29CQUN4QixtQkFBbUI7aUJBQ3BCO2dCQUNELE1BQU0sRUFBRSxHQUFHO2FBQ1o7WUFFRCxzQkFBc0I7WUFDdEIsS0FBSyxFQUFFO2dCQUNMLEtBQUssRUFBRSxDQUFDO2dCQUNSLFdBQVcsRUFBRTtvQkFDWCxjQUFjO29CQUNkLGlCQUFpQjtvQkFDakIsa0JBQWtCO29CQUNsQixnQkFBZ0I7b0JBQ2hCLGlCQUFpQjtvQkFDakIsb0JBQW9CO2lCQUNyQjtnQkFDRCxNQUFNLEVBQUUsR0FBRyxFQUFFLHFDQUFxQzthQUNuRDtZQUVELDJDQUEyQztZQUMzQywwRkFBMEY7WUFDMUYscUZBQXFGO1NBQ3RGLENBQUM7SUFDSixDQUFDO0lBRUQ7O09BRUc7SUFDSCxLQUFLLENBQUMsMkJBQTJCLENBQy9CLHFCQUE0QyxFQUM1QyxhQUFxQjtRQUVyQixNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsOEJBQThCLEVBQUUsQ0FBQztRQUN2RCxJQUFJLFVBQVUsR0FBRyxDQUFDLENBQUM7UUFDbkIsSUFBSSxXQUFXLEdBQUcsQ0FBQyxDQUFDO1FBQ3BCLE1BQU0sZUFBZSxHQUFhLEVBQUUsQ0FBQztRQUNyQyxNQUFNLHVCQUF1QixHQUEyQixFQUFFLENBQUM7UUFFM0QsNEJBQTRCO1FBQzVCLE1BQU0sU0FBUyxHQUFHLE1BQU0sSUFBSSxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUMsVUFBVSxDQUFDO1lBQ3ZELEtBQUssRUFBRSxFQUFFLElBQUksRUFBRSxhQUFhLEVBQUU7WUFDOUIsTUFBTSxFQUFFLEVBQUUsRUFBRSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUU7U0FDN0MsQ0FBQyxDQUFDO1FBRUgsSUFBSSxDQUFDLFNBQVMsRUFBRSxDQUFDO1lBQ2YsTUFBTSxJQUFJLEtBQUssQ0FBQyx3QkFBd0IsYUFBYSxFQUFFLENBQUMsQ0FBQztRQUMzRCxDQUFDO1FBRUQsOENBQThDO1FBQzlDLEtBQUssTUFBTSxDQUFDLGNBQWMsRUFBRSxjQUFjLENBQUMsSUFBSSxNQUFNLENBQUMsT0FBTyxDQUMzRCxxQkFBcUIsQ0FBQyxXQUFXLENBQ2xDLEVBQUUsQ0FBQztZQUNGLE1BQU0sT0FBTyxHQUFHLFFBQVEsQ0FBQyxjQUFjLENBQUMsQ0FBQztZQUN6QyxJQUFJLENBQUMsT0FBTztnQkFBRSxTQUFTO1lBRXZCLE1BQU0sU0FBUyxHQUFHLGNBQWMsQ0FBQyxLQUFLLENBQUM7WUFDdkMsTUFBTSxtQkFBbUIsR0FBRyxPQUFPLENBQUMsV0FBVyxDQUFDLFFBQVEsQ0FBQyxhQUFhLENBQUMsQ0FBQztZQUV4RSxJQUFJLG1CQUFtQixFQUFFLENBQUM7Z0JBQ3hCLGdFQUFnRTtnQkFDaEUsTUFBTSxrQkFBa0IsR0FBRyxJQUFJLENBQUMscUJBQXFCLENBQ25ELGNBQWMsRUFDZCxTQUFTLENBQ1YsQ0FBQztnQkFDRixNQUFNLHlCQUF5QixHQUFHLElBQUksQ0FBQyw0QkFBNEIsQ0FDakUsYUFBYSxFQUNiLGNBQWMsQ0FDZixDQUFDO2dCQUVGLE1BQU0sWUFBWSxHQUNoQixrQkFBa0IsR0FBRyx5QkFBeUIsR0FBRyxPQUFPLENBQUMsTUFBTSxDQUFDO2dCQUVsRSxVQUFVLElBQUksWUFBWSxDQUFDO2dCQUMzQixXQUFXLElBQUksT0FBTyxDQUFDLE1BQU0sQ0FBQztnQkFFOUIsZUFBZSxDQUFDLElBQUksQ0FDbEIsR0FBRyxjQUFjLENBQUMsV0FBVyxFQUFFLEtBQUssY0FBYyxDQUFDLFFBQVEsR0FBRyxDQUMvRCxDQUFDO2dCQUVGLHVCQUF1QixDQUFDLGNBQWMsQ0FBQyxHQUFHO29CQUN4QyxLQUFLLEVBQUUsU0FBUztvQkFDaEIsTUFBTSxFQUFFLE9BQU8sQ0FBQyxNQUFNO29CQUN0QixZQUFZLEVBQUUsWUFBWTtpQkFDM0IsQ0FBQztZQUNKLENBQUM7UUFDSCxDQUFDO1FBRUQsK0JBQStCO1FBQy9CLE1BQU0sa0JBQWtCLEdBQ3RCLFdBQVcsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsVUFBVSxHQUFHLFdBQVcsRUFBRSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBRWhFLDBCQUEwQjtRQUMxQixNQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMscUJBQXFCLENBQzFDLFNBQVMsQ0FBQyxJQUFJLEVBQ2QsZUFBZSxFQUNmLGtCQUFrQixFQUNsQix1QkFBdUIsQ0FDeEIsQ0FBQztRQUVGLE9BQU87WUFDTCxXQUFXLEVBQUUsU0FBUyxDQUFDLEVBQUU7WUFDekIsYUFBYSxFQUFFLFNBQVMsQ0FBQyxJQUFJO1lBQzdCLGtCQUFrQjtZQUNsQixTQUFTO1lBQ1QsZUFBZTtZQUNmLHVCQUF1QjtTQUN4QixDQUFDO0lBQ0osQ0FBQztJQUVEOztPQUVHO0lBQ0sscUJBQXFCLENBQUMsY0FBc0IsRUFBRSxLQUFhO1FBQ2pFLFFBQVEsY0FBYyxFQUFFLENBQUM7WUFDdkIsS0FBSyxNQUFNO2dCQUNULHNGQUFzRjtnQkFDdEYsSUFBSSxLQUFLLElBQUksQ0FBQztvQkFBRSxPQUFPLEdBQUcsQ0FBQyxDQUFDLDBDQUEwQztnQkFDdEUsSUFBSSxLQUFLLElBQUksQ0FBQztvQkFBRSxPQUFPLEdBQUcsQ0FBQyxDQUFDLCtDQUErQztnQkFDM0UsSUFBSSxLQUFLLElBQUksRUFBRTtvQkFBRSxPQUFPLEdBQUcsQ0FBQyxDQUFDLCtDQUErQztnQkFDNUUsSUFBSSxLQUFLLElBQUksRUFBRTtvQkFBRSxPQUFPLEdBQUcsQ0FBQyxDQUFDLGdEQUFnRDtnQkFDN0UsT0FBTyxHQUFHLENBQUMsQ0FBQyxnREFBZ0Q7WUFFOUQsS0FBSyxNQUFNO2dCQUNULDZEQUE2RDtnQkFDN0QsSUFBSSxLQUFLLElBQUksQ0FBQztvQkFBRSxPQUFPLEdBQUcsQ0FBQztnQkFDM0IsSUFBSSxLQUFLLElBQUksQ0FBQztvQkFBRSxPQUFPLEdBQUcsQ0FBQztnQkFDM0IsSUFBSSxLQUFLLElBQUksRUFBRTtvQkFBRSxPQUFPLEdBQUcsQ0FBQztnQkFDNUIsT0FBTyxHQUFHLENBQUM7WUFFYixLQUFLLE9BQU87Z0JBQ1YsNkRBQTZEO2dCQUM3RCxJQUFJLEtBQUssSUFBSSxDQUFDO29CQUFFLE9BQU8sR0FBRyxDQUFDO2dCQUMzQixJQUFJLEtBQUssSUFBSSxDQUFDO29CQUFFLE9BQU8sR0FBRyxDQUFDO2dCQUMzQixJQUFJLEtBQUssSUFBSSxFQUFFO29CQUFFLE9BQU8sR0FBRyxDQUFDO2dCQUM1QixPQUFPLEdBQUcsQ0FBQztZQUViO2dCQUNFLE9BQU8sR0FBRyxDQUFDLENBQUMsa0RBQWtEO1FBQ2xFLENBQUM7SUFDSCxDQUFDO0lBRUQ7O09BRUc7SUFDSyw0QkFBNEIsQ0FDbEMsYUFBcUIsRUFDckIsY0FBc0I7UUFFdEIsd0NBQXdDO1FBQ3hDLE1BQU0sbUJBQW1CLEdBQUc7WUFDMUIsb0JBQW9CLEVBQUUsQ0FBQyxNQUFNLENBQUM7WUFDOUIsaUJBQWlCLEVBQUUsQ0FBQyxNQUFNLENBQUM7WUFDM0IsY0FBYyxFQUFFLENBQUMsT0FBTyxDQUFDO1lBQ3pCLGlCQUFpQixFQUFFLENBQUMsT0FBTyxDQUFDO1lBQzVCLGdCQUFnQixFQUFFLENBQUMsTUFBTSxDQUFDO1lBQzFCLGdCQUFnQixFQUFFLENBQUMsTUFBTSxDQUFDO1NBQzNCLENBQUM7UUFFRixNQUFNLG9CQUFvQixHQUFHLG1CQUFtQixDQUFDLGFBQWEsQ0FBQyxDQUFDO1FBQ2hFLElBQUksb0JBQW9CLElBQUksb0JBQW9CLENBQUMsUUFBUSxDQUFDLGNBQWMsQ0FBQyxFQUFFLENBQUM7WUFDMUUsT0FBTyxHQUFHLENBQUMsQ0FBQyx3Q0FBd0M7UUFDdEQsQ0FBQztRQUVELG1DQUFtQztRQUNuQyxNQUFNLGtCQUFrQixHQUFHO1lBQ3pCLGlCQUFpQjtZQUNqQixpQkFBaUI7WUFDakIsb0JBQW9CO1NBQ3JCLENBQUM7UUFDRixJQUFJLGtCQUFrQixDQUFDLFFBQVEsQ0FBQyxhQUFhLENBQUMsRUFBRSxDQUFDO1lBQy9DLE9BQU8sR0FBRyxDQUFDLENBQUMsMkNBQTJDO1FBQ3pELENBQUM7UUFFRCxPQUFPLEdBQUcsQ0FBQyxDQUFDLHlDQUF5QztJQUN2RCxDQUFDO0lBRUQ7O09BRUc7SUFDSyxxQkFBcUIsQ0FDM0IsYUFBcUIsRUFDckIsZUFBeUIsRUFDekIsa0JBQTBCLEVBQzFCLHVCQUErQztRQUUvQyxNQUFNLGVBQWUsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLGtCQUFrQixHQUFHLEdBQUcsQ0FBQyxDQUFDO1FBRTdELElBQUksU0FBUyxHQUFHLGdEQUFnRCxlQUFlLHdCQUF3QixhQUFhLElBQUksQ0FBQztRQUV6SCxJQUFJLGVBQWUsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFLENBQUM7WUFDL0IsU0FBUyxJQUFJLHdDQUF3QyxlQUFlLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUM7UUFDN0YsQ0FBQztRQUVELElBQUksa0JBQWtCLElBQUksR0FBRyxFQUFFLENBQUM7WUFDOUIsU0FBUztnQkFDUCx3SEFBd0gsQ0FBQztRQUM3SCxDQUFDO2FBQU0sSUFBSSxrQkFBa0IsSUFBSSxHQUFHLEVBQUUsQ0FBQztZQUNyQyxTQUFTO2dCQUNQLHNGQUFzRixDQUFDO1FBQzNGLENBQUM7YUFBTSxJQUFJLGtCQUFrQixJQUFJLEdBQUcsRUFBRSxDQUFDO1lBQ3JDLFNBQVM7Z0JBQ1AscUhBQXFILENBQUM7UUFDMUgsQ0FBQzthQUFNLENBQUM7WUFDTixTQUFTO2dCQUNQLDhJQUE4SSxDQUFDO1FBQ25KLENBQUM7UUFFRCxPQUFPLFNBQVMsQ0FBQztJQUNuQixDQUFDO0lBRUQ7O09BRUc7SUFDSCxLQUFLLENBQUMseUJBQXlCLENBQzdCLE1BQWM7UUFFZCxJQUFJLENBQUM7WUFDSCxzQ0FBc0M7WUFDdEMsTUFBTSxxQkFBcUIsR0FBRyxNQUFNLElBQUksQ0FBQyx3QkFBd0IsQ0FBQyxNQUFNLENBQUMsQ0FBQztZQUUxRSxJQUNFLENBQUMscUJBQXFCO2dCQUN0QixNQUFNLENBQUMsSUFBSSxDQUFDLHFCQUFxQixDQUFDLFdBQVcsQ0FBQyxDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQzNELENBQUM7Z0JBQ0QsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMscUNBQXFDLE1BQU0sRUFBRSxDQUFDLENBQUM7Z0JBQ2hFLE9BQU8sRUFBRSxDQUFDO1lBQ1osQ0FBQztZQUVELGdDQUFnQztZQUNoQyxNQUFNLFdBQVcsR0FBRyxNQUFNLElBQUksQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FBQztnQkFDdkQsTUFBTSxFQUFFLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFO2FBQ25DLENBQUMsQ0FBQztZQUVILDZDQUE2QztZQUM3QyxNQUFNLGVBQWUsR0FBbUMsRUFBRSxDQUFDO1lBRTNELEtBQUssTUFBTSxTQUFTLElBQUksV0FBVyxFQUFFLENBQUM7Z0JBQ3BDLElBQUksQ0FBQztvQkFDSCxNQUFNLGFBQWEsR0FBRyxNQUFNLElBQUksQ0FBQywyQkFBMkIsQ0FDMUQscUJBQXFCLEVBQ3JCLFNBQVMsQ0FBQyxJQUFJLENBQ2YsQ0FBQztvQkFFRixnRUFBZ0U7b0JBQ2hFLElBQUksYUFBYSxDQUFDLGtCQUFrQixHQUFHLEdBQUcsRUFBRSxDQUFDO3dCQUMzQyxlQUFlLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxDQUFDO29CQUN0QyxDQUFDO2dCQUNILENBQUM7Z0JBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztvQkFDZixJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FDZix1Q0FBdUMsU0FBUyxDQUFDLElBQUksR0FBRyxFQUN4RCxLQUFLLENBQ04sQ0FBQztnQkFDSixDQUFDO1lBQ0gsQ0FBQztZQUVELDhDQUE4QztZQUM5QyxlQUFlLENBQUMsSUFBSSxDQUNsQixDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxrQkFBa0IsR0FBRyxDQUFDLENBQUMsa0JBQWtCLENBQ3RELENBQUM7WUFFRixnQ0FBZ0M7WUFDaEMsT0FBTyxlQUFlLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQztRQUN0QyxDQUFDO1FBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztZQUNmLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUNmLDBDQUEwQyxNQUFNLEdBQUcsRUFDbkQsS0FBSyxDQUNOLENBQUM7WUFDRixNQUFNLEtBQUssQ0FBQztRQUNkLENBQUM7SUFDSCxDQUFDO0lBRUQ7O09BRUc7SUFDSyxLQUFLLENBQUMsd0JBQXdCLENBQ3BDLE1BQWM7UUFFZCxJQUFJLENBQUM7WUFDSCxpQ0FBaUM7WUFDakMsTUFBTSxhQUFhLEdBQUcsTUFBTSxJQUFJLENBQUMsTUFBTSxDQUFDLGFBQWEsQ0FBQyxVQUFVLENBQUM7Z0JBQy9ELEtBQUssRUFBRSxFQUFFLFFBQVEsRUFBRSxNQUFNLEVBQUU7Z0JBQzNCLE1BQU0sRUFBRTtvQkFDTixPQUFPLEVBQUUsSUFBSTtvQkFDYixTQUFTLEVBQUUsSUFBSTtpQkFDaEI7YUFDRixDQUFDLENBQUM7WUFFSCxJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7Z0JBQ25CLE9BQU8sSUFBSSxDQUFDO1lBQ2QsQ0FBQztZQUVELGlDQUFpQztZQUNqQyxNQUFNLGNBQWMsR0FBRyxhQUFhLENBQUMsT0FBYyxDQUFDO1lBQ3BELElBQUksQ0FBQyxjQUFjLElBQUksT0FBTyxjQUFjLEtBQUssUUFBUSxFQUFFLENBQUM7Z0JBQzFELElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLG9DQUFvQyxNQUFNLEVBQUUsQ0FBQyxDQUFDO2dCQUMvRCxPQUFPLElBQUksQ0FBQztZQUNkLENBQUM7WUFFRCxNQUFNLE1BQU0sR0FBRyxjQUFjLENBQUMsTUFBYSxDQUFDO1lBQzVDLE1BQU0sY0FBYyxHQUFHLGNBQWMsQ0FBQyxjQUFxQixDQUFDO1lBRTVELElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQztnQkFDWixJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQywrQ0FBK0MsTUFBTSxFQUFFLENBQUMsQ0FBQztnQkFDMUUsT0FBTyxJQUFJLENBQUM7WUFDZCxDQUFDO1lBRUQsTUFBTSxXQUFXLEdBQTJCLEVBQUUsQ0FBQztZQUUvQyxpQ0FBaUM7WUFDakMsSUFBSSxNQUFNLEVBQUUsU0FBUyxLQUFLLElBQUksSUFBSSxNQUFNLEVBQUUsU0FBUyxLQUFLLFNBQVMsRUFBRSxDQUFDO2dCQUNsRSxXQUFXLENBQUMsSUFBSSxHQUFHO29CQUNqQixLQUFLLEVBQUUsTUFBTSxDQUFDLFNBQVM7b0JBQ3ZCLFFBQVEsRUFBRSxJQUFJLENBQUMscUJBQXFCLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQztvQkFDdEQsSUFBSSxFQUFFLGFBQWEsQ0FBQyxTQUFTO2lCQUM5QixDQUFDO1lBQ0osQ0FBQztZQUVELGlDQUFpQztZQUNqQyxJQUFJLE1BQU0sRUFBRSxTQUFTLEtBQUssSUFBSSxJQUFJLE1BQU0sRUFBRSxTQUFTLEtBQUssU0FBUyxFQUFFLENBQUM7Z0JBQ2xFLFdBQVcsQ0FBQyxJQUFJLEdBQUc7b0JBQ2pCLEtBQUssRUFBRSxNQUFNLENBQUMsU0FBUztvQkFDdkIsUUFBUSxFQUFFLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDO29CQUNuRCxJQUFJLEVBQUUsYUFBYSxDQUFDLFNBQVM7aUJBQzlCLENBQUM7WUFDSixDQUFDO1lBRUQsa0NBQWtDO1lBQ2xDLElBQUksTUFBTSxFQUFFLFVBQVUsS0FBSyxJQUFJLElBQUksTUFBTSxFQUFFLFVBQVUsS0FBSyxTQUFTLEVBQUUsQ0FBQztnQkFDcEUsV0FBVyxDQUFDLEtBQUssR0FBRztvQkFDbEIsS0FBSyxFQUFFLE1BQU0sQ0FBQyxVQUFVO29CQUN4QixRQUFRLEVBQUUsSUFBSSxDQUFDLGVBQWUsQ0FBQyxNQUFNLENBQUMsVUFBVSxDQUFDO29CQUNqRCxJQUFJLEVBQUUsYUFBYSxDQUFDLFNBQVM7aUJBQzlCLENBQUM7WUFDSixDQUFDO1lBRUQsT0FBTztnQkFDTCxNQUFNO2dCQUNOLFdBQVc7YUFDWixDQUFDO1FBQ0osQ0FBQztRQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7WUFDZixJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FDZiw2Q0FBNkMsTUFBTSxHQUFHLEVBQ3RELEtBQUssQ0FDTixDQUFDO1lBQ0YsT0FBTyxJQUFJLENBQUM7UUFDZCxDQUFDO0lBQ0gsQ0FBQztJQUVEOztPQUVHO0lBQ0sscUJBQXFCLENBQUMsS0FBYTtRQUN6QyxJQUFJLEtBQUssSUFBSSxDQUFDO1lBQUUsT0FBTyxTQUFTLENBQUM7UUFDakMsSUFBSSxLQUFLLElBQUksQ0FBQztZQUFFLE9BQU8sTUFBTSxDQUFDO1FBQzlCLElBQUksS0FBSyxJQUFJLEVBQUU7WUFBRSxPQUFPLFVBQVUsQ0FBQztRQUNuQyxJQUFJLEtBQUssSUFBSSxFQUFFO1lBQUUsT0FBTyxtQkFBbUIsQ0FBQztRQUM1QyxPQUFPLFFBQVEsQ0FBQztJQUNsQixDQUFDO0lBRUQ7O09BRUc7SUFDSyxrQkFBa0IsQ0FBQyxLQUFhO1FBQ3RDLElBQUksS0FBSyxJQUFJLENBQUM7WUFBRSxPQUFPLFNBQVMsQ0FBQztRQUNqQyxJQUFJLEtBQUssSUFBSSxDQUFDO1lBQUUsT0FBTyxNQUFNLENBQUM7UUFDOUIsSUFBSSxLQUFLLElBQUksRUFBRTtZQUFFLE9BQU8sVUFBVSxDQUFDO1FBQ25DLE9BQU8sUUFBUSxDQUFDO0lBQ2xCLENBQUM7SUFFRDs7T0FFRztJQUNLLGVBQWUsQ0FBQyxLQUFhO1FBQ25DLElBQUksS0FBSyxJQUFJLENBQUM7WUFBRSxPQUFPLFNBQVMsQ0FBQztRQUNqQyxJQUFJLEtBQUssSUFBSSxDQUFDO1lBQUUsT0FBTyxNQUFNLENBQUM7UUFDOUIsSUFBSSxLQUFLLElBQUksRUFBRTtZQUFFLE9BQU8sVUFBVSxDQUFDO1FBQ25DLE9BQU8sUUFBUSxDQUFDO0lBQ2xCLENBQUM7SUFFRDs7T0FFRztJQUNILEtBQUssQ0FBQyxzQkFBc0IsQ0FDMUIsTUFBYyxFQUNkLGNBQXNCO1FBRXRCLElBQUksQ0FBQztZQUNILElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUNiLHVDQUF1QyxNQUFNLEtBQUssY0FBYyxFQUFFLENBQ25FLENBQUM7WUFFRiwwQkFBMEI7WUFDMUIsTUFBTSxrQkFBa0IsR0FBRyxNQUFNLElBQUksQ0FBQyx5QkFBeUIsQ0FBQyxNQUFNLENBQUMsQ0FBQztZQUV4RSx3RkFBd0Y7WUFDeEYsK0JBQStCO1lBQy9CLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUNiLGFBQWEsa0JBQWtCLENBQUMsTUFBTSxpQ0FBaUMsTUFBTSxFQUFFLENBQ2hGLENBQUM7WUFFRixpRUFBaUU7WUFDakUsc0RBQXNEO1FBQ3hELENBQUM7UUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1lBQ2YsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQ2YsNkNBQTZDLE1BQU0sR0FBRyxFQUN0RCxLQUFLLENBQ04sQ0FBQztRQUNKLENBQUM7SUFDSCxDQUFDO0NBQ0YsQ0FBQTtBQTNiWSw0REFBd0I7bUNBQXhCLHdCQUF3QjtJQURwQyxJQUFBLG1CQUFVLEdBQUU7eURBSTBCLHNDQUFhLG9CQUFiLHNDQUFhO0dBSHZDLHdCQUF3QixDQTJicEMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL2NvbW11bml0aWVzL3NlcnZpY2VzL2NvbW11bml0eS1tYXRjaGluZy5zZXJ2aWNlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUsIExvZ2dlciB9IGZyb20gJ0BuZXN0anMvY29tbW9uJztcbmltcG9ydCB7IFByaXNtYVNlcnZpY2UgfSBmcm9tICcuLi8uLi9wcm92aWRlcnMvcHJpc21hLWNsaWVudC5wcm92aWRlcic7XG5cbi8vIEFzc2Vzc21lbnQgdHlwZXMgYW5kIHRoZWlyIGNvbW11bml0eSBtYXBwaW5nc1xuaW50ZXJmYWNlIEFzc2Vzc21lbnRDb21tdW5pdHlNYXBwaW5nIHtcbiAgLy8gUEhRLTkgKERlcHJlc3Npb24pIG1hcHBpbmdcbiAgcGhxOToge1xuICAgIHNjb3JlOiBudW1iZXI7XG4gICAgY29tbXVuaXRpZXM6IHN0cmluZ1tdOyAvLyBjb21tdW5pdHkgc2x1Z3NcbiAgICB3ZWlnaHQ6IG51bWJlcjtcbiAgfTtcbiAgLy8gR0FELTcgKEFueGlldHkpIG1hcHBpbmdcbiAgZ2FkNzoge1xuICAgIHNjb3JlOiBudW1iZXI7XG4gICAgY29tbXVuaXRpZXM6IHN0cmluZ1tdO1xuICAgIHdlaWdodDogbnVtYmVyO1xuICB9O1xuICAvLyBQVFNELTUgKFBUU0QpIG1hcHBpbmdcbiAgcHRzZDU6IHtcbiAgICBzY29yZTogbnVtYmVyO1xuICAgIGNvbW11bml0aWVzOiBzdHJpbmdbXTtcbiAgICB3ZWlnaHQ6IG51bWJlcjtcbiAgfTtcbiAgLy8gQWRkaXRpb25hbCBhc3Nlc3NtZW50IHR5cGVzIGNhbiBiZSBhZGRlZCBoZXJlXG4gIFtrZXk6IHN0cmluZ106IHtcbiAgICBzY29yZTogbnVtYmVyO1xuICAgIGNvbW11bml0aWVzOiBzdHJpbmdbXTtcbiAgICB3ZWlnaHQ6IG51bWJlcjtcbiAgfTtcbn1cblxuaW50ZXJmYWNlIFVzZXJBc3Nlc3NtZW50UHJvZmlsZSB7XG4gIHVzZXJJZDogc3RyaW5nO1xuICBhc3Nlc3NtZW50czoge1xuICAgIFthc3Nlc3NtZW50VHlwZTogc3RyaW5nXToge1xuICAgICAgc2NvcmU6IG51bWJlcjtcbiAgICAgIHNldmVyaXR5OiBzdHJpbmc7XG4gICAgICBkYXRlOiBEYXRlO1xuICAgIH07XG4gIH07XG59XG5cbmludGVyZmFjZSBDb21tdW5pdHlDb21wYXRpYmlsaXR5UmVzdWx0IHtcbiAgY29tbXVuaXR5SWQ6IHN0cmluZztcbiAgY29tbXVuaXR5U2x1Zzogc3RyaW5nO1xuICBjb21wYXRpYmlsaXR5U2NvcmU6IG51bWJlcjtcbiAgcmVhc29uaW5nOiBzdHJpbmc7XG4gIG1hdGNoaW5nRmFjdG9yczogc3RyaW5nW107XG4gIGFzc2Vzc21lbnRDb250cmlidXRpb25zOiB7XG4gICAgW2Fzc2Vzc21lbnRUeXBlOiBzdHJpbmddOiB7XG4gICAgICBzY29yZTogbnVtYmVyO1xuICAgICAgd2VpZ2h0OiBudW1iZXI7XG4gICAgICBjb250cmlidXRpb246IG51bWJlcjtcbiAgICB9O1xuICB9O1xufVxuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgQ29tbXVuaXR5TWF0Y2hpbmdTZXJ2aWNlIHtcbiAgcHJpdmF0ZSByZWFkb25seSBsb2dnZXIgPSBuZXcgTG9nZ2VyKENvbW11bml0eU1hdGNoaW5nU2VydmljZS5uYW1lKTtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIHJlYWRvbmx5IHByaXNtYTogUHJpc21hU2VydmljZSkge31cblxuICAvKipcbiAgICogQ29yZSBhc3Nlc3NtZW50LXRvLWNvbW11bml0eSBtYXBwaW5nIGNvbmZpZ3VyYXRpb25cbiAgICogVGhpcyBkZWZpbmVzIHdoaWNoIGNvbW11bml0aWVzIGFyZSBhcHByb3ByaWF0ZSBmb3IgZGlmZmVyZW50IGFzc2Vzc21lbnQgc2NvcmUgcmFuZ2VzXG4gICAqL1xuICBwcml2YXRlIGdldEFzc2Vzc21lbnRDb21tdW5pdHlNYXBwaW5ncygpOiBBc3Nlc3NtZW50Q29tbXVuaXR5TWFwcGluZyB7XG4gICAgcmV0dXJuIHtcbiAgICAgIC8vIFBIUS05IERlcHJlc3Npb24gU2NhbGUgKDAtMjcpXG4gICAgICBwaHE5OiB7XG4gICAgICAgIHNjb3JlOiAwLFxuICAgICAgICBjb21tdW5pdGllczogW1xuICAgICAgICAgICdnZW5lcmFsLXN1cHBvcnQnLFxuICAgICAgICAgICdkZXByZXNzaW9uLXN1cHBvcnQnLFxuICAgICAgICAgICdhbnhpZXR5LWRlcHJlc3Npb24nLFxuICAgICAgICAgICdtZW50YWwtd2VsbG5lc3MnLFxuICAgICAgICAgICdyZWNvdmVyeS1qb3VybmV5JyxcbiAgICAgICAgICAndGhlcmFweS1kaXNjdXNzaW9uJyxcbiAgICAgICAgXSxcbiAgICAgICAgd2VpZ2h0OiAwLjgsIC8vIEhpZ2ggd2VpZ2h0IGZvciBkZXByZXNzaW9uIG1hdGNoaW5nXG4gICAgICB9LFxuXG4gICAgICAvLyBHQUQtNyBBbnhpZXR5IFNjYWxlICgwLTIxKVxuICAgICAgZ2FkNzoge1xuICAgICAgICBzY29yZTogMCxcbiAgICAgICAgY29tbXVuaXRpZXM6IFtcbiAgICAgICAgICAnYW54aWV0eS1zdXBwb3J0JyxcbiAgICAgICAgICAncGFuaWMtZGlzb3JkZXInLFxuICAgICAgICAgICdzb2NpYWwtYW54aWV0eScsXG4gICAgICAgICAgJ2FueGlldHktZGVwcmVzc2lvbicsXG4gICAgICAgICAgJ21pbmRmdWxuZXNzLW1lZGl0YXRpb24nLFxuICAgICAgICAgICdjb3Bpbmctc3RyYXRlZ2llcycsXG4gICAgICAgIF0sXG4gICAgICAgIHdlaWdodDogMC43LFxuICAgICAgfSxcblxuICAgICAgLy8gUFRTRC01IFNjYWxlICgwLTIwKVxuICAgICAgcHRzZDU6IHtcbiAgICAgICAgc2NvcmU6IDAsXG4gICAgICAgIGNvbW11bml0aWVzOiBbXG4gICAgICAgICAgJ3B0c2Qtc3VwcG9ydCcsXG4gICAgICAgICAgJ3RyYXVtYS1yZWNvdmVyeScsXG4gICAgICAgICAgJ3ZldGVyYW5zLXN1cHBvcnQnLFxuICAgICAgICAgICdjb21wbGV4LXRyYXVtYScsXG4gICAgICAgICAgJ2hlYWxpbmctam91cm5leScsXG4gICAgICAgICAgJ3RoZXJhcHktZGlzY3Vzc2lvbicsXG4gICAgICAgIF0sXG4gICAgICAgIHdlaWdodDogMC45LCAvLyBWZXJ5IGhpZ2ggd2VpZ2h0IGZvciBQVFNEIG1hdGNoaW5nXG4gICAgICB9LFxuXG4gICAgICAvLyBBZGRpdGlvbmFsIGFzc2Vzc21lbnRzIGNhbiBiZSBhZGRlZCBoZXJlXG4gICAgICAvLyBiaXBvbGFyOiB7IHNjb3JlOiAwLCBjb21tdW5pdGllczogWydiaXBvbGFyLXN1cHBvcnQnLCAnbW9vZC1kaXNvcmRlcnMnXSwgd2VpZ2h0OiAwLjggfSxcbiAgICAgIC8vIG9jZDogeyBzY29yZTogMCwgY29tbXVuaXRpZXM6IFsnb2NkLXN1cHBvcnQnLCAnYW54aWV0eS1kaXNvcmRlcnMnXSwgd2VpZ2h0OiAwLjcgfSxcbiAgICB9O1xuICB9XG5cbiAgLyoqXG4gICAqIENhbGN1bGF0ZSBjb21wYXRpYmlsaXR5IHNjb3JlIGJldHdlZW4gdXNlciBhbmQgY29tbXVuaXR5IGJhc2VkIG9uIGFzc2Vzc21lbnQgc2NvcmVzXG4gICAqL1xuICBhc3luYyBjYWxjdWxhdGVDb21wYXRpYmlsaXR5U2NvcmUoXG4gICAgdXNlckFzc2Vzc21lbnRQcm9maWxlOiBVc2VyQXNzZXNzbWVudFByb2ZpbGUsXG4gICAgY29tbXVuaXR5U2x1Zzogc3RyaW5nLFxuICApOiBQcm9taXNlPENvbW11bml0eUNvbXBhdGliaWxpdHlSZXN1bHQ+IHtcbiAgICBjb25zdCBtYXBwaW5ncyA9IHRoaXMuZ2V0QXNzZXNzbWVudENvbW11bml0eU1hcHBpbmdzKCk7XG4gICAgbGV0IHRvdGFsU2NvcmUgPSAwO1xuICAgIGxldCB0b3RhbFdlaWdodCA9IDA7XG4gICAgY29uc3QgbWF0Y2hpbmdGYWN0b3JzOiBzdHJpbmdbXSA9IFtdO1xuICAgIGNvbnN0IGFzc2Vzc21lbnRDb250cmlidXRpb25zOiB7IFtrZXk6IHN0cmluZ106IGFueSB9ID0ge307XG5cbiAgICAvLyBHZXQgY29tbXVuaXR5IGluZm9ybWF0aW9uXG4gICAgY29uc3QgY29tbXVuaXR5ID0gYXdhaXQgdGhpcy5wcmlzbWEuY29tbXVuaXR5LmZpbmRVbmlxdWUoe1xuICAgICAgd2hlcmU6IHsgc2x1ZzogY29tbXVuaXR5U2x1ZyB9LFxuICAgICAgc2VsZWN0OiB7IGlkOiB0cnVlLCBuYW1lOiB0cnVlLCBzbHVnOiB0cnVlIH0sXG4gICAgfSk7XG5cbiAgICBpZiAoIWNvbW11bml0eSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBDb21tdW5pdHkgbm90IGZvdW5kOiAke2NvbW11bml0eVNsdWd9YCk7XG4gICAgfVxuXG4gICAgLy8gQ2FsY3VsYXRlIGNvbnRyaWJ1dGlvbiBmcm9tIGVhY2ggYXNzZXNzbWVudFxuICAgIGZvciAoY29uc3QgW2Fzc2Vzc21lbnRUeXBlLCBhc3Nlc3NtZW50RGF0YV0gb2YgT2JqZWN0LmVudHJpZXMoXG4gICAgICB1c2VyQXNzZXNzbWVudFByb2ZpbGUuYXNzZXNzbWVudHMsXG4gICAgKSkge1xuICAgICAgY29uc3QgbWFwcGluZyA9IG1hcHBpbmdzW2Fzc2Vzc21lbnRUeXBlXTtcbiAgICAgIGlmICghbWFwcGluZykgY29udGludWU7XG5cbiAgICAgIGNvbnN0IHVzZXJTY29yZSA9IGFzc2Vzc21lbnREYXRhLnNjb3JlO1xuICAgICAgY29uc3QgaXNSZWxldmFudENvbW11bml0eSA9IG1hcHBpbmcuY29tbXVuaXRpZXMuaW5jbHVkZXMoY29tbXVuaXR5U2x1Zyk7XG5cbiAgICAgIGlmIChpc1JlbGV2YW50Q29tbXVuaXR5KSB7XG4gICAgICAgIC8vIENhbGN1bGF0ZSBjb21wYXRpYmlsaXR5IGJhc2VkIG9uIHNldmVyaXR5IGFuZCBjb21tdW5pdHkgZm9jdXNcbiAgICAgICAgY29uc3Qgc2V2ZXJpdHlNdWx0aXBsaWVyID0gdGhpcy5nZXRTZXZlcml0eU11bHRpcGxpZXIoXG4gICAgICAgICAgYXNzZXNzbWVudFR5cGUsXG4gICAgICAgICAgdXNlclNjb3JlLFxuICAgICAgICApO1xuICAgICAgICBjb25zdCBjb21tdW5pdHlTcGVjaWZpY2l0eUJvbnVzID0gdGhpcy5nZXRDb21tdW5pdHlTcGVjaWZpY2l0eUJvbnVzKFxuICAgICAgICAgIGNvbW11bml0eVNsdWcsXG4gICAgICAgICAgYXNzZXNzbWVudFR5cGUsXG4gICAgICAgICk7XG5cbiAgICAgICAgY29uc3QgY29udHJpYnV0aW9uID1cbiAgICAgICAgICBzZXZlcml0eU11bHRpcGxpZXIgKiBjb21tdW5pdHlTcGVjaWZpY2l0eUJvbnVzICogbWFwcGluZy53ZWlnaHQ7XG5cbiAgICAgICAgdG90YWxTY29yZSArPSBjb250cmlidXRpb247XG4gICAgICAgIHRvdGFsV2VpZ2h0ICs9IG1hcHBpbmcud2VpZ2h0O1xuXG4gICAgICAgIG1hdGNoaW5nRmFjdG9ycy5wdXNoKFxuICAgICAgICAgIGAke2Fzc2Vzc21lbnRUeXBlLnRvVXBwZXJDYXNlKCl9ICgke2Fzc2Vzc21lbnREYXRhLnNldmVyaXR5fSlgLFxuICAgICAgICApO1xuXG4gICAgICAgIGFzc2Vzc21lbnRDb250cmlidXRpb25zW2Fzc2Vzc21lbnRUeXBlXSA9IHtcbiAgICAgICAgICBzY29yZTogdXNlclNjb3JlLFxuICAgICAgICAgIHdlaWdodDogbWFwcGluZy53ZWlnaHQsXG4gICAgICAgICAgY29udHJpYnV0aW9uOiBjb250cmlidXRpb24sXG4gICAgICAgIH07XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gTm9ybWFsaXplIHNjb3JlIHRvIDAtMSByYW5nZVxuICAgIGNvbnN0IGNvbXBhdGliaWxpdHlTY29yZSA9XG4gICAgICB0b3RhbFdlaWdodCA+IDAgPyBNYXRoLm1pbih0b3RhbFNjb3JlIC8gdG90YWxXZWlnaHQsIDEuMCkgOiAwO1xuXG4gICAgLy8gR2VuZXJhdGUgcmVhc29uaW5nIHRleHRcbiAgICBjb25zdCByZWFzb25pbmcgPSB0aGlzLmdlbmVyYXRlUmVhc29uaW5nVGV4dChcbiAgICAgIGNvbW11bml0eS5uYW1lLFxuICAgICAgbWF0Y2hpbmdGYWN0b3JzLFxuICAgICAgY29tcGF0aWJpbGl0eVNjb3JlLFxuICAgICAgYXNzZXNzbWVudENvbnRyaWJ1dGlvbnMsXG4gICAgKTtcblxuICAgIHJldHVybiB7XG4gICAgICBjb21tdW5pdHlJZDogY29tbXVuaXR5LmlkLFxuICAgICAgY29tbXVuaXR5U2x1ZzogY29tbXVuaXR5LnNsdWcsXG4gICAgICBjb21wYXRpYmlsaXR5U2NvcmUsXG4gICAgICByZWFzb25pbmcsXG4gICAgICBtYXRjaGluZ0ZhY3RvcnMsXG4gICAgICBhc3Nlc3NtZW50Q29udHJpYnV0aW9ucyxcbiAgICB9O1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCBzZXZlcml0eSBtdWx0aXBsaWVyIGJhc2VkIG9uIGFzc2Vzc21lbnQgdHlwZSBhbmQgc2NvcmVcbiAgICovXG4gIHByaXZhdGUgZ2V0U2V2ZXJpdHlNdWx0aXBsaWVyKGFzc2Vzc21lbnRUeXBlOiBzdHJpbmcsIHNjb3JlOiBudW1iZXIpOiBudW1iZXIge1xuICAgIHN3aXRjaCAoYXNzZXNzbWVudFR5cGUpIHtcbiAgICAgIGNhc2UgJ3BocTknOlxuICAgICAgICAvLyBQSFEtOTogMC00IG1pbmltYWwsIDUtOSBtaWxkLCAxMC0xNCBtb2RlcmF0ZSwgMTUtMTkgbW9kZXJhdGVseSBzZXZlcmUsIDIwLTI3IHNldmVyZVxuICAgICAgICBpZiAoc2NvcmUgPD0gNCkgcmV0dXJuIDAuMzsgLy8gTWluaW1hbCBkZXByZXNzaW9uIC0gbG93IGNvbW11bml0eSBuZWVkXG4gICAgICAgIGlmIChzY29yZSA8PSA5KSByZXR1cm4gMC42OyAvLyBNaWxkIGRlcHJlc3Npb24gLSBtb2RlcmF0ZSBjb21tdW5pdHkgYmVuZWZpdFxuICAgICAgICBpZiAoc2NvcmUgPD0gMTQpIHJldHVybiAwLjk7IC8vIE1vZGVyYXRlIGRlcHJlc3Npb24gLSBoaWdoIGNvbW11bml0eSBiZW5lZml0XG4gICAgICAgIGlmIChzY29yZSA8PSAxOSkgcmV0dXJuIDEuMDsgLy8gTW9kZXJhdGVseSBzZXZlcmUgLSBtYXhpbXVtIGNvbW11bml0eSBiZW5lZml0XG4gICAgICAgIHJldHVybiAxLjA7IC8vIFNldmVyZSBkZXByZXNzaW9uIC0gbWF4aW11bSBjb21tdW5pdHkgYmVuZWZpdFxuXG4gICAgICBjYXNlICdnYWQ3JzpcbiAgICAgICAgLy8gR0FELTc6IDAtNCBtaW5pbWFsLCA1LTkgbWlsZCwgMTAtMTQgbW9kZXJhdGUsIDE1LTIxIHNldmVyZVxuICAgICAgICBpZiAoc2NvcmUgPD0gNCkgcmV0dXJuIDAuMztcbiAgICAgICAgaWYgKHNjb3JlIDw9IDkpIHJldHVybiAwLjY7XG4gICAgICAgIGlmIChzY29yZSA8PSAxNCkgcmV0dXJuIDAuOTtcbiAgICAgICAgcmV0dXJuIDEuMDtcblxuICAgICAgY2FzZSAncHRzZDUnOlxuICAgICAgICAvLyBQVFNELTU6IDAtMiBtaW5pbWFsLCAzLTcgbWlsZCwgOC0xNCBtb2RlcmF0ZSwgMTUtMjAgc2V2ZXJlXG4gICAgICAgIGlmIChzY29yZSA8PSAyKSByZXR1cm4gMC4zO1xuICAgICAgICBpZiAoc2NvcmUgPD0gNykgcmV0dXJuIDAuNjtcbiAgICAgICAgaWYgKHNjb3JlIDw9IDE0KSByZXR1cm4gMC45O1xuICAgICAgICByZXR1cm4gMS4wO1xuXG4gICAgICBkZWZhdWx0OlxuICAgICAgICByZXR1cm4gMC41OyAvLyBEZWZhdWx0IG11bHRpcGxpZXIgZm9yIHVua25vd24gYXNzZXNzbWVudCB0eXBlc1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgYm9udXMgZm9yIGNvbW11bml0eS1zcGVjaWZpYyBmb2N1c1xuICAgKi9cbiAgcHJpdmF0ZSBnZXRDb21tdW5pdHlTcGVjaWZpY2l0eUJvbnVzKFxuICAgIGNvbW11bml0eVNsdWc6IHN0cmluZyxcbiAgICBhc3Nlc3NtZW50VHlwZTogc3RyaW5nLFxuICApOiBudW1iZXIge1xuICAgIC8vIEJvbnVzIGZvciBoaWdobHkgc3BlY2lmaWMgY29tbXVuaXRpZXNcbiAgICBjb25zdCBzcGVjaWZpY0NvbW11bml0aWVzID0ge1xuICAgICAgJ2RlcHJlc3Npb24tc3VwcG9ydCc6IFsncGhxOSddLFxuICAgICAgJ2FueGlldHktc3VwcG9ydCc6IFsnZ2FkNyddLFxuICAgICAgJ3B0c2Qtc3VwcG9ydCc6IFsncHRzZDUnXSxcbiAgICAgICd0cmF1bWEtcmVjb3ZlcnknOiBbJ3B0c2Q1J10sXG4gICAgICAncGFuaWMtZGlzb3JkZXInOiBbJ2dhZDcnXSxcbiAgICAgICdzb2NpYWwtYW54aWV0eSc6IFsnZ2FkNyddLFxuICAgIH07XG5cbiAgICBjb25zdCBjb21tdW5pdHlBc3Nlc3NtZW50cyA9IHNwZWNpZmljQ29tbXVuaXRpZXNbY29tbXVuaXR5U2x1Z107XG4gICAgaWYgKGNvbW11bml0eUFzc2Vzc21lbnRzICYmIGNvbW11bml0eUFzc2Vzc21lbnRzLmluY2x1ZGVzKGFzc2Vzc21lbnRUeXBlKSkge1xuICAgICAgcmV0dXJuIDEuMjsgLy8gMjAlIGJvbnVzIGZvciBoaWdobHkgc3BlY2lmaWMgbWF0Y2hlc1xuICAgIH1cblxuICAgIC8vIEdlbmVyYWwgY29tbXVuaXRpZXMgZ2V0IG5vIGJvbnVzXG4gICAgY29uc3QgZ2VuZXJhbENvbW11bml0aWVzID0gW1xuICAgICAgJ2dlbmVyYWwtc3VwcG9ydCcsXG4gICAgICAnbWVudGFsLXdlbGxuZXNzJyxcbiAgICAgICd0aGVyYXB5LWRpc2N1c3Npb24nLFxuICAgIF07XG4gICAgaWYgKGdlbmVyYWxDb21tdW5pdGllcy5pbmNsdWRlcyhjb21tdW5pdHlTbHVnKSkge1xuICAgICAgcmV0dXJuIDAuODsgLy8gU2xpZ2h0IHJlZHVjdGlvbiBmb3IgZ2VuZXJhbCBjb21tdW5pdGllc1xuICAgIH1cblxuICAgIHJldHVybiAxLjA7IC8vIE5vIGJvbnVzL3BlbmFsdHkgZm9yIG90aGVyIGNvbW11bml0aWVzXG4gIH1cblxuICAvKipcbiAgICogR2VuZXJhdGUgaHVtYW4tcmVhZGFibGUgcmVhc29uaW5nIHRleHRcbiAgICovXG4gIHByaXZhdGUgZ2VuZXJhdGVSZWFzb25pbmdUZXh0KFxuICAgIGNvbW11bml0eU5hbWU6IHN0cmluZyxcbiAgICBtYXRjaGluZ0ZhY3RvcnM6IHN0cmluZ1tdLFxuICAgIGNvbXBhdGliaWxpdHlTY29yZTogbnVtYmVyLFxuICAgIGFzc2Vzc21lbnRDb250cmlidXRpb25zOiB7IFtrZXk6IHN0cmluZ106IGFueSB9LFxuICApOiBzdHJpbmcge1xuICAgIGNvbnN0IHNjb3JlUGVyY2VudGFnZSA9IE1hdGgucm91bmQoY29tcGF0aWJpbGl0eVNjb3JlICogMTAwKTtcblxuICAgIGxldCByZWFzb25pbmcgPSBgQmFzZWQgb24geW91ciBhc3Nlc3NtZW50IHJlc3VsdHMsIHlvdSBoYXZlIGEgJHtzY29yZVBlcmNlbnRhZ2V9JSBjb21wYXRpYmlsaXR5IHdpdGggJHtjb21tdW5pdHlOYW1lfS4gYDtcblxuICAgIGlmIChtYXRjaGluZ0ZhY3RvcnMubGVuZ3RoID4gMCkge1xuICAgICAgcmVhc29uaW5nICs9IGBUaGlzIHJlY29tbWVuZGF0aW9uIGlzIGJhc2VkIG9uIHlvdXIgJHttYXRjaGluZ0ZhY3RvcnMuam9pbignLCAnKX0gc2NvcmVzLiBgO1xuICAgIH1cblxuICAgIGlmIChjb21wYXRpYmlsaXR5U2NvcmUgPj0gMC44KSB7XG4gICAgICByZWFzb25pbmcgKz1cbiAgICAgICAgJ1RoaXMgY29tbXVuaXR5IGFwcGVhcnMgdG8gYmUgYW4gZXhjZWxsZW50IG1hdGNoIGZvciB5b3VyIGN1cnJlbnQgbmVlZHMgYW5kIG1heSBwcm92aWRlIHZhbHVhYmxlIHN1cHBvcnQgYW5kIHJlc291cmNlcy4nO1xuICAgIH0gZWxzZSBpZiAoY29tcGF0aWJpbGl0eVNjb3JlID49IDAuNikge1xuICAgICAgcmVhc29uaW5nICs9XG4gICAgICAgICdUaGlzIGNvbW11bml0eSBjb3VsZCBiZSBhIGdvb2QgZml0IGFuZCBtYXkgb2ZmZXIgaGVscGZ1bCBzdXBwb3J0IGZvciB5b3VyIHNpdHVhdGlvbi4nO1xuICAgIH0gZWxzZSBpZiAoY29tcGF0aWJpbGl0eVNjb3JlID49IDAuNCkge1xuICAgICAgcmVhc29uaW5nICs9XG4gICAgICAgICdUaGlzIGNvbW11bml0eSBtYXkgcHJvdmlkZSBzb21lIHJlbGV2YW50IHN1cHBvcnQsIHRob3VnaCBpdCBtaWdodCBub3QgYmUgdGhlIG1vc3QgdGFyZ2V0ZWQgZm9yIHlvdXIgc3BlY2lmaWMgbmVlZHMuJztcbiAgICB9IGVsc2Uge1xuICAgICAgcmVhc29uaW5nICs9XG4gICAgICAgICdXaGlsZSB0aGlzIGNvbW11bml0eSBvZmZlcnMgZ2VuZXJhbCBzdXBwb3J0LCB0aGVyZSBtYXkgYmUgb3RoZXIgY29tbXVuaXRpZXMgdGhhdCBhcmUgbW9yZSBzcGVjaWZpY2FsbHkgYWxpZ25lZCB3aXRoIHlvdXIgYXNzZXNzbWVudCByZXN1bHRzLic7XG4gICAgfVxuXG4gICAgcmV0dXJuIHJlYXNvbmluZztcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgY29tcHJlaGVuc2l2ZSBjb21tdW5pdHkgcmVjb21tZW5kYXRpb25zIGZvciBhIHVzZXJcbiAgICovXG4gIGFzeW5jIGdldFJlY29tbWVuZGF0aW9uc0ZvclVzZXIoXG4gICAgdXNlcklkOiBzdHJpbmcsXG4gICk6IFByb21pc2U8Q29tbXVuaXR5Q29tcGF0aWJpbGl0eVJlc3VsdFtdPiB7XG4gICAgdHJ5IHtcbiAgICAgIC8vIEdldCB1c2VyJ3MgbGF0ZXN0IGFzc2Vzc21lbnQgc2NvcmVzXG4gICAgICBjb25zdCB1c2VyQXNzZXNzbWVudFByb2ZpbGUgPSBhd2FpdCB0aGlzLmdldFVzZXJBc3Nlc3NtZW50UHJvZmlsZSh1c2VySWQpO1xuXG4gICAgICBpZiAoXG4gICAgICAgICF1c2VyQXNzZXNzbWVudFByb2ZpbGUgfHxcbiAgICAgICAgT2JqZWN0LmtleXModXNlckFzc2Vzc21lbnRQcm9maWxlLmFzc2Vzc21lbnRzKS5sZW5ndGggPT09IDBcbiAgICAgICkge1xuICAgICAgICB0aGlzLmxvZ2dlci53YXJuKGBObyBhc3Nlc3NtZW50IGRhdGEgZm91bmQgZm9yIHVzZXIgJHt1c2VySWR9YCk7XG4gICAgICAgIHJldHVybiBbXTtcbiAgICAgIH1cblxuICAgICAgLy8gR2V0IGFsbCBhdmFpbGFibGUgY29tbXVuaXRpZXNcbiAgICAgIGNvbnN0IGNvbW11bml0aWVzID0gYXdhaXQgdGhpcy5wcmlzbWEuY29tbXVuaXR5LmZpbmRNYW55KHtcbiAgICAgICAgc2VsZWN0OiB7IHNsdWc6IHRydWUsIG5hbWU6IHRydWUgfSxcbiAgICAgIH0pO1xuXG4gICAgICAvLyBDYWxjdWxhdGUgY29tcGF0aWJpbGl0eSBmb3IgZWFjaCBjb21tdW5pdHlcbiAgICAgIGNvbnN0IHJlY29tbWVuZGF0aW9uczogQ29tbXVuaXR5Q29tcGF0aWJpbGl0eVJlc3VsdFtdID0gW107XG5cbiAgICAgIGZvciAoY29uc3QgY29tbXVuaXR5IG9mIGNvbW11bml0aWVzKSB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgY29uc3QgY29tcGF0aWJpbGl0eSA9IGF3YWl0IHRoaXMuY2FsY3VsYXRlQ29tcGF0aWJpbGl0eVNjb3JlKFxuICAgICAgICAgICAgdXNlckFzc2Vzc21lbnRQcm9maWxlLFxuICAgICAgICAgICAgY29tbXVuaXR5LnNsdWcsXG4gICAgICAgICAgKTtcblxuICAgICAgICAgIC8vIE9ubHkgaW5jbHVkZSBjb21tdW5pdGllcyB3aXRoIG1lYW5pbmdmdWwgY29tcGF0aWJpbGl0eSAoPjIwJSlcbiAgICAgICAgICBpZiAoY29tcGF0aWJpbGl0eS5jb21wYXRpYmlsaXR5U2NvcmUgPiAwLjIpIHtcbiAgICAgICAgICAgIHJlY29tbWVuZGF0aW9ucy5wdXNoKGNvbXBhdGliaWxpdHkpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICB0aGlzLmxvZ2dlci5lcnJvcihcbiAgICAgICAgICAgIGBFcnJvciBjYWxjdWxhdGluZyBjb21wYXRpYmlsaXR5IGZvciAke2NvbW11bml0eS5zbHVnfTpgLFxuICAgICAgICAgICAgZXJyb3IsXG4gICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICAvLyBTb3J0IGJ5IGNvbXBhdGliaWxpdHkgc2NvcmUgKGhpZ2hlc3QgZmlyc3QpXG4gICAgICByZWNvbW1lbmRhdGlvbnMuc29ydChcbiAgICAgICAgKGEsIGIpID0+IGIuY29tcGF0aWJpbGl0eVNjb3JlIC0gYS5jb21wYXRpYmlsaXR5U2NvcmUsXG4gICAgICApO1xuXG4gICAgICAvLyBSZXR1cm4gdG9wIDEwIHJlY29tbWVuZGF0aW9uc1xuICAgICAgcmV0dXJuIHJlY29tbWVuZGF0aW9ucy5zbGljZSgwLCAxMCk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRoaXMubG9nZ2VyLmVycm9yKFxuICAgICAgICBgRXJyb3IgZ2V0dGluZyByZWNvbW1lbmRhdGlvbnMgZm9yIHVzZXIgJHt1c2VySWR9OmAsXG4gICAgICAgIGVycm9yLFxuICAgICAgKTtcbiAgICAgIHRocm93IGVycm9yO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgdXNlcidzIGFzc2Vzc21lbnQgcHJvZmlsZSBmcm9tIGRhdGFiYXNlXG4gICAqL1xuICBwcml2YXRlIGFzeW5jIGdldFVzZXJBc3Nlc3NtZW50UHJvZmlsZShcbiAgICB1c2VySWQ6IHN0cmluZyxcbiAgKTogUHJvbWlzZTxVc2VyQXNzZXNzbWVudFByb2ZpbGUgfCBudWxsPiB7XG4gICAgdHJ5IHtcbiAgICAgIC8vIEdldCB1c2VyJ3MgcHJlLWFzc2Vzc21lbnQgZGF0YVxuICAgICAgY29uc3QgcHJlQXNzZXNzbWVudCA9IGF3YWl0IHRoaXMucHJpc21hLnByZUFzc2Vzc21lbnQuZmluZFVuaXF1ZSh7XG4gICAgICAgIHdoZXJlOiB7IGNsaWVudElkOiB1c2VySWQgfSxcbiAgICAgICAgc2VsZWN0OiB7XG4gICAgICAgICAgYW5zd2VyczogdHJ1ZSxcbiAgICAgICAgICBjcmVhdGVkQXQ6IHRydWUsXG4gICAgICAgIH0sXG4gICAgICB9KTtcblxuICAgICAgaWYgKCFwcmVBc3Nlc3NtZW50KSB7XG4gICAgICAgIHJldHVybiBudWxsO1xuICAgICAgfVxuXG4gICAgICAvLyBFeHRyYWN0IGRhdGEgZnJvbSBhbnN3ZXJzIEpTT05cbiAgICAgIGNvbnN0IGFzc2Vzc21lbnREYXRhID0gcHJlQXNzZXNzbWVudC5hbnN3ZXJzIGFzIGFueTtcbiAgICAgIGlmICghYXNzZXNzbWVudERhdGEgfHwgdHlwZW9mIGFzc2Vzc21lbnREYXRhICE9PSAnb2JqZWN0Jykge1xuICAgICAgICB0aGlzLmxvZ2dlci53YXJuKGBJbnZhbGlkIGFzc2Vzc21lbnQgZGF0YSBmb3IgdXNlciAke3VzZXJJZH1gKTtcbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHNjb3JlcyA9IGFzc2Vzc21lbnREYXRhLnNjb3JlcyBhcyBhbnk7XG4gICAgICBjb25zdCBzZXZlcml0eUxldmVscyA9IGFzc2Vzc21lbnREYXRhLnNldmVyaXR5TGV2ZWxzIGFzIGFueTtcblxuICAgICAgaWYgKCFzY29yZXMpIHtcbiAgICAgICAgdGhpcy5sb2dnZXIud2FybihgTm8gc2NvcmVzIGZvdW5kIGluIGFzc2Vzc21lbnQgZGF0YSBmb3IgdXNlciAke3VzZXJJZH1gKTtcbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IGFzc2Vzc21lbnRzOiB7IFtrZXk6IHN0cmluZ106IGFueSB9ID0ge307XG5cbiAgICAgIC8vIE1hcCBQSFEtOSBzY29yZSBmcm9tIEpTT04gZGF0YVxuICAgICAgaWYgKHNjb3Jlcz8ucGhxOVNjb3JlICE9PSBudWxsICYmIHNjb3Jlcz8ucGhxOVNjb3JlICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgYXNzZXNzbWVudHMucGhxOSA9IHtcbiAgICAgICAgICBzY29yZTogc2NvcmVzLnBocTlTY29yZSxcbiAgICAgICAgICBzZXZlcml0eTogdGhpcy5nZXREZXByZXNzaW9uU2V2ZXJpdHkoc2NvcmVzLnBocTlTY29yZSksXG4gICAgICAgICAgZGF0ZTogcHJlQXNzZXNzbWVudC5jcmVhdGVkQXQsXG4gICAgICAgIH07XG4gICAgICB9XG5cbiAgICAgIC8vIE1hcCBHQUQtNyBzY29yZSBmcm9tIEpTT04gZGF0YVxuICAgICAgaWYgKHNjb3Jlcz8uZ2FkN1Njb3JlICE9PSBudWxsICYmIHNjb3Jlcz8uZ2FkN1Njb3JlICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgYXNzZXNzbWVudHMuZ2FkNyA9IHtcbiAgICAgICAgICBzY29yZTogc2NvcmVzLmdhZDdTY29yZSxcbiAgICAgICAgICBzZXZlcml0eTogdGhpcy5nZXRBbnhpZXR5U2V2ZXJpdHkoc2NvcmVzLmdhZDdTY29yZSksXG4gICAgICAgICAgZGF0ZTogcHJlQXNzZXNzbWVudC5jcmVhdGVkQXQsXG4gICAgICAgIH07XG4gICAgICB9XG5cbiAgICAgIC8vIE1hcCBQVFNELTUgc2NvcmUgZnJvbSBKU09OIGRhdGFcbiAgICAgIGlmIChzY29yZXM/LnB0c2Q1U2NvcmUgIT09IG51bGwgJiYgc2NvcmVzPy5wdHNkNVNjb3JlICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgYXNzZXNzbWVudHMucHRzZDUgPSB7XG4gICAgICAgICAgc2NvcmU6IHNjb3Jlcy5wdHNkNVNjb3JlLFxuICAgICAgICAgIHNldmVyaXR5OiB0aGlzLmdldFBUU0RTZXZlcml0eShzY29yZXMucHRzZDVTY29yZSksXG4gICAgICAgICAgZGF0ZTogcHJlQXNzZXNzbWVudC5jcmVhdGVkQXQsXG4gICAgICAgIH07XG4gICAgICB9XG5cbiAgICAgIHJldHVybiB7XG4gICAgICAgIHVzZXJJZCxcbiAgICAgICAgYXNzZXNzbWVudHMsXG4gICAgICB9O1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aGlzLmxvZ2dlci5lcnJvcihcbiAgICAgICAgYEVycm9yIGdldHRpbmcgYXNzZXNzbWVudCBwcm9maWxlIGZvciB1c2VyICR7dXNlcklkfTpgLFxuICAgICAgICBlcnJvcixcbiAgICAgICk7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogR2V0IGRlcHJlc3Npb24gc2V2ZXJpdHkgbGFiZWwgZnJvbSBQSFEtOSBzY29yZVxuICAgKi9cbiAgcHJpdmF0ZSBnZXREZXByZXNzaW9uU2V2ZXJpdHkoc2NvcmU6IG51bWJlcik6IHN0cmluZyB7XG4gICAgaWYgKHNjb3JlIDw9IDQpIHJldHVybiAnbWluaW1hbCc7XG4gICAgaWYgKHNjb3JlIDw9IDkpIHJldHVybiAnbWlsZCc7XG4gICAgaWYgKHNjb3JlIDw9IDE0KSByZXR1cm4gJ21vZGVyYXRlJztcbiAgICBpZiAoc2NvcmUgPD0gMTkpIHJldHVybiAnbW9kZXJhdGVseSBzZXZlcmUnO1xuICAgIHJldHVybiAnc2V2ZXJlJztcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgYW54aWV0eSBzZXZlcml0eSBsYWJlbCBmcm9tIEdBRC03IHNjb3JlXG4gICAqL1xuICBwcml2YXRlIGdldEFueGlldHlTZXZlcml0eShzY29yZTogbnVtYmVyKTogc3RyaW5nIHtcbiAgICBpZiAoc2NvcmUgPD0gNCkgcmV0dXJuICdtaW5pbWFsJztcbiAgICBpZiAoc2NvcmUgPD0gOSkgcmV0dXJuICdtaWxkJztcbiAgICBpZiAoc2NvcmUgPD0gMTQpIHJldHVybiAnbW9kZXJhdGUnO1xuICAgIHJldHVybiAnc2V2ZXJlJztcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgUFRTRCBzZXZlcml0eSBsYWJlbCBmcm9tIFBUU0QtNSBzY29yZVxuICAgKi9cbiAgcHJpdmF0ZSBnZXRQVFNEU2V2ZXJpdHkoc2NvcmU6IG51bWJlcik6IHN0cmluZyB7XG4gICAgaWYgKHNjb3JlIDw9IDIpIHJldHVybiAnbWluaW1hbCc7XG4gICAgaWYgKHNjb3JlIDw9IDcpIHJldHVybiAnbWlsZCc7XG4gICAgaWYgKHNjb3JlIDw9IDE0KSByZXR1cm4gJ21vZGVyYXRlJztcbiAgICByZXR1cm4gJ3NldmVyZSc7XG4gIH1cblxuICAvKipcbiAgICogRGV0ZWN0IHdoZW4gdXNlcidzIGFzc2Vzc21lbnRzIGhhdmUgY2hhbmdlZCBhbmQgdHJpZ2dlciByZWNvbW1lbmRhdGlvbiByZWZyZXNoXG4gICAqL1xuICBhc3luYyBoYW5kbGVBc3Nlc3NtZW50Q2hhbmdlKFxuICAgIHVzZXJJZDogc3RyaW5nLFxuICAgIGFzc2Vzc21lbnRUeXBlOiBzdHJpbmcsXG4gICk6IFByb21pc2U8dm9pZD4ge1xuICAgIHRyeSB7XG4gICAgICB0aGlzLmxvZ2dlci5sb2coXG4gICAgICAgIGBBc3Nlc3NtZW50IGNoYW5nZSBkZXRlY3RlZCBmb3IgdXNlciAke3VzZXJJZH06ICR7YXNzZXNzbWVudFR5cGV9YCxcbiAgICAgICk7XG5cbiAgICAgIC8vIEdldCBuZXcgcmVjb21tZW5kYXRpb25zXG4gICAgICBjb25zdCBuZXdSZWNvbW1lbmRhdGlvbnMgPSBhd2FpdCB0aGlzLmdldFJlY29tbWVuZGF0aW9uc0ZvclVzZXIodXNlcklkKTtcblxuICAgICAgLy8gU3RvcmUgcmVjb21tZW5kYXRpb25zIGluIGRhdGFiYXNlICh3aWxsIGJlIGhhbmRsZWQgYnkgQ29tbXVuaXR5UmVjb21tZW5kYXRpb25TZXJ2aWNlKVxuICAgICAgLy8gRm9yIG5vdywganVzdCBsb2cgdGhlIGNoYW5nZVxuICAgICAgdGhpcy5sb2dnZXIubG9nKFxuICAgICAgICBgR2VuZXJhdGVkICR7bmV3UmVjb21tZW5kYXRpb25zLmxlbmd0aH0gbmV3IHJlY29tbWVuZGF0aW9ucyBmb3IgdXNlciAke3VzZXJJZH1gLFxuICAgICAgKTtcblxuICAgICAgLy8gVE9ETzogVHJpZ2dlciBub3RpZmljYXRpb24gdG8gdXNlciBhYm91dCBuZXcgY29tbXVuaXR5IG1hdGNoZXNcbiAgICAgIC8vIFRPRE86IFVwZGF0ZSBleGlzdGluZyByZWNvbW1lbmRhdGlvbnMgaWYgdGhleSBleGlzdFxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aGlzLmxvZ2dlci5lcnJvcihcbiAgICAgICAgYEVycm9yIGhhbmRsaW5nIGFzc2Vzc21lbnQgY2hhbmdlIGZvciB1c2VyICR7dXNlcklkfTpgLFxuICAgICAgICBlcnJvcixcbiAgICAgICk7XG4gICAgfVxuICB9XG59XG4iXSwidmVyc2lvbiI6M30=