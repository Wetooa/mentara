{"file":"/home/wetooa/Documents/code/projects/mentara/mentara-api/src/test-utils/database-test.setup.ts","mappings":"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","names":[],"sources":["/home/wetooa/Documents/code/projects/mentara/mentara-api/src/test-utils/database-test.setup.ts"],"sourcesContent":["import { Test, TestingModule } from '@nestjs/testing';\nimport { PrismaService } from '../providers/prisma-client.provider';\nimport {\n  PostgreSqlContainer,\n  StartedPostgreSqlContainer,\n} from '@testcontainers/postgresql';\n\ninterface CleanupStats {\n  tablesProcessed: number;\n  recordsDeleted: number;\n  errors: string[];\n  duration: number;\n}\n\nexport class DatabaseTestSetup {\n  private static container: StartedPostgreSqlContainer;\n  private static prismaService: PrismaService;\n  private static cleanupStats: CleanupStats[] = [];\n\n  static async startContainer(): Promise<StartedPostgreSqlContainer> {\n    if (!this.container) {\n      this.container = await new PostgreSqlContainer('postgres:15')\n        .withDatabase('mentara_test')\n        .withUsername('test_user')\n        .withPassword('test_password')\n        .withExposedPorts(5432)\n        .withEnvironment({\n          POSTGRES_INITDB_ARGS: '--auth-host=scram-sha-256',\n        })\n        .start();\n    }\n    return this.container;\n  }\n\n  static async setupTestDatabase(): Promise<PrismaService> {\n    const container = await this.startContainer();\n\n    // Set environment variable for test database\n    process.env.DATABASE_URL = container.getConnectionUri();\n\n    const module: TestingModule = await Test.createTestingModule({\n      providers: [PrismaService],\n    }).compile();\n\n    this.prismaService = module.get<PrismaService>(PrismaService);\n\n    // Run migrations\n    // eslint-disable-next-line @typescript-eslint/no-require-imports\n    const { execSync } = require('child_process');\n    execSync('npx prisma migrate deploy', {\n      env: { ...process.env, DATABASE_URL: container.getConnectionUri() },\n    });\n\n    return this.prismaService;\n  }\n\n  /**\n   * Enhanced database cleanup with comprehensive table coverage\n   * Includes all 18+ Prisma models and their relationships\n   */\n  static async cleanupDatabase(): Promise<CleanupStats> {\n    const startTime = Date.now();\n    const stats: CleanupStats = {\n      tablesProcessed: 0,\n      recordsDeleted: 0,\n      errors: [],\n      duration: 0,\n    };\n\n    if (!this.prismaService) {\n      stats.errors.push('PrismaService not initialized');\n      return stats;\n    }\n\n    // Comprehensive table cleanup order respecting all foreign key constraints\n    // Order is critical: child tables first, parent tables last\n    const tableCleanupOrder = [\n      // Messaging system (deepest dependencies)\n      'TypingIndicator',\n      'MessageReaction',\n      'MessageReadReceipt',\n      'Message',\n      'ConversationParticipant',\n      'Conversation',\n      'UserBlock',\n\n      // Community content (posts, comments, replies)\n      'ReplyHeart',\n      'Reply',\n      'CommentHeart',\n      'Comment',\n      'PostHeart',\n      'Post',\n      'Membership',\n      'Room',\n      'RoomGroup',\n      'Community',\n\n      // Analytics and matching\n      'RecommendationFeedback',\n      'AlgorithmPerformance',\n      'ClientCompatibility',\n      'MatchHistory',\n      'MatchingWeight',\n\n      // Reviews and ratings\n      'ReviewHelpful',\n      'Review',\n\n      // Sessions and meetings\n      'SessionLog',\n      'Meeting',\n      'TherapyProgress',\n      'TherapistAvailability',\n\n      // Assessments and worksheets\n      'Assessment',\n      'MentalHealthIndicator',\n      'Worksheet',\n      'PreAssessment',\n\n      // File management\n      'FileDownload',\n      'FileShare',\n      'FileVersion',\n      'File',\n\n      // Billing and subscriptions\n      'DiscountRedemption',\n      'PaymentMethod',\n      'Subscription',\n\n      // Notifications and activities\n      'Notification',\n      'NotificationSettings',\n      'UserActivity',\n      'AuditLog',\n\n      // Client-therapist relationships\n      'ClientPreference',\n      'ClientMedicalHistory',\n      'ClientTherapist',\n\n      // Role-specific profiles\n      'Therapist',\n      'Client',\n      'Moderator',\n      'ModeratorCommunity',\n      'Admin',\n\n      // Core user table (must be last)\n      'User',\n    ];\n\n    // Process each table with enhanced error handling and statistics\n    for (const tableName of tableCleanupOrder) {\n      try {\n        // Get count before deletion for statistics\n        const countQuery = `SELECT COUNT(*) as count FROM \"${tableName}\"`;\n        const countResult =\n          await this.prismaService.$queryRawUnsafe<[{ count: string }]>(\n            countQuery,\n          );\n        const recordCount = parseInt(countResult[0]?.count || '0', 10);\n\n        if (recordCount > 0) {\n          // Use TRUNCATE for better performance and to reset sequences\n          await this.prismaService.$executeRawUnsafe(\n            `TRUNCATE TABLE \"${tableName}\" RESTART IDENTITY CASCADE;`,\n          );\n          stats.recordsDeleted += recordCount;\n        }\n\n        stats.tablesProcessed++;\n      } catch (error) {\n        // Log error but continue with cleanup\n        const errorMessage =\n          error instanceof Error ? error.message : String(error);\n\n        // Only log as error if it's not a \"table doesn't exist\" error\n        if (!errorMessage.includes('does not exist')) {\n          stats.errors.push(`${tableName}: ${errorMessage}`);\n        }\n\n        // Try alternative cleanup method for problematic tables\n        try {\n          await this.prismaService.$executeRawUnsafe(\n            `DELETE FROM \"${tableName}\";`,\n          );\n          stats.tablesProcessed++;\n        } catch (alternativeError) {\n          const altErrorMessage =\n            alternativeError instanceof Error\n              ? alternativeError.message\n              : String(alternativeError);\n          if (!altErrorMessage.includes('does not exist')) {\n            stats.errors.push(`${tableName} (alternative): ${altErrorMessage}`);\n          }\n        }\n      }\n    }\n\n    // Reset all sequences to ensure consistent test data\n    try {\n      const sequenceResetQueries = [\n        \"SELECT setval(pg_get_serial_sequence('\\\"User\\\"', 'id'), 1, false);\",\n        \"SELECT setval(pg_get_serial_sequence('\\\"Community\\\"', 'id'), 1, false);\",\n        \"SELECT setval(pg_get_serial_sequence('\\\"Conversation\\\"', 'id'), 1, false);\",\n        \"SELECT setval(pg_get_serial_sequence('\\\"Meeting\\\"', 'id'), 1, false);\",\n      ];\n\n      for (const query of sequenceResetQueries) {\n        try {\n          await this.prismaService.$executeRawUnsafe(query);\n        } catch {\n          // Ignore sequence reset errors (sequence might not exist)\n        }\n      }\n    } catch {\n      // Ignore sequence reset errors\n    }\n\n    stats.duration = Date.now() - startTime;\n    this.cleanupStats.push(stats);\n\n    // Log cleanup statistics in debug mode\n    if (process.env.DEBUG_TESTS === 'true') {\n      console.log(`üßπ Database Cleanup Complete:\n        üìä Tables Processed: ${stats.tablesProcessed}\n        üóëÔ∏è  Records Deleted: ${stats.recordsDeleted}\n        ‚è±Ô∏è  Duration: ${stats.duration}ms\n        ‚ùå Errors: ${stats.errors.length}\n      `);\n\n      if (stats.errors.length > 0) {\n        console.log('Cleanup Errors:', stats.errors);\n      }\n    }\n\n    return stats;\n  }\n\n  /**\n   * Enhanced cleanup for specific test scenarios\n   */\n  static async cleanupMessagingData(): Promise<void> {\n    if (!this.prismaService) return;\n\n    const messagingTables = [\n      'TypingIndicator',\n      'MessageReaction',\n      'MessageReadReceipt',\n      'Message',\n      'ConversationParticipant',\n      'Conversation',\n      'UserBlock',\n    ];\n\n    for (const table of messagingTables) {\n      try {\n        await this.prismaService.$executeRawUnsafe(\n          `TRUNCATE TABLE \"${table}\" RESTART IDENTITY CASCADE;`,\n        );\n      } catch {\n        // Ignore errors for non-existent tables\n      }\n    }\n  }\n\n  static async cleanupAnalyticsData(): Promise<void> {\n    if (!this.prismaService) return;\n\n    const analyticsTables = [\n      'RecommendationFeedback',\n      'AlgorithmPerformance',\n      'ClientCompatibility',\n      'MatchHistory',\n      'MatchingWeight',\n    ];\n\n    for (const table of analyticsTables) {\n      try {\n        await this.prismaService.$executeRawUnsafe(\n          `TRUNCATE TABLE \"${table}\" RESTART IDENTITY CASCADE;`,\n        );\n      } catch {\n        // Ignore errors for non-existent tables\n      }\n    }\n  }\n\n  static async cleanupCommunityData(): Promise<void> {\n    if (!this.prismaService) return;\n\n    const communityTables = [\n      'ReplyHeart',\n      'Reply',\n      'CommentHeart',\n      'Comment',\n      'PostHeart',\n      'Post',\n      'Membership',\n      'Room',\n      'RoomGroup',\n      'Community',\n    ];\n\n    for (const table of communityTables) {\n      try {\n        await this.prismaService.$executeRawUnsafe(\n          `TRUNCATE TABLE \"${table}\" RESTART IDENTITY CASCADE;`,\n        );\n      } catch {\n        // Ignore errors for non-existent tables\n      }\n    }\n  }\n\n  /**\n   * Verify database connectivity and schema integrity\n   */\n  static async verifyDatabaseHealth(): Promise<{\n    isConnected: boolean;\n    schemaValid: boolean;\n    tableCount: number;\n    errors: string[];\n  }> {\n    const health = {\n      isConnected: false,\n      schemaValid: false,\n      tableCount: 0,\n      errors: [] as string[],\n    };\n\n    try {\n      // Test basic connectivity\n      await this.prismaService.$queryRaw`SELECT 1`;\n      health.isConnected = true;\n\n      // Count tables in the database\n      const tableCountResult = await this.prismaService.$queryRaw<\n        [{ count: bigint }]\n      >`\n        SELECT COUNT(*) as count \n        FROM information_schema.tables \n        WHERE table_schema = 'public'\n      `;\n      health.tableCount = Number(tableCountResult[0]?.count || 0);\n\n      // Verify key tables exist\n      const keyTables = ['User', 'Client', 'Therapist', 'Meeting', 'Community'];\n      for (const table of keyTables) {\n        try {\n          await this.prismaService.$queryRawUnsafe(\n            `SELECT 1 FROM \"${table}\" LIMIT 1`,\n          );\n        } catch (error) {\n          health.errors.push(`Missing or inaccessible table: ${table}`);\n        }\n      }\n\n      health.schemaValid = health.errors.length === 0;\n    } catch (error) {\n      const errorMessage =\n        error instanceof Error ? error.message : String(error);\n      health.errors.push(`Database connection error: ${errorMessage}`);\n    }\n\n    return health;\n  }\n\n  /**\n   * Get cleanup statistics for performance monitoring\n   */\n  static getCleanupStatistics(): CleanupStats[] {\n    return [...this.cleanupStats];\n  }\n\n  /**\n   * Reset cleanup statistics\n   */\n  static resetCleanupStatistics(): void {\n    this.cleanupStats = [];\n  }\n\n  static async stopContainer(): Promise<void> {\n    if (this.container) {\n      await this.container.stop();\n    }\n  }\n\n  static getPrismaService(): PrismaService {\n    return this.prismaService;\n  }\n\n  /**\n   * Enhanced container management with health checks\n   */\n  static async restartContainer(): Promise<void> {\n    if (this.container) {\n      await this.container.stop();\n      this.container = null as any;\n    }\n    await this.startContainer();\n  }\n\n  /**\n   * Performance monitoring for test database operations\n   */\n  static async measureDatabasePerformance<T>(\n    operation: () => Promise<T>,\n    operationName: string,\n  ): Promise<{ result: T; duration: number; memoryUsage: number }> {\n    const startTime = Date.now();\n    const startMemory = process.memoryUsage().heapUsed;\n\n    try {\n      const result = await operation();\n      const endTime = Date.now();\n      const endMemory = process.memoryUsage().heapUsed;\n\n      const performance = {\n        result,\n        duration: endTime - startTime,\n        memoryUsage: endMemory - startMemory,\n      };\n\n      if (process.env.TRACK_TEST_PERFORMANCE === 'true') {\n        console.log(`üìä ${operationName} Performance:\n          ‚è±Ô∏è  Duration: ${performance.duration}ms\n          üß† Memory: ${(performance.memoryUsage / 1024 / 1024).toFixed(2)}MB\n        `);\n      }\n\n      return performance;\n    } catch (error) {\n      const endTime = Date.now();\n      console.error(\n        `‚ùå ${operationName} failed after ${endTime - startTime}ms:`,\n        error,\n      );\n      throw error;\n    }\n  }\n}\n"],"version":3}