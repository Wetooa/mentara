7588b643b60bd11d15f6e1f39e18690e
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var __param = (this && this.__param) || function (paramIndex, decorator) {
    return function (target, key) { decorator(target, key, paramIndex); }
};
var _a, _b;
Object.defineProperty(exports, "__esModule", { value: true });
exports.BillingController = void 0;
const common_1 = require("@nestjs/common");
const billing_service_1 = require("./billing.service");
const jwt_auth_guard_1 = require("src/auth/guards/jwt-auth.guard");
const current_user_id_decorator_1 = require("src/auth/decorators/current-user-id.decorator");
const current_user_role_decorator_1 = require("src/auth/decorators/current-user-role.decorator");
const client_1 = require("@prisma/client");
/**
 * Educational Billing Controller for Mental Health Platform
 *
 * Simplified payment processing endpoints suitable for a school project.
 * Focuses on therapy session payments without complex billing features.
 */
let BillingController = class BillingController {
    billingService;
    constructor(billingService) {
        this.billingService = billingService;
    }
    // ===== PAYMENT METHODS =====
    async createPaymentMethod(body, userId) {
        return this.billingService.createPaymentMethod({
            ...body,
            userId,
        });
    }
    getUserPaymentMethods(userId) {
        return this.billingService.getUserPaymentMethods(userId);
    }
    updatePaymentMethod(id, body) {
        return this.billingService.updatePaymentMethod(id, body);
    }
    deletePaymentMethod(id) {
        return this.billingService.deletePaymentMethod(id);
    }
    // ===== PAYMENT PROCESSING =====
    async processSessionPayment(body, clientId) {
        if (body.amount <= 0) {
            throw new common_1.BadRequestException('Payment amount must be greater than 0');
        }
        return this.billingService.processSessionPayment({
            ...body,
            clientId,
        });
    }
    getPayment(id) {
        return this.billingService.getPayment(id);
    }
    getUserPayments(userId, role, status, limit, offset) {
        return this.billingService.getUserPayments(userId, {
            role,
            status,
            limit: limit ? Number(limit) : undefined,
            offset: offset ? Number(offset) : undefined,
        });
    }
    retryPayment(paymentId) {
        return this.billingService.retryPayment(paymentId);
    }
    // ===== ANALYTICS & REPORTING =====
    getTherapistAnalytics(userId, userRole, startDate, endDate) {
        // Only allow therapists to access their own analytics
        if (userRole !== 'therapist' && userRole !== 'admin') {
            throw new common_1.UnauthorizedException('Only therapists can access payment analytics');
        }
        return this.billingService.getTherapistPaymentStats(userId, startDate ? new Date(startDate) : undefined, endDate ? new Date(endDate) : undefined);
    }
    getPlatformAnalytics(userRole, startDate, endDate) {
        if (userRole !== 'admin') {
            throw new common_1.UnauthorizedException('Admin access required');
        }
        return this.billingService.getPlatformStats(startDate ? new Date(startDate) : undefined, endDate ? new Date(endDate) : undefined);
    }
};
exports.BillingController = BillingController;
__decorate([
    (0, common_1.Post)('payment-methods'),
    __param(0, (0, common_1.Body)()),
    __param(1, (0, current_user_id_decorator_1.CurrentUserId)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Object, String]),
    __metadata("design:returntype", Promise)
], BillingController.prototype, "createPaymentMethod", null);
__decorate([
    (0, common_1.Get)('payment-methods'),
    __param(0, (0, current_user_id_decorator_1.CurrentUserId)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [String]),
    __metadata("design:returntype", void 0)
], BillingController.prototype, "getUserPaymentMethods", null);
__decorate([
    (0, common_1.Patch)('payment-methods/:id'),
    __param(0, (0, common_1.Param)('id')),
    __param(1, (0, common_1.Body)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [String, Object]),
    __metadata("design:returntype", void 0)
], BillingController.prototype, "updatePaymentMethod", null);
__decorate([
    (0, common_1.Delete)('payment-methods/:id'),
    __param(0, (0, common_1.Param)('id')),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [String]),
    __metadata("design:returntype", void 0)
], BillingController.prototype, "deletePaymentMethod", null);
__decorate([
    (0, common_1.Post)('payments/session'),
    __param(0, (0, common_1.Body)()),
    __param(1, (0, current_user_id_decorator_1.CurrentUserId)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Object, String]),
    __metadata("design:returntype", Promise)
], BillingController.prototype, "processSessionPayment", null);
__decorate([
    (0, common_1.Get)('payments/:id'),
    __param(0, (0, common_1.Param)('id')),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [String]),
    __metadata("design:returntype", void 0)
], BillingController.prototype, "getPayment", null);
__decorate([
    (0, common_1.Get)('payments'),
    __param(0, (0, current_user_id_decorator_1.CurrentUserId)()),
    __param(1, (0, common_1.Query)('role')),
    __param(2, (0, common_1.Query)('status')),
    __param(3, (0, common_1.Query)('limit')),
    __param(4, (0, common_1.Query)('offset')),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [String, String, typeof (_b = typeof client_1.PaymentStatus !== "undefined" && client_1.PaymentStatus) === "function" ? _b : Object, Number, Number]),
    __metadata("design:returntype", void 0)
], BillingController.prototype, "getUserPayments", null);
__decorate([
    (0, common_1.Post)('payments/:id/retry'),
    __param(0, (0, common_1.Param)('id')),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [String]),
    __metadata("design:returntype", void 0)
], BillingController.prototype, "retryPayment", null);
__decorate([
    (0, common_1.Get)('analytics/therapist'),
    __param(0, (0, current_user_id_decorator_1.CurrentUserId)()),
    __param(1, (0, current_user_role_decorator_1.CurrentUserRole)()),
    __param(2, (0, common_1.Query)('startDate')),
    __param(3, (0, common_1.Query)('endDate')),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [String, String, String, String]),
    __metadata("design:returntype", void 0)
], BillingController.prototype, "getTherapistAnalytics", null);
__decorate([
    (0, common_1.Get)('analytics/platform'),
    __param(0, (0, current_user_role_decorator_1.CurrentUserRole)()),
    __param(1, (0, common_1.Query)('startDate')),
    __param(2, (0, common_1.Query)('endDate')),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [String, String, String]),
    __metadata("design:returntype", void 0)
], BillingController.prototype, "getPlatformAnalytics", null);
exports.BillingController = BillingController = __decorate([
    (0, common_1.Controller)('billing'),
    (0, common_1.UseGuards)(jwt_auth_guard_1.JwtAuthGuard),
    __metadata("design:paramtypes", [typeof (_a = typeof billing_service_1.BillingService !== "undefined" && billing_service_1.BillingService) === "function" ? _a : Object])
], BillingController);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL2JpbGxpbmcvYmlsbGluZy5jb250cm9sbGVyLnRzIiwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQSwyQ0FZd0I7QUFDeEIsdURBQW1EO0FBQ25ELG1FQUE4RDtBQUM5RCw2RkFBOEU7QUFDOUUsaUdBQWtGO0FBQ2xGLDJDQUErQztBQU8vQzs7Ozs7R0FLRztBQUdJLElBQU0saUJBQWlCLEdBQXZCLE1BQU0saUJBQWlCO0lBQ0M7SUFBN0IsWUFBNkIsY0FBOEI7UUFBOUIsbUJBQWMsR0FBZCxjQUFjLENBQWdCO0lBQUcsQ0FBQztJQUUvRCw4QkFBOEI7SUFHeEIsQUFBTixLQUFLLENBQUMsbUJBQW1CLENBQ2YsSUFBNEIsRUFDbkIsTUFBYztRQUUvQixPQUFPLElBQUksQ0FBQyxjQUFjLENBQUMsbUJBQW1CLENBQUM7WUFDN0MsR0FBRyxJQUFJO1lBQ1AsTUFBTTtTQUNQLENBQUMsQ0FBQztJQUNMLENBQUM7SUFHRCxxQkFBcUIsQ0FBa0IsTUFBYztRQUNuRCxPQUFPLElBQUksQ0FBQyxjQUFjLENBQUMscUJBQXFCLENBQUMsTUFBTSxDQUFDLENBQUM7SUFDM0QsQ0FBQztJQUdELG1CQUFtQixDQUNKLEVBQVUsRUFDZixJQUE0QjtRQUVwQyxPQUFPLElBQUksQ0FBQyxjQUFjLENBQUMsbUJBQW1CLENBQUMsRUFBRSxFQUFFLElBQUksQ0FBQyxDQUFDO0lBQzNELENBQUM7SUFHRCxtQkFBbUIsQ0FBYyxFQUFVO1FBQ3pDLE9BQU8sSUFBSSxDQUFDLGNBQWMsQ0FBQyxtQkFBbUIsQ0FBQyxFQUFFLENBQUMsQ0FBQztJQUNyRCxDQUFDO0lBRUQsaUNBQWlDO0lBRzNCLEFBQU4sS0FBSyxDQUFDLHFCQUFxQixDQUNqQixJQUE4QixFQUNyQixRQUFnQjtRQUVqQyxJQUFJLElBQUksQ0FBQyxNQUFNLElBQUksQ0FBQyxFQUFFLENBQUM7WUFDckIsTUFBTSxJQUFJLDRCQUFtQixDQUFDLHVDQUF1QyxDQUFDLENBQUM7UUFDekUsQ0FBQztRQUVELE9BQU8sSUFBSSxDQUFDLGNBQWMsQ0FBQyxxQkFBcUIsQ0FBQztZQUMvQyxHQUFHLElBQUk7WUFDUCxRQUFRO1NBQ1QsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUdELFVBQVUsQ0FBYyxFQUFVO1FBQ2hDLE9BQU8sSUFBSSxDQUFDLGNBQWMsQ0FBQyxVQUFVLENBQUMsRUFBRSxDQUFDLENBQUM7SUFDNUMsQ0FBQztJQUdELGVBQWUsQ0FDSSxNQUFjLEVBQ2hCLElBQTZCLEVBQzNCLE1BQXNCLEVBQ3ZCLEtBQWMsRUFDYixNQUFlO1FBRWhDLE9BQU8sSUFBSSxDQUFDLGNBQWMsQ0FBQyxlQUFlLENBQUMsTUFBTSxFQUFFO1lBQ2pELElBQUk7WUFDSixNQUFNO1lBQ04sS0FBSyxFQUFFLEtBQUssQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxTQUFTO1lBQ3hDLE1BQU0sRUFBRSxNQUFNLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsU0FBUztTQUM1QyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBR0QsWUFBWSxDQUFjLFNBQWlCO1FBQ3pDLE9BQU8sSUFBSSxDQUFDLGNBQWMsQ0FBQyxZQUFZLENBQUMsU0FBUyxDQUFDLENBQUM7SUFDckQsQ0FBQztJQUVELG9DQUFvQztJQUdwQyxxQkFBcUIsQ0FDRixNQUFjLEVBQ1osUUFBZ0IsRUFDZixTQUFrQixFQUNwQixPQUFnQjtRQUVsQyxzREFBc0Q7UUFDdEQsSUFBSSxRQUFRLEtBQUssV0FBVyxJQUFJLFFBQVEsS0FBSyxPQUFPLEVBQUUsQ0FBQztZQUNyRCxNQUFNLElBQUksOEJBQXFCLENBQzdCLDhDQUE4QyxDQUMvQyxDQUFDO1FBQ0osQ0FBQztRQUVELE9BQU8sSUFBSSxDQUFDLGNBQWMsQ0FBQyx3QkFBd0IsQ0FDakQsTUFBTSxFQUNOLFNBQVMsQ0FBQyxDQUFDLENBQUMsSUFBSSxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDLFNBQVMsRUFDM0MsT0FBTyxDQUFDLENBQUMsQ0FBQyxJQUFJLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUN4QyxDQUFDO0lBQ0osQ0FBQztJQUdELG9CQUFvQixDQUVsQixRQUFnQixFQUNJLFNBQWtCLEVBQ3BCLE9BQWdCO1FBRWxDLElBQUksUUFBUSxLQUFLLE9BQU8sRUFBRSxDQUFDO1lBQ3pCLE1BQU0sSUFBSSw4QkFBcUIsQ0FBQyx1QkFBdUIsQ0FBQyxDQUFDO1FBQzNELENBQUM7UUFFRCxPQUFPLElBQUksQ0FBQyxjQUFjLENBQUMsZ0JBQWdCLENBQ3pDLFNBQVMsQ0FBQyxDQUFDLENBQUMsSUFBSSxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDLFNBQVMsRUFDM0MsT0FBTyxDQUFDLENBQUMsQ0FBQyxJQUFJLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUN4QyxDQUFDO0lBQ0osQ0FBQztDQUNGLENBQUE7QUFwSFksOENBQWlCO0FBTXRCO0lBREwsSUFBQSxhQUFJLEVBQUMsaUJBQWlCLENBQUM7SUFFckIsV0FBQSxJQUFBLGFBQUksR0FBRSxDQUFBO0lBQ04sV0FBQSxJQUFBLHlDQUFhLEdBQUUsQ0FBQTs7Ozs0REFNakI7QUFHRDtJQURDLElBQUEsWUFBRyxFQUFDLGlCQUFpQixDQUFDO0lBQ0EsV0FBQSxJQUFBLHlDQUFhLEdBQUUsQ0FBQTs7Ozs4REFFckM7QUFHRDtJQURDLElBQUEsY0FBSyxFQUFDLHFCQUFxQixDQUFDO0lBRTFCLFdBQUEsSUFBQSxjQUFLLEVBQUMsSUFBSSxDQUFDLENBQUE7SUFDWCxXQUFBLElBQUEsYUFBSSxHQUFFLENBQUE7Ozs7NERBR1I7QUFHRDtJQURDLElBQUEsZUFBTSxFQUFDLHFCQUFxQixDQUFDO0lBQ1QsV0FBQSxJQUFBLGNBQUssRUFBQyxJQUFJLENBQUMsQ0FBQTs7Ozs0REFFL0I7QUFLSztJQURMLElBQUEsYUFBSSxFQUFDLGtCQUFrQixDQUFDO0lBRXRCLFdBQUEsSUFBQSxhQUFJLEdBQUUsQ0FBQTtJQUNOLFdBQUEsSUFBQSx5Q0FBYSxHQUFFLENBQUE7Ozs7OERBVWpCO0FBR0Q7SUFEQyxJQUFBLFlBQUcsRUFBQyxjQUFjLENBQUM7SUFDUixXQUFBLElBQUEsY0FBSyxFQUFDLElBQUksQ0FBQyxDQUFBOzs7O21EQUV0QjtBQUdEO0lBREMsSUFBQSxZQUFHLEVBQUMsVUFBVSxDQUFDO0lBRWIsV0FBQSxJQUFBLHlDQUFhLEdBQUUsQ0FBQTtJQUNmLFdBQUEsSUFBQSxjQUFLLEVBQUMsTUFBTSxDQUFDLENBQUE7SUFDYixXQUFBLElBQUEsY0FBSyxFQUFDLFFBQVEsQ0FBQyxDQUFBO0lBQ2YsV0FBQSxJQUFBLGNBQUssRUFBQyxPQUFPLENBQUMsQ0FBQTtJQUNkLFdBQUEsSUFBQSxjQUFLLEVBQUMsUUFBUSxDQUFDLENBQUE7O3lFQUZVLHNCQUFhLG9CQUFiLHNCQUFhOzt3REFVeEM7QUFHRDtJQURDLElBQUEsYUFBSSxFQUFDLG9CQUFvQixDQUFDO0lBQ2IsV0FBQSxJQUFBLGNBQUssRUFBQyxJQUFJLENBQUMsQ0FBQTs7OztxREFFeEI7QUFLRDtJQURDLElBQUEsWUFBRyxFQUFDLHFCQUFxQixDQUFDO0lBRXhCLFdBQUEsSUFBQSx5Q0FBYSxHQUFFLENBQUE7SUFDZixXQUFBLElBQUEsNkNBQWUsR0FBRSxDQUFBO0lBQ2pCLFdBQUEsSUFBQSxjQUFLLEVBQUMsV0FBVyxDQUFDLENBQUE7SUFDbEIsV0FBQSxJQUFBLGNBQUssRUFBQyxTQUFTLENBQUMsQ0FBQTs7Ozs4REFjbEI7QUFHRDtJQURDLElBQUEsWUFBRyxFQUFDLG9CQUFvQixDQUFDO0lBRXZCLFdBQUEsSUFBQSw2Q0FBZSxHQUFFLENBQUE7SUFFakIsV0FBQSxJQUFBLGNBQUssRUFBQyxXQUFXLENBQUMsQ0FBQTtJQUNsQixXQUFBLElBQUEsY0FBSyxFQUFDLFNBQVMsQ0FBQyxDQUFBOzs7OzZEQVVsQjs0QkFuSFUsaUJBQWlCO0lBRjdCLElBQUEsbUJBQVUsRUFBQyxTQUFTLENBQUM7SUFDckIsSUFBQSxrQkFBUyxFQUFDLDZCQUFZLENBQUM7eURBRXVCLGdDQUFjLG9CQUFkLGdDQUFjO0dBRGhELGlCQUFpQixDQW9IN0IiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL2JpbGxpbmcvYmlsbGluZy5jb250cm9sbGVyLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIENvbnRyb2xsZXIsXG4gIEdldCxcbiAgUG9zdCxcbiAgQm9keSxcbiAgUGF0Y2gsXG4gIFBhcmFtLFxuICBRdWVyeSxcbiAgVXNlR3VhcmRzLFxuICBEZWxldGUsXG4gIFVuYXV0aG9yaXplZEV4Y2VwdGlvbixcbiAgQmFkUmVxdWVzdEV4Y2VwdGlvbixcbn0gZnJvbSAnQG5lc3Rqcy9jb21tb24nO1xuaW1wb3J0IHsgQmlsbGluZ1NlcnZpY2UgfSBmcm9tICcuL2JpbGxpbmcuc2VydmljZSc7XG5pbXBvcnQgeyBKd3RBdXRoR3VhcmQgfSBmcm9tICdzcmMvYXV0aC9ndWFyZHMvand0LWF1dGguZ3VhcmQnO1xuaW1wb3J0IHsgQ3VycmVudFVzZXJJZCB9IGZyb20gJ3NyYy9hdXRoL2RlY29yYXRvcnMvY3VycmVudC11c2VyLWlkLmRlY29yYXRvcic7XG5pbXBvcnQgeyBDdXJyZW50VXNlclJvbGUgfSBmcm9tICdzcmMvYXV0aC9kZWNvcmF0b3JzL2N1cnJlbnQtdXNlci1yb2xlLmRlY29yYXRvcic7XG5pbXBvcnQgeyBQYXltZW50U3RhdHVzIH0gZnJvbSAnQHByaXNtYS9jbGllbnQnO1xuaW1wb3J0IHR5cGUge1xuICBDcmVhdGVQYXltZW50TWV0aG9kRHRvLFxuICBVcGRhdGVQYXltZW50TWV0aG9kRHRvLFxuICBQcm9jZXNzU2Vzc2lvblBheW1lbnREdG8sXG59IGZyb20gJy4vdHlwZXMnO1xuXG4vKipcbiAqIEVkdWNhdGlvbmFsIEJpbGxpbmcgQ29udHJvbGxlciBmb3IgTWVudGFsIEhlYWx0aCBQbGF0Zm9ybVxuICpcbiAqIFNpbXBsaWZpZWQgcGF5bWVudCBwcm9jZXNzaW5nIGVuZHBvaW50cyBzdWl0YWJsZSBmb3IgYSBzY2hvb2wgcHJvamVjdC5cbiAqIEZvY3VzZXMgb24gdGhlcmFweSBzZXNzaW9uIHBheW1lbnRzIHdpdGhvdXQgY29tcGxleCBiaWxsaW5nIGZlYXR1cmVzLlxuICovXG5AQ29udHJvbGxlcignYmlsbGluZycpXG5AVXNlR3VhcmRzKEp3dEF1dGhHdWFyZClcbmV4cG9ydCBjbGFzcyBCaWxsaW5nQ29udHJvbGxlciB7XG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgcmVhZG9ubHkgYmlsbGluZ1NlcnZpY2U6IEJpbGxpbmdTZXJ2aWNlKSB7fVxuXG4gIC8vID09PT09IFBBWU1FTlQgTUVUSE9EUyA9PT09PVxuXG4gIEBQb3N0KCdwYXltZW50LW1ldGhvZHMnKVxuICBhc3luYyBjcmVhdGVQYXltZW50TWV0aG9kKFxuICAgIEBCb2R5KCkgYm9keTogQ3JlYXRlUGF5bWVudE1ldGhvZER0byxcbiAgICBAQ3VycmVudFVzZXJJZCgpIHVzZXJJZDogc3RyaW5nLFxuICApIHtcbiAgICByZXR1cm4gdGhpcy5iaWxsaW5nU2VydmljZS5jcmVhdGVQYXltZW50TWV0aG9kKHtcbiAgICAgIC4uLmJvZHksXG4gICAgICB1c2VySWQsXG4gICAgfSk7XG4gIH1cblxuICBAR2V0KCdwYXltZW50LW1ldGhvZHMnKVxuICBnZXRVc2VyUGF5bWVudE1ldGhvZHMoQEN1cnJlbnRVc2VySWQoKSB1c2VySWQ6IHN0cmluZykge1xuICAgIHJldHVybiB0aGlzLmJpbGxpbmdTZXJ2aWNlLmdldFVzZXJQYXltZW50TWV0aG9kcyh1c2VySWQpO1xuICB9XG5cbiAgQFBhdGNoKCdwYXltZW50LW1ldGhvZHMvOmlkJylcbiAgdXBkYXRlUGF5bWVudE1ldGhvZChcbiAgICBAUGFyYW0oJ2lkJykgaWQ6IHN0cmluZyxcbiAgICBAQm9keSgpIGJvZHk6IFVwZGF0ZVBheW1lbnRNZXRob2REdG8sXG4gICkge1xuICAgIHJldHVybiB0aGlzLmJpbGxpbmdTZXJ2aWNlLnVwZGF0ZVBheW1lbnRNZXRob2QoaWQsIGJvZHkpO1xuICB9XG5cbiAgQERlbGV0ZSgncGF5bWVudC1tZXRob2RzLzppZCcpXG4gIGRlbGV0ZVBheW1lbnRNZXRob2QoQFBhcmFtKCdpZCcpIGlkOiBzdHJpbmcpIHtcbiAgICByZXR1cm4gdGhpcy5iaWxsaW5nU2VydmljZS5kZWxldGVQYXltZW50TWV0aG9kKGlkKTtcbiAgfVxuXG4gIC8vID09PT09IFBBWU1FTlQgUFJPQ0VTU0lORyA9PT09PVxuXG4gIEBQb3N0KCdwYXltZW50cy9zZXNzaW9uJylcbiAgYXN5bmMgcHJvY2Vzc1Nlc3Npb25QYXltZW50KFxuICAgIEBCb2R5KCkgYm9keTogUHJvY2Vzc1Nlc3Npb25QYXltZW50RHRvLFxuICAgIEBDdXJyZW50VXNlcklkKCkgY2xpZW50SWQ6IHN0cmluZyxcbiAgKSB7XG4gICAgaWYgKGJvZHkuYW1vdW50IDw9IDApIHtcbiAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0RXhjZXB0aW9uKCdQYXltZW50IGFtb3VudCBtdXN0IGJlIGdyZWF0ZXIgdGhhbiAwJyk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXMuYmlsbGluZ1NlcnZpY2UucHJvY2Vzc1Nlc3Npb25QYXltZW50KHtcbiAgICAgIC4uLmJvZHksXG4gICAgICBjbGllbnRJZCxcbiAgICB9KTtcbiAgfVxuXG4gIEBHZXQoJ3BheW1lbnRzLzppZCcpXG4gIGdldFBheW1lbnQoQFBhcmFtKCdpZCcpIGlkOiBzdHJpbmcpIHtcbiAgICByZXR1cm4gdGhpcy5iaWxsaW5nU2VydmljZS5nZXRQYXltZW50KGlkKTtcbiAgfVxuXG4gIEBHZXQoJ3BheW1lbnRzJylcbiAgZ2V0VXNlclBheW1lbnRzKFxuICAgIEBDdXJyZW50VXNlcklkKCkgdXNlcklkOiBzdHJpbmcsXG4gICAgQFF1ZXJ5KCdyb2xlJykgcm9sZT86ICdjbGllbnQnIHwgJ3RoZXJhcGlzdCcsXG4gICAgQFF1ZXJ5KCdzdGF0dXMnKSBzdGF0dXM/OiBQYXltZW50U3RhdHVzLFxuICAgIEBRdWVyeSgnbGltaXQnKSBsaW1pdD86IG51bWJlcixcbiAgICBAUXVlcnkoJ29mZnNldCcpIG9mZnNldD86IG51bWJlcixcbiAgKSB7XG4gICAgcmV0dXJuIHRoaXMuYmlsbGluZ1NlcnZpY2UuZ2V0VXNlclBheW1lbnRzKHVzZXJJZCwge1xuICAgICAgcm9sZSxcbiAgICAgIHN0YXR1cyxcbiAgICAgIGxpbWl0OiBsaW1pdCA/IE51bWJlcihsaW1pdCkgOiB1bmRlZmluZWQsXG4gICAgICBvZmZzZXQ6IG9mZnNldCA/IE51bWJlcihvZmZzZXQpIDogdW5kZWZpbmVkLFxuICAgIH0pO1xuICB9XG5cbiAgQFBvc3QoJ3BheW1lbnRzLzppZC9yZXRyeScpXG4gIHJldHJ5UGF5bWVudChAUGFyYW0oJ2lkJykgcGF5bWVudElkOiBzdHJpbmcpIHtcbiAgICByZXR1cm4gdGhpcy5iaWxsaW5nU2VydmljZS5yZXRyeVBheW1lbnQocGF5bWVudElkKTtcbiAgfVxuXG4gIC8vID09PT09IEFOQUxZVElDUyAmIFJFUE9SVElORyA9PT09PVxuXG4gIEBHZXQoJ2FuYWx5dGljcy90aGVyYXBpc3QnKVxuICBnZXRUaGVyYXBpc3RBbmFseXRpY3MoXG4gICAgQEN1cnJlbnRVc2VySWQoKSB1c2VySWQ6IHN0cmluZyxcbiAgICBAQ3VycmVudFVzZXJSb2xlKCkgdXNlclJvbGU6IHN0cmluZyxcbiAgICBAUXVlcnkoJ3N0YXJ0RGF0ZScpIHN0YXJ0RGF0ZT86IHN0cmluZyxcbiAgICBAUXVlcnkoJ2VuZERhdGUnKSBlbmREYXRlPzogc3RyaW5nLFxuICApIHtcbiAgICAvLyBPbmx5IGFsbG93IHRoZXJhcGlzdHMgdG8gYWNjZXNzIHRoZWlyIG93biBhbmFseXRpY3NcbiAgICBpZiAodXNlclJvbGUgIT09ICd0aGVyYXBpc3QnICYmIHVzZXJSb2xlICE9PSAnYWRtaW4nKSB7XG4gICAgICB0aHJvdyBuZXcgVW5hdXRob3JpemVkRXhjZXB0aW9uKFxuICAgICAgICAnT25seSB0aGVyYXBpc3RzIGNhbiBhY2Nlc3MgcGF5bWVudCBhbmFseXRpY3MnLFxuICAgICAgKTtcbiAgICB9XG5cbiAgICByZXR1cm4gdGhpcy5iaWxsaW5nU2VydmljZS5nZXRUaGVyYXBpc3RQYXltZW50U3RhdHMoXG4gICAgICB1c2VySWQsXG4gICAgICBzdGFydERhdGUgPyBuZXcgRGF0ZShzdGFydERhdGUpIDogdW5kZWZpbmVkLFxuICAgICAgZW5kRGF0ZSA/IG5ldyBEYXRlKGVuZERhdGUpIDogdW5kZWZpbmVkLFxuICAgICk7XG4gIH1cblxuICBAR2V0KCdhbmFseXRpY3MvcGxhdGZvcm0nKVxuICBnZXRQbGF0Zm9ybUFuYWx5dGljcyhcbiAgICBAQ3VycmVudFVzZXJSb2xlKClcbiAgICB1c2VyUm9sZTogc3RyaW5nLFxuICAgIEBRdWVyeSgnc3RhcnREYXRlJykgc3RhcnREYXRlPzogc3RyaW5nLFxuICAgIEBRdWVyeSgnZW5kRGF0ZScpIGVuZERhdGU/OiBzdHJpbmcsXG4gICkge1xuICAgIGlmICh1c2VyUm9sZSAhPT0gJ2FkbWluJykge1xuICAgICAgdGhyb3cgbmV3IFVuYXV0aG9yaXplZEV4Y2VwdGlvbignQWRtaW4gYWNjZXNzIHJlcXVpcmVkJyk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXMuYmlsbGluZ1NlcnZpY2UuZ2V0UGxhdGZvcm1TdGF0cyhcbiAgICAgIHN0YXJ0RGF0ZSA/IG5ldyBEYXRlKHN0YXJ0RGF0ZSkgOiB1bmRlZmluZWQsXG4gICAgICBlbmREYXRlID8gbmV3IERhdGUoZW5kRGF0ZSkgOiB1bmRlZmluZWQsXG4gICAgKTtcbiAgfVxufVxuIl0sInZlcnNpb24iOjN9