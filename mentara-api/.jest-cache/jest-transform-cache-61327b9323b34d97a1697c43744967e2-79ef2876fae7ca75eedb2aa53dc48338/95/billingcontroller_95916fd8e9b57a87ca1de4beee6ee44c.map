{"file":"/home/wetooa/Documents/code/projects/mentara/mentara-api/src/billing/billing.controller.ts","mappings":"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","names":[],"sources":["/home/wetooa/Documents/code/projects/mentara/mentara-api/src/billing/billing.controller.ts"],"sourcesContent":["import {\n  Controller,\n  Get,\n  Post,\n  Body,\n  Patch,\n  Param,\n  Query,\n  UseGuards,\n  Delete,\n  UnauthorizedException,\n  BadRequestException,\n} from '@nestjs/common';\nimport { BillingService } from './billing.service';\nimport { JwtAuthGuard } from 'src/auth/guards/jwt-auth.guard';\nimport { CurrentUserId } from 'src/auth/decorators/current-user-id.decorator';\nimport { CurrentUserRole } from 'src/auth/decorators/current-user-role.decorator';\nimport { PaymentStatus } from '@prisma/client';\nimport type {\n  CreatePaymentMethodDto,\n  UpdatePaymentMethodDto,\n  ProcessSessionPaymentDto,\n} from './types';\n\n/**\n * Educational Billing Controller for Mental Health Platform\n *\n * Simplified payment processing endpoints suitable for a school project.\n * Focuses on therapy session payments without complex billing features.\n */\n@Controller('billing')\n@UseGuards(JwtAuthGuard)\nexport class BillingController {\n  constructor(private readonly billingService: BillingService) {}\n\n  // ===== PAYMENT METHODS =====\n\n  @Post('payment-methods')\n  async createPaymentMethod(\n    @Body() body: CreatePaymentMethodDto,\n    @CurrentUserId() userId: string,\n  ) {\n    return this.billingService.createPaymentMethod({\n      ...body,\n      userId,\n    });\n  }\n\n  @Get('payment-methods')\n  getUserPaymentMethods(@CurrentUserId() userId: string) {\n    return this.billingService.getUserPaymentMethods(userId);\n  }\n\n  @Patch('payment-methods/:id')\n  updatePaymentMethod(\n    @Param('id') id: string,\n    @Body() body: UpdatePaymentMethodDto,\n  ) {\n    return this.billingService.updatePaymentMethod(id, body);\n  }\n\n  @Delete('payment-methods/:id')\n  deletePaymentMethod(@Param('id') id: string) {\n    return this.billingService.deletePaymentMethod(id);\n  }\n\n  // ===== PAYMENT PROCESSING =====\n\n  @Post('payments/session')\n  async processSessionPayment(\n    @Body() body: ProcessSessionPaymentDto,\n    @CurrentUserId() clientId: string,\n  ) {\n    if (body.amount <= 0) {\n      throw new BadRequestException('Payment amount must be greater than 0');\n    }\n\n    return this.billingService.processSessionPayment({\n      ...body,\n      clientId,\n    });\n  }\n\n  @Get('payments/:id')\n  getPayment(@Param('id') id: string) {\n    return this.billingService.getPayment(id);\n  }\n\n  @Get('payments')\n  getUserPayments(\n    @CurrentUserId() userId: string,\n    @Query('role') role?: 'client' | 'therapist',\n    @Query('status') status?: PaymentStatus,\n    @Query('limit') limit?: number,\n    @Query('offset') offset?: number,\n  ) {\n    return this.billingService.getUserPayments(userId, {\n      role,\n      status,\n      limit: limit ? Number(limit) : undefined,\n      offset: offset ? Number(offset) : undefined,\n    });\n  }\n\n  @Post('payments/:id/retry')\n  retryPayment(@Param('id') paymentId: string) {\n    return this.billingService.retryPayment(paymentId);\n  }\n\n  // ===== ANALYTICS & REPORTING =====\n\n  @Get('analytics/therapist')\n  getTherapistAnalytics(\n    @CurrentUserId() userId: string,\n    @CurrentUserRole() userRole: string,\n    @Query('startDate') startDate?: string,\n    @Query('endDate') endDate?: string,\n  ) {\n    // Only allow therapists to access their own analytics\n    if (userRole !== 'therapist' && userRole !== 'admin') {\n      throw new UnauthorizedException(\n        'Only therapists can access payment analytics',\n      );\n    }\n\n    return this.billingService.getTherapistPaymentStats(\n      userId,\n      startDate ? new Date(startDate) : undefined,\n      endDate ? new Date(endDate) : undefined,\n    );\n  }\n\n  @Get('analytics/platform')\n  getPlatformAnalytics(\n    @CurrentUserRole()\n    userRole: string,\n    @Query('startDate') startDate?: string,\n    @Query('endDate') endDate?: string,\n  ) {\n    if (userRole !== 'admin') {\n      throw new UnauthorizedException('Admin access required');\n    }\n\n    return this.billingService.getPlatformStats(\n      startDate ? new Date(startDate) : undefined,\n      endDate ? new Date(endDate) : undefined,\n    );\n  }\n}\n"],"version":3}