{"file":"/home/wetooa/Documents/code/projects/mentara/mentara-api/src/communities/communities.service.ts","mappings":"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","names":[],"sources":["/home/wetooa/Documents/code/projects/mentara/mentara-api/src/communities/communities.service.ts"],"sourcesContent":["import {\n  Injectable,\n  ConflictException,\n  NotFoundException,\n} from '@nestjs/common';\nimport { PrismaService } from 'src/providers/prisma-client.provider';\nimport { RoomGroup, Room } from '@prisma/client';\nimport {\n  CommunityCreateInputDto,\n  CommunityUpdateInputDto,\n} from 'mentara-commons';\n\n// Local response interfaces\ninterface CommunityResponse {\n  id: string;\n  name: string;\n  description: string;\n  slug: string;\n  imageUrl: string;\n  isPrivate?: boolean;\n  memberCount?: number;\n  createdAt: Date;\n  updatedAt: Date;\n}\n\ninterface CommunityStatsResponse {\n  memberCount?: number;\n  postCount?: number;\n  activeMembers?: number;\n  totalMembers?: number;\n  totalPosts?: number;\n  activeCommunities?: number;\n  illnessCommunities?: any[];\n}\n\ninterface CommunityWithMembersResponse extends CommunityResponse {\n  members: any[];\n}\n\ninterface CommunityWithRoomGroupsResponse extends CommunityResponse {\n  roomGroups: Array<{\n    id: string;\n    name: string;\n    order: number;\n    communityId: string;\n    rooms: Array<{\n      id: string;\n      name: string;\n      order: number;\n      postingRole: string;\n      roomGroupId: string;\n    }>;\n  }>;\n}\n\n@Injectable()\nexport class CommunitiesService {\n  constructor(private readonly prisma: PrismaService) {}\n\n  async findAllWithStructure(): Promise<CommunityWithRoomGroupsResponse[]> {\n    return await this.prisma.community.findMany({\n      orderBy: { createdAt: 'desc' },\n      include: {\n        roomGroups: {\n          include: {\n            rooms: true,\n          },\n        },\n      },\n    });\n  }\n\n  async findOneWithStructure(\n    id: string,\n  ): Promise<CommunityWithRoomGroupsResponse | null> {\n    return await this.prisma.community.findUniqueOrThrow({\n      where: { id },\n      include: {\n        roomGroups: {\n          include: {\n            rooms: true,\n          },\n        },\n      },\n    });\n  }\n\n  async createRoomGroup(\n    communityId: string,\n    name: string,\n    order: number,\n  ): Promise<RoomGroup> {\n    try {\n      return await this.prisma.roomGroup.create({\n        data: {\n          name,\n          order,\n          community: {\n            connect: {\n              id: communityId,\n            },\n          },\n        },\n      });\n    } catch (error) {\n      throw new ConflictException(\n        error instanceof Error ? error.message : String(error),\n      );\n    }\n  }\n\n  async createRoom(\n    roomGroupId: string,\n    name: string,\n    order: number,\n  ): Promise<Room> {\n    return await this.prisma.room.create({\n      data: {\n        name,\n        order,\n        roomGroupId,\n      },\n    });\n  }\n\n  async findRoomsByGroup(roomGroupId: string): Promise<Room[]> {\n    return await this.prisma.room.findMany({\n      where: { roomGroupId },\n      orderBy: { order: 'asc' },\n    });\n  }\n\n  async findAll(): Promise<CommunityResponse[]> {\n    const communities = await this.prisma.community.findMany({\n      orderBy: { createdAt: 'desc' },\n    });\n\n    return communities.map((community) => community);\n  }\n\n  async findOne(id: string): Promise<CommunityResponse | null> {\n    const community = await this.prisma.community.findUnique({\n      where: { id },\n    });\n    if (!community) return null;\n    return community;\n  }\n\n  async findBySlug(slug: string): Promise<CommunityResponse | null> {\n    const community = await this.prisma.community.findUnique({\n      where: { slug },\n    });\n    if (!community) return null;\n    return community;\n  }\n\n  async createCommunity(\n    data: CommunityCreateInputDto,\n  ): Promise<CommunityResponse> {\n    const community = await this.prisma.community.create({\n      data: {\n        name: data.name,\n        slug:\n          (data as any).slug ||\n          data.name?.toLowerCase().replace(/\\s+/g, '-') ||\n          'untitled',\n        description: data.description,\n        imageUrl: (data as any).imageUrl || null,\n      },\n    });\n    return community;\n  }\n\n  async update(\n    id: string,\n    data: CommunityUpdateInputDto,\n  ): Promise<CommunityResponse> {\n    const community = await this.prisma.community.update({\n      where: { id },\n      data: {\n        name: data.name,\n        slug:\n          (data as any).slug ||\n          data.name?.toLowerCase().replace(/\\s+/g, '-') ||\n          'untitled',\n        description: data.description,\n        imageUrl: (data as any).imageUrl || null,\n      },\n    });\n    return community;\n  }\n\n  async remove(id: string): Promise<CommunityResponse> {\n    const community = await this.prisma.community.delete({\n      where: { id },\n    });\n    return community;\n  }\n\n  async findByUserId(userId: string): Promise<CommunityResponse[]> {\n    const memberships = await this.prisma.membership.findMany({\n      where: { userId },\n      include: {\n        community: true,\n      },\n    });\n    return memberships.map((membership) => membership.community);\n  }\n\n  async joinCommunity(\n    communityId: string,\n    userId: string,\n    role: string = 'member',\n  ): Promise<void> {\n    const existingMembership = await this.prisma.membership.findFirst({\n      where: {\n        communityId,\n        userId,\n      },\n    });\n\n    if (existingMembership) {\n      throw new ConflictException('User is already a member of this community');\n    }\n\n    await this.prisma.membership.create({\n      data: {\n        userId,\n        communityId,\n        role,\n      },\n    });\n  }\n\n  async leaveCommunity(communityId: string, userId: string): Promise<void> {\n    const membership = await this.prisma.membership.findFirstOrThrow({\n      where: {\n        communityId,\n        userId,\n      },\n    });\n    await this.prisma.membership.delete({\n      where: { id: membership.id },\n    });\n  }\n\n  async getMembers(\n    communityId: string,\n    limit: number = 50,\n    offset: number = 0,\n  ): Promise<CommunityWithMembersResponse> {\n    const community = await this.prisma.community.findUnique({\n      where: { id: communityId },\n      include: {\n        memberships: {\n          skip: offset,\n          take: limit,\n          include: {\n            user: {\n              select: {\n                id: true,\n                firstName: true,\n                lastName: true,\n                avatarUrl: true,\n              },\n            },\n          },\n          orderBy: { joinedAt: 'desc' },\n        },\n      },\n    });\n    if (!community) {\n      throw new NotFoundException('Community not found');\n    }\n    return {\n      ...community,\n      members: community.memberships\n        .filter(\n          (membership) =>\n            membership.userId !== null && membership.user !== null,\n        )\n        .map((membership) => ({\n          ...membership,\n          userId: membership.userId!,\n          user: membership.user!,\n        })),\n    };\n  }\n\n  async getStats(): Promise<CommunityStatsResponse> {\n    const [totalMembers, totalPosts, activeCommunities] = await Promise.all([\n      this.prisma.membership.count(),\n      this.prisma.post.count(),\n      this.prisma.community.count(),\n    ]);\n\n    return {\n      totalMembers,\n      totalPosts,\n      activeCommunities,\n      illnessCommunities: [],\n    };\n  }\n}\n"],"version":3}