{"file":"/home/wetooa/Documents/code/projects/mentara/mentara-api/src/reviews/reviews.service.ts","mappings":"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","names":[],"sources":["/home/wetooa/Documents/code/projects/mentara/mentara-api/src/reviews/reviews.service.ts"],"sourcesContent":["import {\n  Injectable,\n  ForbiddenException,\n  NotFoundException,\n  BadRequestException,\n} from '@nestjs/common';\nimport { MeetingStatus, ReviewStatus } from '@prisma/client';\nimport { PrismaService } from '../providers/prisma-client.provider';\nimport {\n  CreateReviewDto,\n  UpdateReviewDto,\n  GetReviewsDto,\n  ModerateReviewDto,\n  ReviewListResponse,\n  ReviewStats,\n} from 'mentara-commons';\n\n@Injectable()\nexport class ReviewsService {\n  constructor(private readonly prisma: PrismaService) {}\n\n  async createReview(\n    meetingId: string,\n    clientId: string,\n    therapistId: string,\n    createReviewDto: CreateReviewDto,\n  ) {\n    const { rating, title, content, isAnonymous } = createReviewDto;\n\n    // Verify the client has had a completed session with this therapist\n    const completedMeeting = await this.prisma.meeting.findFirst({\n      where: {\n        clientId,\n        therapistId,\n        id: meetingId,\n        status: MeetingStatus.COMPLETED,\n      },\n    });\n\n    if (!completedMeeting) {\n      throw new BadRequestException(\n        'You can only review therapists after completing a session with them',\n      );\n    }\n\n    // Check if review already exists for this client-therapist pair\n    const existingReview = await this.prisma.review.findFirst({\n      where: {\n        clientId,\n        therapistId,\n        meetingId: meetingId,\n      },\n    });\n\n    if (existingReview) {\n      throw new BadRequestException(\n        'You have already reviewed this therapist for this session',\n      );\n    }\n\n    // Create the review\n    const review = await this.prisma.review.create({\n      data: {\n        rating,\n        title,\n        content,\n        isAnonymous,\n        clientId,\n        therapistId,\n        meetingId: meetingId,\n        status: ReviewStatus.PENDING,\n      },\n      include: {\n        client: {\n          select: {\n            user: {\n              select: {\n                firstName: true,\n                lastName: true,\n                avatarUrl: true,\n              },\n            },\n          },\n        },\n        therapist: {\n          select: {\n            user: true,\n          },\n        },\n        meeting: {\n          select: {\n            startTime: true,\n            duration: true,\n          },\n        },\n      },\n    });\n\n    return {\n      ...review,\n      therapist: {\n        ...review.therapist,\n        id: review.therapistId,\n      },\n    };\n  }\n\n  async updateReview(\n    reviewId: string,\n    clientId: string,\n    updateReviewDto: UpdateReviewDto,\n  ) {\n    const review = await this.prisma.review.findUnique({\n      where: { id: reviewId },\n    });\n\n    if (!review) {\n      throw new NotFoundException('Review not found');\n    }\n\n    if (review.clientId !== clientId) {\n      throw new ForbiddenException('You can only update your own reviews');\n    }\n\n    const updatedReview = await this.prisma.review.update({\n      where: { id: reviewId },\n      data: {\n        ...updateReviewDto,\n        status: ReviewStatus.PENDING, // Reset to pending for re-moderation\n        updatedAt: new Date(),\n      },\n      include: {\n        client: {\n          select: {\n            user: {\n              select: {\n                firstName: true,\n                lastName: true,\n                avatarUrl: true,\n              },\n            },\n          },\n        },\n        therapist: {\n          select: {\n            user: {\n              select: {\n                firstName: true,\n                lastName: true,\n              },\n            },\n          },\n        },\n        meeting: {\n          select: {\n            startTime: true,\n            duration: true,\n          },\n        },\n      },\n    });\n\n    return updatedReview;\n  }\n\n  async deleteReview(reviewId: string, clientId: string) {\n    const review = await this.prisma.review.findUnique({\n      where: { id: reviewId },\n    });\n\n    if (!review) {\n      throw new NotFoundException('Review not found');\n    }\n\n    if (review.clientId !== clientId) {\n      throw new ForbiddenException('You can only delete your own reviews');\n    }\n\n    await this.prisma.review.delete({\n      where: { id: reviewId },\n    });\n\n    return { message: 'Review deleted successfully' };\n  }\n\n  async getReviews(query: GetReviewsDto): Promise<ReviewListResponse> {\n    const {\n      page = 1,\n      limit = 10,\n      sortBy = 'createdAt',\n      sortOrder = 'desc',\n      therapistId,\n      clientId,\n      status,\n      rating,\n    } = query;\n\n    const skip = (page - 1) * limit;\n\n    const where: any = {\n      status: status || ReviewStatus.APPROVED, // Only show approved reviews by default\n    };\n\n    if (therapistId) where.therapistId = therapistId;\n    if (clientId) where.clientId = clientId;\n    if (rating) where.rating = rating;\n\n    const [reviews, totalCount] = await Promise.all([\n      this.prisma.review.findMany({\n        where,\n        skip,\n        take: limit,\n        orderBy: { [sortBy]: sortOrder },\n        include: {\n          client: {\n            select: {\n              user: {\n                select: {\n                  firstName: true,\n                  lastName: true,\n                  avatarUrl: true,\n                },\n              },\n            },\n          },\n          therapist: {\n            select: {\n              user: {\n                select: {\n                  firstName: true,\n                  lastName: true,\n                },\n              },\n            },\n          },\n          meeting: {\n            select: {\n              startTime: true,\n              duration: true,\n            },\n          },\n          helpfulVotes: true,\n        },\n      }),\n      this.prisma.review.count({ where }),\n    ]);\n\n    const totalPages = Math.ceil(totalCount / limit);\n\n    // Calculate average rating for the result set\n    const averageRating =\n      reviews.length > 0\n        ? reviews.reduce((sum, review) => sum + review.rating, 0) /\n          reviews.length\n        : 0;\n\n    // Calculate rating distribution\n    const ratingDistribution = reviews.reduce(\n      (dist, review) => {\n        dist[review.rating.toString()] =\n          (dist[review.rating.toString()] || 0) + 1;\n        return dist;\n      },\n      { '1': 0, '2': 0, '3': 0, '4': 0, '5': 0 },\n    );\n\n    return {\n      reviews: reviews.map((review) => ({\n        id: review.id,\n        rating: review.rating,\n        title: review.title || undefined,\n        content: review.content || undefined,\n        therapistId: review.therapistId,\n        clientId: review.clientId,\n        meetingId: review.meetingId || undefined,\n        isAnonymous: review.isAnonymous,\n        status: review.status,\n        helpfulCount: review.helpfulVotes?.length || 0,\n        createdAt: review.createdAt.toISOString(),\n        updatedAt: review.updatedAt.toISOString(),\n        moderationNote: review.moderationNote || undefined,\n        client: review.client\n          ? {\n              id: review.clientId,\n              firstName: review.client.user?.firstName,\n              lastName: review.client.user?.lastName,\n            }\n          : undefined,\n        therapist: review.therapist\n          ? {\n              id: review.therapistId,\n              firstName: review.therapist.user?.firstName || '',\n              lastName: review.therapist.user?.lastName || '',\n            }\n          : undefined,\n      })),\n      totalCount,\n      page,\n      pageSize: limit,\n      totalPages,\n      averageRating,\n      ratingDistribution,\n    };\n  }\n\n  async getTherapistReviews(\n    therapistId: string,\n    query: Omit<GetReviewsDto, 'therapistId'>,\n  ): Promise<ReviewListResponse> {\n    return this.getReviews({ ...query, therapistId });\n  }\n\n  async getReviewStats(therapistId: string): Promise<ReviewStats> {\n    const stats = await this.prisma.review.groupBy({\n      by: ['rating'],\n      where: {\n        therapistId,\n        status: ReviewStatus.APPROVED,\n      },\n      _count: {\n        rating: true,\n      },\n    });\n\n    const totalReviews = stats.reduce(\n      (sum, stat) => sum + stat._count.rating,\n      0,\n    );\n    const totalRating = stats.reduce(\n      (sum, stat) => sum + stat.rating * stat._count.rating,\n      0,\n    );\n    const averageRating = totalReviews > 0 ? totalRating / totalReviews : 0;\n\n    const ratingDistribution = {\n      '1': 0,\n      '2': 0,\n      '3': 0,\n      '4': 0,\n      '5': 0,\n    };\n\n    stats.forEach((stat) => {\n      ratingDistribution[stat.rating.toString()] = stat._count.rating;\n    });\n\n    // Get monthly reviews for the last 12 months\n    const twelveMonthsAgo = new Date();\n    twelveMonthsAgo.setMonth(twelveMonthsAgo.getMonth() - 12);\n\n    const monthlyStats = await this.prisma.review.groupBy({\n      by: ['createdAt'],\n      where: {\n        therapistId,\n        status: ReviewStatus.APPROVED,\n        createdAt: {\n          gte: twelveMonthsAgo,\n        },\n      },\n      _count: {\n        rating: true,\n      },\n      _avg: {\n        rating: true,\n      },\n    });\n\n    // Group by month\n    const monthlyReviews = monthlyStats.reduce(\n      (acc, stat) => {\n        const month = stat.createdAt.toISOString().substring(0, 7); // YYYY-MM format\n        if (!acc[month]) {\n          acc[month] = { count: 0, totalRating: 0 };\n        }\n        acc[month].count += stat._count.rating;\n        acc[month].totalRating += (stat._avg.rating || 0) * stat._count.rating;\n        return acc;\n      },\n      {} as Record<string, { count: number; totalRating: number }>,\n    );\n\n    const monthlyReviewsArray = Object.entries(monthlyReviews).map(\n      ([month, data]) => ({\n        month,\n        count: data.count,\n        averageRating: data.count > 0 ? data.totalRating / data.count : 0,\n      }),\n    );\n\n    // Get recent reviews\n    const recentReviews = await this.prisma.review.findMany({\n      where: {\n        therapistId,\n        status: ReviewStatus.APPROVED,\n      },\n      orderBy: {\n        createdAt: 'desc',\n      },\n      take: 5,\n      include: {\n        client: {\n          select: {\n            user: {\n              select: {\n                firstName: true,\n                lastName: true,\n              },\n            },\n          },\n        },\n        helpfulVotes: true,\n      },\n    });\n\n    return {\n      totalReviews,\n      averageRating: Math.round(averageRating * 100) / 100,\n      ratingDistribution,\n      monthlyReviews: monthlyReviewsArray,\n      recentReviews: recentReviews.map((review) => ({\n        id: review.id,\n        rating: review.rating,\n        title: review.title || undefined,\n        content: review.content || undefined,\n        therapistId: review.therapistId,\n        clientId: review.clientId,\n        meetingId: review.meetingId || undefined,\n        isAnonymous: review.isAnonymous,\n        status: review.status,\n        helpfulCount: review.helpfulVotes?.length || 0,\n        createdAt: review.createdAt.toISOString(),\n        updatedAt: review.updatedAt.toISOString(),\n        moderationNote: review.moderationNote || undefined,\n        client: review.client\n          ? {\n              id: review.clientId,\n              firstName: review.client.user?.firstName,\n              lastName: review.client.user?.lastName,\n            }\n          : undefined,\n        therapist: {\n          id: review.therapistId,\n          firstName: '',\n          lastName: '',\n        },\n      })),\n    };\n  }\n\n  async moderateReview(\n    reviewId: string,\n    moderatorId: string,\n    moderateReviewDto: ModerateReviewDto,\n  ) {\n    const review = await this.prisma.review.findUnique({\n      where: { id: reviewId },\n    });\n\n    if (!review) {\n      throw new NotFoundException('Review not found');\n    }\n\n    const moderatedReview = await this.prisma.review.update({\n      where: { id: reviewId },\n      data: {\n        status: moderateReviewDto.status,\n        moderatedBy: moderatorId,\n        moderatedAt: new Date(),\n        moderationNote: moderateReviewDto.moderationNote,\n      },\n      include: {\n        client: {\n          select: {\n            user: {\n              select: {\n                firstName: true,\n                lastName: true,\n              },\n            },\n          },\n        },\n        therapist: {\n          select: {\n            user: {\n              select: {\n                firstName: true,\n                lastName: true,\n              },\n            },\n          },\n        },\n      },\n    });\n\n    return moderatedReview;\n  }\n\n  async markReviewHelpful(reviewId: string, userId: string) {\n    const review = await this.prisma.review.findUnique({\n      where: { id: reviewId },\n    });\n\n    if (!review) {\n      throw new NotFoundException('Review not found');\n    }\n\n    // Create or update a helpful vote using the ReviewHelpful table\n    const existingVote = await this.prisma.reviewHelpful.findUnique({\n      where: {\n        reviewId_userId: {\n          reviewId,\n          userId,\n        },\n      },\n    });\n\n    if (existingVote) {\n      // Remove the vote if it already exists (toggle behavior)\n      await this.prisma.reviewHelpful.delete({\n        where: { id: existingVote.id },\n      });\n\n      const review = await this.prisma.review.findUnique({\n        where: { id: reviewId },\n        include: { helpfulVotes: true },\n      });\n\n      return {\n        helpful: false,\n        helpfulCount: review?.helpfulVotes.length || 0,\n        message: 'Review helpfulness removed',\n      };\n    } else {\n      // Create new helpful vote\n      await this.prisma.reviewHelpful.create({\n        data: {\n          reviewId,\n          userId,\n        },\n      });\n\n      const review = await this.prisma.review.findUnique({\n        where: { id: reviewId },\n        include: { helpfulVotes: true },\n      });\n\n      return {\n        helpful: true,\n        helpfulCount: review?.helpfulVotes.length || 0,\n        message: 'Review marked as helpful',\n      };\n    }\n  }\n}\n"],"version":3}