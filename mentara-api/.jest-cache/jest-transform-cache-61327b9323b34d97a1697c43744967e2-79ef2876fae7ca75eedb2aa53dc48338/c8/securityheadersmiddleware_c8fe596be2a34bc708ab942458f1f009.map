{"version":3,"names":["cov_kpt5wa2se","actualCoverage","common_1","s","require","SecurityHeadersMiddleware","use","req","res","next","f","removeHeader","frontendUrl","b","process","env","FRONTEND_URL","cspPolicy","join","setHeader","NODE_ENV","isSensitiveEndpoint","path","allowedOrigins","origin","headers","includes","method","status","end","sensitivePatterns","some","pattern","startsWith","exports","__decorate","Injectable"],"sources":["/home/wetooa/Documents/code/projects/mentara/mentara-api/src/common/middleware/security-headers.middleware.ts"],"sourcesContent":["import { Injectable, NestMiddleware } from '@nestjs/common';\nimport { Request, Response, NextFunction } from 'express';\n\n@Injectable()\nexport class SecurityHeadersMiddleware implements NestMiddleware {\n  use(req: Request, res: Response, next: NextFunction): void {\n    // Remove server information\n    res.removeHeader('X-Powered-By');\n    res.removeHeader('Server');\n\n    // Content Security Policy\n    const frontendUrl = process.env.FRONTEND_URL || 'http://localhost:3000';\n    const cspPolicy = [\n      \"default-src 'self'\",\n      `connect-src 'self' ${frontendUrl} https://*.clerk.accounts.dev https://*.supabase.co wss://`,\n      \"script-src 'self' 'unsafe-inline' 'unsafe-eval' https://unpkg.com\",\n      \"style-src 'self' 'unsafe-inline' https://fonts.googleapis.com\",\n      \"font-src 'self' https://fonts.gstatic.com data:\",\n      \"img-src 'self' data: https: blob:\",\n      \"media-src 'self' blob:\",\n      \"object-src 'none'\",\n      \"base-uri 'self'\",\n      \"form-action 'self'\",\n      \"frame-ancestors 'none'\",\n      'upgrade-insecure-requests',\n    ].join('; ');\n\n    // Security Headers\n    res.setHeader('Content-Security-Policy', cspPolicy);\n    res.setHeader('X-Content-Type-Options', 'nosniff');\n    res.setHeader('X-Frame-Options', 'DENY');\n    res.setHeader('X-XSS-Protection', '1; mode=block');\n    res.setHeader('Referrer-Policy', 'strict-origin-when-cross-origin');\n    res.setHeader(\n      'Permissions-Policy',\n      'camera=(), microphone=(), geolocation=()',\n    );\n\n    // HSTS (HTTP Strict Transport Security)\n    if (process.env.NODE_ENV === 'production') {\n      res.setHeader(\n        'Strict-Transport-Security',\n        'max-age=31536000; includeSubDomains; preload',\n      );\n    }\n\n    // Cache Control for sensitive endpoints\n    if (this.isSensitiveEndpoint(req.path)) {\n      res.setHeader(\n        'Cache-Control',\n        'no-store, no-cache, must-revalidate, private',\n      );\n      res.setHeader('Pragma', 'no-cache');\n      res.setHeader('Expires', '0');\n    }\n\n    // CORS headers (if not handled by NestJS CORS)\n    const allowedOrigins = [\n      frontendUrl,\n      'http://localhost:3000',\n      'http://localhost:3001',\n    ];\n\n    const origin = req.headers.origin;\n    if (origin && allowedOrigins.includes(origin)) {\n      res.setHeader('Access-Control-Allow-Origin', origin);\n    }\n\n    res.setHeader(\n      'Access-Control-Allow-Methods',\n      'GET, POST, PUT, DELETE, OPTIONS, PATCH',\n    );\n    res.setHeader(\n      'Access-Control-Allow-Headers',\n      'Content-Type, Authorization, X-Requested-With',\n    );\n    res.setHeader('Access-Control-Allow-Credentials', 'true');\n    res.setHeader('Access-Control-Max-Age', '86400'); // 24 hours\n\n    // Handle preflight requests\n    if (req.method === 'OPTIONS') {\n      res.status(200).end();\n      return;\n    }\n\n    next();\n  }\n\n  private isSensitiveEndpoint(path: string): boolean {\n    const sensitivePatterns = [\n      '/auth',\n      '/admin',\n      '/billing',\n      '/files',\n      '/pre-assessment',\n      '/sessions',\n      '/messaging',\n    ];\n\n    return sensitivePatterns.some((pattern) => path.startsWith(pattern));\n  }\n}\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;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","ignoreList":[]}