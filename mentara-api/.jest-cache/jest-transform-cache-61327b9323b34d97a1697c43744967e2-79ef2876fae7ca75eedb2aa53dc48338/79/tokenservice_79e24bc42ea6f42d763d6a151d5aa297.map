{"file":"/home/wetooa/Documents/code/projects/mentara/mentara-api/src/auth/services/token.service.ts","mappings":";;;;;;;;;;;;;AAAA,2CAAmE;AACnE,qCAAyC;AACzC,mFAAuE;AAEvE,iCAAiC;AACjC,iCAAiC;AAiB1B,IAAM,YAAY,GAAlB,MAAM,YAAY;IAEJ;IACA;IAFnB,YACmB,UAAsB,EACtB,MAAqB;QADrB,eAAU,GAAV,UAAU,CAAY;QACtB,WAAM,GAAN,MAAM,CAAe;IACrC,CAAC;IAEJ,KAAK,CAAC,iBAAiB,CACrB,MAAc,EACd,KAAa,EACb,IAAY,EACZ,SAAkB,EAClB,SAAkB;QAElB,MAAM,OAAO,GAAe;YAC1B,GAAG,EAAE,MAAM;YACX,KAAK;YACL,IAAI;SACL,CAAC;QAEF,MAAM,WAAW,GAAG,IAAI,CAAC,UAAU,CAAC,IAAI,CAAC,OAAO,EAAE;YAChD,SAAS,EAAE,OAAO,CAAC,GAAG,CAAC,cAAc,IAAI,IAAI;SAC9C,CAAC,CAAC;QAEH,MAAM,YAAY,GAAG,MAAM,IAAI,CAAC,oBAAoB,CAClD,MAAM,EACN,SAAS,EACT,SAAS,CACV,CAAC;QAEF,OAAO;YACL,WAAW;YACX,YAAY,EAAE,YAAY,CAAC,KAAK;YAChC,SAAS,EAAE,OAAO,CAAC,GAAG,CAAC,cAAc,IAAI,IAAI;SAC9C,CAAC;IACJ,CAAC;IAEO,KAAK,CAAC,oBAAoB,CAChC,MAAc,EACd,SAAkB,EAClB,SAAkB;QAElB,iDAAiD;QACjD,MAAM,KAAK,GAAG,MAAM,CAAC,WAAW,CAAC,EAAE,CAAC,CAAC,QAAQ,CAAC,KAAK,CAAC,CAAC;QACrD,MAAM,WAAW,GAAG,MAAM,CAAC,UAAU,CAAC,QAAQ,CAAC,CAAC,MAAM,CAAC,KAAK,CAAC,CAAC,MAAM,CAAC,KAAK,CAAC,CAAC;QAE5E,MAAM,SAAS,GAAG,IAAI,IAAI,EAAE,CAAC;QAC7B,SAAS,CAAC,OAAO,CACf,SAAS,CAAC,OAAO,EAAE;YACjB,QAAQ,CAAC,OAAO,CAAC,GAAG,CAAC,sBAAsB,EAAE,OAAO,CAAC,GAAG,EAAE,EAAE,CAAC,IAAI,GAAG,CAAC,CACxE,CAAC;QAEF,iCAAiC;QACjC,MAAM,IAAI,CAAC,MAAM,CAAC,YAAY,CAAC,MAAM,CAAC;YACpC,IAAI,EAAE;gBACJ,KAAK,EAAE,WAAW;gBAClB,MAAM;gBACN,SAAS;gBACT,SAAS;gBACT,SAAS;aACV;SACF,CAAC,CAAC;QAEH,OAAO;YACL,KAAK;YACL,MAAM;YACN,SAAS;YACT,SAAS;YACT,SAAS;SACV,CAAC;IACJ,CAAC;IAED,KAAK,CAAC,kBAAkB,CACtB,YAAoB,EACpB,SAAkB,EAClB,SAAkB;QAElB,MAAM,WAAW,GAAG,MAAM;aACvB,UAAU,CAAC,QAAQ,CAAC;aACpB,MAAM,CAAC,YAAY,CAAC;aACpB,MAAM,CAAC,KAAK,CAAC,CAAC;QAEjB,MAAM,WAAW,GAAG,MAAM,IAAI,CAAC,MAAM,CAAC,YAAY,CAAC,UAAU,CAAC;YAC5D,KAAK,EAAE,EAAE,KAAK,EAAE,WAAW,EAAE;YAC7B,OAAO,EAAE,EAAE,IAAI,EAAE,IAAI,EAAE;SACxB,CAAC,CAAC;QAEH,IAAI,CAAC,WAAW,EAAE,CAAC;YACjB,MAAM,IAAI,8BAAqB,CAAC,uBAAuB,CAAC,CAAC;QAC3D,CAAC;QAED,IAAI,WAAW,CAAC,SAAS,GAAG,IAAI,IAAI,EAAE,EAAE,CAAC;YACvC,yBAAyB;YACzB,MAAM,IAAI,CAAC,MAAM,CAAC,YAAY,CAAC,MAAM,CAAC;gBACpC,KAAK,EAAE,EAAE,EAAE,EAAE,WAAW,CAAC,EAAE,EAAE;aAC9B,CAAC,CAAC;YACH,MAAM,IAAI,8BAAqB,CAAC,uBAAuB,CAAC,CAAC;QAC3D,CAAC;QAED,IAAI,WAAW,CAAC,SAAS,EAAE,CAAC;YAC1B,MAAM,IAAI,8BAAqB,CAAC,uBAAuB,CAAC,CAAC;QAC3D,CAAC;QAED,IAAI,WAAW,CAAC,IAAI,CAAC,aAAa,EAAE,CAAC;YACnC,MAAM,IAAI,8BAAqB,CAAC,0BAA0B,CAAC,CAAC;QAC9D,CAAC;QAED,2BAA2B;QAC3B,MAAM,IAAI,CAAC,MAAM,CAAC,YAAY,CAAC,MAAM,CAAC;YACpC,KAAK,EAAE,EAAE,EAAE,EAAE,WAAW,CAAC,EAAE,EAAE;YAC7B,IAAI,EAAE,EAAE,SAAS,EAAE,IAAI,IAAI,EAAE,EAAE;SAChC,CAAC,CAAC;QAEH,0BAA0B;QAC1B,OAAO,IAAI,CAAC,iBAAiB,CAC3B,WAAW,CAAC,MAAM,EAClB,WAAW,CAAC,IAAI,CAAC,KAAK,EACtB,WAAW,CAAC,IAAI,CAAC,IAAI,EACrB,SAAS,EACT,SAAS,CACV,CAAC;IACJ,CAAC;IAED,KAAK,CAAC,kBAAkB,CAAC,YAAoB;QAC3C,MAAM,WAAW,GAAG,MAAM;aACvB,UAAU,CAAC,QAAQ,CAAC;aACpB,MAAM,CAAC,YAAY,CAAC;aACpB,MAAM,CAAC,KAAK,CAAC,CAAC;QAEjB,MAAM,IAAI,CAAC,MAAM,CAAC,YAAY,CAAC,UAAU,CAAC;YACxC,KAAK,EAAE;gBACL,KAAK,EAAE,WAAW;gBAClB,SAAS,EAAE,IAAI;aAChB;YACD,IAAI,EAAE,EAAE,SAAS,EAAE,IAAI,IAAI,EAAE,EAAE;SAChC,CAAC,CAAC;IACL,CAAC;IAED,KAAK,CAAC,mBAAmB,CAAC,MAAc;QACtC,MAAM,IAAI,CAAC,MAAM,CAAC,YAAY,CAAC,UAAU,CAAC;YACxC,KAAK,EAAE;gBACL,MAAM;gBACN,SAAS,EAAE,IAAI;aAChB;YACD,IAAI,EAAE,EAAE,SAAS,EAAE,IAAI,IAAI,EAAE,EAAE;SAChC,CAAC,CAAC;IACL,CAAC;IAED,KAAK,CAAC,oBAAoB;QACxB,MAAM,IAAI,CAAC,MAAM,CAAC,YAAY,CAAC,UAAU,CAAC;YACxC,KAAK,EAAE;gBACL,EAAE,EAAE,CAAC,EAAE,SAAS,EAAE,EAAE,EAAE,EAAE,IAAI,IAAI,EAAE,EAAE,EAAE,EAAE,EAAE,SAAS,EAAE,EAAE,GAAG,EAAE,IAAI,EAAE,EAAE,CAAC;aACtE;SACF,CAAC,CAAC;IACL,CAAC;IAED,6BAA6B;IAC7B,KAAK,CAAC,YAAY,CAAC,QAAgB;QACjC,MAAM,UAAU,GAAG,QAAQ,CAAC,OAAO,CAAC,GAAG,CAAC,kBAAkB,IAAI,IAAI,CAAC,CAAC;QACpE,OAAO,MAAM,CAAC,IAAI,CAAC,QAAQ,EAAE,UAAU,CAAC,CAAC;IAC3C,CAAC;IAED,KAAK,CAAC,eAAe,CACnB,QAAgB,EAChB,cAAsB;QAEtB,OAAO,MAAM,CAAC,OAAO,CAAC,QAAQ,EAAE,cAAc,CAAC,CAAC;IAClD,CAAC;IAED,sCAAsC;IACtC,KAAK,CAAC,8BAA8B;QAKlC,MAAM,KAAK,GAAG,MAAM,CAAC,WAAW,CAAC,EAAE,CAAC,CAAC,QAAQ,CAAC,KAAK,CAAC,CAAC;QACrD,MAAM,WAAW,GAAG,MAAM,CAAC,UAAU,CAAC,QAAQ,CAAC,CAAC,MAAM,CAAC,KAAK,CAAC,CAAC,MAAM,CAAC,KAAK,CAAC,CAAC;QAE5E,MAAM,SAAS,GAAG,IAAI,IAAI,EAAE,CAAC;QAC7B,SAAS,CAAC,QAAQ,CAAC,SAAS,CAAC,QAAQ,EAAE,GAAG,EAAE,CAAC,CAAC,CAAC,kBAAkB;QAEjE,OAAO,EAAE,KAAK,EAAE,WAAW,EAAE,SAAS,EAAE,CAAC;IAC3C,CAAC;IAED,kCAAkC;IAClC,KAAK,CAAC,0BAA0B;QAK9B,MAAM,KAAK,GAAG,MAAM,CAAC,WAAW,CAAC,EAAE,CAAC,CAAC,QAAQ,CAAC,KAAK,CAAC,CAAC;QACrD,MAAM,WAAW,GAAG,MAAM,CAAC,UAAU,CAAC,QAAQ,CAAC,CAAC,MAAM,CAAC,KAAK,CAAC,CAAC,MAAM,CAAC,KAAK,CAAC,CAAC;QAE5E,MAAM,SAAS,GAAG,IAAI,IAAI,EAAE,CAAC;QAC7B,SAAS,CAAC,QAAQ,CAAC,SAAS,CAAC,QAAQ,EAAE,GAAG,CAAC,CAAC,CAAC,CAAC,6BAA6B;QAE3E,OAAO,EAAE,KAAK,EAAE,WAAW,EAAE,SAAS,EAAE,CAAC;IAC3C,CAAC;IAED,4BAA4B;IAC5B,KAAK,CAAC,mBAAmB,CAAC,MAAc;QACtC,MAAM,IAAI,GAAG,MAAM,IAAI,CAAC,MAAM,CAAC,IAAI,CAAC,UAAU,CAAC;YAC7C,KAAK,EAAE,EAAE,EAAE,EAAE,MAAM,EAAE;YACrB,MAAM,EAAE,EAAE,YAAY,EAAE,IAAI,EAAE,gBAAgB,EAAE,IAAI,EAAE;SACvD,CAAC,CAAC;QAEH,IAAI,CAAC,IAAI;YAAE,OAAO,KAAK,CAAC;QAExB,uCAAuC;QACvC,IAAI,IAAI,CAAC,YAAY,IAAI,IAAI,CAAC,YAAY,GAAG,IAAI,IAAI,EAAE,EAAE,CAAC;YACxD,OAAO,IAAI,CAAC;QACd,CAAC;QAED,mCAAmC;QACnC,IAAI,IAAI,CAAC,YAAY,IAAI,IAAI,CAAC,YAAY,IAAI,IAAI,IAAI,EAAE,EAAE,CAAC;YACzD,MAAM,IAAI,CAAC,MAAM,CAAC,IAAI,CAAC,MAAM,CAAC;gBAC5B,KAAK,EAAE,EAAE,EAAE,EAAE,MAAM,EAAE;gBACrB,IAAI,EAAE;oBACJ,YAAY,EAAE,IAAI;oBAClB,gBAAgB,EAAE,CAAC;iBACpB;aACF,CAAC,CAAC;QACL,CAAC;QAED,OAAO,KAAK,CAAC;IACf,CAAC;IAED,KAAK,CAAC,iBAAiB,CAAC,MAAc;QACpC,MAAM,WAAW,GAAG,QAAQ,CAAC,OAAO,CAAC,GAAG,CAAC,kBAAkB,IAAI,GAAG,CAAC,CAAC;QACpE,MAAM,eAAe,GAAG,QAAQ,CAC9B,OAAO,CAAC,GAAG,CAAC,wBAAwB,IAAI,IAAI,CAC7C,CAAC;QAEF,MAAM,IAAI,GAAG,MAAM,IAAI,CAAC,MAAM,CAAC,IAAI,CAAC,UAAU,CAAC;YAC7C,KAAK,EAAE,EAAE,EAAE,EAAE,MAAM,EAAE;YACrB,MAAM,EAAE,EAAE,gBAAgB,EAAE,IAAI,EAAE;SACnC,CAAC,CAAC;QAEH,IAAI,CAAC,IAAI;YAAE,OAAO;QAElB,MAAM,cAAc,GAAG,IAAI,CAAC,gBAAgB,GAAG,CAAC,CAAC;QACjD,MAAM,UAAU,GAAQ,EAAE,gBAAgB,EAAE,cAAc,EAAE,CAAC;QAE7D,uCAAuC;QACvC,IAAI,cAAc,IAAI,WAAW,EAAE,CAAC;YAClC,MAAM,YAAY,GAAG,IAAI,IAAI,EAAE,CAAC;YAChC,YAAY,CAAC,UAAU,CAAC,YAAY,CAAC,UAAU,EAAE,GAAG,eAAe,CAAC,CAAC;YACrE,UAAU,CAAC,YAAY,GAAG,YAAY,CAAC;QACzC,CAAC;QAED,MAAM,IAAI,CAAC,MAAM,CAAC,IAAI,CAAC,MAAM,CAAC;YAC5B,KAAK,EAAE,EAAE,EAAE,EAAE,MAAM,EAAE;YACrB,IAAI,EAAE,UAAU;SACjB,CAAC,CAAC;IACL,CAAC;IAED,KAAK,CAAC,qBAAqB,CAAC,MAAc;QACxC,MAAM,IAAI,CAAC,MAAM,CAAC,IAAI,CAAC,MAAM,CAAC;YAC5B,KAAK,EAAE,EAAE,EAAE,EAAE,MAAM,EAAE;YACrB,IAAI,EAAE;gBACJ,gBAAgB,EAAE,CAAC;gBACnB,YAAY,EAAE,IAAI;gBAClB,WAAW,EAAE,IAAI,IAAI,EAAE;aACxB;SACF,CAAC,CAAC;IACL,CAAC;CACF,CAAA;AAzQY,oCAAY;uBAAZ,YAAY;IADxB,IAAA,mBAAU,GAAE;yDAGoB,gBAAU,oBAAV,gBAAU,oDACd,sCAAa,oBAAb,sCAAa;GAH7B,YAAY,CAyQxB","names":[],"sources":["/home/wetooa/Documents/code/projects/mentara/mentara-api/src/auth/services/token.service.ts"],"sourcesContent":["import { Injectable, UnauthorizedException } from '@nestjs/common';\nimport { JwtService } from '@nestjs/jwt';\nimport { PrismaService } from '../../providers/prisma-client.provider';\nimport { JwtPayload } from '../strategies/jwt.strategy';\nimport * as crypto from 'crypto';\nimport * as bcrypt from 'bcrypt';\n\nexport interface TokenPair {\n  accessToken: string;\n  refreshToken: string;\n  expiresIn: string;\n}\n\nexport interface RefreshTokenData {\n  token: string;\n  userId: string;\n  expiresAt: Date;\n  ipAddress?: string;\n  userAgent?: string;\n}\n\n@Injectable()\nexport class TokenService {\n  constructor(\n    private readonly jwtService: JwtService,\n    private readonly prisma: PrismaService,\n  ) {}\n\n  async generateTokenPair(\n    userId: string,\n    email: string,\n    role: string,\n    ipAddress?: string,\n    userAgent?: string,\n  ): Promise<TokenPair> {\n    const payload: JwtPayload = {\n      sub: userId,\n      email,\n      role,\n    };\n\n    const accessToken = this.jwtService.sign(payload, {\n      expiresIn: process.env.JWT_EXPIRES_IN || '1h',\n    });\n\n    const refreshToken = await this.generateRefreshToken(\n      userId,\n      ipAddress,\n      userAgent,\n    );\n\n    return {\n      accessToken,\n      refreshToken: refreshToken.token,\n      expiresIn: process.env.JWT_EXPIRES_IN || '1h',\n    };\n  }\n\n  private async generateRefreshToken(\n    userId: string,\n    ipAddress?: string,\n    userAgent?: string,\n  ): Promise<RefreshTokenData> {\n    // Generate cryptographically secure random token\n    const token = crypto.randomBytes(64).toString('hex');\n    const hashedToken = crypto.createHash('sha256').update(token).digest('hex');\n\n    const expiresAt = new Date();\n    expiresAt.setDate(\n      expiresAt.getDate() +\n        parseInt(process.env.JWT_REFRESH_EXPIRES_IN?.replace('d', '') || '7'),\n    );\n\n    // Store hashed token in database\n    await this.prisma.refreshToken.create({\n      data: {\n        token: hashedToken,\n        userId,\n        expiresAt,\n        ipAddress,\n        userAgent,\n      },\n    });\n\n    return {\n      token,\n      userId,\n      expiresAt,\n      ipAddress,\n      userAgent,\n    };\n  }\n\n  async refreshAccessToken(\n    refreshToken: string,\n    ipAddress?: string,\n    userAgent?: string,\n  ): Promise<TokenPair> {\n    const hashedToken = crypto\n      .createHash('sha256')\n      .update(refreshToken)\n      .digest('hex');\n\n    const storedToken = await this.prisma.refreshToken.findUnique({\n      where: { token: hashedToken },\n      include: { user: true },\n    });\n\n    if (!storedToken) {\n      throw new UnauthorizedException('Invalid refresh token');\n    }\n\n    if (storedToken.expiresAt < new Date()) {\n      // Clean up expired token\n      await this.prisma.refreshToken.delete({\n        where: { id: storedToken.id },\n      });\n      throw new UnauthorizedException('Refresh token expired');\n    }\n\n    if (storedToken.revokedAt) {\n      throw new UnauthorizedException('Refresh token revoked');\n    }\n\n    if (storedToken.user.deactivatedAt) {\n      throw new UnauthorizedException('User account deactivated');\n    }\n\n    // Revoke old refresh token\n    await this.prisma.refreshToken.update({\n      where: { id: storedToken.id },\n      data: { revokedAt: new Date() },\n    });\n\n    // Generate new token pair\n    return this.generateTokenPair(\n      storedToken.userId,\n      storedToken.user.email,\n      storedToken.user.role,\n      ipAddress,\n      userAgent,\n    );\n  }\n\n  async revokeRefreshToken(refreshToken: string): Promise<void> {\n    const hashedToken = crypto\n      .createHash('sha256')\n      .update(refreshToken)\n      .digest('hex');\n\n    await this.prisma.refreshToken.updateMany({\n      where: {\n        token: hashedToken,\n        revokedAt: null,\n      },\n      data: { revokedAt: new Date() },\n    });\n  }\n\n  async revokeAllUserTokens(userId: string): Promise<void> {\n    await this.prisma.refreshToken.updateMany({\n      where: {\n        userId,\n        revokedAt: null,\n      },\n      data: { revokedAt: new Date() },\n    });\n  }\n\n  async cleanupExpiredTokens(): Promise<void> {\n    await this.prisma.refreshToken.deleteMany({\n      where: {\n        OR: [{ expiresAt: { lt: new Date() } }, { revokedAt: { not: null } }],\n      },\n    });\n  }\n\n  // Password hashing utilities\n  async hashPassword(password: string): Promise<string> {\n    const saltRounds = parseInt(process.env.BCRYPT_SALT_ROUNDS || '12');\n    return bcrypt.hash(password, saltRounds);\n  }\n\n  async comparePassword(\n    password: string,\n    hashedPassword: string,\n  ): Promise<boolean> {\n    return bcrypt.compare(password, hashedPassword);\n  }\n\n  // Email verification token generation\n  async generateEmailVerificationToken(): Promise<{\n    token: string;\n    hashedToken: string;\n    expiresAt: Date;\n  }> {\n    const token = crypto.randomBytes(32).toString('hex');\n    const hashedToken = crypto.createHash('sha256').update(token).digest('hex');\n\n    const expiresAt = new Date();\n    expiresAt.setHours(expiresAt.getHours() + 24); // 24 hours expiry\n\n    return { token, hashedToken, expiresAt };\n  }\n\n  // Password reset token generation\n  async generatePasswordResetToken(): Promise<{\n    token: string;\n    hashedToken: string;\n    expiresAt: Date;\n  }> {\n    const token = crypto.randomBytes(32).toString('hex');\n    const hashedToken = crypto.createHash('sha256').update(token).digest('hex');\n\n    const expiresAt = new Date();\n    expiresAt.setHours(expiresAt.getHours() + 1); // 1 hour expiry for security\n\n    return { token, hashedToken, expiresAt };\n  }\n\n  // Account lockout utilities\n  async checkAccountLockout(userId: string): Promise<boolean> {\n    const user = await this.prisma.user.findUnique({\n      where: { id: userId },\n      select: { lockoutUntil: true, failedLoginCount: true },\n    });\n\n    if (!user) return false;\n\n    // Check if account is currently locked\n    if (user.lockoutUntil && user.lockoutUntil > new Date()) {\n      return true;\n    }\n\n    // Clear lockout if time has passed\n    if (user.lockoutUntil && user.lockoutUntil <= new Date()) {\n      await this.prisma.user.update({\n        where: { id: userId },\n        data: {\n          lockoutUntil: null,\n          failedLoginCount: 0,\n        },\n      });\n    }\n\n    return false;\n  }\n\n  async handleFailedLogin(userId: string): Promise<void> {\n    const maxAttempts = parseInt(process.env.MAX_LOGIN_ATTEMPTS || '5');\n    const lockoutDuration = parseInt(\n      process.env.LOCKOUT_DURATION_MINUTES || '15',\n    );\n\n    const user = await this.prisma.user.findUnique({\n      where: { id: userId },\n      select: { failedLoginCount: true },\n    });\n\n    if (!user) return;\n\n    const newFailedCount = user.failedLoginCount + 1;\n    const updateData: any = { failedLoginCount: newFailedCount };\n\n    // Lock account if max attempts reached\n    if (newFailedCount >= maxAttempts) {\n      const lockoutUntil = new Date();\n      lockoutUntil.setMinutes(lockoutUntil.getMinutes() + lockoutDuration);\n      updateData.lockoutUntil = lockoutUntil;\n    }\n\n    await this.prisma.user.update({\n      where: { id: userId },\n      data: updateData,\n    });\n  }\n\n  async resetFailedLoginCount(userId: string): Promise<void> {\n    await this.prisma.user.update({\n      where: { id: userId },\n      data: {\n        failedLoginCount: 0,\n        lockoutUntil: null,\n        lastLoginAt: new Date(),\n      },\n    });\n  }\n}\n"],"version":3}