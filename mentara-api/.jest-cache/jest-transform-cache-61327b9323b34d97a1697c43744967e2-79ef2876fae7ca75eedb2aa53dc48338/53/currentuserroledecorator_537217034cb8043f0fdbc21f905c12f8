58fa45aefb0f3cc69b229c334163fa38
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.CurrentUserRole = void 0;
const common_1 = require("@nestjs/common");
const prisma_client_provider_1 = require("src/providers/prisma-client.provider");
exports.CurrentUserRole = (0, common_1.createParamDecorator)(async (_, context) => {
    const request = context.switchToHttp().getRequest();
    const clerkId = request.userId;
    if (!clerkId) {
        return null;
    }
    // First, check if role was extracted from Clerk token by ClerkAuthGuard
    if (request.userRole) {
        return request.userRole;
    }
    // Fallback to database lookup for backwards compatibility
    try {
        const prisma = new prisma_client_provider_1.PrismaService();
        const user = await prisma.user.findUnique({
            where: { id: clerkId },
            select: { role: true },
        });
        await prisma.$disconnect();
        return user?.role ?? null;
    }
    catch (error) {
        console.error('Error getting user role from database:', error instanceof Error ? error.message : error);
        return null;
    }
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL2RlY29yYXRvcnMvY3VycmVudC11c2VyLXJvbGUuZGVjb3JhdG9yLnRzIiwibWFwcGluZ3MiOiI7OztBQUFBLDJDQUE2RTtBQUU3RSxpRkFBcUU7QUFFeEQsUUFBQSxlQUFlLEdBQUcsSUFBQSw2QkFBb0IsRUFDakQsS0FBSyxFQUFFLENBQUMsRUFBRSxPQUF5QixFQUFFLEVBQUU7SUFDckMsTUFBTSxPQUFPLEdBQUcsT0FBTyxDQUFDLFlBQVksRUFBRSxDQUFDLFVBQVUsRUFBVyxDQUFDO0lBQzdELE1BQU0sT0FBTyxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUM7SUFFL0IsSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFDO1FBQ2IsT0FBTyxJQUFJLENBQUM7SUFDZCxDQUFDO0lBRUQsd0VBQXdFO0lBQ3hFLElBQUksT0FBTyxDQUFDLFFBQVEsRUFBRSxDQUFDO1FBQ3JCLE9BQU8sT0FBTyxDQUFDLFFBQVEsQ0FBQztJQUMxQixDQUFDO0lBRUQsMERBQTBEO0lBQzFELElBQUksQ0FBQztRQUNILE1BQU0sTUFBTSxHQUFHLElBQUksc0NBQWEsRUFBRSxDQUFDO1FBQ25DLE1BQU0sSUFBSSxHQUFHLE1BQU0sTUFBTSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUM7WUFDeEMsS0FBSyxFQUFFLEVBQUUsRUFBRSxFQUFFLE9BQU8sRUFBRTtZQUN0QixNQUFNLEVBQUUsRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFO1NBQ3ZCLENBQUMsQ0FBQztRQUVILE1BQU0sTUFBTSxDQUFDLFdBQVcsRUFBRSxDQUFDO1FBQzNCLE9BQU8sSUFBSSxFQUFFLElBQUksSUFBSSxJQUFJLENBQUM7SUFDNUIsQ0FBQztJQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7UUFDZixPQUFPLENBQUMsS0FBSyxDQUNYLHdDQUF3QyxFQUN4QyxLQUFLLFlBQVksS0FBSyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQy9DLENBQUM7UUFDRixPQUFPLElBQUksQ0FBQztJQUNkLENBQUM7QUFDSCxDQUFDLENBQ0YsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvaG9tZS93ZXRvb2EvRG9jdW1lbnRzL2NvZGUvcHJvamVjdHMvbWVudGFyYS9tZW50YXJhLWFwaS9zcmMvZGVjb3JhdG9ycy9jdXJyZW50LXVzZXItcm9sZS5kZWNvcmF0b3IudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgY3JlYXRlUGFyYW1EZWNvcmF0b3IsIHR5cGUgRXhlY3V0aW9uQ29udGV4dCB9IGZyb20gJ0BuZXN0anMvY29tbW9uJztcbmltcG9ydCB7IHR5cGUgUmVxdWVzdCB9IGZyb20gJ2V4cHJlc3MnO1xuaW1wb3J0IHsgUHJpc21hU2VydmljZSB9IGZyb20gJ3NyYy9wcm92aWRlcnMvcHJpc21hLWNsaWVudC5wcm92aWRlcic7XG5cbmV4cG9ydCBjb25zdCBDdXJyZW50VXNlclJvbGUgPSBjcmVhdGVQYXJhbURlY29yYXRvcihcbiAgYXN5bmMgKF8sIGNvbnRleHQ6IEV4ZWN1dGlvbkNvbnRleHQpID0+IHtcbiAgICBjb25zdCByZXF1ZXN0ID0gY29udGV4dC5zd2l0Y2hUb0h0dHAoKS5nZXRSZXF1ZXN0PFJlcXVlc3Q+KCk7XG4gICAgY29uc3QgY2xlcmtJZCA9IHJlcXVlc3QudXNlcklkO1xuXG4gICAgaWYgKCFjbGVya0lkKSB7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICAvLyBGaXJzdCwgY2hlY2sgaWYgcm9sZSB3YXMgZXh0cmFjdGVkIGZyb20gQ2xlcmsgdG9rZW4gYnkgQ2xlcmtBdXRoR3VhcmRcbiAgICBpZiAocmVxdWVzdC51c2VyUm9sZSkge1xuICAgICAgcmV0dXJuIHJlcXVlc3QudXNlclJvbGU7XG4gICAgfVxuXG4gICAgLy8gRmFsbGJhY2sgdG8gZGF0YWJhc2UgbG9va3VwIGZvciBiYWNrd2FyZHMgY29tcGF0aWJpbGl0eVxuICAgIHRyeSB7XG4gICAgICBjb25zdCBwcmlzbWEgPSBuZXcgUHJpc21hU2VydmljZSgpO1xuICAgICAgY29uc3QgdXNlciA9IGF3YWl0IHByaXNtYS51c2VyLmZpbmRVbmlxdWUoe1xuICAgICAgICB3aGVyZTogeyBpZDogY2xlcmtJZCB9LFxuICAgICAgICBzZWxlY3Q6IHsgcm9sZTogdHJ1ZSB9LFxuICAgICAgfSk7XG5cbiAgICAgIGF3YWl0IHByaXNtYS4kZGlzY29ubmVjdCgpO1xuICAgICAgcmV0dXJuIHVzZXI/LnJvbGUgPz8gbnVsbDtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc29sZS5lcnJvcihcbiAgICAgICAgJ0Vycm9yIGdldHRpbmcgdXNlciByb2xlIGZyb20gZGF0YWJhc2U6JyxcbiAgICAgICAgZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiBlcnJvcixcbiAgICAgICk7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG4gIH0sXG4pO1xuIl0sInZlcnNpb24iOjN9