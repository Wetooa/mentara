4694c79db27a72236a1ccab485c21c76
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var __param = (this && this.__param) || function (paramIndex, decorator) {
    return function (target, key) { decorator(target, key, paramIndex); }
};
var _a, _b, _c, _d;
Object.defineProperty(exports, "__esModule", { value: true });
exports.WorksheetUploadsController = void 0;
const common_1 = require("@nestjs/common");
const platform_express_1 = require("@nestjs/platform-express");
const prisma_client_provider_1 = require("../providers/prisma-client.provider");
const supabase_storage_service_1 = require("../common/services/supabase-storage.service");
let WorksheetUploadsController = class WorksheetUploadsController {
    prisma;
    supabaseStorageService;
    constructor(prisma, supabaseStorageService) {
        this.prisma = prisma;
        this.supabaseStorageService = supabaseStorageService;
    }
    async uploadFile(file, worksheetId, type) {
        if (!file) {
            throw new common_1.BadRequestException('No file uploaded');
        }
        if (!worksheetId) {
            throw new common_1.BadRequestException('Worksheet ID is required');
        }
        if (!type || !['material', 'submission'].includes(type)) {
            throw new common_1.BadRequestException('Type must be either "material" or "submission"');
        }
        try {
            // Check if the worksheet exists
            const worksheet = await this.prisma.worksheet.findUnique({
                where: { id: worksheetId },
            });
            if (!worksheet) {
                throw new common_1.BadRequestException(`Worksheet with ID ${worksheetId} not found`);
            }
            // Validate file
            const allowedMimeTypes = [
                'application/pdf', // PDF files
                'application/msword', // DOC files
                'application/vnd.openxmlformats-officedocument.wordprocessingml.document', // DOCX files
                'text/plain', // Text files
                'image/jpeg', // JPEG images
                'image/png', // PNG images
            ];
            const validation = this.supabaseStorageService.validateFile(file, 5 * 1024 * 1024, // 5MB limit
            allowedMimeTypes);
            if (!validation.isValid) {
                throw new common_1.BadRequestException(`File validation failed: ${validation.error}`);
            }
            // Upload file to Supabase Storage
            const uploadResult = await this.supabaseStorageService.uploadFile(file, supabase_storage_service_1.SupabaseStorageService.getSupportedBuckets().WORKSHEETS);
            // Update the worksheet with the new file information
            if (type === 'material') {
                // Add to material arrays
                await this.prisma.worksheet.update({
                    where: { id: worksheetId },
                    data: {
                        materialUrls: {
                            push: uploadResult.url,
                        },
                        materialNames: {
                            push: file.originalname,
                        },
                    },
                });
            }
            else {
                // For submissions, create or update WorksheetSubmission
                const existingSubmission = await this.prisma.worksheetSubmission.findUnique({
                    where: { worksheetId },
                });
                if (existingSubmission) {
                    // Update existing submission
                    await this.prisma.worksheetSubmission.update({
                        where: { worksheetId },
                        data: {
                            fileUrls: {
                                push: uploadResult.url,
                            },
                            fileNames: {
                                push: file.originalname,
                            },
                            fileSizes: {
                                push: file.size,
                            },
                        },
                    });
                }
                else {
                    // Create new submission
                    await this.prisma.worksheetSubmission.create({
                        data: {
                            worksheetId,
                            fileUrls: [uploadResult.url],
                            fileNames: [file.originalname],
                            fileSizes: [file.size],
                        },
                    });
                }
            }
            // Return the expected response format
            return {
                id: uploadResult.filename, // Use the unique filename as ID
                filename: file.originalname,
                url: uploadResult.url,
                fileSize: file.size,
                fileType: file.mimetype,
            };
        }
        catch (error) {
            if (error instanceof common_1.BadRequestException) {
                throw error;
            }
            throw new common_1.HttpException(`Failed to upload file: ${error instanceof Error ? error.message : 'Unknown error'}`, common_1.HttpStatus.INTERNAL_SERVER_ERROR);
        }
    }
};
exports.WorksheetUploadsController = WorksheetUploadsController;
__decorate([
    (0, common_1.Post)(),
    (0, common_1.UseInterceptors)((0, platform_express_1.FileInterceptor)('file')),
    __param(0, (0, common_1.UploadedFile)()),
    __param(1, (0, common_1.Body)('worksheetId')),
    __param(2, (0, common_1.Body)('type')),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [typeof (_d = typeof Express !== "undefined" && (_c = Express.Multer) !== void 0 && _c.File) === "function" ? _d : Object, String, String]),
    __metadata("design:returntype", Promise)
], WorksheetUploadsController.prototype, "uploadFile", null);
exports.WorksheetUploadsController = WorksheetUploadsController = __decorate([
    (0, common_1.Controller)('worksheets/upload'),
    __metadata("design:paramtypes", [typeof (_a = typeof prisma_client_provider_1.PrismaService !== "undefined" && prisma_client_provider_1.PrismaService) === "function" ? _a : Object, typeof (_b = typeof supabase_storage_service_1.SupabaseStorageService !== "undefined" && supabase_storage_service_1.SupabaseStorageService) === "function" ? _b : Object])
], WorksheetUploadsController);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL3dvcmtzaGVldHMvd29ya3NoZWV0LXVwbG9hZHMuY29udHJvbGxlci50cyIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsMkNBU3dCO0FBQ3hCLCtEQUEyRDtBQUMzRCxnRkFBb0U7QUFDcEUsMEZBQXFGO0FBRzlFLElBQU0sMEJBQTBCLEdBQWhDLE1BQU0sMEJBQTBCO0lBRTNCO0lBQ1M7SUFGbkIsWUFDVSxNQUFxQixFQUNaLHNCQUE4QztRQUR2RCxXQUFNLEdBQU4sTUFBTSxDQUFlO1FBQ1osMkJBQXNCLEdBQXRCLHNCQUFzQixDQUF3QjtJQUM5RCxDQUFDO0lBSUUsQUFBTixLQUFLLENBQUMsVUFBVSxDQUNFLElBQXlCLEVBQ3BCLFdBQW1CLEVBQzFCLElBQStCO1FBRTdDLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQztZQUNWLE1BQU0sSUFBSSw0QkFBbUIsQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO1FBQ3BELENBQUM7UUFFRCxJQUFJLENBQUMsV0FBVyxFQUFFLENBQUM7WUFDakIsTUFBTSxJQUFJLDRCQUFtQixDQUFDLDBCQUEwQixDQUFDLENBQUM7UUFDNUQsQ0FBQztRQUVELElBQUksQ0FBQyxJQUFJLElBQUksQ0FBQyxDQUFDLFVBQVUsRUFBRSxZQUFZLENBQUMsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQztZQUN4RCxNQUFNLElBQUksNEJBQW1CLENBQzNCLGdEQUFnRCxDQUNqRCxDQUFDO1FBQ0osQ0FBQztRQUVELElBQUksQ0FBQztZQUNILGdDQUFnQztZQUNoQyxNQUFNLFNBQVMsR0FBRyxNQUFNLElBQUksQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDLFVBQVUsQ0FBQztnQkFDdkQsS0FBSyxFQUFFLEVBQUUsRUFBRSxFQUFFLFdBQVcsRUFBRTthQUMzQixDQUFDLENBQUM7WUFFSCxJQUFJLENBQUMsU0FBUyxFQUFFLENBQUM7Z0JB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LFlBQVksQ0FBQyxHQUFHO2dCQUNyQixRQUFRLEVBQUUsSUFBSSxDQUFDLElBQUk7Z0JBQ25CLFFBQVEsRUFBRSxJQUFJLENBQUMsUUFBUTthQUN4QixDQUFDO1FBQ0osQ0FBQztRQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7WUFDZixJQUFJLEtBQUssWUFBWSw0QkFBbUIsRUFBRSxDQUFDO2dCQUN6QyxNQUFNLEtBQUssQ0FBQztZQUNkLENBQUM7WUFFRCxNQUFNLElBQUksc0JBQWEsQ0FDckIsMEJBQTBCLEtBQUssWUFBWSxLQUFLLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLGVBQWUsRUFBRSxFQUNwRixtQkFBVSxDQUFDLHFCQUFxQixDQUNqQyxDQUFDO1FBQ0osQ0FBQztJQUNILENBQUM7Q0FDRixDQUFBO0FBeElZLGdFQUEwQjtBQVEvQjtJQUZMLElBQUEsYUFBSSxHQUFFO0lBQ04sSUFBQSx3QkFBZSxFQUFDLElBQUEsa0NBQWUsRUFBQyxNQUFNLENBQUMsQ0FBQztJQUV0QyxXQUFBLElBQUEscUJBQVksR0FBRSxDQUFBO0lBQ2QsV0FBQSxJQUFBLGFBQUksRUFBQyxhQUFhLENBQUMsQ0FBQTtJQUNuQixXQUFBLElBQUEsYUFBSSxFQUFDLE1BQU0sQ0FBQyxDQUFBOzt5REFGUyxPQUFPLDBCQUFQLE9BQU8sQ0FBQyxNQUFNLG1CQUFDLElBQUk7OzREQThIMUM7cUNBdklVLDBCQUEwQjtJQUR0QyxJQUFBLG1CQUFVLEVBQUMsbUJBQW1CLENBQUM7eURBR1osc0NBQWEsb0JBQWIsc0NBQWEsb0RBQ1ksaURBQXNCLG9CQUF0QixpREFBc0I7R0FIdEQsMEJBQTBCLENBd0l0QyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvaG9tZS93ZXRvb2EvRG9jdW1lbnRzL2NvZGUvcHJvamVjdHMvbWVudGFyYS9tZW50YXJhLWFwaS9zcmMvd29ya3NoZWV0cy93b3Jrc2hlZXQtdXBsb2Fkcy5jb250cm9sbGVyLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIENvbnRyb2xsZXIsXG4gIFBvc3QsXG4gIFVzZUludGVyY2VwdG9ycyxcbiAgVXBsb2FkZWRGaWxlLFxuICBCb2R5LFxuICBCYWRSZXF1ZXN0RXhjZXB0aW9uLFxuICBIdHRwRXhjZXB0aW9uLFxuICBIdHRwU3RhdHVzLFxufSBmcm9tICdAbmVzdGpzL2NvbW1vbic7XG5pbXBvcnQgeyBGaWxlSW50ZXJjZXB0b3IgfSBmcm9tICdAbmVzdGpzL3BsYXRmb3JtLWV4cHJlc3MnO1xuaW1wb3J0IHsgUHJpc21hU2VydmljZSB9IGZyb20gJy4uL3Byb3ZpZGVycy9wcmlzbWEtY2xpZW50LnByb3ZpZGVyJztcbmltcG9ydCB7IFN1cGFiYXNlU3RvcmFnZVNlcnZpY2UgfSBmcm9tICcuLi9jb21tb24vc2VydmljZXMvc3VwYWJhc2Utc3RvcmFnZS5zZXJ2aWNlJztcblxuQENvbnRyb2xsZXIoJ3dvcmtzaGVldHMvdXBsb2FkJylcbmV4cG9ydCBjbGFzcyBXb3Jrc2hlZXRVcGxvYWRzQ29udHJvbGxlciB7XG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgcHJpc21hOiBQcmlzbWFTZXJ2aWNlLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgc3VwYWJhc2VTdG9yYWdlU2VydmljZTogU3VwYWJhc2VTdG9yYWdlU2VydmljZSxcbiAgKSB7fVxuXG4gIEBQb3N0KClcbiAgQFVzZUludGVyY2VwdG9ycyhGaWxlSW50ZXJjZXB0b3IoJ2ZpbGUnKSlcbiAgYXN5bmMgdXBsb2FkRmlsZShcbiAgICBAVXBsb2FkZWRGaWxlKCkgZmlsZTogRXhwcmVzcy5NdWx0ZXIuRmlsZSxcbiAgICBAQm9keSgnd29ya3NoZWV0SWQnKSB3b3Jrc2hlZXRJZDogc3RyaW5nLFxuICAgIEBCb2R5KCd0eXBlJykgdHlwZTogJ21hdGVyaWFsJyB8ICdzdWJtaXNzaW9uJyxcbiAgKSB7XG4gICAgaWYgKCFmaWxlKSB7XG4gICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdEV4Y2VwdGlvbignTm8gZmlsZSB1cGxvYWRlZCcpO1xuICAgIH1cblxuICAgIGlmICghd29ya3NoZWV0SWQpIHtcbiAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0RXhjZXB0aW9uKCdXb3Jrc2hlZXQgSUQgaXMgcmVxdWlyZWQnKTtcbiAgICB9XG5cbiAgICBpZiAoIXR5cGUgfHwgIVsnbWF0ZXJpYWwnLCAnc3VibWlzc2lvbiddLmluY2x1ZGVzKHR5cGUpKSB7XG4gICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdEV4Y2VwdGlvbihcbiAgICAgICAgJ1R5cGUgbXVzdCBiZSBlaXRoZXIgXCJtYXRlcmlhbFwiIG9yIFwic3VibWlzc2lvblwiJyxcbiAgICAgICk7XG4gICAgfVxuXG4gICAgdHJ5IHtcbiAgICAgIC8vIENoZWNrIGlmIHRoZSB3b3Jrc2hlZXQgZXhpc3RzXG4gICAgICBjb25zdCB3b3Jrc2hlZXQgPSBhd2FpdCB0aGlzLnByaXNtYS53b3Jrc2hlZXQuZmluZFVuaXF1ZSh7XG4gICAgICAgIHdoZXJlOiB7IGlkOiB3b3Jrc2hlZXRJZCB9LFxuICAgICAgfSk7XG5cbiAgICAgIGlmICghd29ya3NoZWV0KSB7XG4gICAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0RXhjZXB0aW9uKFxuICAgICAgICAgIGBXb3Jrc2hlZXQgd2l0aCBJRCAke3dvcmtzaGVldElkfSBub3QgZm91bmRgLFxuICAgICAgICApO1xuICAgICAgfVxuXG4gICAgICAvLyBWYWxpZGF0ZSBmaWxlXG4gICAgICBjb25zdCBhbGxvd2VkTWltZVR5cGVzID0gW1xuICAgICAgICAnYXBwbGljYXRpb24vcGRmJywgLy8gUERGIGZpbGVzXG4gICAgICAgICdhcHBsaWNhdGlvbi9tc3dvcmQnLCAvLyBET0MgZmlsZXNcbiAgICAgICAgJ2FwcGxpY2F0aW9uL3ZuZC5vcGVueG1sZm9ybWF0cy1vZmZpY2Vkb2N1bWVudC53b3JkcHJvY2Vzc2luZ21sLmRvY3VtZW50JywgLy8gRE9DWCBmaWxlc1xuICAgICAgICAndGV4dC9wbGFpbicsIC8vIFRleHQgZmlsZXNcbiAgICAgICAgJ2ltYWdlL2pwZWcnLCAvLyBKUEVHIGltYWdlc1xuICAgICAgICAnaW1hZ2UvcG5nJywgLy8gUE5HIGltYWdlc1xuICAgICAgXTtcblxuICAgICAgY29uc3QgdmFsaWRhdGlvbiA9IHRoaXMuc3VwYWJhc2VTdG9yYWdlU2VydmljZS52YWxpZGF0ZUZpbGUoXG4gICAgICAgIGZpbGUsXG4gICAgICAgIDUgKiAxMDI0ICogMTAyNCwgLy8gNU1CIGxpbWl0XG4gICAgICAgIGFsbG93ZWRNaW1lVHlwZXMsXG4gICAgICApO1xuXG4gICAgICBpZiAoIXZhbGlkYXRpb24uaXNWYWxpZCkge1xuICAgICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdEV4Y2VwdGlvbihcbiAgICAgICAgICBgRmlsZSB2YWxpZGF0aW9uIGZhaWxlZDogJHt2YWxpZGF0aW9uLmVycm9yfWAsXG4gICAgICAgICk7XG4gICAgICB9XG5cbiAgICAgIC8vIFVwbG9hZCBmaWxlIHRvIFN1cGFiYXNlIFN0b3JhZ2VcbiAgICAgIGNvbnN0IHVwbG9hZFJlc3VsdCA9IGF3YWl0IHRoaXMuc3VwYWJhc2VTdG9yYWdlU2VydmljZS51cGxvYWRGaWxlKFxuICAgICAgICBmaWxlLFxuICAgICAgICBTdXBhYmFzZVN0b3JhZ2VTZXJ2aWNlLmdldFN1cHBvcnRlZEJ1Y2tldHMoKS5XT1JLU0hFRVRTLFxuICAgICAgKTtcblxuICAgICAgLy8gVXBkYXRlIHRoZSB3b3Jrc2hlZXQgd2l0aCB0aGUgbmV3IGZpbGUgaW5mb3JtYXRpb25cbiAgICAgIGlmICh0eXBlID09PSAnbWF0ZXJpYWwnKSB7XG4gICAgICAgIC8vIEFkZCB0byBtYXRlcmlhbCBhcnJheXNcbiAgICAgICAgYXdhaXQgdGhpcy5wcmlzbWEud29ya3NoZWV0LnVwZGF0ZSh7XG4gICAgICAgICAgd2hlcmU6IHsgaWQ6IHdvcmtzaGVldElkIH0sXG4gICAgICAgICAgZGF0YToge1xuICAgICAgICAgICAgbWF0ZXJpYWxVcmxzOiB7XG4gICAgICAgICAgICAgIHB1c2g6IHVwbG9hZFJlc3VsdC51cmwsXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgbWF0ZXJpYWxOYW1lczoge1xuICAgICAgICAgICAgICBwdXNoOiBmaWxlLm9yaWdpbmFsbmFtZSxcbiAgICAgICAgICAgIH0sXG5cbiAgICAgICAgICB9LFxuICAgICAgICB9KTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIC8vIEZvciBzdWJtaXNzaW9ucywgY3JlYXRlIG9yIHVwZGF0ZSBXb3Jrc2hlZXRTdWJtaXNzaW9uXG4gICAgICAgIGNvbnN0IGV4aXN0aW5nU3VibWlzc2lvbiA9IGF3YWl0IHRoaXMucHJpc21hLndvcmtzaGVldFN1Ym1pc3Npb24uZmluZFVuaXF1ZSh7XG4gICAgICAgICAgd2hlcmU6IHsgd29ya3NoZWV0SWQgfSxcbiAgICAgICAgfSk7XG5cbiAgICAgICAgaWYgKGV4aXN0aW5nU3VibWlzc2lvbikge1xuICAgICAgICAgIC8vIFVwZGF0ZSBleGlzdGluZyBzdWJtaXNzaW9uXG4gICAgICAgICAgYXdhaXQgdGhpcy5wcmlzbWEud29ya3NoZWV0U3VibWlzc2lvbi51cGRhdGUoe1xuICAgICAgICAgICAgd2hlcmU6IHsgd29ya3NoZWV0SWQgfSxcbiAgICAgICAgICAgIGRhdGE6IHtcbiAgICAgICAgICAgICAgZmlsZVVybHM6IHtcbiAgICAgICAgICAgICAgICBwdXNoOiB1cGxvYWRSZXN1bHQudXJsLFxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICBmaWxlTmFtZXM6IHtcbiAgICAgICAgICAgICAgICBwdXNoOiBmaWxlLm9yaWdpbmFsbmFtZSxcbiAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgZmlsZVNpemVzOiB7XG4gICAgICAgICAgICAgICAgcHVzaDogZmlsZS5zaXplLFxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAvLyBDcmVhdGUgbmV3IHN1Ym1pc3Npb25cbiAgICAgICAgICBhd2FpdCB0aGlzLnByaXNtYS53b3Jrc2hlZXRTdWJtaXNzaW9uLmNyZWF0ZSh7XG4gICAgICAgICAgICBkYXRhOiB7XG4gICAgICAgICAgICAgIHdvcmtzaGVldElkLFxuICAgICAgICAgICAgICBmaWxlVXJsczogW3VwbG9hZFJlc3VsdC51cmxdLFxuICAgICAgICAgICAgICBmaWxlTmFtZXM6IFtmaWxlLm9yaWdpbmFsbmFtZV0sXG4gICAgICAgICAgICAgIGZpbGVTaXplczogW2ZpbGUuc2l6ZV0sXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIC8vIFJldHVybiB0aGUgZXhwZWN0ZWQgcmVzcG9uc2UgZm9ybWF0XG4gICAgICByZXR1cm4ge1xuICAgICAgICBpZDogdXBsb2FkUmVzdWx0LmZpbGVuYW1lLCAvLyBVc2UgdGhlIHVuaXF1ZSBmaWxlbmFtZSBhcyBJRFxuICAgICAgICBmaWxlbmFtZTogZmlsZS5vcmlnaW5hbG5hbWUsXG4gICAgICAgIHVybDogdXBsb2FkUmVzdWx0LnVybCxcbiAgICAgICAgZmlsZVNpemU6IGZpbGUuc2l6ZSxcbiAgICAgICAgZmlsZVR5cGU6IGZpbGUubWltZXR5cGUsXG4gICAgICB9O1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBpZiAoZXJyb3IgaW5zdGFuY2VvZiBCYWRSZXF1ZXN0RXhjZXB0aW9uKSB7XG4gICAgICAgIHRocm93IGVycm9yO1xuICAgICAgfVxuXG4gICAgICB0aHJvdyBuZXcgSHR0cEV4Y2VwdGlvbihcbiAgICAgICAgYEZhaWxlZCB0byB1cGxvYWQgZmlsZTogJHtlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6ICdVbmtub3duIGVycm9yJ31gLFxuICAgICAgICBIdHRwU3RhdHVzLklOVEVSTkFMX1NFUlZFUl9FUlJPUixcbiAgICAgICk7XG4gICAgfVxuICB9XG59XG4iXSwidmVyc2lvbiI6M30=