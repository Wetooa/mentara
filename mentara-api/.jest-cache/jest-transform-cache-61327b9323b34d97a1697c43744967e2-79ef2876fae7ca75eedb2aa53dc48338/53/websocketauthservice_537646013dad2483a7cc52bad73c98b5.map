{"file":"/home/wetooa/Documents/code/projects/mentara/mentara-api/src/messaging/services/websocket-auth.service.ts","mappings":"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","names":[],"sources":["/home/wetooa/Documents/code/projects/mentara/mentara-api/src/messaging/services/websocket-auth.service.ts"],"sourcesContent":["import { Injectable, Logger } from '@nestjs/common';\nimport { JwtService } from '@nestjs/jwt';\nimport { PrismaService } from 'src/providers/prisma-client.provider';\nimport { Socket } from 'socket.io';\nimport { WsException } from '@nestjs/websockets';\n\nexport interface AuthenticatedUser {\n  userId: string;\n  role?: string;\n  lastAuthenticated?: Date;\n  connectionCount?: number;\n}\n\ninterface ConnectionAttempt {\n  timestamp: Date;\n  success: boolean;\n  ipAddress?: string;\n}\n\n@Injectable()\nexport class WebSocketAuthService {\n  private readonly logger = new Logger(WebSocketAuthService.name);\n  private readonly connectionAttempts = new Map<string, ConnectionAttempt[]>();\n  private readonly authenticatedConnections = new Map<\n    string,\n    AuthenticatedUser\n  >();\n  private readonly MAX_ATTEMPTS_PER_MINUTE = 10;\n  private readonly MAX_CONNECTIONS_PER_USER = 5;\n\n  constructor(\n    private readonly jwtService: JwtService,\n    private readonly prisma: PrismaService,\n  ) {\n    // Clean up connection tracking every 5 minutes\n    setInterval(() => this.cleanupConnectionTracking(), 5 * 60 * 1000);\n  }\n\n  async authenticateSocket(socket: Socket): Promise<AuthenticatedUser | null> {\n    const clientIp = this.getClientIp(socket);\n\n    try {\n      // Rate limiting check\n      if (!this.checkRateLimit(clientIp)) {\n        this.logger.warn(`Rate limit exceeded for IP ${clientIp}`);\n        this.recordConnectionAttempt(clientIp, false);\n        return null;\n      }\n\n      // Extract token from various sources\n      const token = this.extractToken(socket);\n\n      if (!token) {\n        this.logger.warn(`Socket ${socket.id} connected without valid token`);\n        this.recordConnectionAttempt(clientIp, false);\n        return null;\n      }\n\n      // Verify JWT token with additional security checks\n      const payload = this.jwtService.verify(token, {\n        algorithms: ['HS256'], // Restrict to specific algorithm\n      });\n\n      if (!payload.sub || !payload.email) {\n        this.logger.warn(`Socket ${socket.id} has invalid token payload`);\n        this.recordConnectionAttempt(clientIp, false);\n        return null;\n      }\n\n      // Check for token freshness (prevent replay attacks)\n      const tokenAge = Date.now() / 1000 - payload.iat;\n      if (tokenAge > 24 * 60 * 60) {\n        // 24 hours\n        this.logger.warn(`Socket ${socket.id} using stale token`);\n        this.recordConnectionAttempt(clientIp, false);\n        return null;\n      }\n\n      // Check connection limit per user\n      const existingConnections = this.getUserConnectionCount(payload.sub);\n      if (existingConnections >= this.MAX_CONNECTIONS_PER_USER) {\n        this.logger.warn(\n          `User ${payload.sub} exceeded connection limit (${existingConnections})`,\n        );\n        this.recordConnectionAttempt(clientIp, false);\n        return null;\n      }\n\n      // Validate user exists in database and is not deactivated\n      const user = await this.prisma.user.findUnique({\n        where: {\n          id: payload.sub,\n          deactivatedAt: null,\n          isActive: true,\n        },\n        select: {\n          id: true,\n          role: true,\n          emailVerified: true,\n          lockoutUntil: true,\n          failedLoginCount: true,\n        },\n      });\n\n      if (!user) {\n        this.logger.warn(`Socket ${socket.id} user not found or deactivated`);\n        this.recordConnectionAttempt(clientIp, false);\n        return null;\n      }\n\n      // Check if user account is locked\n      if (user.lockoutUntil && user.lockoutUntil > new Date()) {\n        this.logger.warn(\n          `Socket ${socket.id} user account is locked until ${user.lockoutUntil}`,\n        );\n        this.recordConnectionAttempt(clientIp, false);\n        return null;\n      }\n\n      const authenticatedUser: AuthenticatedUser = {\n        userId: user.id,\n        role: user.role,\n        lastAuthenticated: new Date(),\n        connectionCount: existingConnections + 1,\n      };\n\n      // Track successful authentication\n      this.authenticatedConnections.set(socket.id, authenticatedUser);\n      this.recordConnectionAttempt(clientIp, true);\n\n      this.logger.log(\n        `Socket ${socket.id} authenticated as user ${user.id} with role ${user.role} (${authenticatedUser.connectionCount} connections)`,\n      );\n\n      return authenticatedUser;\n    } catch (error) {\n      this.logger.error(\n        `Socket ${socket.id} authentication failed:`,\n        error instanceof Error ? error.message : error,\n      );\n      this.recordConnectionAttempt(clientIp, false);\n      return null;\n    }\n  }\n\n  private extractToken(socket: Socket): string | null {\n    // Try different token sources in order of preference\n\n    // 1. Authorization header (Bearer token)\n    const authHeader = socket.handshake.headers.authorization;\n    if (\n      authHeader &&\n      typeof authHeader === 'string' &&\n      authHeader.startsWith('Bearer ')\n    ) {\n      const token = authHeader.substring(7).trim();\n      return token.length > 0 ? token : null;\n    }\n\n    // 2. Auth object in handshake\n    const authToken = socket.handshake.auth?.token;\n    if (authToken && typeof authToken === 'string') {\n      return authToken;\n    }\n\n    // 3. Query parameter\n    const queryToken = socket.handshake.query?.token;\n    if (queryToken && typeof queryToken === 'string') {\n      return queryToken;\n    }\n\n    // 4. Cookie (for browser connections)\n    const cookies = socket.handshake.headers.cookie;\n    if (cookies) {\n      const sessionCookie = this.extractCookieValue(cookies, '__session');\n      if (sessionCookie) {\n        return sessionCookie;\n      }\n    }\n\n    return null;\n  }\n\n  private extractCookieValue(cookies: string, name: string): string | null {\n    try {\n      // Escape special regex characters in cookie name\n      const escapedName = name.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\\\$&');\n      const match = cookies.match(new RegExp(`(^| )${escapedName}=([^;]+)`));\n      if (match && match[2]) {\n        return decodeURIComponent(match[2]);\n      }\n      return null;\n    } catch (error) {\n      this.logger.warn(`Failed to extract cookie value for ${name}:`, error);\n      return null;\n    }\n  }\n\n  async validateToken(token: string): Promise<boolean> {\n    try {\n      // Simply verify if the JWT token is valid\n      const payload = this.jwtService.verify(token);\n\n      // Additional validation: check if user still exists and is active\n      const user = await this.prisma.user.findUnique({\n        where: {\n          id: payload.sub,\n          deactivatedAt: null,\n        },\n        select: { id: true },\n      });\n\n      return !!user;\n    } catch (error) {\n      this.logger.warn('Token validation failed:', error);\n      return false;\n    }\n  }\n\n  /**\n   * Clean up connection tracking when socket disconnects\n   */\n  cleanupConnection(socketId: string): void {\n    this.authenticatedConnections.delete(socketId);\n  }\n\n  /**\n   * Get client IP address from socket\n   */\n  private getClientIp(socket: Socket): string {\n    return (\n      (socket.handshake.headers['x-forwarded-for'] as string) ||\n      (socket.handshake.headers['x-real-ip'] as string) ||\n      socket.handshake.address ||\n      socket.conn.remoteAddress ||\n      'unknown'\n    );\n  }\n\n  /**\n   * Check rate limiting for connection attempts\n   */\n  private checkRateLimit(ipAddress: string): boolean {\n    const attempts = this.connectionAttempts.get(ipAddress) || [];\n    const oneMinuteAgo = new Date(Date.now() - 60 * 1000);\n\n    // Filter to attempts in the last minute\n    const recentAttempts = attempts.filter(\n      (attempt) => attempt.timestamp > oneMinuteAgo,\n    );\n\n    return recentAttempts.length < this.MAX_ATTEMPTS_PER_MINUTE;\n  }\n\n  /**\n   * Record connection attempt for rate limiting\n   */\n  private recordConnectionAttempt(ipAddress: string, success: boolean): void {\n    if (!this.connectionAttempts.has(ipAddress)) {\n      this.connectionAttempts.set(ipAddress, []);\n    }\n\n    const attempts = this.connectionAttempts.get(ipAddress)!;\n    attempts.push({\n      timestamp: new Date(),\n      success,\n      ipAddress,\n    });\n\n    // Keep only recent attempts\n    const oneHourAgo = new Date(Date.now() - 60 * 60 * 1000);\n    const recentAttempts = attempts.filter(\n      (attempt) => attempt.timestamp > oneHourAgo,\n    );\n    this.connectionAttempts.set(ipAddress, recentAttempts);\n  }\n\n  /**\n   * Get current connection count for a user\n   */\n  private getUserConnectionCount(userId: string): number {\n    return Array.from(this.authenticatedConnections.values()).filter(\n      (user) => user.userId === userId,\n    ).length;\n  }\n\n  /**\n   * Clean up old connection tracking data\n   */\n  private cleanupConnectionTracking(): void {\n    const oneHourAgo = new Date(Date.now() - 60 * 60 * 1000);\n\n    // Clean up connection attempts\n    for (const [ip, attempts] of this.connectionAttempts.entries()) {\n      const recentAttempts = attempts.filter(\n        (attempt) => attempt.timestamp > oneHourAgo,\n      );\n      if (recentAttempts.length === 0) {\n        this.connectionAttempts.delete(ip);\n      } else {\n        this.connectionAttempts.set(ip, recentAttempts);\n      }\n    }\n\n    this.logger.debug('Cleaned up connection tracking data');\n  }\n\n  /**\n   * Get connection statistics for monitoring\n   */\n  getConnectionStats() {\n    return {\n      totalConnections: this.authenticatedConnections.size,\n      uniqueUsers: new Set(\n        Array.from(this.authenticatedConnections.values()).map(\n          (user) => user.userId,\n        ),\n      ).size,\n      trackedIps: this.connectionAttempts.size,\n      maxConnectionsPerUser: this.MAX_CONNECTIONS_PER_USER,\n      maxAttemptsPerMinute: this.MAX_ATTEMPTS_PER_MINUTE,\n    };\n  }\n}\n"],"version":3}