0aaaf8af271701465ef7c74e971ebbbd
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var WebSocketAuthService_1;
var _a, _b;
Object.defineProperty(exports, "__esModule", { value: true });
exports.WebSocketAuthService = void 0;
const common_1 = require("@nestjs/common");
const jwt_1 = require("@nestjs/jwt");
const prisma_client_provider_1 = require("src/providers/prisma-client.provider");
let WebSocketAuthService = WebSocketAuthService_1 = class WebSocketAuthService {
    jwtService;
    prisma;
    logger = new common_1.Logger(WebSocketAuthService_1.name);
    connectionAttempts = new Map();
    authenticatedConnections = new Map();
    MAX_ATTEMPTS_PER_MINUTE = 10;
    MAX_CONNECTIONS_PER_USER = 5;
    constructor(jwtService, prisma) {
        this.jwtService = jwtService;
        this.prisma = prisma;
        // Clean up connection tracking every 5 minutes
        setInterval(() => this.cleanupConnectionTracking(), 5 * 60 * 1000);
    }
    async authenticateSocket(socket) {
        const clientIp = this.getClientIp(socket);
        try {
            // Rate limiting check
            if (!this.checkRateLimit(clientIp)) {
                this.logger.warn(`Rate limit exceeded for IP ${clientIp}`);
                this.recordConnectionAttempt(clientIp, false);
                return null;
            }
            // Extract token from various sources
            const token = this.extractToken(socket);
            if (!token) {
                this.logger.warn(`Socket ${socket.id} connected without valid token`);
                this.recordConnectionAttempt(clientIp, false);
                return null;
            }
            // Verify JWT token with additional security checks
            const payload = this.jwtService.verify(token, {
                algorithms: ['HS256'], // Restrict to specific algorithm
            });
            if (!payload.sub || !payload.email) {
                this.logger.warn(`Socket ${socket.id} has invalid token payload`);
                this.recordConnectionAttempt(clientIp, false);
                return null;
            }
            // Check for token freshness (prevent replay attacks)
            const tokenAge = Date.now() / 1000 - payload.iat;
            if (tokenAge > 24 * 60 * 60) {
                // 24 hours
                this.logger.warn(`Socket ${socket.id} using stale token`);
                this.recordConnectionAttempt(clientIp, false);
                return null;
            }
            // Check connection limit per user
            const existingConnections = this.getUserConnectionCount(payload.sub);
            if (existingConnections >= this.MAX_CONNECTIONS_PER_USER) {
                this.logger.warn(`User ${payload.sub} exceeded connection limit (${existingConnections})`);
                this.recordConnectionAttempt(clientIp, false);
                return null;
            }
            // Validate user exists in database and is not deactivated
            const user = await this.prisma.user.findUnique({
                where: {
                    id: payload.sub,
                    deactivatedAt: null,
                    isActive: true,
                },
                select: {
                    id: true,
                    role: true,
                    emailVerified: true,
                    lockoutUntil: true,
                    failedLoginCount: true,
                },
            });
            if (!user) {
                this.logger.warn(`Socket ${socket.id} user not found or deactivated`);
                this.recordConnectionAttempt(clientIp, false);
                return null;
            }
            // Check if user account is locked
            if (user.lockoutUntil && user.lockoutUntil > new Date()) {
                this.logger.warn(`Socket ${socket.id} user account is locked until ${user.lockoutUntil}`);
                this.recordConnectionAttempt(clientIp, false);
                return null;
            }
            const authenticatedUser = {
                userId: user.id,
                role: user.role,
                lastAuthenticated: new Date(),
                connectionCount: existingConnections + 1,
            };
            // Track successful authentication
            this.authenticatedConnections.set(socket.id, authenticatedUser);
            this.recordConnectionAttempt(clientIp, true);
            this.logger.log(`Socket ${socket.id} authenticated as user ${user.id} with role ${user.role} (${authenticatedUser.connectionCount} connections)`);
            return authenticatedUser;
        }
        catch (error) {
            this.logger.error(`Socket ${socket.id} authentication failed:`, error instanceof Error ? error.message : error);
            this.recordConnectionAttempt(clientIp, false);
            return null;
        }
    }
    extractToken(socket) {
        // Try different token sources in order of preference
        // 1. Authorization header (Bearer token)
        const authHeader = socket.handshake.headers.authorization;
        if (authHeader &&
            typeof authHeader === 'string' &&
            authHeader.startsWith('Bearer ')) {
            const token = authHeader.substring(7).trim();
            return token.length > 0 ? token : null;
        }
        // 2. Auth object in handshake
        const authToken = socket.handshake.auth?.token;
        if (authToken && typeof authToken === 'string') {
            return authToken;
        }
        // 3. Query parameter
        const queryToken = socket.handshake.query?.token;
        if (queryToken && typeof queryToken === 'string') {
            return queryToken;
        }
        // 4. Cookie (for browser connections)
        const cookies = socket.handshake.headers.cookie;
        if (cookies) {
            const sessionCookie = this.extractCookieValue(cookies, '__session');
            if (sessionCookie) {
                return sessionCookie;
            }
        }
        return null;
    }
    extractCookieValue(cookies, name) {
        try {
            // Escape special regex characters in cookie name
            const escapedName = name.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            const match = cookies.match(new RegExp(`(^| )${escapedName}=([^;]+)`));
            if (match && match[2]) {
                return decodeURIComponent(match[2]);
            }
            return null;
        }
        catch (error) {
            this.logger.warn(`Failed to extract cookie value for ${name}:`, error);
            return null;
        }
    }
    async validateToken(token) {
        try {
            // Simply verify if the JWT token is valid
            const payload = this.jwtService.verify(token);
            // Additional validation: check if user still exists and is active
            const user = await this.prisma.user.findUnique({
                where: {
                    id: payload.sub,
                    deactivatedAt: null,
                },
                select: { id: true },
            });
            return !!user;
        }
        catch (error) {
            this.logger.warn('Token validation failed:', error);
            return false;
        }
    }
    /**
     * Clean up connection tracking when socket disconnects
     */
    cleanupConnection(socketId) {
        this.authenticatedConnections.delete(socketId);
    }
    /**
     * Get client IP address from socket
     */
    getClientIp(socket) {
        return (socket.handshake.headers['x-forwarded-for'] ||
            socket.handshake.headers['x-real-ip'] ||
            socket.handshake.address ||
            socket.conn.remoteAddress ||
            'unknown');
    }
    /**
     * Check rate limiting for connection attempts
     */
    checkRateLimit(ipAddress) {
        const attempts = this.connectionAttempts.get(ipAddress) || [];
        const oneMinuteAgo = new Date(Date.now() - 60 * 1000);
        // Filter to attempts in the last minute
        const recentAttempts = attempts.filter((attempt) => attempt.timestamp > oneMinuteAgo);
        return recentAttempts.length < this.MAX_ATTEMPTS_PER_MINUTE;
    }
    /**
     * Record connection attempt for rate limiting
     */
    recordConnectionAttempt(ipAddress, success) {
        if (!this.connectionAttempts.has(ipAddress)) {
            this.connectionAttempts.set(ipAddress, []);
        }
        const attempts = this.connectionAttempts.get(ipAddress);
        attempts.push({
            timestamp: new Date(),
            success,
            ipAddress,
        });
        // Keep only recent attempts
        const oneHourAgo = new Date(Date.now() - 60 * 60 * 1000);
        const recentAttempts = attempts.filter((attempt) => attempt.timestamp > oneHourAgo);
        this.connectionAttempts.set(ipAddress, recentAttempts);
    }
    /**
     * Get current connection count for a user
     */
    getUserConnectionCount(userId) {
        return Array.from(this.authenticatedConnections.values()).filter((user) => user.userId === userId).length;
    }
    /**
     * Clean up old connection tracking data
     */
    cleanupConnectionTracking() {
        const oneHourAgo = new Date(Date.now() - 60 * 60 * 1000);
        // Clean up connection attempts
        for (const [ip, attempts] of this.connectionAttempts.entries()) {
            const recentAttempts = attempts.filter((attempt) => attempt.timestamp > oneHourAgo);
            if (recentAttempts.length === 0) {
                this.connectionAttempts.delete(ip);
            }
            else {
                this.connectionAttempts.set(ip, recentAttempts);
            }
        }
        this.logger.debug('Cleaned up connection tracking data');
    }
    /**
     * Get connection statistics for monitoring
     */
    getConnectionStats() {
        return {
            totalConnections: this.authenticatedConnections.size,
            uniqueUsers: new Set(Array.from(this.authenticatedConnections.values()).map((user) => user.userId)).size,
            trackedIps: this.connectionAttempts.size,
            maxConnectionsPerUser: this.MAX_CONNECTIONS_PER_USER,
            maxAttemptsPerMinute: this.MAX_ATTEMPTS_PER_MINUTE,
        };
    }
};
exports.WebSocketAuthService = WebSocketAuthService;
exports.WebSocketAuthService = WebSocketAuthService = WebSocketAuthService_1 = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [typeof (_a = typeof jwt_1.JwtService !== "undefined" && jwt_1.JwtService) === "function" ? _a : Object, typeof (_b = typeof prisma_client_provider_1.PrismaService !== "undefined" && prisma_client_provider_1.PrismaService) === "function" ? _b : Object])
], WebSocketAuthService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL21lc3NhZ2luZy9zZXJ2aWNlcy93ZWJzb2NrZXQtYXV0aC5zZXJ2aWNlLnRzIiwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7O0FBQUEsMkNBQW9EO0FBQ3BELHFDQUF5QztBQUN6QyxpRkFBcUU7QUFrQjlELElBQU0sb0JBQW9CLDRCQUExQixNQUFNLG9CQUFvQjtJQVdaO0lBQ0E7SUFYRixNQUFNLEdBQUcsSUFBSSxlQUFNLENBQUMsc0JBQW9CLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDL0Msa0JBQWtCLEdBQUcsSUFBSSxHQUFHLEVBQStCLENBQUM7SUFDNUQsd0JBQXdCLEdBQUcsSUFBSSxHQUFHLEVBR2hELENBQUM7SUFDYSx1QkFBdUIsR0FBRyxFQUFFLENBQUM7SUFDN0Isd0JBQXdCLEdBQUcsQ0FBQyxDQUFDO0lBRTlDLFlBQ21CLFVBQXNCLEVBQ3RCLE1BQXFCO1FBRHJCLGVBQVUsR0FBVixVQUFVLENBQVk7UUFDdEIsV0FBTSxHQUFOLE1BQU0sQ0FBZTtRQUV0QywrQ0FBK0M7UUFDL0MsV0FBVyxDQUFDLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQyx5QkFBeUIsRUFBRSxFQUFFLENBQUMsR0FBRyxFQUFFLEdBQUcsSUFBSSxDQUFDLENBQUM7SUFDckUsQ0FBQztJQUVELEtBQUssQ0FBQyxrQkFBa0IsQ0FBQyxNQUFjO1FBQ3JDLE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsTUFBTSxDQUFDLENBQUM7UUFFMUMsSUFBSSxDQUFDO1lBQ0gsc0JBQXNCO1lBQ3RCLElBQUksQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUM7Z0JBQ25DLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLDhCQUE4QixRQUFRLEVBQUUsQ0FBQyxDQUFDO2dCQUMzRCxJQUFJLENBQUMsdUJBQXVCLENBQUMsUUFBUSxFQUFFLEtBQUssQ0FB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O1NBQ25ELENBQUM7SUFDSixDQUFDO0NBQ0YsQ0FBQTtBQS9TWSxvREFBb0I7K0JBQXBCLG9CQUFvQjtJQURoQyxJQUFBLG1CQUFVLEdBQUU7eURBWW9CLGdCQUFVLG9CQUFWLGdCQUFVLG9EQUNkLHNDQUFhLG9CQUFiLHNDQUFhO0dBWjdCLG9CQUFvQixDQStTaEMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL21lc3NhZ2luZy9zZXJ2aWNlcy93ZWJzb2NrZXQtYXV0aC5zZXJ2aWNlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUsIExvZ2dlciB9IGZyb20gJ0BuZXN0anMvY29tbW9uJztcbmltcG9ydCB7IEp3dFNlcnZpY2UgfSBmcm9tICdAbmVzdGpzL2p3dCc7XG5pbXBvcnQgeyBQcmlzbWFTZXJ2aWNlIH0gZnJvbSAnc3JjL3Byb3ZpZGVycy9wcmlzbWEtY2xpZW50LnByb3ZpZGVyJztcbmltcG9ydCB7IFNvY2tldCB9IGZyb20gJ3NvY2tldC5pbyc7XG5pbXBvcnQgeyBXc0V4Y2VwdGlvbiB9IGZyb20gJ0BuZXN0anMvd2Vic29ja2V0cyc7XG5cbmV4cG9ydCBpbnRlcmZhY2UgQXV0aGVudGljYXRlZFVzZXIge1xuICB1c2VySWQ6IHN0cmluZztcbiAgcm9sZT86IHN0cmluZztcbiAgbGFzdEF1dGhlbnRpY2F0ZWQ/OiBEYXRlO1xuICBjb25uZWN0aW9uQ291bnQ/OiBudW1iZXI7XG59XG5cbmludGVyZmFjZSBDb25uZWN0aW9uQXR0ZW1wdCB7XG4gIHRpbWVzdGFtcDogRGF0ZTtcbiAgc3VjY2VzczogYm9vbGVhbjtcbiAgaXBBZGRyZXNzPzogc3RyaW5nO1xufVxuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgV2ViU29ja2V0QXV0aFNlcnZpY2Uge1xuICBwcml2YXRlIHJlYWRvbmx5IGxvZ2dlciA9IG5ldyBMb2dnZXIoV2ViU29ja2V0QXV0aFNlcnZpY2UubmFtZSk7XG4gIHByaXZhdGUgcmVhZG9ubHkgY29ubmVjdGlvbkF0dGVtcHRzID0gbmV3IE1hcDxzdHJpbmcsIENvbm5lY3Rpb25BdHRlbXB0W10+KCk7XG4gIHByaXZhdGUgcmVhZG9ubHkgYXV0aGVudGljYXRlZENvbm5lY3Rpb25zID0gbmV3IE1hcDxcbiAgICBzdHJpbmcsXG4gICAgQXV0aGVudGljYXRlZFVzZXJcbiAgPigpO1xuICBwcml2YXRlIHJlYWRvbmx5IE1BWF9BVFRFTVBUU19QRVJfTUlOVVRFID0gMTA7XG4gIHByaXZhdGUgcmVhZG9ubHkgTUFYX0NPTk5FQ1RJT05TX1BFUl9VU0VSID0gNTtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHJlYWRvbmx5IGp3dFNlcnZpY2U6IEp3dFNlcnZpY2UsXG4gICAgcHJpdmF0ZSByZWFkb25seSBwcmlzbWE6IFByaXNtYVNlcnZpY2UsXG4gICkge1xuICAgIC8vIENsZWFuIHVwIGNvbm5lY3Rpb24gdHJhY2tpbmcgZXZlcnkgNSBtaW51dGVzXG4gICAgc2V0SW50ZXJ2YWwoKCkgPT4gdGhpcy5jbGVhbnVwQ29ubmVjdGlvblRyYWNraW5nKCksIDUgKiA2MCAqIDEwMDApO1xuICB9XG5cbiAgYXN5bmMgYXV0aGVudGljYXRlU29ja2V0KHNvY2tldDogU29ja2V0KTogUHJvbWlzZTxBdXRoZW50aWNhdGVkVXNlciB8IG51bGw+IHtcbiAgICBjb25zdCBjbGllbnRJcCA9IHRoaXMuZ2V0Q2xpZW50SXAoc29ja2V0KTtcblxuICAgIHRyeSB7XG4gICAgICAvLyBSYXRlIGxpbWl0aW5nIGNoZWNrXG4gICAgICBpZiAoIXRoaXMuY2hlY2tSYXRlTGltaXQoY2xpZW50SXApKSB7XG4gICAgICAgIHRoaXMubG9nZ2VyLndhcm4oYFJhdGUgbGltaXQgZXhjZWVkZWQgZm9yIElQICR7Y2xpZW50SXB9YCk7XG4gICAgICAgIHRoaXMucmVjb3JkQ29ubmVjdGlvbkF0dGVtcHQoY2xpZW50SXAsIGZhbHNlKTtcbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICB9XG5cbiAgICAgIC8vIEV4dHJhY3QgdG9rZW4gZnJvbSB2YXJpb3VzIHNvdXJjZXNcbiAgICAgIGNvbnN0IHRva2VuID0gdGhpcy5leHRyYWN0VG9rZW4oc29ja2V0KTtcblxuICAgICAgaWYgKCF0b2tlbikge1xuICAgICAgICB0aGlzLmxvZ2dlci53YXJuKGBTb2NrZXQgJHtzb2NrZXQuaWR9IGNvbm5lY3RlZCB3aXRob3V0IHZhbGlkIHRva2VuYCk7XG4gICAgICAgIHRoaXMucmVjb3JkQ29ubmVjdGlvbkF0dGVtcHQoY2xpZW50SXAsIGZhbHNlKTtcbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICB9XG5cbiAgICAgIC8vIFZlcmlmeSBKV1QgdG9rZW4gd2l0aCBhZGRpdGlvbmFsIHNlY3VyaXR5IGNoZWNrc1xuICAgICAgY29uc3QgcGF5bG9hZCA9IHRoaXMuand0U2VydmljZS52ZXJpZnkodG9rZW4sIHtcbiAgICAgICAgYWxnb3JpdGhtczogWydIUzI1NiddLCAvLyBSZXN0cmljdCB0byBzcGVjaWZpYyBhbGdvcml0aG1cbiAgICAgIH0pO1xuXG4gICAgICBpZiAoIXBheWxvYWQuc3ViIHx8ICFwYXlsb2FkLmVtYWlsKSB7XG4gICAgICAgIHRoaXMubG9nZ2VyLndhcm4oYFNvY2tldCAke3NvY2tldC5pZH0gaGFzIGludmFsaWQgdG9rZW4gcGF5bG9hZGApO1xuICAgICAgICB0aGlzLnJlY29yZENvbm5lY3Rpb25BdHRlbXB0KGNsaWVudElwLCBmYWxzZSk7XG4gICAgICAgIHJldHVybiBudWxsO1xuICAgICAgfVxuXG4gICAgICAvLyBDaGVjayBmb3IgdG9rZW4gZnJlc2huZXNzIChwcmV2ZW50IHJlcGxheSBhdHRhY2tzKVxuICAgICAgY29uc3QgdG9rZW5BZ2UgPSBEYXRlLm5vdygpIC8gMTAwMCAtIHBheWxvYWQuaWF0O1xuICAgICAgaWYgKHRva2VuQWdlID4gMjQgKiA2MCAqIDYwKSB7XG4gICAgICAgIC8vIDI0IGhvdXJzXG4gICAgICAgIHRoaXMubG9nZ2VyLndhcm4oYFNvY2tldCAke3NvY2tldC5pZH0gdXNpbmcgc3RhbGUgdG9rZW5gKTtcbiAgICAgICAgdGhpcy5yZWNvcmRDb25uZWN0aW9uQXR0ZW1wdChjbGllbnRJcCwgZmFsc2UpO1xuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgIH1cblxuICAgICAgLy8gQ2hlY2sgY29ubmVjdGlvbiBsaW1pdCBwZXIgdXNlclxuICAgICAgY29uc3QgZXhpc3RpbmdDb25uZWN0aW9ucyA9IHRoaXMuZ2V0VXNlckNvbm5lY3Rpb25Db3VudChwYXlsb2FkLnN1Yik7XG4gICAgICBpZiAoZXhpc3RpbmdDb25uZWN0aW9ucyA+PSB0aGlzLk1BWF9DT05ORUNUSU9OU19QRVJfVVNFUikge1xuICAgICAgICB0aGlzLmxvZ2dlci53YXJuKFxuICAgICAgICAgIGBVc2VyICR7cGF5bG9hZC5zdWJ9IGV4Y2VlZGVkIGNvbm5lY3Rpb24gbGltaXQgKCR7ZXhpc3RpbmdDb25uZWN0aW9uc30pYCxcbiAgICAgICAgKTtcbiAgICAgICAgdGhpcy5yZWNvcmRDb25uZWN0aW9uQXR0ZW1wdChjbGllbnRJcCwgZmFsc2UpO1xuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgIH1cblxuICAgICAgLy8gVmFsaWRhdGUgdXNlciBleGlzdHMgaW4gZGF0YWJhc2UgYW5kIGlzIG5vdCBkZWFjdGl2YXRlZFxuICAgICAgY29uc3QgdXNlciA9IGF3YWl0IHRoaXMucHJpc21hLnVzZXIuZmluZFVuaXF1ZSh7XG4gICAgICAgIHdoZXJlOiB7XG4gICAgICAgICAgaWQ6IHBheWxvYWQuc3ViLFxuICAgICAgICAgIGRlYWN0aXZhdGVkQXQ6IG51bGwsXG4gICAgICAgICAgaXNBY3RpdmU6IHRydWUsXG4gICAgICAgIH0sXG4gICAgICAgIHNlbGVjdDoge1xuICAgICAgICAgIGlkOiB0cnVlLFxuICAgICAgICAgIHJvbGU6IHRydWUsXG4gICAgICAgICAgZW1haWxWZXJpZmllZDogdHJ1ZSxcbiAgICAgICAgICBsb2Nrb3V0VW50aWw6IHRydWUsXG4gICAgICAgICAgZmFpbGVkTG9naW5Db3VudDogdHJ1ZSxcbiAgICAgICAgfSxcbiAgICAgIH0pO1xuXG4gICAgICBpZiAoIXVzZXIpIHtcbiAgICAgICAgdGhpcy5sb2dnZXIud2FybihgU29ja2V0ICR7c29ja2V0LmlkfSB1c2VyIG5vdCBmb3VuZCBvciBkZWFjdGl2YXRlZGApO1xuICAgICAgICB0aGlzLnJlY29yZENvbm5lY3Rpb25BdHRlbXB0KGNsaWVudElwLCBmYWxzZSk7XG4gICAgICAgIHJldHVybiBudWxsO1xuICAgICAgfVxuXG4gICAgICAvLyBDaGVjayBpZiB1c2VyIGFjY291bnQgaXMgbG9ja2VkXG4gICAgICBpZiAodXNlci5sb2Nrb3V0VW50aWwgJiYgdXNlci5sb2Nrb3V0VW50aWwgPiBuZXcgRGF0ZSgpKSB7XG4gICAgICAgIHRoaXMubG9nZ2VyLndhcm4oXG4gICAgICAgICAgYFNvY2tldCAke3NvY2tldC5pZH0gdXNlciBhY2NvdW50IGlzIGxvY2tlZCB1bnRpbCAke3VzZXIubG9ja291dFVudGlsfWAsXG4gICAgICAgICk7XG4gICAgICAgIHRoaXMucmVjb3JkQ29ubmVjdGlvbkF0dGVtcHQoY2xpZW50SXAsIGZhbHNlKTtcbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IGF1dGhlbnRpY2F0ZWRVc2VyOiBBdXRoZW50aWNhdGVkVXNlciA9IHtcbiAgICAgICAgdXNlcklkOiB1c2VyLmlkLFxuICAgICAgICByb2xlOiB1c2VyLnJvbGUsXG4gICAgICAgIGxhc3RBdXRoZW50aWNhdGVkOiBuZXcgRGF0ZSgpLFxuICAgICAgICBjb25uZWN0aW9uQ291bnQ6IGV4aXN0aW5nQ29ubmVjdGlvbnMgKyAxLFxuICAgICAgfTtcblxuICAgICAgLy8gVHJhY2sgc3VjY2Vzc2Z1bCBhdXRoZW50aWNhdGlvblxuICAgICAgdGhpcy5hdXRoZW50aWNhdGVkQ29ubmVjdGlvbnMuc2V0KHNvY2tldC5pZCwgYXV0aGVudGljYXRlZFVzZXIpO1xuICAgICAgdGhpcy5yZWNvcmRDb25uZWN0aW9uQXR0ZW1wdChjbGllbnRJcCwgdHJ1ZSk7XG5cbiAgICAgIHRoaXMubG9nZ2VyLmxvZyhcbiAgICAgICAgYFNvY2tldCAke3NvY2tldC5pZH0gYXV0aGVudGljYXRlZCBhcyB1c2VyICR7dXNlci5pZH0gd2l0aCByb2xlICR7dXNlci5yb2xlfSAoJHthdXRoZW50aWNhdGVkVXNlci5jb25uZWN0aW9uQ291bnR9IGNvbm5lY3Rpb25zKWAsXG4gICAgICApO1xuXG4gICAgICByZXR1cm4gYXV0aGVudGljYXRlZFVzZXI7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRoaXMubG9nZ2VyLmVycm9yKFxuICAgICAgICBgU29ja2V0ICR7c29ja2V0LmlkfSBhdXRoZW50aWNhdGlvbiBmYWlsZWQ6YCxcbiAgICAgICAgZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiBlcnJvcixcbiAgICAgICk7XG4gICAgICB0aGlzLnJlY29yZENvbm5lY3Rpb25BdHRlbXB0KGNsaWVudElwLCBmYWxzZSk7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGV4dHJhY3RUb2tlbihzb2NrZXQ6IFNvY2tldCk6IHN0cmluZyB8IG51bGwge1xuICAgIC8vIFRyeSBkaWZmZXJlbnQgdG9rZW4gc291cmNlcyBpbiBvcmRlciBvZiBwcmVmZXJlbmNlXG5cbiAgICAvLyAxLiBBdXRob3JpemF0aW9uIGhlYWRlciAoQmVhcmVyIHRva2VuKVxuICAgIGNvbnN0IGF1dGhIZWFkZXIgPSBzb2NrZXQuaGFuZHNoYWtlLmhlYWRlcnMuYXV0aG9yaXphdGlvbjtcbiAgICBpZiAoXG4gICAgICBhdXRoSGVhZGVyICYmXG4gICAgICB0eXBlb2YgYXV0aEhlYWRlciA9PT0gJ3N0cmluZycgJiZcbiAgICAgIGF1dGhIZWFkZXIuc3RhcnRzV2l0aCgnQmVhcmVyICcpXG4gICAgKSB7XG4gICAgICBjb25zdCB0b2tlbiA9IGF1dGhIZWFkZXIuc3Vic3RyaW5nKDcpLnRyaW0oKTtcbiAgICAgIHJldHVybiB0b2tlbi5sZW5ndGggPiAwID8gdG9rZW4gOiBudWxsO1xuICAgIH1cblxuICAgIC8vIDIuIEF1dGggb2JqZWN0IGluIGhhbmRzaGFrZVxuICAgIGNvbnN0IGF1dGhUb2tlbiA9IHNvY2tldC5oYW5kc2hha2UuYXV0aD8udG9rZW47XG4gICAgaWYgKGF1dGhUb2tlbiAmJiB0eXBlb2YgYXV0aFRva2VuID09PSAnc3RyaW5nJykge1xuICAgICAgcmV0dXJuIGF1dGhUb2tlbjtcbiAgICB9XG5cbiAgICAvLyAzLiBRdWVyeSBwYXJhbWV0ZXJcbiAgICBjb25zdCBxdWVyeVRva2VuID0gc29ja2V0LmhhbmRzaGFrZS5xdWVyeT8udG9rZW47XG4gICAgaWYgKHF1ZXJ5VG9rZW4gJiYgdHlwZW9mIHF1ZXJ5VG9rZW4gPT09ICdzdHJpbmcnKSB7XG4gICAgICByZXR1cm4gcXVlcnlUb2tlbjtcbiAgICB9XG5cbiAgICAvLyA0LiBDb29raWUgKGZvciBicm93c2VyIGNvbm5lY3Rpb25zKVxuICAgIGNvbnN0IGNvb2tpZXMgPSBzb2NrZXQuaGFuZHNoYWtlLmhlYWRlcnMuY29va2llO1xuICAgIGlmIChjb29raWVzKSB7XG4gICAgICBjb25zdCBzZXNzaW9uQ29va2llID0gdGhpcy5leHRyYWN0Q29va2llVmFsdWUoY29va2llcywgJ19fc2Vzc2lvbicpO1xuICAgICAgaWYgKHNlc3Npb25Db29raWUpIHtcbiAgICAgICAgcmV0dXJuIHNlc3Npb25Db29raWU7XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIG51bGw7XG4gIH1cblxuICBwcml2YXRlIGV4dHJhY3RDb29raWVWYWx1ZShjb29raWVzOiBzdHJpbmcsIG5hbWU6IHN0cmluZyk6IHN0cmluZyB8IG51bGwge1xuICAgIHRyeSB7XG4gICAgICAvLyBFc2NhcGUgc3BlY2lhbCByZWdleCBjaGFyYWN0ZXJzIGluIGNvb2tpZSBuYW1lXG4gICAgICBjb25zdCBlc2NhcGVkTmFtZSA9IG5hbWUucmVwbGFjZSgvWy4qKz9eJHt9KCl8W1xcXVxcXFxdL2csICdcXFxcJCYnKTtcbiAgICAgIGNvbnN0IG1hdGNoID0gY29va2llcy5tYXRjaChuZXcgUmVnRXhwKGAoXnwgKSR7ZXNjYXBlZE5hbWV9PShbXjtdKylgKSk7XG4gICAgICBpZiAobWF0Y2ggJiYgbWF0Y2hbMl0pIHtcbiAgICAgICAgcmV0dXJuIGRlY29kZVVSSUNvbXBvbmVudChtYXRjaFsyXSk7XG4gICAgICB9XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhpcy5sb2dnZXIud2FybihgRmFpbGVkIHRvIGV4dHJhY3QgY29va2llIHZhbHVlIGZvciAke25hbWV9OmAsIGVycm9yKTtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIHZhbGlkYXRlVG9rZW4odG9rZW46IHN0cmluZyk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgIHRyeSB7XG4gICAgICAvLyBTaW1wbHkgdmVyaWZ5IGlmIHRoZSBKV1QgdG9rZW4gaXMgdmFsaWRcbiAgICAgIGNvbnN0IHBheWxvYWQgPSB0aGlzLmp3dFNlcnZpY2UudmVyaWZ5KHRva2VuKTtcblxuICAgICAgLy8gQWRkaXRpb25hbCB2YWxpZGF0aW9uOiBjaGVjayBpZiB1c2VyIHN0aWxsIGV4aXN0cyBhbmQgaXMgYWN0aXZlXG4gICAgICBjb25zdCB1c2VyID0gYXdhaXQgdGhpcy5wcmlzbWEudXNlci5maW5kVW5pcXVlKHtcbiAgICAgICAgd2hlcmU6IHtcbiAgICAgICAgICBpZDogcGF5bG9hZC5zdWIsXG4gICAgICAgICAgZGVhY3RpdmF0ZWRBdDogbnVsbCxcbiAgICAgICAgfSxcbiAgICAgICAgc2VsZWN0OiB7IGlkOiB0cnVlIH0sXG4gICAgICB9KTtcblxuICAgICAgcmV0dXJuICEhdXNlcjtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhpcy5sb2dnZXIud2FybignVG9rZW4gdmFsaWRhdGlvbiBmYWlsZWQ6JywgZXJyb3IpO1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBDbGVhbiB1cCBjb25uZWN0aW9uIHRyYWNraW5nIHdoZW4gc29ja2V0IGRpc2Nvbm5lY3RzXG4gICAqL1xuICBjbGVhbnVwQ29ubmVjdGlvbihzb2NrZXRJZDogc3RyaW5nKTogdm9pZCB7XG4gICAgdGhpcy5hdXRoZW50aWNhdGVkQ29ubmVjdGlvbnMuZGVsZXRlKHNvY2tldElkKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgY2xpZW50IElQIGFkZHJlc3MgZnJvbSBzb2NrZXRcbiAgICovXG4gIHByaXZhdGUgZ2V0Q2xpZW50SXAoc29ja2V0OiBTb2NrZXQpOiBzdHJpbmcge1xuICAgIHJldHVybiAoXG4gICAgICAoc29ja2V0LmhhbmRzaGFrZS5oZWFkZXJzWyd4LWZvcndhcmRlZC1mb3InXSBhcyBzdHJpbmcpIHx8XG4gICAgICAoc29ja2V0LmhhbmRzaGFrZS5oZWFkZXJzWyd4LXJlYWwtaXAnXSBhcyBzdHJpbmcpIHx8XG4gICAgICBzb2NrZXQuaGFuZHNoYWtlLmFkZHJlc3MgfHxcbiAgICAgIHNvY2tldC5jb25uLnJlbW90ZUFkZHJlc3MgfHxcbiAgICAgICd1bmtub3duJ1xuICAgICk7XG4gIH1cblxuICAvKipcbiAgICogQ2hlY2sgcmF0ZSBsaW1pdGluZyBmb3IgY29ubmVjdGlvbiBhdHRlbXB0c1xuICAgKi9cbiAgcHJpdmF0ZSBjaGVja1JhdGVMaW1pdChpcEFkZHJlc3M6IHN0cmluZyk6IGJvb2xlYW4ge1xuICAgIGNvbnN0IGF0dGVtcHRzID0gdGhpcy5jb25uZWN0aW9uQXR0ZW1wdHMuZ2V0KGlwQWRkcmVzcykgfHwgW107XG4gICAgY29uc3Qgb25lTWludXRlQWdvID0gbmV3IERhdGUoRGF0ZS5ub3coKSAtIDYwICogMTAwMCk7XG5cbiAgICAvLyBGaWx0ZXIgdG8gYXR0ZW1wdHMgaW4gdGhlIGxhc3QgbWludXRlXG4gICAgY29uc3QgcmVjZW50QXR0ZW1wdHMgPSBhdHRlbXB0cy5maWx0ZXIoXG4gICAgICAoYXR0ZW1wdCkgPT4gYXR0ZW1wdC50aW1lc3RhbXAgPiBvbmVNaW51dGVBZ28sXG4gICAgKTtcblxuICAgIHJldHVybiByZWNlbnRBdHRlbXB0cy5sZW5ndGggPCB0aGlzLk1BWF9BVFRFTVBUU19QRVJfTUlOVVRFO1xuICB9XG5cbiAgLyoqXG4gICAqIFJlY29yZCBjb25uZWN0aW9uIGF0dGVtcHQgZm9yIHJhdGUgbGltaXRpbmdcbiAgICovXG4gIHByaXZhdGUgcmVjb3JkQ29ubmVjdGlvbkF0dGVtcHQoaXBBZGRyZXNzOiBzdHJpbmcsIHN1Y2Nlc3M6IGJvb2xlYW4pOiB2b2lkIHtcbiAgICBpZiAoIXRoaXMuY29ubmVjdGlvbkF0dGVtcHRzLmhhcyhpcEFkZHJlc3MpKSB7XG4gICAgICB0aGlzLmNvbm5lY3Rpb25BdHRlbXB0cy5zZXQoaXBBZGRyZXNzLCBbXSk7XG4gICAgfVxuXG4gICAgY29uc3QgYXR0ZW1wdHMgPSB0aGlzLmNvbm5lY3Rpb25BdHRlbXB0cy5nZXQoaXBBZGRyZXNzKSE7XG4gICAgYXR0ZW1wdHMucHVzaCh7XG4gICAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKCksXG4gICAgICBzdWNjZXNzLFxuICAgICAgaXBBZGRyZXNzLFxuICAgIH0pO1xuXG4gICAgLy8gS2VlcCBvbmx5IHJlY2VudCBhdHRlbXB0c1xuICAgIGNvbnN0IG9uZUhvdXJBZ28gPSBuZXcgRGF0ZShEYXRlLm5vdygpIC0gNjAgKiA2MCAqIDEwMDApO1xuICAgIGNvbnN0IHJlY2VudEF0dGVtcHRzID0gYXR0ZW1wdHMuZmlsdGVyKFxuICAgICAgKGF0dGVtcHQpID0+IGF0dGVtcHQudGltZXN0YW1wID4gb25lSG91ckFnbyxcbiAgICApO1xuICAgIHRoaXMuY29ubmVjdGlvbkF0dGVtcHRzLnNldChpcEFkZHJlc3MsIHJlY2VudEF0dGVtcHRzKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgY3VycmVudCBjb25uZWN0aW9uIGNvdW50IGZvciBhIHVzZXJcbiAgICovXG4gIHByaXZhdGUgZ2V0VXNlckNvbm5lY3Rpb25Db3VudCh1c2VySWQ6IHN0cmluZyk6IG51bWJlciB7XG4gICAgcmV0dXJuIEFycmF5LmZyb20odGhpcy5hdXRoZW50aWNhdGVkQ29ubmVjdGlvbnMudmFsdWVzKCkpLmZpbHRlcihcbiAgICAgICh1c2VyKSA9PiB1c2VyLnVzZXJJZCA9PT0gdXNlcklkLFxuICAgICkubGVuZ3RoO1xuICB9XG5cbiAgLyoqXG4gICAqIENsZWFuIHVwIG9sZCBjb25uZWN0aW9uIHRyYWNraW5nIGRhdGFcbiAgICovXG4gIHByaXZhdGUgY2xlYW51cENvbm5lY3Rpb25UcmFja2luZygpOiB2b2lkIHtcbiAgICBjb25zdCBvbmVIb3VyQWdvID0gbmV3IERhdGUoRGF0ZS5ub3coKSAtIDYwICogNjAgKiAxMDAwKTtcblxuICAgIC8vIENsZWFuIHVwIGNvbm5lY3Rpb24gYXR0ZW1wdHNcbiAgICBmb3IgKGNvbnN0IFtpcCwgYXR0ZW1wdHNdIG9mIHRoaXMuY29ubmVjdGlvbkF0dGVtcHRzLmVudHJpZXMoKSkge1xuICAgICAgY29uc3QgcmVjZW50QXR0ZW1wdHMgPSBhdHRlbXB0cy5maWx0ZXIoXG4gICAgICAgIChhdHRlbXB0KSA9PiBhdHRlbXB0LnRpbWVzdGFtcCA+IG9uZUhvdXJBZ28sXG4gICAgICApO1xuICAgICAgaWYgKHJlY2VudEF0dGVtcHRzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICB0aGlzLmNvbm5lY3Rpb25BdHRlbXB0cy5kZWxldGUoaXApO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5jb25uZWN0aW9uQXR0ZW1wdHMuc2V0KGlwLCByZWNlbnRBdHRlbXB0cyk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgdGhpcy5sb2dnZXIuZGVidWcoJ0NsZWFuZWQgdXAgY29ubmVjdGlvbiB0cmFja2luZyBkYXRhJyk7XG4gIH1cblxuICAvKipcbiAgICogR2V0IGNvbm5lY3Rpb24gc3RhdGlzdGljcyBmb3IgbW9uaXRvcmluZ1xuICAgKi9cbiAgZ2V0Q29ubmVjdGlvblN0YXRzKCkge1xuICAgIHJldHVybiB7XG4gICAgICB0b3RhbENvbm5lY3Rpb25zOiB0aGlzLmF1dGhlbnRpY2F0ZWRDb25uZWN0aW9ucy5zaXplLFxuICAgICAgdW5pcXVlVXNlcnM6IG5ldyBTZXQoXG4gICAgICAgIEFycmF5LmZyb20odGhpcy5hdXRoZW50aWNhdGVkQ29ubmVjdGlvbnMudmFsdWVzKCkpLm1hcChcbiAgICAgICAgICAodXNlcikgPT4gdXNlci51c2VySWQsXG4gICAgICAgICksXG4gICAgICApLnNpemUsXG4gICAgICB0cmFja2VkSXBzOiB0aGlzLmNvbm5lY3Rpb25BdHRlbXB0cy5zaXplLFxuICAgICAgbWF4Q29ubmVjdGlvbnNQZXJVc2VyOiB0aGlzLk1BWF9DT05ORUNUSU9OU19QRVJfVVNFUixcbiAgICAgIG1heEF0dGVtcHRzUGVyTWludXRlOiB0aGlzLk1BWF9BVFRFTVBUU19QRVJfTUlOVVRFLFxuICAgIH07XG4gIH1cbn1cbiJdLCJ2ZXJzaW9uIjozfQ==