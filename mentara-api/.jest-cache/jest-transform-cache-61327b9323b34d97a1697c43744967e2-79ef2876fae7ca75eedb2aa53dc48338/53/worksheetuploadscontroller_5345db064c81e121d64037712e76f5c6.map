{"file":"/home/wetooa/Documents/code/projects/mentara/mentara-api/src/worksheets/worksheet-uploads.controller.ts","mappings":"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","names":[],"sources":["/home/wetooa/Documents/code/projects/mentara/mentara-api/src/worksheets/worksheet-uploads.controller.ts"],"sourcesContent":["import {\n  Controller,\n  Post,\n  UseInterceptors,\n  UploadedFile,\n  Body,\n  BadRequestException,\n  HttpException,\n  HttpStatus,\n} from '@nestjs/common';\nimport { FileInterceptor } from '@nestjs/platform-express';\nimport { PrismaService } from '../providers/prisma-client.provider';\nimport { SupabaseStorageService } from '../common/services/supabase-storage.service';\n\n@Controller('worksheets/upload')\nexport class WorksheetUploadsController {\n  constructor(\n    private prisma: PrismaService,\n    private readonly supabaseStorageService: SupabaseStorageService,\n  ) {}\n\n  @Post()\n  @UseInterceptors(FileInterceptor('file'))\n  async uploadFile(\n    @UploadedFile() file: Express.Multer.File,\n    @Body('worksheetId') worksheetId: string,\n    @Body('type') type: 'material' | 'submission',\n  ) {\n    if (!file) {\n      throw new BadRequestException('No file uploaded');\n    }\n\n    if (!worksheetId) {\n      throw new BadRequestException('Worksheet ID is required');\n    }\n\n    if (!type || !['material', 'submission'].includes(type)) {\n      throw new BadRequestException(\n        'Type must be either \"material\" or \"submission\"',\n      );\n    }\n\n    try {\n      // Check if the worksheet exists\n      const worksheet = await this.prisma.worksheet.findUnique({\n        where: { id: worksheetId },\n      });\n\n      if (!worksheet) {\n        throw new BadRequestException(\n          `Worksheet with ID ${worksheetId} not found`,\n        );\n      }\n\n      // Validate file\n      const allowedMimeTypes = [\n        'application/pdf', // PDF files\n        'application/msword', // DOC files\n        'application/vnd.openxmlformats-officedocument.wordprocessingml.document', // DOCX files\n        'text/plain', // Text files\n        'image/jpeg', // JPEG images\n        'image/png', // PNG images\n      ];\n\n      const validation = this.supabaseStorageService.validateFile(\n        file,\n        5 * 1024 * 1024, // 5MB limit\n        allowedMimeTypes,\n      );\n\n      if (!validation.isValid) {\n        throw new BadRequestException(\n          `File validation failed: ${validation.error}`,\n        );\n      }\n\n      // Upload file to Supabase Storage\n      const uploadResult = await this.supabaseStorageService.uploadFile(\n        file,\n        SupabaseStorageService.getSupportedBuckets().WORKSHEETS,\n      );\n\n      // Update the worksheet with the new file information\n      if (type === 'material') {\n        // Add to material arrays\n        await this.prisma.worksheet.update({\n          where: { id: worksheetId },\n          data: {\n            materialUrls: {\n              push: uploadResult.url,\n            },\n            materialNames: {\n              push: file.originalname,\n            },\n\n          },\n        });\n      } else {\n        // For submissions, create or update WorksheetSubmission\n        const existingSubmission = await this.prisma.worksheetSubmission.findUnique({\n          where: { worksheetId },\n        });\n\n        if (existingSubmission) {\n          // Update existing submission\n          await this.prisma.worksheetSubmission.update({\n            where: { worksheetId },\n            data: {\n              fileUrls: {\n                push: uploadResult.url,\n              },\n              fileNames: {\n                push: file.originalname,\n              },\n              fileSizes: {\n                push: file.size,\n              },\n            },\n          });\n        } else {\n          // Create new submission\n          await this.prisma.worksheetSubmission.create({\n            data: {\n              worksheetId,\n              fileUrls: [uploadResult.url],\n              fileNames: [file.originalname],\n              fileSizes: [file.size],\n            },\n          });\n        }\n      }\n\n      // Return the expected response format\n      return {\n        id: uploadResult.filename, // Use the unique filename as ID\n        filename: file.originalname,\n        url: uploadResult.url,\n        fileSize: file.size,\n        fileType: file.mimetype,\n      };\n    } catch (error) {\n      if (error instanceof BadRequestException) {\n        throw error;\n      }\n\n      throw new HttpException(\n        `Failed to upload file: ${error instanceof Error ? error.message : 'Unknown error'}`,\n        HttpStatus.INTERNAL_SERVER_ERROR,\n      );\n    }\n  }\n}\n"],"version":3}