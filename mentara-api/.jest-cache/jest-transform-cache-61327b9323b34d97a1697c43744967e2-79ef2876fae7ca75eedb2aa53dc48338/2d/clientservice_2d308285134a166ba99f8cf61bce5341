a764beb697338739d09fee5ddf59b7ee
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var ClientService_1;
var _a, _b;
Object.defineProperty(exports, "__esModule", { value: true });
exports.ClientService = void 0;
const common_1 = require("@nestjs/common");
const prisma_client_provider_1 = require("../providers/prisma-client.provider");
const messaging_service_1 = require("../messaging/messaging.service");
const library_1 = require("@prisma/client/runtime/library");
let ClientService = ClientService_1 = class ClientService {
    prisma;
    messagingService;
    logger = new common_1.Logger(ClientService_1.name);
    constructor(prisma, messagingService) {
        this.prisma = prisma;
        this.messagingService = messagingService;
    }
    async getProfile(userId) {
        try {
            const client = await this.prisma.client.findUnique({
                where: { userId },
                include: { user: true },
            });
            if (!client) {
                this.logger.warn(`Client profile not found for userId: ${userId}`);
                throw new common_1.NotFoundException('Client profile not found');
            }
            return this.transformPrismaUserToDTO(client.user);
        }
        catch (error) {
            if (error instanceof common_1.NotFoundException) {
                throw error;
            }
            if (error instanceof library_1.PrismaClientKnownRequestError) {
                this.logger.error(`Database error in getProfile: ${error.code} - ${error.message}`);
                throw new common_1.InternalServerErrorException('Failed to retrieve client profile');
            }
            this.logger.error(`Unexpected error in getProfile: ${error instanceof Error ? error.message : String(error)}`);
            throw new common_1.InternalServerErrorException('An unexpected error occurred');
        }
    }
    async updateProfile(userId, data) {
        try {
            const updatedClient = await this.prisma.client.update({
                where: { userId },
                data: {
                    user: {
                        update: data,
                    },
                },
                include: { user: true },
            });
            return this.transformPrismaUserToDTO(updatedClient.user);
        }
        catch (error) {
            if (error instanceof library_1.PrismaClientKnownRequestError) {
                switch (error.code) {
                    case 'P2025':
                        this.logger.warn(`Client not found for update, userId: ${userId}`);
                        throw new common_1.NotFoundException('Client not found');
                    case 'P2002':
                        this.logger.warn(`Unique constraint violation in updateProfile: ${error.message}`);
                        throw new common_1.BadRequestException('A profile with this data already exists');
                    default:
                        this.logger.error(`Database error in updateProfile: ${error.code} - ${error.message}`);
                        throw new common_1.InternalServerErrorException('Failed to update client profile');
                }
            }
            this.logger.error(`Unexpected error in updateProfile: ${error instanceof Error ? error.message : String(error)}`);
            throw new common_1.InternalServerErrorException('An unexpected error occurred while updating profile');
        }
    }
    async needsTherapistRecommendations(userId) {
        try {
            const client = await this.prisma.client.findUnique({
                where: { userId },
                select: { hasSeenTherapistRecommendations: true },
            });
            return !client?.hasSeenTherapistRecommendations;
        }
        catch (error) {
            this.logger.error(`Error checking therapist recommendations for userId ${userId}: ${error instanceof Error ? error.message : String(error)}`);
            throw new common_1.InternalServerErrorException('Failed to check therapist recommendation status');
        }
    }
    async markTherapistRecommendationsSeen(userId) {
        try {
            await this.prisma.client.update({
                where: { userId },
                data: { hasSeenTherapistRecommendations: true },
            });
        }
        catch (error) {
            if (error instanceof library_1.PrismaClientKnownRequestError &&
                error.code === 'P2025') {
                this.logger.warn(`Client not found when marking recommendations seen, userId: ${userId}`);
                throw new common_1.NotFoundException('Client not found');
            }
            this.logger.error(`Error marking therapist recommendations seen for userId ${userId}: ${error instanceof Error ? error.message : String(error)}`);
            throw new common_1.InternalServerErrorException('Failed to update therapist recommendation status');
        }
    }
    async getAssignedTherapist(userId) {
        const assignment = await this.prisma.clientTherapist.findFirst({
            where: {
                clientId: userId,
            },
            include: {
                therapist: {
                    include: { user: true },
                },
            },
            orderBy: { assignedAt: 'desc' },
        });
        if (!assignment?.therapist) {
            return null;
        }
        // Transform the Prisma result to match TherapistRecommendation type
        const therapist = assignment.therapist;
        return {
            id: therapist.userId,
            firstName: therapist.user.firstName,
            lastName: therapist.user.lastName,
            title: 'Therapist',
            specialties: therapist.areasOfExpertise,
            hourlyRate: Number(therapist.hourlyRate),
            experience: therapist.yearsOfExperience || 0,
            province: therapist.province,
            isActive: therapist.status === 'APPROVED',
            bio: therapist.user.bio || undefined,
            profileImage: undefined,
        };
    }
    async assignTherapist(userId, therapistId) {
        // Check if client exists
        const client = await this.prisma.client.findUnique({
            where: { userId },
        });
        if (!client) {
            throw new common_1.NotFoundException('Client not found');
        }
        // Check if therapist exists
        const therapist = await this.prisma.therapist.findUnique({
            where: { userId: therapistId },
            include: { user: true },
        });
        if (!therapist) {
            throw new common_1.NotFoundException('Therapist not found');
        }
        // Delete any existing assignments
        await this.prisma.clientTherapist.deleteMany({
            where: {
                clientId: userId,
            },
        });
        // Create new assignment
        await this.prisma.clientTherapist.create({
            data: {
                clientId: userId,
                therapistId: therapistId,
            },
        });
        // Automatically create conversation between client and therapist
        try {
            await this.messagingService.createConversation(userId, {
                participantIds: [therapistId],
                type: 'direct',
                title: `Therapy Session with ${therapist.user.firstName} ${therapist.user.lastName}`,
            });
            this.logger.log(`Auto-created conversation between client ${userId} and therapist ${therapistId}`);
        }
        catch (error) {
            // Log error but don't fail the assignment if conversation creation fails
            this.logger.warn(`Failed to auto-create conversation between client ${userId} and therapist ${therapistId}: ${error instanceof Error ? error.message : String(error)}`);
        }
        // Transform the Prisma result to match TherapistRecommendation type
        return {
            id: therapist.userId,
            firstName: therapist.user.firstName,
            lastName: therapist.user.lastName,
            title: 'Therapist',
            specialties: therapist.areasOfExpertise,
            hourlyRate: Number(therapist.hourlyRate),
            experience: therapist.yearsOfExperience || 0,
            province: therapist.province,
            isActive: therapist.status === 'APPROVED',
            bio: therapist.user.bio || undefined,
            profileImage: undefined,
        };
    }
    async removeTherapist(userId) {
        // Check if client exists
        const client = await this.prisma.client.findUnique({
            where: { userId },
        });
        if (!client) {
            throw new common_1.NotFoundException('Client not found');
        }
        // Delete any existing assignments
        await this.prisma.clientTherapist.deleteMany({
            where: {
                clientId: userId,
            },
        });
    }
    transformPrismaUserToDTO(user) {
        return {
            id: user.id,
            email: user.email,
            role: user.role,
            createdAt: user.createdAt.toISOString(),
            updatedAt: user.updatedAt.toISOString(),
            firstName: user.firstName,
            lastName: user.lastName,
        };
    }
};
exports.ClientService = ClientService;
exports.ClientService = ClientService = ClientService_1 = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [typeof (_a = typeof prisma_client_provider_1.PrismaService !== "undefined" && prisma_client_provider_1.PrismaService) === "function" ? _a : Object, typeof (_b = typeof messaging_service_1.MessagingService !== "undefined" && messaging_service_1.MessagingService) === "function" ? _b : Object])
], ClientService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL2NsaWVudC9jbGllbnQuc2VydmljZS50cyIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7OztBQUFBLDJDQU13QjtBQUN4QixnRkFBb0U7QUFDcEUsc0VBQWtFO0FBQ2xFLDREQUErRTtBQWN4RSxJQUFNLGFBQWEscUJBQW5CLE1BQU0sYUFBYTtJQUlMO0lBQ0E7SUFKRixNQUFNLEdBQUcsSUFBSSxlQUFNLENBQUMsZUFBYSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBRXpELFlBQ21CLE1BQXFCLEVBQ3JCLGdCQUFrQztRQURsQyxXQUFNLEdBQU4sTUFBTSxDQUFlO1FBQ3JCLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBa0I7SUFDbEQsQ0FBQztJQUVKLEtBQUssQ0FBQyxVQUFVLENBQUMsTUFBYztRQUM3QixJQUFJLENBQUM7WUFDSCxNQUFNLE1BQU0sR0FBRyxNQUFNLElBQUksQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQztnQkFDakQsS0FBSyxFQUFFLEVBQUUsTUFBTSxFQUFFO2dCQUNqQixPQUFPLEVBQUUsRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFO2FBQ3hCLENBQUMsQ0FBQztZQUVILElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQztnQkFDWixJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyx3Q0FBd0MsTUFBTSxFQUFFLENBQUMsQ0FBQztnQkFDbkUsTUFBTSxJQUFJLDBCQUFpQixDQUFDLDBCQUEwQixDQUFDLENBQUM7WUFDMUQsQ0FBQztZQUVELE9BQU8sSUFBSSxDQUFDLHdCQUF3QixDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUNwRCxDQUFDO1FBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztZQUNmLElBQUksS0FBSyxZQUFZLDBCQUFpQixFQUFFLENBQUM7Z0JBQ3ZDLE1BQU0sS0FBSyxDQUFDO1lBQ2QsQ0FBQztZQUVELElBQUksS0FBSyxZ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QUM7UUFFRCxrQ0FBa0M7UUFDbEMsTUFBTSxJQUFJLENBQUMsTUFBTSxDQUFDLGVBQWUsQ0FBQyxVQUFVLENBQUM7WUFDM0MsS0FBSyxFQUFFO2dCQUNMLFFBQVEsRUFBRSxNQUFNO2FBQ2pCO1NBQ0YsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVPLHdCQUF3QixDQUFDLElBQVM7UUFDeEMsT0FBTztZQUNMLEVBQUUsRUFBRSxJQUFJLENBQUMsRUFBRTtZQUNYLEtBQUssRUFBRSxJQUFJLENBQUMsS0FBSztZQUNqQixJQUFJLEVBQUUsSUFBSSxDQUFDLElBQXNEO1lBQ2pFLFNBQVMsRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLFdBQVcsRUFBRTtZQUN2QyxTQUFTLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxXQUFXLEVBQUU7WUFDdkMsU0FBUyxFQUFFLElBQUksQ0FBQyxTQUFTO1lBQ3pCLFFBQVEsRUFBRSxJQUFJLENBQUMsUUFBUTtTQUN4QixDQUFDO0lBQ0osQ0FBQztDQUNGLENBQUE7QUFuUVksc0NBQWE7d0JBQWIsYUFBYTtJQUR6QixJQUFBLG1CQUFVLEdBQUU7eURBS2dCLHNDQUFhLG9CQUFiLHNDQUFhLG9EQUNILG9DQUFnQixvQkFBaEIsb0NBQWdCO0dBTDFDLGFBQWEsQ0FtUXpCIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9ob21lL3dldG9vYS9Eb2N1bWVudHMvY29kZS9wcm9qZWN0cy9tZW50YXJhL21lbnRhcmEtYXBpL3NyYy9jbGllbnQvY2xpZW50LnNlcnZpY2UudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgSW5qZWN0YWJsZSxcbiAgTm90Rm91bmRFeGNlcHRpb24sXG4gIEJhZFJlcXVlc3RFeGNlcHRpb24sXG4gIEludGVybmFsU2VydmVyRXJyb3JFeGNlcHRpb24sXG4gIExvZ2dlcixcbn0gZnJvbSAnQG5lc3Rqcy9jb21tb24nO1xuaW1wb3J0IHsgUHJpc21hU2VydmljZSB9IGZyb20gJy4uL3Byb3ZpZGVycy9wcmlzbWEtY2xpZW50LnByb3ZpZGVyJztcbmltcG9ydCB7IE1lc3NhZ2luZ1NlcnZpY2UgfSBmcm9tICcuLi9tZXNzYWdpbmcvbWVzc2FnaW5nLnNlcnZpY2UnO1xuaW1wb3J0IHsgUHJpc21hQ2xpZW50S25vd25SZXF1ZXN0RXJyb3IgfSBmcm9tICdAcHJpc21hL2NsaWVudC9ydW50aW1lL2xpYnJhcnknO1xuLy8gQ2xpZW50IHByb2ZpbGUgRFRPIGludGVyZmFjZVxuaW50ZXJmYWNlIENsaWVudFByb2ZpbGVEdG8ge1xuICBpZDogc3RyaW5nO1xuICBlbWFpbDogc3RyaW5nO1xuICBmaXJzdE5hbWU6IHN0cmluZztcbiAgbGFzdE5hbWU6IHN0cmluZztcbiAgcm9sZTogc3RyaW5nO1xuICBjcmVhdGVkQXQ6IHN0cmluZztcbiAgdXBkYXRlZEF0OiBzdHJpbmc7XG59XG5pbXBvcnQgdHlwZSB7IFVwZGF0ZUNsaWVudER0bywgVGhlcmFwaXN0UmVjb21tZW5kYXRpb24gfSBmcm9tICcuL3R5cGVzJztcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIENsaWVudFNlcnZpY2Uge1xuICBwcml2YXRlIHJlYWRvbmx5IGxvZ2dlciA9IG5ldyBMb2dnZXIoQ2xpZW50U2VydmljZS5uYW1lKTtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHJlYWRvbmx5IHByaXNtYTogUHJpc21hU2VydmljZSxcbiAgICBwcml2YXRlIHJlYWRvbmx5IG1lc3NhZ2luZ1NlcnZpY2U6IE1lc3NhZ2luZ1NlcnZpY2UsXG4gICkge31cblxuICBhc3luYyBnZXRQcm9maWxlKHVzZXJJZDogc3RyaW5nKTogUHJvbWlzZTxDbGllbnRQcm9maWxlRHRvPiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGNsaWVudCA9IGF3YWl0IHRoaXMucHJpc21hLmNsaWVudC5maW5kVW5pcXVlKHtcbiAgICAgICAgd2hlcmU6IHsgdXNlcklkIH0sXG4gICAgICAgIGluY2x1ZGU6IHsgdXNlcjogdHJ1ZSB9LFxuICAgICAgfSk7XG5cbiAgICAgIGlmICghY2xpZW50KSB7XG4gICAgICAgIHRoaXMubG9nZ2VyLndhcm4oYENsaWVudCBwcm9maWxlIG5vdCBmb3VuZCBmb3IgdXNlcklkOiAke3VzZXJJZH1gKTtcbiAgICAgICAgdGhyb3cgbmV3IE5vdEZvdW5kRXhjZXB0aW9uKCdDbGllbnQgcHJvZmlsZSBub3QgZm91bmQnKTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHRoaXMudHJhbnNmb3JtUHJpc21hVXNlclRvRFRPKGNsaWVudC51c2VyKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgaWYgKGVycm9yIGluc3RhbmNlb2YgTm90Rm91bmRFeGNlcHRpb24pIHtcbiAgICAgICAgdGhyb3cgZXJyb3I7XG4gICAgICB9XG5cbiAgICAgIGlmIChlcnJvciBpbnN0YW5jZW9mIFByaXNtYUNsaWVudEtub3duUmVxdWVzdEVycm9yKSB7XG4gICAgICAgIHRoaXMubG9nZ2VyLmVycm9yKFxuICAgICAgICAgIGBEYXRhYmFzZSBlcnJvciBpbiBnZXRQcm9maWxlOiAke2Vycm9yLmNvZGV9IC0gJHtlcnJvci5tZXNzYWdlfWAsXG4gICAgICAgICk7XG4gICAgICAgIHRocm93IG5ldyBJbnRlcm5hbFNlcnZlckVycm9yRXhjZXB0aW9uKFxuICAgICAgICAgICdGYWlsZWQgdG8gcmV0cmlldmUgY2xpZW50IHByb2ZpbGUnLFxuICAgICAgICApO1xuICAgICAgfVxuXG4gICAgICB0aGlzLmxvZ2dlci5lcnJvcihcbiAgICAgICAgYFVuZXhwZWN0ZWQgZXJyb3IgaW4gZ2V0UHJvZmlsZTogJHtlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6IFN0cmluZyhlcnJvcil9YCxcbiAgICAgICk7XG4gICAgICB0aHJvdyBuZXcgSW50ZXJuYWxTZXJ2ZXJFcnJvckV4Y2VwdGlvbignQW4gdW5leHBlY3RlZCBlcnJvciBvY2N1cnJlZCcpO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIHVwZGF0ZVByb2ZpbGUodXNlcklkOiBzdHJpbmcsIGRhdGE6IFVwZGF0ZUNsaWVudER0byk6IFByb21pc2U8Q2xpZW50UHJvZmlsZUR0bz4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCB1cGRhdGVkQ2xpZW50ID0gYXdhaXQgdGhpcy5wcmlzbWEuY2xpZW50LnVwZGF0ZSh7XG4gICAgICAgIHdoZXJlOiB7IHVzZXJJZCB9LFxuICAgICAgICBkYXRhOiB7XG4gICAgICAgICAgdXNlcjoge1xuICAgICAgICAgICAgdXBkYXRlOiBkYXRhLFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICAgIGluY2x1ZGU6IHsgdXNlcjogdHJ1ZSB9LFxuICAgICAgfSk7XG5cbiAgICAgIHJldHVybiB0aGlzLnRyYW5zZm9ybVByaXNtYVVzZXJUb0RUTyh1cGRhdGVkQ2xpZW50LnVzZXIpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBpZiAoZXJyb3IgaW5zdGFuY2VvZiBQcmlzbWFDbGllbnRLbm93blJlcXVlc3RFcnJvcikge1xuICAgICAgICBzd2l0Y2ggKGVycm9yLmNvZGUpIHtcbiAgICAgICAgICBjYXNlICdQMjAyNSc6XG4gICAgICAgICAgICB0aGlzLmxvZ2dlci53YXJuKGBDbGllbnQgbm90IGZvdW5kIGZvciB1cGRhdGUsIHVzZXJJZDogJHt1c2VySWR9YCk7XG4gICAgICAgICAgICB0aHJvdyBuZXcgTm90Rm91bmRFeGNlcHRpb24oJ0NsaWVudCBub3QgZm91bmQnKTtcbiAgICAgICAgICBjYXNlICdQMjAwMic6XG4gICAgICAgICAgICB0aGlzLmxvZ2dlci53YXJuKFxuICAgICAgICAgICAgICBgVW5pcXVlIGNvbnN0cmFpbnQgdmlvbGF0aW9uIGluIHVwZGF0ZVByb2ZpbGU6ICR7ZXJyb3IubWVzc2FnZX1gLFxuICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0RXhjZXB0aW9uKFxuICAgICAgICAgICAgICAnQSBwcm9maWxlIHdpdGggdGhpcyBkYXRhIGFscmVhZHkgZXhpc3RzJyxcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICAgIHRoaXMubG9nZ2VyLmVycm9yKFxuICAgICAgICAgICAgICBgRGF0YWJhc2UgZXJyb3IgaW4gdXBkYXRlUHJvZmlsZTogJHtlcnJvci5jb2RlfSAtICR7ZXJyb3IubWVzc2FnZX1gLFxuICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIHRocm93IG5ldyBJbnRlcm5hbFNlcnZlckVycm9yRXhjZXB0aW9uKFxuICAgICAgICAgICAgICAnRmFpbGVkIHRvIHVwZGF0ZSBjbGllbnQgcHJvZmlsZScsXG4gICAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIHRoaXMubG9nZ2VyLmVycm9yKFxuICAgICAgICBgVW5leHBlY3RlZCBlcnJvciBpbiB1cGRhdGVQcm9maWxlOiAke2Vycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogU3RyaW5nKGVycm9yKX1gLFxuICAgICAgKTtcbiAgICAgIHRocm93IG5ldyBJbnRlcm5hbFNlcnZlckVycm9yRXhjZXB0aW9uKFxuICAgICAgICAnQW4gdW5leHBlY3RlZCBlcnJvciBvY2N1cnJlZCB3aGlsZSB1cGRhdGluZyBwcm9maWxlJyxcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgbmVlZHNUaGVyYXBpc3RSZWNvbW1lbmRhdGlvbnModXNlcklkOiBzdHJpbmcpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgY2xpZW50ID0gYXdhaXQgdGhpcy5wcmlzbWEuY2xpZW50LmZpbmRVbmlxdWUoe1xuICAgICAgICB3aGVyZTogeyB1c2VySWQgfSxcbiAgICAgICAgc2VsZWN0OiB7IGhhc1NlZW5UaGVyYXBpc3RSZWNvbW1lbmRhdGlvbnM6IHRydWUgfSxcbiAgICAgIH0pO1xuICAgICAgcmV0dXJuICFjbGllbnQ/Lmhhc1NlZW5UaGVyYXBpc3RSZWNvbW1lbmRhdGlvbnM7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRoaXMubG9nZ2VyLmVycm9yKFxuICAgICAgICBgRXJyb3IgY2hlY2tpbmcgdGhlcmFwaXN0IHJlY29tbWVuZGF0aW9ucyBmb3IgdXNlcklkICR7dXNlcklkfTogJHtlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6IFN0cmluZyhlcnJvcil9YCxcbiAgICAgICk7XG4gICAgICB0aHJvdyBuZXcgSW50ZXJuYWxTZXJ2ZXJFcnJvckV4Y2VwdGlvbihcbiAgICAgICAgJ0ZhaWxlZCB0byBjaGVjayB0aGVyYXBpc3QgcmVjb21tZW5kYXRpb24gc3RhdHVzJyxcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgbWFya1RoZXJhcGlzdFJlY29tbWVuZGF0aW9uc1NlZW4odXNlcklkOiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICB0cnkge1xuICAgICAgYXdhaXQgdGhpcy5wcmlzbWEuY2xpZW50LnVwZGF0ZSh7XG4gICAgICAgIHdoZXJlOiB7IHVzZXJJZCB9LFxuICAgICAgICBkYXRhOiB7IGhhc1NlZW5UaGVyYXBpc3RSZWNvbW1lbmRhdGlvbnM6IHRydWUgfSxcbiAgICAgIH0pO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBpZiAoXG4gICAgICAgIGVycm9yIGluc3RhbmNlb2YgUHJpc21hQ2xpZW50S25vd25SZXF1ZXN0RXJyb3IgJiZcbiAgICAgICAgZXJyb3IuY29kZSA9PT0gJ1AyMDI1J1xuICAgICAgKSB7XG4gICAgICAgIHRoaXMubG9nZ2VyLndhcm4oXG4gICAgICAgICAgYENsaWVudCBub3QgZm91bmQgd2hlbiBtYXJraW5nIHJlY29tbWVuZGF0aW9ucyBzZWVuLCB1c2VySWQ6ICR7dXNlcklkfWAsXG4gICAgICAgICk7XG4gICAgICAgIHRocm93IG5ldyBOb3RGb3VuZEV4Y2VwdGlvbignQ2xpZW50IG5vdCBmb3VuZCcpO1xuICAgICAgfVxuXG4gICAgICB0aGlzLmxvZ2dlci5lcnJvcihcbiAgICAgICAgYEVycm9yIG1hcmtpbmcgdGhlcmFwaXN0IHJlY29tbWVuZGF0aW9ucyBzZWVuIGZvciB1c2VySWQgJHt1c2VySWR9OiAke2Vycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogU3RyaW5nKGVycm9yKX1gLFxuICAgICAgKTtcbiAgICAgIHRocm93IG5ldyBJbnRlcm5hbFNlcnZlckVycm9yRXhjZXB0aW9uKFxuICAgICAgICAnRmFpbGVkIHRvIHVwZGF0ZSB0aGVyYXBpc3QgcmVjb21tZW5kYXRpb24gc3RhdHVzJyxcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgZ2V0QXNzaWduZWRUaGVyYXBpc3QoXG4gICAgdXNlcklkOiBzdHJpbmcsXG4gICk6IFByb21pc2U8VGhlcmFwaXN0UmVjb21tZW5kYXRpb24gfCBudWxsPiB7XG4gICAgY29uc3QgYXNzaWdubWVudCA9IGF3YWl0IHRoaXMucHJpc21hLmNsaWVudFRoZXJhcGlzdC5maW5kRmlyc3Qoe1xuICAgICAgd2hlcmU6IHtcbiAgICAgICAgY2xpZW50SWQ6IHVzZXJJZCxcbiAgICAgIH0sXG4gICAgICBpbmNsdWRlOiB7XG4gICAgICAgIHRoZXJhcGlzdDoge1xuICAgICAgICAgIGluY2x1ZGU6IHsgdXNlcjogdHJ1ZSB9LFxuICAgICAgICB9LFxuICAgICAgfSxcbiAgICAgIG9yZGVyQnk6IHsgYXNzaWduZWRBdDogJ2Rlc2MnIH0sXG4gICAgfSk7XG5cbiAgICBpZiAoIWFzc2lnbm1lbnQ/LnRoZXJhcGlzdCkge1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuXG4gICAgLy8gVHJhbnNmb3JtIHRoZSBQcmlzbWEgcmVzdWx0IHRvIG1hdGNoIFRoZXJhcGlzdFJlY29tbWVuZGF0aW9uIHR5cGVcbiAgICBjb25zdCB0aGVyYXBpc3QgPSBhc3NpZ25tZW50LnRoZXJhcGlzdDtcbiAgICByZXR1cm4ge1xuICAgICAgaWQ6IHRoZXJhcGlzdC51c2VySWQsXG4gICAgICBmaXJzdE5hbWU6IHRoZXJhcGlzdC51c2VyLmZpcnN0TmFtZSxcbiAgICAgIGxhc3ROYW1lOiB0aGVyYXBpc3QudXNlci5sYXN0TmFtZSxcbiAgICAgIHRpdGxlOiAnVGhlcmFwaXN0JyxcbiAgICAgIHNwZWNpYWx0aWVzOiB0aGVyYXBpc3QuYXJlYXNPZkV4cGVydGlzZSxcbiAgICAgIGhvdXJseVJhdGU6IE51bWJlcih0aGVyYXBpc3QuaG91cmx5UmF0ZSksXG4gICAgICBleHBlcmllbmNlOiB0aGVyYXBpc3QueWVhcnNPZkV4cGVyaWVuY2UgfHwgMCxcbiAgICAgIHByb3ZpbmNlOiB0aGVyYXBpc3QucHJvdmluY2UsXG4gICAgICBpc0FjdGl2ZTogdGhlcmFwaXN0LnN0YXR1cyA9PT0gJ0FQUFJPVkVEJyxcbiAgICAgIGJpbzogdGhlcmFwaXN0LnVzZXIuYmlvIHx8IHVuZGVmaW5lZCxcbiAgICAgIHByb2ZpbGVJbWFnZTogdW5kZWZpbmVkLFxuICAgIH07XG4gIH1cblxuICBhc3luYyBhc3NpZ25UaGVyYXBpc3QoXG4gICAgdXNlcklkOiBzdHJpbmcsXG4gICAgdGhlcmFwaXN0SWQ6IHN0cmluZyxcbiAgKTogUHJvbWlzZTxUaGVyYXBpc3RSZWNvbW1lbmRhdGlvbj4ge1xuICAgIC8vIENoZWNrIGlmIGNsaWVudCBleGlzdHNcbiAgICBjb25zdCBjbGllbnQgPSBhd2FpdCB0aGlzLnByaXNtYS5jbGllbnQuZmluZFVuaXF1ZSh7XG4gICAgICB3aGVyZTogeyB1c2VySWQgfSxcbiAgICB9KTtcbiAgICBpZiAoIWNsaWVudCkge1xuICAgICAgdGhyb3cgbmV3IE5vdEZvdW5kRXhjZXB0aW9uKCdDbGllbnQgbm90IGZvdW5kJyk7XG4gICAgfVxuXG4gICAgLy8gQ2hlY2sgaWYgdGhlcmFwaXN0IGV4aXN0c1xuICAgIGNvbnN0IHRoZXJhcGlzdCA9IGF3YWl0IHRoaXMucHJpc21hLnRoZXJhcGlzdC5maW5kVW5pcXVlKHtcbiAgICAgIHdoZXJlOiB7IHVzZXJJZDogdGhlcmFwaXN0SWQgfSxcbiAgICAgIGluY2x1ZGU6IHsgdXNlcjogdHJ1ZSB9LFxuICAgIH0pO1xuICAgIGlmICghdGhlcmFwaXN0KSB7XG4gICAgICB0aHJvdyBuZXcgTm90Rm91bmRFeGNlcHRpb24oJ1RoZXJhcGlzdCBub3QgZm91bmQnKTtcbiAgICB9XG5cbiAgICAvLyBEZWxldGUgYW55IGV4aXN0aW5nIGFzc2lnbm1lbnRzXG4gICAgYXdhaXQgdGhpcy5wcmlzbWEuY2xpZW50VGhlcmFwaXN0LmRlbGV0ZU1hbnkoe1xuICAgICAgd2hlcmU6IHtcbiAgICAgICAgY2xpZW50SWQ6IHVzZXJJZCxcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICAvLyBDcmVhdGUgbmV3IGFzc2lnbm1lbnRcbiAgICBhd2FpdCB0aGlzLnByaXNtYS5jbGllbnRUaGVyYXBpc3QuY3JlYXRlKHtcbiAgICAgIGRhdGE6IHtcbiAgICAgICAgY2xpZW50SWQ6IHVzZXJJZCxcbiAgICAgICAgdGhlcmFwaXN0SWQ6IHRoZXJhcGlzdElkLFxuICAgICAgfSxcbiAgICB9KTtcblxuICAgIC8vIEF1dG9tYXRpY2FsbHkgY3JlYXRlIGNvbnZlcnNhdGlvbiBiZXR3ZWVuIGNsaWVudCBhbmQgdGhlcmFwaXN0XG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IHRoaXMubWVzc2FnaW5nU2VydmljZS5jcmVhdGVDb252ZXJzYXRpb24odXNlcklkLCB7XG4gICAgICAgIHBhcnRpY2lwYW50SWRzOiBbdGhlcmFwaXN0SWRdLFxuICAgICAgICB0eXBlOiAnZGlyZWN0JyxcbiAgICAgICAgdGl0bGU6IGBUaGVyYXB5IFNlc3Npb24gd2l0aCAke3RoZXJhcGlzdC51c2VyLmZpcnN0TmFtZX0gJHt0aGVyYXBpc3QudXNlci5sYXN0TmFtZX1gLFxuICAgICAgfSk7XG4gICAgICB0aGlzLmxvZ2dlci5sb2coYEF1dG8tY3JlYXRlZCBjb252ZXJzYXRpb24gYmV0d2VlbiBjbGllbnQgJHt1c2VySWR9IGFuZCB0aGVyYXBpc3QgJHt0aGVyYXBpc3RJZH1gKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgLy8gTG9nIGVycm9yIGJ1dCBkb24ndCBmYWlsIHRoZSBhc3NpZ25tZW50IGlmIGNvbnZlcnNhdGlvbiBjcmVhdGlvbiBmYWlsc1xuICAgICAgdGhpcy5sb2dnZXIud2FybihgRmFpbGVkIHRvIGF1dG8tY3JlYXRlIGNvbnZlcnNhdGlvbiBiZXR3ZWVuIGNsaWVudCAke3VzZXJJZH0gYW5kIHRoZXJhcGlzdCAke3RoZXJhcGlzdElkfTogJHtlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6IFN0cmluZyhlcnJvcil9YCk7XG4gICAgfVxuXG4gICAgLy8gVHJhbnNmb3JtIHRoZSBQcmlzbWEgcmVzdWx0IHRvIG1hdGNoIFRoZXJhcGlzdFJlY29tbWVuZGF0aW9uIHR5cGVcbiAgICByZXR1cm4ge1xuICAgICAgaWQ6IHRoZXJhcGlzdC51c2VySWQsXG4gICAgICBmaXJzdE5hbWU6IHRoZXJhcGlzdC51c2VyLmZpcnN0TmFtZSxcbiAgICAgIGxhc3ROYW1lOiB0aGVyYXBpc3QudXNlci5sYXN0TmFtZSxcbiAgICAgIHRpdGxlOiAnVGhlcmFwaXN0JyxcbiAgICAgIHNwZWNpYWx0aWVzOiB0aGVyYXBpc3QuYXJlYXNPZkV4cGVydGlzZSxcbiAgICAgIGhvdXJseVJhdGU6IE51bWJlcih0aGVyYXBpc3QuaG91cmx5UmF0ZSksXG4gICAgICBleHBlcmllbmNlOiB0aGVyYXBpc3QueWVhcnNPZkV4cGVyaWVuY2UgfHwgMCxcbiAgICAgIHByb3ZpbmNlOiB0aGVyYXBpc3QucHJvdmluY2UsXG4gICAgICBpc0FjdGl2ZTogdGhlcmFwaXN0LnN0YXR1cyA9PT0gJ0FQUFJPVkVEJyxcbiAgICAgIGJpbzogdGhlcmFwaXN0LnVzZXIuYmlvIHx8IHVuZGVmaW5lZCxcbiAgICAgIHByb2ZpbGVJbWFnZTogdW5kZWZpbmVkLFxuICAgIH07XG4gIH1cblxuICBhc3luYyByZW1vdmVUaGVyYXBpc3QodXNlcklkOiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAvLyBDaGVjayBpZiBjbGllbnQgZXhpc3RzXG4gICAgY29uc3QgY2xpZW50ID0gYXdhaXQgdGhpcy5wcmlzbWEuY2xpZW50LmZpbmRVbmlxdWUoe1xuICAgICAgd2hlcmU6IHsgdXNlcklkIH0sXG4gICAgfSk7XG4gICAgaWYgKCFjbGllbnQpIHtcbiAgICAgIHRocm93IG5ldyBOb3RGb3VuZEV4Y2VwdGlvbignQ2xpZW50IG5vdCBmb3VuZCcpO1xuICAgIH1cblxuICAgIC8vIERlbGV0ZSBhbnkgZXhpc3RpbmcgYXNzaWdubWVudHNcbiAgICBhd2FpdCB0aGlzLnByaXNtYS5jbGllbnRUaGVyYXBpc3QuZGVsZXRlTWFueSh7XG4gICAgICB3aGVyZToge1xuICAgICAgICBjbGllbnRJZDogdXNlcklkLFxuICAgICAgfSxcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgdHJhbnNmb3JtUHJpc21hVXNlclRvRFRPKHVzZXI6IGFueSk6IENsaWVudFByb2ZpbGVEdG8ge1xuICAgIHJldHVybiB7XG4gICAgICBpZDogdXNlci5pZCxcbiAgICAgIGVtYWlsOiB1c2VyLmVtYWlsLFxuICAgICAgcm9sZTogdXNlci5yb2xlIGFzICdjbGllbnQnIHwgJ3RoZXJhcGlzdCcgfCAnYWRtaW4nIHwgJ21vZGVyYXRvcicsXG4gICAgICBjcmVhdGVkQXQ6IHVzZXIuY3JlYXRlZEF0LnRvSVNPU3RyaW5nKCksXG4gICAgICB1cGRhdGVkQXQ6IHVzZXIudXBkYXRlZEF0LnRvSVNPU3RyaW5nKCksXG4gICAgICBmaXJzdE5hbWU6IHVzZXIuZmlyc3ROYW1lLFxuICAgICAgbGFzdE5hbWU6IHVzZXIubGFzdE5hbWUsXG4gICAgfTtcbiAgfVxufVxuIl0sInZlcnNpb24iOjN9