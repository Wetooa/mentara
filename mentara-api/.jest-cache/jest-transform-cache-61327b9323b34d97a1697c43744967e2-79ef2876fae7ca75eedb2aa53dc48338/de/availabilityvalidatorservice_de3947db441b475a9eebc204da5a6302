e8e0a77c4d9c5e75040fed7d07636b87
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
exports.AvailabilityValidatorService = void 0;
const common_1 = require("@nestjs/common");
const prisma_client_provider_1 = require("../../providers/prisma-client.provider");
let AvailabilityValidatorService = class AvailabilityValidatorService {
    prisma;
    defaultConfig = {
        allowedDurations: [30, 60, 90, 120],
        timeFormat: 'HH:MM',
        timezone: 'UTC',
        businessHours: {
            start: '08:00',
            end: '20:00',
        },
        advanceBooking: {
            minHours: 2,
            maxDays: 90,
        },
        weekendBooking: true,
    };
    constructor(prisma) {
        this.prisma = prisma;
    }
    /**
     * Validate time format (HH:MM or HH:mm)
     */
    validateTimeFormat(timeString, format = 'HH:MM') {
        const regex = format === 'HH:MM'
            ? /^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$/
            : /^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$/;
        if (!regex.test(timeString)) {
            throw new common_1.BadRequestException(`Invalid time format. Expected ${format} format (e.g., 09:30)`);
        }
        return true;
    }
    /**
     * Validate meeting duration
     */
    validateDuration(duration, allowedDurations) {
        const allowed = allowedDurations || this.defaultConfig.allowedDurations;
        if (!allowed.includes(duration)) {
            throw new common_1.BadRequestException(`Invalid duration. Allowed durations are: ${allowed.join(', ')} minutes`);
        }
        return true;
    }
    /**
     * Validate booking date and time constraints
     */
    validateBookingDateTime(startTime, duration, config = {}) {
        const finalConfig = { ...this.defaultConfig, ...config };
        this.validateAdvanceBooking(startTime, finalConfig);
        this.validateBusinessHours(startTime, duration, finalConfig);
        this.validateWeekendBooking(startTime, finalConfig);
        this.validateDuration(duration, finalConfig.allowedDurations);
        return true;
    }
    /**
     * Validate advance booking constraints
     */
    validateAdvanceBooking(startTime, config) {
        const now = new Date();
        const timeDiff = startTime.getTime() - now.getTime();
        const hoursDiff = timeDiff / (1000 * 60 * 60);
        const daysDiff = timeDiff / (1000 * 60 * 60 * 24);
        if (hoursDiff < config.advanceBooking.minHours) {
            throw new common_1.BadRequestException(`Bookings must be made at least ${config.advanceBooking.minHours} hours in advance`);
        }
        if (daysDiff > config.advanceBooking.maxDays) {
            throw new common_1.BadRequestException(`Bookings can only be made up to ${config.advanceBooking.maxDays} days in advance`);
        }
    }
    /**
     * Validate business hours constraints
     */
    validateBusinessHours(startTime, duration, config) {
        const endTime = new Date(startTime.getTime() + duration * 60 * 1000);
        const startTimeStr = this.formatTime(startTime);
        const endTimeStr = this.formatTime(endTime);
        if (startTimeStr < config.businessHours.start ||
            endTimeStr > config.businessHours.end) {
            throw new common_1.BadRequestException(`Meeting must be within business hours (${config.businessHours.start} - ${config.businessHours.end})`);
        }
    }
    /**
     * Validate weekend booking if not allowed
     */
    validateWeekendBooking(startTime, config) {
        if (!config.weekendBooking) {
            const dayOfWeek = startTime.getDay();
            if (dayOfWeek === 0 || dayOfWeek === 6) {
                // Sunday = 0, Saturday = 6
                throw new common_1.BadRequestException('Weekend bookings are not allowed');
            }
        }
    }
    /**
     * Check if therapist is available at the specified time
     */
    async validateTherapistAvailability(therapistId, startTime, duration) {
        const dayOfWeek = startTime.getDay();
        const startTimeStr = this.formatTime(startTime);
        const endTime = new Date(startTime.getTime() + duration * 60 * 1000);
        const endTimeStr = this.formatTime(endTime);
        const availability = await this.prisma.therapistAvailability.findFirst({
            where: {
                therapistId,
                dayOfWeek,
                startTime: { lte: startTimeStr },
                endTime: { gte: endTimeStr },
                isAvailable: true,
            },
        });
        if (!availability) {
            throw new common_1.BadRequestException('Therapist is not available at the requested time');
        }
        return true;
    }
    /**
     * Validate client-therapist relationship exists
     */
    async validateClientTherapistRelationship(clientId, therapistId) {
        const relationship = await this.prisma.clientTherapist.findFirst({
            where: {
                clientId,
                therapistId,
                status: 'ACTIVE', // Assuming there's a status field
            },
        });
        if (!relationship) {
            throw new common_1.BadRequestException('You can only book sessions with your assigned therapists');
        }
        return true;
    }
    /**
     * Validate therapist exists and is active
     */
    async validateTherapistExists(therapistId) {
        const therapist = await this.prisma.therapist.findFirst({
            where: {
                userId: therapistId,
                status: 'approved',
            },
            include: {
                user: {
                    select: {
                        isActive: true,
                    },
                },
            },
        });
        if (!therapist || !therapist.user.isActive) {
            throw new common_1.BadRequestException('Therapist not found or inactive');
        }
        return true;
    }
    /**
     * Validate availability slot overlap
     */
    validateAvailabilityOverlap(startTime1, endTime1, startTime2, endTime2) {
        if (startTime1 >= endTime1) {
            throw new common_1.BadRequestException('Start time must be before end time');
        }
        if (startTime2 >= endTime2) {
            throw new common_1.BadRequestException('Start time must be before end time');
        }
        const hasOverlap = startTime1 < endTime2 && endTime1 > startTime2;
        if (hasOverlap) {
            throw new common_1.BadRequestException('Availability slot overlaps with existing availability');
        }
        return true;
    }
    /**
     * Validate timezone (if timezone support is needed)
     */
    validateTimezone(timezone) {
        try {
            // Check if timezone is valid
            Intl.DateTimeFormat(undefined, { timeZone: timezone });
            return true;
        }
        catch {
            throw new common_1.BadRequestException(`Invalid timezone: ${timezone}`);
        }
    }
    /**
     * Comprehensive validation for meeting creation
     */
    async validateMeetingCreation({ therapistId, clientId, startTime, duration, config = {}, }) {
        // Run all validations
        await Promise.all([
            this.validateTherapistExists(therapistId),
            this.validateClientTherapistRelationship(clientId, therapistId),
            this.validateTherapistAvailability(therapistId, startTime, duration),
        ]);
        this.validateBookingDateTime(startTime, duration, config);
        return true;
    }
    /**
     * Comprehensive validation for availability creation
     */
    async validateAvailabilityCreation({ therapistId, dayOfWeek, startTime, endTime, }) {
        // Validate therapist exists
        await this.validateTherapistExists(therapistId);
        // Validate time formats
        this.validateTimeFormat(startTime);
        this.validateTimeFormat(endTime);
        // Validate time range
        if (startTime >= endTime) {
            throw new common_1.BadRequestException('Start time must be before end time');
        }
        // Validate day of week
        if (dayOfWeek < 0 || dayOfWeek > 6) {
            throw new common_1.BadRequestException('Day of week must be between 0 (Sunday) and 6 (Saturday)');
        }
        // Check for overlapping availability
        const overlapping = await this.prisma.therapistAvailability.findFirst({
            where: {
                therapistId,
                dayOfWeek,
                OR: [
                    {
                        startTime: { lt: endTime },
                        endTime: { gt: startTime },
                    },
                ],
            },
        });
        if (overlapping) {
            throw new common_1.BadRequestException('Availability slot overlaps with existing availability');
        }
        return true;
    }
    /**
     * Format Date to HH:MM string
     */
    formatTime(date) {
        return date.toTimeString().slice(0, 5);
    }
    /**
     * Parse time string to minutes since midnight
     */
    parseTimeToMinutes(timeString) {
        const [hours, minutes] = timeString.split(':').map(Number);
        return hours * 60 + minutes;
    }
    /**
     * Convert minutes since midnight to HH:MM string
     */
    minutesToTimeString(minutes) {
        const hours = Math.floor(minutes / 60);
        const mins = minutes % 60;
        return `${hours.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}`;
    }
};
exports.AvailabilityValidatorService = AvailabilityValidatorService;
exports.AvailabilityValidatorService = AvailabilityValidatorService = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [typeof (_a = typeof prisma_client_provider_1.PrismaService !== "undefined" && prisma_client_provider_1.PrismaService) === "function" ? _a : Object])
], AvailabilityValidatorService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL2Jvb2tpbmcvc2VydmljZXMvYXZhaWxhYmlsaXR5LXZhbGlkYXRvci5zZXJ2aWNlLnRzIiwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7QUFBQSwyQ0FBaUU7QUFDakUsbUZBQXVFO0FBa0JoRSxJQUFNLDRCQUE0QixHQUFsQyxNQUFNLDRCQUE0QjtJQWdCVjtJQWZaLGFBQWEsR0FBcUI7UUFDakQsZ0JBQWdCLEVBQUUsQ0FBQyxFQUFFLEVBQUUsRUFBRSxFQUFFLEVBQUUsRUFBRSxHQUFHLENBQUM7UUFDbkMsVUFBVSxFQUFFLE9BQU87UUFDbkIsUUFBUSxFQUFFLEtBQUs7UUFDZixhQUFhLEVBQUU7WUFDYixLQUFLLEVBQUUsT0FBTztZQUNkLEdBQUcsRUFBRSxPQUFPO1NBQ2I7UUFDRCxjQUFjLEVBQUU7WUFDZCxRQUFRLEVBQUUsQ0FBQztZQUNYLE9BQU8sRUFBRSxFQUFFO1NBQ1o7UUFDRCxjQUFjLEVBQUUsSUFBSTtLQUNyQixDQUFDO0lBRUYsWUFBNkIsTUFBcUI7UUFBckIsV0FBTSxHQUFOLE1BQU0sQ0FBZTtJQUFHLENBQUM7SUFFdEQ7O09BRUc7SUFDSCxrQkFBa0IsQ0FDaEIsVUFBa0IsRUFDbEIsU0FBNEIsT0FBTztRQUVuQyxNQUFNLEtBQUssR0FDVCxNQUFNLEtBQUssT0FBTztZQUNoQixDQUFDLENBQUMsbUNBQW1DO1lBQ3JDLENBQUMsQ0FBQyxtQ0FBbUMsQ0FBQztRQUUxQyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsRUFBRSxDQUFDO1lBQzVCLE1BQU0sSUFBSSw0QkFBbUIsQ0FDM0IsaUNBQWlDLE1BQU0sdUJBQXVCLENBQy9ELENBQUM7UUFDSixDQUFDO1FBQ0QsT0FBTyxJQUFJLENBQUM7SUFDZCxDQUFDO0lBRUQ7O09BRUc7SUFDSCxnQkFBZ0IsQ0FBQyxRQUFnQixFQUFFLGdCQUEyQjtRQUM1RCxNQUFNLE9BQU8sR0FB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QUFZLEVBQUUsQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO0lBQ3pDLENBQUM7SUFFRDs7T0FFRztJQUNLLGtCQUFrQixDQUFDLFVBQWtCO1FBQzNDLE1BQU0sQ0FBQyxLQUFLLEVBQUUsT0FBTyxDQUFDLEdBQUcsVUFBVSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDM0QsT0FBTyxLQUFLLEdBQUcsRUFBRSxHQUFHLE9BQU8sQ0FBQztJQUM5QixDQUFDO0lBRUQ7O09BRUc7SUFDSyxtQkFBbUIsQ0FBQyxPQUFlO1FBQ3pDLE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxHQUFHLEVBQUUsQ0FBQyxDQUFDO1FBQ3ZDLE1BQU0sSUFBSSxHQUFHLE9BQU8sR0FBRyxFQUFFLENBQUM7UUFDMUIsT0FBTyxHQUFHLEtBQUssQ0FBQyxRQUFRLEVBQUUsQ0FBQyxRQUFRLENBQUMsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxJQUFJLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQyxRQUFRLENBQUMsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxFQUFFLENBQUM7SUFDcEYsQ0FBQztDQUNGLENBQUE7QUEzV1ksb0VBQTRCO3VDQUE1Qiw0QkFBNEI7SUFEeEMsSUFBQSxtQkFBVSxHQUFFO3lEQWlCMEIsc0NBQWEsb0JBQWIsc0NBQWE7R0FoQnZDLDRCQUE0QixDQTJXeEMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL2Jvb2tpbmcvc2VydmljZXMvYXZhaWxhYmlsaXR5LXZhbGlkYXRvci5zZXJ2aWNlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUsIEJhZFJlcXVlc3RFeGNlcHRpb24gfSBmcm9tICdAbmVzdGpzL2NvbW1vbic7XG5pbXBvcnQgeyBQcmlzbWFTZXJ2aWNlIH0gZnJvbSAnLi4vLi4vcHJvdmlkZXJzL3ByaXNtYS1jbGllbnQucHJvdmlkZXInO1xuXG5leHBvcnQgaW50ZXJmYWNlIFZhbGlkYXRpb25Db25maWcge1xuICBhbGxvd2VkRHVyYXRpb25zOiBudW1iZXJbXTsgLy8gbWludXRlc1xuICB0aW1lRm9ybWF0OiAnSEg6TU0nIHwgJ0hIOm1tJztcbiAgdGltZXpvbmU6IHN0cmluZztcbiAgYnVzaW5lc3NIb3Vyczoge1xuICAgIHN0YXJ0OiBzdHJpbmc7IC8vIEhIOk1NXG4gICAgZW5kOiBzdHJpbmc7IC8vIEhIOk1NXG4gIH07XG4gIGFkdmFuY2VCb29raW5nOiB7XG4gICAgbWluSG91cnM6IG51bWJlcjtcbiAgICBtYXhEYXlzOiBudW1iZXI7XG4gIH07XG4gIHdlZWtlbmRCb29raW5nOiBib29sZWFuO1xufVxuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgQXZhaWxhYmlsaXR5VmFsaWRhdG9yU2VydmljZSB7XG4gIHByaXZhdGUgcmVhZG9ubHkgZGVmYXVsdENvbmZpZzogVmFsaWRhdGlvbkNvbmZpZyA9IHtcbiAgICBhbGxvd2VkRHVyYXRpb25zOiBbMzAsIDYwLCA5MCwgMTIwXSxcbiAgICB0aW1lRm9ybWF0OiAnSEg6TU0nLFxuICAgIHRpbWV6b25lOiAnVVRDJyxcbiAgICBidXNpbmVzc0hvdXJzOiB7XG4gICAgICBzdGFydDogJzA4OjAwJyxcbiAgICAgIGVuZDogJzIwOjAwJyxcbiAgICB9LFxuICAgIGFkdmFuY2VCb29raW5nOiB7XG4gICAgICBtaW5Ib3VyczogMixcbiAgICAgIG1heERheXM6IDkwLFxuICAgIH0sXG4gICAgd2Vla2VuZEJvb2tpbmc6IHRydWUsXG4gIH07XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSByZWFkb25seSBwcmlzbWE6IFByaXNtYVNlcnZpY2UpIHt9XG5cbiAgLyoqXG4gICAqIFZhbGlkYXRlIHRpbWUgZm9ybWF0IChISDpNTSBvciBISDptbSlcbiAgICovXG4gIHZhbGlkYXRlVGltZUZvcm1hdChcbiAgICB0aW1lU3RyaW5nOiBzdHJpbmcsXG4gICAgZm9ybWF0OiAnSEg6TU0nIHwgJ0hIOm1tJyA9ICdISDpNTScsXG4gICk6IGJvb2xlYW4ge1xuICAgIGNvbnN0IHJlZ2V4ID1cbiAgICAgIGZvcm1hdCA9PT0gJ0hIOk1NJ1xuICAgICAgICA/IC9eKFswLTFdP1swLTldfDJbMC0zXSk6WzAtNV1bMC05XSQvXG4gICAgICAgIDogL14oWzAtMV0/WzAtOV18MlswLTNdKTpbMC01XVswLTldJC87XG5cbiAgICBpZiAoIXJlZ2V4LnRlc3QodGltZVN0cmluZykpIHtcbiAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0RXhjZXB0aW9uKFxuICAgICAgICBgSW52YWxpZCB0aW1lIGZvcm1hdC4gRXhwZWN0ZWQgJHtmb3JtYXR9IGZvcm1hdCAoZS5nLiwgMDk6MzApYCxcbiAgICAgICk7XG4gICAgfVxuICAgIHJldHVybiB0cnVlO1xuICB9XG5cbiAgLyoqXG4gICAqIFZhbGlkYXRlIG1lZXRpbmcgZHVyYXRpb25cbiAgICovXG4gIHZhbGlkYXRlRHVyYXRpb24oZHVyYXRpb246IG51bWJlciwgYWxsb3dlZER1cmF0aW9ucz86IG51bWJlcltdKTogYm9vbGVhbiB7XG4gICAgY29uc3QgYWxsb3dlZCA9IGFsbG93ZWREdXJhdGlvbnMgfHwgdGhpcy5kZWZhdWx0Q29uZmlnLmFsbG93ZWREdXJhdGlvbnM7XG5cbiAgICBpZiAoIWFsbG93ZWQuaW5jbHVkZXMoZHVyYXRpb24pKSB7XG4gICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdEV4Y2VwdGlvbihcbiAgICAgICAgYEludmFsaWQgZHVyYXRpb24uIEFsbG93ZWQgZHVyYXRpb25zIGFyZTogJHthbGxvd2VkLmpvaW4oJywgJyl9IG1pbnV0ZXNgLFxuICAgICAgKTtcbiAgICB9XG4gICAgcmV0dXJuIHRydWU7XG4gIH1cblxuICAvKipcbiAgICogVmFsaWRhdGUgYm9va2luZyBkYXRlIGFuZCB0aW1lIGNvbnN0cmFpbnRzXG4gICAqL1xuICB2YWxpZGF0ZUJvb2tpbmdEYXRlVGltZShcbiAgICBzdGFydFRpbWU6IERhdGUsXG4gICAgZHVyYXRpb246IG51bWJlcixcbiAgICBjb25maWc6IFBhcnRpYWw8VmFsaWRhdGlvbkNvbmZpZz4gPSB7fSxcbiAgKTogYm9vbGVhbiB7XG4gICAgY29uc3QgZmluYWxDb25maWcgPSB7IC4uLnRoaXMuZGVmYXVsdENvbmZpZywgLi4uY29uZmlnIH07XG5cbiAgICB0aGlzLnZhbGlkYXRlQWR2YW5jZUJvb2tpbmcoc3RhcnRUaW1lLCBmaW5hbENvbmZpZyk7XG4gICAgdGhpcy52YWxpZGF0ZUJ1c2luZXNzSG91cnMoc3RhcnRUaW1lLCBkdXJhdGlvbiwgZmluYWxDb25maWcpO1xuICAgIHRoaXMudmFsaWRhdGVXZWVrZW5kQm9va2luZyhzdGFydFRpbWUsIGZpbmFsQ29uZmlnKTtcbiAgICB0aGlzLnZhbGlkYXRlRHVyYXRpb24oZHVyYXRpb24sIGZpbmFsQ29uZmlnLmFsbG93ZWREdXJhdGlvbnMpO1xuXG4gICAgcmV0dXJuIHRydWU7XG4gIH1cblxuICAvKipcbiAgICogVmFsaWRhdGUgYWR2YW5jZSBib29raW5nIGNvbnN0cmFpbnRzXG4gICAqL1xuICBwcml2YXRlIHZhbGlkYXRlQWR2YW5jZUJvb2tpbmcoXG4gICAgc3RhcnRUaW1lOiBEYXRlLFxuICAgIGNvbmZpZzogVmFsaWRhdGlvbkNvbmZpZyxcbiAgKTogdm9pZCB7XG4gICAgY29uc3Qgbm93ID0gbmV3IERhdGUoKTtcbiAgICBjb25zdCB0aW1lRGlmZiA9IHN0YXJ0VGltZS5nZXRUaW1lKCkgLSBub3cuZ2V0VGltZSgpO1xuICAgIGNvbnN0IGhvdXJzRGlmZiA9IHRpbWVEaWZmIC8gKDEwMDAgKiA2MCAqIDYwKTtcbiAgICBjb25zdCBkYXlzRGlmZiA9IHRpbWVEaWZmIC8gKDEwMDAgKiA2MCAqIDYwICogMjQpO1xuXG4gICAgaWYgKGhvdXJzRGlmZiA8IGNvbmZpZy5hZHZhbmNlQm9va2luZy5taW5Ib3Vycykge1xuICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFeGNlcHRpb24oXG4gICAgICAgIGBCb29raW5ncyBtdXN0IGJlIG1hZGUgYXQgbGVhc3QgJHtjb25maWcuYWR2YW5jZUJvb2tpbmcubWluSG91cnN9IGhvdXJzIGluIGFkdmFuY2VgLFxuICAgICAgKTtcbiAgICB9XG5cbiAgICBpZiAoZGF5c0RpZmYgPiBjb25maWcuYWR2YW5jZUJvb2tpbmcubWF4RGF5cykge1xuICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFeGNlcHRpb24oXG4gICAgICAgIGBCb29raW5ncyBjYW4gb25seSBiZSBtYWRlIHVwIHRvICR7Y29uZmlnLmFkdmFuY2VCb29raW5nLm1heERheXN9IGRheXMgaW4gYWR2YW5jZWAsXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBWYWxpZGF0ZSBidXNpbmVzcyBob3VycyBjb25zdHJhaW50c1xuICAgKi9cbiAgcHJpdmF0ZSB2YWxpZGF0ZUJ1c2luZXNzSG91cnMoXG4gICAgc3RhcnRUaW1lOiBEYXRlLFxuICAgIGR1cmF0aW9uOiBudW1iZXIsXG4gICAgY29uZmlnOiBWYWxpZGF0aW9uQ29uZmlnLFxuICApOiB2b2lkIHtcbiAgICBjb25zdCBlbmRUaW1lID0gbmV3IERhdGUoc3RhcnRUaW1lLmdldFRpbWUoKSArIGR1cmF0aW9uICogNjAgKiAxMDAwKTtcblxuICAgIGNvbnN0IHN0YXJ0VGltZVN0ciA9IHRoaXMuZm9ybWF0VGltZShzdGFydFRpbWUpO1xuICAgIGNvbnN0IGVuZFRpbWVTdHIgPSB0aGlzLmZvcm1hdFRpbWUoZW5kVGltZSk7XG5cbiAgICBpZiAoXG4gICAgICBzdGFydFRpbWVTdHIgPCBjb25maWcuYnVzaW5lc3NIb3Vycy5zdGFydCB8fFxuICAgICAgZW5kVGltZVN0ciA+IGNvbmZpZy5idXNpbmVzc0hvdXJzLmVuZFxuICAgICkge1xuICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFeGNlcHRpb24oXG4gICAgICAgIGBNZWV0aW5nIG11c3QgYmUgd2l0aGluIGJ1c2luZXNzIGhvdXJzICgke2NvbmZpZy5idXNpbmVzc0hvdXJzLnN0YXJ0fSAtICR7Y29uZmlnLmJ1c2luZXNzSG91cnMuZW5kfSlgLFxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogVmFsaWRhdGUgd2Vla2VuZCBib29raW5nIGlmIG5vdCBhbGxvd2VkXG4gICAqL1xuICBwcml2YXRlIHZhbGlkYXRlV2Vla2VuZEJvb2tpbmcoXG4gICAgc3RhcnRUaW1lOiBEYXRlLFxuICAgIGNvbmZpZzogVmFsaWRhdGlvbkNvbmZpZyxcbiAgKTogdm9pZCB7XG4gICAgaWYgKCFjb25maWcud2Vla2VuZEJvb2tpbmcpIHtcbiAgICAgIGNvbnN0IGRheU9mV2VlayA9IHN0YXJ0VGltZS5nZXREYXkoKTtcbiAgICAgIGlmIChkYXlPZldlZWsgPT09IDAgfHwgZGF5T2ZXZWVrID09PSA2KSB7XG4gICAgICAgIC8vIFN1bmRheSA9IDAsIFNhdHVyZGF5ID0gNlxuICAgICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdEV4Y2VwdGlvbignV2Vla2VuZCBib29raW5ncyBhcmUgbm90IGFsbG93ZWQnKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogQ2hlY2sgaWYgdGhlcmFwaXN0IGlzIGF2YWlsYWJsZSBhdCB0aGUgc3BlY2lmaWVkIHRpbWVcbiAgICovXG4gIGFzeW5jIHZhbGlkYXRlVGhlcmFwaXN0QXZhaWxhYmlsaXR5KFxuICAgIHRoZXJhcGlzdElkOiBzdHJpbmcsXG4gICAgc3RhcnRUaW1lOiBEYXRlLFxuICAgIGR1cmF0aW9uOiBudW1iZXIsXG4gICk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgIGNvbnN0IGRheU9mV2VlayA9IHN0YXJ0VGltZS5nZXREYXkoKTtcbiAgICBjb25zdCBzdGFydFRpbWVTdHIgPSB0aGlzLmZvcm1hdFRpbWUoc3RhcnRUaW1lKTtcbiAgICBjb25zdCBlbmRUaW1lID0gbmV3IERhdGUoc3RhcnRUaW1lLmdldFRpbWUoKSArIGR1cmF0aW9uICogNjAgKiAxMDAwKTtcbiAgICBjb25zdCBlbmRUaW1lU3RyID0gdGhpcy5mb3JtYXRUaW1lKGVuZFRpbWUpO1xuXG4gICAgY29uc3QgYXZhaWxhYmlsaXR5ID0gYXdhaXQgdGhpcy5wcmlzbWEudGhlcmFwaXN0QXZhaWxhYmlsaXR5LmZpbmRGaXJzdCh7XG4gICAgICB3aGVyZToge1xuICAgICAgICB0aGVyYXBpc3RJZCxcbiAgICAgICAgZGF5T2ZXZWVrLFxuICAgICAgICBzdGFydFRpbWU6IHsgbHRlOiBzdGFydFRpbWVTdHIgfSxcbiAgICAgICAgZW5kVGltZTogeyBndGU6IGVuZFRpbWVTdHIgfSxcbiAgICAgICAgaXNBdmFpbGFibGU6IHRydWUsXG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgaWYgKCFhdmFpbGFiaWxpdHkpIHtcbiAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0RXhjZXB0aW9uKFxuICAgICAgICAnVGhlcmFwaXN0IGlzIG5vdCBhdmFpbGFibGUgYXQgdGhlIHJlcXVlc3RlZCB0aW1lJyxcbiAgICAgICk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRydWU7XG4gIH1cblxuICAvKipcbiAgICogVmFsaWRhdGUgY2xpZW50LXRoZXJhcGlzdCByZWxhdGlvbnNoaXAgZXhpc3RzXG4gICAqL1xuICBhc3luYyB2YWxpZGF0ZUNsaWVudFRoZXJhcGlzdFJlbGF0aW9uc2hpcChcbiAgICBjbGllbnRJZDogc3RyaW5nLFxuICAgIHRoZXJhcGlzdElkOiBzdHJpbmcsXG4gICk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgIGNvbnN0IHJlbGF0aW9uc2hpcCA9IGF3YWl0IHRoaXMucHJpc21hLmNsaWVudFRoZXJhcGlzdC5maW5kRmlyc3Qoe1xuICAgICAgd2hlcmU6IHtcbiAgICAgICAgY2xpZW50SWQsXG4gICAgICAgIHRoZXJhcGlzdElkLFxuICAgICAgICBzdGF0dXM6ICdBQ1RJVkUnLCAvLyBBc3N1bWluZyB0aGVyZSdzIGEgc3RhdHVzIGZpZWxkXG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgaWYgKCFyZWxhdGlvbnNoaXApIHtcbiAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0RXhjZXB0aW9uKFxuICAgICAgICAnWW91IGNhbiBvbmx5IGJvb2sgc2Vzc2lvbnMgd2l0aCB5b3VyIGFzc2lnbmVkIHRoZXJhcGlzdHMnLFxuICAgICAgKTtcbiAgICB9XG5cbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBWYWxpZGF0ZSB0aGVyYXBpc3QgZXhpc3RzIGFuZCBpcyBhY3RpdmVcbiAgICovXG4gIGFzeW5jIHZhbGlkYXRlVGhlcmFwaXN0RXhpc3RzKHRoZXJhcGlzdElkOiBzdHJpbmcpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICBjb25zdCB0aGVyYXBpc3QgPSBhd2FpdCB0aGlzLnByaXNtYS50aGVyYXBpc3QuZmluZEZpcnN0KHtcbiAgICAgIHdoZXJlOiB7XG4gICAgICAgIHVzZXJJZDogdGhlcmFwaXN0SWQsXG4gICAgICAgIHN0YXR1czogJ2FwcHJvdmVkJyxcbiAgICAgIH0sXG4gICAgICBpbmNsdWRlOiB7XG4gICAgICAgIHVzZXI6IHtcbiAgICAgICAgICBzZWxlY3Q6IHtcbiAgICAgICAgICAgIGlzQWN0aXZlOiB0cnVlLFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgaWYgKCF0aGVyYXBpc3QgfHwgIXRoZXJhcGlzdC51c2VyLmlzQWN0aXZlKSB7XG4gICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdEV4Y2VwdGlvbignVGhlcmFwaXN0IG5vdCBmb3VuZCBvciBpbmFjdGl2ZScpO1xuICAgIH1cblxuICAgIHJldHVybiB0cnVlO1xuICB9XG5cbiAgLyoqXG4gICAqIFZhbGlkYXRlIGF2YWlsYWJpbGl0eSBzbG90IG92ZXJsYXBcbiAgICovXG4gIHZhbGlkYXRlQXZhaWxhYmlsaXR5T3ZlcmxhcChcbiAgICBzdGFydFRpbWUxOiBzdHJpbmcsXG4gICAgZW5kVGltZTE6IHN0cmluZyxcbiAgICBzdGFydFRpbWUyOiBzdHJpbmcsXG4gICAgZW5kVGltZTI6IHN0cmluZyxcbiAgKTogYm9vbGVhbiB7XG4gICAgaWYgKHN0YXJ0VGltZTEgPj0gZW5kVGltZTEpIHtcbiAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0RXhjZXB0aW9uKCdTdGFydCB0aW1lIG11c3QgYmUgYmVmb3JlIGVuZCB0aW1lJyk7XG4gICAgfVxuXG4gICAgaWYgKHN0YXJ0VGltZTIgPj0gZW5kVGltZTIpIHtcbiAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0RXhjZXB0aW9uKCdTdGFydCB0aW1lIG11c3QgYmUgYmVmb3JlIGVuZCB0aW1lJyk7XG4gICAgfVxuXG4gICAgY29uc3QgaGFzT3ZlcmxhcCA9IHN0YXJ0VGltZTEgPCBlbmRUaW1lMiAmJiBlbmRUaW1lMSA+IHN0YXJ0VGltZTI7XG5cbiAgICBpZiAoaGFzT3ZlcmxhcCkge1xuICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFeGNlcHRpb24oXG4gICAgICAgICdBdmFpbGFiaWxpdHkgc2xvdCBvdmVybGFwcyB3aXRoIGV4aXN0aW5nIGF2YWlsYWJpbGl0eScsXG4gICAgICApO1xuICAgIH1cblxuICAgIHJldHVybiB0cnVlO1xuICB9XG5cbiAgLyoqXG4gICAqIFZhbGlkYXRlIHRpbWV6b25lIChpZiB0aW1lem9uZSBzdXBwb3J0IGlzIG5lZWRlZClcbiAgICovXG4gIHZhbGlkYXRlVGltZXpvbmUodGltZXpvbmU6IHN0cmluZyk6IGJvb2xlYW4ge1xuICAgIHRyeSB7XG4gICAgICAvLyBDaGVjayBpZiB0aW1lem9uZSBpcyB2YWxpZFxuICAgICAgSW50bC5EYXRlVGltZUZvcm1hdCh1bmRlZmluZWQsIHsgdGltZVpvbmU6IHRpbWV6b25lIH0pO1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfSBjYXRjaCB7XG4gICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdEV4Y2VwdGlvbihgSW52YWxpZCB0aW1lem9uZTogJHt0aW1lem9uZX1gKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogQ29tcHJlaGVuc2l2ZSB2YWxpZGF0aW9uIGZvciBtZWV0aW5nIGNyZWF0aW9uXG4gICAqL1xuICBhc3luYyB2YWxpZGF0ZU1lZXRpbmdDcmVhdGlvbih7XG4gICAgdGhlcmFwaXN0SWQsXG4gICAgY2xpZW50SWQsXG4gICAgc3RhcnRUaW1lLFxuICAgIGR1cmF0aW9uLFxuICAgIGNvbmZpZyA9IHt9LFxuICB9OiB7XG4gICAgdGhlcmFwaXN0SWQ6IHN0cmluZztcbiAgICBjbGllbnRJZDogc3RyaW5nO1xuICAgIHN0YXJ0VGltZTogRGF0ZTtcbiAgICBkdXJhdGlvbjogbnVtYmVyO1xuICAgIGNvbmZpZz86IFBhcnRpYWw8VmFsaWRhdGlvbkNvbmZpZz47XG4gIH0pOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICAvLyBSdW4gYWxsIHZhbGlkYXRpb25zXG4gICAgYXdhaXQgUHJvbWlzZS5hbGwoW1xuICAgICAgdGhpcy52YWxpZGF0ZVRoZXJhcGlzdEV4aXN0cyh0aGVyYXBpc3RJZCksXG4gICAgICB0aGlzLnZhbGlkYXRlQ2xpZW50VGhlcmFwaXN0UmVsYXRpb25zaGlwKGNsaWVudElkLCB0aGVyYXBpc3RJZCksXG4gICAgICB0aGlzLnZhbGlkYXRlVGhlcmFwaXN0QXZhaWxhYmlsaXR5KHRoZXJhcGlzdElkLCBzdGFydFRpbWUsIGR1cmF0aW9uKSxcbiAgICBdKTtcblxuICAgIHRoaXMudmFsaWRhdGVCb29raW5nRGF0ZVRpbWUoc3RhcnRUaW1lLCBkdXJhdGlvbiwgY29uZmlnKTtcblxuICAgIHJldHVybiB0cnVlO1xuICB9XG5cbiAgLyoqXG4gICAqIENvbXByZWhlbnNpdmUgdmFsaWRhdGlvbiBmb3IgYXZhaWxhYmlsaXR5IGNyZWF0aW9uXG4gICAqL1xuICBhc3luYyB2YWxpZGF0ZUF2YWlsYWJpbGl0eUNyZWF0aW9uKHtcbiAgICB0aGVyYXBpc3RJZCxcbiAgICBkYXlPZldlZWssXG4gICAgc3RhcnRUaW1lLFxuICAgIGVuZFRpbWUsXG4gIH06IHtcbiAgICB0aGVyYXBpc3RJZDogc3RyaW5nO1xuICAgIGRheU9mV2VlazogbnVtYmVyO1xuICAgIHN0YXJ0VGltZTogc3RyaW5nO1xuICAgIGVuZFRpbWU6IHN0cmluZztcbiAgfSk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgIC8vIFZhbGlkYXRlIHRoZXJhcGlzdCBleGlzdHNcbiAgICBhd2FpdCB0aGlzLnZhbGlkYXRlVGhlcmFwaXN0RXhpc3RzKHRoZXJhcGlzdElkKTtcblxuICAgIC8vIFZhbGlkYXRlIHRpbWUgZm9ybWF0c1xuICAgIHRoaXMudmFsaWRhdGVUaW1lRm9ybWF0KHN0YXJ0VGltZSk7XG4gICAgdGhpcy52YWxpZGF0ZVRpbWVGb3JtYXQoZW5kVGltZSk7XG5cbiAgICAvLyBWYWxpZGF0ZSB0aW1lIHJhbmdlXG4gICAgaWYgKHN0YXJ0VGltZSA+PSBlbmRUaW1lKSB7XG4gICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdEV4Y2VwdGlvbignU3RhcnQgdGltZSBtdXN0IGJlIGJlZm9yZSBlbmQgdGltZScpO1xuICAgIH1cblxuICAgIC8vIFZhbGlkYXRlIGRheSBvZiB3ZWVrXG4gICAgaWYgKGRheU9mV2VlayA8IDAgfHwgZGF5T2ZXZWVrID4gNikge1xuICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFeGNlcHRpb24oXG4gICAgICAgICdEYXkgb2Ygd2VlayBtdXN0IGJlIGJldHdlZW4gMCAoU3VuZGF5KSBhbmQgNiAoU2F0dXJkYXkpJyxcbiAgICAgICk7XG4gICAgfVxuXG4gICAgLy8gQ2hlY2sgZm9yIG92ZXJsYXBwaW5nIGF2YWlsYWJpbGl0eVxuICAgIGNvbnN0IG92ZXJsYXBwaW5nID0gYXdhaXQgdGhpcy5wcmlzbWEudGhlcmFwaXN0QXZhaWxhYmlsaXR5LmZpbmRGaXJzdCh7XG4gICAgICB3aGVyZToge1xuICAgICAgICB0aGVyYXBpc3RJZCxcbiAgICAgICAgZGF5T2ZXZWVrLFxuICAgICAgICBPUjogW1xuICAgICAgICAgIHtcbiAgICAgICAgICAgIHN0YXJ0VGltZTogeyBsdDogZW5kVGltZSB9LFxuICAgICAgICAgICAgZW5kVGltZTogeyBndDogc3RhcnRUaW1lIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgXSxcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICBpZiAob3ZlcmxhcHBpbmcpIHtcbiAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0RXhjZXB0aW9uKFxuICAgICAgICAnQXZhaWxhYmlsaXR5IHNsb3Qgb3ZlcmxhcHMgd2l0aCBleGlzdGluZyBhdmFpbGFiaWxpdHknLFxuICAgICAgKTtcbiAgICB9XG5cbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBGb3JtYXQgRGF0ZSB0byBISDpNTSBzdHJpbmdcbiAgICovXG4gIHByaXZhdGUgZm9ybWF0VGltZShkYXRlOiBEYXRlKTogc3RyaW5nIHtcbiAgICByZXR1cm4gZGF0ZS50b1RpbWVTdHJpbmcoKS5zbGljZSgwLCA1KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBQYXJzZSB0aW1lIHN0cmluZyB0byBtaW51dGVzIHNpbmNlIG1pZG5pZ2h0XG4gICAqL1xuICBwcml2YXRlIHBhcnNlVGltZVRvTWludXRlcyh0aW1lU3RyaW5nOiBzdHJpbmcpOiBudW1iZXIge1xuICAgIGNvbnN0IFtob3VycywgbWludXRlc10gPSB0aW1lU3RyaW5nLnNwbGl0KCc6JykubWFwKE51bWJlcik7XG4gICAgcmV0dXJuIGhvdXJzICogNjAgKyBtaW51dGVzO1xuICB9XG5cbiAgLyoqXG4gICAqIENvbnZlcnQgbWludXRlcyBzaW5jZSBtaWRuaWdodCB0byBISDpNTSBzdHJpbmdcbiAgICovXG4gIHByaXZhdGUgbWludXRlc1RvVGltZVN0cmluZyhtaW51dGVzOiBudW1iZXIpOiBzdHJpbmcge1xuICAgIGNvbnN0IGhvdXJzID0gTWF0aC5mbG9vcihtaW51dGVzIC8gNjApO1xuICAgIGNvbnN0IG1pbnMgPSBtaW51dGVzICUgNjA7XG4gICAgcmV0dXJuIGAke2hvdXJzLnRvU3RyaW5nKCkucGFkU3RhcnQoMiwgJzAnKX06JHttaW5zLnRvU3RyaW5nKCkucGFkU3RhcnQoMiwgJzAnKX1gO1xuICB9XG59XG4iXSwidmVyc2lvbiI6M30=