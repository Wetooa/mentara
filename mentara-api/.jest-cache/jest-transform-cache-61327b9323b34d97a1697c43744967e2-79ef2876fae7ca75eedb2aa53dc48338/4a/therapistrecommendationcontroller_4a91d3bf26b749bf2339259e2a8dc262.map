{"file":"/home/wetooa/Documents/code/projects/mentara/mentara-api/src/therapist/therapist-recommendation.controller.ts","mappings":"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","names":[],"sources":["/home/wetooa/Documents/code/projects/mentara/mentara-api/src/therapist/therapist-recommendation.controller.ts"],"sourcesContent":["import {\n  Controller,\n  Get,\n  Query,\n  Param,\n  UseGuards,\n  HttpCode,\n  HttpStatus,\n  InternalServerErrorException,\n  NotFoundException,\n} from '@nestjs/common';\nimport { TherapistRecommendationService } from './therapist-recommendation.service';\nimport { PrismaService } from '../providers/prisma-client.provider';\nimport { JwtAuthGuard } from '../auth/guards/jwt-auth.guard';\nimport { CurrentUserId } from '../auth/decorators/current-user-id.decorator';\nimport { ZodValidationPipe } from '../common/pipes/zod-validation.pipe';\nimport {\n  ApiTags,\n  ApiOperation,\n  ApiResponse,\n  ApiBody,\n  ApiBearerAuth,\n  ApiParam,\n  ApiQuery,\n} from '@nestjs/swagger';\nimport {\n  TherapistRecommendationRequestSchema,\n  TherapistRecommendationResponseDtoSchema,\n  TherapistRecommendationQuerySchema,\n  WelcomeRecommendationQuerySchema,\n  type TherapistRecommendationRequest,\n  type TherapistRecommendationResponseDto,\n  type TherapistRecommendationQuery,\n  type WelcomeRecommendationQuery,\n} from 'mentara-commons';\n\n@ApiTags('therapist-recommendation')\n@ApiBearerAuth('JWT-auth')\n@Controller('therapist-recommendations')\n@UseGuards(JwtAuthGuard)\nexport class TherapistRecommendationController {\n  constructor(\n    private readonly therapistRecommendationService: TherapistRecommendationService,\n    private readonly prisma: PrismaService,\n  ) {}\n\n  @Get()\n  @ApiOperation({\n    summary: 'Retrieve get recommended therapists',\n\n    description: 'Retrieve get recommended therapists',\n  })\n  @ApiResponse({\n    status: 200,\n\n    description: 'Retrieved successfully',\n  })\n  @ApiResponse({ status: 401, description: 'Unauthorized' })\n  @HttpCode(HttpStatus.OK)\n  async getRecommendedTherapists(\n    @CurrentUserId() clerkId: string,\n    @Query(new ZodValidationPipe(TherapistRecommendationQuerySchema))\n    query: TherapistRecommendationQuery,\n  ): Promise<TherapistRecommendationResponseDto> {\n    try {\n      const user = await this.prisma.user.findUnique({\n        where: { id: clerkId },\n      });\n\n      if (!user) {\n        throw new NotFoundException(`User with ID ${clerkId} not found`);\n      }\n\n      const request: TherapistRecommendationRequest = {\n        userId: user.id,\n        limit: query.limit,\n        includeInactive: query.includeInactive,\n        province: query.province,\n        maxHourlyRate: query.maxHourlyRate,\n      };\n      return await this.therapistRecommendationService.getRecommendedTherapists(\n        request,\n      );\n    } catch (error) {\n      if (error instanceof NotFoundException) {\n        throw error;\n      }\n      throw new InternalServerErrorException(\n        error instanceof Error ? error.message : error,\n      );\n    }\n  }\n\n  @Get('compatibility/:therapistId')\n  @ApiOperation({\n    summary: 'Retrieve get compatibility analysis',\n\n    description: 'Retrieve get compatibility analysis',\n  })\n  @ApiResponse({\n    status: 200,\n\n    description: 'Retrieved successfully',\n  })\n  @ApiResponse({ status: 401, description: 'Unauthorized' })\n  @HttpCode(HttpStatus.OK)\n  async getCompatibilityAnalysis(\n    @CurrentUserId() clerkId: string,\n    @Param('therapistId') therapistId: string,\n  ) {\n    try {\n      const user = await this.prisma.user.findUnique({\n        where: { id: clerkId },\n      });\n\n      if (!user) {\n        throw new NotFoundException(`User with ID ${clerkId} not found`);\n      }\n\n      return await this.therapistRecommendationService.getCompatibilityAnalysis(\n        user.id,\n        therapistId,\n      );\n    } catch (error) {\n      if (error instanceof NotFoundException) {\n        throw error;\n      }\n      throw new InternalServerErrorException(\n        error instanceof Error ? error.message : error,\n      );\n    }\n  }\n\n  @Get('welcome')\n  @ApiOperation({\n    summary: 'Retrieve get welcome recommendations',\n\n    description: 'Retrieve get welcome recommendations',\n  })\n  @ApiResponse({\n    status: 200,\n\n    description: 'Retrieved successfully',\n  })\n  @ApiResponse({ status: 401, description: 'Unauthorized' })\n  @HttpCode(HttpStatus.OK)\n  async getWelcomeRecommendations(\n    @CurrentUserId() userId: string,\n    @Query(new ZodValidationPipe(WelcomeRecommendationQuerySchema))\n    query: WelcomeRecommendationQuery,\n  ) {\n    try {\n      // Verify user exists and get client status\n      const [user, client] = await Promise.all([\n        this.prisma.user.findUnique({\n          where: { id: userId },\n          select: {\n            id: true,\n            firstName: true,\n            lastName: true,\n            role: true,\n            createdAt: true,\n          },\n        }),\n        this.prisma.client.findUnique({\n          where: { userId },\n          select: {\n            hasSeenTherapistRecommendations: true,\n            createdAt: true,\n          },\n        }),\n      ]);\n\n      if (!user) {\n        throw new NotFoundException(`User with ID ${userId} not found`);\n      }\n\n      if (!client) {\n        throw new NotFoundException(\n          `Client profile not found for user ${userId}`,\n        );\n      }\n\n      // Check if this is truly a first-time user (unless forcing refresh)\n      const isFirstTime = !client.hasSeenTherapistRecommendations;\n      const shouldShowWelcome = isFirstTime || query.forceRefresh;\n\n      if (!shouldShowWelcome) {\n        // User has already seen recommendations, redirect to regular recommendations\n        return {\n          isFirstTime: false,\n          redirectTo: '/therapist-recommendations',\n          message: 'User has already completed welcome flow',\n          lastSeenAt: client.createdAt,\n        };\n      }\n\n      // Get personalized welcome recommendations\n      const request: TherapistRecommendationRequest = {\n        userId: user.id,\n        limit: query.limit,\n        includeInactive: false, // Only active therapists for welcome\n        province: query.province,\n        maxHourlyRate: undefined, // No rate filter for initial welcome\n      };\n\n      const recommendations =\n        await this.therapistRecommendationService.getRecommendedTherapists(\n          request,\n        );\n\n      // Enhance recommendations with welcome-specific data\n      const enhancedRecommendations = {\n        ...recommendations,\n        welcomeMessage: this.generateWelcomeMessage(\n          user.firstName,\n          isFirstTime,\n        ),\n        isFirstTime,\n        userInfo: {\n          firstName: user.firstName,\n          memberSince: user.createdAt,\n          needsOnboarding: isFirstTime,\n        },\n        nextSteps: {\n          canSendRequests: true,\n          recommendedActions: [\n            'Browse therapist profiles',\n            'Send requests to therapists you find interesting',\n            'Complete your profile for better matches',\n            'Take the mental health assessment for personalized recommendations',\n          ],\n        },\n        matchingInsights: {\n          totalAvailableTherapists: recommendations.totalCount,\n          recommendationEngine: 'AI-powered compatibility matching',\n          lastUpdated: new Date(),\n        },\n      };\n\n      return enhancedRecommendations;\n    } catch (error) {\n      if (error instanceof NotFoundException) {\n        throw error;\n      }\n      throw new InternalServerErrorException(\n        error instanceof Error ? error.message : error,\n      );\n    }\n  }\n\n  private generateWelcomeMessage(\n    firstName: string,\n    isFirstTime: boolean,\n  ): string {\n    if (isFirstTime) {\n      return `Welcome to Mentara, ${firstName}! We've curated a personalized list of therapists who may be a great fit for you. Take your time browsing through their profiles and don't hesitate to reach out to those who resonate with you.`;\n    } else {\n      return `Welcome back, ${firstName}! Here are some fresh therapist recommendations based on your preferences and our latest matching insights.`;\n    }\n  }\n}\n"],"version":3}