{"version":3,"names":["cov_2fykdp9i39","actualCoverage","common_1","s","require","core_1","role_utils_1","admin_only_decorator_1","AdminAuthGuard","AdminAuthGuard_1","reflector","roleUtils","logger","Logger","name","constructor","f","canActivate","context","isAdminOnly","getAllAndOverride","ADMIN_ONLY_KEY","getHandler","getClass","b","request","switchToHttp","getRequest","userId","warn","ForbiddenException","isAdmin","isUserAdmin","error","exports","__decorate","Injectable","Reflector","_a","Object","_b","RoleUtils"],"sources":["/home/wetooa/Documents/code/projects/mentara/mentara-api/src/auth/guards/admin-auth.guard.ts"],"sourcesContent":["import {\n  Injectable,\n  CanActivate,\n  ExecutionContext,\n  ForbiddenException,\n  Logger,\n} from '@nestjs/common';\nimport { Reflector } from '@nestjs/core';\nimport { Request } from 'express';\nimport { RoleUtils } from '../../utils/role-utils';\nimport { ADMIN_ONLY_KEY } from '../decorators/admin-only.decorator';\nimport '../../types';\n\n@Injectable()\nexport class AdminAuthGuard implements CanActivate {\n  private readonly logger = new Logger(AdminAuthGuard.name);\n\n  constructor(\n    private reflector: Reflector,\n    private roleUtils: RoleUtils,\n  ) {}\n\n  async canActivate(context: ExecutionContext): Promise<boolean> {\n    const isAdminOnly = this.reflector.getAllAndOverride<boolean>(\n      ADMIN_ONLY_KEY,\n      [context.getHandler(), context.getClass()],\n    );\n\n    if (!isAdminOnly) {\n      return true;\n    }\n\n    const request = context.switchToHttp().getRequest<Request>();\n    const userId = request.userId;\n\n    if (!userId) {\n      this.logger.warn('No user ID found in request');\n      throw new ForbiddenException('Authentication required');\n    }\n\n    try {\n      const isAdmin = await this.roleUtils.isUserAdmin(userId);\n\n      if (!isAdmin) {\n        this.logger.warn(\n          `User ${userId} attempted to access admin endpoint without permission`,\n        );\n        throw new ForbiddenException('Admin access required');\n      }\n\n      return true;\n    } catch (error) {\n      this.logger.error('Error checking admin permissions:', error);\n      throw new ForbiddenException('Unable to verify admin permissions');\n    }\n  }\n}\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;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","ignoreList":[]}