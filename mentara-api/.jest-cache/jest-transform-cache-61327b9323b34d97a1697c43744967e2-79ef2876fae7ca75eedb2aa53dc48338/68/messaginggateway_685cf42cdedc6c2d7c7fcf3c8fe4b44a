74a2971de6706c8dfc8d1fa6ebca63a8
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var __param = (this && this.__param) || function (paramIndex, decorator) {
    return function (target, key) { decorator(target, key, paramIndex); }
};
var MessagingGateway_1;
var _a, _b, _c, _d, _e, _f;
Object.defineProperty(exports, "__esModule", { value: true });
exports.MessagingGateway = void 0;
const websockets_1 = require("@nestjs/websockets");
const socket_io_1 = require("socket.io");
const common_1 = require("@nestjs/common");
const prisma_client_provider_1 = require("../providers/prisma-client.provider");
const websocket_auth_service_1 = require("./services/websocket-auth.service");
const mentara_commons_1 = require("mentara-commons");
let MessagingGateway = MessagingGateway_1 = class MessagingGateway {
    prisma;
    webSocketAuth;
    server;
    logger = new common_1.Logger(MessagingGateway_1.name);
    userSockets = new Map(); // userId -> Set of socket IDs
    conversationParticipants = new Map(); // conversationId -> Set of user IDs
    constructor(prisma, webSocketAuth) {
        this.prisma = prisma;
        this.webSocketAuth = webSocketAuth;
    }
    async handleConnection(client) {
        try {
            this.logger.log(`New WebSocket connection attempt: ${client.id}`);
            // Authenticate the socket connection using the new auth service
            const authResult = await this.webSocketAuth.authenticateSocket(client);
            if (!authResult) {
                this.logger.warn(`Client ${client.id} authentication failed`);
                client.emit('auth_error', {
                    message: 'Authentication failed. Please provide a valid token.',
                    code: 'AUTH_FAILED',
                });
                client.disconnect(true);
                return;
            }
            // Attach authenticated user info to socket
            client.userId = authResult.userId;
            client.userRole = authResult.role;
            client.isAuthenticated = true;
            // Verify user exists in database and is active
            const user = await this.prisma.user.findUnique({
                where: {
                    id: authResult.userId,
                    isActive: true, // Only allow active users
                },
                select: { id: true, role: true, isActive: true },
            });
            if (!user) {
                this.logger.warn(`User ${authResult.userId} not found or inactive`);
                client.emit('auth_error', {
                    message: 'User account not found or inactive',
                    code: 'USER_NOT_FOUND',
                });
                client.disconnect(true);
                return;
            }
            // Add socket to user's socket set
            if (!this.userSockets.has(authResult.userId)) {
                this.userSockets.set(authResult.userId, new Set());
            }
            this.userSockets.get(authResult.userId).add(client.id);
            // Join user to their conversation rooms
            await this.joinUserConversations(client, authResult.userId);
            // Subscribe user to their personal notification room
            await this.subscribeUserToPersonalRoom(client, authResult.userId);
            // Notify successful connection
            client.emit('authenticated', {
                userId: authResult.userId,
                role: user.role,
                message: 'Successfully authenticated and connected',
                timestamp: new Date().toISOString(),
            });
            // Emit user online status to their contacts
            await this.broadcastUserStatus(authResult.userId, 'online');
            this.logger.log(`User ${authResult.userId} successfully authenticated and connected with socket ${client.id}`);
        }
        catch (error) {
            this.logger.error(`Connection error for client ${client.id}:`, error);
            client.emit('connection_error', {
                message: 'Internal server error during connection',
                code: 'INTERNAL_ERROR',
            });
            client.disconnect(true);
        }
    }
    async handleDisconnect(client) {
        try {
            if (client.userId) {
                const userSockets = this.userSockets.get(client.userId);
                if (userSockets) {
                    userSockets.delete(client.id);
                    // If no more sockets for this user, remove from tracking
                    if (userSockets.size === 0) {
                        this.userSockets.delete(client.userId);
                        // Clean up conversation participants tracking
                        for (const [conversationId, participants,] of this.conversationParticipants.entries()) {
                            participants.delete(client.userId);
                            // Remove empty conversation sets
                            if (participants.size === 0) {
                                this.conversationParticipants.delete(conversationId);
                            }
                        }
                        // Broadcast user offline status to their contacts
                        await this.broadcastUserStatus(client.userId, 'offline');
                    }
                }
                this.logger.log(`User ${client.userId} disconnected socket ${client.id}`);
            }
            // Clean up authentication tracking
            this.webSocketAuth.cleanupConnection(client.id);
        }
        catch (error) {
            this.logger.error(`Error during disconnect cleanup for socket ${client.id}:`, error);
        }
    }
    async handleJoinConversation(client, data) {
        // Authentication guard
        if (!this.isAuthenticated(client)) {
            return;
        }
        try {
            const { conversationId } = data;
            const userId = client.userId;
            // Verify user is a participant in this conversation
            const participation = await this.prisma.conversationParticipant.findFirst({
                where: {
                    conversationId,
                    userId,
                    isActive: true,
                },
            });
            if (!participation) {
                client.emit('error', { message: 'Access denied to this conversation' });
                return;
            }
            // Join socket to conversation room
            void client.join(conversationId);
            // Add user to conversation participants tracking
            if (!this.conversationParticipants.has(conversationId)) {
                this.conversationParticipants.set(conversationId, new Set());
            }
            this.conversationParticipants.get(conversationId).add(userId);
            // Notify other participants that user joined
            client.to(conversationId).emit('user_joined_conversation', {
                conversationId,
                userId,
            });
            client.emit('conversation_joined', { conversationId });
            this.logger.log(`User ${userId} joined conversation ${conversationId}`);
        }
        catch (error) {
            this.logger.error('Error joining conversation:', error);
            client.emit('error', { message: 'Failed to join conversation' });
        }
    }
    handleLeaveConversation(client, data) {
        // Authentication guard
        if (!this.isAuthenticated(client)) {
            return;
        }
        const { conversationId } = data;
        const userId = client.userId;
        void client.leave(conversationId);
        // Remove user from conversation participants tracking
        const participants = this.conversationParticipants.get(conversationId);
        if (participants) {
            participants.delete(userId);
            if (participants.size === 0) {
                this.conversationParticipants.delete(conversationId);
            }
        }
        // Notify other participants that user left
        client.to(conversationId).emit('user_left_conversation', {
            conversationId,
            userId,
        });
        client.emit('conversation_left', { conversationId });
        this.logger.log(`User ${userId} left conversation ${conversationId}`);
    }
    async handleTypingIndicator(client, data) {
        // Authentication guard
        if (!this.isAuthenticated(client)) {
            return;
        }
        const { conversationId, isTyping = true } = data;
        const userId = client.userId;
        // Update typing indicator in database for persistence
        if (isTyping) {
            await this.prisma.typingIndicator.upsert({
                where: {
                    conversationId_userId: {
                        conversationId,
                        userId,
                    },
                },
                create: {
                    conversationId,
                    userId,
                    lastTypingAt: new Date(),
                },
                update: {
                    lastTypingAt: new Date(),
                },
            });
        }
        else {
            // Remove typing indicator when user stops typing
            await this.prisma.typingIndicator.deleteMany({
                where: {
                    conversationId,
                    userId,
                },
            });
        }
        // Broadcast typing indicator to other participants in the conversation
        client.to(conversationId).emit('typing_indicator', {
            conversationId,
            userId,
            isTyping,
        });
    }
    // Broadcast new message to conversation participants
    broadcastMessage(conversationId, message) {
        this.server.to(conversationId).emit('new_message', message);
        // Send push notification to offline users (implement as needed)
        this.sendPushNotifications(conversationId, message);
    }
    // Broadcast message update (edit/delete)
    broadcastMessageUpdate(conversationId, messageId, update) {
        this.server.to(conversationId).emit('message_updated', {
            messageId,
            ...update,
        });
    }
    // Broadcast read receipt
    broadcastReadReceipt(conversationId, messageId, userId) {
        this.server.to(conversationId).emit('message_read', {
            messageId,
            userId,
            readAt: new Date(),
        });
    }
    // Broadcast message reaction
    broadcastReaction(conversationId, messageId, reaction) {
        this.server.to(conversationId).emit('message_reaction', {
            messageId,
            reaction,
        });
    }
    // Private helper methods
    // Authentication guard for message handlers
    isAuthenticated(client) {
        if (!client.isAuthenticated || !client.userId) {
            this.logger.warn(`Unauthenticated client ${client.id} attempted to perform action`);
            client.emit('auth_error', {
                message: 'Authentication required for this action',
                code: 'AUTH_REQUIRED',
            });
            return false;
        }
        return true;
    }
    async joinUserConversations(client, userId) {
        try {
            // Get all active conversations for the user
            const conversations = await this.prisma.conversation.findMany({
                where: {
                    participants: {
                        some: {
                            userId,
                            isActive: true,
                        },
                    },
                    isActive: true,
                },
                select: {
                    id: true,
                },
            });
            // Join all conversation rooms
            for (const conversation of conversations) {
                void client.join(conversation.id);
                // Add to tracking
                if (!this.conversationParticipants.has(conversation.id)) {
                    this.conversationParticipants.set(conversation.id, new Set());
                }
                this.conversationParticipants.get(conversation.id).add(userId);
            }
            this.logger.log(`User ${userId} joined ${conversations.length} conversation rooms`);
        }
        catch (error) {
            this.logger.error('Error joining user conversations:', error);
        }
    }
    async broadcastUserStatus(userId, status) {
        // Get all conversations this user participates in
        const conversations = await this.prisma.conversation.findMany({
            where: {
                participants: {
                    some: {
                        userId,
                        isActive: true,
                    },
                },
            },
            select: {
                id: true,
            },
        });
        // Broadcast status to all conversation rooms
        for (const conversation of conversations) {
            this.server.to(conversation.id).emit('user_status_changed', {
                userId,
                status,
                timestamp: new Date(),
            });
        }
    }
    async sendPushNotifications(conversationId, message) {
        try {
            // Get all participants in the conversation except the sender
            const conversation = await this.prisma.conversation.findUnique({
                where: { id: conversationId },
                include: {
                    participants: {
                        include: {
                            user: {
                                include: {
                                    notificationSettings: true,
                                    deviceTokens: true,
                                },
                            },
                        },
                    },
                },
            });
            if (!conversation) {
                this.logger.warn(`Conversation ${conversationId} not found for push notifications`);
                return;
            }
            // Filter participants who should receive push notifications
            const eligibleParticipants = conversation.participants.filter((participant) => {
                // Don't send to message sender
                if (participant.userId === message.senderId) {
                    return false;
                }
                // Check if user has push notifications enabled for messages
                const settings = participant.user.notificationSettings;
                if (!settings?.pushNewMessages) {
                    return false;
                }
                // Check if user has active device tokens for push notifications
                return (participant.user.deviceTokens &&
                    participant.user.deviceTokens.length > 0);
            });
            if (eligibleParticipants.length === 0) {
                this.logger.log(`No eligible participants for push notifications in conversation ${conversationId}`);
                return;
            }
            // Prepare notification payload
            const notificationPayload = {
                title: 'New Message',
                body: message.content.length > 50
                    ? `${message.content.substring(0, 50)}...`
                    : message.content,
                icon: '/icon-192x192.png',
                badge: '/badge-72x72.png',
                data: {
                    conversationId: conversationId,
                    messageId: message.id,
                    senderId: message.senderId,
                    url: `/user/messages?conversation=${conversationId}`,
                },
            };
            // Send push notifications to all eligible participants
            const pushPromises = eligibleParticipants.flatMap((participant) => participant.user.deviceTokens.map(async (deviceToken) => {
                try {
                    // Simplified push notification - would implement proper service if available
                    this.logger.log(`Would send push notification to device: ${deviceToken.token}`);
                    this.logger.log(`Push notification sent to user ${participant.userId} for message ${message.id}`);
                }
                catch (error) {
                    const errorMessage = error instanceof Error ? error.message : 'Unknown error';
                    this.logger.error(`Failed to send push notification to user ${participant.userId}: ${errorMessage}`);
                    // If subscription is invalid, remove it
                    if (errorMessage.includes('invalid') ||
                        errorMessage.includes('expired')) {
                        await this.prisma.deviceToken.delete({
                            where: { id: deviceToken.id },
                        });
                        this.logger.log(`Removed invalid push subscription for user ${participant.userId}`);
                    }
                }
            }));
            await Promise.allSettled(pushPromises);
            this.logger.log(`Push notification processing completed for conversation ${conversationId}`);
        }
        catch (error) {
            this.logger.error(`Failed to send push notifications for conversation ${conversationId}:`, error);
        }
    }
    // Clean up old typing indicators (call this periodically)
    async cleanupTypingIndicators() {
        const fiveMinutesAgo = new Date(Date.now() - 5 * 60 * 1000);
        await this.prisma.typingIndicator.deleteMany({
            where: {
                lastTypingAt: {
                    lt: fiveMinutesAgo,
                },
            },
        });
    }
    // Personal room subscription methods for real-time notifications
    async subscribeUserToPersonalRoom(client, userId) {
        const userRoom = `user_${userId}`;
        await client.join(userRoom);
        this.logger.debug(`User ${userId} subscribed to personal room: ${userRoom}`);
    }
    async unsubscribeUserFromPersonalRoom(client, userId) {
        const userRoom = `user_${userId}`;
        await client.leave(userRoom);
        this.logger.debug(`User ${userId} unsubscribed from personal room: ${userRoom}`);
    }
    // Community and post room subscriptions for social features
    async handleJoinCommunity(client, data) {
        if (!this.isAuthenticated(client)) {
            return;
        }
        const { communityId } = data;
        const userId = client.userId;
        try {
            // Verify user is a member of this community
            const membership = await this.prisma.membership.findFirst({
                where: {
                    communityId,
                    userId,
                },
            });
            if (!membership) {
                client.emit('error', { message: 'Access denied to this community' });
                return;
            }
            const communityRoom = `community_${communityId}`;
            await client.join(communityRoom);
            client.emit('community_joined', { communityId });
            this.logger.log(`User ${userId} joined community room ${communityId}`);
        }
        catch (error) {
            this.logger.error('Error joining community:', error);
            client.emit('error', { message: 'Failed to join community' });
        }
    }
    async handleLeaveCommunity(client, data) {
        if (!this.isAuthenticated(client)) {
            return;
        }
        const { communityId } = data;
        const userId = client.userId;
        const communityRoom = `community_${communityId}`;
        await client.leave(communityRoom);
        client.emit('community_left', { communityId });
        this.logger.log(`User ${userId} left community room ${communityId}`);
    }
    async handleJoinPost(client, data) {
        if (!this.isAuthenticated(client)) {
            return;
        }
        const { postId } = data;
        const userId = client.userId;
        try {
            // Verify post exists and user has access
            const post = await this.prisma.post.findFirst({
                where: {
                    id: postId,
                    room: {
                        roomGroup: {
                            community: {
                                memberships: {
                                    some: {
                                        userId,
                                    },
                                },
                            },
                        },
                    },
                },
            });
            if (!post) {
                client.emit('error', { message: 'Access denied to this post' });
                return;
            }
            const postRoom = `post_${postId}`;
            await client.join(postRoom);
            client.emit('post_joined', { postId });
            this.logger.log(`User ${userId} joined post room ${postId}`);
        }
        catch (error) {
            this.logger.error('Error joining post:', error);
            client.emit('error', { message: 'Failed to join post' });
        }
    }
    async handleLeavePost(client, data) {
        if (!this.isAuthenticated(client)) {
            return;
        }
        const { postId } = data;
        const userId = client.userId;
        const postRoom = `post_${postId}`;
        await client.leave(postRoom);
        client.emit('post_left', { postId });
        this.logger.log(`User ${userId} left post room ${postId}`);
    }
    // Utility method to get server instance for event broadcasting
    getServer() {
        return this.server;
    }
};
exports.MessagingGateway = MessagingGateway;
__decorate([
    (0, websockets_1.WebSocketServer)(),
    __metadata("design:type", typeof (_c = typeof socket_io_1.Server !== "undefined" && socket_io_1.Server) === "function" ? _c : Object)
], MessagingGateway.prototype, "server", void 0);
__decorate([
    (0, websockets_1.SubscribeMessage)('join_conversation'),
    __param(0, (0, websockets_1.ConnectedSocket)()),
    __param(1, (0, websockets_1.MessageBody)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Object, typeof (_d = typeof mentara_commons_1.JoinConversationDto !== "undefined" && mentara_commons_1.JoinConversationDto) === "function" ? _d : Object]),
    __metadata("design:returntype", Promise)
], MessagingGateway.prototype, "handleJoinConversation", null);
__decorate([
    (0, websockets_1.SubscribeMessage)('leave_conversation'),
    __param(0, (0, websockets_1.ConnectedSocket)()),
    __param(1, (0, websockets_1.MessageBody)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Object, typeof (_e = typeof mentara_commons_1.LeaveConversationDto !== "undefined" && mentara_commons_1.LeaveConversationDto) === "function" ? _e : Object]),
    __metadata("design:returntype", void 0)
], MessagingGateway.prototype, "handleLeaveConversation", null);
__decorate([
    (0, websockets_1.SubscribeMessage)('typing_indicator'),
    __param(0, (0, websockets_1.ConnectedSocket)()),
    __param(1, (0, websockets_1.MessageBody)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Object, typeof (_f = typeof mentara_commons_1.TypingIndicatorDto !== "undefined" && mentara_commons_1.TypingIndicatorDto) === "function" ? _f : Object]),
    __metadata("design:returntype", Promise)
], MessagingGateway.prototype, "handleTypingIndicator", null);
__decorate([
    (0, websockets_1.SubscribeMessage)('join_community'),
    __param(0, (0, websockets_1.ConnectedSocket)()),
    __param(1, (0, websockets_1.MessageBody)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Object, Object]),
    __metadata("design:returntype", Promise)
], MessagingGateway.prototype, "handleJoinCommunity", null);
__decorate([
    (0, websockets_1.SubscribeMessage)('leave_community'),
    __param(0, (0, websockets_1.ConnectedSocket)()),
    __param(1, (0, websockets_1.MessageBody)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Object, Object]),
    __metadata("design:returntype", Promise)
], MessagingGateway.prototype, "handleLeaveCommunity", null);
__decorate([
    (0, websockets_1.SubscribeMessage)('join_post'),
    __param(0, (0, websockets_1.ConnectedSocket)()),
    __param(1, (0, websockets_1.MessageBody)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Object, Object]),
    __metadata("design:returntype", Promise)
], MessagingGateway.prototype, "handleJoinPost", null);
__decorate([
    (0, websockets_1.SubscribeMessage)('leave_post'),
    __param(0, (0, websockets_1.ConnectedSocket)()),
    __param(1, (0, websockets_1.MessageBody)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Object, Object]),
    __metadata("design:returntype", Promise)
], MessagingGateway.prototype, "handleLeavePost", null);
exports.MessagingGateway = MessagingGateway = MessagingGateway_1 = __decorate([
    (0, websockets_1.WebSocketGateway)({
        cors: {
            origin: process.env.FRONTEND_URL || 'http://localhost:3000',
            credentials: true,
        },
        namespace: '/messaging',
    }),
    __metadata("design:paramtypes", [typeof (_a = typeof prisma_client_provider_1.PrismaService !== "undefined" && prisma_client_provider_1.PrismaService) === "function" ? _a : Object, typeof (_b = typeof websocket_auth_service_1.WebSocketAuthService !== "undefined" && websocket_auth_service_1.WebSocketAuthService) === "function" ? _b : Object])
], MessagingGateway);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL21lc3NhZ2luZy9tZXNzYWdpbmcuZ2F0ZXdheS50cyIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLG1EQVE0QjtBQUM1Qix5Q0FBMkM7QUFDM0MsMkNBQXdDO0FBQ3hDLGdGQUFvRTtBQUNwRSw4RUFBeUU7QUFDekUscURBSXlCO0FBZWxCLElBQU0sZ0JBQWdCLHdCQUF0QixNQUFNLGdCQUFnQjtJQVdSO0lBQ0E7SUFSbkIsTUFBTSxDQUFVO0lBRUMsTUFBTSxHQUFHLElBQUksZUFBTSxDQUFDLGtCQUFnQixDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ3BELFdBQVcsR0FBRyxJQUFJLEdBQUcsRUFBdUIsQ0FBQyxDQUFDLDhCQUE4QjtJQUM1RSx3QkFBd0IsR0FBRyxJQUFJLEdBQUcsRUFBdUIsQ0FBQyxDQUFDLG9DQUFvQztJQUV2RyxZQUNtQixNQUFxQixFQUNyQixhQUFtQztRQURuQyxXQUFNLEdBQU4sTUFBTSxDQUFlO1FBQ3JCLGtCQUFhLEdBQWIsYUFBYSxDQUFzQjtJQUNuRCxDQUFDO0lBRUosS0FBSyxDQUFDLGdCQUFnQixDQUFDLE1BQTJCO1FBQ2hELElBQUksQ0FBQztZQUNILElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLHFDQUFxQyxNQUFNLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQztZQUVsRSxnRUFBZ0U7WUFDaEUsTUFBTSxVQUFVLEdBQUcsTUFBTSxJQUFJLENBQUMsYUFBYSxDQUFDLGtCQUFrQixDQUFDLE1BQU0sQ0FBQyxDQUFDO1lBRXZFLElBQUksQ0FBQyxVQUFVLEVBQUUsQ0FBQztnQkFDaEIsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsVUFBVSxNQUFNLENBQUMsRUFBRSx3QkFBd0IsQ0FBQyxDQUFDO2dCQUM5RCxNQUFNLENBQUMsSUFBSSxDQUFDLFlBQVksRUFBRTtvQkFDeEIsT0FBTyxFQUFFLHNEQUFzRDtvQkFD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QWNmO0FBR0s7SUFETCxJQUFBLDZCQUFnQixFQUFDLFdBQVcsQ0FBQztJQUUzQixXQUFBLElBQUEsNEJBQWUsR0FBRSxDQUFBO0lBQ2pCLFdBQUEsSUFBQSx3QkFBVyxHQUFFLENBQUE7Ozs7c0RBMENmO0FBR0s7SUFETCxJQUFBLDZCQUFnQixFQUFDLFlBQVksQ0FBQztJQUU1QixXQUFBLElBQUEsNEJBQWUsR0FBRSxDQUFBO0lBQ2pCLFdBQUEsSUFBQSx3QkFBVyxHQUFFLENBQUE7Ozs7dURBY2Y7MkJBbHFCVSxnQkFBZ0I7SUFQNUIsSUFBQSw2QkFBZ0IsRUFBQztRQUNoQixJQUFJLEVBQUU7WUFDSixNQUFNLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxZQUFZLElBQUksdUJBQXVCO1lBQzNELFdBQVcsRUFBRSxJQUFJO1NBQ2xCO1FBQ0QsU0FBUyxFQUFFLFlBQVk7S0FDeEIsQ0FBQzt5REFZMkIsc0NBQWEsb0JBQWIsc0NBQWEsb0RBQ04sNkNBQW9CLG9CQUFwQiw2Q0FBb0I7R0FaM0MsZ0JBQWdCLENBd3FCNUIiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL21lc3NhZ2luZy9tZXNzYWdpbmcuZ2F0ZXdheS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBXZWJTb2NrZXRHYXRld2F5LFxuICBXZWJTb2NrZXRTZXJ2ZXIsXG4gIFN1YnNjcmliZU1lc3NhZ2UsXG4gIE9uR2F0ZXdheUNvbm5lY3Rpb24sXG4gIE9uR2F0ZXdheURpc2Nvbm5lY3QsXG4gIENvbm5lY3RlZFNvY2tldCxcbiAgTWVzc2FnZUJvZHksXG59IGZyb20gJ0BuZXN0anMvd2Vic29ja2V0cyc7XG5pbXBvcnQgeyBTZXJ2ZXIsIFNvY2tldCB9IGZyb20gJ3NvY2tldC5pbyc7XG5pbXBvcnQgeyBMb2dnZXIgfSBmcm9tICdAbmVzdGpzL2NvbW1vbic7XG5pbXBvcnQgeyBQcmlzbWFTZXJ2aWNlIH0gZnJvbSAnLi4vcHJvdmlkZXJzL3ByaXNtYS1jbGllbnQucHJvdmlkZXInO1xuaW1wb3J0IHsgV2ViU29ja2V0QXV0aFNlcnZpY2UgfSBmcm9tICcuL3NlcnZpY2VzL3dlYnNvY2tldC1hdXRoLnNlcnZpY2UnO1xuaW1wb3J0IHtcbiAgSm9pbkNvbnZlcnNhdGlvbkR0byxcbiAgTGVhdmVDb252ZXJzYXRpb25EdG8sXG4gIFR5cGluZ0luZGljYXRvckR0byxcbn0gZnJvbSAnbWVudGFyYS1jb21tb25zJztcblxuaW50ZXJmYWNlIEF1dGhlbnRpY2F0ZWRTb2NrZXQgZXh0ZW5kcyBTb2NrZXQge1xuICB1c2VySWQ/OiBzdHJpbmc7XG4gIHVzZXJSb2xlPzogc3RyaW5nO1xuICBpc0F1dGhlbnRpY2F0ZWQ/OiBib29sZWFuO1xufVxuXG5AV2ViU29ja2V0R2F0ZXdheSh7XG4gIGNvcnM6IHtcbiAgICBvcmlnaW46IHByb2Nlc3MuZW52LkZST05URU5EX1VSTCB8fCAnaHR0cDovL2xvY2FsaG9zdDozMDAwJyxcbiAgICBjcmVkZW50aWFsczogdHJ1ZSxcbiAgfSxcbiAgbmFtZXNwYWNlOiAnL21lc3NhZ2luZycsXG59KVxuZXhwb3J0IGNsYXNzIE1lc3NhZ2luZ0dhdGV3YXlcbiAgaW1wbGVtZW50cyBPbkdhdGV3YXlDb25uZWN0aW9uLCBPbkdhdGV3YXlEaXNjb25uZWN0XG57XG4gIEBXZWJTb2NrZXRTZXJ2ZXIoKVxuICBzZXJ2ZXIhOiBTZXJ2ZXI7XG5cbiAgcHJpdmF0ZSByZWFkb25seSBsb2dnZXIgPSBuZXcgTG9nZ2VyKE1lc3NhZ2luZ0dhdGV3YXkubmFtZSk7XG4gIHByaXZhdGUgdXNlclNvY2tldHMgPSBuZXcgTWFwPHN0cmluZywgU2V0PHN0cmluZz4+KCk7IC8vIHVzZXJJZCAtPiBTZXQgb2Ygc29ja2V0IElEc1xuICBwcml2YXRlIGNvbnZlcnNhdGlvblBhcnRpY2lwYW50cyA9IG5ldyBNYXA8c3RyaW5nLCBTZXQ8c3RyaW5nPj4oKTsgLy8gY29udmVyc2F0aW9uSWQgLT4gU2V0IG9mIHVzZXIgSURzXG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSByZWFkb25seSBwcmlzbWE6IFByaXNtYVNlcnZpY2UsXG4gICAgcHJpdmF0ZSByZWFkb25seSB3ZWJTb2NrZXRBdXRoOiBXZWJTb2NrZXRBdXRoU2VydmljZSxcbiAgKSB7fVxuXG4gIGFzeW5jIGhhbmRsZUNvbm5lY3Rpb24oY2xpZW50OiBBdXRoZW50aWNhdGVkU29ja2V0KSB7XG4gICAgdHJ5IHtcbiAgICAgIHRoaXMubG9nZ2VyLmxvZyhgTmV3IFdlYlNvY2tldCBjb25uZWN0aW9uIGF0dGVtcHQ6ICR7Y2xpZW50LmlkfWApO1xuXG4gICAgICAvLyBBdXRoZW50aWNhdGUgdGhlIHNvY2tldCBjb25uZWN0aW9uIHVzaW5nIHRoZSBuZXcgYXV0aCBzZXJ2aWNlXG4gICAgICBjb25zdCBhdXRoUmVzdWx0ID0gYXdhaXQgdGhpcy53ZWJTb2NrZXRBdXRoLmF1dGhlbnRpY2F0ZVNvY2tldChjbGllbnQpO1xuXG4gICAgICBpZiAoIWF1dGhSZXN1bHQpIHtcbiAgICAgICAgdGhpcy5sb2dnZXIud2FybihgQ2xpZW50ICR7Y2xpZW50LmlkfSBhdXRoZW50aWNhdGlvbiBmYWlsZWRgKTtcbiAgICAgICAgY2xpZW50LmVtaXQoJ2F1dGhfZXJyb3InLCB7XG4gICAgICAgICAgbWVzc2FnZTogJ0F1dGhlbnRpY2F0aW9uIGZhaWxlZC4gUGxlYXNlIHByb3ZpZGUgYSB2YWxpZCB0b2tlbi4nLFxuICAgICAgICAgIGNvZGU6ICdBVVRIX0ZBSUxFRCcsXG4gICAgICAgIH0pO1xuICAgICAgICBjbGllbnQuZGlzY29ubmVjdCh0cnVlKTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuXG4gICAgICAvLyBBdHRhY2ggYXV0aGVudGljYXRlZCB1c2VyIGluZm8gdG8gc29ja2V0XG4gICAgICBjbGllbnQudXNlcklkID0gYXV0aFJlc3VsdC51c2VySWQ7XG4gICAgICBjbGllbnQudXNlclJvbGUgPSBhdXRoUmVzdWx0LnJvbGU7XG4gICAgICBjbGllbnQuaXNBdXRoZW50aWNhdGVkID0gdHJ1ZTtcblxuICAgICAgLy8gVmVyaWZ5IHVzZXIgZXhpc3RzIGluIGRhdGFiYXNlIGFuZCBpcyBhY3RpdmVcbiAgICAgIGNvbnN0IHVzZXIgPSBhd2FpdCB0aGlzLnByaXNtYS51c2VyLmZpbmRVbmlxdWUoe1xuICAgICAgICB3aGVyZToge1xuICAgICAgICAgIGlkOiBhdXRoUmVzdWx0LnVzZXJJZCxcbiAgICAgICAgICBpc0FjdGl2ZTogdHJ1ZSwgLy8gT25seSBhbGxvdyBhY3RpdmUgdXNlcnNcbiAgICAgICAgfSxcbiAgICAgICAgc2VsZWN0OiB7IGlkOiB0cnVlLCByb2xlOiB0cnVlLCBpc0FjdGl2ZTogdHJ1ZSB9LFxuICAgICAgfSk7XG5cbiAgICAgIGlmICghdXNlcikge1xuICAgICAgICB0aGlzLmxvZ2dlci53YXJuKGBVc2VyICR7YXV0aFJlc3VsdC51c2VySWR9IG5vdCBmb3VuZCBvciBpbmFjdGl2ZWApO1xuICAgICAgICBjbGllbnQuZW1pdCgnYXV0aF9lcnJvcicsIHtcbiAgICAgICAgICBtZXNzYWdlOiAnVXNlciBhY2NvdW50IG5vdCBmb3VuZCBvciBpbmFjdGl2ZScsXG4gICAgICAgICAgY29kZTogJ1VTRVJfTk9UX0ZPVU5EJyxcbiAgICAgICAgfSk7XG4gICAgICAgIGNsaWVudC5kaXNjb25uZWN0KHRydWUpO1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG5cbiAgICAgIC8vIEFkZCBzb2NrZXQgdG8gdXNlcidzIHNvY2tldCBzZXRcbiAgICAgIGlmICghdGhpcy51c2VyU29ja2V0cy5oYXMoYXV0aFJlc3VsdC51c2VySWQpKSB7XG4gICAgICAgIHRoaXMudXNlclNvY2tldHMuc2V0KGF1dGhSZXN1bHQudXNlcklkLCBuZXcgU2V0KCkpO1xuICAgICAgfVxuICAgICAgdGhpcy51c2VyU29ja2V0cy5nZXQoYXV0aFJlc3VsdC51c2VySWQpIS5hZGQoY2xpZW50LmlkKTtcblxuICAgICAgLy8gSm9pbiB1c2VyIHRvIHRoZWlyIGNvbnZlcnNhdGlvbiByb29tc1xuICAgICAgYXdhaXQgdGhpcy5qb2luVXNlckNvbnZlcnNhdGlvbnMoY2xpZW50LCBhdXRoUmVzdWx0LnVzZXJJZCk7XG5cbiAgICAgIC8vIFN1YnNjcmliZSB1c2VyIHRvIHRoZWlyIHBlcnNvbmFsIG5vdGlmaWNhdGlvbiByb29tXG4gICAgICBhd2FpdCB0aGlzLnN1YnNjcmliZVVzZXJUb1BlcnNvbmFsUm9vbShjbGllbnQsIGF1dGhSZXN1bHQudXNlcklkKTtcblxuICAgICAgLy8gTm90aWZ5IHN1Y2Nlc3NmdWwgY29ubmVjdGlvblxuICAgICAgY2xpZW50LmVtaXQoJ2F1dGhlbnRpY2F0ZWQnLCB7XG4gICAgICAgIHVzZXJJZDogYXV0aFJlc3VsdC51c2VySWQsXG4gICAgICAgIHJvbGU6IHVzZXIucm9sZSxcbiAgICAgICAgbWVzc2FnZTogJ1N1Y2Nlc3NmdWxseSBhdXRoZW50aWNhdGVkIGFuZCBjb25uZWN0ZWQnLFxuICAgICAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSxcbiAgICAgIH0pO1xuXG4gICAgICAvLyBFbWl0IHVzZXIgb25saW5lIHN0YXR1cyB0byB0aGVpciBjb250YWN0c1xuICAgICAgYXdhaXQgdGhpcy5icm9hZGNhc3RVc2VyU3RhdHVzKGF1dGhSZXN1bHQudXNlcklkLCAnb25saW5lJyk7XG5cbiAgICAgIHRoaXMubG9nZ2VyLmxvZyhcbiAgICAgICAgYFVzZXIgJHthdXRoUmVzdWx0LnVzZXJJZH0gc3VjY2Vzc2Z1bGx5IGF1dGhlbnRpY2F0ZWQgYW5kIGNvbm5lY3RlZCB3aXRoIHNvY2tldCAke2NsaWVudC5pZH1gLFxuICAgICAgKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoYENvbm5lY3Rpb24gZXJyb3IgZm9yIGNsaWVudCAke2NsaWVudC5pZH06YCwgZXJyb3IpO1xuICAgICAgY2xpZW50LmVtaXQoJ2Nvbm5lY3Rpb25fZXJyb3InLCB7XG4gICAgICAgIG1lc3NhZ2U6ICdJbnRlcm5hbCBzZXJ2ZXIgZXJyb3IgZHVyaW5nIGNvbm5lY3Rpb24nLFxuICAgICAgICBjb2RlOiAnSU5URVJOQUxfRVJST1InLFxuICAgICAgfSk7XG4gICAgICBjbGllbnQuZGlzY29ubmVjdCh0cnVlKTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBoYW5kbGVEaXNjb25uZWN0KGNsaWVudDogQXV0aGVudGljYXRlZFNvY2tldCkge1xuICAgIHRyeSB7XG4gICAgICBpZiAoY2xpZW50LnVzZXJJZCkge1xuICAgICAgICBjb25zdCB1c2VyU29ja2V0cyA9IHRoaXMudXNlclNvY2tldHMuZ2V0KGNsaWVudC51c2VySWQpO1xuICAgICAgICBpZiAodXNlclNvY2tldHMpIHtcbiAgICAgICAgICB1c2VyU29ja2V0cy5kZWxldGUoY2xpZW50LmlkKTtcblxuICAgICAgICAgIC8vIElmIG5vIG1vcmUgc29ja2V0cyBmb3IgdGhpcyB1c2VyLCByZW1vdmUgZnJvbSB0cmFja2luZ1xuICAgICAgICAgIGlmICh1c2VyU29ja2V0cy5zaXplID09PSAwKSB7XG4gICAgICAgICAgICB0aGlzLnVzZXJTb2NrZXRzLmRlbGV0ZShjbGllbnQudXNlcklkKTtcblxuICAgICAgICAgICAgLy8gQ2xlYW4gdXAgY29udmVyc2F0aW9uIHBhcnRpY2lwYW50cyB0cmFja2luZ1xuICAgICAgICAgICAgZm9yIChjb25zdCBbXG4gICAgICAgICAgICAgIGNvbnZlcnNhdGlvbklkLFxuICAgICAgICAgICAgICBwYXJ0aWNpcGFudHMsXG4gICAgICAgICAgICBdIG9mIHRoaXMuY29udmVyc2F0aW9uUGFydGljaXBhbnRzLmVudHJpZXMoKSkge1xuICAgICAgICAgICAgICBwYXJ0aWNpcGFudHMuZGVsZXRlKGNsaWVudC51c2VySWQpO1xuICAgICAgICAgICAgICAvLyBSZW1vdmUgZW1wdHkgY29udmVyc2F0aW9uIHNldHNcbiAgICAgICAgICAgICAgaWYgKHBhcnRpY2lwYW50cy5zaXplID09PSAwKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5jb252ZXJzYXRpb25QYXJ0aWNpcGFudHMuZGVsZXRlKGNvbnZlcnNhdGlvbklkKTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAvLyBCcm9hZGNhc3QgdXNlciBvZmZsaW5lIHN0YXR1cyB0byB0aGVpciBjb250YWN0c1xuICAgICAgICAgICAgYXdhaXQgdGhpcy5icm9hZGNhc3RVc2VyU3RhdHVzKGNsaWVudC51c2VySWQsICdvZmZsaW5lJyk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5sb2dnZXIubG9nKFxuICAgICAgICAgIGBVc2VyICR7Y2xpZW50LnVzZXJJZH0gZGlzY29ubmVjdGVkIHNvY2tldCAke2NsaWVudC5pZH1gLFxuICAgICAgICApO1xuICAgICAgfVxuXG4gICAgICAvLyBDbGVhbiB1cCBhdXRoZW50aWNhdGlvbiB0cmFja2luZ1xuICAgICAgdGhpcy53ZWJTb2NrZXRBdXRoLmNsZWFudXBDb25uZWN0aW9uKGNsaWVudC5pZCk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRoaXMubG9nZ2VyLmVycm9yKFxuICAgICAgICBgRXJyb3IgZHVyaW5nIGRpc2Nvbm5lY3QgY2xlYW51cCBmb3Igc29ja2V0ICR7Y2xpZW50LmlkfTpgLFxuICAgICAgICBlcnJvcixcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgQFN1YnNjcmliZU1lc3NhZ2UoJ2pvaW5fY29udmVyc2F0aW9uJylcbiAgYXN5bmMgaGFuZGxlSm9pbkNvbnZlcnNhdGlvbihcbiAgICBAQ29ubmVjdGVkU29ja2V0KCkgY2xpZW50OiBBdXRoZW50aWNhdGVkU29ja2V0LFxuICAgIEBNZXNzYWdlQm9keSgpIGRhdGE6IEpvaW5Db252ZXJzYXRpb25EdG8sXG4gICkge1xuICAgIC8vIEF1dGhlbnRpY2F0aW9uIGd1YXJkXG4gICAgaWYgKCF0aGlzLmlzQXV0aGVudGljYXRlZChjbGllbnQpKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHsgY29udmVyc2F0aW9uSWQgfSA9IGRhdGE7XG4gICAgICBjb25zdCB1c2VySWQgPSBjbGllbnQudXNlcklkITtcblxuICAgICAgLy8gVmVyaWZ5IHVzZXIgaXMgYSBwYXJ0aWNpcGFudCBpbiB0aGlzIGNvbnZlcnNhdGlvblxuICAgICAgY29uc3QgcGFydGljaXBhdGlvbiA9IGF3YWl0IHRoaXMucHJpc21hLmNvbnZlcnNhdGlvblBhcnRpY2lwYW50LmZpbmRGaXJzdChcbiAgICAgICAge1xuICAgICAgICAgIHdoZXJlOiB7XG4gICAgICAgICAgICBjb252ZXJzYXRpb25JZCxcbiAgICAgICAgICAgIHVzZXJJZCxcbiAgICAgICAgICAgIGlzQWN0aXZlOiB0cnVlLFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICApO1xuXG4gICAgICBpZiAoIXBhcnRpY2lwYXRpb24pIHtcbiAgICAgICAgY2xpZW50LmVtaXQoJ2Vycm9yJywgeyBtZXNzYWdlOiAnQWNjZXNzIGRlbmllZCB0byB0aGlzIGNvbnZlcnNhdGlvbicgfSk7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cblxuICAgICAgLy8gSm9pbiBzb2NrZXQgdG8gY29udmVyc2F0aW9uIHJvb21cbiAgICAgIHZvaWQgY2xpZW50LmpvaW4oY29udmVyc2F0aW9uSWQpO1xuXG4gICAgICAvLyBBZGQgdXNlciB0byBjb252ZXJzYXRpb24gcGFydGljaXBhbnRzIHRyYWNraW5nXG4gICAgICBpZiAoIXRoaXMuY29udmVyc2F0aW9uUGFydGljaXBhbnRzLmhhcyhjb252ZXJzYXRpb25JZCkpIHtcbiAgICAgICAgdGhpcy5jb252ZXJzYXRpb25QYXJ0aWNpcGFudHMuc2V0KGNvbnZlcnNhdGlvbklkLCBuZXcgU2V0KCkpO1xuICAgICAgfVxuICAgICAgdGhpcy5jb252ZXJzYXRpb25QYXJ0aWNpcGFudHMuZ2V0KGNvbnZlcnNhdGlvbklkKSEuYWRkKHVzZXJJZCk7XG5cbiAgICAgIC8vIE5vdGlmeSBvdGhlciBwYXJ0aWNpcGFudHMgdGhhdCB1c2VyIGpvaW5lZFxuICAgICAgY2xpZW50LnRvKGNvbnZlcnNhdGlvbklkKS5lbWl0KCd1c2VyX2pvaW5lZF9jb252ZXJzYXRpb24nLCB7XG4gICAgICAgIGNvbnZlcnNhdGlvbklkLFxuICAgICAgICB1c2VySWQsXG4gICAgICB9KTtcblxuICAgICAgY2xpZW50LmVtaXQoJ2NvbnZlcnNhdGlvbl9qb2luZWQnLCB7IGNvbnZlcnNhdGlvbklkIH0pO1xuICAgICAgdGhpcy5sb2dnZXIubG9nKGBVc2VyICR7dXNlcklkfSBqb2luZWQgY29udmVyc2F0aW9uICR7Y29udmVyc2F0aW9uSWR9YCk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRoaXMubG9nZ2VyLmVycm9yKCdFcnJvciBqb2luaW5nIGNvbnZlcnNhdGlvbjonLCBlcnJvcik7XG4gICAgICBjbGllbnQuZW1pdCgnZXJyb3InLCB7IG1lc3NhZ2U6ICdGYWlsZWQgdG8gam9pbiBjb252ZXJzYXRpb24nIH0pO1xuICAgIH1cbiAgfVxuXG4gIEBTdWJzY3JpYmVNZXNzYWdlKCdsZWF2ZV9jb252ZXJzYXRpb24nKVxuICBoYW5kbGVMZWF2ZUNvbnZlcnNhdGlvbihcbiAgICBAQ29ubmVjdGVkU29ja2V0KCkgY2xpZW50OiBBdXRoZW50aWNhdGVkU29ja2V0LFxuICAgIEBNZXNzYWdlQm9keSgpIGRhdGE6IExlYXZlQ29udmVyc2F0aW9uRHRvLFxuICApIHtcbiAgICAvLyBBdXRoZW50aWNhdGlvbiBndWFyZFxuICAgIGlmICghdGhpcy5pc0F1dGhlbnRpY2F0ZWQoY2xpZW50KSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGNvbnN0IHsgY29udmVyc2F0aW9uSWQgfSA9IGRhdGE7XG4gICAgY29uc3QgdXNlcklkID0gY2xpZW50LnVzZXJJZCE7XG5cbiAgICB2b2lkIGNsaWVudC5sZWF2ZShjb252ZXJzYXRpb25JZCk7XG5cbiAgICAvLyBSZW1vdmUgdXNlciBmcm9tIGNvbnZlcnNhdGlvbiBwYXJ0aWNpcGFudHMgdHJhY2tpbmdcbiAgICBjb25zdCBwYXJ0aWNpcGFudHMgPSB0aGlzLmNvbnZlcnNhdGlvblBhcnRpY2lwYW50cy5nZXQoY29udmVyc2F0aW9uSWQpO1xuICAgIGlmIChwYXJ0aWNpcGFudHMpIHtcbiAgICAgIHBhcnRpY2lwYW50cy5kZWxldGUodXNlcklkKTtcbiAgICAgIGlmIChwYXJ0aWNpcGFudHMuc2l6ZSA9PT0gMCkge1xuICAgICAgICB0aGlzLmNvbnZlcnNhdGlvblBhcnRpY2lwYW50cy5kZWxldGUoY29udmVyc2F0aW9uSWQpO1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vIE5vdGlmeSBvdGhlciBwYXJ0aWNpcGFudHMgdGhhdCB1c2VyIGxlZnRcbiAgICBjbGllbnQudG8oY29udmVyc2F0aW9uSWQpLmVtaXQoJ3VzZXJfbGVmdF9jb252ZXJzYXRpb24nLCB7XG4gICAgICBjb252ZXJzYXRpb25JZCxcbiAgICAgIHVzZXJJZCxcbiAgICB9KTtcblxuICAgIGNsaWVudC5lbWl0KCdjb252ZXJzYXRpb25fbGVmdCcsIHsgY29udmVyc2F0aW9uSWQgfSk7XG4gICAgdGhpcy5sb2dnZXIubG9nKGBVc2VyICR7dXNlcklkfSBsZWZ0IGNvbnZlcnNhdGlvbiAke2NvbnZlcnNhdGlvbklkfWApO1xuICB9XG5cbiAgQFN1YnNjcmliZU1lc3NhZ2UoJ3R5cGluZ19pbmRpY2F0b3InKVxuICBhc3luYyBoYW5kbGVUeXBpbmdJbmRpY2F0b3IoXG4gICAgQENvbm5lY3RlZFNvY2tldCgpIGNsaWVudDogQXV0aGVudGljYXRlZFNvY2tldCxcbiAgICBATWVzc2FnZUJvZHkoKSBkYXRhOiBUeXBpbmdJbmRpY2F0b3JEdG8sXG4gICkge1xuICAgIC8vIEF1dGhlbnRpY2F0aW9uIGd1YXJkXG4gICAgaWYgKCF0aGlzLmlzQXV0aGVudGljYXRlZChjbGllbnQpKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgeyBjb252ZXJzYXRpb25JZCwgaXNUeXBpbmcgPSB0cnVlIH0gPSBkYXRhO1xuICAgIGNvbnN0IHVzZXJJZCA9IGNsaWVudC51c2VySWQhO1xuXG4gICAgLy8gVXBkYXRlIHR5cGluZyBpbmRpY2F0b3IgaW4gZGF0YWJhc2UgZm9yIHBlcnNpc3RlbmNlXG4gICAgaWYgKGlzVHlwaW5nKSB7XG4gICAgICBhd2FpdCB0aGlzLnByaXNtYS50eXBpbmdJbmRpY2F0b3IudXBzZXJ0KHtcbiAgICAgICAgd2hlcmU6IHtcbiAgICAgICAgICBjb252ZXJzYXRpb25JZF91c2VySWQ6IHtcbiAgICAgICAgICAgIGNvbnZlcnNhdGlvbklkLFxuICAgICAgICAgICAgdXNlcklkLFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICAgIGNyZWF0ZToge1xuICAgICAgICAgIGNvbnZlcnNhdGlvbklkLFxuICAgICAgICAgIHVzZXJJZCxcbiAgICAgICAgICBsYXN0VHlwaW5nQXQ6IG5ldyBEYXRlKCksXG4gICAgICAgIH0sXG4gICAgICAgIHVwZGF0ZToge1xuICAgICAgICAgIGxhc3RUeXBpbmdBdDogbmV3IERhdGUoKSxcbiAgICAgICAgfSxcbiAgICAgIH0pO1xuICAgIH0gZWxzZSB7XG4gICAgICAvLyBSZW1vdmUgdHlwaW5nIGluZGljYXRvciB3aGVuIHVzZXIgc3RvcHMgdHlwaW5nXG4gICAgICBhd2FpdCB0aGlzLnByaXNtYS50eXBpbmdJbmRpY2F0b3IuZGVsZXRlTWFueSh7XG4gICAgICAgIHdoZXJlOiB7XG4gICAgICAgICAgY29udmVyc2F0aW9uSWQsXG4gICAgICAgICAgdXNlcklkLFxuICAgICAgICB9LFxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgLy8gQnJvYWRjYXN0IHR5cGluZyBpbmRpY2F0b3IgdG8gb3RoZXIgcGFydGljaXBhbnRzIGluIHRoZSBjb252ZXJzYXRpb25cbiAgICBjbGllbnQudG8oY29udmVyc2F0aW9uSWQpLmVtaXQoJ3R5cGluZ19pbmRpY2F0b3InLCB7XG4gICAgICBjb252ZXJzYXRpb25JZCxcbiAgICAgIHVzZXJJZCxcbiAgICAgIGlzVHlwaW5nLFxuICAgIH0pO1xuICB9XG5cbiAgLy8gQnJvYWRjYXN0IG5ldyBtZXNzYWdlIHRvIGNvbnZlcnNhdGlvbiBwYXJ0aWNpcGFudHNcbiAgYnJvYWRjYXN0TWVzc2FnZShjb252ZXJzYXRpb25JZDogc3RyaW5nLCBtZXNzYWdlOiBhbnkpIHtcbiAgICB0aGlzLnNlcnZlci50byhjb252ZXJzYXRpb25JZCkuZW1pdCgnbmV3X21lc3NhZ2UnLCBtZXNzYWdlKTtcblxuICAgIC8vIFNlbmQgcHVzaCBub3RpZmljYXRpb24gdG8gb2ZmbGluZSB1c2VycyAoaW1wbGVtZW50IGFzIG5lZWRlZClcbiAgICB0aGlzLnNlbmRQdXNoTm90aWZpY2F0aW9ucyhjb252ZXJzYXRpb25JZCwgbWVzc2FnZSk7XG4gIH1cblxuICAvLyBCcm9hZGNhc3QgbWVzc2FnZSB1cGRhdGUgKGVkaXQvZGVsZXRlKVxuICBicm9hZGNhc3RNZXNzYWdlVXBkYXRlKFxuICAgIGNvbnZlcnNhdGlvbklkOiBzdHJpbmcsXG4gICAgbWVzc2FnZUlkOiBzdHJpbmcsXG4gICAgdXBkYXRlOiBhbnksXG4gICkge1xuICAgIHRoaXMuc2VydmVyLnRvKGNvbnZlcnNhdGlvbklkKS5lbWl0KCdtZXNzYWdlX3VwZGF0ZWQnLCB7XG4gICAgICBtZXNzYWdlSWQsXG4gICAgICAuLi51cGRhdGUsXG4gICAgfSk7XG4gIH1cblxuICAvLyBCcm9hZGNhc3QgcmVhZCByZWNlaXB0XG4gIGJyb2FkY2FzdFJlYWRSZWNlaXB0KFxuICAgIGNvbnZlcnNhdGlvbklkOiBzdHJpbmcsXG4gICAgbWVzc2FnZUlkOiBzdHJpbmcsXG4gICAgdXNlcklkOiBzdHJpbmcsXG4gICkge1xuICAgIHRoaXMuc2VydmVyLnRvKGNvbnZlcnNhdGlvbklkKS5lbWl0KCdtZXNzYWdlX3JlYWQnLCB7XG4gICAgICBtZXNzYWdlSWQsXG4gICAgICB1c2VySWQsXG4gICAgICByZWFkQXQ6IG5ldyBEYXRlKCksXG4gICAgfSk7XG4gIH1cblxuICAvLyBCcm9hZGNhc3QgbWVzc2FnZSByZWFjdGlvblxuICBicm9hZGNhc3RSZWFjdGlvbihjb252ZXJzYXRpb25JZDogc3RyaW5nLCBtZXNzYWdlSWQ6IHN0cmluZywgcmVhY3Rpb246IGFueSkge1xuICAgIHRoaXMuc2VydmVyLnRvKGNvbnZlcnNhdGlvbklkKS5lbWl0KCdtZXNzYWdlX3JlYWN0aW9uJywge1xuICAgICAgbWVzc2FnZUlkLFxuICAgICAgcmVhY3Rpb24sXG4gICAgfSk7XG4gIH1cblxuICAvLyBQcml2YXRlIGhlbHBlciBtZXRob2RzXG4gIC8vIEF1dGhlbnRpY2F0aW9uIGd1YXJkIGZvciBtZXNzYWdlIGhhbmRsZXJzXG4gIHByaXZhdGUgaXNBdXRoZW50aWNhdGVkKGNsaWVudDogQXV0aGVudGljYXRlZFNvY2tldCk6IGJvb2xlYW4ge1xuICAgIGlmICghY2xpZW50LmlzQXV0aGVudGljYXRlZCB8fCAhY2xpZW50LnVzZXJJZCkge1xuICAgICAgdGhpcy5sb2dnZXIud2FybihcbiAgICAgICAgYFVuYXV0aGVudGljYXRlZCBjbGllbnQgJHtjbGllbnQuaWR9IGF0dGVtcHRlZCB0byBwZXJmb3JtIGFjdGlvbmAsXG4gICAgICApO1xuICAgICAgY2xpZW50LmVtaXQoJ2F1dGhfZXJyb3InLCB7XG4gICAgICAgIG1lc3NhZ2U6ICdBdXRoZW50aWNhdGlvbiByZXF1aXJlZCBmb3IgdGhpcyBhY3Rpb24nLFxuICAgICAgICBjb2RlOiAnQVVUSF9SRVFVSVJFRCcsXG4gICAgICB9KTtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gICAgcmV0dXJuIHRydWU7XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGpvaW5Vc2VyQ29udmVyc2F0aW9ucyhcbiAgICBjbGllbnQ6IEF1dGhlbnRpY2F0ZWRTb2NrZXQsXG4gICAgdXNlcklkOiBzdHJpbmcsXG4gICkge1xuICAgIHRyeSB7XG4gICAgICAvLyBHZXQgYWxsIGFjdGl2ZSBjb252ZXJzYXRpb25zIGZvciB0aGUgdXNlclxuICAgICAgY29uc3QgY29udmVyc2F0aW9ucyA9IGF3YWl0IHRoaXMucHJpc21hLmNvbnZlcnNhdGlvbi5maW5kTWFueSh7XG4gICAgICAgIHdoZXJlOiB7XG4gICAgICAgICAgcGFydGljaXBhbnRzOiB7XG4gICAgICAgICAgICBzb21lOiB7XG4gICAgICAgICAgICAgIHVzZXJJZCxcbiAgICAgICAgICAgICAgaXNBY3RpdmU6IHRydWUsXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0sXG4gICAgICAgICAgaXNBY3RpdmU6IHRydWUsXG4gICAgICAgIH0sXG4gICAgICAgIHNlbGVjdDoge1xuICAgICAgICAgIGlkOiB0cnVlLFxuICAgICAgICB9LFxuICAgICAgfSk7XG5cbiAgICAgIC8vIEpvaW4gYWxsIGNvbnZlcnNhdGlvbiByb29tc1xuICAgICAgZm9yIChjb25zdCBjb252ZXJzYXRpb24gb2YgY29udmVyc2F0aW9ucykge1xuICAgICAgICB2b2lkIGNsaWVudC5qb2luKGNvbnZlcnNhdGlvbi5pZCk7XG5cbiAgICAgICAgLy8gQWRkIHRvIHRyYWNraW5nXG4gICAgICAgIGlmICghdGhpcy5jb252ZXJzYXRpb25QYXJ0aWNpcGFudHMuaGFzKGNvbnZlcnNhdGlvbi5pZCkpIHtcbiAgICAgICAgICB0aGlzLmNvbnZlcnNhdGlvblBhcnRpY2lwYW50cy5zZXQoY29udmVyc2F0aW9uLmlkLCBuZXcgU2V0KCkpO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuY29udmVyc2F0aW9uUGFydGljaXBhbnRzLmdldChjb252ZXJzYXRpb24uaWQpIS5hZGQodXNlcklkKTtcbiAgICAgIH1cblxuICAgICAgdGhpcy5sb2dnZXIubG9nKFxuICAgICAgICBgVXNlciAke3VzZXJJZH0gam9pbmVkICR7Y29udmVyc2F0aW9ucy5sZW5ndGh9IGNvbnZlcnNhdGlvbiByb29tc2AsXG4gICAgICApO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aGlzLmxvZ2dlci5lcnJvcignRXJyb3Igam9pbmluZyB1c2VyIGNvbnZlcnNhdGlvbnM6JywgZXJyb3IpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgYnJvYWRjYXN0VXNlclN0YXR1cyhcbiAgICB1c2VySWQ6IHN0cmluZyxcbiAgICBzdGF0dXM6ICdvbmxpbmUnIHwgJ29mZmxpbmUnLFxuICApIHtcbiAgICAvLyBHZXQgYWxsIGNvbnZlcnNhdGlvbnMgdGhpcyB1c2VyIHBhcnRpY2lwYXRlcyBpblxuICAgIGNvbnN0IGNvbnZlcnNhdGlvbnMgPSBhd2FpdCB0aGlzLnByaXNtYS5jb252ZXJzYXRpb24uZmluZE1hbnkoe1xuICAgICAgd2hlcmU6IHtcbiAgICAgICAgcGFydGljaXBhbnRzOiB7XG4gICAgICAgICAgc29tZToge1xuICAgICAgICAgICAgdXNlcklkLFxuICAgICAgICAgICAgaXNBY3RpdmU6IHRydWUsXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgIH0sXG4gICAgICBzZWxlY3Q6IHtcbiAgICAgICAgaWQ6IHRydWUsXG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgLy8gQnJvYWRjYXN0IHN0YXR1cyB0byBhbGwgY29udmVyc2F0aW9uIHJvb21zXG4gICAgZm9yIChjb25zdCBjb252ZXJzYXRpb24gb2YgY29udmVyc2F0aW9ucykge1xuICAgICAgdGhpcy5zZXJ2ZXIudG8oY29udmVyc2F0aW9uLmlkKS5lbWl0KCd1c2VyX3N0YXR1c19jaGFuZ2VkJywge1xuICAgICAgICB1c2VySWQsXG4gICAgICAgIHN0YXR1cyxcbiAgICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLFxuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBzZW5kUHVzaE5vdGlmaWNhdGlvbnMoY29udmVyc2F0aW9uSWQ6IHN0cmluZywgbWVzc2FnZTogYW55KSB7XG4gICAgdHJ5IHtcbiAgICAgIC8vIEdldCBhbGwgcGFydGljaXBhbnRzIGluIHRoZSBjb252ZXJzYXRpb24gZXhjZXB0IHRoZSBzZW5kZXJcbiAgICAgIGNvbnN0IGNvbnZlcnNhdGlvbiA9IGF3YWl0IHRoaXMucHJpc21hLmNvbnZlcnNhdGlvbi5maW5kVW5pcXVlKHtcbiAgICAgICAgd2hlcmU6IHsgaWQ6IGNvbnZlcnNhdGlvbklkIH0sXG4gICAgICAgIGluY2x1ZGU6IHtcbiAgICAgICAgICBwYXJ0aWNpcGFudHM6IHtcbiAgICAgICAgICAgIGluY2x1ZGU6IHtcbiAgICAgICAgICAgICAgdXNlcjoge1xuICAgICAgICAgICAgICAgIGluY2x1ZGU6IHtcbiAgICAgICAgICAgICAgICAgIG5vdGlmaWNhdGlvblNldHRpbmdzOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgZGV2aWNlVG9rZW5zOiB0cnVlLFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICB9KTtcblxuICAgICAgaWYgKCFjb252ZXJzYXRpb24pIHtcbiAgICAgICAgdGhpcy5sb2dnZXIud2FybihcbiAgICAgICAgICBgQ29udmVyc2F0aW9uICR7Y29udmVyc2F0aW9uSWR9IG5vdCBmb3VuZCBmb3IgcHVzaCBub3RpZmljYXRpb25zYCxcbiAgICAgICAgKTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuXG4gICAgICAvLyBGaWx0ZXIgcGFydGljaXBhbnRzIHdobyBzaG91bGQgcmVjZWl2ZSBwdXNoIG5vdGlmaWNhdGlvbnNcbiAgICAgIGNvbnN0IGVsaWdpYmxlUGFydGljaXBhbnRzID0gY29udmVyc2F0aW9uLnBhcnRpY2lwYW50cy5maWx0ZXIoXG4gICAgICAgIChwYXJ0aWNpcGFudCkgPT4ge1xuICAgICAgICAgIC8vIERvbid0IHNlbmQgdG8gbWVzc2FnZSBzZW5kZXJcbiAgICAgICAgICBpZiAocGFydGljaXBhbnQudXNlcklkID09PSBtZXNzYWdlLnNlbmRlcklkKSB7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgLy8gQ2hlY2sgaWYgdXNlciBoYXMgcHVzaCBub3RpZmljYXRpb25zIGVuYWJsZWQgZm9yIG1lc3NhZ2VzXG4gICAgICAgICAgY29uc3Qgc2V0dGluZ3MgPSBwYXJ0aWNpcGFudC51c2VyLm5vdGlmaWNhdGlvblNldHRpbmdzO1xuICAgICAgICAgIGlmICghc2V0dGluZ3M/LnB1c2hOZXdNZXNzYWdlcykge1xuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIC8vIENoZWNrIGlmIHVzZXIgaGFzIGFjdGl2ZSBkZXZpY2UgdG9rZW5zIGZvciBwdXNoIG5vdGlmaWNhdGlvbnNcbiAgICAgICAgICByZXR1cm4gKFxuICAgICAgICAgICAgcGFydGljaXBhbnQudXNlci5kZXZpY2VUb2tlbnMgJiZcbiAgICAgICAgICAgIHBhcnRpY2lwYW50LnVzZXIuZGV2aWNlVG9rZW5zLmxlbmd0aCA+IDBcbiAgICAgICAgICApO1xuICAgICAgICB9LFxuICAgICAgKTtcblxuICAgICAgaWYgKGVsaWdpYmxlUGFydGljaXBhbnRzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICB0aGlzLmxvZ2dlci5sb2coXG4gICAgICAgICAgYE5vIGVsaWdpYmxlIHBhcnRpY2lwYW50cyBmb3IgcHVzaCBub3RpZmljYXRpb25zIGluIGNvbnZlcnNhdGlvbiAke2NvbnZlcnNhdGlvbklkfWAsXG4gICAgICAgICk7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cblxuICAgICAgLy8gUHJlcGFyZSBub3RpZmljYXRpb24gcGF5bG9hZFxuICAgICAgY29uc3Qgbm90aWZpY2F0aW9uUGF5bG9hZCA9IHtcbiAgICAgICAgdGl0bGU6ICdOZXcgTWVzc2FnZScsXG4gICAgICAgIGJvZHk6XG4gICAgICAgICAgbWVzc2FnZS5jb250ZW50Lmxlbmd0aCA+IDUwXG4gICAgICAgICAgICA/IGAke21lc3NhZ2UuY29udGVudC5zdWJzdHJpbmcoMCwgNTApfS4uLmBcbiAgICAgICAgICAgIDogbWVzc2FnZS5jb250ZW50LFxuICAgICAgICBpY29uOiAnL2ljb24tMTkyeDE5Mi5wbmcnLFxuICAgICAgICBiYWRnZTogJy9iYWRnZS03Mng3Mi5wbmcnLFxuICAgICAgICBkYXRhOiB7XG4gICAgICAgICAgY29udmVyc2F0aW9uSWQ6IGNvbnZlcnNhdGlvbklkLFxuICAgICAgICAgIG1lc3NhZ2VJZDogbWVzc2FnZS5pZCxcbiAgICAgICAgICBzZW5kZXJJZDogbWVzc2FnZS5zZW5kZXJJZCxcbiAgICAgICAgICB1cmw6IGAvdXNlci9tZXNzYWdlcz9jb252ZXJzYXRpb249JHtjb252ZXJzYXRpb25JZH1gLFxuICAgICAgICB9LFxuICAgICAgfTtcblxuICAgICAgLy8gU2VuZCBwdXNoIG5vdGlmaWNhdGlvbnMgdG8gYWxsIGVsaWdpYmxlIHBhcnRpY2lwYW50c1xuICAgICAgY29uc3QgcHVzaFByb21pc2VzID0gZWxpZ2libGVQYXJ0aWNpcGFudHMuZmxhdE1hcCgocGFydGljaXBhbnQpID0+XG4gICAgICAgIHBhcnRpY2lwYW50LnVzZXIuZGV2aWNlVG9rZW5zLm1hcChhc3luYyAoZGV2aWNlVG9rZW46IGFueSkgPT4ge1xuICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAvLyBTaW1wbGlmaWVkIHB1c2ggbm90aWZpY2F0aW9uIC0gd291bGQgaW1wbGVtZW50IHByb3BlciBzZXJ2aWNlIGlmIGF2YWlsYWJsZVxuICAgICAgICAgICAgdGhpcy5sb2dnZXIubG9nKFxuICAgICAgICAgICAgICBgV291bGQgc2VuZCBwdXNoIG5vdGlmaWNhdGlvbiB0byBkZXZpY2U6ICR7ZGV2aWNlVG9rZW4udG9rZW59YCxcbiAgICAgICAgICAgICk7XG5cbiAgICAgICAgICAgIHRoaXMubG9nZ2VyLmxvZyhcbiAgICAgICAgICAgICAgYFB1c2ggbm90aWZpY2F0aW9uIHNlbnQgdG8gdXNlciAke3BhcnRpY2lwYW50LnVzZXJJZH0gZm9yIG1lc3NhZ2UgJHttZXNzYWdlLmlkfWAsXG4gICAgICAgICAgICApO1xuICAgICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICBjb25zdCBlcnJvck1lc3NhZ2UgPVxuICAgICAgICAgICAgICBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6ICdVbmtub3duIGVycm9yJztcbiAgICAgICAgICAgIHRoaXMubG9nZ2VyLmVycm9yKFxuICAgICAgICAgICAgICBgRmFpbGVkIHRvIHNlbmQgcHVzaCBub3RpZmljYXRpb24gdG8gdXNlciAke3BhcnRpY2lwYW50LnVzZXJJZH06ICR7ZXJyb3JNZXNzYWdlfWAsXG4gICAgICAgICAgICApO1xuXG4gICAgICAgICAgICAvLyBJZiBzdWJzY3JpcHRpb24gaXMgaW52YWxpZCwgcmVtb3ZlIGl0XG4gICAgICAgICAgICBpZiAoXG4gICAgICAgICAgICAgIGVycm9yTWVzc2FnZS5pbmNsdWRlcygnaW52YWxpZCcpIHx8XG4gICAgICAgICAgICAgIGVycm9yTWVzc2FnZS5pbmNsdWRlcygnZXhwaXJlZCcpXG4gICAgICAgICAgICApIHtcbiAgICAgICAgICAgICAgYXdhaXQgdGhpcy5wcmlzbWEuZGV2aWNlVG9rZW4uZGVsZXRlKHtcbiAgICAgICAgICAgICAgICB3aGVyZTogeyBpZDogZGV2aWNlVG9rZW4uaWQgfSxcbiAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgIHRoaXMubG9nZ2VyLmxvZyhcbiAgICAgICAgICAgICAgICBgUmVtb3ZlZCBpbnZhbGlkIHB1c2ggc3Vic2NyaXB0aW9uIGZvciB1c2VyICR7cGFydGljaXBhbnQudXNlcklkfWAsXG4gICAgICAgICAgICAgICk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9KSxcbiAgICAgICk7XG5cbiAgICAgIGF3YWl0IFByb21pc2UuYWxsU2V0dGxlZChwdXNoUHJvbWlzZXMpO1xuXG4gICAgICB0aGlzLmxvZ2dlci5sb2coXG4gICAgICAgIGBQdXNoIG5vdGlmaWNhdGlvbiBwcm9jZXNzaW5nIGNvbXBsZXRlZCBmb3IgY29udmVyc2F0aW9uICR7Y29udmVyc2F0aW9uSWR9YCxcbiAgICAgICk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRoaXMubG9nZ2VyLmVycm9yKFxuICAgICAgICBgRmFpbGVkIHRvIHNlbmQgcHVzaCBub3RpZmljYXRpb25zIGZvciBjb252ZXJzYXRpb24gJHtjb252ZXJzYXRpb25JZH06YCxcbiAgICAgICAgZXJyb3IsXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIC8vIENsZWFuIHVwIG9sZCB0eXBpbmcgaW5kaWNhdG9ycyAoY2FsbCB0aGlzIHBlcmlvZGljYWxseSlcbiAgYXN5bmMgY2xlYW51cFR5cGluZ0luZGljYXRvcnMoKSB7XG4gICAgY29uc3QgZml2ZU1pbnV0ZXNBZ28gPSBuZXcgRGF0ZShEYXRlLm5vdygpIC0gNSAqIDYwICogMTAwMCk7XG5cbiAgICBhd2FpdCB0aGlzLnByaXNtYS50eXBpbmdJbmRpY2F0b3IuZGVsZXRlTWFueSh7XG4gICAgICB3aGVyZToge1xuICAgICAgICBsYXN0VHlwaW5nQXQ6IHtcbiAgICAgICAgICBsdDogZml2ZU1pbnV0ZXNBZ28sXG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgIH0pO1xuICB9XG5cbiAgLy8gUGVyc29uYWwgcm9vbSBzdWJzY3JpcHRpb24gbWV0aG9kcyBmb3IgcmVhbC10aW1lIG5vdGlmaWNhdGlvbnNcbiAgYXN5bmMgc3Vic2NyaWJlVXNlclRvUGVyc29uYWxSb29tKFxuICAgIGNsaWVudDogQXV0aGVudGljYXRlZFNvY2tldCxcbiAgICB1c2VySWQ6IHN0cmluZyxcbiAgKSB7XG4gICAgY29uc3QgdXNlclJvb20gPSBgdXNlcl8ke3VzZXJJZH1gO1xuICAgIGF3YWl0IGNsaWVudC5qb2luKHVzZXJSb29tKTtcbiAgICB0aGlzLmxvZ2dlci5kZWJ1ZyhcbiAgICAgIGBVc2VyICR7dXNlcklkfSBzdWJzY3JpYmVkIHRvIHBlcnNvbmFsIHJvb206ICR7dXNlclJvb219YCxcbiAgICApO1xuICB9XG5cbiAgYXN5bmMgdW5zdWJzY3JpYmVVc2VyRnJvbVBlcnNvbmFsUm9vbShcbiAgICBjbGllbnQ6IEF1dGhlbnRpY2F0ZWRTb2NrZXQsXG4gICAgdXNlcklkOiBzdHJpbmcsXG4gICkge1xuICAgIGNvbnN0IHVzZXJSb29tID0gYHVzZXJfJHt1c2VySWR9YDtcbiAgICBhd2FpdCBjbGllbnQubGVhdmUodXNlclJvb20pO1xuICAgIHRoaXMubG9nZ2VyLmRlYnVnKFxuICAgICAgYFVzZXIgJHt1c2VySWR9IHVuc3Vic2NyaWJlZCBmcm9tIHBlcnNvbmFsIHJvb206ICR7dXNlclJvb219YCxcbiAgICApO1xuICB9XG5cbiAgLy8gQ29tbXVuaXR5IGFuZCBwb3N0IHJvb20gc3Vic2NyaXB0aW9ucyBmb3Igc29jaWFsIGZlYXR1cmVzXG4gIEBTdWJzY3JpYmVNZXNzYWdlKCdqb2luX2NvbW11bml0eScpXG4gIGFzeW5jIGhhbmRsZUpvaW5Db21tdW5pdHkoXG4gICAgQENvbm5lY3RlZFNvY2tldCgpIGNsaWVudDogQXV0aGVudGljYXRlZFNvY2tldCxcbiAgICBATWVzc2FnZUJvZHkoKSBkYXRhOiB7IGNvbW11bml0eUlkOiBzdHJpbmcgfSxcbiAgKSB7XG4gICAgaWYgKCF0aGlzLmlzQXV0aGVudGljYXRlZChjbGllbnQpKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgeyBjb21tdW5pdHlJZCB9ID0gZGF0YTtcbiAgICBjb25zdCB1c2VySWQgPSBjbGllbnQudXNlcklkITtcblxuICAgIHRyeSB7XG4gICAgICAvLyBWZXJpZnkgdXNlciBpcyBhIG1lbWJlciBvZiB0aGlzIGNvbW11bml0eVxuICAgICAgY29uc3QgbWVtYmVyc2hpcCA9IGF3YWl0IHRoaXMucHJpc21hLm1lbWJlcnNoaXAuZmluZEZpcnN0KHtcbiAgICAgICAgd2hlcmU6IHtcbiAgICAgICAgICBjb21tdW5pdHlJZCxcbiAgICAgICAgICB1c2VySWQsXG4gICAgICAgIH0sXG4gICAgICB9KTtcblxuICAgICAgaWYgKCFtZW1iZXJzaGlwKSB7XG4gICAgICAgIGNsaWVudC5lbWl0KCdlcnJvcicsIHsgbWVzc2FnZTogJ0FjY2VzcyBkZW5pZWQgdG8gdGhpcyBjb21tdW5pdHknIH0pO1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IGNvbW11bml0eVJvb20gPSBgY29tbXVuaXR5XyR7Y29tbXVuaXR5SWR9YDtcbiAgICAgIGF3YWl0IGNsaWVudC5qb2luKGNvbW11bml0eVJvb20pO1xuXG4gICAgICBjbGllbnQuZW1pdCgnY29tbXVuaXR5X2pvaW5lZCcsIHsgY29tbXVuaXR5SWQgfSk7XG4gICAgICB0aGlzLmxvZ2dlci5sb2coYFVzZXIgJHt1c2VySWR9IGpvaW5lZCBjb21tdW5pdHkgcm9vbSAke2NvbW11bml0eUlkfWApO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aGlzLmxvZ2dlci5lcnJvcignRXJyb3Igam9pbmluZyBjb21tdW5pdHk6JywgZXJyb3IpO1xuICAgICAgY2xpZW50LmVtaXQoJ2Vycm9yJywgeyBtZXNzYWdlOiAnRmFpbGVkIHRvIGpvaW4gY29tbXVuaXR5JyB9KTtcbiAgICB9XG4gIH1cblxuICBAU3Vic2NyaWJlTWVzc2FnZSgnbGVhdmVfY29tbXVuaXR5JylcbiAgYXN5bmMgaGFuZGxlTGVhdmVDb21tdW5pdHkoXG4gICAgQENvbm5lY3RlZFNvY2tldCgpIGNsaWVudDogQXV0aGVudGljYXRlZFNvY2tldCxcbiAgICBATWVzc2FnZUJvZHkoKSBkYXRhOiB7IGNvbW11bml0eUlkOiBzdHJpbmcgfSxcbiAgKSB7XG4gICAgaWYgKCF0aGlzLmlzQXV0aGVudGljYXRlZChjbGllbnQpKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgeyBjb21tdW5pdHlJZCB9ID0gZGF0YTtcbiAgICBjb25zdCB1c2VySWQgPSBjbGllbnQudXNlcklkITtcblxuICAgIGNvbnN0IGNvbW11bml0eVJvb20gPSBgY29tbXVuaXR5XyR7Y29tbXVuaXR5SWR9YDtcbiAgICBhd2FpdCBjbGllbnQubGVhdmUoY29tbXVuaXR5Um9vbSk7XG5cbiAgICBjbGllbnQuZW1pdCgnY29tbXVuaXR5X2xlZnQnLCB7IGNvbW11bml0eUlkIH0pO1xuICAgIHRoaXMubG9nZ2VyLmxvZyhgVXNlciAke3VzZXJJZH0gbGVmdCBjb21tdW5pdHkgcm9vbSAke2NvbW11bml0eUlkfWApO1xuICB9XG5cbiAgQFN1YnNjcmliZU1lc3NhZ2UoJ2pvaW5fcG9zdCcpXG4gIGFzeW5jIGhhbmRsZUpvaW5Qb3N0KFxuICAgIEBDb25uZWN0ZWRTb2NrZXQoKSBjbGllbnQ6IEF1dGhlbnRpY2F0ZWRTb2NrZXQsXG4gICAgQE1lc3NhZ2VCb2R5KCkgZGF0YTogeyBwb3N0SWQ6IHN0cmluZyB9LFxuICApIHtcbiAgICBpZiAoIXRoaXMuaXNBdXRoZW50aWNhdGVkKGNsaWVudCkpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjb25zdCB7IHBvc3RJZCB9ID0gZGF0YTtcbiAgICBjb25zdCB1c2VySWQgPSBjbGllbnQudXNlcklkITtcblxuICAgIHRyeSB7XG4gICAgICAvLyBWZXJpZnkgcG9zdCBleGlzdHMgYW5kIHVzZXIgaGFzIGFjY2Vzc1xuICAgICAgY29uc3QgcG9zdCA9IGF3YWl0IHRoaXMucHJpc21hLnBvc3QuZmluZEZpcnN0KHtcbiAgICAgICAgd2hlcmU6IHtcbiAgICAgICAgICBpZDogcG9zdElkLFxuICAgICAgICAgIHJvb206IHtcbiAgICAgICAgICAgIHJvb21Hcm91cDoge1xuICAgICAgICAgICAgICBjb21tdW5pdHk6IHtcbiAgICAgICAgICAgICAgICBtZW1iZXJzaGlwczoge1xuICAgICAgICAgICAgICAgICAgc29tZToge1xuICAgICAgICAgICAgICAgICAgICB1c2VySWQsXG4gICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICB9KTtcblxuICAgICAgaWYgKCFwb3N0KSB7XG4gICAgICAgIGNsaWVudC5lbWl0KCdlcnJvcicsIHsgbWVzc2FnZTogJ0FjY2VzcyBkZW5pZWQgdG8gdGhpcyBwb3N0JyB9KTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBwb3N0Um9vbSA9IGBwb3N0XyR7cG9zdElkfWA7XG4gICAgICBhd2FpdCBjbGllbnQuam9pbihwb3N0Um9vbSk7XG5cbiAgICAgIGNsaWVudC5lbWl0KCdwb3N0X2pvaW5lZCcsIHsgcG9zdElkIH0pO1xuICAgICAgdGhpcy5sb2dnZXIubG9nKGBVc2VyICR7dXNlcklkfSBqb2luZWQgcG9zdCByb29tICR7cG9zdElkfWApO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aGlzLmxvZ2dlci5lcnJvcignRXJyb3Igam9pbmluZyBwb3N0OicsIGVycm9yKTtcbiAgICAgIGNsaWVudC5lbWl0KCdlcnJvcicsIHsgbWVzc2FnZTogJ0ZhaWxlZCB0byBqb2luIHBvc3QnIH0pO1xuICAgIH1cbiAgfVxuXG4gIEBTdWJzY3JpYmVNZXNzYWdlKCdsZWF2ZV9wb3N0JylcbiAgYXN5bmMgaGFuZGxlTGVhdmVQb3N0KFxuICAgIEBDb25uZWN0ZWRTb2NrZXQoKSBjbGllbnQ6IEF1dGhlbnRpY2F0ZWRTb2NrZXQsXG4gICAgQE1lc3NhZ2VCb2R5KCkgZGF0YTogeyBwb3N0SWQ6IHN0cmluZyB9LFxuICApIHtcbiAgICBpZiAoIXRoaXMuaXNBdXRoZW50aWNhdGVkKGNsaWVudCkpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjb25zdCB7IHBvc3RJZCB9ID0gZGF0YTtcbiAgICBjb25zdCB1c2VySWQgPSBjbGllbnQudXNlcklkITtcblxuICAgIGNvbnN0IHBvc3RSb29tID0gYHBvc3RfJHtwb3N0SWR9YDtcbiAgICBhd2FpdCBjbGllbnQubGVhdmUocG9zdFJvb20pO1xuXG4gICAgY2xpZW50LmVtaXQoJ3Bvc3RfbGVmdCcsIHsgcG9zdElkIH0pO1xuICAgIHRoaXMubG9nZ2VyLmxvZyhgVXNlciAke3VzZXJJZH0gbGVmdCBwb3N0IHJvb20gJHtwb3N0SWR9YCk7XG4gIH1cblxuICAvLyBVdGlsaXR5IG1ldGhvZCB0byBnZXQgc2VydmVyIGluc3RhbmNlIGZvciBldmVudCBicm9hZGNhc3RpbmdcbiAgZ2V0U2VydmVyKCk6IFNlcnZlciB7XG4gICAgcmV0dXJuIHRoaXMuc2VydmVyO1xuICB9XG59XG4iXSwidmVyc2lvbiI6M30=