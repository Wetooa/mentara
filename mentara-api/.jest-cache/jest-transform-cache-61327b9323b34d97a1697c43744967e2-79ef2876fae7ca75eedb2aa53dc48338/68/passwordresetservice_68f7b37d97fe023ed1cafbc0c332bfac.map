{"file":"/home/wetooa/Documents/code/projects/mentara/mentara-api/src/auth/services/password-reset.service.ts","mappings":"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","names":[],"sources":["/home/wetooa/Documents/code/projects/mentara/mentara-api/src/auth/services/password-reset.service.ts"],"sourcesContent":["import {\n  Injectable,\n  BadRequestException,\n  NotFoundException,\n} from '@nestjs/common';\nimport { PrismaService } from '../../providers/prisma-client.provider';\nimport { EmailService } from '../../email/email.service';\nimport { TokenService } from './token.service';\nimport * as crypto from 'crypto';\n\n@Injectable()\nexport class PasswordResetService {\n  constructor(\n    private readonly prisma: PrismaService,\n    private readonly emailService: EmailService,\n    private readonly tokenService: TokenService,\n  ) {}\n\n  async requestPasswordReset(email: string): Promise<void> {\n    const user = await this.prisma.user.findUnique({\n      where: { email },\n      select: {\n        id: true,\n        email: true,\n        firstName: true,\n        deactivatedAt: true,\n        resetToken: true,\n        resetTokenExpiry: true,\n      },\n    });\n\n    if (!user) {\n      // Don't reveal if email exists for security\n      return;\n    }\n\n    if (user.deactivatedAt) {\n      throw new BadRequestException('Account is deactivated');\n    }\n\n    // Check if there's an existing valid token (prevent spam)\n    if (\n      user.resetToken &&\n      user.resetTokenExpiry &&\n      user.resetTokenExpiry > new Date()\n    ) {\n      const timeDiff = user.resetTokenExpiry.getTime() - new Date().getTime();\n      if (timeDiff > 50 * 60 * 1000) {\n        // More than 50 minutes remaining\n        throw new BadRequestException(\n          'Password reset email already sent. Please check your email or wait before requesting again.',\n        );\n      }\n    }\n\n    // Generate new reset token\n    const { token, hashedToken, expiresAt } =\n      await this.tokenService.generatePasswordResetToken();\n\n    // Update user with reset token\n    await this.prisma.user.update({\n      where: { id: user.id },\n      data: {\n        resetToken: hashedToken,\n        resetTokenExpiry: expiresAt,\n      },\n    });\n\n    // Send password reset email\n    await this.sendPasswordResetEmail(user.email, user.firstName, token);\n  }\n\n  async resetPassword(\n    token: string,\n    newPassword: string,\n  ): Promise<{ success: boolean; message: string }> {\n    if (!token || !newPassword) {\n      throw new BadRequestException(\n        'Reset token and new password are required',\n      );\n    }\n\n    // Validate password strength\n    this.validatePasswordStrength(newPassword);\n\n    const hashedToken = crypto.createHash('sha256').update(token).digest('hex');\n\n    const user = await this.prisma.user.findUnique({\n      where: { resetToken: hashedToken },\n      select: {\n        id: true,\n        email: true,\n        resetTokenExpiry: true,\n        deactivatedAt: true,\n        password: true,\n      },\n    });\n\n    if (!user) {\n      throw new BadRequestException('Invalid or expired reset token');\n    }\n\n    if (user.deactivatedAt) {\n      throw new BadRequestException('Account is deactivated');\n    }\n\n    if (!user.resetTokenExpiry || user.resetTokenExpiry < new Date()) {\n      // Clean up expired token\n      await this.prisma.user.update({\n        where: { id: user.id },\n        data: {\n          resetToken: null,\n          resetTokenExpiry: null,\n        },\n      });\n      throw new BadRequestException('Reset token has expired');\n    }\n\n    // Check if new password is different from current (if user has one)\n    if (user.password) {\n      const isSamePassword = await this.tokenService.comparePassword(\n        newPassword,\n        user.password,\n      );\n      if (isSamePassword) {\n        throw new BadRequestException(\n          'New password must be different from current password',\n        );\n      }\n    }\n\n    // Hash new password\n    const hashedPassword = await this.tokenService.hashPassword(newPassword);\n\n    // Update password and clear reset token\n    await this.prisma.user.update({\n      where: { id: user.id },\n      data: {\n        password: hashedPassword,\n        resetToken: null,\n        resetTokenExpiry: null,\n        failedLoginCount: 0, // Reset failed login attempts\n        lockoutUntil: null, // Clear any lockout\n      },\n    });\n\n    // Simple logout for security after password reset\n    await this.tokenService.logout(user.id);\n\n    // Send confirmation email\n    await this.sendPasswordResetConfirmationEmail(user.email);\n\n    return {\n      success: true,\n      message: 'Password reset successfully',\n    };\n  }\n\n  async validateResetToken(\n    token: string,\n  ): Promise<{ valid: boolean; email?: string }> {\n    if (!token) {\n      return { valid: false };\n    }\n\n    const hashedToken = crypto.createHash('sha256').update(token).digest('hex');\n\n    const user = await this.prisma.user.findUnique({\n      where: { resetToken: hashedToken },\n      select: {\n        email: true,\n        resetTokenExpiry: true,\n        deactivatedAt: true,\n      },\n    });\n\n    if (!user || user.deactivatedAt) {\n      return { valid: false };\n    }\n\n    if (!user.resetTokenExpiry || user.resetTokenExpiry < new Date()) {\n      return { valid: false };\n    }\n\n    return {\n      valid: true,\n      email: user.email,\n    };\n  }\n\n  private validatePasswordStrength(password: string): void {\n    const minLength = parseInt(process.env.MIN_PASSWORD_LENGTH || '8');\n\n    if (password.length < minLength) {\n      throw new BadRequestException(\n        `Password must be at least ${minLength} characters long`,\n      );\n    }\n\n    // Check for at least one uppercase letter\n    if (!/[A-Z]/.test(password)) {\n      throw new BadRequestException(\n        'Password must contain at least one uppercase letter',\n      );\n    }\n\n    // Check for at least one lowercase letter\n    if (!/[a-z]/.test(password)) {\n      throw new BadRequestException(\n        'Password must contain at least one lowercase letter',\n      );\n    }\n\n    // Check for at least one number\n    if (!/\\d/.test(password)) {\n      throw new BadRequestException(\n        'Password must contain at least one number',\n      );\n    }\n\n    // Check for at least one special character\n    if (!/[!@#$%^&*()_+\\-=\\[\\]{};':\"\\\\|,.<>\\/?]/.test(password)) {\n      throw new BadRequestException(\n        'Password must contain at least one special character',\n      );\n    }\n\n    // Check for common weak passwords\n    const commonPasswords = [\n      'password',\n      'password123',\n      '123456',\n      'qwerty',\n      'abc123',\n      'letmein',\n      'welcome',\n      'monkey',\n      '1234567890',\n      'admin',\n    ];\n\n    if (commonPasswords.includes(password.toLowerCase())) {\n      throw new BadRequestException(\n        'Password is too common. Please choose a more secure password',\n      );\n    }\n  }\n\n  private async sendPasswordResetEmail(\n    email: string,\n    firstName: string,\n    token: string,\n  ): Promise<void> {\n    const resetUrl = `${process.env.FRONTEND_URL}/reset-password?token=${token}`;\n\n    try {\n      const html = `\n        <div style=\"font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;\">\n          <h2 style=\"color: #8B5CF6;\">Reset Your Mentara Password</h2>\n          <p>Hello ${firstName},</p>\n          <p>We received a request to reset your password for your Mentara account. Click the button below to reset your password.</p>\n          <div style=\"text-align: center; margin: 30px 0;\">\n            <a href=\"${resetUrl}\" style=\"background-color: #8B5CF6; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; display: inline-block;\">\n              Reset Password\n            </a>\n          </div>\n          <p>This link will expire in 1 hour for security reasons.</p>\n          <p>If you didn't request a password reset, you can safely ignore this email. Your password will not be changed.</p>\n          <p>If you have any questions, please contact us at ${process.env.SUPPORT_EMAIL || 'support@mentara.com'}</p>\n          <hr style=\"border: none; border-top: 1px solid #eee; margin: 30px 0;\">\n          <p style=\"color: #666; font-size: 12px;\">\n            This is an automated message from Mentara. Please do not reply to this email.\n          </p>\n        </div>\n      `;\n\n      await this.emailService.sendPasswordReset(\n        email,\n        firstName,\n        'Reset Your Mentara Password',\n        resetUrl\n      );\n    } catch (error) {\n      console.error('Failed to send password reset email:', error);\n      throw new BadRequestException('Failed to send password reset email');\n    }\n  }\n\n  private async sendPasswordResetConfirmationEmail(\n    email: string,\n  ): Promise<void> {\n    try {\n      const html = `\n        <div style=\"font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;\">\n          <h2 style=\"color: #10B981;\">Password Reset Successful</h2>\n          <p>Your password has been successfully reset for your Mentara account.</p>\n          <p>If you didn't make this change, please contact our support team immediately at ${process.env.SUPPORT_EMAIL || 'support@mentara.com'}.</p>\n          <div style=\"text-align: center; margin: 30px 0;\">\n            <a href=\"${process.env.FRONTEND_URL}/login\" style=\"background-color: #8B5CF6; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; display: inline-block;\">\n              Login to Your Account\n            </a>\n          </div>\n          <hr style=\"border: none; border-top: 1px solid #eee; margin: 30px 0;\">\n          <p style=\"color: #666; font-size: 12px;\">\n            This is an automated message from Mentara. Please do not reply to this email.\n          </p>\n        </div>\n      `;\n\n      await this.emailService.sendPasswordResetSuccess(\n        email,\n        'User',\n        'Password Reset Successful'\n      );\n    } catch (error) {\n      console.error('Failed to send password reset confirmation email:', error);\n      // Don't throw error here as password reset was successful\n    }\n  }\n\n  async cleanupExpiredTokens(): Promise<void> {\n    await this.prisma.user.updateMany({\n      where: {\n        resetTokenExpiry: {\n          lt: new Date(),\n        },\n      },\n      data: {\n        resetToken: null,\n        resetTokenExpiry: null,\n      },\n    });\n  }\n}\n"],"version":3}