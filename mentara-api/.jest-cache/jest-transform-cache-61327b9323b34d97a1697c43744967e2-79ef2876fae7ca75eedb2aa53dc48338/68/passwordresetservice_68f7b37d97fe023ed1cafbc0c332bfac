a979827a4c188aa69b423375f24bd505
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var _a, _b, _c;
Object.defineProperty(exports, "__esModule", { value: true });
exports.PasswordResetService = void 0;
const common_1 = require("@nestjs/common");
const prisma_client_provider_1 = require("../../providers/prisma-client.provider");
const email_service_1 = require("../../email/email.service");
const token_service_1 = require("./token.service");
const crypto = require("crypto");
let PasswordResetService = class PasswordResetService {
    prisma;
    emailService;
    tokenService;
    constructor(prisma, emailService, tokenService) {
        this.prisma = prisma;
        this.emailService = emailService;
        this.tokenService = tokenService;
    }
    async requestPasswordReset(email) {
        const user = await this.prisma.user.findUnique({
            where: { email },
            select: {
                id: true,
                email: true,
                firstName: true,
                deactivatedAt: true,
                resetToken: true,
                resetTokenExpiry: true,
            },
        });
        if (!user) {
            // Don't reveal if email exists for security
            return;
        }
        if (user.deactivatedAt) {
            throw new common_1.BadRequestException('Account is deactivated');
        }
        // Check if there's an existing valid token (prevent spam)
        if (user.resetToken &&
            user.resetTokenExpiry &&
            user.resetTokenExpiry > new Date()) {
            const timeDiff = user.resetTokenExpiry.getTime() - new Date().getTime();
            if (timeDiff > 50 * 60 * 1000) {
                // More than 50 minutes remaining
                throw new common_1.BadRequestException('Password reset email already sent. Please check your email or wait before requesting again.');
            }
        }
        // Generate new reset token
        const { token, hashedToken, expiresAt } = await this.tokenService.generatePasswordResetToken();
        // Update user with reset token
        await this.prisma.user.update({
            where: { id: user.id },
            data: {
                resetToken: hashedToken,
                resetTokenExpiry: expiresAt,
            },
        });
        // Send password reset email
        await this.sendPasswordResetEmail(user.email, user.firstName, token);
    }
    async resetPassword(token, newPassword) {
        if (!token || !newPassword) {
            throw new common_1.BadRequestException('Reset token and new password are required');
        }
        // Validate password strength
        this.validatePasswordStrength(newPassword);
        const hashedToken = crypto.createHash('sha256').update(token).digest('hex');
        const user = await this.prisma.user.findUnique({
            where: { resetToken: hashedToken },
            select: {
                id: true,
                email: true,
                resetTokenExpiry: true,
                deactivatedAt: true,
                password: true,
            },
        });
        if (!user) {
            throw new common_1.BadRequestException('Invalid or expired reset token');
        }
        if (user.deactivatedAt) {
            throw new common_1.BadRequestException('Account is deactivated');
        }
        if (!user.resetTokenExpiry || user.resetTokenExpiry < new Date()) {
            // Clean up expired token
            await this.prisma.user.update({
                where: { id: user.id },
                data: {
                    resetToken: null,
                    resetTokenExpiry: null,
                },
            });
            throw new common_1.BadRequestException('Reset token has expired');
        }
        // Check if new password is different from current (if user has one)
        if (user.password) {
            const isSamePassword = await this.tokenService.comparePassword(newPassword, user.password);
            if (isSamePassword) {
                throw new common_1.BadRequestException('New password must be different from current password');
            }
        }
        // Hash new password
        const hashedPassword = await this.tokenService.hashPassword(newPassword);
        // Update password and clear reset token
        await this.prisma.user.update({
            where: { id: user.id },
            data: {
                password: hashedPassword,
                resetToken: null,
                resetTokenExpiry: null,
                failedLoginCount: 0, // Reset failed login attempts
                lockoutUntil: null, // Clear any lockout
            },
        });
        // Simple logout for security after password reset
        await this.tokenService.logout(user.id);
        // Send confirmation email
        await this.sendPasswordResetConfirmationEmail(user.email);
        return {
            success: true,
            message: 'Password reset successfully',
        };
    }
    async validateResetToken(token) {
        if (!token) {
            return { valid: false };
        }
        const hashedToken = crypto.createHash('sha256').update(token).digest('hex');
        const user = await this.prisma.user.findUnique({
            where: { resetToken: hashedToken },
            select: {
                email: true,
                resetTokenExpiry: true,
                deactivatedAt: true,
            },
        });
        if (!user || user.deactivatedAt) {
            return { valid: false };
        }
        if (!user.resetTokenExpiry || user.resetTokenExpiry < new Date()) {
            return { valid: false };
        }
        return {
            valid: true,
            email: user.email,
        };
    }
    validatePasswordStrength(password) {
        const minLength = parseInt(process.env.MIN_PASSWORD_LENGTH || '8');
        if (password.length < minLength) {
            throw new common_1.BadRequestException(`Password must be at least ${minLength} characters long`);
        }
        // Check for at least one uppercase letter
        if (!/[A-Z]/.test(password)) {
            throw new common_1.BadRequestException('Password must contain at least one uppercase letter');
        }
        // Check for at least one lowercase letter
        if (!/[a-z]/.test(password)) {
            throw new common_1.BadRequestException('Password must contain at least one lowercase letter');
        }
        // Check for at least one number
        if (!/\d/.test(password)) {
            throw new common_1.BadRequestException('Password must contain at least one number');
        }
        // Check for at least one special character
        if (!/[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password)) {
            throw new common_1.BadRequestException('Password must contain at least one special character');
        }
        // Check for common weak passwords
        const commonPasswords = [
            'password',
            'password123',
            '123456',
            'qwerty',
            'abc123',
            'letmein',
            'welcome',
            'monkey',
            '1234567890',
            'admin',
        ];
        if (commonPasswords.includes(password.toLowerCase())) {
            throw new common_1.BadRequestException('Password is too common. Please choose a more secure password');
        }
    }
    async sendPasswordResetEmail(email, firstName, token) {
        const resetUrl = `${process.env.FRONTEND_URL}/reset-password?token=${token}`;
        try {
            const html = `
        <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
          <h2 style="color: #8B5CF6;">Reset Your Mentara Password</h2>
          <p>Hello ${firstName},</p>
          <p>We received a request to reset your password for your Mentara account. Click the button below to reset your password.</p>
          <div style="text-align: center; margin: 30px 0;">
            <a href="${resetUrl}" style="background-color: #8B5CF6; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; display: inline-block;">
              Reset Password
            </a>
          </div>
          <p>This link will expire in 1 hour for security reasons.</p>
          <p>If you didn't request a password reset, you can safely ignore this email. Your password will not be changed.</p>
          <p>If you have any questions, please contact us at ${process.env.SUPPORT_EMAIL || 'support@mentara.com'}</p>
          <hr style="border: none; border-top: 1px solid #eee; margin: 30px 0;">
          <p style="color: #666; font-size: 12px;">
            This is an automated message from Mentara. Please do not reply to this email.
          </p>
        </div>
      `;
            await this.emailService.sendPasswordReset(email, firstName, 'Reset Your Mentara Password', resetUrl);
        }
        catch (error) {
            console.error('Failed to send password reset email:', error);
            throw new common_1.BadRequestException('Failed to send password reset email');
        }
    }
    async sendPasswordResetConfirmationEmail(email) {
        try {
            const html = `
        <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
          <h2 style="color: #10B981;">Password Reset Successful</h2>
          <p>Your password has been successfully reset for your Mentara account.</p>
          <p>If you didn't make this change, please contact our support team immediately at ${process.env.SUPPORT_EMAIL || 'support@mentara.com'}.</p>
          <div style="text-align: center; margin: 30px 0;">
            <a href="${process.env.FRONTEND_URL}/login" style="background-color: #8B5CF6; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; display: inline-block;">
              Login to Your Account
            </a>
          </div>
          <hr style="border: none; border-top: 1px solid #eee; margin: 30px 0;">
          <p style="color: #666; font-size: 12px;">
            This is an automated message from Mentara. Please do not reply to this email.
          </p>
        </div>
      `;
            await this.emailService.sendPasswordResetSuccess(email, 'User', 'Password Reset Successful');
        }
        catch (error) {
            console.error('Failed to send password reset confirmation email:', error);
            // Don't throw error here as password reset was successful
        }
    }
    async cleanupExpiredTokens() {
        await this.prisma.user.updateMany({
            where: {
                resetTokenExpiry: {
                    lt: new Date(),
                },
            },
            data: {
                resetToken: null,
                resetTokenExpiry: null,
            },
        });
    }
};
exports.PasswordResetService = PasswordResetService;
exports.PasswordResetService = PasswordResetService = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [typeof (_a = typeof prisma_client_provider_1.PrismaService !== "undefined" && prisma_client_provider_1.PrismaService) === "function" ? _a : Object, typeof (_b = typeof email_service_1.EmailService !== "undefined" && email_service_1.EmailService) === "function" ? _b : Object, typeof (_c = typeof token_service_1.TokenService !== "undefined" && token_service_1.TokenService) === "function" ? _c : Object])
], PasswordResetService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL2F1dGgvc2VydmljZXMvcGFzc3dvcmQtcmVzZXQuc2VydmljZS50cyIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7O0FBQUEsMkNBSXdCO0FBQ3hCLG1GQUF1RTtBQUN2RSw2REFBeUQ7QUFDekQsbURBQStDO0FBQy9DLGlDQUFpQztBQUcxQixJQUFNLG9CQUFvQixHQUExQixNQUFNLG9CQUFvQjtJQUVaO0lBQ0E7SUFDQTtJQUhuQixZQUNtQixNQUFxQixFQUNyQixZQUEwQixFQUMxQixZQUEwQjtRQUYxQixXQUFNLEdBQU4sTUFBTSxDQUFlO1FBQ3JCLGlCQUFZLEdBQVosWUFBWSxDQUFjO1FBQzFCLGlCQUFZLEdBQVosWUFBWSxDQUFjO0lBQzFDLENBQUM7SUFFSixLQUFLLENBQUMsb0JBQW9CLENBQUMsS0FBYTtRQUN0QyxNQUFNLElBQUksR0FBRyxNQUFNLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQztZQUM3QyxLQUFLLEVBQUUsRUFBRSxLQUFLLEVBQUU7WUFDaEIsTUFBTSxFQUFFO2dCQUNOLEVBQUUsRUFBRSxJQUFJO2dCQUNSLEtBQUssRUFBRSxJQUFJO2dCQUNYLFNBQVMsRUFBRSxJQUFJO2dCQUNmLGFBQWEsRUFBRSxJQUFJO2dCQUNuQixVQUFVLEVBQUUsSUFBSTtnQkFDaEIsZ0JBQWdCLEVBQUUsSUFBSTthQUN2QjtTQUNGLENBQUMsQ0FBQztRQUVILElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQztZQUNWLDRDQUE0QztZQUM1QyxPQUFPO1FBQ1QsQ0FBQztRQUVELElBQUksSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO1lBQ3ZCLE1BQU0sSUFBSSw0QkFBbUIsQ0FBQyx3QkFBd0IsQ0FBQyxDQUFDO1FBQzFELENBQUM7UUFFRCwwREFBMEQ7UUFDMUQsSUFDRSxJQUFJLENBQUMsVUFBVTtZQUNmLElBQUksQ0FBQyxnQkFBZ0I7WUFDckIs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QixFQUFFLElBQUk7YUFDdkI7U0FDRixDQUFDLENBQUM7SUFDTCxDQUFDO0NBQ0YsQ0FBQTtBQWxVWSxvREFBb0I7K0JBQXBCLG9CQUFvQjtJQURoQyxJQUFBLG1CQUFVLEdBQUU7eURBR2dCLHNDQUFhLG9CQUFiLHNDQUFhLG9EQUNQLDRCQUFZLG9CQUFaLDRCQUFZLG9EQUNaLDRCQUFZLG9CQUFaLDRCQUFZO0dBSmxDLG9CQUFvQixDQWtVaEMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL2F1dGgvc2VydmljZXMvcGFzc3dvcmQtcmVzZXQuc2VydmljZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBJbmplY3RhYmxlLFxuICBCYWRSZXF1ZXN0RXhjZXB0aW9uLFxuICBOb3RGb3VuZEV4Y2VwdGlvbixcbn0gZnJvbSAnQG5lc3Rqcy9jb21tb24nO1xuaW1wb3J0IHsgUHJpc21hU2VydmljZSB9IGZyb20gJy4uLy4uL3Byb3ZpZGVycy9wcmlzbWEtY2xpZW50LnByb3ZpZGVyJztcbmltcG9ydCB7IEVtYWlsU2VydmljZSB9IGZyb20gJy4uLy4uL2VtYWlsL2VtYWlsLnNlcnZpY2UnO1xuaW1wb3J0IHsgVG9rZW5TZXJ2aWNlIH0gZnJvbSAnLi90b2tlbi5zZXJ2aWNlJztcbmltcG9ydCAqIGFzIGNyeXB0byBmcm9tICdjcnlwdG8nO1xuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgUGFzc3dvcmRSZXNldFNlcnZpY2Uge1xuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHJlYWRvbmx5IHByaXNtYTogUHJpc21hU2VydmljZSxcbiAgICBwcml2YXRlIHJlYWRvbmx5IGVtYWlsU2VydmljZTogRW1haWxTZXJ2aWNlLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgdG9rZW5TZXJ2aWNlOiBUb2tlblNlcnZpY2UsXG4gICkge31cblxuICBhc3luYyByZXF1ZXN0UGFzc3dvcmRSZXNldChlbWFpbDogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgY29uc3QgdXNlciA9IGF3YWl0IHRoaXMucHJpc21hLnVzZXIuZmluZFVuaXF1ZSh7XG4gICAgICB3aGVyZTogeyBlbWFpbCB9LFxuICAgICAgc2VsZWN0OiB7XG4gICAgICAgIGlkOiB0cnVlLFxuICAgICAgICBlbWFpbDogdHJ1ZSxcbiAgICAgICAgZmlyc3ROYW1lOiB0cnVlLFxuICAgICAgICBkZWFjdGl2YXRlZEF0OiB0cnVlLFxuICAgICAgICByZXNldFRva2VuOiB0cnVlLFxuICAgICAgICByZXNldFRva2VuRXhwaXJ5OiB0cnVlLFxuICAgICAgfSxcbiAgICB9KTtcblxuICAgIGlmICghdXNlcikge1xuICAgICAgLy8gRG9uJ3QgcmV2ZWFsIGlmIGVtYWlsIGV4aXN0cyBmb3Igc2VjdXJpdHlcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpZiAodXNlci5kZWFjdGl2YXRlZEF0KSB7XG4gICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdEV4Y2VwdGlvbignQWNjb3VudCBpcyBkZWFjdGl2YXRlZCcpO1xuICAgIH1cblxuICAgIC8vIENoZWNrIGlmIHRoZXJlJ3MgYW4gZXhpc3RpbmcgdmFsaWQgdG9rZW4gKHByZXZlbnQgc3BhbSlcbiAgICBpZiAoXG4gICAgICB1c2VyLnJlc2V0VG9rZW4gJiZcbiAgICAgIHVzZXIucmVzZXRUb2tlbkV4cGlyeSAmJlxuICAgICAgdXNlci5yZXNldFRva2VuRXhwaXJ5ID4gbmV3IERhdGUoKVxuICAgICkge1xuICAgICAgY29uc3QgdGltZURpZmYgPSB1c2VyLnJlc2V0VG9rZW5FeHBpcnkuZ2V0VGltZSgpIC0gbmV3IERhdGUoKS5nZXRUaW1lKCk7XG4gICAgICBpZiAodGltZURpZmYgPiA1MCAqIDYwICogMTAwMCkge1xuICAgICAgICAvLyBNb3JlIHRoYW4gNTAgbWludXRlcyByZW1haW5pbmdcbiAgICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFeGNlcHRpb24oXG4gICAgICAgICAgJ1Bhc3N3b3JkIHJlc2V0IGVtYWlsIGFscmVhZHkgc2VudC4gUGxlYXNlIGNoZWNrIHlvdXIgZW1haWwgb3Igd2FpdCBiZWZvcmUgcmVxdWVzdGluZyBhZ2Fpbi4nLFxuICAgICAgICApO1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vIEdlbmVyYXRlIG5ldyByZXNldCB0b2tlblxuICAgIGNvbnN0IHsgdG9rZW4sIGhhc2hlZFRva2VuLCBleHBpcmVzQXQgfSA9XG4gICAgICBhd2FpdCB0aGlzLnRva2VuU2VydmljZS5nZW5lcmF0ZVBhc3N3b3JkUmVzZXRUb2tlbigpO1xuXG4gICAgLy8gVXBkYXRlIHVzZXIgd2l0aCByZXNldCB0b2tlblxuICAgIGF3YWl0IHRoaXMucHJpc21hLnVzZXIudXBkYXRlKHtcbiAgICAgIHdoZXJlOiB7IGlkOiB1c2VyLmlkIH0sXG4gICAgICBkYXRhOiB7XG4gICAgICAgIHJlc2V0VG9rZW46IGhhc2hlZFRva2VuLFxuICAgICAgICByZXNldFRva2VuRXhwaXJ5OiBleHBpcmVzQXQsXG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgLy8gU2VuZCBwYXNzd29yZCByZXNldCBlbWFpbFxuICAgIGF3YWl0IHRoaXMuc2VuZFBhc3N3b3JkUmVzZXRFbWFpbCh1c2VyLmVtYWlsLCB1c2VyLmZpcnN0TmFtZSwgdG9rZW4pO1xuICB9XG5cbiAgYXN5bmMgcmVzZXRQYXNzd29yZChcbiAgICB0b2tlbjogc3RyaW5nLFxuICAgIG5ld1Bhc3N3b3JkOiBzdHJpbmcsXG4gICk6IFByb21pc2U8eyBzdWNjZXNzOiBib29sZWFuOyBtZXNzYWdlOiBzdHJpbmcgfT4ge1xuICAgIGlmICghdG9rZW4gfHwgIW5ld1Bhc3N3b3JkKSB7XG4gICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdEV4Y2VwdGlvbihcbiAgICAgICAgJ1Jlc2V0IHRva2VuIGFuZCBuZXcgcGFzc3dvcmQgYXJlIHJlcXVpcmVkJyxcbiAgICAgICk7XG4gICAgfVxuXG4gICAgLy8gVmFsaWRhdGUgcGFzc3dvcmQgc3RyZW5ndGhcbiAgICB0aGlzLnZhbGlkYXRlUGFzc3dvcmRTdHJlbmd0aChuZXdQYXNzd29yZCk7XG5cbiAgICBjb25zdCBoYXNoZWRUb2tlbiA9IGNyeXB0by5jcmVhdGVIYXNoKCdzaGEyNTYnKS51cGRhdGUodG9rZW4pLmRpZ2VzdCgnaGV4Jyk7XG5cbiAgICBjb25zdCB1c2VyID0gYXdhaXQgdGhpcy5wcmlzbWEudXNlci5maW5kVW5pcXVlKHtcbiAgICAgIHdoZXJlOiB7IHJlc2V0VG9rZW46IGhhc2hlZFRva2VuIH0sXG4gICAgICBzZWxlY3Q6IHtcbiAgICAgICAgaWQ6IHRydWUsXG4gICAgICAgIGVtYWlsOiB0cnVlLFxuICAgICAgICByZXNldFRva2VuRXhwaXJ5OiB0cnVlLFxuICAgICAgICBkZWFjdGl2YXRlZEF0OiB0cnVlLFxuICAgICAgICBwYXNzd29yZDogdHJ1ZSxcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICBpZiAoIXVzZXIpIHtcbiAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0RXhjZXB0aW9uKCdJbnZhbGlkIG9yIGV4cGlyZWQgcmVzZXQgdG9rZW4nKTtcbiAgICB9XG5cbiAgICBpZiAodXNlci5kZWFjdGl2YXRlZEF0KSB7XG4gICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdEV4Y2VwdGlvbignQWNjb3VudCBpcyBkZWFjdGl2YXRlZCcpO1xuICAgIH1cblxuICAgIGlmICghdXNlci5yZXNldFRva2VuRXhwaXJ5IHx8IHVzZXIucmVzZXRUb2tlbkV4cGlyeSA8IG5ldyBEYXRlKCkpIHtcbiAgICAgIC8vIENsZWFuIHVwIGV4cGlyZWQgdG9rZW5cbiAgICAgIGF3YWl0IHRoaXMucHJpc21hLnVzZXIudXBkYXRlKHtcbiAgICAgICAgd2hlcmU6IHsgaWQ6IHVzZXIuaWQgfSxcbiAgICAgICAgZGF0YToge1xuICAgICAgICAgIHJlc2V0VG9rZW46IG51bGwsXG4gICAgICAgICAgcmVzZXRUb2tlbkV4cGlyeTogbnVsbCxcbiAgICAgICAgfSxcbiAgICAgIH0pO1xuICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFeGNlcHRpb24oJ1Jlc2V0IHRva2VuIGhhcyBleHBpcmVkJyk7XG4gICAgfVxuXG4gICAgLy8gQ2hlY2sgaWYgbmV3IHBhc3N3b3JkIGlzIGRpZmZlcmVudCBmcm9tIGN1cnJlbnQgKGlmIHVzZXIgaGFzIG9uZSlcbiAgICBpZiAodXNlci5wYXNzd29yZCkge1xuICAgICAgY29uc3QgaXNTYW1lUGFzc3dvcmQgPSBhd2FpdCB0aGlzLnRva2VuU2VydmljZS5jb21wYXJlUGFzc3dvcmQoXG4gICAgICAgIG5ld1Bhc3N3b3JkLFxuICAgICAgICB1c2VyLnBhc3N3b3JkLFxuICAgICAgKTtcbiAgICAgIGlmIChpc1NhbWVQYXNzd29yZCkge1xuICAgICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdEV4Y2VwdGlvbihcbiAgICAgICAgICAnTmV3IHBhc3N3b3JkIG11c3QgYmUgZGlmZmVyZW50IGZyb20gY3VycmVudCBwYXNzd29yZCcsXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gSGFzaCBuZXcgcGFzc3dvcmRcbiAgICBjb25zdCBoYXNoZWRQYXNzd29yZCA9IGF3YWl0IHRoaXMudG9rZW5TZXJ2aWNlLmhhc2hQYXNzd29yZChuZXdQYXNzd29yZCk7XG5cbiAgICAvLyBVcGRhdGUgcGFzc3dvcmQgYW5kIGNsZWFyIHJlc2V0IHRva2VuXG4gICAgYXdhaXQgdGhpcy5wcmlzbWEudXNlci51cGRhdGUoe1xuICAgICAgd2hlcmU6IHsgaWQ6IHVzZXIuaWQgfSxcbiAgICAgIGRhdGE6IHtcbiAgICAgICAgcGFzc3dvcmQ6IGhhc2hlZFBhc3N3b3JkLFxuICAgICAgICByZXNldFRva2VuOiBudWxsLFxuICAgICAgICByZXNldFRva2VuRXhwaXJ5OiBudWxsLFxuICAgICAgICBmYWlsZWRMb2dpbkNvdW50OiAwLCAvLyBSZXNldCBmYWlsZWQgbG9naW4gYXR0ZW1wdHNcbiAgICAgICAgbG9ja291dFVudGlsOiBudWxsLCAvLyBDbGVhciBhbnkgbG9ja291dFxuICAgICAgfSxcbiAgICB9KTtcblxuICAgIC8vIFNpbXBsZSBsb2dvdXQgZm9yIHNlY3VyaXR5IGFmdGVyIHBhc3N3b3JkIHJlc2V0XG4gICAgYXdhaXQgdGhpcy50b2tlblNlcnZpY2UubG9nb3V0KHVzZXIuaWQpO1xuXG4gICAgLy8gU2VuZCBjb25maXJtYXRpb24gZW1haWxcbiAgICBhd2FpdCB0aGlzLnNlbmRQYXNzd29yZFJlc2V0Q29uZmlybWF0aW9uRW1haWwodXNlci5lbWFpbCk7XG5cbiAgICByZXR1cm4ge1xuICAgICAgc3VjY2VzczogdHJ1ZSxcbiAgICAgIG1lc3NhZ2U6ICdQYXNzd29yZCByZXNldCBzdWNjZXNzZnVsbHknLFxuICAgIH07XG4gIH1cblxuICBhc3luYyB2YWxpZGF0ZVJlc2V0VG9rZW4oXG4gICAgdG9rZW46IHN0cmluZyxcbiAgKTogUHJvbWlzZTx7IHZhbGlkOiBib29sZWFuOyBlbWFpbD86IHN0cmluZyB9PiB7XG4gICAgaWYgKCF0b2tlbikge1xuICAgICAgcmV0dXJuIHsgdmFsaWQ6IGZhbHNlIH07XG4gICAgfVxuXG4gICAgY29uc3QgaGFzaGVkVG9rZW4gPSBjcnlwdG8uY3JlYXRlSGFzaCgnc2hhMjU2JykudXBkYXRlKHRva2VuKS5kaWdlc3QoJ2hleCcpO1xuXG4gICAgY29uc3QgdXNlciA9IGF3YWl0IHRoaXMucHJpc21hLnVzZXIuZmluZFVuaXF1ZSh7XG4gICAgICB3aGVyZTogeyByZXNldFRva2VuOiBoYXNoZWRUb2tlbiB9LFxuICAgICAgc2VsZWN0OiB7XG4gICAgICAgIGVtYWlsOiB0cnVlLFxuICAgICAgICByZXNldFRva2VuRXhwaXJ5OiB0cnVlLFxuICAgICAgICBkZWFjdGl2YXRlZEF0OiB0cnVlLFxuICAgICAgfSxcbiAgICB9KTtcblxuICAgIGlmICghdXNlciB8fCB1c2VyLmRlYWN0aXZhdGVkQXQpIHtcbiAgICAgIHJldHVybiB7IHZhbGlkOiBmYWxzZSB9O1xuICAgIH1cblxuICAgIGlmICghdXNlci5yZXNldFRva2VuRXhwaXJ5IHx8IHVzZXIucmVzZXRUb2tlbkV4cGlyeSA8IG5ldyBEYXRlKCkpIHtcbiAgICAgIHJldHVybiB7IHZhbGlkOiBmYWxzZSB9O1xuICAgIH1cblxuICAgIHJldHVybiB7XG4gICAgICB2YWxpZDogdHJ1ZSxcbiAgICAgIGVtYWlsOiB1c2VyLmVtYWlsLFxuICAgIH07XG4gIH1cblxuICBwcml2YXRlIHZhbGlkYXRlUGFzc3dvcmRTdHJlbmd0aChwYXNzd29yZDogc3RyaW5nKTogdm9pZCB7XG4gICAgY29uc3QgbWluTGVuZ3RoID0gcGFyc2VJbnQocHJvY2Vzcy5lbnYuTUlOX1BBU1NXT1JEX0xFTkdUSCB8fCAnOCcpO1xuXG4gICAgaWYgKHBhc3N3b3JkLmxlbmd0aCA8IG1pbkxlbmd0aCkge1xuICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFeGNlcHRpb24oXG4gICAgICAgIGBQYXNzd29yZCBtdXN0IGJlIGF0IGxlYXN0ICR7bWluTGVuZ3RofSBjaGFyYWN0ZXJzIGxvbmdgLFxuICAgICAgKTtcbiAgICB9XG5cbiAgICAvLyBDaGVjayBmb3IgYXQgbGVhc3Qgb25lIHVwcGVyY2FzZSBsZXR0ZXJcbiAgICBpZiAoIS9bQS1aXS8udGVzdChwYXNzd29yZCkpIHtcbiAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0RXhjZXB0aW9uKFxuICAgICAgICAnUGFzc3dvcmQgbXVzdCBjb250YWluIGF0IGxlYXN0IG9uZSB1cHBlcmNhc2UgbGV0dGVyJyxcbiAgICAgICk7XG4gICAgfVxuXG4gICAgLy8gQ2hlY2sgZm9yIGF0IGxlYXN0IG9uZSBsb3dlcmNhc2UgbGV0dGVyXG4gICAgaWYgKCEvW2Etel0vLnRlc3QocGFzc3dvcmQpKSB7XG4gICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdEV4Y2VwdGlvbihcbiAgICAgICAgJ1Bhc3N3b3JkIG11c3QgY29udGFpbiBhdCBsZWFzdCBvbmUgbG93ZXJjYXNlIGxldHRlcicsXG4gICAgICApO1xuICAgIH1cblxuICAgIC8vIENoZWNrIGZvciBhdCBsZWFzdCBvbmUgbnVtYmVyXG4gICAgaWYgKCEvXFxkLy50ZXN0KHBhc3N3b3JkKSkge1xuICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFeGNlcHRpb24oXG4gICAgICAgICdQYXNzd29yZCBtdXN0IGNvbnRhaW4gYXQgbGVhc3Qgb25lIG51bWJlcicsXG4gICAgICApO1xuICAgIH1cblxuICAgIC8vIENoZWNrIGZvciBhdCBsZWFzdCBvbmUgc3BlY2lhbCBjaGFyYWN0ZXJcbiAgICBpZiAoIS9bIUAjJCVeJiooKV8rXFwtPVxcW1xcXXt9Oyc6XCJcXFxcfCwuPD5cXC8/XS8udGVzdChwYXNzd29yZCkpIHtcbiAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0RXhjZXB0aW9uKFxuICAgICAgICAnUGFzc3dvcmQgbXVzdCBjb250YWluIGF0IGxlYXN0IG9uZSBzcGVjaWFsIGNoYXJhY3RlcicsXG4gICAgICApO1xuICAgIH1cblxuICAgIC8vIENoZWNrIGZvciBjb21tb24gd2VhayBwYXNzd29yZHNcbiAgICBjb25zdCBjb21tb25QYXNzd29yZHMgPSBbXG4gICAgICAncGFzc3dvcmQnLFxuICAgICAgJ3Bhc3N3b3JkMTIzJyxcbiAgICAgICcxMjM0NTYnLFxuICAgICAgJ3F3ZXJ0eScsXG4gICAgICAnYWJjMTIzJyxcbiAgICAgICdsZXRtZWluJyxcbiAgICAgICd3ZWxjb21lJyxcbiAgICAgICdtb25rZXknLFxuICAgICAgJzEyMzQ1Njc4OTAnLFxuICAgICAgJ2FkbWluJyxcbiAgICBdO1xuXG4gICAgaWYgKGNvbW1vblBhc3N3b3Jkcy5pbmNsdWRlcyhwYXNzd29yZC50b0xvd2VyQ2FzZSgpKSkge1xuICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFeGNlcHRpb24oXG4gICAgICAgICdQYXNzd29yZCBpcyB0b28gY29tbW9uLiBQbGVhc2UgY2hvb3NlIGEgbW9yZSBzZWN1cmUgcGFzc3dvcmQnLFxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIHNlbmRQYXNzd29yZFJlc2V0RW1haWwoXG4gICAgZW1haWw6IHN0cmluZyxcbiAgICBmaXJzdE5hbWU6IHN0cmluZyxcbiAgICB0b2tlbjogc3RyaW5nLFxuICApOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBjb25zdCByZXNldFVybCA9IGAke3Byb2Nlc3MuZW52LkZST05URU5EX1VSTH0vcmVzZXQtcGFzc3dvcmQ/dG9rZW49JHt0b2tlbn1gO1xuXG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGh0bWwgPSBgXG4gICAgICAgIDxkaXYgc3R5bGU9XCJmb250LWZhbWlseTogQXJpYWwsIHNhbnMtc2VyaWY7IG1heC13aWR0aDogNjAwcHg7IG1hcmdpbjogMCBhdXRvOyBwYWRkaW5nOiAyMHB4O1wiPlxuICAgICAgICAgIDxoMiBzdHlsZT1cImNvbG9yOiAjOEI1Q0Y2O1wiPlJlc2V0IFlvdXIgTWVudGFyYSBQYXNzd29yZDwvaDI+XG4gICAgICAgICAgPHA+SGVsbG8gJHtmaXJzdE5hbWV9LDwvcD5cbiAgICAgICAgICA8cD5XZSByZWNlaXZlZCBhIHJlcXVlc3QgdG8gcmVzZXQgeW91ciBwYXNzd29yZCBmb3IgeW91ciBNZW50YXJhIGFjY291bnQuIENsaWNrIHRoZSBidXR0b24gYmVsb3cgdG8gcmVzZXQgeW91ciBwYXNzd29yZC48L3A+XG4gICAgICAgICAgPGRpdiBzdHlsZT1cInRleHQtYWxpZ246IGNlbnRlcjsgbWFyZ2luOiAzMHB4IDA7XCI+XG4gICAgICAgICAgICA8YSBocmVmPVwiJHtyZXNldFVybH1cIiBzdHlsZT1cImJhY2tncm91bmQtY29sb3I6ICM4QjVDRjY7IGNvbG9yOiB3aGl0ZTsgcGFkZGluZzogMTJweCAyNHB4OyB0ZXh0LWRlY29yYXRpb246IG5vbmU7IGJvcmRlci1yYWRpdXM6IDZweDsgZGlzcGxheTogaW5saW5lLWJsb2NrO1wiPlxuICAgICAgICAgICAgICBSZXNldCBQYXNzd29yZFxuICAgICAgICAgICAgPC9hPlxuICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgIDxwPlRoaXMgbGluayB3aWxsIGV4cGlyZSBpbiAxIGhvdXIgZm9yIHNlY3VyaXR5IHJlYXNvbnMuPC9wPlxuICAgICAgICAgIDxwPklmIHlvdSBkaWRuJ3QgcmVxdWVzdCBhIHBhc3N3b3JkIHJlc2V0LCB5b3UgY2FuIHNhZmVseSBpZ25vcmUgdGhpcyBlbWFpbC4gWW91ciBwYXNzd29yZCB3aWxsIG5vdCBiZSBjaGFuZ2VkLjwvcD5cbiAgICAgICAgICA8cD5JZiB5b3UgaGF2ZSBhbnkgcXVlc3Rpb25zLCBwbGVhc2UgY29udGFjdCB1cyBhdCAke3Byb2Nlc3MuZW52LlNVUFBPUlRfRU1BSUwgfHwgJ3N1cHBvcnRAbWVudGFyYS5jb20nfTwvcD5cbiAgICAgICAgICA8aHIgc3R5bGU9XCJib3JkZXI6IG5vbmU7IGJvcmRlci10b3A6IDFweCBzb2xpZCAjZWVlOyBtYXJnaW46IDMwcHggMDtcIj5cbiAgICAgICAgICA8cCBzdHlsZT1cImNvbG9yOiAjNjY2OyBmb250LXNpemU6IDEycHg7XCI+XG4gICAgICAgICAgICBUaGlzIGlzIGFuIGF1dG9tYXRlZCBtZXNzYWdlIGZyb20gTWVudGFyYS4gUGxlYXNlIGRvIG5vdCByZXBseSB0byB0aGlzIGVtYWlsLlxuICAgICAgICAgIDwvcD5cbiAgICAgICAgPC9kaXY+XG4gICAgICBgO1xuXG4gICAgICBhd2FpdCB0aGlzLmVtYWlsU2VydmljZS5zZW5kUGFzc3dvcmRSZXNldChcbiAgICAgICAgZW1haWwsXG4gICAgICAgIGZpcnN0TmFtZSxcbiAgICAgICAgJ1Jlc2V0IFlvdXIgTWVudGFyYSBQYXNzd29yZCcsXG4gICAgICAgIHJlc2V0VXJsXG4gICAgICApO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBjb25zb2xlLmVycm9yKCdGYWlsZWQgdG8gc2VuZCBwYXNzd29yZCByZXNldCBlbWFpbDonLCBlcnJvcik7XG4gICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdEV4Y2VwdGlvbignRmFpbGVkIHRvIHNlbmQgcGFzc3dvcmQgcmVzZXQgZW1haWwnKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIHNlbmRQYXNzd29yZFJlc2V0Q29uZmlybWF0aW9uRW1haWwoXG4gICAgZW1haWw6IHN0cmluZyxcbiAgKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGh0bWwgPSBgXG4gICAgICAgIDxkaXYgc3R5bGU9XCJmb250LWZhbWlseTogQXJpYWwsIHNhbnMtc2VyaWY7IG1heC13aWR0aDogNjAwcHg7IG1hcmdpbjogMCBhdXRvOyBwYWRkaW5nOiAyMHB4O1wiPlxuICAgICAgICAgIDxoMiBzdHlsZT1cImNvbG9yOiAjMTBCOTgxO1wiPlBhc3N3b3JkIFJlc2V0IFN1Y2Nlc3NmdWw8L2gyPlxuICAgICAgICAgIDxwPllvdXIgcGFzc3dvcmQgaGFzIGJlZW4gc3VjY2Vzc2Z1bGx5IHJlc2V0IGZvciB5b3VyIE1lbnRhcmEgYWNjb3VudC48L3A+XG4gICAgICAgICAgPHA+SWYgeW91IGRpZG4ndCBtYWtlIHRoaXMgY2hhbmdlLCBwbGVhc2UgY29udGFjdCBvdXIgc3VwcG9ydCB0ZWFtIGltbWVkaWF0ZWx5IGF0ICR7cHJvY2Vzcy5lbnYuU1VQUE9SVF9FTUFJTCB8fCAnc3VwcG9ydEBtZW50YXJhLmNvbSd9LjwvcD5cbiAgICAgICAgICA8ZGl2IHN0eWxlPVwidGV4dC1hbGlnbjogY2VudGVyOyBtYXJnaW46IDMwcHggMDtcIj5cbiAgICAgICAgICAgIDxhIGhyZWY9XCIke3Byb2Nlc3MuZW52LkZST05URU5EX1VSTH0vbG9naW5cIiBzdHlsZT1cImJhY2tncm91bmQtY29sb3I6ICM4QjVDRjY7IGNvbG9yOiB3aGl0ZTsgcGFkZGluZzogMTJweCAyNHB4OyB0ZXh0LWRlY29yYXRpb246IG5vbmU7IGJvcmRlci1yYWRpdXM6IDZweDsgZGlzcGxheTogaW5saW5lLWJsb2NrO1wiPlxuICAgICAgICAgICAgICBMb2dpbiB0byBZb3VyIEFjY291bnRcbiAgICAgICAgICAgIDwvYT5cbiAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICA8aHIgc3R5bGU9XCJib3JkZXI6IG5vbmU7IGJvcmRlci10b3A6IDFweCBzb2xpZCAjZWVlOyBtYXJnaW46IDMwcHggMDtcIj5cbiAgICAgICAgICA8cCBzdHlsZT1cImNvbG9yOiAjNjY2OyBmb250LXNpemU6IDEycHg7XCI+XG4gICAgICAgICAgICBUaGlzIGlzIGFuIGF1dG9tYXRlZCBtZXNzYWdlIGZyb20gTWVudGFyYS4gUGxlYXNlIGRvIG5vdCByZXBseSB0byB0aGlzIGVtYWlsLlxuICAgICAgICAgIDwvcD5cbiAgICAgICAgPC9kaXY+XG4gICAgICBgO1xuXG4gICAgICBhd2FpdCB0aGlzLmVtYWlsU2VydmljZS5zZW5kUGFzc3dvcmRSZXNldFN1Y2Nlc3MoXG4gICAgICAgIGVtYWlsLFxuICAgICAgICAnVXNlcicsXG4gICAgICAgICdQYXNzd29yZCBSZXNldCBTdWNjZXNzZnVsJ1xuICAgICAgKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc29sZS5lcnJvcignRmFpbGVkIHRvIHNlbmQgcGFzc3dvcmQgcmVzZXQgY29uZmlybWF0aW9uIGVtYWlsOicsIGVycm9yKTtcbiAgICAgIC8vIERvbid0IHRocm93IGVycm9yIGhlcmUgYXMgcGFzc3dvcmQgcmVzZXQgd2FzIHN1Y2Nlc3NmdWxcbiAgICB9XG4gIH1cblxuICBhc3luYyBjbGVhbnVwRXhwaXJlZFRva2VucygpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBhd2FpdCB0aGlzLnByaXNtYS51c2VyLnVwZGF0ZU1hbnkoe1xuICAgICAgd2hlcmU6IHtcbiAgICAgICAgcmVzZXRUb2tlbkV4cGlyeToge1xuICAgICAgICAgIGx0OiBuZXcgRGF0ZSgpLFxuICAgICAgICB9LFxuICAgICAgfSxcbiAgICAgIGRhdGE6IHtcbiAgICAgICAgcmVzZXRUb2tlbjogbnVsbCxcbiAgICAgICAgcmVzZXRUb2tlbkV4cGlyeTogbnVsbCxcbiAgICAgIH0sXG4gICAgfSk7XG4gIH1cbn1cbiJdLCJ2ZXJzaW9uIjozfQ==