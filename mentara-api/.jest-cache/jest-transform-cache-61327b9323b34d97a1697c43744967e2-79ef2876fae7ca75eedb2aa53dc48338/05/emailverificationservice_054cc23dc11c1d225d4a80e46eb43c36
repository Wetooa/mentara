ef4f52920c02aa8f6122c974b8bfb9d6
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var _a, _b, _c;
Object.defineProperty(exports, "__esModule", { value: true });
exports.EmailVerificationService = void 0;
const common_1 = require("@nestjs/common");
const prisma_client_provider_1 = require("../../providers/prisma-client.provider");
const email_service_1 = require("../../services/email.service");
const token_service_1 = require("./token.service");
const crypto = require("crypto");
let EmailVerificationService = class EmailVerificationService {
    prisma;
    emailService;
    tokenService;
    constructor(prisma, emailService, tokenService) {
        this.prisma = prisma;
        this.emailService = emailService;
        this.tokenService = tokenService;
    }
    async sendVerificationEmail(userId) {
        const user = await this.prisma.user.findUnique({
            where: { id: userId },
            select: {
                id: true,
                email: true,
                firstName: true,
                emailVerified: true,
                emailVerifyToken: true,
                emailVerifyTokenExp: true,
            },
        });
        if (!user) {
            throw new common_1.NotFoundException('User not found');
        }
        if (user.emailVerified) {
            throw new common_1.BadRequestException('Email already verified');
        }
        // Check if there's an existing valid token
        if (user.emailVerifyToken &&
            user.emailVerifyTokenExp &&
            user.emailVerifyTokenExp > new Date()) {
            // Resend existing token (rate limiting would be handled at controller level)
            await this.sendVerificationEmailWithToken(user.email, user.firstName, user.emailVerifyToken);
            return;
        }
        // Generate new verification token
        const { token, hashedToken, expiresAt } = await this.tokenService.generateEmailVerificationToken();
        // Update user with new token
        await this.prisma.user.update({
            where: { id: userId },
            data: {
                emailVerifyToken: hashedToken,
                emailVerifyTokenExp: expiresAt,
            },
        });
        // Send verification email
        await this.sendVerificationEmailWithToken(user.email, user.firstName, token);
    }
    async verifyEmail(token) {
        if (!token) {
            throw new common_1.BadRequestException('Verification token is required');
        }
        const hashedToken = crypto.createHash('sha256').update(token).digest('hex');
        const user = await this.prisma.user.findUnique({
            where: { emailVerifyToken: hashedToken },
            select: {
                id: true,
                email: true,
                emailVerified: true,
                emailVerifyTokenExp: true,
            },
        });
        if (!user) {
            throw new common_1.BadRequestException('Invalid verification token');
        }
        if (user.emailVerified) {
            return {
                success: true,
                message: 'Email already verified',
            };
        }
        if (!user.emailVerifyTokenExp || user.emailVerifyTokenExp < new Date()) {
            // Clean up expired token
            await this.prisma.user.update({
                where: { id: user.id },
                data: {
                    emailVerifyToken: null,
                    emailVerifyTokenExp: null,
                },
            });
            throw new common_1.BadRequestException('Verification token has expired');
        }
        // Verify the email
        await this.prisma.user.update({
            where: { id: user.id },
            data: {
                emailVerified: true,
                emailVerifyToken: null,
                emailVerifyTokenExp: null,
                isVerified: true, // Update general verification status
            },
        });
        return {
            success: true,
            message: 'Email verified successfully',
        };
    }
    async resendVerificationEmail(email) {
        const user = await this.prisma.user.findUnique({
            where: { email },
            select: {
                id: true,
                email: true,
                firstName: true,
                emailVerified: true,
            },
        });
        if (!user) {
            // Don't reveal if email exists for security
            return;
        }
        if (user.emailVerified) {
            throw new common_1.BadRequestException('Email already verified');
        }
        await this.sendVerificationEmail(user.id);
    }
    async sendVerificationEmailWithToken(email, firstName, token) {
        const verificationUrl = `${process.env.FRONTEND_URL}/verify-email?token=${token}`;
        try {
            await this.emailService.sendGenericEmail({
                to: email,
                subject: 'Verify Your Mentara Account',
                template: 'email-verification',
                data: {
                    firstName,
                    verificationUrl,
                    supportEmail: process.env.SUPPORT_EMAIL || 'support@mentara.com',
                },
            });
        }
        catch (error) {
            console.error('Failed to send verification email:', error);
            throw new common_1.BadRequestException('Failed to send verification email');
        }
    }
    async cleanupExpiredTokens() {
        await this.prisma.user.updateMany({
            where: {
                emailVerifyTokenExp: {
                    lt: new Date(),
                },
            },
            data: {
                emailVerifyToken: null,
                emailVerifyTokenExp: null,
            },
        });
    }
};
exports.EmailVerificationService = EmailVerificationService;
exports.EmailVerificationService = EmailVerificationService = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [typeof (_a = typeof prisma_client_provider_1.PrismaService !== "undefined" && prisma_client_provider_1.PrismaService) === "function" ? _a : Object, typeof (_b = typeof email_service_1.EmailService !== "undefined" && email_service_1.EmailService) === "function" ? _b : Object, typeof (_c = typeof token_service_1.TokenService !== "undefined" && token_service_1.TokenService) === "function" ? _c : Object])
], EmailVerificationService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL2F1dGgvc2VydmljZXMvZW1haWwtdmVyaWZpY2F0aW9uLnNlcnZpY2UudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7OztBQUFBLDJDQUl3QjtBQUN4QixtRkFBdUU7QUFDdkUsZ0VBQTREO0FBQzVELG1EQUErQztBQUMvQyxpQ0FBaUM7QUFHMUIsSUFBTSx3QkFBd0IsR0FBOUIsTUFBTSx3QkFBd0I7SUFFaEI7SUFDQTtJQUNBO0lBSG5CLFlBQ21CLE1BQXFCLEVBQ3JCLFlBQTBCLEVBQzFCLFlBQTBCO1FBRjFCLFdBQU0sR0FBTixNQUFNLENBQWU7UUFDckIsaUJBQVksR0FBWixZQUFZLENBQWM7UUFDMUIsaUJBQVksR0FBWixZQUFZLENBQWM7SUFDMUMsQ0FBQztJQUVKLEtBQUssQ0FBQyxxQkFBcUIsQ0FBQyxNQUFjO1FBQ3hDLE1BQU0sSUFBSSxHQUFHLE1BQU0sSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDO1lBQzdDLEtBQUssRUFBRSxFQUFFLEVBQUUsRUFBRSxNQUFNLEVBQUU7WUFDckIsTUFBTSxFQUFFO2dCQUNOLEVBQUUsRUFBRSxJQUFJO2dCQUNSLEtBQUssRUFBRSxJQUFJO2dCQUNYLFNBQVMsRUFBRSxJQUFJO2dCQUNmLGFBQWEsRUFBRSxJQUFJO2dCQUNuQixnQkFBZ0IsRUFBRSxJQUFJO2dCQUN0QixtQkFBbUIsRUFBRSxJQUFJO2FBQzFCO1NBQ0YsQ0FBQyxDQUFDO1FBRUgsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDO1lBQ1YsTUFBTSxJQUFJLDBCQUFpQixDQUFDLGdCQUFnQixDQUFDLENBQUM7UUFDaEQsQ0FBQztRQUVELElBQUksSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO1lBQ3ZCLE1BQU0sSUFBSSw0QkFBbUIsQ0FBQyx3QkFBd0IsQ0FBQyxDQUFDO1FBQzFELENBQUM7UUFFRCwyQ0FBMkM7UUFDM0MsSUFDRSxJQUFJLENBQUMsZ0JBQWdCO1lBQ3JCLElBQUksQ0FBQyxtQkFBbUI7WUFDeEIsSUFBSSxDQUFDLG1CQUFtQixHQUFHLElBQUksSUFBSSxFQUFFLEVBQ3JDLENBQUM7WUFDRCw2RUFBNkU7WUFDN0UsTUFBTSxJQUFJLENBQUMsOEJBQThCLENBQ3ZDLElBQUksQ0FBQyxLQUFLLEVBQ1YsSUFBSSxDQUFDLFNBQVMsRUFDZCxJQUFJLENBQUMsZ0JBQWdCLENBQ3RCLENBQUM7WUFDRixPQUFPO1FBQ1QsQ0FBQztRQUVELGtDQUFrQztRQUNsQyxNQUFNLEVBQUUsS0FBSyxFQUFFLFdBQVcsRUFBRSxTQUFTLEVBQUUsR0FDckMsTUFBTSxJQUFJLENBQUMsWUFBWSxDQUFDLDhCQUE4QixFQUFFLENBQUM7UUFFM0QsNkJBQTZCO1FBQzdCLE1BQU0sSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDO1lBQzVCLEtBQUssRUFBRSxFQUFFLEVBQUUsRUFBRSxNQUFNLEVBQUU7WUFDckIsSUFBSSxFQUFFO2dCQUNKLGdCQUFnQixFQUFFLFdBQVc7Z0JBQzdCLG1CQUFtQixFQUFFLFNBQVM7YUFDL0I7U0FDRixDQUFDLENBQUM7UUFFSCwwQkFBMEI7UUFDMUIsTUFBTSxJQUFJLENBQUMsOEJBQThCLENBQ3ZDLElBQUksQ0FBQyxLQUFLLEVBQ1YsSUFBSSxDQUFDLFNBQVMsRUFDZCxLQUFLLENBQ04sQ0FBQztJQUNKLENBQUM7SUFFRCxLQUFLLENBQUMsV0FBVyxDQUNmLEtBQWE7UUFFYixJQUFJLENBQUMsS0FBSyxFQUFFLENBQUM7WUFDWCxNQUFNLElBQUksNEJBQW1CLENBQUMsZ0NBQWdDLENBQUMsQ0FBQztRQUNsRSxDQUFDO1FBRUQsTUFBTSxXQUFXLEdBQUcsTUFBTSxDQUFDLFVBQVUsQ0FBQyxRQUFRLENBQUMsQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBRTVFLE1BQU0sSUFBSSxHQUFHLE1BQU0sSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDO1lBQzdDLEtBQUssRUFBRSxFQUFFLGdCQUFnQixFQUFFLFdBQVcsRUFBRTtZQUN4QyxNQUFNLEVBQUU7Z0JBQ04sRUFBRSxFQUFFLElBQUk7Z0JBQ1IsS0FBSyxFQUFFLElBQUk7Z0JBQ1gsYUFBYSxFQUFFLElBQUk7Z0JBQ25CLG1CQUFtQixFQUFFLElBQUk7YUFDMUI7U0FDRixDQUFDLENBQUM7UUFFSCxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUM7WUFDVixNQUFNLElBQUksNEJBQW1CLENBQUMsNEJBQTRCLENBQUMsQ0FBQztRQUM5RCxDQUFDO1FBRUQsSUFBSSxJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7WUFDdkIsT0FBTztnQkFDTCxPQUFPLEVBQUUsSUFBSTtnQkFDYixPQUFPLEVBQUUsd0JBQXdCO2FBQ2xDLENBQUM7UUFDSixDQUFDO1FBRUQsSUFBSSxDQUFDLElBQUksQ0FBQyxtQkFBbUIsSUFBSSxJQUFJLENBQUMsbUJBQW1CLEdBQUcsSUFBSSxJQUFJLEVBQUUsRUFBRSxDQUFDO1lBQ3ZFLHlCQUF5QjtZQUN6QixNQUFNLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQztnQkFDNUIsS0FBSyxFQUFFLEVBQUUsRUFBRSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7Z0JBQ3RCLElBQUksRUFBRTtvQkFDSixnQkFBZ0IsRUFBRSxJQUFJO29CQUN0QixtQkFBbUIsRUFBRSxJQUFJO2lCQUMxQjthQUNGLENBQUMsQ0FBQztZQUNILE1BQU0sSUFBSSw0QkFBbUIsQ0FBQyxnQ0FBZ0MsQ0FBQyxDQUFDO1FBQ2xFLENBQUM7UUFFRCxtQkFBbUI7UUFDbkIsTUFBTSxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUM7WUFDNUIsS0FBSyxFQUFFLEVBQUUsRUFBRSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7WUFDdEIsSUFBSSxFQUFFO2dCQUNKLGFBQWEsRUFBRSxJQUFJO2dCQUNuQixnQkFBZ0IsRUFBRSxJQUFJO2dCQUN0QixtQkFBbUIsRUFBRSxJQUFJO2dCQUN6QixVQUFVLEVBQUUsSUFBSSxFQUFFLHFDQUFxQzthQUN4RDtTQUNGLENBQUMsQ0FBQztRQUVILE9BQU87WUFDTCxPQUFPLEVBQUUsSUFBSTtZQUNiLE9BQU8sRUFBRSw2QkFBNkI7U0FDdkMsQ0FBQztJQUNKLENBQUM7SUFFRCxLQUFLLENBQUMsdUJBQXVCLENBQUMsS0FBYTtRQUN6QyxNQUFNLElBQUksR0FBRyxNQUFNLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQztZQUM3QyxLQUFLLEVBQUUsRUFBRSxLQUFLLEVBQUU7WUFDaEIsTUFBTSxFQUFFO2dCQUNOLEVBQUUsRUFBRSxJQUFJO2dCQUNSLEtBQUssRUFBRSxJQUFJO2dCQUNYLFNBQVMsRUFBRSxJQUFJO2dCQUNmLGFBQWEsRUFBRSxJQUFJO2FBQ3BCO1NBQ0YsQ0FBQyxDQUFDO1FBRUgsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDO1lBQ1YsNENBQTRDO1lBQzVDLE9BQU87UUFDVCxDQUFDO1FBRUQsSUFBSSxJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7WUFDdkIsTUFBTSxJQUFJLDRCQUFtQixDQUFDLHdCQUF3QixDQUFDLENBQUM7UUFDMUQsQ0FBQztRQUVELE1BQU0sSUFBSSxDQUFDLHFCQUFxQixDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQztJQUM1QyxDQUFDO0lBRU8sS0FBSyxDQUFDLDhCQUE4QixDQUMxQyxLQUFhLEVBQ2IsU0FBaUIsRUFDakIsS0FBYTtRQUViLE1BQU0sZUFBZSxHQUFHLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxZQUFZLHVCQUF1QixLQUFLLEVBQUUsQ0FBQztRQUVsRixJQUFJLENBQUM7WUFDSCxNQUFNLElBQUksQ0FBQyxZQUFZLENBQUMsZ0JBQWdCLENBQUM7Z0JBQ3ZDLEVBQUUsRUFBRSxLQUFLO2dCQUNULE9BQU8sRUFBRSw2QkFBNkI7Z0JBQ3RDLFFBQVEsRUFBRSxvQkFBb0I7Z0JBQzlCLElBQUksRUFBRTtvQkFDSixTQUFTO29CQUNULGVBQWU7b0JBQ2YsWUFBWSxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsYUFBYSxJQUFJLHFCQUFxQjtpQkFDakU7YUFDRixDQUFDLENBQUM7UUFDTCxDQUFDO1FBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztZQUNmLE9BQU8sQ0FBQyxLQUFLLENBQUMsb0NBQW9DLEVBQUUsS0FBSyxDQUFDLENBQUM7WUFDM0QsTUFBTSxJQUFJLDRCQUFtQixDQUFDLG1DQUFtQyxDQUFDLENBQUM7UUFDckUsQ0FBQztJQUNILENBQUM7SUFFRCxLQUFLLENBQUMsb0JBQW9CO1FBQ3hCLE1BQU0sSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDO1lBQ2hDLEtBQUssRUFBRTtnQkFDTCxtQkFBbUIsRUFBRTtvQkFDbkIsRUFBRSxFQUFFLElBQUksSUFBSSxFQUFFO2lCQUNmO2FBQ0Y7WUFDRCxJQUFJLEVBQUU7Z0JBQ0osZ0JBQWdCLEVBQUUsSUFBSTtnQkFDdEIsbUJBQW1CLEVBQUUsSUFBSTthQUMxQjtTQUNGLENBQUMsQ0FBQztJQUNMLENBQUM7Q0FDRixDQUFBO0FBdkxZLDREQUF3QjttQ0FBeEIsd0JBQXdCO0lBRHBDLElBQUEsbUJBQVUsR0FBRTt5REFHZ0Isc0NBQWEsb0JBQWIsc0NBQWEsb0RBQ1AsNEJBQVksb0JBQVosNEJBQVksb0RBQ1osNEJBQVksb0JBQVosNEJBQVk7R0FKbEMsd0JBQXdCLENBdUxwQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvaG9tZS93ZXRvb2EvRG9jdW1lbnRzL2NvZGUvcHJvamVjdHMvbWVudGFyYS9tZW50YXJhLWFwaS9zcmMvYXV0aC9zZXJ2aWNlcy9lbWFpbC12ZXJpZmljYXRpb24uc2VydmljZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBJbmplY3RhYmxlLFxuICBCYWRSZXF1ZXN0RXhjZXB0aW9uLFxuICBOb3RGb3VuZEV4Y2VwdGlvbixcbn0gZnJvbSAnQG5lc3Rqcy9jb21tb24nO1xuaW1wb3J0IHsgUHJpc21hU2VydmljZSB9IGZyb20gJy4uLy4uL3Byb3ZpZGVycy9wcmlzbWEtY2xpZW50LnByb3ZpZGVyJztcbmltcG9ydCB7IEVtYWlsU2VydmljZSB9IGZyb20gJy4uLy4uL3NlcnZpY2VzL2VtYWlsLnNlcnZpY2UnO1xuaW1wb3J0IHsgVG9rZW5TZXJ2aWNlIH0gZnJvbSAnLi90b2tlbi5zZXJ2aWNlJztcbmltcG9ydCAqIGFzIGNyeXB0byBmcm9tICdjcnlwdG8nO1xuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgRW1haWxWZXJpZmljYXRpb25TZXJ2aWNlIHtcbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSByZWFkb25seSBwcmlzbWE6IFByaXNtYVNlcnZpY2UsXG4gICAgcHJpdmF0ZSByZWFkb25seSBlbWFpbFNlcnZpY2U6IEVtYWlsU2VydmljZSxcbiAgICBwcml2YXRlIHJlYWRvbmx5IHRva2VuU2VydmljZTogVG9rZW5TZXJ2aWNlLFxuICApIHt9XG5cbiAgYXN5bmMgc2VuZFZlcmlmaWNhdGlvbkVtYWlsKHVzZXJJZDogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgY29uc3QgdXNlciA9IGF3YWl0IHRoaXMucHJpc21hLnVzZXIuZmluZFVuaXF1ZSh7XG4gICAgICB3aGVyZTogeyBpZDogdXNlcklkIH0sXG4gICAgICBzZWxlY3Q6IHtcbiAgICAgICAgaWQ6IHRydWUsXG4gICAgICAgIGVtYWlsOiB0cnVlLFxuICAgICAgICBmaXJzdE5hbWU6IHRydWUsXG4gICAgICAgIGVtYWlsVmVyaWZpZWQ6IHRydWUsXG4gICAgICAgIGVtYWlsVmVyaWZ5VG9rZW46IHRydWUsXG4gICAgICAgIGVtYWlsVmVyaWZ5VG9rZW5FeHA6IHRydWUsXG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgaWYgKCF1c2VyKSB7XG4gICAgICB0aHJvdyBuZXcgTm90Rm91bmRFeGNlcHRpb24oJ1VzZXIgbm90IGZvdW5kJyk7XG4gICAgfVxuXG4gICAgaWYgKHVzZXIuZW1haWxWZXJpZmllZCkge1xuICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFeGNlcHRpb24oJ0VtYWlsIGFscmVhZHkgdmVyaWZpZWQnKTtcbiAgICB9XG5cbiAgICAvLyBDaGVjayBpZiB0aGVyZSdzIGFuIGV4aXN0aW5nIHZhbGlkIHRva2VuXG4gICAgaWYgKFxuICAgICAgdXNlci5lbWFpbFZlcmlmeVRva2VuICYmXG4gICAgICB1c2VyLmVtYWlsVmVyaWZ5VG9rZW5FeHAgJiZcbiAgICAgIHVzZXIuZW1haWxWZXJpZnlUb2tlbkV4cCA+IG5ldyBEYXRlKClcbiAgICApIHtcbiAgICAgIC8vIFJlc2VuZCBleGlzdGluZyB0b2tlbiAocmF0ZSBsaW1pdGluZyB3b3VsZCBiZSBoYW5kbGVkIGF0IGNvbnRyb2xsZXIgbGV2ZWwpXG4gICAgICBhd2FpdCB0aGlzLnNlbmRWZXJpZmljYXRpb25FbWFpbFdpdGhUb2tlbihcbiAgICAgICAgdXNlci5lbWFpbCxcbiAgICAgICAgdXNlci5maXJzdE5hbWUsXG4gICAgICAgIHVzZXIuZW1haWxWZXJpZnlUb2tlbixcbiAgICAgICk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgLy8gR2VuZXJhdGUgbmV3IHZlcmlmaWNhdGlvbiB0b2tlblxuICAgIGNvbnN0IHsgdG9rZW4sIGhhc2hlZFRva2VuLCBleHBpcmVzQXQgfSA9XG4gICAgICBhd2FpdCB0aGlzLnRva2VuU2VydmljZS5nZW5lcmF0ZUVtYWlsVmVyaWZpY2F0aW9uVG9rZW4oKTtcblxuICAgIC8vIFVwZGF0ZSB1c2VyIHdpdGggbmV3IHRva2VuXG4gICAgYXdhaXQgdGhpcy5wcmlzbWEudXNlci51cGRhdGUoe1xuICAgICAgd2hlcmU6IHsgaWQ6IHVzZXJJZCB9LFxuICAgICAgZGF0YToge1xuICAgICAgICBlbWFpbFZlcmlmeVRva2VuOiBoYXNoZWRUb2tlbixcbiAgICAgICAgZW1haWxWZXJpZnlUb2tlbkV4cDogZXhwaXJlc0F0LFxuICAgICAgfSxcbiAgICB9KTtcblxuICAgIC8vIFNlbmQgdmVyaWZpY2F0aW9uIGVtYWlsXG4gICAgYXdhaXQgdGhpcy5zZW5kVmVyaWZpY2F0aW9uRW1haWxXaXRoVG9rZW4oXG4gICAgICB1c2VyLmVtYWlsLFxuICAgICAgdXNlci5maXJzdE5hbWUsXG4gICAgICB0b2tlbixcbiAgICApO1xuICB9XG5cbiAgYXN5bmMgdmVyaWZ5RW1haWwoXG4gICAgdG9rZW46IHN0cmluZyxcbiAgKTogUHJvbWlzZTx7IHN1Y2Nlc3M6IGJvb2xlYW47IG1lc3NhZ2U6IHN0cmluZyB9PiB7XG4gICAgaWYgKCF0b2tlbikge1xuICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFeGNlcHRpb24oJ1ZlcmlmaWNhdGlvbiB0b2tlbiBpcyByZXF1aXJlZCcpO1xuICAgIH1cblxuICAgIGNvbnN0IGhhc2hlZFRva2VuID0gY3J5cHRvLmNyZWF0ZUhhc2goJ3NoYTI1NicpLnVwZGF0ZSh0b2tlbikuZGlnZXN0KCdoZXgnKTtcblxuICAgIGNvbnN0IHVzZXIgPSBhd2FpdCB0aGlzLnByaXNtYS51c2VyLmZpbmRVbmlxdWUoe1xuICAgICAgd2hlcmU6IHsgZW1haWxWZXJpZnlUb2tlbjogaGFzaGVkVG9rZW4gfSxcbiAgICAgIHNlbGVjdDoge1xuICAgICAgICBpZDogdHJ1ZSxcbiAgICAgICAgZW1haWw6IHRydWUsXG4gICAgICAgIGVtYWlsVmVyaWZpZWQ6IHRydWUsXG4gICAgICAgIGVtYWlsVmVyaWZ5VG9rZW5FeHA6IHRydWUsXG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgaWYgKCF1c2VyKSB7XG4gICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdEV4Y2VwdGlvbignSW52YWxpZCB2ZXJpZmljYXRpb24gdG9rZW4nKTtcbiAgICB9XG5cbiAgICBpZiAodXNlci5lbWFpbFZlcmlmaWVkKSB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgICBtZXNzYWdlOiAnRW1haWwgYWxyZWFkeSB2ZXJpZmllZCcsXG4gICAgICB9O1xuICAgIH1cblxuICAgIGlmICghdXNlci5lbWFpbFZlcmlmeVRva2VuRXhwIHx8IHVzZXIuZW1haWxWZXJpZnlUb2tlbkV4cCA8IG5ldyBEYXRlKCkpIHtcbiAgICAgIC8vIENsZWFuIHVwIGV4cGlyZWQgdG9rZW5cbiAgICAgIGF3YWl0IHRoaXMucHJpc21hLnVzZXIudXBkYXRlKHtcbiAgICAgICAgd2hlcmU6IHsgaWQ6IHVzZXIuaWQgfSxcbiAgICAgICAgZGF0YToge1xuICAgICAgICAgIGVtYWlsVmVyaWZ5VG9rZW46IG51bGwsXG4gICAgICAgICAgZW1haWxWZXJpZnlUb2tlbkV4cDogbnVsbCxcbiAgICAgICAgfSxcbiAgICAgIH0pO1xuICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFeGNlcHRpb24oJ1ZlcmlmaWNhdGlvbiB0b2tlbiBoYXMgZXhwaXJlZCcpO1xuICAgIH1cblxuICAgIC8vIFZlcmlmeSB0aGUgZW1haWxcbiAgICBhd2FpdCB0aGlzLnByaXNtYS51c2VyLnVwZGF0ZSh7XG4gICAgICB3aGVyZTogeyBpZDogdXNlci5pZCB9LFxuICAgICAgZGF0YToge1xuICAgICAgICBlbWFpbFZlcmlmaWVkOiB0cnVlLFxuICAgICAgICBlbWFpbFZlcmlmeVRva2VuOiBudWxsLFxuICAgICAgICBlbWFpbFZlcmlmeVRva2VuRXhwOiBudWxsLFxuICAgICAgICBpc1ZlcmlmaWVkOiB0cnVlLCAvLyBVcGRhdGUgZ2VuZXJhbCB2ZXJpZmljYXRpb24gc3RhdHVzXG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICBtZXNzYWdlOiAnRW1haWwgdmVyaWZpZWQgc3VjY2Vzc2Z1bGx5JyxcbiAgICB9O1xuICB9XG5cbiAgYXN5bmMgcmVzZW5kVmVyaWZpY2F0aW9uRW1haWwoZW1haWw6IHN0cmluZyk6IFByb21pc2U8dm9pZD4ge1xuICAgIGNvbnN0IHVzZXIgPSBhd2FpdCB0aGlzLnByaXNtYS51c2VyLmZpbmRVbmlxdWUoe1xuICAgICAgd2hlcmU6IHsgZW1haWwgfSxcbiAgICAgIHNlbGVjdDoge1xuICAgICAgICBpZDogdHJ1ZSxcbiAgICAgICAgZW1haWw6IHRydWUsXG4gICAgICAgIGZpcnN0TmFtZTogdHJ1ZSxcbiAgICAgICAgZW1haWxWZXJpZmllZDogdHJ1ZSxcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICBpZiAoIXVzZXIpIHtcbiAgICAgIC8vIERvbid0IHJldmVhbCBpZiBlbWFpbCBleGlzdHMgZm9yIHNlY3VyaXR5XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgaWYgKHVzZXIuZW1haWxWZXJpZmllZCkge1xuICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFeGNlcHRpb24oJ0VtYWlsIGFscmVhZHkgdmVyaWZpZWQnKTtcbiAgICB9XG5cbiAgICBhd2FpdCB0aGlzLnNlbmRWZXJpZmljYXRpb25FbWFpbCh1c2VyLmlkKTtcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgc2VuZFZlcmlmaWNhdGlvbkVtYWlsV2l0aFRva2VuKFxuICAgIGVtYWlsOiBzdHJpbmcsXG4gICAgZmlyc3ROYW1lOiBzdHJpbmcsXG4gICAgdG9rZW46IHN0cmluZyxcbiAgKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgY29uc3QgdmVyaWZpY2F0aW9uVXJsID0gYCR7cHJvY2Vzcy5lbnYuRlJPTlRFTkRfVVJMfS92ZXJpZnktZW1haWw/dG9rZW49JHt0b2tlbn1gO1xuXG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IHRoaXMuZW1haWxTZXJ2aWNlLnNlbmRHZW5lcmljRW1haWwoe1xuICAgICAgICB0bzogZW1haWwsXG4gICAgICAgIHN1YmplY3Q6ICdWZXJpZnkgWW91ciBNZW50YXJhIEFjY291bnQnLFxuICAgICAgICB0ZW1wbGF0ZTogJ2VtYWlsLXZlcmlmaWNhdGlvbicsXG4gICAgICAgIGRhdGE6IHtcbiAgICAgICAgICBmaXJzdE5hbWUsXG4gICAgICAgICAgdmVyaWZpY2F0aW9uVXJsLFxuICAgICAgICAgIHN1cHBvcnRFbWFpbDogcHJvY2Vzcy5lbnYuU1VQUE9SVF9FTUFJTCB8fCAnc3VwcG9ydEBtZW50YXJhLmNvbScsXG4gICAgICAgIH0sXG4gICAgICB9KTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc29sZS5lcnJvcignRmFpbGVkIHRvIHNlbmQgdmVyaWZpY2F0aW9uIGVtYWlsOicsIGVycm9yKTtcbiAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0RXhjZXB0aW9uKCdGYWlsZWQgdG8gc2VuZCB2ZXJpZmljYXRpb24gZW1haWwnKTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBjbGVhbnVwRXhwaXJlZFRva2VucygpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBhd2FpdCB0aGlzLnByaXNtYS51c2VyLnVwZGF0ZU1hbnkoe1xuICAgICAgd2hlcmU6IHtcbiAgICAgICAgZW1haWxWZXJpZnlUb2tlbkV4cDoge1xuICAgICAgICAgIGx0OiBuZXcgRGF0ZSgpLFxuICAgICAgICB9LFxuICAgICAgfSxcbiAgICAgIGRhdGE6IHtcbiAgICAgICAgZW1haWxWZXJpZnlUb2tlbjogbnVsbCxcbiAgICAgICAgZW1haWxWZXJpZnlUb2tlbkV4cDogbnVsbCxcbiAgICAgIH0sXG4gICAgfSk7XG4gIH1cbn1cbiJdLCJ2ZXJzaW9uIjozfQ==