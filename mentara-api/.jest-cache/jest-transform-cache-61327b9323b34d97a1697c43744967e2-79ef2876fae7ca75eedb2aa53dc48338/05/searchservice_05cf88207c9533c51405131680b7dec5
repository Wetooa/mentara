e152b5d8c9e3e5e1b434991f554b1277
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
exports.SearchService = void 0;
const common_1 = require("@nestjs/common");
const prisma_client_provider_1 = require("../providers/prisma-client.provider");
let SearchService = class SearchService {
    prisma;
    constructor(prisma) {
        this.prisma = prisma;
    }
    async searchTherapists(query, filters) {
        try {
            const where = {
                status: 'APPROVED',
                OR: [
                    {
                        user: {
                            firstName: { contains: query, mode: 'insensitive' },
                        },
                    },
                    {
                        user: {
                            lastName: { contains: query, mode: 'insensitive' },
                        },
                    },
                    {
                        bio: { contains: query, mode: 'insensitive' },
                    },
                    {
                        expertise: { hasSome: [query] },
                    },
                ],
            };
            if (filters) {
                if (filters.province) {
                    where.province = filters.province;
                }
                if (filters.expertise && filters.expertise.length > 0) {
                    where.expertise = { hasSome: filters.expertise };
                }
                if (filters.maxHourlyRate) {
                    where.hourlyRate = { lte: filters.maxHourlyRate };
                }
                if (filters.minExperience) {
                    where.yearsOfExperience = { gte: filters.minExperience };
                }
            }
            return this.prisma.therapist.findMany({
                where,
                include: {
                    user: {
                        select: {
                            id: true,
                            firstName: true,
                            lastName: true,
                            avatarUrl: true,
                        },
                    },
                },
                orderBy: { createdAt: 'desc' },
                take: 20,
            });
        }
        catch (error) {
            throw new common_1.InternalServerErrorException(`Failed to search therapists: ${error instanceof Error ? error.message : String(error)}`);
        }
    }
    async searchPosts(query, communityId, userId) {
        try {
            const where = {
                OR: [
                    { title: { contains: query, mode: 'insensitive' } },
                    { content: { contains: query, mode: 'insensitive' } },
                    { tags: { hasSome: [query] } },
                ],
            };
            // If userId is provided, filter posts to only include those from communities the user is a member of
            if (userId) {
                where.room = {
                    roomGroup: {
                        community: {
                            memberships: {
                                some: {
                                    userId: userId,
                                },
                            },
                        },
                    },
                };
            }
            // If specific communityId is provided, further filter by that community
            if (communityId) {
                if (where.room) {
                    where.room.roomGroup.community.id = communityId;
                }
                else {
                    where.room = {
                        roomGroup: {
                            community: {
                                id: communityId,
                            },
                        },
                    };
                }
            }
            return this.prisma.post.findMany({
                where,
                include: {
                    user: {
                        select: {
                            id: true,
                            firstName: true,
                            lastName: true,
                            avatarUrl: true,
                        },
                    },
                    room: {
                        include: {
                            roomGroup: {
                                include: {
                                    community: {
                                        select: {
                                            id: true,
                                            name: true,
                                            slug: true,
                                        },
                                    },
                                },
                            },
                        },
                    },
                    _count: {
                        select: {
                            hearts: true,
                            comments: true,
                        },
                    },
                },
                orderBy: { createdAt: 'desc' },
                take: 20,
            });
        }
        catch (error) {
            throw new common_1.InternalServerErrorException(`Failed to search posts: ${error instanceof Error ? error.message : String(error)}`);
        }
    }
    async searchComments(query, communityId, userId) {
        try {
            const where = {
                content: { contains: query, mode: 'insensitive' },
            };
            // If userId is provided, filter comments to only include those from posts in communities the user is a member of
            if (userId) {
                where.post = {
                    room: {
                        roomGroup: {
                            community: {
                                memberships: {
                                    some: {
                                        userId: userId,
                                    },
                                },
                            },
                        },
                    },
                };
            }
            // If specific communityId is provided, further filter by that community
            if (communityId) {
                if (where.post) {
                    where.post.room.roomGroup.community.id = communityId;
                }
                else {
                    where.post = {
                        room: {
                            roomGroup: {
                                community: {
                                    id: communityId,
                                },
                            },
                        },
                    };
                }
            }
            return this.prisma.comment.findMany({
                where,
                include: {
                    user: {
                        select: {
                            id: true,
                            firstName: true,
                            lastName: true,
                            avatarUrl: true,
                            role: true,
                        },
                    },
                    post: {
                        select: {
                            id: true,
                            title: true,
                            userId: true,
                            room: {
                                include: {
                                    roomGroup: {
                                        include: {
                                            community: {
                                                select: {
                                                    id: true,
                                                    name: true,
                                                    slug: true,
                                                },
                                            },
                                        },
                                    },
                                },
                            },
                        },
                    },
                    _count: {
                        select: {
                            hearts: true,
                            children: true,
                        },
                    },
                },
                orderBy: { createdAt: 'desc' },
                take: 20,
            });
        }
        catch (error) {
            throw new common_1.InternalServerErrorException(`Failed to search comments: ${error instanceof Error ? error.message : String(error)}`);
        }
    }
    async searchCommunities(query) {
        try {
            return this.prisma.community.findMany({
                where: {
                    OR: [
                        { name: { contains: query, mode: 'insensitive' } },
                        { description: { contains: query, mode: 'insensitive' } },
                    ],
                },
                include: {
                    _count: {
                        select: {
                            memberships: true,
                        },
                    },
                },
                orderBy: { createdAt: 'desc' },
                take: 20,
            });
        }
        catch (error) {
            throw new common_1.InternalServerErrorException(`Failed to search communities: ${error instanceof Error ? error.message : String(error)}`);
        }
    }
    async searchUsers(query, role) {
        try {
            const where = {
                OR: [
                    { firstName: { contains: query, mode: 'insensitive' } },
                    { lastName: { contains: query, mode: 'insensitive' } },
                    { email: { contains: query, mode: 'insensitive' } },
                ],
            };
            if (role) {
                where.role = role;
            }
            return this.prisma.user.findMany({
                where,
                select: {
                    id: true,
                    firstName: true,
                    lastName: true,
                    email: true,
                    avatarUrl: true,
                    role: true,
                    createdAt: true,
                },
                orderBy: { createdAt: 'desc' },
                take: 20,
            });
        }
        catch (error) {
            throw new common_1.InternalServerErrorException(`Failed to search users: ${error instanceof Error ? error.message : String(error)}`);
        }
    }
    async searchWorksheets(query, userId, role) {
        try {
            const where = {
                OR: [
                    { title: { contains: query, mode: 'insensitive' } },
                    { instructions: { contains: query, mode: 'insensitive' } },
                ],
            };
            // Filter by user role (client can only see their own worksheets)
            if (role === 'client' && userId) {
                where.clientId = userId;
            }
            else if (role === 'therapist' && userId) {
                where.therapistId = userId;
            }
            return this.prisma.worksheet.findMany({
                where,
                include: {
                    client: {
                        select: {
                            userId: true,
                            user: {
                                select: {
                                    firstName: true,
                                    lastName: true,
                                    avatarUrl: true,
                                },
                            },
                        },
                    },
                    therapist: {
                        select: {
                            userId: true,
                            user: {
                                select: {
                                    firstName: true,
                                    lastName: true,
                                    avatarUrl: true,
                                },
                            },
                        },
                    },
                    submission: {
                        select: {
                            id: true,
                            submittedAt: true,
                            feedback: true,
                        },
                    },
                },
                orderBy: { createdAt: 'desc' },
                take: 20,
            });
        }
        catch (error) {
            throw new common_1.InternalServerErrorException(`Failed to search worksheets: ${error instanceof Error ? error.message : String(error)}`);
        }
    }
    async searchMessages(query, userId) {
        try {
            const whereClause = {
                AND: [
                    {
                        content: {
                            contains: query,
                            mode: 'insensitive',
                        },
                    },
                    {
                        isDeleted: false,
                    },
                    {
                        conversation: {
                            participants: {
                                some: {
                                    userId,
                                    isActive: true,
                                },
                            },
                        },
                    },
                ],
            };
            return this.prisma.message.findMany({
                where: whereClause,
                include: {
                    sender: {
                        select: {
                            id: true,
                            firstName: true,
                            lastName: true,
                            avatarUrl: true,
                        },
                    },
                    conversation: {
                        select: {
                            id: true,
                            type: true,
                            title: true,
                        },
                    },
                },
                orderBy: { createdAt: 'desc' },
                take: 20,
            });
        }
        catch (error) {
            throw new common_1.InternalServerErrorException(`Failed to search messages: ${error instanceof Error ? error.message : String(error)}`);
        }
    }
    async globalSearch(query, types, userId, userRole) {
        try {
            const results = {};
            // Default to all types if none specified
            const defaultTypes = ['therapists', 'posts', 'communities', 'users', 'worksheets', 'messages'];
            const typesArray = types && types.length > 0 ? types : defaultTypes;
            if (typesArray.includes('therapists')) {
                results.therapists = await this.searchTherapists(query);
            }
            if (typesArray.includes('posts')) {
                results.posts = await this.searchPosts(query, undefined, userId);
            }
            // Add comments search (always filtered by user communities if userId is provided)
            if (userId) {
                results.comments = await this.searchComments(query, undefined, userId);
            }
            if (typesArray.includes('communities')) {
                results.communities = await this.searchCommunities(query);
            }
            if (typesArray.includes('users')) {
                results.users = await this.searchUsers(query);
            }
            if (typesArray.includes('worksheets')) {
                // Only search worksheets if user has appropriate permissions
                if (userRole === 'client' || userRole === 'therapist') {
                    results.worksheets = await this.searchWorksheets(query, userId, userRole);
                }
                else if (userRole === 'moderator' || userRole === 'admin') {
                    // Admins and moderators can see all worksheets
                    results.worksheets = await this.searchWorksheets(query);
                }
            }
            if (typesArray.includes('messages') && userId) {
                // Messages are always private to the user
                results.messages = await this.searchMessages(query, userId);
            }
            return results;
        }
        catch (error) {
            throw new common_1.InternalServerErrorException(`Failed to perform global search: ${error instanceof Error ? error.message : String(error)}`);
        }
    }
};
exports.SearchService = SearchService;
exports.SearchService = SearchService = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [typeof (_a = typeof prisma_client_provider_1.PrismaService !== "undefined" && prisma_client_provider_1.PrismaService) === "function" ? _a : Object])
], SearchService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL3NlYXJjaC9zZWFyY2guc2VydmljZS50cyIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7O0FBQUEsMkNBQTBFO0FBQzFFLGdGQUFvRTtBQUc3RCxJQUFNLGFBQWEsR0FBbkIsTUFBTSxhQUFhO0lBQ0s7SUFBN0IsWUFBNkIsTUFBcUI7UUFBckIsV0FBTSxHQUFOLE1BQU0sQ0FBZTtJQUFHLENBQUM7SUFFdEQsS0FBSyxDQUFDLGdCQUFnQixDQUNwQixLQUFhLEVBQ2IsT0FjQztRQUVELElBQUksQ0FBQztZQUNILE1BQU0sS0FBSyxHQUFRO2dCQUNqQixNQUFNLEVBQUUsVUFBVTtnQkFDbEIsRUFBRSxFQUFFO29CQUNGO3dCQUNFLElBQUksRUFBRTs0QkFDSixTQUFTLEVBQUUsRUFBRSxRQUFRLEVBQUUsS0FBSyxFQUFFLElBQUksRUFBRSxhQUFhLEVBQUU7eUJBQ3BEO3FCQUNGO29CQUNEO3dCQUNFLElBQUksRUFBRTs0QkFDSixRQUFRLEVBQUUsRUFBRSxRQUFRLEVBQUUsS0FBSyxFQUFFLElBQUksRUFBRSxhQUFhLEVBQUU7eUJBQ25EO3FCQUNGO29CQUNEO3dCQUNFLEdBQUcsRUFBRSxFQUFFLFFBQVEsRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLGFBQWEsRUFBRTtxQkFDOUM7b0JBQ0Q7d0JBQ0UsU0FBUyxFQUFFLEVBQUUsT0FBTyxFQUFFLENBQUMsS0FBSyxDQUFDLEVBQUU7cUJBQ2hDO2lCQUNGO2FBQ0YsQ0FBQztZQUVGLElBQUksT0FBTyxFQUFFLENBQUM7Z0JBQ1osSUFBSSxPQUFPLENBQUMsUUFBUSxFQUFFLENBQUM7b0JBQ3JCLEtBQUssQ0FBQyxRQUFRLEdBQUcsT0FBTyxDQUFDLFFBQVEsQ0FBQztnQkFDcEMsQ0FBQztnQkFDRCxJQUFJLE9BQU8sQ0FBQyxTQUFTLElBQUksT0FBTyxDQUFDLFNBQVMsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFLENBQUM7b0JB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S0FBSyxDQUFDLENBQUM7Z0JBQzFELENBQUM7WUFDSCxDQUFDO1lBRUQsSUFBSSxVQUFVLENBQUMsUUFBUSxDQUFDLFVBQVUsQ0FBQyxJQUFJLE1BQU0sRUFBRSxDQUFDO2dCQUM5QywwQ0FBMEM7Z0JBQzFDLE9BQU8sQ0FBQyxRQUFRLEdBQUcsTUFBTSxJQUFJLENBQUMsY0FBYyxDQUFDLEtBQUssRUFBRSxNQUFNLENBQUMsQ0FBQztZQUM5RCxDQUFDO1lBRUQsT0FBTyxPQUFPLENBQUM7UUFDakIsQ0FBQztRQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7WUFDZixNQUFNLElBQUkscUNBQTRCLENBQ3BDLG9DQUFvQyxLQUFLLFlBQVksS0FBSyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FDN0YsQ0FBQztRQUNKLENBQUM7SUFDSCxDQUFDO0NBQ0YsQ0FBQTtBQXplWSxzQ0FBYTt3QkFBYixhQUFhO0lBRHpCLElBQUEsbUJBQVUsR0FBRTt5REFFMEIsc0NBQWEsb0JBQWIsc0NBQWE7R0FEdkMsYUFBYSxDQXllekIiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL3NlYXJjaC9zZWFyY2guc2VydmljZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlLCBJbnRlcm5hbFNlcnZlckVycm9yRXhjZXB0aW9uIH0gZnJvbSAnQG5lc3Rqcy9jb21tb24nO1xuaW1wb3J0IHsgUHJpc21hU2VydmljZSB9IGZyb20gJy4uL3Byb3ZpZGVycy9wcmlzbWEtY2xpZW50LnByb3ZpZGVyJztcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIFNlYXJjaFNlcnZpY2Uge1xuICBjb25zdHJ1Y3Rvcihwcml2YXRlIHJlYWRvbmx5IHByaXNtYTogUHJpc21hU2VydmljZSkge31cblxuICBhc3luYyBzZWFyY2hUaGVyYXBpc3RzKFxuICAgIHF1ZXJ5OiBzdHJpbmcsXG4gICAgZmlsdGVycz86IHtcbiAgICAgIHByb3ZpbmNlPzogc3RyaW5nO1xuICAgICAgbG9jYXRpb24/OiBzdHJpbmc7XG4gICAgICBleHBlcnRpc2U/OiBzdHJpbmdbXTtcbiAgICAgIHNwZWNpYWx0aWVzPzogc3RyaW5nW107XG4gICAgICBtYXhIb3VybHlSYXRlPzogbnVtYmVyO1xuICAgICAgbWluRXhwZXJpZW5jZT86IG51bWJlcjtcbiAgICAgIGV4cGVyaWVuY2VZZWFycz86IG51bWJlcjtcbiAgICAgIHJhdGluZz86IG51bWJlcjtcbiAgICAgIGdlbmRlcj86IHN0cmluZztcbiAgICAgIGxhbmd1YWdlcz86IHN0cmluZ1tdO1xuICAgICAgYXZhaWxhYmlsaXR5PzogYW55O1xuICAgICAgdmVyaWZpZWRPbmx5PzogYm9vbGVhbjtcbiAgICAgIHByaWNlUmFuZ2U/OiB7IG1pbj86IG51bWJlcjsgbWF4PzogbnVtYmVyIH07XG4gICAgfSxcbiAgKSB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHdoZXJlOiBhbnkgPSB7XG4gICAgICAgIHN0YXR1czogJ0FQUFJPVkVEJyxcbiAgICAgICAgT1I6IFtcbiAgICAgICAgICB7XG4gICAgICAgICAgICB1c2VyOiB7XG4gICAgICAgICAgICAgIGZpcnN0TmFtZTogeyBjb250YWluczogcXVlcnksIG1vZGU6ICdpbnNlbnNpdGl2ZScgfSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgICB7XG4gICAgICAgICAgICB1c2VyOiB7XG4gICAgICAgICAgICAgIGxhc3ROYW1lOiB7IGNvbnRhaW5zOiBxdWVyeSwgbW9kZTogJ2luc2Vuc2l0aXZlJyB9LFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9LFxuICAgICAgICAgIHtcbiAgICAgICAgICAgIGJpbzogeyBjb250YWluczogcXVlcnksIG1vZGU6ICdpbnNlbnNpdGl2ZScgfSxcbiAgICAgICAgICB9LFxuICAgICAgICAgIHtcbiAgICAgICAgICAgIGV4cGVydGlzZTogeyBoYXNTb21lOiBbcXVlcnldIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgXSxcbiAgICAgIH07XG5cbiAgICAgIGlmIChmaWx0ZXJzKSB7XG4gICAgICAgIGlmIChmaWx0ZXJzLnByb3ZpbmNlKSB7XG4gICAgICAgICAgd2hlcmUucHJvdmluY2UgPSBmaWx0ZXJzLnByb3ZpbmNlO1xuICAgICAgICB9XG4gICAgICAgIGlmIChmaWx0ZXJzLmV4cGVydGlzZSAmJiBmaWx0ZXJzLmV4cGVydGlzZS5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgd2hlcmUuZXhwZXJ0aXNlID0geyBoYXNTb21lOiBmaWx0ZXJzLmV4cGVydGlzZSB9O1xuICAgICAgICB9XG4gICAgICAgIGlmIChmaWx0ZXJzLm1heEhvdXJseVJhdGUpIHtcbiAgICAgICAgICB3aGVyZS5ob3VybHlSYXRlID0geyBsdGU6IGZpbHRlcnMubWF4SG91cmx5UmF0ZSB9O1xuICAgICAgICB9XG4gICAgICAgIGlmIChmaWx0ZXJzLm1pbkV4cGVyaWVuY2UpIHtcbiAgICAgICAgICB3aGVyZS55ZWFyc09mRXhwZXJpZW5jZSA9IHsgZ3RlOiBmaWx0ZXJzLm1pbkV4cGVyaWVuY2UgfTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICByZXR1cm4gdGhpcy5wcmlzbWEudGhlcmFwaXN0LmZpbmRNYW55KHtcbiAgICAgICAgd2hlcmUsXG4gICAgICAgIGluY2x1ZGU6IHtcbiAgICAgICAgICB1c2VyOiB7XG4gICAgICAgICAgICBzZWxlY3Q6IHtcbiAgICAgICAgICAgICAgaWQ6IHRydWUsXG4gICAgICAgICAgICAgIGZpcnN0TmFtZTogdHJ1ZSxcbiAgICAgICAgICAgICAgbGFzdE5hbWU6IHRydWUsXG4gICAgICAgICAgICAgIGF2YXRhclVybDogdHJ1ZSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgICAgb3JkZXJCeTogeyBjcmVhdGVkQXQ6ICdkZXNjJyB9LFxuICAgICAgICB0YWtlOiAyMCxcbiAgICAgIH0pO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aHJvdyBuZXcgSW50ZXJuYWxTZXJ2ZXJFcnJvckV4Y2VwdGlvbihcbiAgICAgICAgYEZhaWxlZCB0byBzZWFyY2ggdGhlcmFwaXN0czogJHtlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6IFN0cmluZyhlcnJvcil9YCxcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgc2VhcmNoUG9zdHMocXVlcnk6IHN0cmluZywgY29tbXVuaXR5SWQ/OiBzdHJpbmcsIHVzZXJJZD86IHN0cmluZykge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCB3aGVyZTogYW55ID0ge1xuICAgICAgICBPUjogW1xuICAgICAgICAgIHsgdGl0bGU6IHsgY29udGFpbnM6IHF1ZXJ5LCBtb2RlOiAnaW5zZW5zaXRpdmUnIH0gfSxcbiAgICAgICAgICB7IGNvbnRlbnQ6IHsgY29udGFpbnM6IHF1ZXJ5LCBtb2RlOiAnaW5zZW5zaXRpdmUnIH0gfSxcbiAgICAgICAgICB7IHRhZ3M6IHsgaGFzU29tZTogW3F1ZXJ5XSB9IH0sXG4gICAgICAgIF0sXG4gICAgICB9O1xuXG4gICAgICAvLyBJZiB1c2VySWQgaXMgcHJvdmlkZWQsIGZpbHRlciBwb3N0cyB0byBvbmx5IGluY2x1ZGUgdGhvc2UgZnJvbSBjb21tdW5pdGllcyB0aGUgdXNlciBpcyBhIG1lbWJlciBvZlxuICAgICAgaWYgKHVzZXJJZCkge1xuICAgICAgICB3aGVyZS5yb29tID0ge1xuICAgICAgICAgIHJvb21Hcm91cDoge1xuICAgICAgICAgICAgY29tbXVuaXR5OiB7XG4gICAgICAgICAgICAgIG1lbWJlcnNoaXBzOiB7XG4gICAgICAgICAgICAgICAgc29tZToge1xuICAgICAgICAgICAgICAgICAgdXNlcklkOiB1c2VySWQsXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgfTtcbiAgICAgIH1cblxuICAgICAgLy8gSWYgc3BlY2lmaWMgY29tbXVuaXR5SWQgaXMgcHJvdmlkZWQsIGZ1cnRoZXIgZmlsdGVyIGJ5IHRoYXQgY29tbXVuaXR5XG4gICAgICBpZiAoY29tbXVuaXR5SWQpIHtcbiAgICAgICAgaWYgKHdoZXJlLnJvb20pIHtcbiAgICAgICAgICB3aGVyZS5yb29tLnJvb21Hcm91cC5jb21tdW5pdHkuaWQgPSBjb21tdW5pdHlJZDtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB3aGVyZS5yb29tID0ge1xuICAgICAgICAgICAgcm9vbUdyb3VwOiB7XG4gICAgICAgICAgICAgIGNvbW11bml0eToge1xuICAgICAgICAgICAgICAgIGlkOiBjb21tdW5pdHlJZCxcbiAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICByZXR1cm4gdGhpcy5wcmlzbWEucG9zdC5maW5kTWFueSh7XG4gICAgICAgIHdoZXJlLFxuICAgICAgICBpbmNsdWRlOiB7XG4gICAgICAgICAgdXNlcjoge1xuICAgICAgICAgICAgc2VsZWN0OiB7XG4gICAgICAgICAgICAgIGlkOiB0cnVlLFxuICAgICAgICAgICAgICBmaXJzdE5hbWU6IHRydWUsXG4gICAgICAgICAgICAgIGxhc3ROYW1lOiB0cnVlLFxuICAgICAgICAgICAgICBhdmF0YXJVcmw6IHRydWUsXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0sXG4gICAgICAgICAgcm9vbToge1xuICAgICAgICAgICAgaW5jbHVkZToge1xuICAgICAgICAgICAgICByb29tR3JvdXA6IHtcbiAgICAgICAgICAgICAgICBpbmNsdWRlOiB7XG4gICAgICAgICAgICAgICAgICBjb21tdW5pdHk6IHtcbiAgICAgICAgICAgICAgICAgICAgc2VsZWN0OiB7XG4gICAgICAgICAgICAgICAgICAgICAgaWQ6IHRydWUsXG4gICAgICAgICAgICAgICAgICAgICAgbmFtZTogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgICAgICBzbHVnOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9LFxuICAgICAgICAgIF9jb3VudDoge1xuICAgICAgICAgICAgc2VsZWN0OiB7XG4gICAgICAgICAgICAgIGhlYXJ0czogdHJ1ZSxcbiAgICAgICAgICAgICAgY29tbWVudHM6IHRydWUsXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICAgIG9yZGVyQnk6IHsgY3JlYXRlZEF0OiAnZGVzYycgfSxcbiAgICAgICAgdGFrZTogMjAsXG4gICAgICB9KTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhyb3cgbmV3IEludGVybmFsU2VydmVyRXJyb3JFeGNlcHRpb24oXG4gICAgICAgIGBGYWlsZWQgdG8gc2VhcmNoIHBvc3RzOiAke2Vycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogU3RyaW5nKGVycm9yKX1gLFxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBzZWFyY2hDb21tZW50cyhxdWVyeTogc3RyaW5nLCBjb21tdW5pdHlJZD86IHN0cmluZywgdXNlcklkPzogc3RyaW5nKSB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHdoZXJlOiBhbnkgPSB7XG4gICAgICAgIGNvbnRlbnQ6IHsgY29udGFpbnM6IHF1ZXJ5LCBtb2RlOiAnaW5zZW5zaXRpdmUnIH0sXG4gICAgICB9O1xuXG4gICAgICAvLyBJZiB1c2VySWQgaXMgcHJvdmlkZWQsIGZpbHRlciBjb21tZW50cyB0byBvbmx5IGluY2x1ZGUgdGhvc2UgZnJvbSBwb3N0cyBpbiBjb21tdW5pdGllcyB0aGUgdXNlciBpcyBhIG1lbWJlciBvZlxuICAgICAgaWYgKHVzZXJJZCkge1xuICAgICAgICB3aGVyZS5wb3N0ID0ge1xuICAgICAgICAgIHJvb206IHtcbiAgICAgICAgICAgIHJvb21Hcm91cDoge1xuICAgICAgICAgICAgICBjb21tdW5pdHk6IHtcbiAgICAgICAgICAgICAgICBtZW1iZXJzaGlwczoge1xuICAgICAgICAgICAgICAgICAgc29tZToge1xuICAgICAgICAgICAgICAgICAgICB1c2VySWQ6IHVzZXJJZCxcbiAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgfTtcbiAgICAgIH1cblxuICAgICAgLy8gSWYgc3BlY2lmaWMgY29tbXVuaXR5SWQgaXMgcHJvdmlkZWQsIGZ1cnRoZXIgZmlsdGVyIGJ5IHRoYXQgY29tbXVuaXR5XG4gICAgICBpZiAoY29tbXVuaXR5SWQpIHtcbiAgICAgICAgaWYgKHdoZXJlLnBvc3QpIHtcbiAgICAgICAgICB3aGVyZS5wb3N0LnJvb20ucm9vbUdyb3VwLmNvbW11bml0eS5pZCA9IGNvbW11bml0eUlkO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHdoZXJlLnBvc3QgPSB7XG4gICAgICAgICAgICByb29tOiB7XG4gICAgICAgICAgICAgIHJvb21Hcm91cDoge1xuICAgICAgICAgICAgICAgIGNvbW11bml0eToge1xuICAgICAgICAgICAgICAgICAgaWQ6IGNvbW11bml0eUlkLFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH07XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHRoaXMucHJpc21hLmNvbW1lbnQuZmluZE1hbnkoe1xuICAgICAgICB3aGVyZSxcbiAgICAgICAgaW5jbHVkZToge1xuICAgICAgICAgIHVzZXI6IHtcbiAgICAgICAgICAgIHNlbGVjdDoge1xuICAgICAgICAgICAgICBpZDogdHJ1ZSxcbiAgICAgICAgICAgICAgZmlyc3ROYW1lOiB0cnVlLFxuICAgICAgICAgICAgICBsYXN0TmFtZTogdHJ1ZSxcbiAgICAgICAgICAgICAgYXZhdGFyVXJsOiB0cnVlLFxuICAgICAgICAgICAgICByb2xlOiB0cnVlLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9LFxuICAgICAgICAgIHBvc3Q6IHtcbiAgICAgICAgICAgIHNlbGVjdDoge1xuICAgICAgICAgICAgICBpZDogdHJ1ZSxcbiAgICAgICAgICAgICAgdGl0bGU6IHRydWUsXG4gICAgICAgICAgICAgIHVzZXJJZDogdHJ1ZSxcbiAgICAgICAgICAgICAgcm9vbToge1xuICAgICAgICAgICAgICAgIGluY2x1ZGU6IHtcbiAgICAgICAgICAgICAgICAgIHJvb21Hcm91cDoge1xuICAgICAgICAgICAgICAgICAgICBpbmNsdWRlOiB7XG4gICAgICAgICAgICAgICAgICAgICAgY29tbXVuaXR5OiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzZWxlY3Q6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgaWQ6IHRydWUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWU6IHRydWUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgIHNsdWc6IHRydWUsXG4gICAgICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0sXG4gICAgICAgICAgX2NvdW50OiB7XG4gICAgICAgICAgICBzZWxlY3Q6IHtcbiAgICAgICAgICAgICAgaGVhcnRzOiB0cnVlLFxuICAgICAgICAgICAgICBjaGlsZHJlbjogdHJ1ZSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgICAgb3JkZXJCeTogeyBjcmVhdGVkQXQ6ICdkZXNjJyB9LFxuICAgICAgICB0YWtlOiAyMCxcbiAgICAgIH0pO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aHJvdyBuZXcgSW50ZXJuYWxTZXJ2ZXJFcnJvckV4Y2VwdGlvbihcbiAgICAgICAgYEZhaWxlZCB0byBzZWFyY2ggY29tbWVudHM6ICR7ZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiBTdHJpbmcoZXJyb3IpfWAsXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIHNlYXJjaENvbW11bml0aWVzKHF1ZXJ5OiBzdHJpbmcpIHtcbiAgICB0cnkge1xuICAgICAgcmV0dXJuIHRoaXMucHJpc21hLmNvbW11bml0eS5maW5kTWFueSh7XG4gICAgICAgIHdoZXJlOiB7XG4gICAgICAgICAgT1I6IFtcbiAgICAgICAgICAgIHsgbmFtZTogeyBjb250YWluczogcXVlcnksIG1vZGU6ICdpbnNlbnNpdGl2ZScgfSB9LFxuICAgICAgICAgICAgeyBkZXNjcmlwdGlvbjogeyBjb250YWluczogcXVlcnksIG1vZGU6ICdpbnNlbnNpdGl2ZScgfSB9LFxuICAgICAgICAgIF0sXG4gICAgICAgIH0sXG4gICAgICAgIGluY2x1ZGU6IHtcbiAgICAgICAgICBfY291bnQ6IHtcbiAgICAgICAgICAgIHNlbGVjdDoge1xuICAgICAgICAgICAgICBtZW1iZXJzaGlwczogdHJ1ZSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgICAgb3JkZXJCeTogeyBjcmVhdGVkQXQ6ICdkZXNjJyB9LFxuICAgICAgICB0YWtlOiAyMCxcbiAgICAgIH0pO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aHJvdyBuZXcgSW50ZXJuYWxTZXJ2ZXJFcnJvckV4Y2VwdGlvbihcbiAgICAgICAgYEZhaWxlZCB0byBzZWFyY2ggY29tbXVuaXRpZXM6ICR7ZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiBTdHJpbmcoZXJyb3IpfWAsXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIHNlYXJjaFVzZXJzKHF1ZXJ5OiBzdHJpbmcsIHJvbGU/OiBzdHJpbmcpIHtcbiAgICB0cnkge1xuICAgICAgY29uc3Qgd2hlcmU6IGFueSA9IHtcbiAgICAgICAgT1I6IFtcbiAgICAgICAgICB7IGZpcnN0TmFtZTogeyBjb250YWluczogcXVlcnksIG1vZGU6ICdpbnNlbnNpdGl2ZScgfSB9LFxuICAgICAgICAgIHsgbGFzdE5hbWU6IHsgY29udGFpbnM6IHF1ZXJ5LCBtb2RlOiAnaW5zZW5zaXRpdmUnIH0gfSxcbiAgICAgICAgICB7IGVtYWlsOiB7IGNvbnRhaW5zOiBxdWVyeSwgbW9kZTogJ2luc2Vuc2l0aXZlJyB9IH0sXG4gICAgICAgIF0sXG4gICAgICB9O1xuXG4gICAgICBpZiAocm9sZSkge1xuICAgICAgICB3aGVyZS5yb2xlID0gcm9sZTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHRoaXMucHJpc21hLnVzZXIuZmluZE1hbnkoe1xuICAgICAgICB3aGVyZSxcbiAgICAgICAgc2VsZWN0OiB7XG4gICAgICAgICAgaWQ6IHRydWUsXG4gICAgICAgICAgZmlyc3ROYW1lOiB0cnVlLFxuICAgICAgICAgIGxhc3ROYW1lOiB0cnVlLFxuICAgICAgICAgIGVtYWlsOiB0cnVlLFxuICAgICAgICAgIGF2YXRhclVybDogdHJ1ZSxcbiAgICAgICAgICByb2xlOiB0cnVlLFxuICAgICAgICAgIGNyZWF0ZWRBdDogdHJ1ZSxcbiAgICAgICAgfSxcbiAgICAgICAgb3JkZXJCeTogeyBjcmVhdGVkQXQ6ICdkZXNjJyB9LFxuICAgICAgICB0YWtlOiAyMCxcbiAgICAgIH0pO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aHJvdyBuZXcgSW50ZXJuYWxTZXJ2ZXJFcnJvckV4Y2VwdGlvbihcbiAgICAgICAgYEZhaWxlZCB0byBzZWFyY2ggdXNlcnM6ICR7ZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiBTdHJpbmcoZXJyb3IpfWAsXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIHNlYXJjaFdvcmtzaGVldHMocXVlcnk6IHN0cmluZywgdXNlcklkPzogc3RyaW5nLCByb2xlPzogJ2NsaWVudCcgfCAndGhlcmFwaXN0Jykge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCB3aGVyZTogYW55ID0ge1xuICAgICAgICBPUjogW1xuICAgICAgICAgIHsgdGl0bGU6IHsgY29udGFpbnM6IHF1ZXJ5LCBtb2RlOiAnaW5zZW5zaXRpdmUnIH0gfSxcbiAgICAgICAgICB7IGluc3RydWN0aW9uczogeyBjb250YWluczogcXVlcnksIG1vZGU6ICdpbnNlbnNpdGl2ZScgfSB9LFxuICAgICAgICBdLFxuICAgICAgfTtcblxuICAgICAgLy8gRmlsdGVyIGJ5IHVzZXIgcm9sZSAoY2xpZW50IGNhbiBvbmx5IHNlZSB0aGVpciBvd24gd29ya3NoZWV0cylcbiAgICAgIGlmIChyb2xlID09PSAnY2xpZW50JyAmJiB1c2VySWQpIHtcbiAgICAgICAgd2hlcmUuY2xpZW50SWQgPSB1c2VySWQ7XG4gICAgICB9IGVsc2UgaWYgKHJvbGUgPT09ICd0aGVyYXBpc3QnICYmIHVzZXJJZCkge1xuICAgICAgICB3aGVyZS50aGVyYXBpc3RJZCA9IHVzZXJJZDtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHRoaXMucHJpc21hLndvcmtzaGVldC5maW5kTWFueSh7XG4gICAgICAgIHdoZXJlLFxuICAgICAgICBpbmNsdWRlOiB7XG4gICAgICAgICAgY2xpZW50OiB7XG4gICAgICAgICAgICBzZWxlY3Q6IHtcbiAgICAgICAgICAgICAgdXNlcklkOiB0cnVlLFxuICAgICAgICAgICAgICB1c2VyOiB7XG4gICAgICAgICAgICAgICAgc2VsZWN0OiB7XG4gICAgICAgICAgICAgICAgICBmaXJzdE5hbWU6IHRydWUsXG4gICAgICAgICAgICAgICAgICBsYXN0TmFtZTogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgIGF2YXRhclVybDogdHJ1ZSxcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9LFxuICAgICAgICAgIHRoZXJhcGlzdDoge1xuICAgICAgICAgICAgc2VsZWN0OiB7XG4gICAgICAgICAgICAgIHVzZXJJZDogdHJ1ZSxcbiAgICAgICAgICAgICAgdXNlcjoge1xuICAgICAgICAgICAgICAgIHNlbGVjdDoge1xuICAgICAgICAgICAgICAgICAgZmlyc3ROYW1lOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgbGFzdE5hbWU6IHRydWUsXG4gICAgICAgICAgICAgICAgICBhdmF0YXJVcmw6IHRydWUsXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgICBzdWJtaXNzaW9uOiB7XG4gICAgICAgICAgICBzZWxlY3Q6IHtcbiAgICAgICAgICAgICAgaWQ6IHRydWUsXG4gICAgICAgICAgICAgIHN1Ym1pdHRlZEF0OiB0cnVlLFxuICAgICAgICAgICAgICBmZWVkYmFjazogdHJ1ZSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgICAgb3JkZXJCeTogeyBjcmVhdGVkQXQ6ICdkZXNjJyB9LFxuICAgICAgICB0YWtlOiAyMCxcbiAgICAgIH0pO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aHJvdyBuZXcgSW50ZXJuYWxTZXJ2ZXJFcnJvckV4Y2VwdGlvbihcbiAgICAgICAgYEZhaWxlZCB0byBzZWFyY2ggd29ya3NoZWV0czogJHtlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6IFN0cmluZyhlcnJvcil9YCxcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgc2VhcmNoTWVzc2FnZXMocXVlcnk6IHN0cmluZywgdXNlcklkOiBzdHJpbmcpIHtcbiAgICB0cnkge1xuICAgICAgY29uc3Qgd2hlcmVDbGF1c2U6IGFueSA9IHtcbiAgICAgICAgQU5EOiBbXG4gICAgICAgICAge1xuICAgICAgICAgICAgY29udGVudDoge1xuICAgICAgICAgICAgICBjb250YWluczogcXVlcnksXG4gICAgICAgICAgICAgIG1vZGU6ICdpbnNlbnNpdGl2ZScsXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0sXG4gICAgICAgICAge1xuICAgICAgICAgICAgaXNEZWxldGVkOiBmYWxzZSxcbiAgICAgICAgICB9LFxuICAgICAgICAgIHtcbiAgICAgICAgICAgIGNvbnZlcnNhdGlvbjoge1xuICAgICAgICAgICAgICBwYXJ0aWNpcGFudHM6IHtcbiAgICAgICAgICAgICAgICBzb21lOiB7XG4gICAgICAgICAgICAgICAgICB1c2VySWQsXG4gICAgICAgICAgICAgICAgICBpc0FjdGl2ZTogdHJ1ZSxcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9LFxuICAgICAgICBdLFxuICAgICAgfTtcblxuICAgICAgcmV0dXJuIHRoaXMucHJpc21hLm1lc3NhZ2UuZmluZE1hbnkoe1xuICAgICAgICB3aGVyZTogd2hlcmVDbGF1c2UsXG4gICAgICAgIGluY2x1ZGU6IHtcbiAgICAgICAgICBzZW5kZXI6IHtcbiAgICAgICAgICAgIHNlbGVjdDoge1xuICAgICAgICAgICAgICBpZDogdHJ1ZSxcbiAgICAgICAgICAgICAgZmlyc3ROYW1lOiB0cnVlLFxuICAgICAgICAgICAgICBsYXN0TmFtZTogdHJ1ZSxcbiAgICAgICAgICAgICAgYXZhdGFyVXJsOiB0cnVlLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9LFxuICAgICAgICAgIGNvbnZlcnNhdGlvbjoge1xuICAgICAgICAgICAgc2VsZWN0OiB7XG4gICAgICAgICAgICAgIGlkOiB0cnVlLFxuICAgICAgICAgICAgICB0eXBlOiB0cnVlLFxuICAgICAgICAgICAgICB0aXRsZTogdHJ1ZSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgICAgb3JkZXJCeTogeyBjcmVhdGVkQXQ6ICdkZXNjJyB9LFxuICAgICAgICB0YWtlOiAyMCxcbiAgICAgIH0pO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aHJvdyBuZXcgSW50ZXJuYWxTZXJ2ZXJFcnJvckV4Y2VwdGlvbihcbiAgICAgICAgYEZhaWxlZCB0byBzZWFyY2ggbWVzc2FnZXM6ICR7ZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiBTdHJpbmcoZXJyb3IpfWAsXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGdsb2JhbFNlYXJjaChcbiAgICBxdWVyeTogc3RyaW5nLFxuICAgIHR5cGVzPzpcbiAgICAgIHwgKCd0aGVyYXBpc3RzJyB8ICdwb3N0cycgfCAnY29tbXVuaXRpZXMnIHwgJ3VzZXJzJyB8ICd3b3Jrc2hlZXRzJyB8ICdtZXNzYWdlcycpW10sXG4gICAgdXNlcklkPzogc3RyaW5nLFxuICAgIHVzZXJSb2xlPzogJ2NsaWVudCcgfCAndGhlcmFwaXN0JyB8ICdtb2RlcmF0b3InIHwgJ2FkbWluJyxcbiAgKSB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHJlc3VsdHM6IGFueSA9IHt9O1xuXG4gICAgICAvLyBEZWZhdWx0IHRvIGFsbCB0eXBlcyBpZiBub25lIHNwZWNpZmllZFxuICAgICAgY29uc3QgZGVmYXVsdFR5cGVzID0gWyd0aGVyYXBpc3RzJywgJ3Bvc3RzJywgJ2NvbW11bml0aWVzJywgJ3VzZXJzJywgJ3dvcmtzaGVldHMnLCAnbWVzc2FnZXMnXTtcbiAgICAgIGNvbnN0IHR5cGVzQXJyYXkgPSB0eXBlcyAmJiB0eXBlcy5sZW5ndGggPiAwID8gdHlwZXMgOiBkZWZhdWx0VHlwZXM7XG5cbiAgICAgIGlmICh0eXBlc0FycmF5LmluY2x1ZGVzKCd0aGVyYXBpc3RzJykpIHtcbiAgICAgICAgcmVzdWx0cy50aGVyYXBpc3RzID0gYXdhaXQgdGhpcy5zZWFyY2hUaGVyYXBpc3RzKHF1ZXJ5KTtcbiAgICAgIH1cblxuICAgICAgaWYgKHR5cGVzQXJyYXkuaW5jbHVkZXMoJ3Bvc3RzJykpIHtcbiAgICAgICAgcmVzdWx0cy5wb3N0cyA9IGF3YWl0IHRoaXMuc2VhcmNoUG9zdHMocXVlcnksIHVuZGVmaW5lZCwgdXNlcklkKTtcbiAgICAgIH1cblxuICAgICAgLy8gQWRkIGNvbW1lbnRzIHNlYXJjaCAoYWx3YXlzIGZpbHRlcmVkIGJ5IHVzZXIgY29tbXVuaXRpZXMgaWYgdXNlcklkIGlzIHByb3ZpZGVkKVxuICAgICAgaWYgKHVzZXJJZCkge1xuICAgICAgICByZXN1bHRzLmNvbW1lbnRzID0gYXdhaXQgdGhpcy5zZWFyY2hDb21tZW50cyhxdWVyeSwgdW5kZWZpbmVkLCB1c2VySWQpO1xuICAgICAgfVxuXG4gICAgICBpZiAodHlwZXNBcnJheS5pbmNsdWRlcygnY29tbXVuaXRpZXMnKSkge1xuICAgICAgICByZXN1bHRzLmNvbW11bml0aWVzID0gYXdhaXQgdGhpcy5zZWFyY2hDb21tdW5pdGllcyhxdWVyeSk7XG4gICAgICB9XG5cbiAgICAgIGlmICh0eXBlc0FycmF5LmluY2x1ZGVzKCd1c2VycycpKSB7XG4gICAgICAgIHJlc3VsdHMudXNlcnMgPSBhd2FpdCB0aGlzLnNlYXJjaFVzZXJzKHF1ZXJ5KTtcbiAgICAgIH1cblxuICAgICAgaWYgKHR5cGVzQXJyYXkuaW5jbHVkZXMoJ3dvcmtzaGVldHMnKSkge1xuICAgICAgICAvLyBPbmx5IHNlYXJjaCB3b3Jrc2hlZXRzIGlmIHVzZXIgaGFzIGFwcHJvcHJpYXRlIHBlcm1pc3Npb25zXG4gICAgICAgIGlmICh1c2VyUm9sZSA9PT0gJ2NsaWVudCcgfHwgdXNlclJvbGUgPT09ICd0aGVyYXBpc3QnKSB7XG4gICAgICAgICAgcmVzdWx0cy53b3Jrc2hlZXRzID0gYXdhaXQgdGhpcy5zZWFyY2hXb3Jrc2hlZXRzKHF1ZXJ5LCB1c2VySWQsIHVzZXJSb2xlKTtcbiAgICAgICAgfSBlbHNlIGlmICh1c2VyUm9sZSA9PT0gJ21vZGVyYXRvcicgfHwgdXNlclJvbGUgPT09ICdhZG1pbicpIHtcbiAgICAgICAgICAvLyBBZG1pbnMgYW5kIG1vZGVyYXRvcnMgY2FuIHNlZSBhbGwgd29ya3NoZWV0c1xuICAgICAgICAgIHJlc3VsdHMud29ya3NoZWV0cyA9IGF3YWl0IHRoaXMuc2VhcmNoV29ya3NoZWV0cyhxdWVyeSk7XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgaWYgKHR5cGVzQXJyYXkuaW5jbHVkZXMoJ21lc3NhZ2VzJykgJiYgdXNlcklkKSB7XG4gICAgICAgIC8vIE1lc3NhZ2VzIGFyZSBhbHdheXMgcHJpdmF0ZSB0byB0aGUgdXNlclxuICAgICAgICByZXN1bHRzLm1lc3NhZ2VzID0gYXdhaXQgdGhpcy5zZWFyY2hNZXNzYWdlcyhxdWVyeSwgdXNlcklkKTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHJlc3VsdHM7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRocm93IG5ldyBJbnRlcm5hbFNlcnZlckVycm9yRXhjZXB0aW9uKFxuICAgICAgICBgRmFpbGVkIHRvIHBlcmZvcm0gZ2xvYmFsIHNlYXJjaDogJHtlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6IFN0cmluZyhlcnJvcil9YCxcbiAgICAgICk7XG4gICAgfVxuICB9XG59XG4iXSwidmVyc2lvbiI6M30=