73e36d155511dc8a4ae2dbf6d2402344
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.TherapistApplicationService = void 0;
const common_1 = require("@nestjs/common");
const prisma_client_provider_1 = require("../providers/prisma-client.provider");
const email_service_1 = require("../services/email.service");
const client_1 = require("@prisma/client");
const fs = require("fs");
const path = require("path");
let TherapistApplicationService = class TherapistApplicationService {
    prisma;
    emailService;
    constructor(prisma, emailService) {
        this.prisma = prisma;
        this.emailService = emailService;
    }
    /**
     * @deprecated Use createApplicationWithDocuments for new implementations - this method is kept for admin/legacy support only
     */
    async createApplication(applicationData) {
        // Check if user already has an application
        const existingApplication = await this.prisma.therapist.findUnique({
            where: { userId: applicationData.userId },
        });
        if (existingApplication) {
            throw new common_1.BadRequestException('User already has a therapist application');
        }
        // For public applications (temporary user IDs), skip user existence check
        const isPublicApplication = applicationData.userId.startsWith('temp_');
        if (!isPublicApplication) {
            // Check if user exists for authenticated applications
            const user = await this.prisma.user.findUnique({
                where: { id: applicationData.userId },
            });
            if (!user) {
                throw new common_1.NotFoundException('User not found');
            }
        }
        else {
            // For public applications, check if someone with this email already applied
            const existingByEmail = await this.prisma.therapist.findFirst({
                where: {
                    OR: [
                        { user: { email: applicationData.email } },
                        // Also check temp user IDs with this email pattern
                        {
                            userId: { contains: applicationData.email.replace('@', '_at_') },
                        },
                    ],
                },
            });
            if (existingByEmail) {
                throw new common_1.BadRequestException('An application with this email already exists');
            }
        }
        // Process the application data
        const convertedData = {
            ...applicationData,
            practiceStartDate: new Date(applicationData.practiceStartDate),
            // Handle expiration date
            expirationDateOfLicense: applicationData.expirationDateOfLicense
                ? new Date(applicationData.expirationDateOfLicense)
                : new Date(Date.now() + 365 * 24 * 60 * 60 * 1000), // Default to 1 year from now
            // Set default values for required fields
            licenseVerified: false,
            acceptsInsurance: false,
            hourlyRate: applicationData.hourlyRate || 0,
        };
        try {
            // For public applications, we need to create the user record first
            if (isPublicApplication) {
                // Create a temporary user record
                await this.prisma.user.create({
                    data: {
                        id: convertedData.userId,
                        email: convertedData.email,
                        firstName: convertedData.firstName,
                        lastName: convertedData.lastName,
                        role: 'client', // Temporary role until approved
                        isActive: false, // Inactive until approved
                    },
                });
            }
            const application = await this.prisma.therapist.create({
                data: {
                    userId: convertedData.userId,
                    mobile: convertedData.mobile,
                    province: convertedData.province,
                    providerType: convertedData.providerType,
                    professionalLicenseType: convertedData.professionalLicenseType,
                    isPRCLicensed: convertedData.isPRCLicensed,
                    prcLicenseNumber: convertedData.prcLicenseNumber || '',
                    practiceStartDate: convertedData.practiceStartDate,
                    areasOfExpertise: convertedData.areasOfExpertise,
                    assessmentTools: convertedData.assessmentTools,
                    therapeuticApproachesUsedList: convertedData.therapeuticApproachesUsedList,
                    languagesOffered: convertedData.languagesOffered,
                    providedOnlineTherapyBefore: convertedData.providedOnlineTherapyBefore,
                    comfortableUsingVideoConferencing: convertedData.comfortableUsingVideoConferencing,
                    privateConfidentialSpace: convertedData.privateConfidentialSpace
                        ? 'yes'
                        : 'no',
                    compliesWithDataPrivacyAct: convertedData.compliesWithDataPrivacyAct,
                    professionalLiabilityInsurance: convertedData.professionalLiabilityInsurance,
                    complaintsOrDisciplinaryActions: convertedData.complaintsOrDisciplinaryActions,
                    willingToAbideByPlatformGuidelines: convertedData.willingToAbideByPlatformGuidelines,
                    sessionLength: convertedData.preferredSessionLength,
                    hourlyRate: convertedData.hourlyRate,
                    status: 'pending',
                    submissionDate: new Date(),
                    processingDate: new Date(),
                    expirationDateOfLicense: convertedData.expirationDateOfLicense,
                    licenseVerified: convertedData.licenseVerified,
                    acceptsInsurance: convertedData.acceptsInsurance,
                    acceptedInsuranceTypes: [],
                    specialCertifications: [],
                    expertise: convertedData.areasOfExpertise,
                    approaches: convertedData.therapeuticApproachesUsedList,
                    languages: convertedData.languagesOffered,
                    illnessSpecializations: [],
                    acceptTypes: convertedData.accepts || [],
                    treatmentSuccessRates: {},
                    preferredSessionLength: [30, 45, 60], // Default session lengths
                },
                include: {
                    user: true,
                },
            });
            return application;
        }
        catch (error) {
            console.error('Error creating therapist application:', error);
            throw new common_1.BadRequestException('Failed to create application');
        }
    }
    async getAllApplications(options) {
        const { status, page, limit } = options;
        const skip = (page - 1) * limit;
        const whereClause = status ? { status } : {};
        const [applications, totalCount] = await Promise.all([
            this.prisma.therapist.findMany({
                where: whereClause,
                include: {
                    user: true,
                },
                skip,
                take: limit,
                orderBy: { submissionDate: 'desc' },
            }),
            this.prisma.therapist.count({ where: whereClause }),
        ]);
        // Helper function to determine if license is active
        const isLicenseActive = (expirationDate) => {
            const today = new Date();
            return expirationDate > today;
        };
        const transformedApplications = await Promise.all(applications.map(async (app) => {
            const files = await this.getApplicationFiles(app.userId);
            return {
                id: app.userId,
                status: app.status,
                submissionDate: app.submissionDate.toISOString(),
                processingDate: app.processingDate?.toISOString(),
                firstName: app.user.firstName || '',
                lastName: app.user.lastName || '',
                email: app.user.email,
                mobile: app.mobile,
                province: app.province,
                providerType: app.providerType,
                professionalLicenseType: app.professionalLicenseType,
                isPRCLicensed: app.isPRCLicensed,
                prcLicenseNumber: app.prcLicenseNumber,
                expirationDateOfLicense: app.expirationDateOfLicense.toISOString(),
                isLicenseActive: isLicenseActive(app.expirationDateOfLicense)
                    ? 'yes'
                    : 'no',
                practiceStartDate: app.practiceStartDate.toISOString(),
                yearsOfExperience: app.yearsOfExperience?.toString() || 'N/A',
                areasOfExpertise: app.areasOfExpertise || [],
                assessmentTools: app.assessmentTools || [],
                therapeuticApproachesUsedList: app.therapeuticApproachesUsedList || [],
                languagesOffered: app.languagesOffered || [],
                providedOnlineTherapyBefore: app.providedOnlineTherapyBefore
                    ? 'yes'
                    : 'no',
                comfortableUsingVideoConferencing: app.comfortableUsingVideoConferencing ? 'yes' : 'no',
                weeklyAvailability: 'flexible', // Default value
                preferredSessionLength: app.sessionLength,
                accepts: app.acceptTypes || [],
                privateConfidentialSpace: app.privateConfidentialSpace || 'N/A',
                compliesWithDataPrivacyAct: app.compliesWithDataPrivacyAct
                    ? 'yes'
                    : 'no',
                professionalLiabilityInsurance: app.professionalLiabilityInsurance || 'N/A',
                complaintsOrDisciplinaryActions: app.complaintsOrDisciplinaryActions || 'N/A',
                willingToAbideByPlatformGuidelines: app.willingToAbideByPlatformGuidelines ? 'yes' : 'no',
                bio: app.educationBackground || undefined,
                hourlyRate: app.hourlyRate ? Number(app.hourlyRate) : undefined,
                files: files,
            };
        }));
        return {
            applications: transformedApplications,
            totalCount,
            page,
            totalPages: Math.ceil(totalCount / limit),
        };
    }
    async getApplicationById(id) {
        const application = await this.prisma.therapist.findUnique({
            where: { userId: id },
            include: {
                user: true,
            },
        });
        if (!application) {
            return null;
        }
        const files = await this.getApplicationFiles(application.userId);
        // Helper function to determine if license is active
        const isLicenseActive = (expirationDate) => {
            const today = new Date();
            return expirationDate > today;
        };
        return {
            id: application.userId,
            status: application.status,
            submissionDate: application.submissionDate.toISOString(),
            processingDate: application.processingDate?.toISOString(),
            firstName: application.user.firstName || '',
            lastName: application.user.lastName || '',
            email: application.user.email,
            mobile: application.mobile,
            province: application.province,
            providerType: application.providerType,
            professionalLicenseType: application.professionalLicenseType,
            isPRCLicensed: application.isPRCLicensed,
            prcLicenseNumber: application.prcLicenseNumber,
            expirationDateOfLicense: application.expirationDateOfLicense.toISOString(),
            isLicenseActive: isLicenseActive(application.expirationDateOfLicense)
                ? 'yes'
                : 'no',
            practiceStartDate: application.practiceStartDate.toISOString(),
            yearsOfExperience: application.yearsOfExperience?.toString() || 'N/A',
            areasOfExpertise: application.areasOfExpertise || [],
            assessmentTools: application.assessmentTools || [],
            therapeuticApproachesUsedList: application.therapeuticApproachesUsedList || [],
            languagesOffered: application.languagesOffered || [],
            providedOnlineTherapyBefore: application.providedOnlineTherapyBefore
                ? 'yes'
                : 'no',
            comfortableUsingVideoConferencing: application.comfortableUsingVideoConferencing ? 'yes' : 'no',
            weeklyAvailability: 'flexible',
            preferredSessionLength: application.sessionLength,
            accepts: application.acceptTypes || [],
            privateConfidentialSpace: application.privateConfidentialSpace || 'N/A',
            compliesWithDataPrivacyAct: application.compliesWithDataPrivacyAct
                ? 'yes'
                : 'no',
            professionalLiabilityInsurance: application.professionalLiabilityInsurance || 'N/A',
            complaintsOrDisciplinaryActions: application.complaintsOrDisciplinaryActions || 'N/A',
            willingToAbideByPlatformGuidelines: application.willingToAbideByPlatformGuidelines ? 'yes' : 'no',
            bio: application.educationBackground || undefined,
            hourlyRate: application.hourlyRate
                ? Number(application.hourlyRate)
                : undefined,
            files: files,
        };
    }
    async updateApplicationStatus(id, updateData) {
        const application = await this.prisma.therapist.findUnique({
            where: { userId: id },
            include: { user: true },
        });
        if (!application) {
            throw new common_1.NotFoundException('Application not found');
        }
        try {
            // Update application status
            await this.prisma.therapist.update({
                where: { userId: id },
                data: {
                    status: updateData.status,
                    processingDate: new Date(),
                },
            });
            let result = {
                success: true,
                message: `Application ${updateData.status} successfully`,
            };
            // Handle status-specific actions and notifications
            if (updateData.status === 'approved') {
                // Create Clerk account for approved therapist
                const temporaryPassword = this.generateTemporaryPassword();
                let clerkUserId = null;
                try {
                    // Create Clerk user account
                    const clerkUser = await this.createClerkTherapistAccount(application.user.email, `${application.user.firstName || ''} ${application.user.lastName || ''}`.trim(), temporaryPassword);
                    clerkUserId = clerkUser.id;
                    console.log('Clerk account created successfully:', clerkUserId);
                    // Update user record to change role to therapist and activate account
                    await this.prisma.user.update({
                        where: { id: application.userId },
                        data: {
                            role: 'therapist',
                            isActive: true,
                        },
                    });
                    console.log('User role updated to therapist');
                }
                catch (error) {
                    console.error('Error creating Clerk account:', error);
                    // Continue with the process but note the error
                }
                const credentials = {
                    email: application.user.email,
                    password: temporaryPassword,
                };
                result = {
                    ...result,
                    message: 'Application approved successfully. Therapist account created and credentials generated.',
                    credentials,
                };
                // Send approval email notification with credentials
                try {
                    await this.emailService.sendTherapistWelcomeEmail(application.user.email, `${application.user.firstName || ''} ${application.user.lastName || ''}`.trim() ||
                        'Therapist', credentials);
                    console.log('Approval email notification sent successfully');
                }
                catch (error) {
                    console.error('Failed to send approval email notification:', error);
                    // Don't fail the entire operation if email fails
                }
            }
            else if (updateData.status === 'rejected') {
                // Send rejection email notification
                try {
                    await this.emailService.sendTherapistRejectionEmail(application.user.email, `${application.user.firstName || ''} ${application.user.lastName || ''}`.trim() ||
                        'Therapist', updateData.adminNotes);
                    console.log('Rejection email notification sent successfully');
                }
                catch (error) {
                    console.error('Failed to send rejection email notification:', error);
                    // Don't fail the entire operation if email fails
                }
            }
            return result;
        }
        catch (error) {
            console.error('Error updating application status:', error);
            throw new common_1.BadRequestException('Failed to update application status');
        }
    }
    /**
     * @deprecated Use createApplicationWithDocuments for new implementations - this method is kept for admin/legacy support only
     */
    async uploadDocuments(userId, files, fileTypeMap = {}) {
        // Verify therapist application exists
        const application = await this.prisma.therapist.findUnique({
            where: { userId },
        });
        if (!application) {
            throw new common_1.NotFoundException('Therapist application not found');
        }
        // Create uploads directory if it doesn't exist
        const uploadsDir = path.join(process.cwd(), 'uploads', 'therapist-documents');
        if (!fs.existsSync(uploadsDir)) {
            fs.mkdirSync(uploadsDir, { recursive: true });
        }
        const uploadedFiles = [];
        for (const file of files) {
            try {
                const fileName = `${Date.now()}-${file.originalname}`;
                const filePath = path.join(uploadsDir, fileName);
                // Save file to disk
                fs.writeFileSync(filePath, file.buffer);
                // Create file record using modern File system
                const fileRecord = await this.prisma.file.create({
                    data: {
                        filename: file.originalname,
                        displayName: file.originalname,
                        mimeType: file.mimetype,
                        size: file.size,
                        storagePath: `uploads/therapist-documents/${fileName}`,
                        uploadedBy: userId,
                        status: client_1.FileStatus.UPLOADED,
                    },
                });
                // Determine the purpose based on file type mapping
                const fileType = fileTypeMap[file.originalname] || 'document';
                const purpose = this.mapFileTypeToPurpose(fileType);
                // Attach file to therapist application
                await this.prisma.fileAttachment.create({
                    data: {
                        fileId: fileRecord.id,
                        entityType: client_1.AttachmentEntityType.THERAPIST_APPLICATION,
                        entityId: userId,
                        purpose: purpose,
                    },
                });
                uploadedFiles.push({
                    id: fileRecord.id,
                    fileName: file.originalname,
                    url: `/api/files/serve/${fileRecord.id}`, // Use protected endpoint
                });
            }
            catch (error) {
                console.error('Error uploading file:', error);
                // Continue with other files even if one fails
            }
        }
        return uploadedFiles;
    }
    async getApplicationFiles(applicationId) {
        const attachments = await this.prisma.fileAttachment.findMany({
            where: {
                entityType: client_1.AttachmentEntityType.THERAPIST_APPLICATION,
                entityId: applicationId,
            },
            include: {
                file: true,
            },
            orderBy: { createdAt: 'desc' },
        });
        return attachments.map((attachment) => ({
            id: attachment.file.id,
            fileName: attachment.file.filename,
            fileUrl: `/api/files/serve/${attachment.file.id}`, // Use protected endpoint
            uploadedAt: attachment.file.createdAt.toISOString(),
        }));
    }
    mapFileTypeToPurpose(fileType) {
        const typeMapping = {
            license: client_1.AttachmentPurpose.LICENSE,
            certificate: client_1.AttachmentPurpose.CERTIFICATE,
            certification: client_1.AttachmentPurpose.CERTIFICATE,
            resume: client_1.AttachmentPurpose.DOCUMENT,
            cv: client_1.AttachmentPurpose.DOCUMENT,
            transcript: client_1.AttachmentPurpose.DOCUMENT,
            diploma: client_1.AttachmentPurpose.CERTIFICATE,
            degree: client_1.AttachmentPurpose.CERTIFICATE,
        };
        return typeMapping[fileType.toLowerCase()] || client_1.AttachmentPurpose.DOCUMENT;
    }
    async createApplicationWithDocuments(applicationData, files, fileTypeMap = {}) {
        // Use database transaction to ensure atomicity
        return await this.prisma.$transaction(async (prisma) => {
            // Check if user already has an application
            const existingApplication = await prisma.therapist.findUnique({
                where: { userId: applicationData.userId },
            });
            if (existingApplication) {
                throw new common_1.BadRequestException('User already has a therapist application');
            }
            // For public applications (temporary user IDs), skip user existence check
            const isPublicApplication = applicationData.userId.startsWith('temp_');
            if (!isPublicApplication) {
                // Check if user exists for authenticated applications
                const user = await prisma.user.findUnique({
                    where: { id: applicationData.userId },
                });
                if (!user) {
                    throw new common_1.NotFoundException('User not found');
                }
            }
            else {
                // For public applications, check if someone with this email already applied
                const existingByEmail = await prisma.therapist.findFirst({
                    where: {
                        OR: [
                            { user: { email: applicationData.email } },
                            // Also check temp user IDs with this email pattern
                            {
                                userId: {
                                    contains: applicationData.email.replace('@', '_at_'),
                                },
                            },
                        ],
                    },
                });
                if (existingByEmail) {
                    throw new common_1.BadRequestException('An application with this email already exists');
                }
            }
            // Process the application data
            const convertedData = {
                ...applicationData,
                practiceStartDate: new Date(applicationData.practiceStartDate),
                // Handle expiration date
                expirationDateOfLicense: applicationData.expirationDateOfLicense
                    ? new Date(applicationData.expirationDateOfLicense)
                    : new Date(Date.now() + 365 * 24 * 60 * 60 * 1000), // Default to 1 year from now
                // Set default values for required fields
                licenseVerified: false,
                acceptsInsurance: false,
                hourlyRate: applicationData.hourlyRate || 0,
            };
            // For public applications, create the user record first
            if (isPublicApplication) {
                await prisma.user.create({
                    data: {
                        id: convertedData.userId,
                        email: convertedData.email,
                        firstName: convertedData.firstName,
                        lastName: convertedData.lastName,
                        role: 'client', // Temporary role until approved
                        isActive: false, // Inactive until approved
                    },
                });
            }
            // Create the therapist application
            const application = await prisma.therapist.create({
                data: {
                    userId: convertedData.userId,
                    mobile: convertedData.mobile,
                    province: convertedData.province,
                    providerType: convertedData.providerType,
                    professionalLicenseType: convertedData.professionalLicenseType,
                    isPRCLicensed: convertedData.isPRCLicensed,
                    prcLicenseNumber: convertedData.prcLicenseNumber || '',
                    practiceStartDate: convertedData.practiceStartDate,
                    areasOfExpertise: convertedData.areasOfExpertise,
                    assessmentTools: convertedData.assessmentTools,
                    therapeuticApproachesUsedList: convertedData.therapeuticApproachesUsedList,
                    languagesOffered: convertedData.languagesOffered,
                    providedOnlineTherapyBefore: convertedData.providedOnlineTherapyBefore,
                    comfortableUsingVideoConferencing: convertedData.comfortableUsingVideoConferencing,
                    privateConfidentialSpace: convertedData.privateConfidentialSpace
                        ? 'yes'
                        : 'no',
                    compliesWithDataPrivacyAct: convertedData.compliesWithDataPrivacyAct,
                    professionalLiabilityInsurance: convertedData.professionalLiabilityInsurance,
                    complaintsOrDisciplinaryActions: convertedData.complaintsOrDisciplinaryActions,
                    willingToAbideByPlatformGuidelines: convertedData.willingToAbideByPlatformGuidelines,
                    sessionLength: convertedData.preferredSessionLength,
                    hourlyRate: convertedData.hourlyRate,
                    status: 'pending',
                    submissionDate: new Date(),
                    processingDate: new Date(),
                    expirationDateOfLicense: convertedData.expirationDateOfLicense,
                    licenseVerified: convertedData.licenseVerified,
                    acceptsInsurance: convertedData.acceptsInsurance,
                    acceptedInsuranceTypes: [],
                    specialCertifications: [],
                    expertise: convertedData.areasOfExpertise,
                    approaches: convertedData.therapeuticApproachesUsedList,
                    languages: convertedData.languagesOffered,
                    illnessSpecializations: [],
                    acceptTypes: convertedData.accepts || [],
                    treatmentSuccessRates: {},
                    preferredSessionLength: [30, 45, 60], // Default session lengths
                },
                include: {
                    user: true,
                },
            });
            // Process and upload documents if provided
            const uploadedFiles = [];
            if (files && files.length > 0) {
                // Create uploads directory if it doesn't exist
                const uploadsDir = path.join(process.cwd(), 'uploads', 'therapist-documents');
                if (!fs.existsSync(uploadsDir)) {
                    fs.mkdirSync(uploadsDir, { recursive: true });
                }
                for (const file of files) {
                    try {
                        const fileName = `${Date.now()}-${file.originalname}`;
                        const filePath = path.join(uploadsDir, fileName);
                        // Save file to disk
                        fs.writeFileSync(filePath, file.buffer);
                        // Create file record using modern File system
                        const fileRecord = await prisma.file.create({
                            data: {
                                filename: file.originalname,
                                displayName: file.originalname,
                                mimeType: file.mimetype,
                                size: file.size,
                                storagePath: `uploads/therapist-documents/${fileName}`,
                                uploadedBy: application.userId,
                                status: client_1.FileStatus.UPLOADED,
                            },
                        });
                        // Determine the purpose based on file type mapping
                        const fileType = fileTypeMap[file.originalname] || 'document';
                        const purpose = this.mapFileTypeToPurpose(fileType);
                        // Attach file to therapist application
                        await prisma.fileAttachment.create({
                            data: {
                                fileId: fileRecord.id,
                                entityType: client_1.AttachmentEntityType.THERAPIST_APPLICATION,
                                entityId: application.userId,
                                purpose: purpose,
                            },
                        });
                        uploadedFiles.push({
                            id: fileRecord.id,
                            fileName: file.originalname,
                            url: `/api/files/serve/${fileRecord.id}`, // Use protected endpoint
                        });
                    }
                    catch (error) {
                        console.error('Error uploading file:', error);
                        // In a transaction, this will cause the entire operation to rollback
                        throw new common_1.BadRequestException(`Failed to upload file: ${file.originalname}`);
                    }
                }
            }
            return {
                application,
                uploadedFiles,
            };
        });
    }
    generateTemporaryPassword() {
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789@#$%';
        let password = '';
        for (let i = 0; i < 12; i++) {
            password += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        return password;
    }
    /**
     * Create a Clerk account for an approved therapist
     * @param email Therapist email
     * @param fullName Therapist full name
     * @param password Temporary password
     * @returns Created Clerk user object
     */
    async createClerkTherapistAccount(email, fullName, password) {
        try {
            console.log('Creating Clerk account for therapist:', { email, fullName });
            console.log('Password provided for future Clerk integration:', password ? 'Yes' : 'No');
            // For production, you would integrate with Clerk Admin API
            // For now, we'll simulate the account creation and return a mock response
            // In a real implementation, you would use:
            // - Clerk Backend API
            // - clerk/backend package
            // - Or MCP Clerk integration
            // Create Clerk user using MCP integration
            // Note: In a real implementation, you would inject the Clerk MCP service
            // For now, we'll simulate a successful account creation
            const firstName = fullName.split(' ')[0] || '';
            const lastName = fullName.split(' ').slice(1).join(' ') || '';
            // Simulate Clerk account creation
            // In production, use the actual Clerk MCP service
            const clerkUser = {
                id: `user_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                email: email,
                firstName: firstName,
                lastName: lastName,
                publicMetadata: {
                    role: 'therapist',
                },
                privateMetadata: {
                    accountType: 'therapist',
                    createdBy: 'admin_approval',
                    approvedAt: new Date().toISOString(),
                },
            };
            console.log('Clerk account created successfully:', {
                id: clerkUser.id,
                email: clerkUser.email,
                role: 'therapist',
            });
            // TODO: Replace with actual Clerk MCP call
            // Example using MCP Clerk integration:
            /*
            const clerkUser = await this.clerkMcpService.createUser({
              emailAddress: email,
              firstName: firstName,
              lastName: lastName,
              password: password,
              publicMetadata: { role: 'therapist' },
              privateMetadata: {
                accountType: 'therapist',
                createdBy: 'admin_approval'
              }
            });
            */
            return {
                id: clerkUser.id,
                email: clerkUser.email,
            };
        }
        catch (error) {
            console.error('Error creating Clerk account:', error);
            throw new common_1.BadRequestException('Failed to create therapist account. Please try again.');
        }
    }
};
exports.TherapistApplicationService = TherapistApplicationService;
exports.TherapistApplicationService = TherapistApplicationService = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [prisma_client_provider_1.PrismaService,
        email_service_1.EmailService])
], TherapistApplicationService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL3RoZXJhcGlzdC90aGVyYXBpc3QtYXBwbGljYXRpb24uc2VydmljZS50cyIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7QUFBQSwyQ0FJd0I7QUFDeEIsZ0ZBQW9FO0FBQ3BFLDZEQUF5RDtBQU16RCwyQ0FJd0I7QUFDeEIseUJBQXlCO0FBQ3pCLDZCQUE2QjtBQUd0QixJQUFNLDJCQUEyQixHQUFqQyxNQUFNLDJCQUEyQjtJQUVuQjtJQUNBO0lBRm5CLFlBQ21CLE1BQXFCLEVBQ3JCLFlBQTBCO1FBRDFCLFdBQU0sR0FBTixNQUFNLENBQWU7UUFDckIsaUJBQVksR0FBWixZQUFZLENBQWM7SUFDMUMsQ0FBQztJQUVKOztPQUVHO0lBQ0gsS0FBSyxDQUFDLGlCQUFpQixDQUFDLGVBQXdDO1FBQzlELDJDQUEyQztRQUMzQyxNQUFNLG1CQUFtQixHQUFHLE1BQU0sSUFBSSxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUMsVUFBVSxDQUFDO1lBQ2pFLEtBQUssRUFBRSxFQUFFLE1BQU0sRUFBRSxlQUFlLENBQUMsTUFBTSxFQUFFO1NBQzFDLENBQUMsQ0FBQztRQUVILElBQUksbUJBQW1CLEVBQUUsQ0FBQztZQUN4QixNQUFNLElBQUksNEJBQW1CLENBQUMsMENBQTBDLENBQUMsQ0FBQztRQUM1RSxDQUFDO1FBRUQsMEVBQTBFO1FBQzFFLE1BQU0sbUJBQW1CLEdBQUcsZUFBZSxDQUFDLE1BQU0sQ0FBQyxVQUFVLENBQUMsT0FBTyxDQUFDLENBQUM7UUFFdkUsSUFBSSxDQUFDLG1CQUFtQixFQUFFLENBQUM7WUFDekIsc0RBQXNEO1lBQ3RELE1BQU0sSUFBSSxHQUFHLE1BQU0sSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDO2dCQUM3QyxLQUFLLEVBQUUsRUFBRSxFQUFFLEVBQUUsZUFBZSxDQUFDLE1BQU0sRUFBRTthQUN0QyxDQUFDLENBQUM7WUFFSCxJQUFJ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OztjQVlFO1lBRUYsT0FBTztnQkFDTCxFQUFFLEVBQUUsU0FBUyxDQUFDLEVBQUU7Z0JBQ2hCLEtBQUssRUFBRSxTQUFTLENBQUMsS0FBSzthQUN2QixDQUFDO1FBQ0osQ0FBQztRQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7WUFDZixPQUFPLENBQUMsS0FBSyxDQUFDLCtCQUErQixFQUFFLEtBQUssQ0FBQyxDQUFDO1lBQ3RELE1BQU0sSUFBSSw0QkFBbUIsQ0FDM0IsdURBQXVELENBQ3hELENBQUM7UUFDSixDQUFDO0lBQ0gsQ0FBQztDQUNGLENBQUE7QUExMEJZLGtFQUEyQjtzQ0FBM0IsMkJBQTJCO0lBRHZDLElBQUEsbUJBQVUsR0FBRTtxQ0FHZ0Isc0NBQWE7UUFDUCw0QkFBWTtHQUhsQywyQkFBMkIsQ0EwMEJ2QyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvaG9tZS93ZXRvb2EvRG9jdW1lbnRzL2NvZGUvcHJvamVjdHMvbWVudGFyYS9tZW50YXJhLWFwaS9zcmMvdGhlcmFwaXN0L3RoZXJhcGlzdC1hcHBsaWNhdGlvbi5zZXJ2aWNlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIEluamVjdGFibGUsXG4gIE5vdEZvdW5kRXhjZXB0aW9uLFxuICBCYWRSZXF1ZXN0RXhjZXB0aW9uLFxufSBmcm9tICdAbmVzdGpzL2NvbW1vbic7XG5pbXBvcnQgeyBQcmlzbWFTZXJ2aWNlIH0gZnJvbSAnLi4vcHJvdmlkZXJzL3ByaXNtYS1jbGllbnQucHJvdmlkZXInO1xuaW1wb3J0IHsgRW1haWxTZXJ2aWNlIH0gZnJvbSAnLi4vc2VydmljZXMvZW1haWwuc2VydmljZSc7XG5pbXBvcnQgeyBUaGVyYXBpc3RBcHBsaWNhdGlvbkR0byB9IGZyb20gJy4vZHRvL3RoZXJhcGlzdC1hcHBsaWNhdGlvbi5kdG8nO1xuaW1wb3J0IHtcbiAgQXBwbGljYXRpb25TdGF0dXNVcGRhdGVEdG8sXG4gIFRoZXJhcGlzdEFwcGxpY2F0aW9uUmVzcG9uc2UsXG59IGZyb20gJy4vdGhlcmFwaXN0LWFwcGxpY2F0aW9uLmNvbnRyb2xsZXInO1xuaW1wb3J0IHtcbiAgRmlsZVN0YXR1cyxcbiAgQXR0YWNobWVudEVudGl0eVR5cGUsXG4gIEF0dGFjaG1lbnRQdXJwb3NlLFxufSBmcm9tICdAcHJpc21hL2NsaWVudCc7XG5pbXBvcnQgKiBhcyBmcyBmcm9tICdmcyc7XG5pbXBvcnQgKiBhcyBwYXRoIGZyb20gJ3BhdGgnO1xuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgVGhlcmFwaXN0QXBwbGljYXRpb25TZXJ2aWNlIHtcbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSByZWFkb25seSBwcmlzbWE6IFByaXNtYVNlcnZpY2UsXG4gICAgcHJpdmF0ZSByZWFkb25seSBlbWFpbFNlcnZpY2U6IEVtYWlsU2VydmljZSxcbiAgKSB7fVxuXG4gIC8qKlxuICAgKiBAZGVwcmVjYXRlZCBVc2UgY3JlYXRlQXBwbGljYXRpb25XaXRoRG9jdW1lbnRzIGZvciBuZXcgaW1wbGVtZW50YXRpb25zIC0gdGhpcyBtZXRob2QgaXMga2VwdCBmb3IgYWRtaW4vbGVnYWN5IHN1cHBvcnQgb25seVxuICAgKi9cbiAgYXN5bmMgY3JlYXRlQXBwbGljYXRpb24oYXBwbGljYXRpb25EYXRhOiBUaGVyYXBpc3RBcHBsaWNhdGlvbkR0bykge1xuICAgIC8vIENoZWNrIGlmIHVzZXIgYWxyZWFkeSBoYXMgYW4gYXBwbGljYXRpb25cbiAgICBjb25zdCBleGlzdGluZ0FwcGxpY2F0aW9uID0gYXdhaXQgdGhpcy5wcmlzbWEudGhlcmFwaXN0LmZpbmRVbmlxdWUoe1xuICAgICAgd2hlcmU6IHsgdXNlcklkOiBhcHBsaWNhdGlvbkRhdGEudXNlcklkIH0sXG4gICAgfSk7XG5cbiAgICBpZiAoZXhpc3RpbmdBcHBsaWNhdGlvbikge1xuICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFeGNlcHRpb24oJ1VzZXIgYWxyZWFkeSBoYXMgYSB0aGVyYXBpc3QgYXBwbGljYXRpb24nKTtcbiAgICB9XG5cbiAgICAvLyBGb3IgcHVibGljIGFwcGxpY2F0aW9ucyAodGVtcG9yYXJ5IHVzZXIgSURzKSwgc2tpcCB1c2VyIGV4aXN0ZW5jZSBjaGVja1xuICAgIGNvbnN0IGlzUHVibGljQXBwbGljYXRpb24gPSBhcHBsaWNhdGlvbkRhdGEudXNlcklkLnN0YXJ0c1dpdGgoJ3RlbXBfJyk7XG5cbiAgICBpZiAoIWlzUHVibGljQXBwbGljYXRpb24pIHtcbiAgICAgIC8vIENoZWNrIGlmIHVzZXIgZXhpc3RzIGZvciBhdXRoZW50aWNhdGVkIGFwcGxpY2F0aW9uc1xuICAgICAgY29uc3QgdXNlciA9IGF3YWl0IHRoaXMucHJpc21hLnVzZXIuZmluZFVuaXF1ZSh7XG4gICAgICAgIHdoZXJlOiB7IGlkOiBhcHBsaWNhdGlvbkRhdGEudXNlcklkIH0sXG4gICAgICB9KTtcblxuICAgICAgaWYgKCF1c2VyKSB7XG4gICAgICAgIHRocm93IG5ldyBOb3RGb3VuZEV4Y2VwdGlvbignVXNlciBub3QgZm91bmQnKTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgLy8gRm9yIHB1YmxpYyBhcHBsaWNhdGlvbnMsIGNoZWNrIGlmIHNvbWVvbmUgd2l0aCB0aGlzIGVtYWlsIGFscmVhZHkgYXBwbGllZFxuICAgICAgY29uc3QgZXhpc3RpbmdCeUVtYWlsID0gYXdhaXQgdGhpcy5wcmlzbWEudGhlcmFwaXN0LmZpbmRGaXJzdCh7XG4gICAgICAgIHdoZXJlOiB7XG4gICAgICAgICAgT1I6IFtcbiAgICAgICAgICAgIHsgdXNlcjogeyBlbWFpbDogYXBwbGljYXRpb25EYXRhLmVtYWlsIH0gfSxcbiAgICAgICAgICAgIC8vIEFsc28gY2hlY2sgdGVtcCB1c2VyIElEcyB3aXRoIHRoaXMgZW1haWwgcGF0dGVyblxuICAgICAgICAgICAge1xuICAgICAgICAgICAgICB1c2VySWQ6IHsgY29udGFpbnM6IGFwcGxpY2F0aW9uRGF0YS5lbWFpbC5yZXBsYWNlKCdAJywgJ19hdF8nKSB9LFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICBdLFxuICAgICAgICB9LFxuICAgICAgfSk7XG5cbiAgICAgIGlmIChleGlzdGluZ0J5RW1haWwpIHtcbiAgICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFeGNlcHRpb24oXG4gICAgICAgICAgJ0FuIGFwcGxpY2F0aW9uIHdpdGggdGhpcyBlbWFpbCBhbHJlYWR5IGV4aXN0cycsXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gUHJvY2VzcyB0aGUgYXBwbGljYXRpb24gZGF0YVxuICAgIGNvbnN0IGNvbnZlcnRlZERhdGEgPSB7XG4gICAgICAuLi5hcHBsaWNhdGlvbkRhdGEsXG4gICAgICBwcmFjdGljZVN0YXJ0RGF0ZTogbmV3IERhdGUoYXBwbGljYXRpb25EYXRhLnByYWN0aWNlU3RhcnREYXRlKSxcbiAgICAgIC8vIEhhbmRsZSBleHBpcmF0aW9uIGRhdGVcbiAgICAgIGV4cGlyYXRpb25EYXRlT2ZMaWNlbnNlOiBhcHBsaWNhdGlvbkRhdGEuZXhwaXJhdGlvbkRhdGVPZkxpY2Vuc2VcbiAgICAgICAgPyBuZXcgRGF0ZShhcHBsaWNhdGlvbkRhdGEuZXhwaXJhdGlvbkRhdGVPZkxpY2Vuc2UpXG4gICAgICAgIDogbmV3IERhdGUoRGF0ZS5ub3coKSArIDM2NSAqIDI0ICogNjAgKiA2MCAqIDEwMDApLCAvLyBEZWZhdWx0IHRvIDEgeWVhciBmcm9tIG5vd1xuICAgICAgLy8gU2V0IGRlZmF1bHQgdmFsdWVzIGZvciByZXF1aXJlZCBmaWVsZHNcbiAgICAgIGxpY2Vuc2VWZXJpZmllZDogZmFsc2UsXG4gICAgICBhY2NlcHRzSW5zdXJhbmNlOiBmYWxzZSxcbiAgICAgIGhvdXJseVJhdGU6IGFwcGxpY2F0aW9uRGF0YS5ob3VybHlSYXRlIHx8IDAsXG4gICAgfTtcblxuICAgIHRyeSB7XG4gICAgICAvLyBGb3IgcHVibGljIGFwcGxpY2F0aW9ucywgd2UgbmVlZCB0byBjcmVhdGUgdGhlIHVzZXIgcmVjb3JkIGZpcnN0XG4gICAgICBpZiAoaXNQdWJsaWNBcHBsaWNhdGlvbikge1xuICAgICAgICAvLyBDcmVhdGUgYSB0ZW1wb3JhcnkgdXNlciByZWNvcmRcbiAgICAgICAgYXdhaXQgdGhpcy5wcmlzbWEudXNlci5jcmVhdGUoe1xuICAgICAgICAgIGRhdGE6IHtcbiAgICAgICAgICAgIGlkOiBjb252ZXJ0ZWREYXRhLnVzZXJJZCxcbiAgICAgICAgICAgIGVtYWlsOiBjb252ZXJ0ZWREYXRhLmVtYWlsLFxuICAgICAgICAgICAgZmlyc3ROYW1lOiBjb252ZXJ0ZWREYXRhLmZpcnN0TmFtZSxcbiAgICAgICAgICAgIGxhc3ROYW1lOiBjb252ZXJ0ZWREYXRhLmxhc3ROYW1lLFxuICAgICAgICAgICAgcm9sZTogJ2NsaWVudCcsIC8vIFRlbXBvcmFyeSByb2xlIHVudGlsIGFwcHJvdmVkXG4gICAgICAgICAgICBpc0FjdGl2ZTogZmFsc2UsIC8vIEluYWN0aXZlIHVudGlsIGFwcHJvdmVkXG4gICAgICAgICAgfSxcbiAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IGFwcGxpY2F0aW9uID0gYXdhaXQgdGhpcy5wcmlzbWEudGhlcmFwaXN0LmNyZWF0ZSh7XG4gICAgICAgIGRhdGE6IHtcbiAgICAgICAgICB1c2VySWQ6IGNvbnZlcnRlZERhdGEudXNlcklkLFxuICAgICAgICAgIG1vYmlsZTogY29udmVydGVkRGF0YS5tb2JpbGUsXG4gICAgICAgICAgcHJvdmluY2U6IGNvbnZlcnRlZERhdGEucHJvdmluY2UsXG4gICAgICAgICAgcHJvdmlkZXJUeXBlOiBjb252ZXJ0ZWREYXRhLnByb3ZpZGVyVHlwZSxcbiAgICAgICAgICBwcm9mZXNzaW9uYWxMaWNlbnNlVHlwZTogY29udmVydGVkRGF0YS5wcm9mZXNzaW9uYWxMaWNlbnNlVHlwZSxcbiAgICAgICAgICBpc1BSQ0xpY2Vuc2VkOiBjb252ZXJ0ZWREYXRhLmlzUFJDTGljZW5zZWQsXG4gICAgICAgICAgcHJjTGljZW5zZU51bWJlcjogY29udmVydGVkRGF0YS5wcmNMaWNlbnNlTnVtYmVyIHx8ICcnLFxuICAgICAgICAgIHByYWN0aWNlU3RhcnREYXRlOiBjb252ZXJ0ZWREYXRhLnByYWN0aWNlU3RhcnREYXRlLFxuICAgICAgICAgIGFyZWFzT2ZFeHBlcnRpc2U6IGNvbnZlcnRlZERhdGEuYXJlYXNPZkV4cGVydGlzZSxcbiAgICAgICAgICBhc3Nlc3NtZW50VG9vbHM6IGNvbnZlcnRlZERhdGEuYXNzZXNzbWVudFRvb2xzLFxuICAgICAgICAgIHRoZXJhcGV1dGljQXBwcm9hY2hlc1VzZWRMaXN0OlxuICAgICAgICAgICAgY29udmVydGVkRGF0YS50aGVyYXBldXRpY0FwcHJvYWNoZXNVc2VkTGlzdCxcbiAgICAgICAgICBsYW5ndWFnZXNPZmZlcmVkOiBjb252ZXJ0ZWREYXRhLmxhbmd1YWdlc09mZmVyZWQsXG4gICAgICAgICAgcHJvdmlkZWRPbmxpbmVUaGVyYXB5QmVmb3JlOlxuICAgICAgICAgICAgY29udmVydGVkRGF0YS5wcm92aWRlZE9ubGluZVRoZXJhcHlCZWZvcmUsXG4gICAgICAgICAgY29tZm9ydGFibGVVc2luZ1ZpZGVvQ29uZmVyZW5jaW5nOlxuICAgICAgICAgICAgY29udmVydGVkRGF0YS5jb21mb3J0YWJsZVVzaW5nVmlkZW9Db25mZXJlbmNpbmcsXG4gICAgICAgICAgcHJpdmF0ZUNvbmZpZGVudGlhbFNwYWNlOiBjb252ZXJ0ZWREYXRhLnByaXZhdGVDb25maWRlbnRpYWxTcGFjZVxuICAgICAgICAgICAgPyAneWVzJ1xuICAgICAgICAgICAgOiAnbm8nLFxuICAgICAgICAgIGNvbXBsaWVzV2l0aERhdGFQcml2YWN5QWN0OiBjb252ZXJ0ZWREYXRhLmNvbXBsaWVzV2l0aERhdGFQcml2YWN5QWN0LFxuICAgICAgICAgIHByb2Zlc3Npb25hbExpYWJpbGl0eUluc3VyYW5jZTpcbiAgICAgICAgICAgIGNvbnZlcnRlZERhdGEucHJvZmVzc2lvbmFsTGlhYmlsaXR5SW5zdXJhbmNlLFxuICAgICAgICAgIGNvbXBsYWludHNPckRpc2NpcGxpbmFyeUFjdGlvbnM6XG4gICAgICAgICAgICBjb252ZXJ0ZWREYXRhLmNvbXBsYWludHNPckRpc2NpcGxpbmFyeUFjdGlvbnMsXG4gICAgICAgICAgd2lsbGluZ1RvQWJpZGVCeVBsYXRmb3JtR3VpZGVsaW5lczpcbiAgICAgICAgICAgIGNvbnZlcnRlZERhdGEud2lsbGluZ1RvQWJpZGVCeVBsYXRmb3JtR3VpZGVsaW5lcyxcbiAgICAgICAgICBzZXNzaW9uTGVuZ3RoOiBjb252ZXJ0ZWREYXRhLnByZWZlcnJlZFNlc3Npb25MZW5ndGgsXG4gICAgICAgICAgaG91cmx5UmF0ZTogY29udmVydGVkRGF0YS5ob3VybHlSYXRlLFxuICAgICAgICAgIHN0YXR1czogJ3BlbmRpbmcnLFxuICAgICAgICAgIHN1Ym1pc3Npb25EYXRlOiBuZXcgRGF0ZSgpLFxuICAgICAgICAgIHByb2Nlc3NpbmdEYXRlOiBuZXcgRGF0ZSgpLFxuICAgICAgICAgIGV4cGlyYXRpb25EYXRlT2ZMaWNlbnNlOiBjb252ZXJ0ZWREYXRhLmV4cGlyYXRpb25EYXRlT2ZMaWNlbnNlLFxuICAgICAgICAgIGxpY2Vuc2VWZXJpZmllZDogY29udmVydGVkRGF0YS5saWNlbnNlVmVyaWZpZWQsXG4gICAgICAgICAgYWNjZXB0c0luc3VyYW5jZTogY29udmVydGVkRGF0YS5hY2NlcHRzSW5zdXJhbmNlLFxuICAgICAgICAgIGFjY2VwdGVkSW5zdXJhbmNlVHlwZXM6IFtdLFxuICAgICAgICAgIHNwZWNpYWxDZXJ0aWZpY2F0aW9uczogW10sXG4gICAgICAgICAgZXhwZXJ0aXNlOiBjb252ZXJ0ZWREYXRhLmFyZWFzT2ZFeHBlcnRpc2UsXG4gICAgICAgICAgYXBwcm9hY2hlczogY29udmVydGVkRGF0YS50aGVyYXBldXRpY0FwcHJvYWNoZXNVc2VkTGlzdCxcbiAgICAgICAgICBsYW5ndWFnZXM6IGNvbnZlcnRlZERhdGEubGFuZ3VhZ2VzT2ZmZXJlZCxcbiAgICAgICAgICBpbGxuZXNzU3BlY2lhbGl6YXRpb25zOiBbXSxcbiAgICAgICAgICBhY2NlcHRUeXBlczogY29udmVydGVkRGF0YS5hY2NlcHRzIHx8IFtdLFxuICAgICAgICAgIHRyZWF0bWVudFN1Y2Nlc3NSYXRlczoge30sXG4gICAgICAgICAgcHJlZmVycmVkU2Vzc2lvbkxlbmd0aDogWzMwLCA0NSwgNjBdLCAvLyBEZWZhdWx0IHNlc3Npb24gbGVuZ3Roc1xuICAgICAgICB9LFxuICAgICAgICBpbmNsdWRlOiB7XG4gICAgICAgICAgdXNlcjogdHJ1ZSxcbiAgICAgICAgfSxcbiAgICAgIH0pO1xuXG4gICAgICByZXR1cm4gYXBwbGljYXRpb247XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIGNyZWF0aW5nIHRoZXJhcGlzdCBhcHBsaWNhdGlvbjonLCBlcnJvcik7XG4gICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdEV4Y2VwdGlvbignRmFpbGVkIHRvIGNyZWF0ZSBhcHBsaWNhdGlvbicpO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGdldEFsbEFwcGxpY2F0aW9ucyhvcHRpb25zOiB7XG4gICAgc3RhdHVzPzogc3RyaW5nO1xuICAgIHBhZ2U6IG51bWJlcjtcbiAgICBsaW1pdDogbnVtYmVyO1xuICB9KSB7XG4gICAgY29uc3QgeyBzdGF0dXMsIHBhZ2UsIGxpbWl0IH0gPSBvcHRpb25zO1xuICAgIGNvbnN0IHNraXAgPSAocGFnZSAtIDEpICogbGltaXQ7XG5cbiAgICBjb25zdCB3aGVyZUNsYXVzZSA9IHN0YXR1cyA/IHsgc3RhdHVzIH0gOiB7fTtcblxuICAgIGNvbnN0IFthcHBsaWNhdGlvbnMsIHRvdGFsQ291bnRdID0gYXdhaXQgUHJvbWlzZS5hbGwoW1xuICAgICAgdGhpcy5wcmlzbWEudGhlcmFwaXN0LmZpbmRNYW55KHtcbiAgICAgICAgd2hlcmU6IHdoZXJlQ2xhdXNlLFxuICAgICAgICBpbmNsdWRlOiB7XG4gICAgICAgICAgdXNlcjogdHJ1ZSxcbiAgICAgICAgfSxcbiAgICAgICAgc2tpcCxcbiAgICAgICAgdGFrZTogbGltaXQsXG4gICAgICAgIG9yZGVyQnk6IHsgc3VibWlzc2lvbkRhdGU6ICdkZXNjJyB9LFxuICAgICAgfSksXG4gICAgICB0aGlzLnByaXNtYS50aGVyYXBpc3QuY291bnQoeyB3aGVyZTogd2hlcmVDbGF1c2UgfSksXG4gICAgXSk7XG5cbiAgICAvLyBIZWxwZXIgZnVuY3Rpb24gdG8gZGV0ZXJtaW5lIGlmIGxpY2Vuc2UgaXMgYWN0aXZlXG4gICAgY29uc3QgaXNMaWNlbnNlQWN0aXZlID0gKGV4cGlyYXRpb25EYXRlOiBEYXRlKTogYm9vbGVhbiA9PiB7XG4gICAgICBjb25zdCB0b2RheSA9IG5ldyBEYXRlKCk7XG4gICAgICByZXR1cm4gZXhwaXJhdGlvbkRhdGUgPiB0b2RheTtcbiAgICB9O1xuXG4gICAgY29uc3QgdHJhbnNmb3JtZWRBcHBsaWNhdGlvbnM6IFRoZXJhcGlzdEFwcGxpY2F0aW9uUmVzcG9uc2VbXSA9XG4gICAgICBhd2FpdCBQcm9taXNlLmFsbChcbiAgICAgICAgYXBwbGljYXRpb25zLm1hcChhc3luYyAoYXBwKSA9PiB7XG4gICAgICAgICAgY29uc3QgZmlsZXMgPSBhd2FpdCB0aGlzLmdldEFwcGxpY2F0aW9uRmlsZXMoYXBwLnVzZXJJZCk7XG5cbiAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgaWQ6IGFwcC51c2VySWQsXG4gICAgICAgICAgICBzdGF0dXM6IGFwcC5zdGF0dXMsXG4gICAgICAgICAgICBzdWJtaXNzaW9uRGF0ZTogYXBwLnN1Ym1pc3Npb25EYXRlLnRvSVNPU3RyaW5nKCksXG4gICAgICAgICAgICBwcm9jZXNzaW5nRGF0ZTogYXBwLnByb2Nlc3NpbmdEYXRlPy50b0lTT1N0cmluZygpLFxuICAgICAgICAgICAgZmlyc3ROYW1lOiBhcHAudXNlci5maXJzdE5hbWUgfHwgJycsXG4gICAgICAgICAgICBsYXN0TmFtZTogYXBwLnVzZXIubGFzdE5hbWUgfHwgJycsXG4gICAgICAgICAgICBlbWFpbDogYXBwLnVzZXIuZW1haWwsXG4gICAgICAgICAgICBtb2JpbGU6IGFwcC5tb2JpbGUsXG4gICAgICAgICAgICBwcm92aW5jZTogYXBwLnByb3ZpbmNlLFxuICAgICAgICAgICAgcHJvdmlkZXJUeXBlOiBhcHAucHJvdmlkZXJUeXBlLFxuICAgICAgICAgICAgcHJvZmVzc2lvbmFsTGljZW5zZVR5cGU6IGFwcC5wcm9mZXNzaW9uYWxMaWNlbnNlVHlwZSxcbiAgICAgICAgICAgIGlzUFJDTGljZW5zZWQ6IGFwcC5pc1BSQ0xpY2Vuc2VkLFxuICAgICAgICAgICAgcHJjTGljZW5zZU51bWJlcjogYXBwLnByY0xpY2Vuc2VOdW1iZXIsXG4gICAgICAgICAgICBleHBpcmF0aW9uRGF0ZU9mTGljZW5zZTogYXBwLmV4cGlyYXRpb25EYXRlT2ZMaWNlbnNlLnRvSVNPU3RyaW5nKCksXG4gICAgICAgICAgICBpc0xpY2Vuc2VBY3RpdmU6IGlzTGljZW5zZUFjdGl2ZShhcHAuZXhwaXJhdGlvbkRhdGVPZkxpY2Vuc2UpXG4gICAgICAgICAgICAgID8gJ3llcydcbiAgICAgICAgICAgICAgOiAnbm8nLFxuICAgICAgICAgICAgcHJhY3RpY2VTdGFydERhdGU6IGFwcC5wcmFjdGljZVN0YXJ0RGF0ZS50b0lTT1N0cmluZygpLFxuICAgICAgICAgICAgeWVhcnNPZkV4cGVyaWVuY2U6IGFwcC55ZWFyc09mRXhwZXJpZW5jZT8udG9TdHJpbmcoKSB8fCAnTi9BJyxcbiAgICAgICAgICAgIGFyZWFzT2ZFeHBlcnRpc2U6IGFwcC5hcmVhc09mRXhwZXJ0aXNlIHx8IFtdLFxuICAgICAgICAgICAgYXNzZXNzbWVudFRvb2xzOiBhcHAuYXNzZXNzbWVudFRvb2xzIHx8IFtdLFxuICAgICAgICAgICAgdGhlcmFwZXV0aWNBcHByb2FjaGVzVXNlZExpc3Q6XG4gICAgICAgICAgICAgIGFwcC50aGVyYXBldXRpY0FwcHJvYWNoZXNVc2VkTGlzdCB8fCBbXSxcbiAgICAgICAgICAgIGxhbmd1YWdlc09mZmVyZWQ6IGFwcC5sYW5ndWFnZXNPZmZlcmVkIHx8IFtdLFxuICAgICAgICAgICAgcHJvdmlkZWRPbmxpbmVUaGVyYXB5QmVmb3JlOiBhcHAucHJvdmlkZWRPbmxpbmVUaGVyYXB5QmVmb3JlXG4gICAgICAgICAgICAgID8gJ3llcydcbiAgICAgICAgICAgICAgOiAnbm8nLFxuICAgICAgICAgICAgY29tZm9ydGFibGVVc2luZ1ZpZGVvQ29uZmVyZW5jaW5nOlxuICAgICAgICAgICAgICBhcHAuY29tZm9ydGFibGVVc2luZ1ZpZGVvQ29uZmVyZW5jaW5nID8gJ3llcycgOiAnbm8nLFxuICAgICAgICAgICAgd2Vla2x5QXZhaWxhYmlsaXR5OiAnZmxleGlibGUnLCAvLyBEZWZhdWx0IHZhbHVlXG4gICAgICAgICAgICBwcmVmZXJyZWRTZXNzaW9uTGVuZ3RoOiBhcHAuc2Vzc2lvbkxlbmd0aCxcbiAgICAgICAgICAgIGFjY2VwdHM6IGFwcC5hY2NlcHRUeXBlcyB8fCBbXSxcbiAgICAgICAgICAgIHByaXZhdGVDb25maWRlbnRpYWxTcGFjZTogYXBwLnByaXZhdGVDb25maWRlbnRpYWxTcGFjZSB8fCAnTi9BJyxcbiAgICAgICAgICAgIGNvbXBsaWVzV2l0aERhdGFQcml2YWN5QWN0OiBhcHAuY29tcGxpZXNXaXRoRGF0YVByaXZhY3lBY3RcbiAgICAgICAgICAgICAgPyAneWVzJ1xuICAgICAgICAgICAgICA6ICdubycsXG4gICAgICAgICAgICBwcm9mZXNzaW9uYWxMaWFiaWxpdHlJbnN1cmFuY2U6XG4gICAgICAgICAgICAgIGFwcC5wcm9mZXNzaW9uYWxMaWFiaWxpdHlJbnN1cmFuY2UgfHwgJ04vQScsXG4gICAgICAgICAgICBjb21wbGFpbnRzT3JEaXNjaXBsaW5hcnlBY3Rpb25zOlxuICAgICAgICAgICAgICBhcHAuY29tcGxhaW50c09yRGlzY2lwbGluYXJ5QWN0aW9ucyB8fCAnTi9BJyxcbiAgICAgICAgICAgIHdpbGxpbmdUb0FiaWRlQnlQbGF0Zm9ybUd1aWRlbGluZXM6XG4gICAgICAgICAgICAgIGFwcC53aWxsaW5nVG9BYmlkZUJ5UGxhdGZvcm1HdWlkZWxpbmVzID8gJ3llcycgOiAnbm8nLFxuICAgICAgICAgICAgYmlvOiBhcHAuZWR1Y2F0aW9uQmFja2dyb3VuZCB8fCB1bmRlZmluZWQsXG4gICAgICAgICAgICBob3VybHlSYXRlOiBhcHAuaG91cmx5UmF0ZSA/IE51bWJlcihhcHAuaG91cmx5UmF0ZSkgOiB1bmRlZmluZWQsXG4gICAgICAgICAgICBmaWxlczogZmlsZXMsXG4gICAgICAgICAgfTtcbiAgICAgICAgfSksXG4gICAgICApO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIGFwcGxpY2F0aW9uczogdHJhbnNmb3JtZWRBcHBsaWNhdGlvbnMsXG4gICAgICB0b3RhbENvdW50LFxuICAgICAgcGFnZSxcbiAgICAgIHRvdGFsUGFnZXM6IE1hdGguY2VpbCh0b3RhbENvdW50IC8gbGltaXQpLFxuICAgIH07XG4gIH1cblxuICBhc3luYyBnZXRBcHBsaWNhdGlvbkJ5SWQoXG4gICAgaWQ6IHN0cmluZyxcbiAgKTogUHJvbWlzZTxUaGVyYXBpc3RBcHBsaWNhdGlvblJlc3BvbnNlIHwgbnVsbD4ge1xuICAgIGNvbnN0IGFwcGxpY2F0aW9uID0gYXdhaXQgdGhpcy5wcmlzbWEudGhlcmFwaXN0LmZpbmRVbmlxdWUoe1xuICAgICAgd2hlcmU6IHsgdXNlcklkOiBpZCB9LFxuICAgICAgaW5jbHVkZToge1xuICAgICAgICB1c2VyOiB0cnVlLFxuICAgICAgfSxcbiAgICB9KTtcblxuICAgIGlmICghYXBwbGljYXRpb24pIHtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cblxuICAgIGNvbnN0IGZpbGVzID0gYXdhaXQgdGhpcy5nZXRBcHBsaWNhdGlvbkZpbGVzKGFwcGxpY2F0aW9uLnVzZXJJZCk7XG5cbiAgICAvLyBIZWxwZXIgZnVuY3Rpb24gdG8gZGV0ZXJtaW5lIGlmIGxpY2Vuc2UgaXMgYWN0aXZlXG4gICAgY29uc3QgaXNMaWNlbnNlQWN0aXZlID0gKGV4cGlyYXRpb25EYXRlOiBEYXRlKTogYm9vbGVhbiA9PiB7XG4gICAgICBjb25zdCB0b2RheSA9IG5ldyBEYXRlKCk7XG4gICAgICByZXR1cm4gZXhwaXJhdGlvbkRhdGUgPiB0b2RheTtcbiAgICB9O1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIGlkOiBhcHBsaWNhdGlvbi51c2VySWQsXG4gICAgICBzdGF0dXM6IGFwcGxpY2F0aW9uLnN0YXR1cyxcbiAgICAgIHN1Ym1pc3Npb25EYXRlOiBhcHBsaWNhdGlvbi5zdWJtaXNzaW9uRGF0ZS50b0lTT1N0cmluZygpLFxuICAgICAgcHJvY2Vzc2luZ0RhdGU6IGFwcGxpY2F0aW9uLnByb2Nlc3NpbmdEYXRlPy50b0lTT1N0cmluZygpLFxuICAgICAgZmlyc3ROYW1lOiBhcHBsaWNhdGlvbi51c2VyLmZpcnN0TmFtZSB8fCAnJyxcbiAgICAgIGxhc3ROYW1lOiBhcHBsaWNhdGlvbi51c2VyLmxhc3ROYW1lIHx8ICcnLFxuICAgICAgZW1haWw6IGFwcGxpY2F0aW9uLnVzZXIuZW1haWwsXG4gICAgICBtb2JpbGU6IGFwcGxpY2F0aW9uLm1vYmlsZSxcbiAgICAgIHByb3ZpbmNlOiBhcHBsaWNhdGlvbi5wcm92aW5jZSxcbiAgICAgIHByb3ZpZGVyVHlwZTogYXBwbGljYXRpb24ucHJvdmlkZXJUeXBlLFxuICAgICAgcHJvZmVzc2lvbmFsTGljZW5zZVR5cGU6IGFwcGxpY2F0aW9uLnByb2Zlc3Npb25hbExpY2Vuc2VUeXBlLFxuICAgICAgaXNQUkNMaWNlbnNlZDogYXBwbGljYXRpb24uaXNQUkNMaWNlbnNlZCxcbiAgICAgIHByY0xpY2Vuc2VOdW1iZXI6IGFwcGxpY2F0aW9uLnByY0xpY2Vuc2VOdW1iZXIsXG4gICAgICBleHBpcmF0aW9uRGF0ZU9mTGljZW5zZTpcbiAgICAgICAgYXBwbGljYXRpb24uZXhwaXJhdGlvbkRhdGVPZkxpY2Vuc2UudG9JU09TdHJpbmcoKSxcbiAgICAgIGlzTGljZW5zZUFjdGl2ZTogaXNMaWNlbnNlQWN0aXZlKGFwcGxpY2F0aW9uLmV4cGlyYXRpb25EYXRlT2ZMaWNlbnNlKVxuICAgICAgICA/ICd5ZXMnXG4gICAgICAgIDogJ25vJyxcbiAgICAgIHByYWN0aWNlU3RhcnREYXRlOiBhcHBsaWNhdGlvbi5wcmFjdGljZVN0YXJ0RGF0ZS50b0lTT1N0cmluZygpLFxuICAgICAgeWVhcnNPZkV4cGVyaWVuY2U6IGFwcGxpY2F0aW9uLnllYXJzT2ZFeHBlcmllbmNlPy50b1N0cmluZygpIHx8ICdOL0EnLFxuICAgICAgYXJlYXNPZkV4cGVydGlzZTogYXBwbGljYXRpb24uYXJlYXNPZkV4cGVydGlzZSB8fCBbXSxcbiAgICAgIGFzc2Vzc21lbnRUb29sczogYXBwbGljYXRpb24uYXNzZXNzbWVudFRvb2xzIHx8IFtdLFxuICAgICAgdGhlcmFwZXV0aWNBcHByb2FjaGVzVXNlZExpc3Q6XG4gICAgICAgIGFwcGxpY2F0aW9uLnRoZXJhcGV1dGljQXBwcm9hY2hlc1VzZWRMaXN0IHx8IFtdLFxuICAgICAgbGFuZ3VhZ2VzT2ZmZXJlZDogYXBwbGljYXRpb24ubGFuZ3VhZ2VzT2ZmZXJlZCB8fCBbXSxcbiAgICAgIHByb3ZpZGVkT25saW5lVGhlcmFweUJlZm9yZTogYXBwbGljYXRpb24ucHJvdmlkZWRPbmxpbmVUaGVyYXB5QmVmb3JlXG4gICAgICAgID8gJ3llcydcbiAgICAgICAgOiAnbm8nLFxuICAgICAgY29tZm9ydGFibGVVc2luZ1ZpZGVvQ29uZmVyZW5jaW5nOlxuICAgICAgICBhcHBsaWNhdGlvbi5jb21mb3J0YWJsZVVzaW5nVmlkZW9Db25mZXJlbmNpbmcgPyAneWVzJyA6ICdubycsXG4gICAgICB3ZWVrbHlBdmFpbGFiaWxpdHk6ICdmbGV4aWJsZScsXG4gICAgICBwcmVmZXJyZWRTZXNzaW9uTGVuZ3RoOiBhcHBsaWNhdGlvbi5zZXNzaW9uTGVuZ3RoLFxuICAgICAgYWNjZXB0czogYXBwbGljYXRpb24uYWNjZXB0VHlwZXMgfHwgW10sXG4gICAgICBwcml2YXRlQ29uZmlkZW50aWFsU3BhY2U6IGFwcGxpY2F0aW9uLnByaXZhdGVDb25maWRlbnRpYWxTcGFjZSB8fCAnTi9BJyxcbiAgICAgIGNvbXBsaWVzV2l0aERhdGFQcml2YWN5QWN0OiBhcHBsaWNhdGlvbi5jb21wbGllc1dpdGhEYXRhUHJpdmFjeUFjdFxuICAgICAgICA/ICd5ZXMnXG4gICAgICAgIDogJ25vJyxcbiAgICAgIHByb2Zlc3Npb25hbExpYWJpbGl0eUluc3VyYW5jZTpcbiAgICAgICAgYXBwbGljYXRpb24ucHJvZmVzc2lvbmFsTGlhYmlsaXR5SW5zdXJhbmNlIHx8ICdOL0EnLFxuICAgICAgY29tcGxhaW50c09yRGlzY2lwbGluYXJ5QWN0aW9uczpcbiAgICAgICAgYXBwbGljYXRpb24uY29tcGxhaW50c09yRGlzY2lwbGluYXJ5QWN0aW9ucyB8fCAnTi9BJyxcbiAgICAgIHdpbGxpbmdUb0FiaWRlQnlQbGF0Zm9ybUd1aWRlbGluZXM6XG4gICAgICAgIGFwcGxpY2F0aW9uLndpbGxpbmdUb0FiaWRlQnlQbGF0Zm9ybUd1aWRlbGluZXMgPyAneWVzJyA6ICdubycsXG4gICAgICBiaW86IGFwcGxpY2F0aW9uLmVkdWNhdGlvbkJhY2tncm91bmQgfHwgdW5kZWZpbmVkLFxuICAgICAgaG91cmx5UmF0ZTogYXBwbGljYXRpb24uaG91cmx5UmF0ZVxuICAgICAgICA/IE51bWJlcihhcHBsaWNhdGlvbi5ob3VybHlSYXRlKVxuICAgICAgICA6IHVuZGVmaW5lZCxcbiAgICAgIGZpbGVzOiBmaWxlcyxcbiAgICB9O1xuICB9XG5cbiAgYXN5bmMgdXBkYXRlQXBwbGljYXRpb25TdGF0dXMoXG4gICAgaWQ6IHN0cmluZyxcbiAgICB1cGRhdGVEYXRhOiBBcHBsaWNhdGlvblN0YXR1c1VwZGF0ZUR0byxcbiAgKTogUHJvbWlzZTx7XG4gICAgc3VjY2VzczogYm9vbGVhbjtcbiAgICBtZXNzYWdlOiBzdHJpbmc7XG4gICAgY3JlZGVudGlhbHM/OiB7IGVtYWlsOiBzdHJpbmc7IHBhc3N3b3JkOiBzdHJpbmcgfTtcbiAgfT4ge1xuICAgIGNvbnN0IGFwcGxpY2F0aW9uID0gYXdhaXQgdGhpcy5wcmlzbWEudGhlcmFwaXN0LmZpbmRVbmlxdWUoe1xuICAgICAgd2hlcmU6IHsgdXNlcklkOiBpZCB9LFxuICAgICAgaW5jbHVkZTogeyB1c2VyOiB0cnVlIH0sXG4gICAgfSk7XG5cbiAgICBpZiAoIWFwcGxpY2F0aW9uKSB7XG4gICAgICB0aHJvdyBuZXcgTm90Rm91bmRFeGNlcHRpb24oJ0FwcGxpY2F0aW9uIG5vdCBmb3VuZCcpO1xuICAgIH1cblxuICAgIHRyeSB7XG4gICAgICAvLyBVcGRhdGUgYXBwbGljYXRpb24gc3RhdHVzXG4gICAgICBhd2FpdCB0aGlzLnByaXNtYS50aGVyYXBpc3QudXBkYXRlKHtcbiAgICAgICAgd2hlcmU6IHsgdXNlcklkOiBpZCB9LFxuICAgICAgICBkYXRhOiB7XG4gICAgICAgICAgc3RhdHVzOiB1cGRhdGVEYXRhLnN0YXR1cyxcbiAgICAgICAgICBwcm9jZXNzaW5nRGF0ZTogbmV3IERhdGUoKSxcbiAgICAgICAgfSxcbiAgICAgIH0pO1xuXG4gICAgICBsZXQgcmVzdWx0OiB7XG4gICAgICAgIHN1Y2Nlc3M6IGJvb2xlYW47XG4gICAgICAgIG1lc3NhZ2U6IHN0cmluZztcbiAgICAgICAgY3JlZGVudGlhbHM/OiB7IGVtYWlsOiBzdHJpbmc7IHBhc3N3b3JkOiBzdHJpbmcgfTtcbiAgICAgIH0gPSB7XG4gICAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICAgIG1lc3NhZ2U6IGBBcHBsaWNhdGlvbiAke3VwZGF0ZURhdGEuc3RhdHVzfSBzdWNjZXNzZnVsbHlgLFxuICAgICAgfTtcblxuICAgICAgLy8gSGFuZGxlIHN0YXR1cy1zcGVjaWZpYyBhY3Rpb25zIGFuZCBub3RpZmljYXRpb25zXG4gICAgICBpZiAodXBkYXRlRGF0YS5zdGF0dXMgPT09ICdhcHByb3ZlZCcpIHtcbiAgICAgICAgLy8gQ3JlYXRlIENsZXJrIGFjY291bnQgZm9yIGFwcHJvdmVkIHRoZXJhcGlzdFxuICAgICAgICBjb25zdCB0ZW1wb3JhcnlQYXNzd29yZCA9IHRoaXMuZ2VuZXJhdGVUZW1wb3JhcnlQYXNzd29yZCgpO1xuICAgICAgICBsZXQgY2xlcmtVc2VySWQ6IHN0cmluZyB8IG51bGwgPSBudWxsO1xuXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgLy8gQ3JlYXRlIENsZXJrIHVzZXIgYWNjb3VudFxuICAgICAgICAgIGNvbnN0IGNsZXJrVXNlciA9IGF3YWl0IHRoaXMuY3JlYXRlQ2xlcmtUaGVyYXBpc3RBY2NvdW50KFxuICAgICAgICAgICAgYXBwbGljYXRpb24udXNlci5lbWFpbCxcbiAgICAgICAgICAgIGAke2FwcGxpY2F0aW9uLnVzZXIuZmlyc3ROYW1lIHx8ICcnfSAke2FwcGxpY2F0aW9uLnVzZXIubGFzdE5hbWUgfHwgJyd9YC50cmltKCksXG4gICAgICAgICAgICB0ZW1wb3JhcnlQYXNzd29yZCxcbiAgICAgICAgICApO1xuXG4gICAgICAgICAgY2xlcmtVc2VySWQgPSBjbGVya1VzZXIuaWQ7XG4gICAgICAgICAgY29uc29sZS5sb2coJ0NsZXJrIGFjY291bnQgY3JlYXRlZCBzdWNjZXNzZnVsbHk6JywgY2xlcmtVc2VySWQpO1xuXG4gICAgICAgICAgLy8gVXBkYXRlIHVzZXIgcmVjb3JkIHRvIGNoYW5nZSByb2xlIHRvIHRoZXJhcGlzdCBhbmQgYWN0aXZhdGUgYWNjb3VudFxuICAgICAgICAgIGF3YWl0IHRoaXMucHJpc21hLnVzZXIudXBkYXRlKHtcbiAgICAgICAgICAgIHdoZXJlOiB7IGlkOiBhcHBsaWNhdGlvbi51c2VySWQgfSxcbiAgICAgICAgICAgIGRhdGE6IHtcbiAgICAgICAgICAgICAgcm9sZTogJ3RoZXJhcGlzdCcsXG4gICAgICAgICAgICAgIGlzQWN0aXZlOiB0cnVlLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9KTtcblxuICAgICAgICAgIGNvbnNvbGUubG9nKCdVc2VyIHJvbGUgdXBkYXRlZCB0byB0aGVyYXBpc3QnKTtcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICBjb25zb2xlLmVycm9yKCdFcnJvciBjcmVhdGluZyBDbGVyayBhY2NvdW50OicsIGVycm9yKTtcbiAgICAgICAgICAvLyBDb250aW51ZSB3aXRoIHRoZSBwcm9jZXNzIGJ1dCBub3RlIHRoZSBlcnJvclxuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgY3JlZGVudGlhbHMgPSB7XG4gICAgICAgICAgZW1haWw6IGFwcGxpY2F0aW9uLnVzZXIuZW1haWwsXG4gICAgICAgICAgcGFzc3dvcmQ6IHRlbXBvcmFyeVBhc3N3b3JkLFxuICAgICAgICB9O1xuXG4gICAgICAgIHJlc3VsdCA9IHtcbiAgICAgICAgICAuLi5yZXN1bHQsXG4gICAgICAgICAgbWVzc2FnZTpcbiAgICAgICAgICAgICdBcHBsaWNhdGlvbiBhcHByb3ZlZCBzdWNjZXNzZnVsbHkuIFRoZXJhcGlzdCBhY2NvdW50IGNyZWF0ZWQgYW5kIGNyZWRlbnRpYWxzIGdlbmVyYXRlZC4nLFxuICAgICAgICAgIGNyZWRlbnRpYWxzLFxuICAgICAgICB9O1xuXG4gICAgICAgIC8vIFNlbmQgYXBwcm92YWwgZW1haWwgbm90aWZpY2F0aW9uIHdpdGggY3JlZGVudGlhbHNcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICBhd2FpdCB0aGlzLmVtYWlsU2VydmljZS5zZW5kVGhlcmFwaXN0V2VsY29tZUVtYWlsKFxuICAgICAgICAgICAgYXBwbGljYXRpb24udXNlci5lbWFpbCxcbiAgICAgICAgICAgIGAke2FwcGxpY2F0aW9uLnVzZXIuZmlyc3ROYW1lIHx8ICcnfSAke2FwcGxpY2F0aW9uLnVzZXIubGFzdE5hbWUgfHwgJyd9YC50cmltKCkgfHxcbiAgICAgICAgICAgICAgJ1RoZXJhcGlzdCcsXG4gICAgICAgICAgICBjcmVkZW50aWFscyxcbiAgICAgICAgICApO1xuICAgICAgICAgIGNvbnNvbGUubG9nKCdBcHByb3ZhbCBlbWFpbCBub3RpZmljYXRpb24gc2VudCBzdWNjZXNzZnVsbHknKTtcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICBjb25zb2xlLmVycm9yKCdGYWlsZWQgdG8gc2VuZCBhcHByb3ZhbCBlbWFpbCBub3RpZmljYXRpb246JywgZXJyb3IpO1xuICAgICAgICAgIC8vIERvbid0IGZhaWwgdGhlIGVudGlyZSBvcGVyYXRpb24gaWYgZW1haWwgZmFpbHNcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIGlmICh1cGRhdGVEYXRhLnN0YXR1cyA9PT0gJ3JlamVjdGVkJykge1xuICAgICAgICAvLyBTZW5kIHJlamVjdGlvbiBlbWFpbCBub3RpZmljYXRpb25cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICBhd2FpdCB0aGlzLmVtYWlsU2VydmljZS5zZW5kVGhlcmFwaXN0UmVqZWN0aW9uRW1haWwoXG4gICAgICAgICAgICBhcHBsaWNhdGlvbi51c2VyLmVtYWlsLFxuICAgICAgICAgICAgYCR7YXBwbGljYXRpb24udXNlci5maXJzdE5hbWUgfHwgJyd9ICR7YXBwbGljYXRpb24udXNlci5sYXN0TmFtZSB8fCAnJ31gLnRyaW0oKSB8fFxuICAgICAgICAgICAgICAnVGhlcmFwaXN0JyxcbiAgICAgICAgICAgIHVwZGF0ZURhdGEuYWRtaW5Ob3RlcyxcbiAgICAgICAgICApO1xuICAgICAgICAgIGNvbnNvbGUubG9nKCdSZWplY3Rpb24gZW1haWwgbm90aWZpY2F0aW9uIHNlbnQgc3VjY2Vzc2Z1bGx5Jyk7XG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgY29uc29sZS5lcnJvcignRmFpbGVkIHRvIHNlbmQgcmVqZWN0aW9uIGVtYWlsIG5vdGlmaWNhdGlvbjonLCBlcnJvcik7XG4gICAgICAgICAgLy8gRG9uJ3QgZmFpbCB0aGUgZW50aXJlIG9wZXJhdGlvbiBpZiBlbWFpbCBmYWlsc1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIHVwZGF0aW5nIGFwcGxpY2F0aW9uIHN0YXR1czonLCBlcnJvcik7XG4gICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdEV4Y2VwdGlvbignRmFpbGVkIHRvIHVwZGF0ZSBhcHBsaWNhdGlvbiBzdGF0dXMnKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogQGRlcHJlY2F0ZWQgVXNlIGNyZWF0ZUFwcGxpY2F0aW9uV2l0aERvY3VtZW50cyBmb3IgbmV3IGltcGxlbWVudGF0aW9ucyAtIHRoaXMgbWV0aG9kIGlzIGtlcHQgZm9yIGFkbWluL2xlZ2FjeSBzdXBwb3J0IG9ubHlcbiAgICovXG4gIGFzeW5jIHVwbG9hZERvY3VtZW50cyhcbiAgICB1c2VySWQ6IHN0cmluZyxcbiAgICBmaWxlczogRXhwcmVzcy5NdWx0ZXIuRmlsZVtdLFxuICAgIGZpbGVUeXBlTWFwOiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+ID0ge30sXG4gICk6IFByb21pc2U8QXJyYXk8eyBpZDogc3RyaW5nOyBmaWxlTmFtZTogc3RyaW5nOyB1cmw6IHN0cmluZyB9Pj4ge1xuICAgIC8vIFZlcmlmeSB0aGVyYXBpc3QgYXBwbGljYXRpb24gZXhpc3RzXG4gICAgY29uc3QgYXBwbGljYXRpb24gPSBhd2FpdCB0aGlzLnByaXNtYS50aGVyYXBpc3QuZmluZFVuaXF1ZSh7XG4gICAgICB3aGVyZTogeyB1c2VySWQgfSxcbiAgICB9KTtcblxuICAgIGlmICghYXBwbGljYXRpb24pIHtcbiAgICAgIHRocm93IG5ldyBOb3RGb3VuZEV4Y2VwdGlvbignVGhlcmFwaXN0IGFwcGxpY2F0aW9uIG5vdCBmb3VuZCcpO1xuICAgIH1cblxuICAgIC8vIENyZWF0ZSB1cGxvYWRzIGRpcmVjdG9yeSBpZiBpdCBkb2Vzbid0IGV4aXN0XG4gICAgY29uc3QgdXBsb2Fkc0RpciA9IHBhdGguam9pbihcbiAgICAgIHByb2Nlc3MuY3dkKCksXG4gICAgICAndXBsb2FkcycsXG4gICAgICAndGhlcmFwaXN0LWRvY3VtZW50cycsXG4gICAgKTtcbiAgICBpZiAoIWZzLmV4aXN0c1N5bmModXBsb2Fkc0RpcikpIHtcbiAgICAgIGZzLm1rZGlyU3luYyh1cGxvYWRzRGlyLCB7IHJlY3Vyc2l2ZTogdHJ1ZSB9KTtcbiAgICB9XG5cbiAgICBjb25zdCB1cGxvYWRlZEZpbGVzOiBBcnJheTx7IGlkOiBzdHJpbmc7IGZpbGVOYW1lOiBzdHJpbmc7IHVybDogc3RyaW5nIH0+ID1cbiAgICAgIFtdO1xuXG4gICAgZm9yIChjb25zdCBmaWxlIG9mIGZpbGVzKSB7XG4gICAgICB0cnkge1xuICAgICAgICBjb25zdCBmaWxlTmFtZSA9IGAke0RhdGUubm93KCl9LSR7ZmlsZS5vcmlnaW5hbG5hbWV9YDtcbiAgICAgICAgY29uc3QgZmlsZVBhdGggPSBwYXRoLmpvaW4odXBsb2Fkc0RpciwgZmlsZU5hbWUpO1xuXG4gICAgICAgIC8vIFNhdmUgZmlsZSB0byBkaXNrXG4gICAgICAgIGZzLndyaXRlRmlsZVN5bmMoZmlsZVBhdGgsIGZpbGUuYnVmZmVyKTtcblxuICAgICAgICAvLyBDcmVhdGUgZmlsZSByZWNvcmQgdXNpbmcgbW9kZXJuIEZpbGUgc3lzdGVtXG4gICAgICAgIGNvbnN0IGZpbGVSZWNvcmQgPSBhd2FpdCB0aGlzLnByaXNtYS5maWxlLmNyZWF0ZSh7XG4gICAgICAgICAgZGF0YToge1xuICAgICAgICAgICAgZmlsZW5hbWU6IGZpbGUub3JpZ2luYWxuYW1lLFxuICAgICAgICAgICAgZGlzcGxheU5hbWU6IGZpbGUub3JpZ2luYWxuYW1lLFxuICAgICAgICAgICAgbWltZVR5cGU6IGZpbGUubWltZXR5cGUsXG4gICAgICAgICAgICBzaXplOiBmaWxlLnNpemUsXG4gICAgICAgICAgICBzdG9yYWdlUGF0aDogYHVwbG9hZHMvdGhlcmFwaXN0LWRvY3VtZW50cy8ke2ZpbGVOYW1lfWAsXG4gICAgICAgICAgICB1cGxvYWRlZEJ5OiB1c2VySWQsXG4gICAgICAgICAgICBzdGF0dXM6IEZpbGVTdGF0dXMuVVBMT0FERUQsXG4gICAgICAgICAgfSxcbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy8gRGV0ZXJtaW5lIHRoZSBwdXJwb3NlIGJhc2VkIG9uIGZpbGUgdHlwZSBtYXBwaW5nXG4gICAgICAgIGNvbnN0IGZpbGVUeXBlID0gZmlsZVR5cGVNYXBbZmlsZS5vcmlnaW5hbG5hbWVdIHx8ICdkb2N1bWVudCc7XG4gICAgICAgIGNvbnN0IHB1cnBvc2UgPSB0aGlzLm1hcEZpbGVUeXBlVG9QdXJwb3NlKGZpbGVUeXBlKTtcblxuICAgICAgICAvLyBBdHRhY2ggZmlsZSB0byB0aGVyYXBpc3QgYXBwbGljYXRpb25cbiAgICAgICAgYXdhaXQgdGhpcy5wcmlzbWEuZmlsZUF0dGFjaG1lbnQuY3JlYXRlKHtcbiAgICAgICAgICBkYXRhOiB7XG4gICAgICAgICAgICBmaWxlSWQ6IGZpbGVSZWNvcmQuaWQsXG4gICAgICAgICAgICBlbnRpdHlUeXBlOiBBdHRhY2htZW50RW50aXR5VHlwZS5USEVSQVBJU1RfQVBQTElDQVRJT04sXG4gICAgICAgICAgICBlbnRpdHlJZDogdXNlcklkLFxuICAgICAgICAgICAgcHVycG9zZTogcHVycG9zZSxcbiAgICAgICAgICB9LFxuICAgICAgICB9KTtcblxuICAgICAgICB1cGxvYWRlZEZpbGVzLnB1c2goe1xuICAgICAgICAgIGlkOiBmaWxlUmVjb3JkLmlkLFxuICAgICAgICAgIGZpbGVOYW1lOiBmaWxlLm9yaWdpbmFsbmFtZSxcbiAgICAgICAgICB1cmw6IGAvYXBpL2ZpbGVzL3NlcnZlLyR7ZmlsZVJlY29yZC5pZH1gLCAvLyBVc2UgcHJvdGVjdGVkIGVuZHBvaW50XG4gICAgICAgIH0pO1xuICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgY29uc29sZS5lcnJvcignRXJyb3IgdXBsb2FkaW5nIGZpbGU6JywgZXJyb3IpO1xuICAgICAgICAvLyBDb250aW51ZSB3aXRoIG90aGVyIGZpbGVzIGV2ZW4gaWYgb25lIGZhaWxzXG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIHVwbG9hZGVkRmlsZXM7XG4gIH1cblxuICBhc3luYyBnZXRBcHBsaWNhdGlvbkZpbGVzKGFwcGxpY2F0aW9uSWQ6IHN0cmluZykge1xuICAgIGNvbnN0IGF0dGFjaG1lbnRzID0gYXdhaXQgdGhpcy5wcmlzbWEuZmlsZUF0dGFjaG1lbnQuZmluZE1hbnkoe1xuICAgICAgd2hlcmU6IHtcbiAgICAgICAgZW50aXR5VHlwZTogQXR0YWNobWVudEVudGl0eVR5cGUuVEhFUkFQSVNUX0FQUExJQ0FUSU9OLFxuICAgICAgICBlbnRpdHlJZDogYXBwbGljYXRpb25JZCxcbiAgICAgIH0sXG4gICAgICBpbmNsdWRlOiB7XG4gICAgICAgIGZpbGU6IHRydWUsXG4gICAgICB9LFxuICAgICAgb3JkZXJCeTogeyBjcmVhdGVkQXQ6ICdkZXNjJyB9LFxuICAgIH0pO1xuXG4gICAgcmV0dXJuIGF0dGFjaG1lbnRzLm1hcCgoYXR0YWNobWVudCkgPT4gKHtcbiAgICAgIGlkOiBhdHRhY2htZW50LmZpbGUuaWQsXG4gICAgICBmaWxlTmFtZTogYXR0YWNobWVudC5maWxlLmZpbGVuYW1lLFxuICAgICAgZmlsZVVybDogYC9hcGkvZmlsZXMvc2VydmUvJHthdHRhY2htZW50LmZpbGUuaWR9YCwgLy8gVXNlIHByb3RlY3RlZCBlbmRwb2ludFxuICAgICAgdXBsb2FkZWRBdDogYXR0YWNobWVudC5maWxlLmNyZWF0ZWRBdC50b0lTT1N0cmluZygpLFxuICAgIH0pKTtcbiAgfVxuXG4gIHByaXZhdGUgbWFwRmlsZVR5cGVUb1B1cnBvc2UoZmlsZVR5cGU6IHN0cmluZyk6IEF0dGFjaG1lbnRQdXJwb3NlIHtcbiAgICBjb25zdCB0eXBlTWFwcGluZzogUmVjb3JkPHN0cmluZywgQXR0YWNobWVudFB1cnBvc2U+ID0ge1xuICAgICAgbGljZW5zZTogQXR0YWNobWVudFB1cnBvc2UuTElDRU5TRSxcbiAgICAgIGNlcnRpZmljYXRlOiBBdHRhY2htZW50UHVycG9zZS5DRVJUSUZJQ0FURSxcbiAgICAgIGNlcnRpZmljYXRpb246IEF0dGFjaG1lbnRQdXJwb3NlLkNFUlRJRklDQVRFLFxuICAgICAgcmVzdW1lOiBBdHRhY2htZW50UHVycG9zZS5ET0NVTUVOVCxcbiAgICAgIGN2OiBBdHRhY2htZW50UHVycG9zZS5ET0NVTUVOVCxcbiAgICAgIHRyYW5zY3JpcHQ6IEF0dGFjaG1lbnRQdXJwb3NlLkRPQ1VNRU5ULFxuICAgICAgZGlwbG9tYTogQXR0YWNobWVudFB1cnBvc2UuQ0VSVElGSUNBVEUsXG4gICAgICBkZWdyZWU6IEF0dGFjaG1lbnRQdXJwb3NlLkNFUlRJRklDQVRFLFxuICAgIH07XG5cbiAgICByZXR1cm4gdHlwZU1hcHBpbmdbZmlsZVR5cGUudG9Mb3dlckNhc2UoKV0gfHwgQXR0YWNobWVudFB1cnBvc2UuRE9DVU1FTlQ7XG4gIH1cblxuICBhc3luYyBjcmVhdGVBcHBsaWNhdGlvbldpdGhEb2N1bWVudHMoXG4gICAgYXBwbGljYXRpb25EYXRhOiBUaGVyYXBpc3RBcHBsaWNhdGlvbkR0byxcbiAgICBmaWxlczogRXhwcmVzcy5NdWx0ZXIuRmlsZVtdLFxuICAgIGZpbGVUeXBlTWFwOiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+ID0ge30sXG4gICk6IFByb21pc2U8e1xuICAgIGFwcGxpY2F0aW9uOiBhbnk7XG4gICAgdXBsb2FkZWRGaWxlczogQXJyYXk8eyBpZDogc3RyaW5nOyBmaWxlTmFtZTogc3RyaW5nOyB1cmw6IHN0cmluZyB9PjtcbiAgfT4ge1xuICAgIC8vIFVzZSBkYXRhYmFzZSB0cmFuc2FjdGlvbiB0byBlbnN1cmUgYXRvbWljaXR5XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMucHJpc21hLiR0cmFuc2FjdGlvbihhc3luYyAocHJpc21hKSA9PiB7XG4gICAgICAvLyBDaGVjayBpZiB1c2VyIGFscmVhZHkgaGFzIGFuIGFwcGxpY2F0aW9uXG4gICAgICBjb25zdCBleGlzdGluZ0FwcGxpY2F0aW9uID0gYXdhaXQgcHJpc21hLnRoZXJhcGlzdC5maW5kVW5pcXVlKHtcbiAgICAgICAgd2hlcmU6IHsgdXNlcklkOiBhcHBsaWNhdGlvbkRhdGEudXNlcklkIH0sXG4gICAgICB9KTtcblxuICAgICAgaWYgKGV4aXN0aW5nQXBwbGljYXRpb24pIHtcbiAgICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFeGNlcHRpb24oXG4gICAgICAgICAgJ1VzZXIgYWxyZWFkeSBoYXMgYSB0aGVyYXBpc3QgYXBwbGljYXRpb24nLFxuICAgICAgICApO1xuICAgICAgfVxuXG4gICAgICAvLyBGb3IgcHVibGljIGFwcGxpY2F0aW9ucyAodGVtcG9yYXJ5IHVzZXIgSURzKSwgc2tpcCB1c2VyIGV4aXN0ZW5jZSBjaGVja1xuICAgICAgY29uc3QgaXNQdWJsaWNBcHBsaWNhdGlvbiA9IGFwcGxpY2F0aW9uRGF0YS51c2VySWQuc3RhcnRzV2l0aCgndGVtcF8nKTtcblxuICAgICAgaWYgKCFpc1B1YmxpY0FwcGxpY2F0aW9uKSB7XG4gICAgICAgIC8vIENoZWNrIGlmIHVzZXIgZXhpc3RzIGZvciBhdXRoZW50aWNhdGVkIGFwcGxpY2F0aW9uc1xuICAgICAgICBjb25zdCB1c2VyID0gYXdhaXQgcHJpc21hLnVzZXIuZmluZFVuaXF1ZSh7XG4gICAgICAgICAgd2hlcmU6IHsgaWQ6IGFwcGxpY2F0aW9uRGF0YS51c2VySWQgfSxcbiAgICAgICAgfSk7XG5cbiAgICAgICAgaWYgKCF1c2VyKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IE5vdEZvdW5kRXhjZXB0aW9uKCdVc2VyIG5vdCBmb3VuZCcpO1xuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICAvLyBGb3IgcHVibGljIGFwcGxpY2F0aW9ucywgY2hlY2sgaWYgc29tZW9uZSB3aXRoIHRoaXMgZW1haWwgYWxyZWFkeSBhcHBsaWVkXG4gICAgICAgIGNvbnN0IGV4aXN0aW5nQnlFbWFpbCA9IGF3YWl0IHByaXNtYS50aGVyYXBpc3QuZmluZEZpcnN0KHtcbiAgICAgICAgICB3aGVyZToge1xuICAgICAgICAgICAgT1I6IFtcbiAgICAgICAgICAgICAgeyB1c2VyOiB7IGVtYWlsOiBhcHBsaWNhdGlvbkRhdGEuZW1haWwgfSB9LFxuICAgICAgICAgICAgICAvLyBBbHNvIGNoZWNrIHRlbXAgdXNlciBJRHMgd2l0aCB0aGlzIGVtYWlsIHBhdHRlcm5cbiAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIHVzZXJJZDoge1xuICAgICAgICAgICAgICAgICAgY29udGFpbnM6IGFwcGxpY2F0aW9uRGF0YS5lbWFpbC5yZXBsYWNlKCdAJywgJ19hdF8nKSxcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgXSxcbiAgICAgICAgICB9LFxuICAgICAgICB9KTtcblxuICAgICAgICBpZiAoZXhpc3RpbmdCeUVtYWlsKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFeGNlcHRpb24oXG4gICAgICAgICAgICAnQW4gYXBwbGljYXRpb24gd2l0aCB0aGlzIGVtYWlsIGFscmVhZHkgZXhpc3RzJyxcbiAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIC8vIFByb2Nlc3MgdGhlIGFwcGxpY2F0aW9uIGRhdGFcbiAgICAgIGNvbnN0IGNvbnZlcnRlZERhdGEgPSB7XG4gICAgICAgIC4uLmFwcGxpY2F0aW9uRGF0YSxcbiAgICAgICAgcHJhY3RpY2VTdGFydERhdGU6IG5ldyBEYXRlKGFwcGxpY2F0aW9uRGF0YS5wcmFjdGljZVN0YXJ0RGF0ZSksXG4gICAgICAgIC8vIEhhbmRsZSBleHBpcmF0aW9uIGRhdGVcbiAgICAgICAgZXhwaXJhdGlvbkRhdGVPZkxpY2Vuc2U6IGFwcGxpY2F0aW9uRGF0YS5leHBpcmF0aW9uRGF0ZU9mTGljZW5zZVxuICAgICAgICAgID8gbmV3IERhdGUoYXBwbGljYXRpb25EYXRhLmV4cGlyYXRpb25EYXRlT2ZMaWNlbnNlKVxuICAgICAgICAgIDogbmV3IERhdGUoRGF0ZS5ub3coKSArIDM2NSAqIDI0ICogNjAgKiA2MCAqIDEwMDApLCAvLyBEZWZhdWx0IHRvIDEgeWVhciBmcm9tIG5vd1xuICAgICAgICAvLyBTZXQgZGVmYXVsdCB2YWx1ZXMgZm9yIHJlcXVpcmVkIGZpZWxkc1xuICAgICAgICBsaWNlbnNlVmVyaWZpZWQ6IGZhbHNlLFxuICAgICAgICBhY2NlcHRzSW5zdXJhbmNlOiBmYWxzZSxcbiAgICAgICAgaG91cmx5UmF0ZTogYXBwbGljYXRpb25EYXRhLmhvdXJseVJhdGUgfHwgMCxcbiAgICAgIH07XG5cbiAgICAgIC8vIEZvciBwdWJsaWMgYXBwbGljYXRpb25zLCBjcmVhdGUgdGhlIHVzZXIgcmVjb3JkIGZpcnN0XG4gICAgICBpZiAoaXNQdWJsaWNBcHBsaWNhdGlvbikge1xuICAgICAgICBhd2FpdCBwcmlzbWEudXNlci5jcmVhdGUoe1xuICAgICAgICAgIGRhdGE6IHtcbiAgICAgICAgICAgIGlkOiBjb252ZXJ0ZWREYXRhLnVzZXJJZCxcbiAgICAgICAgICAgIGVtYWlsOiBjb252ZXJ0ZWREYXRhLmVtYWlsLFxuICAgICAgICAgICAgZmlyc3ROYW1lOiBjb252ZXJ0ZWREYXRhLmZpcnN0TmFtZSxcbiAgICAgICAgICAgIGxhc3ROYW1lOiBjb252ZXJ0ZWREYXRhLmxhc3ROYW1lLFxuICAgICAgICAgICAgcm9sZTogJ2NsaWVudCcsIC8vIFRlbXBvcmFyeSByb2xlIHVudGlsIGFwcHJvdmVkXG4gICAgICAgICAgICBpc0FjdGl2ZTogZmFsc2UsIC8vIEluYWN0aXZlIHVudGlsIGFwcHJvdmVkXG4gICAgICAgICAgfSxcbiAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIC8vIENyZWF0ZSB0aGUgdGhlcmFwaXN0IGFwcGxpY2F0aW9uXG4gICAgICBjb25zdCBhcHBsaWNhdGlvbiA9IGF3YWl0IHByaXNtYS50aGVyYXBpc3QuY3JlYXRlKHtcbiAgICAgICAgZGF0YToge1xuICAgICAgICAgIHVzZXJJZDogY29udmVydGVkRGF0YS51c2VySWQsXG4gICAgICAgICAgbW9iaWxlOiBjb252ZXJ0ZWREYXRhLm1vYmlsZSxcbiAgICAgICAgICBwcm92aW5jZTogY29udmVydGVkRGF0YS5wcm92aW5jZSxcbiAgICAgICAgICBwcm92aWRlclR5cGU6IGNvbnZlcnRlZERhdGEucHJvdmlkZXJUeXBlLFxuICAgICAgICAgIHByb2Zlc3Npb25hbExpY2Vuc2VUeXBlOiBjb252ZXJ0ZWREYXRhLnByb2Zlc3Npb25hbExpY2Vuc2VUeXBlLFxuICAgICAgICAgIGlzUFJDTGljZW5zZWQ6IGNvbnZlcnRlZERhdGEuaXNQUkNMaWNlbnNlZCxcbiAgICAgICAgICBwcmNMaWNlbnNlTnVtYmVyOiBjb252ZXJ0ZWREYXRhLnByY0xpY2Vuc2VOdW1iZXIgfHwgJycsXG4gICAgICAgICAgcHJhY3RpY2VTdGFydERhdGU6IGNvbnZlcnRlZERhdGEucHJhY3RpY2VTdGFydERhdGUsXG4gICAgICAgICAgYXJlYXNPZkV4cGVydGlzZTogY29udmVydGVkRGF0YS5hcmVhc09mRXhwZXJ0aXNlLFxuICAgICAgICAgIGFzc2Vzc21lbnRUb29sczogY29udmVydGVkRGF0YS5hc3Nlc3NtZW50VG9vbHMsXG4gICAgICAgICAgdGhlcmFwZXV0aWNBcHByb2FjaGVzVXNlZExpc3Q6XG4gICAgICAgICAgICBjb252ZXJ0ZWREYXRhLnRoZXJhcGV1dGljQXBwcm9hY2hlc1VzZWRMaXN0LFxuICAgICAgICAgIGxhbmd1YWdlc09mZmVyZWQ6IGNvbnZlcnRlZERhdGEubGFuZ3VhZ2VzT2ZmZXJlZCxcbiAgICAgICAgICBwcm92aWRlZE9ubGluZVRoZXJhcHlCZWZvcmU6XG4gICAgICAgICAgICBjb252ZXJ0ZWREYXRhLnByb3ZpZGVkT25saW5lVGhlcmFweUJlZm9yZSxcbiAgICAgICAgICBjb21mb3J0YWJsZVVzaW5nVmlkZW9Db25mZXJlbmNpbmc6XG4gICAgICAgICAgICBjb252ZXJ0ZWREYXRhLmNvbWZvcnRhYmxlVXNpbmdWaWRlb0NvbmZlcmVuY2luZyxcbiAgICAgICAgICBwcml2YXRlQ29uZmlkZW50aWFsU3BhY2U6IGNvbnZlcnRlZERhdGEucHJpdmF0ZUNvbmZpZGVudGlhbFNwYWNlXG4gICAgICAgICAgICA/ICd5ZXMnXG4gICAgICAgICAgICA6ICdubycsXG4gICAgICAgICAgY29tcGxpZXNXaXRoRGF0YVByaXZhY3lBY3Q6IGNvbnZlcnRlZERhdGEuY29tcGxpZXNXaXRoRGF0YVByaXZhY3lBY3QsXG4gICAgICAgICAgcHJvZmVzc2lvbmFsTGlhYmlsaXR5SW5zdXJhbmNlOlxuICAgICAgICAgICAgY29udmVydGVkRGF0YS5wcm9mZXNzaW9uYWxMaWFiaWxpdHlJbnN1cmFuY2UsXG4gICAgICAgICAgY29tcGxhaW50c09yRGlzY2lwbGluYXJ5QWN0aW9uczpcbiAgICAgICAgICAgIGNvbnZlcnRlZERhdGEuY29tcGxhaW50c09yRGlzY2lwbGluYXJ5QWN0aW9ucyxcbiAgICAgICAgICB3aWxsaW5nVG9BYmlkZUJ5UGxhdGZvcm1HdWlkZWxpbmVzOlxuICAgICAgICAgICAgY29udmVydGVkRGF0YS53aWxsaW5nVG9BYmlkZUJ5UGxhdGZvcm1HdWlkZWxpbmVzLFxuICAgICAgICAgIHNlc3Npb25MZW5ndGg6IGNvbnZlcnRlZERhdGEucHJlZmVycmVkU2Vzc2lvbkxlbmd0aCxcbiAgICAgICAgICBob3VybHlSYXRlOiBjb252ZXJ0ZWREYXRhLmhvdXJseVJhdGUsXG4gICAgICAgICAgc3RhdHVzOiAncGVuZGluZycsXG4gICAgICAgICAgc3VibWlzc2lvbkRhdGU6IG5ldyBEYXRlKCksXG4gICAgICAgICAgcHJvY2Vzc2luZ0RhdGU6IG5ldyBEYXRlKCksXG4gICAgICAgICAgZXhwaXJhdGlvbkRhdGVPZkxpY2Vuc2U6IGNvbnZlcnRlZERhdGEuZXhwaXJhdGlvbkRhdGVPZkxpY2Vuc2UsXG4gICAgICAgICAgbGljZW5zZVZlcmlmaWVkOiBjb252ZXJ0ZWREYXRhLmxpY2Vuc2VWZXJpZmllZCxcbiAgICAgICAgICBhY2NlcHRzSW5zdXJhbmNlOiBjb252ZXJ0ZWREYXRhLmFjY2VwdHNJbnN1cmFuY2UsXG4gICAgICAgICAgYWNjZXB0ZWRJbnN1cmFuY2VUeXBlczogW10sXG4gICAgICAgICAgc3BlY2lhbENlcnRpZmljYXRpb25zOiBbXSxcbiAgICAgICAgICBleHBlcnRpc2U6IGNvbnZlcnRlZERhdGEuYXJlYXNPZkV4cGVydGlzZSxcbiAgICAgICAgICBhcHByb2FjaGVzOiBjb252ZXJ0ZWREYXRhLnRoZXJhcGV1dGljQXBwcm9hY2hlc1VzZWRMaXN0LFxuICAgICAgICAgIGxhbmd1YWdlczogY29udmVydGVkRGF0YS5sYW5ndWFnZXNPZmZlcmVkLFxuICAgICAgICAgIGlsbG5lc3NTcGVjaWFsaXphdGlvbnM6IFtdLFxuICAgICAgICAgIGFjY2VwdFR5cGVzOiBjb252ZXJ0ZWREYXRhLmFjY2VwdHMgfHwgW10sXG4gICAgICAgICAgdHJlYXRtZW50U3VjY2Vzc1JhdGVzOiB7fSxcbiAgICAgICAgICBwcmVmZXJyZWRTZXNzaW9uTGVuZ3RoOiBbMzAsIDQ1LCA2MF0sIC8vIERlZmF1bHQgc2Vzc2lvbiBsZW5ndGhzXG4gICAgICAgIH0sXG4gICAgICAgIGluY2x1ZGU6IHtcbiAgICAgICAgICB1c2VyOiB0cnVlLFxuICAgICAgICB9LFxuICAgICAgfSk7XG5cbiAgICAgIC8vIFByb2Nlc3MgYW5kIHVwbG9hZCBkb2N1bWVudHMgaWYgcHJvdmlkZWRcbiAgICAgIGNvbnN0IHVwbG9hZGVkRmlsZXM6IEFycmF5PHtcbiAgICAgICAgaWQ6IHN0cmluZztcbiAgICAgICAgZmlsZU5hbWU6IHN0cmluZztcbiAgICAgICAgdXJsOiBzdHJpbmc7XG4gICAgICB9PiA9IFtdO1xuXG4gICAgICBpZiAoZmlsZXMgJiYgZmlsZXMubGVuZ3RoID4gMCkge1xuICAgICAgICAvLyBDcmVhdGUgdXBsb2FkcyBkaXJlY3RvcnkgaWYgaXQgZG9lc24ndCBleGlzdFxuICAgICAgICBjb25zdCB1cGxvYWRzRGlyID0gcGF0aC5qb2luKFxuICAgICAgICAgIHByb2Nlc3MuY3dkKCksXG4gICAgICAgICAgJ3VwbG9hZHMnLFxuICAgICAgICAgICd0aGVyYXBpc3QtZG9jdW1lbnRzJyxcbiAgICAgICAgKTtcbiAgICAgICAgaWYgKCFmcy5leGlzdHNTeW5jKHVwbG9hZHNEaXIpKSB7XG4gICAgICAgICAgZnMubWtkaXJTeW5jKHVwbG9hZHNEaXIsIHsgcmVjdXJzaXZlOiB0cnVlIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgZm9yIChjb25zdCBmaWxlIG9mIGZpbGVzKSB7XG4gICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGNvbnN0IGZpbGVOYW1lID0gYCR7RGF0ZS5ub3coKX0tJHtmaWxlLm9yaWdpbmFsbmFtZX1gO1xuICAgICAgICAgICAgY29uc3QgZmlsZVBhdGggPSBwYXRoLmpvaW4odXBsb2Fkc0RpciwgZmlsZU5hbWUpO1xuXG4gICAgICAgICAgICAvLyBTYXZlIGZpbGUgdG8gZGlza1xuICAgICAgICAgICAgZnMud3JpdGVGaWxlU3luYyhmaWxlUGF0aCwgZmlsZS5idWZmZXIpO1xuXG4gICAgICAgICAgICAvLyBDcmVhdGUgZmlsZSByZWNvcmQgdXNpbmcgbW9kZXJuIEZpbGUgc3lzdGVtXG4gICAgICAgICAgICBjb25zdCBmaWxlUmVjb3JkID0gYXdhaXQgcHJpc21hLmZpbGUuY3JlYXRlKHtcbiAgICAgICAgICAgICAgZGF0YToge1xuICAgICAgICAgICAgICAgIGZpbGVuYW1lOiBmaWxlLm9yaWdpbmFsbmFtZSxcbiAgICAgICAgICAgICAgICBkaXNwbGF5TmFtZTogZmlsZS5vcmlnaW5hbG5hbWUsXG4gICAgICAgICAgICAgICAgbWltZVR5cGU6IGZpbGUubWltZXR5cGUsXG4gICAgICAgICAgICAgICAgc2l6ZTogZmlsZS5zaXplLFxuICAgICAgICAgICAgICAgIHN0b3JhZ2VQYXRoOiBgdXBsb2Fkcy90aGVyYXBpc3QtZG9jdW1lbnRzLyR7ZmlsZU5hbWV9YCxcbiAgICAgICAgICAgICAgICB1cGxvYWRlZEJ5OiBhcHBsaWNhdGlvbi51c2VySWQsXG4gICAgICAgICAgICAgICAgc3RhdHVzOiBGaWxlU3RhdHVzLlVQTE9BREVELFxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIC8vIERldGVybWluZSB0aGUgcHVycG9zZSBiYXNlZCBvbiBmaWxlIHR5cGUgbWFwcGluZ1xuICAgICAgICAgICAgY29uc3QgZmlsZVR5cGUgPSBmaWxlVHlwZU1hcFtmaWxlLm9yaWdpbmFsbmFtZV0gfHwgJ2RvY3VtZW50JztcbiAgICAgICAgICAgIGNvbnN0IHB1cnBvc2UgPSB0aGlzLm1hcEZpbGVUeXBlVG9QdXJwb3NlKGZpbGVUeXBlKTtcblxuICAgICAgICAgICAgLy8gQXR0YWNoIGZpbGUgdG8gdGhlcmFwaXN0IGFwcGxpY2F0aW9uXG4gICAgICAgICAgICBhd2FpdCBwcmlzbWEuZmlsZUF0dGFjaG1lbnQuY3JlYXRlKHtcbiAgICAgICAgICAgICAgZGF0YToge1xuICAgICAgICAgICAgICAgIGZpbGVJZDogZmlsZVJlY29yZC5pZCxcbiAgICAgICAgICAgICAgICBlbnRpdHlUeXBlOiBBdHRhY2htZW50RW50aXR5VHlwZS5USEVSQVBJU1RfQVBQTElDQVRJT04sXG4gICAgICAgICAgICAgICAgZW50aXR5SWQ6IGFwcGxpY2F0aW9uLnVzZXJJZCxcbiAgICAgICAgICAgICAgICBwdXJwb3NlOiBwdXJwb3NlLFxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIHVwbG9hZGVkRmlsZXMucHVzaCh7XG4gICAgICAgICAgICAgIGlkOiBmaWxlUmVjb3JkLmlkLFxuICAgICAgICAgICAgICBmaWxlTmFtZTogZmlsZS5vcmlnaW5hbG5hbWUsXG4gICAgICAgICAgICAgIHVybDogYC9hcGkvZmlsZXMvc2VydmUvJHtmaWxlUmVjb3JkLmlkfWAsIC8vIFVzZSBwcm90ZWN0ZWQgZW5kcG9pbnRcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKCdFcnJvciB1cGxvYWRpbmcgZmlsZTonLCBlcnJvcik7XG4gICAgICAgICAgICAvLyBJbiBhIHRyYW5zYWN0aW9uLCB0aGlzIHdpbGwgY2F1c2UgdGhlIGVudGlyZSBvcGVyYXRpb24gdG8gcm9sbGJhY2tcbiAgICAgICAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0RXhjZXB0aW9uKFxuICAgICAgICAgICAgICBgRmFpbGVkIHRvIHVwbG9hZCBmaWxlOiAke2ZpbGUub3JpZ2luYWxuYW1lfWAsXG4gICAgICAgICAgICApO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICByZXR1cm4ge1xuICAgICAgICBhcHBsaWNhdGlvbixcbiAgICAgICAgdXBsb2FkZWRGaWxlcyxcbiAgICAgIH07XG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIGdlbmVyYXRlVGVtcG9yYXJ5UGFzc3dvcmQoKTogc3RyaW5nIHtcbiAgICBjb25zdCBjaGFycyA9XG4gICAgICAnQUJDREVGR0hJSktMTU5PUFFSU1RVVldYWVphYmNkZWZnaGlqa2xtbm9wcXJzdHV2d3h5ejAxMjM0NTY3ODlAIyQlJztcbiAgICBsZXQgcGFzc3dvcmQgPSAnJztcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IDEyOyBpKyspIHtcbiAgICAgIHBhc3N3b3JkICs9IGNoYXJzLmNoYXJBdChNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiBjaGFycy5sZW5ndGgpKTtcbiAgICB9XG4gICAgcmV0dXJuIHBhc3N3b3JkO1xuICB9XG5cbiAgLyoqXG4gICAqIENyZWF0ZSBhIENsZXJrIGFjY291bnQgZm9yIGFuIGFwcHJvdmVkIHRoZXJhcGlzdFxuICAgKiBAcGFyYW0gZW1haWwgVGhlcmFwaXN0IGVtYWlsXG4gICAqIEBwYXJhbSBmdWxsTmFtZSBUaGVyYXBpc3QgZnVsbCBuYW1lXG4gICAqIEBwYXJhbSBwYXNzd29yZCBUZW1wb3JhcnkgcGFzc3dvcmRcbiAgICogQHJldHVybnMgQ3JlYXRlZCBDbGVyayB1c2VyIG9iamVjdFxuICAgKi9cbiAgcHJpdmF0ZSBhc3luYyBjcmVhdGVDbGVya1RoZXJhcGlzdEFjY291bnQoXG4gICAgZW1haWw6IHN0cmluZyxcbiAgICBmdWxsTmFtZTogc3RyaW5nLFxuICAgIHBhc3N3b3JkOiBzdHJpbmcsXG4gICk6IFByb21pc2U8eyBpZDogc3RyaW5nOyBlbWFpbDogc3RyaW5nIH0+IHtcbiAgICB0cnkge1xuICAgICAgY29uc29sZS5sb2coJ0NyZWF0aW5nIENsZXJrIGFjY291bnQgZm9yIHRoZXJhcGlzdDonLCB7IGVtYWlsLCBmdWxsTmFtZSB9KTtcbiAgICAgIGNvbnNvbGUubG9nKFxuICAgICAgICAnUGFzc3dvcmQgcHJvdmlkZWQgZm9yIGZ1dHVyZSBDbGVyayBpbnRlZ3JhdGlvbjonLFxuICAgICAgICBwYXNzd29yZCA/ICdZZXMnIDogJ05vJyxcbiAgICAgICk7XG5cbiAgICAgIC8vIEZvciBwcm9kdWN0aW9uLCB5b3Ugd291bGQgaW50ZWdyYXRlIHdpdGggQ2xlcmsgQWRtaW4gQVBJXG4gICAgICAvLyBGb3Igbm93LCB3ZSdsbCBzaW11bGF0ZSB0aGUgYWNjb3VudCBjcmVhdGlvbiBhbmQgcmV0dXJuIGEgbW9jayByZXNwb25zZVxuICAgICAgLy8gSW4gYSByZWFsIGltcGxlbWVudGF0aW9uLCB5b3Ugd291bGQgdXNlOlxuICAgICAgLy8gLSBDbGVyayBCYWNrZW5kIEFQSVxuICAgICAgLy8gLSBjbGVyay9iYWNrZW5kIHBhY2thZ2VcbiAgICAgIC8vIC0gT3IgTUNQIENsZXJrIGludGVncmF0aW9uXG5cbiAgICAgIC8vIENyZWF0ZSBDbGVyayB1c2VyIHVzaW5nIE1DUCBpbnRlZ3JhdGlvblxuICAgICAgLy8gTm90ZTogSW4gYSByZWFsIGltcGxlbWVudGF0aW9uLCB5b3Ugd291bGQgaW5qZWN0IHRoZSBDbGVyayBNQ1Agc2VydmljZVxuICAgICAgLy8gRm9yIG5vdywgd2UnbGwgc2ltdWxhdGUgYSBzdWNjZXNzZnVsIGFjY291bnQgY3JlYXRpb25cblxuICAgICAgY29uc3QgZmlyc3ROYW1lID0gZnVsbE5hbWUuc3BsaXQoJyAnKVswXSB8fCAnJztcbiAgICAgIGNvbnN0IGxhc3ROYW1lID0gZnVsbE5hbWUuc3BsaXQoJyAnKS5zbGljZSgxKS5qb2luKCcgJykgfHwgJyc7XG5cbiAgICAgIC8vIFNpbXVsYXRlIENsZXJrIGFjY291bnQgY3JlYXRpb25cbiAgICAgIC8vIEluIHByb2R1Y3Rpb24sIHVzZSB0aGUgYWN0dWFsIENsZXJrIE1DUCBzZXJ2aWNlXG4gICAgICBjb25zdCBjbGVya1VzZXIgPSB7XG4gICAgICAgIGlkOiBgdXNlcl8ke0RhdGUubm93KCl9XyR7TWF0aC5yYW5kb20oKS50b1N0cmluZygzNikuc3Vic3RyKDIsIDkpfWAsXG4gICAgICAgIGVtYWlsOiBlbWFpbCxcbiAgICAgICAgZmlyc3ROYW1lOiBmaXJzdE5hbWUsXG4gICAgICAgIGxhc3ROYW1lOiBsYXN0TmFtZSxcbiAgICAgICAgcHVibGljTWV0YWRhdGE6IHtcbiAgICAgICAgICByb2xlOiAndGhlcmFwaXN0JyxcbiAgICAgICAgfSxcbiAgICAgICAgcHJpdmF0ZU1ldGFkYXRhOiB7XG4gICAgICAgICAgYWNjb3VudFR5cGU6ICd0aGVyYXBpc3QnLFxuICAgICAgICAgIGNyZWF0ZWRCeTogJ2FkbWluX2FwcHJvdmFsJyxcbiAgICAgICAgICBhcHByb3ZlZEF0OiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksXG4gICAgICAgIH0sXG4gICAgICB9O1xuXG4gICAgICBjb25zb2xlLmxvZygnQ2xlcmsgYWNjb3VudCBjcmVhdGVkIHN1Y2Nlc3NmdWxseTonLCB7XG4gICAgICAgIGlkOiBjbGVya1VzZXIuaWQsXG4gICAgICAgIGVtYWlsOiBjbGVya1VzZXIuZW1haWwsXG4gICAgICAgIHJvbGU6ICd0aGVyYXBpc3QnLFxuICAgICAgfSk7XG5cbiAgICAgIC8vIFRPRE86IFJlcGxhY2Ugd2l0aCBhY3R1YWwgQ2xlcmsgTUNQIGNhbGxcbiAgICAgIC8vIEV4YW1wbGUgdXNpbmcgTUNQIENsZXJrIGludGVncmF0aW9uOlxuICAgICAgLypcbiAgICAgIGNvbnN0IGNsZXJrVXNlciA9IGF3YWl0IHRoaXMuY2xlcmtNY3BTZXJ2aWNlLmNyZWF0ZVVzZXIoe1xuICAgICAgICBlbWFpbEFkZHJlc3M6IGVtYWlsLFxuICAgICAgICBmaXJzdE5hbWU6IGZpcnN0TmFtZSxcbiAgICAgICAgbGFzdE5hbWU6IGxhc3ROYW1lLFxuICAgICAgICBwYXNzd29yZDogcGFzc3dvcmQsXG4gICAgICAgIHB1YmxpY01ldGFkYXRhOiB7IHJvbGU6ICd0aGVyYXBpc3QnIH0sXG4gICAgICAgIHByaXZhdGVNZXRhZGF0YTogeyBcbiAgICAgICAgICBhY2NvdW50VHlwZTogJ3RoZXJhcGlzdCcsXG4gICAgICAgICAgY3JlYXRlZEJ5OiAnYWRtaW5fYXBwcm92YWwnXG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgICAgKi9cblxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgaWQ6IGNsZXJrVXNlci5pZCxcbiAgICAgICAgZW1haWw6IGNsZXJrVXNlci5lbWFpbCxcbiAgICAgIH07XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIGNyZWF0aW5nIENsZXJrIGFjY291bnQ6JywgZXJyb3IpO1xuICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFeGNlcHRpb24oXG4gICAgICAgICdGYWlsZWQgdG8gY3JlYXRlIHRoZXJhcGlzdCBhY2NvdW50LiBQbGVhc2UgdHJ5IGFnYWluLicsXG4gICAgICApO1xuICAgIH1cbiAgfVxufVxuIl0sInZlcnNpb24iOjN9