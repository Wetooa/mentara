{"version":3,"names":["cov_2ar9tlx6c1","actualCoverage","common_1","s","require","passport_1","passport_jwt_1","prisma_client_provider_1","JwtStrategy","PassportStrategy","Strategy","prisma","constructor","f","jwtFromRequest","ExtractJwt","fromAuthHeaderAsBearerToken","ignoreExpiration","secretOrKey","b","process","env","JWT_SECRET","validate","payload","user","findUnique","where","id","sub","deactivatedAt","select","email","firstName","lastName","role","client","therapist","UnauthorizedException","userId","exports","__decorate","Injectable","PrismaService","_a","Object"],"sources":["/home/wetooa/Documents/code/projects/mentara/mentara-api/src/auth/strategies/jwt.strategy.ts"],"sourcesContent":["import { Injectable, UnauthorizedException } from '@nestjs/common';\nimport { PassportStrategy } from '@nestjs/passport';\nimport { ExtractJwt, Strategy } from 'passport-jwt';\nimport { PrismaService } from '../../providers/prisma-client.provider';\n\nexport interface JwtPayload {\n  sub: string; // User ID\n  email: string;\n  role: string;\n  iat?: number;\n  exp?: number;\n}\n\n@Injectable()\nexport class JwtStrategy extends PassportStrategy(Strategy) {\n  constructor(private readonly prisma: PrismaService) {\n    super({\n      jwtFromRequest: ExtractJwt.fromAuthHeaderAsBearerToken(),\n      ignoreExpiration: false,\n      secretOrKey: process.env.JWT_SECRET || 'fallback-secret-key',\n    });\n  }\n\n  async validate(payload: JwtPayload) {\n    // Verify user still exists and is active\n    const user = await this.prisma.user.findUnique({\n      where: {\n        id: payload.sub,\n        deactivatedAt: null, // Ensure user is not deactivated\n      },\n      select: {\n        id: true,\n        email: true,\n        firstName: true,\n        lastName: true,\n        role: true,\n        client: true,\n        therapist: true,\n      },\n    });\n\n    if (!user) {\n      throw new UnauthorizedException('User not found or deactivated');\n    }\n\n    // Verify role matches\n    if (user.role !== payload.role) {\n      throw new UnauthorizedException('Role mismatch - please re-authenticate');\n    }\n\n    return {\n      userId: user.id,\n      email: user.email,\n      firstName: user.firstName,\n      lastName: user.lastName,\n      role: user.role,\n      client: user.client,\n      therapist: user.therapist,\n    };\n  }\n}\n"],"mappings":"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","ignoreList":[]}