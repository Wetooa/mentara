fdd023061c6978de20944c4ca8543b2a
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var AiServiceClient_1;
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
exports.AiServiceClient = void 0;
const common_1 = require("@nestjs/common");
const config_1 = require("@nestjs/config");
const axios_1 = require("axios");
const class_validator_1 = require("class-validator");
// DTO for AI service input validation
class AiPredictionInputDto {
    inputs;
}
__decorate([
    (0, class_validator_1.IsArray)(),
    (0, class_validator_1.ArrayMinSize)(201, { message: 'Input array must contain exactly 201 values' }),
    (0, class_validator_1.ArrayMaxSize)(201, { message: 'Input array must contain exactly 201 values' }),
    (0, class_validator_1.IsNumber)({}, { each: true, message: 'All values must be numbers' }),
    (0, class_validator_1.Min)(0, { each: true, message: 'All values must be non-negative' }),
    (0, class_validator_1.Max)(10, { each: true, message: 'All values must be 10 or less' }),
    __metadata("design:type", Array)
], AiPredictionInputDto.prototype, "inputs", void 0);
let AiServiceClient = AiServiceClient_1 = class AiServiceClient {
    configService;
    logger = new common_1.Logger(AiServiceClient_1.name);
    axiosInstance;
    maxRetries = 3;
    timeoutMs = 30000; // 30 seconds
    baseURL;
    requestCount = 0;
    maxRequestsPerMinute = 60; // Rate limiting
    lastResetTime = Date.now();
    constructor(configService) {
        this.configService = configService;
        // Get AI service URL from environment with fallback
        this.baseURL =
            this.configService.get('AI_SERVICE_URL') ||
                'http://localhost:5000';
        this.axiosInstance = axios_1.default.create({
            baseURL: this.baseURL,
            timeout: this.timeoutMs,
            headers: {
                'Content-Type': 'application/json',
                'User-Agent': 'Mentara-API/1.0',
            },
        });
        // Add request interceptor for logging
        this.axiosInstance.interceptors.request.use((config) => {
            this.logger.debug(`Making AI service request to ${config.url}`);
            return config;
        }, (error) => {
            this.logger.error('AI service request interceptor error:', error);
            return Promise.reject(new Error(String(error)));
        });
        // Add response interceptor for logging
        this.axiosInstance.interceptors.response.use((response) => {
            this.logger.debug(`AI service response received: ${response.status}`);
            return response;
        }, (error) => {
            this.logger.error('AI service response error:', error?.response?.status || error.message);
            return Promise.reject(new Error(String(error)));
        });
    }
    validateInput(flatAnswers) {
        const inputDto = new AiPredictionInputDto();
        inputDto.inputs = flatAnswers;
        const errors = (0, class_validator_1.validateSync)(inputDto);
        if (errors.length > 0) {
            this.logger.warn('AI service input validation failed:', errors.map((e) => e.toString()));
            return false;
        }
        return true;
    }
    isRateLimited() {
        const now = Date.now();
        // Reset counter every minute
        if (now - this.lastResetTime > 60000) {
            this.requestCount = 0;
            this.lastResetTime = now;
        }
        if (this.requestCount >= this.maxRequestsPerMinute) {
            this.logger.warn('AI service rate limit exceeded');
            return true;
        }
        this.requestCount++;
        return false;
    }
    sanitizeInput(flatAnswers) {
        // Sanitize input values to prevent injection attacks
        return flatAnswers.map((value) => {
            // Ensure value is a finite number
            if (!Number.isFinite(value)) {
                this.logger.warn(`Invalid value detected: ${value}, replacing with 0`);
                return 0;
            }
            // Clamp values to expected range
            return Math.max(0, Math.min(10, Math.round(value * 100) / 100)); // Round to 2 decimal places
        });
    }
    async predict(flatAnswers) {
        const startTime = Date.now();
        try {
            // Rate limiting check
            if (this.isRateLimited()) {
                return {
                    success: false,
                    error: 'Rate limit exceeded. Please try again later.',
                };
            }
            // Input validation
            if (!this.validateInput(flatAnswers)) {
                return {
                    success: false,
                    error: 'Invalid input data for AI prediction',
                };
            }
            // Sanitize input
            const sanitizedInput = this.sanitizeInput(flatAnswers);
            // Make the prediction with retry logic
            const result = await this.makeRequestWithRetry(sanitizedInput);
            const responseTime = Date.now() - startTime;
            this.logger.log(`AI prediction completed in ${responseTime}ms`);
            return {
                success: true,
                predictions: result,
                responseTime,
            };
        }
        catch (error) {
            const responseTime = Date.now() - startTime;
            this.logger.error(`AI prediction failed after ${responseTime}ms:`, error);
            return {
                success: false,
                error: this.getErrorMessage(error),
                responseTime,
            };
        }
    }
    async makeRequestWithRetry(sanitizedInput, attempt = 1) {
        try {
            const response = await this.axiosInstance.post('/predict', {
                inputs: sanitizedInput,
            });
            // Validate response structure
            if (!response.data || typeof response.data !== 'object') {
                throw new Error('Invalid response format from AI service');
            }
            return response.data;
        }
        catch (error) {
            if (attempt < this.maxRetries && this.isRetryableError(error)) {
                this.logger.warn(`AI service request failed (attempt ${attempt}/${this.maxRetries}), retrying...`);
                // Exponential backoff
                const delay = Math.min(1000 * Math.pow(2, attempt - 1), 5000);
                await new Promise((resolve) => setTimeout(resolve, delay));
                return this.makeRequestWithRetry(sanitizedInput, attempt + 1);
            }
            throw error;
        }
    }
    isRetryableError(error) {
        if (error instanceof axios_1.AxiosError) {
            // Retry on network errors, timeouts, and 5xx server errors
            return (!error.response ||
                error.response.status >= 500 ||
                error.code === 'ECONNRESET' ||
                error.code === 'ETIMEDOUT');
        }
        return false;
    }
    getErrorMessage(error) {
        if (error instanceof axios_1.AxiosError) {
            if (error.code === 'ECONNREFUSED') {
                return 'AI service is currently unavailable';
            }
            if (error.code === 'ETIMEDOUT') {
                return 'AI service request timed out';
            }
            if (error.response?.status === 400) {
                return 'Invalid request to AI service';
            }
            if (error.response?.status === 429) {
                return 'AI service rate limit exceeded';
            }
            if (error.response?.status && error.response.status >= 500) {
                return 'AI service internal error';
            }
        }
        return 'Unknown error occurred while contacting AI service';
    }
    async healthCheck() {
        try {
            const response = await this.axiosInstance.get('/health', {
                timeout: 5000,
            });
            return response.status === 200;
        }
        catch (error) {
            this.logger.warn('AI service health check failed:', error);
            return false;
        }
    }
    getServiceInfo() {
        return {
            baseURL: this.baseURL,
            timeout: this.timeoutMs,
            maxRetries: this.maxRetries,
        };
    }
};
exports.AiServiceClient = AiServiceClient;
exports.AiServiceClient = AiServiceClient = AiServiceClient_1 = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [typeof (_a = typeof config_1.ConfigService !== "undefined" && config_1.ConfigService) === "function" ? _a : Object])
], AiServiceClient);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL3ByZS1hc3Nlc3NtZW50L3NlcnZpY2VzL2FpLXNlcnZpY2UuY2xpZW50LnRzIiwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7O0FBQUEsMkNBQW9EO0FBQ3BELDJDQUErQztBQUMvQyxpQ0FBeUQ7QUFDekQscURBUXlCO0FBRXpCLHNDQUFzQztBQUN0QyxNQUFNLG9CQUFvQjtJQU94QixNQUFNLENBQVk7Q0FDbkI7QUFEQztJQU5DLElBQUEseUJBQU8sR0FBRTtJQUNULElBQUEsOEJBQVksRUFBQyxHQUFHLEVBQUUsRUFBRSxPQUFPLEVBQUUsNkNBQTZDLEVBQUUsQ0FBQztJQUM3RSxJQUFBLDhCQUFZLEVBQUMsR0FBRyxFQUFFLEVBQUUsT0FBTyxFQUFFLDZDQUE2QyxFQUFFLENBQUM7SUFDN0UsSUFBQSwwQkFBUSxFQUFDLEVBQUUsRUFBRSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsT0FBTyxFQUFFLDRCQUE0QixFQUFFLENBQUM7SUFDbkUsSUFBQSxxQkFBRyxFQUFDLENBQUMsRUFBRSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsT0FBTyxFQUFFLGlDQUFpQyxFQUFFLENBQUM7SUFDbEUsSUFBQSxxQkFBRyxFQUFDLEVBQUUsRUFBRSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsT0FBTyxFQUFFLCtCQUErQixFQUFFLENBQUM7O29EQUNoRDtBQVdiLElBQU0sZUFBZSx1QkFBckIsTUFBTSxlQUFlO0lBVUc7SUFUWixNQUFNLEdBQUcsSUFBSSxlQUFNLENBQUMsaUJBQWUsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUMxQyxhQUFhLENBQWdCO0lBQzdCLFVBQVUsR0FBVyxDQUFDLENBQUM7SUFDdkIsU0FBUyxHQUFXLEtBQUssQ0FBQyxDQUFDLGFBQWE7SUFDeEMsT0FBTyxDQUFTO0lBQ3pCLFlBQVksR0FBRyxDQUFDLENBQUM7SUFDUixvQkFBb0IsR0FBRyxFQUFFLENBQUMs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LENBQUMsaUNBQWlDLEVBQUUsS0FBSyxDQUFDLENBQUM7WUFDM0QsT0FBTyxLQUFLLENBQUM7UUFDZixDQUFDO0lBQ0gsQ0FBQztJQUVELGNBQWM7UUFDWixPQUFPO1lBQ0wsT0FBTyxFQUFFLElBQUksQ0FBQyxPQUFPO1lBQ3JCLE9BQU8sRUFBRSxJQUFJLENBQUMsU0FBUztZQUN2QixVQUFVLEVBQUUsSUFBSSxDQUFDLFVBQVU7U0FDNUIsQ0FBQztJQUNKLENBQUM7Q0FDRixDQUFBO0FBMU9ZLDBDQUFlOzBCQUFmLGVBQWU7SUFEM0IsSUFBQSxtQkFBVSxHQUFFO3lEQVdpQyxzQkFBYSxvQkFBYixzQkFBYTtHQVY5QyxlQUFlLENBME8zQiIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvaG9tZS93ZXRvb2EvRG9jdW1lbnRzL2NvZGUvcHJvamVjdHMvbWVudGFyYS9tZW50YXJhLWFwaS9zcmMvcHJlLWFzc2Vzc21lbnQvc2VydmljZXMvYWktc2VydmljZS5jbGllbnQudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSwgTG9nZ2VyIH0gZnJvbSAnQG5lc3Rqcy9jb21tb24nO1xuaW1wb3J0IHsgQ29uZmlnU2VydmljZSB9IGZyb20gJ0BuZXN0anMvY29uZmlnJztcbmltcG9ydCBheGlvcywgeyBBeGlvc0luc3RhbmNlLCBBeGlvc0Vycm9yIH0gZnJvbSAnYXhpb3MnO1xuaW1wb3J0IHtcbiAgSXNBcnJheSxcbiAgSXNOdW1iZXIsXG4gIHZhbGlkYXRlU3luYyxcbiAgTWluLFxuICBNYXgsXG4gIEFycmF5TWluU2l6ZSxcbiAgQXJyYXlNYXhTaXplLFxufSBmcm9tICdjbGFzcy12YWxpZGF0b3InO1xuXG4vLyBEVE8gZm9yIEFJIHNlcnZpY2UgaW5wdXQgdmFsaWRhdGlvblxuY2xhc3MgQWlQcmVkaWN0aW9uSW5wdXREdG8ge1xuICBASXNBcnJheSgpXG4gIEBBcnJheU1pblNpemUoMjAxLCB7IG1lc3NhZ2U6ICdJbnB1dCBhcnJheSBtdXN0IGNvbnRhaW4gZXhhY3RseSAyMDEgdmFsdWVzJyB9KVxuICBAQXJyYXlNYXhTaXplKDIwMSwgeyBtZXNzYWdlOiAnSW5wdXQgYXJyYXkgbXVzdCBjb250YWluIGV4YWN0bHkgMjAxIHZhbHVlcycgfSlcbiAgQElzTnVtYmVyKHt9LCB7IGVhY2g6IHRydWUsIG1lc3NhZ2U6ICdBbGwgdmFsdWVzIG11c3QgYmUgbnVtYmVycycgfSlcbiAgQE1pbigwLCB7IGVhY2g6IHRydWUsIG1lc3NhZ2U6ICdBbGwgdmFsdWVzIG11c3QgYmUgbm9uLW5lZ2F0aXZlJyB9KVxuICBATWF4KDEwLCB7IGVhY2g6IHRydWUsIG1lc3NhZ2U6ICdBbGwgdmFsdWVzIG11c3QgYmUgMTAgb3IgbGVzcycgfSlcbiAgaW5wdXRzITogbnVtYmVyW107XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQWlQcmVkaWN0aW9uUmVzdWx0IHtcbiAgc3VjY2VzczogYm9vbGVhbjtcbiAgcHJlZGljdGlvbnM/OiBSZWNvcmQ8c3RyaW5nLCBib29sZWFuPjtcbiAgZXJyb3I/OiBzdHJpbmc7XG4gIHJlc3BvbnNlVGltZT86IG51bWJlcjtcbn1cblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIEFpU2VydmljZUNsaWVudCB7XG4gIHByaXZhdGUgcmVhZG9ubHkgbG9nZ2VyID0gbmV3IExvZ2dlcihBaVNlcnZpY2VDbGllbnQubmFtZSk7XG4gIHByaXZhdGUgcmVhZG9ubHkgYXhpb3NJbnN0YW5jZTogQXhpb3NJbnN0YW5jZTtcbiAgcHJpdmF0ZSByZWFkb25seSBtYXhSZXRyaWVzOiBudW1iZXIgPSAzO1xuICBwcml2YXRlIHJlYWRvbmx5IHRpbWVvdXRNczogbnVtYmVyID0gMzAwMDA7IC8vIDMwIHNlY29uZHNcbiAgcHJpdmF0ZSByZWFkb25seSBiYXNlVVJMOiBzdHJpbmc7XG4gIHByaXZhdGUgcmVxdWVzdENvdW50ID0gMDtcbiAgcHJpdmF0ZSByZWFkb25seSBtYXhSZXF1ZXN0c1Blck1pbnV0ZSA9IDYwOyAvLyBSYXRlIGxpbWl0aW5nXG4gIHByaXZhdGUgbGFzdFJlc2V0VGltZSA9IERhdGUubm93KCk7XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSByZWFkb25seSBjb25maWdTZXJ2aWNlOiBDb25maWdTZXJ2aWNlKSB7XG4gICAgLy8gR2V0IEFJIHNlcnZpY2UgVVJMIGZyb20gZW52aXJvbm1lbnQgd2l0aCBmYWxsYmFja1xuICAgIHRoaXMuYmFzZVVSTCA9XG4gICAgICB0aGlzLmNvbmZpZ1NlcnZpY2UuZ2V0PHN0cmluZz4oJ0FJX1NFUlZJQ0VfVVJMJykgfHxcbiAgICAgICdodHRwOi8vbG9jYWxob3N0OjUwMDAnO1xuXG4gICAgdGhpcy5heGlvc0luc3RhbmNlID0gYXhpb3MuY3JlYXRlKHtcbiAgICAgIGJhc2VVUkw6IHRoaXMuYmFzZVVSTCxcbiAgICAgIHRpbWVvdXQ6IHRoaXMudGltZW91dE1zLFxuICAgICAgaGVhZGVyczoge1xuICAgICAgICAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nLFxuICAgICAgICAnVXNlci1BZ2VudCc6ICdNZW50YXJhLUFQSS8xLjAnLFxuICAgICAgfSxcbiAgICB9KTtcblxuICAgIC8vIEFkZCByZXF1ZXN0IGludGVyY2VwdG9yIGZvciBsb2dnaW5nXG4gICAgdGhpcy5heGlvc0luc3RhbmNlLmludGVyY2VwdG9ycy5yZXF1ZXN0LnVzZShcbiAgICAgIChjb25maWcpID0+IHtcbiAgICAgICAgdGhpcy5sb2dnZXIuZGVidWcoYE1ha2luZyBBSSBzZXJ2aWNlIHJlcXVlc3QgdG8gJHtjb25maWcudXJsfWApO1xuICAgICAgICByZXR1cm4gY29uZmlnO1xuICAgICAgfSxcbiAgICAgIChlcnJvcikgPT4ge1xuICAgICAgICB0aGlzLmxvZ2dlci5lcnJvcignQUkgc2VydmljZSByZXF1ZXN0IGludGVyY2VwdG9yIGVycm9yOicsIGVycm9yKTtcbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KG5ldyBFcnJvcihTdHJpbmcoZXJyb3IpKSk7XG4gICAgICB9LFxuICAgICk7XG5cbiAgICAvLyBBZGQgcmVzcG9uc2UgaW50ZXJjZXB0b3IgZm9yIGxvZ2dpbmdcbiAgICB0aGlzLmF4aW9zSW5zdGFuY2UuaW50ZXJjZXB0b3JzLnJlc3BvbnNlLnVzZShcbiAgICAgIChyZXNwb25zZSkgPT4ge1xuICAgICAgICB0aGlzLmxvZ2dlci5kZWJ1ZyhgQUkgc2VydmljZSByZXNwb25zZSByZWNlaXZlZDogJHtyZXNwb25zZS5zdGF0dXN9YCk7XG4gICAgICAgIHJldHVybiByZXNwb25zZTtcbiAgICAgIH0sXG4gICAgICAoZXJyb3IpID0+IHtcbiAgICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoXG4gICAgICAgICAgJ0FJIHNlcnZpY2UgcmVzcG9uc2UgZXJyb3I6JyxcbiAgICAgICAgICBlcnJvcj8ucmVzcG9uc2U/LnN0YXR1cyB8fCBlcnJvci5tZXNzYWdlLFxuICAgICAgICApO1xuICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QobmV3IEVycm9yKFN0cmluZyhlcnJvcikpKTtcbiAgICAgIH0sXG4gICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgdmFsaWRhdGVJbnB1dChmbGF0QW5zd2VyczogbnVtYmVyW10pOiBib29sZWFuIHtcbiAgICBjb25zdCBpbnB1dER0byA9IG5ldyBBaVByZWRpY3Rpb25JbnB1dER0bygpO1xuICAgIGlucHV0RHRvLmlucHV0cyA9IGZsYXRBbnN3ZXJzO1xuXG4gICAgY29uc3QgZXJyb3JzID0gdmFsaWRhdGVTeW5jKGlucHV0RHRvKTtcblxuICAgIGlmIChlcnJvcnMubGVuZ3RoID4gMCkge1xuICAgICAgdGhpcy5sb2dnZXIud2FybihcbiAgICAgICAgJ0FJIHNlcnZpY2UgaW5wdXQgdmFsaWRhdGlvbiBmYWlsZWQ6JyxcbiAgICAgICAgZXJyb3JzLm1hcCgoZSkgPT4gZS50b1N0cmluZygpKSxcbiAgICAgICk7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRydWU7XG4gIH1cblxuICBwcml2YXRlIGlzUmF0ZUxpbWl0ZWQoKTogYm9vbGVhbiB7XG4gICAgY29uc3Qgbm93ID0gRGF0ZS5ub3coKTtcblxuICAgIC8vIFJlc2V0IGNvdW50ZXIgZXZlcnkgbWludXRlXG4gICAgaWYgKG5vdyAtIHRoaXMubGFzdFJlc2V0VGltZSA+IDYwMDAwKSB7XG4gICAgICB0aGlzLnJlcXVlc3RDb3VudCA9IDA7XG4gICAgICB0aGlzLmxhc3RSZXNldFRpbWUgPSBub3c7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMucmVxdWVzdENvdW50ID49IHRoaXMubWF4UmVxdWVzdHNQZXJNaW51dGUpIHtcbiAgICAgIHRoaXMubG9nZ2VyLndhcm4oJ0FJIHNlcnZpY2UgcmF0ZSBsaW1pdCBleGNlZWRlZCcpO1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuXG4gICAgdGhpcy5yZXF1ZXN0Q291bnQrKztcbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cblxuICBwcml2YXRlIHNhbml0aXplSW5wdXQoZmxhdEFuc3dlcnM6IG51bWJlcltdKTogbnVtYmVyW10ge1xuICAgIC8vIFNhbml0aXplIGlucHV0IHZhbHVlcyB0byBwcmV2ZW50IGluamVjdGlvbiBhdHRhY2tzXG4gICAgcmV0dXJuIGZsYXRBbnN3ZXJzLm1hcCgodmFsdWUpID0+IHtcbiAgICAgIC8vIEVuc3VyZSB2YWx1ZSBpcyBhIGZpbml0ZSBudW1iZXJcbiAgICAgIGlmICghTnVtYmVyLmlzRmluaXRlKHZhbHVlKSkge1xuICAgICAgICB0aGlzLmxvZ2dlci53YXJuKGBJbnZhbGlkIHZhbHVlIGRldGVjdGVkOiAke3ZhbHVlfSwgcmVwbGFjaW5nIHdpdGggMGApO1xuICAgICAgICByZXR1cm4gMDtcbiAgICAgIH1cblxuICAgICAgLy8gQ2xhbXAgdmFsdWVzIHRvIGV4cGVjdGVkIHJhbmdlXG4gICAgICByZXR1cm4gTWF0aC5tYXgoMCwgTWF0aC5taW4oMTAsIE1hdGgucm91bmQodmFsdWUgKiAxMDApIC8gMTAwKSk7IC8vIFJvdW5kIHRvIDIgZGVjaW1hbCBwbGFjZXNcbiAgICB9KTtcbiAgfVxuXG4gIGFzeW5jIHByZWRpY3QoZmxhdEFuc3dlcnM6IG51bWJlcltdKTogUHJvbWlzZTxBaVByZWRpY3Rpb25SZXN1bHQ+IHtcbiAgICBjb25zdCBzdGFydFRpbWUgPSBEYXRlLm5vdygpO1xuXG4gICAgdHJ5IHtcbiAgICAgIC8vIFJhdGUgbGltaXRpbmcgY2hlY2tcbiAgICAgIGlmICh0aGlzLmlzUmF0ZUxpbWl0ZWQoKSkge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICAgIGVycm9yOiAnUmF0ZSBsaW1pdCBleGNlZWRlZC4gUGxlYXNlIHRyeSBhZ2FpbiBsYXRlci4nLFxuICAgICAgICB9O1xuICAgICAgfVxuXG4gICAgICAvLyBJbnB1dCB2YWxpZGF0aW9uXG4gICAgICBpZiAoIXRoaXMudmFsaWRhdGVJbnB1dChmbGF0QW5zd2VycykpIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgICBlcnJvcjogJ0ludmFsaWQgaW5wdXQgZGF0YSBmb3IgQUkgcHJlZGljdGlvbicsXG4gICAgICAgIH07XG4gICAgICB9XG5cbiAgICAgIC8vIFNhbml0aXplIGlucHV0XG4gICAgICBjb25zdCBzYW5pdGl6ZWRJbnB1dCA9IHRoaXMuc2FuaXRpemVJbnB1dChmbGF0QW5zd2Vycyk7XG5cbiAgICAgIC8vIE1ha2UgdGhlIHByZWRpY3Rpb24gd2l0aCByZXRyeSBsb2dpY1xuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgdGhpcy5tYWtlUmVxdWVzdFdpdGhSZXRyeShzYW5pdGl6ZWRJbnB1dCk7XG5cbiAgICAgIGNvbnN0IHJlc3BvbnNlVGltZSA9IERhdGUubm93KCkgLSBzdGFydFRpbWU7XG4gICAgICB0aGlzLmxvZ2dlci5sb2coYEFJIHByZWRpY3Rpb24gY29tcGxldGVkIGluICR7cmVzcG9uc2VUaW1lfW1zYCk7XG5cbiAgICAgIHJldHVybiB7XG4gICAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICAgIHByZWRpY3Rpb25zOiByZXN1bHQsXG4gICAgICAgIHJlc3BvbnNlVGltZSxcbiAgICAgIH07XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnN0IHJlc3BvbnNlVGltZSA9IERhdGUubm93KCkgLSBzdGFydFRpbWU7XG4gICAgICB0aGlzLmxvZ2dlci5lcnJvcihgQUkgcHJlZGljdGlvbiBmYWlsZWQgYWZ0ZXIgJHtyZXNwb25zZVRpbWV9bXM6YCwgZXJyb3IpO1xuXG4gICAgICByZXR1cm4ge1xuICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgZXJyb3I6IHRoaXMuZ2V0RXJyb3JNZXNzYWdlKGVycm9yKSxcbiAgICAgICAgcmVzcG9uc2VUaW1lLFxuICAgICAgfTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIG1ha2VSZXF1ZXN0V2l0aFJldHJ5KFxuICAgIHNhbml0aXplZElucHV0OiBudW1iZXJbXSxcbiAgICBhdHRlbXB0OiBudW1iZXIgPSAxLFxuICApOiBQcm9taXNlPFJlY29yZDxzdHJpbmcsIGJvb2xlYW4+PiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgdGhpcy5heGlvc0luc3RhbmNlLnBvc3QoJy9wcmVkaWN0Jywge1xuICAgICAgICBpbnB1dHM6IHNhbml0aXplZElucHV0LFxuICAgICAgfSk7XG5cbiAgICAgIC8vIFZhbGlkYXRlIHJlc3BvbnNlIHN0cnVjdHVyZVxuICAgICAgaWYgKCFyZXNwb25zZS5kYXRhIHx8IHR5cGVvZiByZXNwb25zZS5kYXRhICE9PSAnb2JqZWN0Jykge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ludmFsaWQgcmVzcG9uc2UgZm9ybWF0IGZyb20gQUkgc2VydmljZScpO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gcmVzcG9uc2UuZGF0YSBhcyBSZWNvcmQ8c3RyaW5nLCBib29sZWFuPjtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgaWYgKGF0dGVtcHQgPCB0aGlzLm1heFJldHJpZXMgJiYgdGhpcy5pc1JldHJ5YWJsZUVycm9yKGVycm9yKSkge1xuICAgICAgICB0aGlzLmxvZ2dlci53YXJuKFxuICAgICAgICAgIGBBSSBzZXJ2aWNlIHJlcXVlc3QgZmFpbGVkIChhdHRlbXB0ICR7YXR0ZW1wdH0vJHt0aGlzLm1heFJldHJpZXN9KSwgcmV0cnlpbmcuLi5gLFxuICAgICAgICApO1xuXG4gICAgICAgIC8vIEV4cG9uZW50aWFsIGJhY2tvZmZcbiAgICAgICAgY29uc3QgZGVsYXkgPSBNYXRoLm1pbigxMDAwICogTWF0aC5wb3coMiwgYXR0ZW1wdCAtIDEpLCA1MDAwKTtcbiAgICAgICAgYXdhaXQgbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHNldFRpbWVvdXQocmVzb2x2ZSwgZGVsYXkpKTtcblxuICAgICAgICByZXR1cm4gdGhpcy5tYWtlUmVxdWVzdFdpdGhSZXRyeShzYW5pdGl6ZWRJbnB1dCwgYXR0ZW1wdCArIDEpO1xuICAgICAgfVxuXG4gICAgICB0aHJvdyBlcnJvcjtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGlzUmV0cnlhYmxlRXJyb3IoZXJyb3I6IHVua25vd24pOiBib29sZWFuIHtcbiAgICBpZiAoZXJyb3IgaW5zdGFuY2VvZiBBeGlvc0Vycm9yKSB7XG4gICAgICAvLyBSZXRyeSBvbiBuZXR3b3JrIGVycm9ycywgdGltZW91dHMsIGFuZCA1eHggc2VydmVyIGVycm9yc1xuICAgICAgcmV0dXJuIChcbiAgICAgICAgIWVycm9yLnJlc3BvbnNlIHx8XG4gICAgICAgIGVycm9yLnJlc3BvbnNlLnN0YXR1cyA+PSA1MDAgfHxcbiAgICAgICAgZXJyb3IuY29kZSA9PT0gJ0VDT05OUkVTRVQnIHx8XG4gICAgICAgIGVycm9yLmNvZGUgPT09ICdFVElNRURPVVQnXG4gICAgICApO1xuICAgIH1cbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cblxuICBwcml2YXRlIGdldEVycm9yTWVzc2FnZShlcnJvcjogdW5rbm93bik6IHN0cmluZyB7XG4gICAgaWYgKGVycm9yIGluc3RhbmNlb2YgQXhpb3NFcnJvcikge1xuICAgICAgaWYgKGVycm9yLmNvZGUgPT09ICdFQ09OTlJFRlVTRUQnKSB7XG4gICAgICAgIHJldHVybiAnQUkgc2VydmljZSBpcyBjdXJyZW50bHkgdW5hdmFpbGFibGUnO1xuICAgICAgfVxuICAgICAgaWYgKGVycm9yLmNvZGUgPT09ICdFVElNRURPVVQnKSB7XG4gICAgICAgIHJldHVybiAnQUkgc2VydmljZSByZXF1ZXN0IHRpbWVkIG91dCc7XG4gICAgICB9XG4gICAgICBpZiAoZXJyb3IucmVzcG9uc2U/LnN0YXR1cyA9PT0gNDAwKSB7XG4gICAgICAgIHJldHVybiAnSW52YWxpZCByZXF1ZXN0IHRvIEFJIHNlcnZpY2UnO1xuICAgICAgfVxuICAgICAgaWYgKGVycm9yLnJlc3BvbnNlPy5zdGF0dXMgPT09IDQyOSkge1xuICAgICAgICByZXR1cm4gJ0FJIHNlcnZpY2UgcmF0ZSBsaW1pdCBleGNlZWRlZCc7XG4gICAgICB9XG4gICAgICBpZiAoZXJyb3IucmVzcG9uc2U/LnN0YXR1cyAmJiBlcnJvci5yZXNwb25zZS5zdGF0dXMgPj0gNTAwKSB7XG4gICAgICAgIHJldHVybiAnQUkgc2VydmljZSBpbnRlcm5hbCBlcnJvcic7XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuICdVbmtub3duIGVycm9yIG9jY3VycmVkIHdoaWxlIGNvbnRhY3RpbmcgQUkgc2VydmljZSc7XG4gIH1cblxuICBhc3luYyBoZWFsdGhDaGVjaygpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCB0aGlzLmF4aW9zSW5zdGFuY2UuZ2V0KCcvaGVhbHRoJywge1xuICAgICAgICB0aW1lb3V0OiA1MDAwLFxuICAgICAgfSk7XG4gICAgICByZXR1cm4gcmVzcG9uc2Uuc3RhdHVzID09PSAyMDA7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRoaXMubG9nZ2VyLndhcm4oJ0FJIHNlcnZpY2UgaGVhbHRoIGNoZWNrIGZhaWxlZDonLCBlcnJvcik7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICB9XG5cbiAgZ2V0U2VydmljZUluZm8oKTogeyBiYXNlVVJMOiBzdHJpbmc7IHRpbWVvdXQ6IG51bWJlcjsgbWF4UmV0cmllczogbnVtYmVyIH0ge1xuICAgIHJldHVybiB7XG4gICAgICBiYXNlVVJMOiB0aGlzLmJhc2VVUkwsXG4gICAgICB0aW1lb3V0OiB0aGlzLnRpbWVvdXRNcyxcbiAgICAgIG1heFJldHJpZXM6IHRoaXMubWF4UmV0cmllcyxcbiAgICB9O1xuICB9XG59XG4iXSwidmVyc2lvbiI6M30=