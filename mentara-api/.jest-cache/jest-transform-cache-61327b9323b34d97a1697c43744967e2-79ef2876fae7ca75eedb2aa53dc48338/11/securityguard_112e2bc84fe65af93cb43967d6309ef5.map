{"version":3,"names":["cov_a3b0f8bf7","actualCoverage","common_1","s","require","SecurityGuard","suspiciousPatterns","maxRequestSize","maxHeaderLength","maxUrlLength","canActivate","context","f","request","switchToHttp","getRequest","getRequestSize","b","ForbiddenException","url","length","validateHeaders","validateInput","Object","entries","query","forEach","key","value","String","body","validateRequestBody","contentLength","headers","parseInt","name","headerValue","Array","isArray","join","input","pattern","test","depth","item","keys","exports","__decorate","Injectable"],"sources":["/home/wetooa/Documents/code/projects/mentara/mentara-api/src/common/guards/security.guard.ts"],"sourcesContent":["import {\n  Injectable,\n  CanActivate,\n  ExecutionContext,\n  ForbiddenException,\n} from '@nestjs/common';\nimport { Request } from 'express';\n\n@Injectable()\nexport class SecurityGuard implements CanActivate {\n  private readonly suspiciousPatterns = [\n    // SQL Injection patterns\n    /union\\s+select/i,\n    /drop\\s+table/i,\n    /insert\\s+into/i,\n    /delete\\s+from/i,\n    /update\\s+.*set/i,\n    /script\\s*>/i,\n\n    // XSS patterns\n    /<script/i,\n    /javascript:/i,\n    /vbscript:/i,\n    /onload\\s*=/i,\n    /onerror\\s*=/i,\n\n    // Command injection patterns\n    /\\|\\s*cat\\s+/,\n    /;\\s*rm\\s+-rf/,\n    /&&\\s*curl/,\n    /`.*`/,\n\n    // Path traversal patterns\n    /\\.\\.\\//,\n    /\\.\\.\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\w+/,\n    /\\.\\.\\%2f/i,\n    /\\.\\.\\%5c/i,\n  ];\n\n  private readonly maxRequestSize = 10 * 1024 * 1024; // 10MB\n  private readonly maxHeaderLength = 8192; // 8KB\n  private readonly maxUrlLength = 2048; // 2KB\n\n  canActivate(context: ExecutionContext): boolean {\n    const request = context.switchToHttp().getRequest<Request>();\n\n    // Check request size\n    if (this.getRequestSize(request) > this.maxRequestSize) {\n      throw new ForbiddenException('Request too large');\n    }\n\n    // Check URL length\n    if (request.url.length > this.maxUrlLength) {\n      throw new ForbiddenException('URL too long');\n    }\n\n    // Check headers\n    this.validateHeaders(request);\n\n    // Check for suspicious patterns in URL\n    this.validateInput(request.url, 'URL');\n\n    // Check query parameters\n    Object.entries(request.query || {}).forEach(([key, value]) => {\n      this.validateInput(key, 'Query parameter key');\n      this.validateInput(String(value), 'Query parameter value');\n    });\n\n    // Check body if it exists\n    if (request.body) {\n      this.validateRequestBody(request.body);\n    }\n\n    return true;\n  }\n\n  private getRequestSize(request: Request): number {\n    const contentLength = request.headers['content-length'];\n    return contentLength ? parseInt(contentLength, 10) : 0;\n  }\n\n  private validateHeaders(request: Request): void {\n    Object.entries(request.headers).forEach(([name, value]) => {\n      const headerValue = Array.isArray(value)\n        ? value.join('')\n        : String(value || '');\n\n      if (headerValue.length > this.maxHeaderLength) {\n        throw new ForbiddenException(`Header ${name} too long`);\n      }\n\n      this.validateInput(headerValue, `Header ${name}`);\n    });\n  }\n\n  private validateInput(input: string, context: string): void {\n    for (const pattern of this.suspiciousPatterns) {\n      if (pattern.test(input)) {\n        throw new ForbiddenException(\n          `Suspicious content detected in ${context}`,\n        );\n      }\n    }\n  }\n\n  private validateRequestBody(body: any, depth = 0): void {\n    // Prevent deep nesting attacks\n    if (depth > 10) {\n      throw new ForbiddenException('Request body too deeply nested');\n    }\n\n    if (typeof body === 'string') {\n      this.validateInput(body, 'Request body');\n    } else if (Array.isArray(body)) {\n      if (body.length > 1000) {\n        throw new ForbiddenException('Array too large');\n      }\n      body.forEach((item) => this.validateRequestBody(item, depth + 1));\n    } else if (typeof body === 'object' && body !== null) {\n      const keys = Object.keys(body);\n      if (keys.length > 100) {\n        throw new ForbiddenException('Too many object properties');\n      }\n\n      keys.forEach((key) => {\n        this.validateInput(key, 'Object key');\n        this.validateRequestBody(body[key], depth + 1);\n      });\n    }\n  }\n}\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;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","ignoreList":[]}