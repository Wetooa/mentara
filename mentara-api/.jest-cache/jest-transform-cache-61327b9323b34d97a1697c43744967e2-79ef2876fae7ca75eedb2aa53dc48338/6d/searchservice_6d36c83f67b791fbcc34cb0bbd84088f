7e3e8796e7e65d08ec3a97bda9a0d568
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
exports.SearchService = void 0;
const common_1 = require("@nestjs/common");
const prisma_client_provider_1 = require("../providers/prisma-client.provider");
let SearchService = class SearchService {
    prisma;
    constructor(prisma) {
        this.prisma = prisma;
    }
    async searchTherapists(query, filters) {
        try {
            const where = {
                status: 'APPROVED',
                OR: [
                    {
                        user: {
                            firstName: { contains: query, mode: 'insensitive' },
                        },
                    },
                    {
                        user: {
                            lastName: { contains: query, mode: 'insensitive' },
                        },
                    },
                    {
                        user: {
                            bio: { contains: query, mode: 'insensitive' },
                        },
                    },
                    {
                        expertise: { hasSome: [query] },
                    },
                ],
            };
            if (filters) {
                if (filters.province) {
                    where.province = filters.province;
                }
                if (filters.expertise && filters.expertise.length > 0) {
                    where.expertise = { hasSome: filters.expertise };
                }
                if (filters.maxHourlyRate) {
                    where.hourlyRate = { lte: filters.maxHourlyRate };
                }
                if (filters.minExperience) {
                    where.yearsOfExperience = { gte: filters.minExperience };
                }
            }
            return this.prisma.therapist.findMany({
                where,
                include: {
                    user: {
                        select: {
                            id: true,
                            firstName: true,
                            lastName: true,
                            avatarUrl: true,
                            bio: true,
                        },
                    },
                },
                orderBy: { createdAt: 'desc' },
                take: 20,
            });
        }
        catch (error) {
            throw new common_1.InternalServerErrorException(`Failed to search therapists: ${error instanceof Error ? error.message : String(error)}`);
        }
    }
    async searchPosts(query, communityId, userId) {
        try {
            const where = {
                OR: [
                    { title: { contains: query, mode: 'insensitive' } },
                    { content: { contains: query, mode: 'insensitive' } },
                ],
            };
            // If userId is provided, filter posts to only include those from communities the user is a member of
            if (userId) {
                where.room = {
                    roomGroup: {
                        community: {
                            memberships: {
                                some: {
                                    userId: userId,
                                },
                            },
                        },
                    },
                };
            }
            // If specific communityId is provided, further filter by that community
            if (communityId) {
                if (where.room) {
                    where.room.roomGroup.community.id = communityId;
                }
                else {
                    where.room = {
                        roomGroup: {
                            community: {
                                id: communityId,
                            },
                        },
                    };
                }
            }
            return this.prisma.post.findMany({
                where,
                include: {
                    user: {
                        select: {
                            id: true,
                            firstName: true,
                            lastName: true,
                            avatarUrl: true,
                        },
                    },
                    room: {
                        include: {
                            roomGroup: {
                                include: {
                                    community: {
                                        select: {
                                            id: true,
                                            name: true,
                                            slug: true,
                                        },
                                    },
                                },
                            },
                        },
                    },
                    _count: {
                        select: {
                            hearts: true,
                            comments: true,
                        },
                    },
                },
                orderBy: { createdAt: 'desc' },
                take: 20,
            });
        }
        catch (error) {
            throw new common_1.InternalServerErrorException(`Failed to search posts: ${error instanceof Error ? error.message : String(error)}`);
        }
    }
    async searchComments(query, communityId, userId) {
        try {
            const where = {
                content: { contains: query, mode: 'insensitive' },
            };
            // If userId is provided, filter comments to only include those from posts in communities the user is a member of
            if (userId) {
                where.post = {
                    room: {
                        roomGroup: {
                            community: {
                                memberships: {
                                    some: {
                                        userId: userId,
                                    },
                                },
                            },
                        },
                    },
                };
            }
            // If specific communityId is provided, further filter by that community
            if (communityId) {
                if (where.post) {
                    where.post.room.roomGroup.community.id = communityId;
                }
                else {
                    where.post = {
                        room: {
                            roomGroup: {
                                community: {
                                    id: communityId,
                                },
                            },
                        },
                    };
                }
            }
            return this.prisma.comment.findMany({
                where,
                include: {
                    user: {
                        select: {
                            id: true,
                            firstName: true,
                            lastName: true,
                            avatarUrl: true,
                            role: true,
                        },
                    },
                    post: {
                        select: {
                            id: true,
                            title: true,
                            userId: true,
                            room: {
                                include: {
                                    roomGroup: {
                                        include: {
                                            community: {
                                                select: {
                                                    id: true,
                                                    name: true,
                                                    slug: true,
                                                },
                                            },
                                        },
                                    },
                                },
                            },
                        },
                    },
                    _count: {
                        select: {
                            hearts: true,
                            children: true,
                        },
                    },
                },
                orderBy: { createdAt: 'desc' },
                take: 20,
            });
        }
        catch (error) {
            throw new common_1.InternalServerErrorException(`Failed to search comments: ${error instanceof Error ? error.message : String(error)}`);
        }
    }
    async searchCommunities(query) {
        try {
            return this.prisma.community.findMany({
                where: {
                    OR: [
                        { name: { contains: query, mode: 'insensitive' } },
                        { description: { contains: query, mode: 'insensitive' } },
                    ],
                },
                include: {
                    _count: {
                        select: {
                            memberships: true,
                        },
                    },
                },
                orderBy: { createdAt: 'desc' },
                take: 20,
            });
        }
        catch (error) {
            throw new common_1.InternalServerErrorException(`Failed to search communities: ${error instanceof Error ? error.message : String(error)}`);
        }
    }
    async searchUsers(query, role) {
        try {
            const where = {
                OR: [
                    { firstName: { contains: query, mode: 'insensitive' } },
                    { lastName: { contains: query, mode: 'insensitive' } },
                    { email: { contains: query, mode: 'insensitive' } },
                ],
            };
            if (role) {
                where.role = role;
            }
            return this.prisma.user.findMany({
                where,
                select: {
                    id: true,
                    firstName: true,
                    lastName: true,
                    email: true,
                    avatarUrl: true,
                    role: true,
                    createdAt: true,
                },
                orderBy: { createdAt: 'desc' },
                take: 20,
            });
        }
        catch (error) {
            throw new common_1.InternalServerErrorException(`Failed to search users: ${error instanceof Error ? error.message : String(error)}`);
        }
    }
    async searchWorksheets(query, userId, role) {
        try {
            const where = {
                OR: [
                    { title: { contains: query, mode: 'insensitive' } },
                    { instructions: { contains: query, mode: 'insensitive' } },
                ],
            };
            // Filter by user role (client can only see their own worksheets)
            if (role === 'client' && userId) {
                where.clientId = userId;
            }
            else if (role === 'therapist' && userId) {
                where.therapistId = userId;
            }
            return this.prisma.worksheet.findMany({
                where,
                include: {
                    client: {
                        select: {
                            userId: true,
                            user: {
                                select: {
                                    firstName: true,
                                    lastName: true,
                                    avatarUrl: true,
                                },
                            },
                        },
                    },
                    therapist: {
                        select: {
                            userId: true,
                            user: {
                                select: {
                                    firstName: true,
                                    lastName: true,
                                    avatarUrl: true,
                                },
                            },
                        },
                    },
                    submission: {
                        select: {
                            id: true,
                            submittedAt: true,
                            feedback: true,
                        },
                    },
                },
                orderBy: { createdAt: 'desc' },
                take: 20,
            });
        }
        catch (error) {
            throw new common_1.InternalServerErrorException(`Failed to search worksheets: ${error instanceof Error ? error.message : String(error)}`);
        }
    }
    async searchMessages(query, userId) {
        try {
            const whereClause = {
                AND: [
                    {
                        content: {
                            contains: query,
                            mode: 'insensitive',
                        },
                    },
                    {
                        isDeleted: false,
                    },
                    {
                        conversation: {
                            participants: {
                                some: {
                                    userId,
                                    isActive: true,
                                },
                            },
                        },
                    },
                ],
            };
            return this.prisma.message.findMany({
                where: whereClause,
                include: {
                    sender: {
                        select: {
                            id: true,
                            firstName: true,
                            lastName: true,
                            avatarUrl: true,
                        },
                    },
                    conversation: {
                        select: {
                            id: true,
                            type: true,
                            title: true,
                        },
                    },
                },
                orderBy: { createdAt: 'desc' },
                take: 20,
            });
        }
        catch (error) {
            throw new common_1.InternalServerErrorException(`Failed to search messages: ${error instanceof Error ? error.message : String(error)}`);
        }
    }
    async globalSearch(query, types, userId, userRole) {
        try {
            const results = {};
            // Default to all types if none specified
            const defaultTypes = ['therapists', 'posts', 'communities', 'users', 'worksheets', 'messages'];
            const typesArray = types && types.length > 0 ? types : defaultTypes;
            if (typesArray.includes('therapists')) {
                results.therapists = await this.searchTherapists(query);
            }
            if (typesArray.includes('posts')) {
                results.posts = await this.searchPosts(query, undefined, userId);
            }
            // Add comments search (always filtered by user communities if userId is provided)
            if (userId) {
                results.comments = await this.searchComments(query, undefined, userId);
            }
            if (typesArray.includes('communities')) {
                results.communities = await this.searchCommunities(query);
            }
            if (typesArray.includes('users')) {
                results.users = await this.searchUsers(query);
            }
            if (typesArray.includes('worksheets')) {
                // Only search worksheets if user has appropriate permissions
                if (userRole === 'client' || userRole === 'therapist') {
                    results.worksheets = await this.searchWorksheets(query, userId, userRole);
                }
                else if (userRole === 'moderator' || userRole === 'admin') {
                    // Admins and moderators can see all worksheets
                    results.worksheets = await this.searchWorksheets(query);
                }
            }
            if (typesArray.includes('messages') && userId) {
                // Messages are always private to the user
                results.messages = await this.searchMessages(query, userId);
            }
            return results;
        }
        catch (error) {
            throw new common_1.InternalServerErrorException(`Failed to perform global search: ${error instanceof Error ? error.message : String(error)}`);
        }
    }
};
exports.SearchService = SearchService;
exports.SearchService = SearchService = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [typeof (_a = typeof prisma_client_provider_1.PrismaService !== "undefined" && prisma_client_provider_1.PrismaService) === "function" ? _a : Object])
], SearchService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL3NlYXJjaC9zZWFyY2guc2VydmljZS50cyIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7O0FBQUEsMkNBQTBFO0FBQzFFLGdGQUFvRTtBQUc3RCxJQUFNLGFBQWEsR0FBbkIsTUFBTSxhQUFhO0lBQ0s7SUFBN0IsWUFBNkIsTUFBcUI7UUFBckIsV0FBTSxHQUFOLE1BQU0sQ0FBZTtJQUFHLENBQUM7SUFFdEQsS0FBSyxDQUFDLGdCQUFnQixDQUNwQixLQUFhLEVBQ2IsT0FjQztRQUVELElBQUksQ0FBQztZQUNILE1BQU0sS0FBSyxHQUFRO2dCQUNqQixNQUFNLEVBQUUsVUFBVTtnQkFDbEIsRUFBRSxFQUFFO29CQUNGO3dCQUNFLElBQUksRUFBRTs0QkFDSixTQUFTLEVBQUUsRUFBRSxRQUFRLEVBQUUsS0FBSyxFQUFFLElBQUksRUFBRSxhQUFhLEVBQUU7eUJBQ3BEO3FCQUNGO29CQUNEO3dCQUNFLElBQUksRUFBRTs0QkFDSixRQUFRLEVBQUUsRUFBRSxRQUFRLEVBQUUsS0FBSyxFQUFFLElBQUksRUFBRSxhQUFhLEVBQUU7eUJBQ25EO3FCQUNGO29CQUNEO3dCQUNFLElBQUksRUFBRTs0QkFDSixHQUFHLEVBQUUsRUFBRSxRQUFRLEVBQUUsS0FBSyxFQUFFLElBQUksRUFBRSxhQUFhLEVBQUU7eUJBQzlDO3FCQUNGO29CQUNEO3dCQUNFLFNBQVMsRUFBRSxFQUFFLE9BQU8sRUFBRSxDQUFDLEtBQUssQ0FBQyxFQUFFO3FCQUNoQztpQkFDRjthQUNGLENBQUM7WUFFRixJQUFJLE9BQU8sRUFBRSxDQUFDO2dCQUNaLElBQUksT0FBTyxDQUFDLFFBQVEsRUFBRSxDQUFDO29CQUNyQixLQUFLLENBQUMsUUFBUSxHQUFHLE9BQU8sQ0FBQyxRQUFRLENBQUM7Z0JBQ3BDLENBQUM7Z0JBQ0QsSUFBSSxPQUFPLENBQUMsU0FBUyxJQUFJLE9BQU8sQ0FBQyxTQUFTLENBQUMsTUFBTSxH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RCxDQUFDO1lBQ0gsQ0FBQztZQUVELElBQUksVUFBVSxDQUFDLFFBQVEsQ0FBQyxVQUFVLENBQUMsSUFBSSxNQUFNLEVBQUUsQ0FBQztnQkFDOUMsMENBQTBDO2dCQUMxQyxPQUFPLENBQUMsUUFBUSxHQUFHLE1BQU0sSUFBSSxDQUFDLGNBQWMsQ0FBQyxLQUFLLEVBQUUsTUFBTSxDQUFDLENBQUM7WUFDOUQsQ0FBQztZQUVELE9BQU8sT0FBTyxDQUFDO1FBQ2pCLENBQUM7UUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1lBQ2YsTUFBTSxJQUFJLHFDQUE0QixDQUNwQyxvQ0FBb0MsS0FBSyxZQUFZLEtBQUssQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQzdGLENBQUM7UUFDSixDQUFDO0lBQ0gsQ0FBQztDQUNGLENBQUE7QUEzZVksc0NBQWE7d0JBQWIsYUFBYTtJQUR6QixJQUFBLG1CQUFVLEdBQUU7eURBRTBCLHNDQUFhLG9CQUFiLHNDQUFhO0dBRHZDLGFBQWEsQ0EyZXpCIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9ob21lL3dldG9vYS9Eb2N1bWVudHMvY29kZS9wcm9qZWN0cy9tZW50YXJhL21lbnRhcmEtYXBpL3NyYy9zZWFyY2gvc2VhcmNoLnNlcnZpY2UudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSwgSW50ZXJuYWxTZXJ2ZXJFcnJvckV4Y2VwdGlvbiB9IGZyb20gJ0BuZXN0anMvY29tbW9uJztcbmltcG9ydCB7IFByaXNtYVNlcnZpY2UgfSBmcm9tICcuLi9wcm92aWRlcnMvcHJpc21hLWNsaWVudC5wcm92aWRlcic7XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBTZWFyY2hTZXJ2aWNlIHtcbiAgY29uc3RydWN0b3IocHJpdmF0ZSByZWFkb25seSBwcmlzbWE6IFByaXNtYVNlcnZpY2UpIHt9XG5cbiAgYXN5bmMgc2VhcmNoVGhlcmFwaXN0cyhcbiAgICBxdWVyeTogc3RyaW5nLFxuICAgIGZpbHRlcnM/OiB7XG4gICAgICBwcm92aW5jZT86IHN0cmluZztcbiAgICAgIGxvY2F0aW9uPzogc3RyaW5nO1xuICAgICAgZXhwZXJ0aXNlPzogc3RyaW5nW107XG4gICAgICBzcGVjaWFsdGllcz86IHN0cmluZ1tdO1xuICAgICAgbWF4SG91cmx5UmF0ZT86IG51bWJlcjtcbiAgICAgIG1pbkV4cGVyaWVuY2U/OiBudW1iZXI7XG4gICAgICBleHBlcmllbmNlWWVhcnM/OiBudW1iZXI7XG4gICAgICByYXRpbmc/OiBudW1iZXI7XG4gICAgICBnZW5kZXI/OiBzdHJpbmc7XG4gICAgICBsYW5ndWFnZXM/OiBzdHJpbmdbXTtcbiAgICAgIGF2YWlsYWJpbGl0eT86IGFueTtcbiAgICAgIHZlcmlmaWVkT25seT86IGJvb2xlYW47XG4gICAgICBwcmljZVJhbmdlPzogeyBtaW4/OiBudW1iZXI7IG1heD86IG51bWJlciB9O1xuICAgIH0sXG4gICkge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCB3aGVyZTogYW55ID0ge1xuICAgICAgICBzdGF0dXM6ICdBUFBST1ZFRCcsXG4gICAgICAgIE9SOiBbXG4gICAgICAgICAge1xuICAgICAgICAgICAgdXNlcjoge1xuICAgICAgICAgICAgICBmaXJzdE5hbWU6IHsgY29udGFpbnM6IHF1ZXJ5LCBtb2RlOiAnaW5zZW5zaXRpdmUnIH0sXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0sXG4gICAgICAgICAge1xuICAgICAgICAgICAgdXNlcjoge1xuICAgICAgICAgICAgICBsYXN0TmFtZTogeyBjb250YWluczogcXVlcnksIG1vZGU6ICdpbnNlbnNpdGl2ZScgfSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgICB7XG4gICAgICAgICAgICB1c2VyOiB7XG4gICAgICAgICAgICAgIGJpbzogeyBjb250YWluczogcXVlcnksIG1vZGU6ICdpbnNlbnNpdGl2ZScgfSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgICB7XG4gICAgICAgICAgICBleHBlcnRpc2U6IHsgaGFzU29tZTogW3F1ZXJ5XSB9LFxuICAgICAgICAgIH0sXG4gICAgICAgIF0sXG4gICAgICB9O1xuXG4gICAgICBpZiAoZmlsdGVycykge1xuICAgICAgICBpZiAoZmlsdGVycy5wcm92aW5jZSkge1xuICAgICAgICAgIHdoZXJlLnByb3ZpbmNlID0gZmlsdGVycy5wcm92aW5jZTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoZmlsdGVycy5leHBlcnRpc2UgJiYgZmlsdGVycy5leHBlcnRpc2UubGVuZ3RoID4gMCkge1xuICAgICAgICAgIHdoZXJlLmV4cGVydGlzZSA9IHsgaGFzU29tZTogZmlsdGVycy5leHBlcnRpc2UgfTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoZmlsdGVycy5tYXhIb3VybHlSYXRlKSB7XG4gICAgICAgICAgd2hlcmUuaG91cmx5UmF0ZSA9IHsgbHRlOiBmaWx0ZXJzLm1heEhvdXJseVJhdGUgfTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoZmlsdGVycy5taW5FeHBlcmllbmNlKSB7XG4gICAgICAgICAgd2hlcmUueWVhcnNPZkV4cGVyaWVuY2UgPSB7IGd0ZTogZmlsdGVycy5taW5FeHBlcmllbmNlIH07XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHRoaXMucHJpc21hLnRoZXJhcGlzdC5maW5kTWFueSh7XG4gICAgICAgIHdoZXJlLFxuICAgICAgICBpbmNsdWRlOiB7XG4gICAgICAgICAgdXNlcjoge1xuICAgICAgICAgICAgc2VsZWN0OiB7XG4gICAgICAgICAgICAgIGlkOiB0cnVlLFxuICAgICAgICAgICAgICBmaXJzdE5hbWU6IHRydWUsXG4gICAgICAgICAgICAgIGxhc3ROYW1lOiB0cnVlLFxuICAgICAgICAgICAgICBhdmF0YXJVcmw6IHRydWUsXG4gICAgICAgICAgICAgIGJpbzogdHJ1ZSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgICAgb3JkZXJCeTogeyBjcmVhdGVkQXQ6ICdkZXNjJyB9LFxuICAgICAgICB0YWtlOiAyMCxcbiAgICAgIH0pO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aHJvdyBuZXcgSW50ZXJuYWxTZXJ2ZXJFcnJvckV4Y2VwdGlvbihcbiAgICAgICAgYEZhaWxlZCB0byBzZWFyY2ggdGhlcmFwaXN0czogJHtlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6IFN0cmluZyhlcnJvcil9YCxcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgc2VhcmNoUG9zdHMocXVlcnk6IHN0cmluZywgY29tbXVuaXR5SWQ/OiBzdHJpbmcsIHVzZXJJZD86IHN0cmluZykge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCB3aGVyZTogYW55ID0ge1xuICAgICAgICBPUjogW1xuICAgICAgICAgIHsgdGl0bGU6IHsgY29udGFpbnM6IHF1ZXJ5LCBtb2RlOiAnaW5zZW5zaXRpdmUnIH0gfSxcbiAgICAgICAgICB7IGNvbnRlbnQ6IHsgY29udGFpbnM6IHF1ZXJ5LCBtb2RlOiAnaW5zZW5zaXRpdmUnIH0gfSxcbiAgICAgICAgXSxcbiAgICAgIH07XG5cbiAgICAgIC8vIElmIHVzZXJJZCBpcyBwcm92aWRlZCwgZmlsdGVyIHBvc3RzIHRvIG9ubHkgaW5jbHVkZSB0aG9zZSBmcm9tIGNvbW11bml0aWVzIHRoZSB1c2VyIGlzIGEgbWVtYmVyIG9mXG4gICAgICBpZiAodXNlcklkKSB7XG4gICAgICAgIHdoZXJlLnJvb20gPSB7XG4gICAgICAgICAgcm9vbUdyb3VwOiB7XG4gICAgICAgICAgICBjb21tdW5pdHk6IHtcbiAgICAgICAgICAgICAgbWVtYmVyc2hpcHM6IHtcbiAgICAgICAgICAgICAgICBzb21lOiB7XG4gICAgICAgICAgICAgICAgICB1c2VySWQ6IHVzZXJJZCxcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9LFxuICAgICAgICB9O1xuICAgICAgfVxuXG4gICAgICAvLyBJZiBzcGVjaWZpYyBjb21tdW5pdHlJZCBpcyBwcm92aWRlZCwgZnVydGhlciBmaWx0ZXIgYnkgdGhhdCBjb21tdW5pdHlcbiAgICAgIGlmIChjb21tdW5pdHlJZCkge1xuICAgICAgICBpZiAod2hlcmUucm9vbSkge1xuICAgICAgICAgIHdoZXJlLnJvb20ucm9vbUdyb3VwLmNvbW11bml0eS5pZCA9IGNvbW11bml0eUlkO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHdoZXJlLnJvb20gPSB7XG4gICAgICAgICAgICByb29tR3JvdXA6IHtcbiAgICAgICAgICAgICAgY29tbXVuaXR5OiB7XG4gICAgICAgICAgICAgICAgaWQ6IGNvbW11bml0eUlkLFxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9O1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIHJldHVybiB0aGlzLnByaXNtYS5wb3N0LmZpbmRNYW55KHtcbiAgICAgICAgd2hlcmUsXG4gICAgICAgIGluY2x1ZGU6IHtcbiAgICAgICAgICB1c2VyOiB7XG4gICAgICAgICAgICBzZWxlY3Q6IHtcbiAgICAgICAgICAgICAgaWQ6IHRydWUsXG4gICAgICAgICAgICAgIGZpcnN0TmFtZTogdHJ1ZSxcbiAgICAgICAgICAgICAgbGFzdE5hbWU6IHRydWUsXG4gICAgICAgICAgICAgIGF2YXRhclVybDogdHJ1ZSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgICByb29tOiB7XG4gICAgICAgICAgICBpbmNsdWRlOiB7XG4gICAgICAgICAgICAgIHJvb21Hcm91cDoge1xuICAgICAgICAgICAgICAgIGluY2x1ZGU6IHtcbiAgICAgICAgICAgICAgICAgIGNvbW11bml0eToge1xuICAgICAgICAgICAgICAgICAgICBzZWxlY3Q6IHtcbiAgICAgICAgICAgICAgICAgICAgICBpZDogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgICAgICBuYW1lOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgICAgIHNsdWc6IHRydWUsXG4gICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0sXG4gICAgICAgICAgX2NvdW50OiB7XG4gICAgICAgICAgICBzZWxlY3Q6IHtcbiAgICAgICAgICAgICAgaGVhcnRzOiB0cnVlLFxuICAgICAgICAgICAgICBjb21tZW50czogdHJ1ZSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgICAgb3JkZXJCeTogeyBjcmVhdGVkQXQ6ICdkZXNjJyB9LFxuICAgICAgICB0YWtlOiAyMCxcbiAgICAgIH0pO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aHJvdyBuZXcgSW50ZXJuYWxTZXJ2ZXJFcnJvckV4Y2VwdGlvbihcbiAgICAgICAgYEZhaWxlZCB0byBzZWFyY2ggcG9zdHM6ICR7ZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiBTdHJpbmcoZXJyb3IpfWAsXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIHNlYXJjaENvbW1lbnRzKHF1ZXJ5OiBzdHJpbmcsIGNvbW11bml0eUlkPzogc3RyaW5nLCB1c2VySWQ/OiBzdHJpbmcpIHtcbiAgICB0cnkge1xuICAgICAgY29uc3Qgd2hlcmU6IGFueSA9IHtcbiAgICAgICAgY29udGVudDogeyBjb250YWluczogcXVlcnksIG1vZGU6ICdpbnNlbnNpdGl2ZScgfSxcbiAgICAgIH07XG5cbiAgICAgIC8vIElmIHVzZXJJZCBpcyBwcm92aWRlZCwgZmlsdGVyIGNvbW1lbnRzIHRvIG9ubHkgaW5jbHVkZSB0aG9zZSBmcm9tIHBvc3RzIGluIGNvbW11bml0aWVzIHRoZSB1c2VyIGlzIGEgbWVtYmVyIG9mXG4gICAgICBpZiAodXNlcklkKSB7XG4gICAgICAgIHdoZXJlLnBvc3QgPSB7XG4gICAgICAgICAgcm9vbToge1xuICAgICAgICAgICAgcm9vbUdyb3VwOiB7XG4gICAgICAgICAgICAgIGNvbW11bml0eToge1xuICAgICAgICAgICAgICAgIG1lbWJlcnNoaXBzOiB7XG4gICAgICAgICAgICAgICAgICBzb21lOiB7XG4gICAgICAgICAgICAgICAgICAgIHVzZXJJZDogdXNlcklkLFxuICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9LFxuICAgICAgICB9O1xuICAgICAgfVxuXG4gICAgICAvLyBJZiBzcGVjaWZpYyBjb21tdW5pdHlJZCBpcyBwcm92aWRlZCwgZnVydGhlciBmaWx0ZXIgYnkgdGhhdCBjb21tdW5pdHlcbiAgICAgIGlmIChjb21tdW5pdHlJZCkge1xuICAgICAgICBpZiAod2hlcmUucG9zdCkge1xuICAgICAgICAgIHdoZXJlLnBvc3Qucm9vbS5yb29tR3JvdXAuY29tbXVuaXR5LmlkID0gY29tbXVuaXR5SWQ7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgd2hlcmUucG9zdCA9IHtcbiAgICAgICAgICAgIHJvb206IHtcbiAgICAgICAgICAgICAgcm9vbUdyb3VwOiB7XG4gICAgICAgICAgICAgICAgY29tbXVuaXR5OiB7XG4gICAgICAgICAgICAgICAgICBpZDogY29tbXVuaXR5SWQsXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICByZXR1cm4gdGhpcy5wcmlzbWEuY29tbWVudC5maW5kTWFueSh7XG4gICAgICAgIHdoZXJlLFxuICAgICAgICBpbmNsdWRlOiB7XG4gICAgICAgICAgdXNlcjoge1xuICAgICAgICAgICAgc2VsZWN0OiB7XG4gICAgICAgICAgICAgIGlkOiB0cnVlLFxuICAgICAgICAgICAgICBmaXJzdE5hbWU6IHRydWUsXG4gICAgICAgICAgICAgIGxhc3ROYW1lOiB0cnVlLFxuICAgICAgICAgICAgICBhdmF0YXJVcmw6IHRydWUsXG4gICAgICAgICAgICAgIHJvbGU6IHRydWUsXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0sXG4gICAgICAgICAgcG9zdDoge1xuICAgICAgICAgICAgc2VsZWN0OiB7XG4gICAgICAgICAgICAgIGlkOiB0cnVlLFxuICAgICAgICAgICAgICB0aXRsZTogdHJ1ZSxcbiAgICAgICAgICAgICAgdXNlcklkOiB0cnVlLFxuICAgICAgICAgICAgICByb29tOiB7XG4gICAgICAgICAgICAgICAgaW5jbHVkZToge1xuICAgICAgICAgICAgICAgICAgcm9vbUdyb3VwOiB7XG4gICAgICAgICAgICAgICAgICAgIGluY2x1ZGU6IHtcbiAgICAgICAgICAgICAgICAgICAgICBjb21tdW5pdHk6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdDoge1xuICAgICAgICAgICAgICAgICAgICAgICAgICBpZDogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgc2x1ZzogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgICBfY291bnQ6IHtcbiAgICAgICAgICAgIHNlbGVjdDoge1xuICAgICAgICAgICAgICBoZWFydHM6IHRydWUsXG4gICAgICAgICAgICAgIGNoaWxkcmVuOiB0cnVlLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgICBvcmRlckJ5OiB7IGNyZWF0ZWRBdDogJ2Rlc2MnIH0sXG4gICAgICAgIHRha2U6IDIwLFxuICAgICAgfSk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRocm93IG5ldyBJbnRlcm5hbFNlcnZlckVycm9yRXhjZXB0aW9uKFxuICAgICAgICBgRmFpbGVkIHRvIHNlYXJjaCBjb21tZW50czogJHtlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6IFN0cmluZyhlcnJvcil9YCxcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgc2VhcmNoQ29tbXVuaXRpZXMocXVlcnk6IHN0cmluZykge1xuICAgIHRyeSB7XG4gICAgICByZXR1cm4gdGhpcy5wcmlzbWEuY29tbXVuaXR5LmZpbmRNYW55KHtcbiAgICAgICAgd2hlcmU6IHtcbiAgICAgICAgICBPUjogW1xuICAgICAgICAgICAgeyBuYW1lOiB7IGNvbnRhaW5zOiBxdWVyeSwgbW9kZTogJ2luc2Vuc2l0aXZlJyB9IH0sXG4gICAgICAgICAgICB7IGRlc2NyaXB0aW9uOiB7IGNvbnRhaW5zOiBxdWVyeSwgbW9kZTogJ2luc2Vuc2l0aXZlJyB9IH0sXG4gICAgICAgICAgXSxcbiAgICAgICAgfSxcbiAgICAgICAgaW5jbHVkZToge1xuICAgICAgICAgIF9jb3VudDoge1xuICAgICAgICAgICAgc2VsZWN0OiB7XG4gICAgICAgICAgICAgIG1lbWJlcnNoaXBzOiB0cnVlLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgICBvcmRlckJ5OiB7IGNyZWF0ZWRBdDogJ2Rlc2MnIH0sXG4gICAgICAgIHRha2U6IDIwLFxuICAgICAgfSk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRocm93IG5ldyBJbnRlcm5hbFNlcnZlckVycm9yRXhjZXB0aW9uKFxuICAgICAgICBgRmFpbGVkIHRvIHNlYXJjaCBjb21tdW5pdGllczogJHtlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6IFN0cmluZyhlcnJvcil9YCxcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgc2VhcmNoVXNlcnMocXVlcnk6IHN0cmluZywgcm9sZT86IHN0cmluZykge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCB3aGVyZTogYW55ID0ge1xuICAgICAgICBPUjogW1xuICAgICAgICAgIHsgZmlyc3ROYW1lOiB7IGNvbnRhaW5zOiBxdWVyeSwgbW9kZTogJ2luc2Vuc2l0aXZlJyB9IH0sXG4gICAgICAgICAgeyBsYXN0TmFtZTogeyBjb250YWluczogcXVlcnksIG1vZGU6ICdpbnNlbnNpdGl2ZScgfSB9LFxuICAgICAgICAgIHsgZW1haWw6IHsgY29udGFpbnM6IHF1ZXJ5LCBtb2RlOiAnaW5zZW5zaXRpdmUnIH0gfSxcbiAgICAgICAgXSxcbiAgICAgIH07XG5cbiAgICAgIGlmIChyb2xlKSB7XG4gICAgICAgIHdoZXJlLnJvbGUgPSByb2xlO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gdGhpcy5wcmlzbWEudXNlci5maW5kTWFueSh7XG4gICAgICAgIHdoZXJlLFxuICAgICAgICBzZWxlY3Q6IHtcbiAgICAgICAgICBpZDogdHJ1ZSxcbiAgICAgICAgICBmaXJzdE5hbWU6IHRydWUsXG4gICAgICAgICAgbGFzdE5hbWU6IHRydWUsXG4gICAgICAgICAgZW1haWw6IHRydWUsXG4gICAgICAgICAgYXZhdGFyVXJsOiB0cnVlLFxuICAgICAgICAgIHJvbGU6IHRydWUsXG4gICAgICAgICAgY3JlYXRlZEF0OiB0cnVlLFxuICAgICAgICB9LFxuICAgICAgICBvcmRlckJ5OiB7IGNyZWF0ZWRBdDogJ2Rlc2MnIH0sXG4gICAgICAgIHRha2U6IDIwLFxuICAgICAgfSk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRocm93IG5ldyBJbnRlcm5hbFNlcnZlckVycm9yRXhjZXB0aW9uKFxuICAgICAgICBgRmFpbGVkIHRvIHNlYXJjaCB1c2VyczogJHtlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6IFN0cmluZyhlcnJvcil9YCxcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgc2VhcmNoV29ya3NoZWV0cyhxdWVyeTogc3RyaW5nLCB1c2VySWQ/OiBzdHJpbmcsIHJvbGU/OiAnY2xpZW50JyB8ICd0aGVyYXBpc3QnKSB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHdoZXJlOiBhbnkgPSB7XG4gICAgICAgIE9SOiBbXG4gICAgICAgICAgeyB0aXRsZTogeyBjb250YWluczogcXVlcnksIG1vZGU6ICdpbnNlbnNpdGl2ZScgfSB9LFxuICAgICAgICAgIHsgaW5zdHJ1Y3Rpb25zOiB7IGNvbnRhaW5zOiBxdWVyeSwgbW9kZTogJ2luc2Vuc2l0aXZlJyB9IH0sXG4gICAgICAgIF0sXG4gICAgICB9O1xuXG4gICAgICAvLyBGaWx0ZXIgYnkgdXNlciByb2xlIChjbGllbnQgY2FuIG9ubHkgc2VlIHRoZWlyIG93biB3b3Jrc2hlZXRzKVxuICAgICAgaWYgKHJvbGUgPT09ICdjbGllbnQnICYmIHVzZXJJZCkge1xuICAgICAgICB3aGVyZS5jbGllbnRJZCA9IHVzZXJJZDtcbiAgICAgIH0gZWxzZSBpZiAocm9sZSA9PT0gJ3RoZXJhcGlzdCcgJiYgdXNlcklkKSB7XG4gICAgICAgIHdoZXJlLnRoZXJhcGlzdElkID0gdXNlcklkO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gdGhpcy5wcmlzbWEud29ya3NoZWV0LmZpbmRNYW55KHtcbiAgICAgICAgd2hlcmUsXG4gICAgICAgIGluY2x1ZGU6IHtcbiAgICAgICAgICBjbGllbnQ6IHtcbiAgICAgICAgICAgIHNlbGVjdDoge1xuICAgICAgICAgICAgICB1c2VySWQ6IHRydWUsXG4gICAgICAgICAgICAgIHVzZXI6IHtcbiAgICAgICAgICAgICAgICBzZWxlY3Q6IHtcbiAgICAgICAgICAgICAgICAgIGZpcnN0TmFtZTogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgIGxhc3ROYW1lOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgYXZhdGFyVXJsOiB0cnVlLFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0sXG4gICAgICAgICAgdGhlcmFwaXN0OiB7XG4gICAgICAgICAgICBzZWxlY3Q6IHtcbiAgICAgICAgICAgICAgdXNlcklkOiB0cnVlLFxuICAgICAgICAgICAgICB1c2VyOiB7XG4gICAgICAgICAgICAgICAgc2VsZWN0OiB7XG4gICAgICAgICAgICAgICAgICBmaXJzdE5hbWU6IHRydWUsXG4gICAgICAgICAgICAgICAgICBsYXN0TmFtZTogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgIGF2YXRhclVybDogdHJ1ZSxcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9LFxuICAgICAgICAgIHN1Ym1pc3Npb246IHtcbiAgICAgICAgICAgIHNlbGVjdDoge1xuICAgICAgICAgICAgICBpZDogdHJ1ZSxcbiAgICAgICAgICAgICAgc3VibWl0dGVkQXQ6IHRydWUsXG4gICAgICAgICAgICAgIGZlZWRiYWNrOiB0cnVlLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgICBvcmRlckJ5OiB7IGNyZWF0ZWRBdDogJ2Rlc2MnIH0sXG4gICAgICAgIHRha2U6IDIwLFxuICAgICAgfSk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRocm93IG5ldyBJbnRlcm5hbFNlcnZlckVycm9yRXhjZXB0aW9uKFxuICAgICAgICBgRmFpbGVkIHRvIHNlYXJjaCB3b3Jrc2hlZXRzOiAke2Vycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogU3RyaW5nKGVycm9yKX1gLFxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBzZWFyY2hNZXNzYWdlcyhxdWVyeTogc3RyaW5nLCB1c2VySWQ6IHN0cmluZykge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCB3aGVyZUNsYXVzZTogYW55ID0ge1xuICAgICAgICBBTkQ6IFtcbiAgICAgICAgICB7XG4gICAgICAgICAgICBjb250ZW50OiB7XG4gICAgICAgICAgICAgIGNvbnRhaW5zOiBxdWVyeSxcbiAgICAgICAgICAgICAgbW9kZTogJ2luc2Vuc2l0aXZlJyxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgICB7XG4gICAgICAgICAgICBpc0RlbGV0ZWQ6IGZhbHNlLFxuICAgICAgICAgIH0sXG4gICAgICAgICAge1xuICAgICAgICAgICAgY29udmVyc2F0aW9uOiB7XG4gICAgICAgICAgICAgIHBhcnRpY2lwYW50czoge1xuICAgICAgICAgICAgICAgIHNvbWU6IHtcbiAgICAgICAgICAgICAgICAgIHVzZXJJZCxcbiAgICAgICAgICAgICAgICAgIGlzQWN0aXZlOiB0cnVlLFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0sXG4gICAgICAgIF0sXG4gICAgICB9O1xuXG4gICAgICByZXR1cm4gdGhpcy5wcmlzbWEubWVzc2FnZS5maW5kTWFueSh7XG4gICAgICAgIHdoZXJlOiB3aGVyZUNsYXVzZSxcbiAgICAgICAgaW5jbHVkZToge1xuICAgICAgICAgIHNlbmRlcjoge1xuICAgICAgICAgICAgc2VsZWN0OiB7XG4gICAgICAgICAgICAgIGlkOiB0cnVlLFxuICAgICAgICAgICAgICBmaXJzdE5hbWU6IHRydWUsXG4gICAgICAgICAgICAgIGxhc3ROYW1lOiB0cnVlLFxuICAgICAgICAgICAgICBhdmF0YXJVcmw6IHRydWUsXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0sXG4gICAgICAgICAgY29udmVyc2F0aW9uOiB7XG4gICAgICAgICAgICBzZWxlY3Q6IHtcbiAgICAgICAgICAgICAgaWQ6IHRydWUsXG4gICAgICAgICAgICAgIHR5cGU6IHRydWUsXG4gICAgICAgICAgICAgIHRpdGxlOiB0cnVlLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgICBvcmRlckJ5OiB7IGNyZWF0ZWRBdDogJ2Rlc2MnIH0sXG4gICAgICAgIHRha2U6IDIwLFxuICAgICAgfSk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRocm93IG5ldyBJbnRlcm5hbFNlcnZlckVycm9yRXhjZXB0aW9uKFxuICAgICAgICBgRmFpbGVkIHRvIHNlYXJjaCBtZXNzYWdlczogJHtlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6IFN0cmluZyhlcnJvcil9YCxcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgZ2xvYmFsU2VhcmNoKFxuICAgIHF1ZXJ5OiBzdHJpbmcsXG4gICAgdHlwZXM/OlxuICAgICAgfCAoJ3RoZXJhcGlzdHMnIHwgJ3Bvc3RzJyB8ICdjb21tdW5pdGllcycgfCAndXNlcnMnIHwgJ3dvcmtzaGVldHMnIHwgJ21lc3NhZ2VzJylbXSxcbiAgICB1c2VySWQ/OiBzdHJpbmcsXG4gICAgdXNlclJvbGU/OiAnY2xpZW50JyB8ICd0aGVyYXBpc3QnIHwgJ21vZGVyYXRvcicgfCAnYWRtaW4nLFxuICApIHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgcmVzdWx0czogYW55ID0ge307XG5cbiAgICAgIC8vIERlZmF1bHQgdG8gYWxsIHR5cGVzIGlmIG5vbmUgc3BlY2lmaWVkXG4gICAgICBjb25zdCBkZWZhdWx0VHlwZXMgPSBbJ3RoZXJhcGlzdHMnLCAncG9zdHMnLCAnY29tbXVuaXRpZXMnLCAndXNlcnMnLCAnd29ya3NoZWV0cycsICdtZXNzYWdlcyddO1xuICAgICAgY29uc3QgdHlwZXNBcnJheSA9IHR5cGVzICYmIHR5cGVzLmxlbmd0aCA+IDAgPyB0eXBlcyA6IGRlZmF1bHRUeXBlcztcblxuICAgICAgaWYgKHR5cGVzQXJyYXkuaW5jbHVkZXMoJ3RoZXJhcGlzdHMnKSkge1xuICAgICAgICByZXN1bHRzLnRoZXJhcGlzdHMgPSBhd2FpdCB0aGlzLnNlYXJjaFRoZXJhcGlzdHMocXVlcnkpO1xuICAgICAgfVxuXG4gICAgICBpZiAodHlwZXNBcnJheS5pbmNsdWRlcygncG9zdHMnKSkge1xuICAgICAgICByZXN1bHRzLnBvc3RzID0gYXdhaXQgdGhpcy5zZWFyY2hQb3N0cyhxdWVyeSwgdW5kZWZpbmVkLCB1c2VySWQpO1xuICAgICAgfVxuXG4gICAgICAvLyBBZGQgY29tbWVudHMgc2VhcmNoIChhbHdheXMgZmlsdGVyZWQgYnkgdXNlciBjb21tdW5pdGllcyBpZiB1c2VySWQgaXMgcHJvdmlkZWQpXG4gICAgICBpZiAodXNlcklkKSB7XG4gICAgICAgIHJlc3VsdHMuY29tbWVudHMgPSBhd2FpdCB0aGlzLnNlYXJjaENvbW1lbnRzKHF1ZXJ5LCB1bmRlZmluZWQsIHVzZXJJZCk7XG4gICAgICB9XG5cbiAgICAgIGlmICh0eXBlc0FycmF5LmluY2x1ZGVzKCdjb21tdW5pdGllcycpKSB7XG4gICAgICAgIHJlc3VsdHMuY29tbXVuaXRpZXMgPSBhd2FpdCB0aGlzLnNlYXJjaENvbW11bml0aWVzKHF1ZXJ5KTtcbiAgICAgIH1cblxuICAgICAgaWYgKHR5cGVzQXJyYXkuaW5jbHVkZXMoJ3VzZXJzJykpIHtcbiAgICAgICAgcmVzdWx0cy51c2VycyA9IGF3YWl0IHRoaXMuc2VhcmNoVXNlcnMocXVlcnkpO1xuICAgICAgfVxuXG4gICAgICBpZiAodHlwZXNBcnJheS5pbmNsdWRlcygnd29ya3NoZWV0cycpKSB7XG4gICAgICAgIC8vIE9ubHkgc2VhcmNoIHdvcmtzaGVldHMgaWYgdXNlciBoYXMgYXBwcm9wcmlhdGUgcGVybWlzc2lvbnNcbiAgICAgICAgaWYgKHVzZXJSb2xlID09PSAnY2xpZW50JyB8fCB1c2VyUm9sZSA9PT0gJ3RoZXJhcGlzdCcpIHtcbiAgICAgICAgICByZXN1bHRzLndvcmtzaGVldHMgPSBhd2FpdCB0aGlzLnNlYXJjaFdvcmtzaGVldHMocXVlcnksIHVzZXJJZCwgdXNlclJvbGUpO1xuICAgICAgICB9IGVsc2UgaWYgKHVzZXJSb2xlID09PSAnbW9kZXJhdG9yJyB8fCB1c2VyUm9sZSA9PT0gJ2FkbWluJykge1xuICAgICAgICAgIC8vIEFkbWlucyBhbmQgbW9kZXJhdG9ycyBjYW4gc2VlIGFsbCB3b3Jrc2hlZXRzXG4gICAgICAgICAgcmVzdWx0cy53b3Jrc2hlZXRzID0gYXdhaXQgdGhpcy5zZWFyY2hXb3Jrc2hlZXRzKHF1ZXJ5KTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICBpZiAodHlwZXNBcnJheS5pbmNsdWRlcygnbWVzc2FnZXMnKSAmJiB1c2VySWQpIHtcbiAgICAgICAgLy8gTWVzc2FnZXMgYXJlIGFsd2F5cyBwcml2YXRlIHRvIHRoZSB1c2VyXG4gICAgICAgIHJlc3VsdHMubWVzc2FnZXMgPSBhd2FpdCB0aGlzLnNlYXJjaE1lc3NhZ2VzKHF1ZXJ5LCB1c2VySWQpO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gcmVzdWx0cztcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhyb3cgbmV3IEludGVybmFsU2VydmVyRXJyb3JFeGNlcHRpb24oXG4gICAgICAgIGBGYWlsZWQgdG8gcGVyZm9ybSBnbG9iYWwgc2VhcmNoOiAke2Vycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogU3RyaW5nKGVycm9yKX1gLFxuICAgICAgKTtcbiAgICB9XG4gIH1cbn1cbiJdLCJ2ZXJzaW9uIjozfQ==