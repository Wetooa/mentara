9ca6148314e3d53eaa0b776dd23bf303
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.TEST_TIMEOUT = void 0;
// Mock external dependencies
jest.mock('axios');
jest.mock('@clerk/backend', () => ({
    clerkClient: {
        users: {
            getUser: jest.fn(),
            updateUser: jest.fn(),
            deleteUser: jest.fn(),
        },
    },
    createClerkClient: jest.fn(),
}));
require("reflect-metadata");
// Global test setup for unit tests
beforeAll(async () => {
    // Set test environment variables
    process.env.NODE_ENV = 'test';
    process.env.DATABASE_URL =
        process.env.TEST_DATABASE_URL ||
            'postgresql://test:test@localhost:5432/mentara_test';
    // Disable external services in tests
    process.env.DISABLE_CLERK_WEBHOOK = 'true';
    process.env.DISABLE_EMAIL_SERVICE = 'true';
    process.env.DISABLE_AI_SERVICE = 'true';
    // Test-specific configurations
    process.env.JWT_SECRET = 'test-jwt-secret-key';
    process.env.ENCRYPTION_KEY = 'test-encryption-key-32-chars!!';
});
// Note: File upload and AI service mocks will be added per-test as needed
// This prevents global module resolution issues when dependencies aren't installed
// Enhanced console mocking with test insights
const originalConsole = { ...console };
global.console = {
    ...console,
    // Suppress console.log during tests unless explicitly needed
    log: jest.fn((message) => {
        if (process.env.DEBUG_TESTS === 'true') {
            originalConsole.log('[TEST DEBUG]', message);
        }
    }),
    debug: jest.fn(),
    info: jest.fn(),
    warn: (message) => {
        if (process.env.SHOW_WARNINGS === 'true') {
            originalConsole.warn('[TEST WARN]', message);
        }
    },
    error: originalConsole.error, // Always show errors
};
// Setup global test timeout
jest.setTimeout(10000);
// Enhanced cleanup after each test
afterEach(async () => {
    jest.clearAllMocks();
    jest.clearAllTimers();
    // Reset environment variables that might have been modified
    delete process.env.TEST_USER_ID;
    delete process.env.TEST_ROLE;
});
// Global cleanup
afterAll(async () => {
    // Clean up any remaining async operations
    await new Promise((resolve) => setTimeout(resolve, 100));
});
// Test environment validation
if (process.env.JEST_TEST_TYPE === 'integration' &&
    !process.env.DATABASE_URL?.includes('test')) {
    throw new Error('Integration tests must use a test database. DATABASE_URL must contain "test"');
}
// Prevent tests from running against production database
if (process.env.DATABASE_URL?.includes('prod')) {
    throw new Error('Tests cannot run against production database!');
}
// Enhanced test timeouts with categories
exports.TEST_TIMEOUT = {
    UNIT: 5000,
    INTEGRATION: 15000,
    E2E: 30000,
    DATABASE: 20000,
    ASYNC_OPERATION: 10000,
};
// Test performance tracking
const testStartTimes = new Map();
beforeEach(() => {
    const testName = expect.getState().currentTestName;
    testStartTimes.set(testName, Date.now());
});
afterEach(() => {
    const testName = expect.getState().currentTestName;
    const startTime = testStartTimes.get(testName);
    if (startTime && process.env.TRACK_TEST_PERFORMANCE === 'true') {
        const duration = Date.now() - startTime;
        if (duration > 1000) {
            console.warn(`Slow test detected: ${testName} took ${duration}ms`);
        }
    }
    testStartTimes.delete(testName);
});
// Global error handlers for unhandled promises
process.on('unhandledRejection', (reason, promise) => {
    console.error('Unhandled Rejection at:', promise, 'reason:', reason);
});
process.on('uncaughtException', (error) => {
    console.error('Uncaught Exception:', error);
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL3Rlc3QtdXRpbHMvamVzdC5zZXR1cC50cyIsIm1hcHBpbmdzIjoiOzs7QUFvQkEsNkJBQTZCO0FBQzdCLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7QUFDbkIsSUFBSSxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsRUFBRSxHQUFHLEVBQUUsQ0FBQyxDQUFDO0lBQ2pDLFdBQVcsRUFBRTtRQUNYLEtBQUssRUFBRTtZQUNMLE9BQU8sRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO1lBQ2xCLFVBQVUsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO1lBQ3JCLFVBQVUsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO1NBQ3RCO0tBQ0Y7SUFDRCxpQkFBaUIsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO0NBQzdCLENBQUMsQ0FBQyxDQUFDO0FBL0JKLDRCQUEwQjtBQUUxQixtQ0FBbUM7QUFDbkMsU0FBUyxDQUFDLEtBQUssSUFBSSxFQUFFO0lBQ25CLGlDQUFpQztJQUNqQyxPQUFPLENBQUMsR0FBRyxDQUFDLFFBQVEsR0FBRyxNQUFNLENBQUM7SUFDOUIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxZQUFZO1FBQ3RCLE9BQU8sQ0FBQyxHQUFHLENBQUMsaUJBQWlCO1lBQzdCLG9EQUFvRCxDQUFDO0lBRXZELHFDQUFxQztJQUNyQyxPQUFPLENBQUMsR0FBRyxDQUFDLHFCQUFxQixHQUFHLE1BQU0sQ0FBQztJQUMzQyxPQUFPLENBQUMsR0FBRyxDQUFDLHFCQUFxQixHQUFHLE1BQU0sQ0FBQztJQUMzQyxPQUFPLENBQUMsR0FBRyxDQUFDLGtCQUFrQixHQUFHLE1BQU0sQ0FBQztJQUV4QywrQkFBK0I7SUFDL0IsT0FBTyxDQUFDLEdBQUcsQ0FBQyxVQUFVLEdBQUcscUJBQXFCLENBQUM7SUFDL0MsT0FBTyxDQUFDLEdBQUcsQ0FBQyxjQUFjLEdBQUcsZ0NBQWdDLENBQUM7QUFDaEUs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QUcsTUFBTSxDQUFDLFFBQVEsRUFBRSxDQUFDLGVBQWUsQ0FBQztJQUNuRCxNQUFNLFNBQVMsR0FBRyxjQUFjLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxDQUFDO0lBQy9DLElBQUksU0FBUyxJQUFJLE9BQU8sQ0FBQyxHQUFHLENBQUMsc0JBQXNCLEtBQUssTUFBTSxFQUFFLENBQUM7UUFDL0QsTUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLEdBQUcsRUFBRSxHQUFHLFNBQVMsQ0FBQztRQUN4QyxJQUFJLFFBQVEsR0FBRyxJQUFJLEVBQUUsQ0FBQztZQUNwQixPQUFPLENBQUMsSUFBSSxDQUFDLHVCQUF1QixRQUFRLFNBQVMsUUFBUSxJQUFJLENBQUMsQ0FBQztRQUNyRSxDQUFDO0lBQ0gsQ0FBQztJQUNELGNBQWMsQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLENBQUM7QUFDbEMsQ0FBQyxDQUFDLENBQUM7QUFFSCwrQ0FBK0M7QUFDL0MsT0FBTyxDQUFDLEVBQUUsQ0FBQyxvQkFBb0IsRUFBRSxDQUFDLE1BQU0sRUFBRSxPQUFPLEVBQUUsRUFBRTtJQUNuRCxPQUFPLENBQUMsS0FBSyxDQUFDLHlCQUF5QixFQUFFLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxDQUFDLENBQUM7QUFDdkUsQ0FBQyxDQUFDLENBQUM7QUFFSCxPQUFPLENBQUMsRUFBRSxDQUFDLG1CQUFtQixFQUFFLENBQUMsS0FBSyxFQUFFLEVBQUU7SUFDeEMsT0FBTyxDQUFDLEtBQUssQ0FBQyxxQkFBcUIsRUFBRSxLQUFLLENBQUMsQ0FBQztBQUM5QyxDQUFDLENBQUMsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvaG9tZS93ZXRvb2EvRG9jdW1lbnRzL2NvZGUvcHJvamVjdHMvbWVudGFyYS9tZW50YXJhLWFwaS9zcmMvdGVzdC11dGlscy9qZXN0LnNldHVwLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAncmVmbGVjdC1tZXRhZGF0YSc7XG5cbi8vIEdsb2JhbCB0ZXN0IHNldHVwIGZvciB1bml0IHRlc3RzXG5iZWZvcmVBbGwoYXN5bmMgKCkgPT4ge1xuICAvLyBTZXQgdGVzdCBlbnZpcm9ubWVudCB2YXJpYWJsZXNcbiAgcHJvY2Vzcy5lbnYuTk9ERV9FTlYgPSAndGVzdCc7XG4gIHByb2Nlc3MuZW52LkRBVEFCQVNFX1VSTCA9XG4gICAgcHJvY2Vzcy5lbnYuVEVTVF9EQVRBQkFTRV9VUkwgfHxcbiAgICAncG9zdGdyZXNxbDovL3Rlc3Q6dGVzdEBsb2NhbGhvc3Q6NTQzMi9tZW50YXJhX3Rlc3QnO1xuXG4gIC8vIERpc2FibGUgZXh0ZXJuYWwgc2VydmljZXMgaW4gdGVzdHNcbiAgcHJvY2Vzcy5lbnYuRElTQUJMRV9DTEVSS19XRUJIT09LID0gJ3RydWUnO1xuICBwcm9jZXNzLmVudi5ESVNBQkxFX0VNQUlMX1NFUlZJQ0UgPSAndHJ1ZSc7XG4gIHByb2Nlc3MuZW52LkRJU0FCTEVfQUlfU0VSVklDRSA9ICd0cnVlJztcblxuICAvLyBUZXN0LXNwZWNpZmljIGNvbmZpZ3VyYXRpb25zXG4gIHByb2Nlc3MuZW52LkpXVF9TRUNSRVQgPSAndGVzdC1qd3Qtc2VjcmV0LWtleSc7XG4gIHByb2Nlc3MuZW52LkVOQ1JZUFRJT05fS0VZID0gJ3Rlc3QtZW5jcnlwdGlvbi1rZXktMzItY2hhcnMhISc7XG59KTtcblxuLy8gTW9jayBleHRlcm5hbCBkZXBlbmRlbmNpZXNcbmplc3QubW9jaygnYXhpb3MnKTtcbmplc3QubW9jaygnQGNsZXJrL2JhY2tlbmQnLCAoKSA9PiAoe1xuICBjbGVya0NsaWVudDoge1xuICAgIHVzZXJzOiB7XG4gICAgICBnZXRVc2VyOiBqZXN0LmZuKCksXG4gICAgICB1cGRhdGVVc2VyOiBqZXN0LmZuKCksXG4gICAgICBkZWxldGVVc2VyOiBqZXN0LmZuKCksXG4gICAgfSxcbiAgfSxcbiAgY3JlYXRlQ2xlcmtDbGllbnQ6IGplc3QuZm4oKSxcbn0pKTtcblxuLy8gTm90ZTogRmlsZSB1cGxvYWQgYW5kIEFJIHNlcnZpY2UgbW9ja3Mgd2lsbCBiZSBhZGRlZCBwZXItdGVzdCBhcyBuZWVkZWRcbi8vIFRoaXMgcHJldmVudHMgZ2xvYmFsIG1vZHVsZSByZXNvbHV0aW9uIGlzc3VlcyB3aGVuIGRlcGVuZGVuY2llcyBhcmVuJ3QgaW5zdGFsbGVkXG5cbi8vIEVuaGFuY2VkIGNvbnNvbGUgbW9ja2luZyB3aXRoIHRlc3QgaW5zaWdodHNcbmNvbnN0IG9yaWdpbmFsQ29uc29sZSA9IHsgLi4uY29uc29sZSB9O1xuZ2xvYmFsLmNvbnNvbGUgPSB7XG4gIC4uLmNvbnNvbGUsXG4gIC8vIFN1cHByZXNzIGNvbnNvbGUubG9nIGR1cmluZyB0ZXN0cyB1bmxlc3MgZXhwbGljaXRseSBuZWVkZWRcbiAgbG9nOiBqZXN0LmZuKChtZXNzYWdlKSA9PiB7XG4gICAgaWYgKHByb2Nlc3MuZW52LkRFQlVHX1RFU1RTID09PSAndHJ1ZScpIHtcbiAgICAgIG9yaWdpbmFsQ29uc29sZS5sb2coJ1tURVNUIERFQlVHXScsIG1lc3NhZ2UpO1xuICAgIH1cbiAgfSksXG4gIGRlYnVnOiBqZXN0LmZuKCksXG4gIGluZm86IGplc3QuZm4oKSxcbiAgd2FybjogKG1lc3NhZ2UpID0+IHtcbiAgICBpZiAocHJvY2Vzcy5lbnYuU0hPV19XQVJOSU5HUyA9PT0gJ3RydWUnKSB7XG4gICAgICBvcmlnaW5hbENvbnNvbGUud2FybignW1RFU1QgV0FSTl0nLCBtZXNzYWdlKTtcbiAgICB9XG4gIH0sXG4gIGVycm9yOiBvcmlnaW5hbENvbnNvbGUuZXJyb3IsIC8vIEFsd2F5cyBzaG93IGVycm9yc1xufTtcblxuLy8gU2V0dXAgZ2xvYmFsIHRlc3QgdGltZW91dFxuamVzdC5zZXRUaW1lb3V0KDEwMDAwKTtcblxuLy8gRW5oYW5jZWQgY2xlYW51cCBhZnRlciBlYWNoIHRlc3RcbmFmdGVyRWFjaChhc3luYyAoKSA9PiB7XG4gIGplc3QuY2xlYXJBbGxNb2NrcygpO1xuICBqZXN0LmNsZWFyQWxsVGltZXJzKCk7XG5cbiAgLy8gUmVzZXQgZW52aXJvbm1lbnQgdmFyaWFibGVzIHRoYXQgbWlnaHQgaGF2ZSBiZWVuIG1vZGlmaWVkXG4gIGRlbGV0ZSBwcm9jZXNzLmVudi5URVNUX1VTRVJfSUQ7XG4gIGRlbGV0ZSBwcm9jZXNzLmVudi5URVNUX1JPTEU7XG59KTtcblxuLy8gR2xvYmFsIGNsZWFudXBcbmFmdGVyQWxsKGFzeW5jICgpID0+IHtcbiAgLy8gQ2xlYW4gdXAgYW55IHJlbWFpbmluZyBhc3luYyBvcGVyYXRpb25zXG4gIGF3YWl0IG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiBzZXRUaW1lb3V0KHJlc29sdmUsIDEwMCkpO1xufSk7XG5cbi8vIFRlc3QgZW52aXJvbm1lbnQgdmFsaWRhdGlvblxuaWYgKFxuICBwcm9jZXNzLmVudi5KRVNUX1RFU1RfVFlQRSA9PT0gJ2ludGVncmF0aW9uJyAmJlxuICAhcHJvY2Vzcy5lbnYuREFUQUJBU0VfVVJMPy5pbmNsdWRlcygndGVzdCcpXG4pIHtcbiAgdGhyb3cgbmV3IEVycm9yKFxuICAgICdJbnRlZ3JhdGlvbiB0ZXN0cyBtdXN0IHVzZSBhIHRlc3QgZGF0YWJhc2UuIERBVEFCQVNFX1VSTCBtdXN0IGNvbnRhaW4gXCJ0ZXN0XCInLFxuICApO1xufVxuXG4vLyBQcmV2ZW50IHRlc3RzIGZyb20gcnVubmluZyBhZ2FpbnN0IHByb2R1Y3Rpb24gZGF0YWJhc2VcbmlmIChwcm9jZXNzLmVudi5EQVRBQkFTRV9VUkw/LmluY2x1ZGVzKCdwcm9kJykpIHtcbiAgdGhyb3cgbmV3IEVycm9yKCdUZXN0cyBjYW5ub3QgcnVuIGFnYWluc3QgcHJvZHVjdGlvbiBkYXRhYmFzZSEnKTtcbn1cblxuLy8gR2xvYmFsIHRlc3QgY29uc3RhbnRzXG5kZWNsYXJlIGdsb2JhbCB7XG4gIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tbmFtZXNwYWNlXG4gIG5hbWVzcGFjZSBOb2RlSlMge1xuICAgIGludGVyZmFjZSBHbG9iYWwge1xuICAgICAgdGVzdERiOiBhbnk7XG4gICAgICB0ZXN0RmFjdG9yeTogYW55O1xuICAgIH1cbiAgfVxufVxuXG4vLyBFbmhhbmNlZCB0ZXN0IHRpbWVvdXRzIHdpdGggY2F0ZWdvcmllc1xuZXhwb3J0IGNvbnN0IFRFU1RfVElNRU9VVCA9IHtcbiAgVU5JVDogNTAwMCxcbiAgSU5URUdSQVRJT046IDE1MDAwLFxuICBFMkU6IDMwMDAwLFxuICBEQVRBQkFTRTogMjAwMDAsXG4gIEFTWU5DX09QRVJBVElPTjogMTAwMDAsXG59O1xuXG4vLyBUZXN0IHBlcmZvcm1hbmNlIHRyYWNraW5nXG5jb25zdCB0ZXN0U3RhcnRUaW1lcyA9IG5ldyBNYXAoKTtcblxuYmVmb3JlRWFjaCgoKSA9PiB7XG4gIGNvbnN0IHRlc3ROYW1lID0gZXhwZWN0LmdldFN0YXRlKCkuY3VycmVudFRlc3ROYW1lO1xuICB0ZXN0U3RhcnRUaW1lcy5zZXQodGVzdE5hbWUsIERhdGUubm93KCkpO1xufSk7XG5cbmFmdGVyRWFjaCgoKSA9PiB7XG4gIGNvbnN0IHRlc3ROYW1lID0gZXhwZWN0LmdldFN0YXRlKCkuY3VycmVudFRlc3ROYW1lO1xuICBjb25zdCBzdGFydFRpbWUgPSB0ZXN0U3RhcnRUaW1lcy5nZXQodGVzdE5hbWUpO1xuICBpZiAoc3RhcnRUaW1lICYmIHByb2Nlc3MuZW52LlRSQUNLX1RFU1RfUEVSRk9STUFOQ0UgPT09ICd0cnVlJykge1xuICAgIGNvbnN0IGR1cmF0aW9uID0gRGF0ZS5ub3coKSAtIHN0YXJ0VGltZTtcbiAgICBpZiAoZHVyYXRpb24gPiAxMDAwKSB7XG4gICAgICBjb25zb2xlLndhcm4oYFNsb3cgdGVzdCBkZXRlY3RlZDogJHt0ZXN0TmFtZX0gdG9vayAke2R1cmF0aW9ufW1zYCk7XG4gICAgfVxuICB9XG4gIHRlc3RTdGFydFRpbWVzLmRlbGV0ZSh0ZXN0TmFtZSk7XG59KTtcblxuLy8gR2xvYmFsIGVycm9yIGhhbmRsZXJzIGZvciB1bmhhbmRsZWQgcHJvbWlzZXNcbnByb2Nlc3Mub24oJ3VuaGFuZGxlZFJlamVjdGlvbicsIChyZWFzb24sIHByb21pc2UpID0+IHtcbiAgY29uc29sZS5lcnJvcignVW5oYW5kbGVkIFJlamVjdGlvbiBhdDonLCBwcm9taXNlLCAncmVhc29uOicsIHJlYXNvbik7XG59KTtcblxucHJvY2Vzcy5vbigndW5jYXVnaHRFeGNlcHRpb24nLCAoZXJyb3IpID0+IHtcbiAgY29uc29sZS5lcnJvcignVW5jYXVnaHQgRXhjZXB0aW9uOicsIGVycm9yKTtcbn0pO1xuIl0sInZlcnNpb24iOjN9