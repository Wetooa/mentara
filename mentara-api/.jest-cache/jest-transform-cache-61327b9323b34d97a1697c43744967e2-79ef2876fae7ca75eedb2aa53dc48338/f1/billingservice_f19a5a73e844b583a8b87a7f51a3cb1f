9ac6e6d44cdb8577785744a1fe42d056
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var BillingService_1;
var _a, _b;
Object.defineProperty(exports, "__esModule", { value: true });
exports.BillingService = void 0;
const common_1 = require("@nestjs/common");
const prisma_client_provider_1 = require("src/providers/prisma-client.provider");
const event_emitter_1 = require("@nestjs/event-emitter");
const client_1 = require("@prisma/client");
/**
 * Educational Billing Service for Mental Health Platform
 *
 * This service provides a simplified, educational payment processing system
 * suitable for a school project. It simulates real payment flows without
 * processing actual money.
 *
 * Features:
 * - Mock payment processing for therapy sessions
 * - Payment method management
 * - Educational payment flows
 * - Realistic payment failures and retries
 */
let BillingService = BillingService_1 = class BillingService {
    prisma;
    eventEmitter;
    logger = new common_1.Logger(BillingService_1.name);
    constructor(prisma, eventEmitter) {
        this.prisma = prisma;
        this.eventEmitter = eventEmitter;
    }
    // ===== PAYMENT METHODS =====
    /**
     * Create a new payment method for a user
     */
    async createPaymentMethod(data) {
        this.logger.log(`Creating payment method for user ${data.userId}`);
        // If this is set as default, unset other default payment methods
        if (data.isDefault) {
            await this.prisma.paymentMethod.updateMany({
                where: { userId: data.userId, isDefault: true },
                data: { isDefault: false },
            });
        }
        const paymentMethod = await this.prisma.paymentMethod.create({
            data: {
                userId: data.userId,
                type: data.type,
                cardLast4: data.cardLast4,
                cardBrand: data.cardBrand,
                isDefault: data.isDefault || false,
            },
        });
        this.eventEmitter.emit('payment_method.created', {
            userId: data.userId,
            paymentMethodId: paymentMethod.id,
            type: data.type,
        });
        return paymentMethod;
    }
    /**
     * Get all payment methods for a user
     */
    async getUserPaymentMethods(userId) {
        return this.prisma.paymentMethod.findMany({
            where: { userId },
            orderBy: [{ isDefault: 'desc' }, { createdAt: 'desc' }],
        });
    }
    /**
     * Update payment method settings
     */
    async updatePaymentMethod(id, data) {
        const paymentMethod = await this.prisma.paymentMethod.findUnique({
            where: { id },
        });
        if (!paymentMethod) {
            throw new common_1.NotFoundException(`Payment method ${id} not found`);
        }
        // If setting as default, unset other defaults for this user
        if (data.isDefault) {
            await this.prisma.paymentMethod.updateMany({
                where: { userId: paymentMethod.userId, isDefault: true },
                data: { isDefault: false },
            });
        }
        return this.prisma.paymentMethod.update({
            where: { id },
            data,
        });
    }
    /**
     * Delete (soft delete) a payment method
     */
    async deletePaymentMethod(id) {
        const paymentMethod = await this.prisma.paymentMethod.findUnique({
            where: { id },
        });
        if (!paymentMethod) {
            throw new common_1.NotFoundException(`Payment method ${id} not found`);
        }
        // Cannot delete the only payment method if user has pending payments
        const otherMethods = await this.prisma.paymentMethod.count({
            where: {
                userId: paymentMethod.userId,
                id: { not: id }
            },
        });
        const pendingPayments = await this.prisma.payment.count({
            where: {
                OR: [
                    { clientId: paymentMethod.userId },
                    { therapistId: paymentMethod.userId }
                ],
                status: client_1.PaymentStatus.PENDING,
            },
        });
        if (otherMethods === 0 && pendingPayments > 0) {
            throw new common_1.BadRequestException('Cannot delete the only payment method with pending payments');
        }
        await this.prisma.paymentMethod.delete({
            where: { id },
        });
        this.eventEmitter.emit('payment_method.deleted', {
            userId: paymentMethod.userId,
            paymentMethodId: id,
        });
        return { success: true };
    }
    /**
     * Create automatic mock payment for booking (used when payment is mocked/automatic)
     * This creates a COMPLETED payment record without requiring payment method validation
     */
    async createAutomaticMockPayment(data, tx) {
        this.logger.log(`Creating automatic mock payment: ${data.amount} ${data.currency || 'USD'} for meeting ${data.meetingId}`);
        const prismaClient = tx || this.prisma;
        // Create completed payment record (mock payment is always successful)
        const payment = await prismaClient.payment.create({
            data: {
                amount: data.amount,
                currency: data.currency || 'USD',
                status: 'COMPLETED', // Mock payment is always successful
                client: { connect: { userId: data.clientId } },
                therapist: { connect: { userId: data.therapistId } },
                meetingId: data.meetingId,
                paymentMethodId: null, // No payment method needed for mock
                processedAt: new Date(),
                failureReason: null,
            },
            include: {
                client: {
                    select: {
                        user: {
                            select: { firstName: true, lastName: true, email: true }
                        }
                    }
                },
                therapist: {
                    select: {
                        user: {
                            select: { firstName: true, lastName: true, email: true }
                        }
                    }
                },
            },
        });
        this.logger.log(`Mock payment created successfully: ${payment.id}`);
        return payment;
    }
    // ===== PAYMENT PROCESSING =====
    /**
     * Process a payment for a therapy session
     */
    async processSessionPayment(data) {
        this.logger.log(`Processing session payment: ${data.amount} ${data.currency || 'USD'} from client ${data.clientId} to therapist ${data.therapistId}`);
        // Validate payment method belongs to client
        const paymentMethod = await this.prisma.paymentMethod.findFirst({
            where: {
                id: data.paymentMethodId,
                userId: data.clientId,
            },
        });
        if (!paymentMethod) {
            throw new common_1.BadRequestException('Invalid payment method');
        }
        // Create payment record
        const paymentData = {
            amount: data.amount,
            currency: data.currency || 'USD',
            status: client_1.PaymentStatus.PENDING,
            client: { connect: { userId: data.clientId } },
            therapist: { connect: { userId: data.therapistId } },
            paymentMethodId: data.paymentMethodId,
            failureReason: null,
        };
        // Only include meetingId if it's defined
        if (data.meetingId) {
            paymentData.meetingId = data.meetingId;
        }
        const payment = await this.prisma.payment.create({
            data: paymentData,
            include: {
                client: {
                    select: {
                        user: {
                            select: { firstName: true, lastName: true, email: true }
                        }
                    }
                },
                therapist: {
                    select: {
                        user: {
                            select: { firstName: true, lastName: true, email: true }
                        }
                    }
                },
                paymentMethod: true,
            },
        });
        // Process payment asynchronously
        this.processPaymentAsync(payment.id).catch((error) => {
            this.logger.error(`Failed to process payment ${payment.id}:`, error);
        });
        return payment;
    }
    /**
     * Asynchronously process the payment with mock payment gateway
     */
    async processPaymentAsync(paymentId) {
        // Simulate payment processing delay
        await new Promise(resolve => setTimeout(resolve, 2000 + Math.random() * 3000));
        const payment = await this.prisma.payment.findUnique({
            where: { id: paymentId },
            include: {
                client: {
                    select: {
                        user: {
                            select: { firstName: true, lastName: true, email: true }
                        }
                    }
                },
                therapist: {
                    select: {
                        user: {
                            select: { firstName: true, lastName: true, email: true }
                        }
                    }
                },
                paymentMethod: true,
            },
        });
        if (!payment) {
            this.logger.error(`Payment ${paymentId} not found during processing`);
            return;
        }
        // Mock payment processing with realistic success/failure rates
        const success = this.mockPaymentGateway(payment);
        if (success) {
            await this.handlePaymentSuccess(payment);
        }
        else {
            await this.handlePaymentFailure(payment);
        }
    }
    /**
     * Mock payment gateway simulation
     * Returns true for success, false for failure
     */
    mockPaymentGateway(payment) {
        // Simulate different failure scenarios based on card details
        const cardLast4 = payment.paymentMethod?.cardLast4;
        // Test card numbers for specific scenarios
        if (cardLast4) {
            switch (cardLast4) {
                case '0002': // Always decline
                    return false;
                case '0004': // Always decline with insufficient funds
                    return false;
                case '0008': // Always decline with expired card
                    return false;
                case '0001': // Always succeed
                    return true;
                default:
                    // Random success/failure (90% success rate)
                    return Math.random() > 0.1;
            }
        }
        // Default: 90% success rate
        return Math.random() > 0.1;
    }
    /**
     * Handle successful payment
     */
    async handlePaymentSuccess(payment) {
        this.logger.log(`Payment ${payment.id} processed successfully`);
        const updatedPayment = await this.prisma.payment.update({
            where: { id: payment.id },
            data: {
                status: client_1.PaymentStatus.COMPLETED,
                processedAt: new Date(),
            },
        });
        // Calculate platform fee (e.g., 5% platform commission)
        const platformFeeRate = 0.05;
        const platformFee = Number(payment.amount) * platformFeeRate;
        const therapistAmount = Number(payment.amount) - platformFee;
        // Emit payment success event
        this.eventEmitter.emit('payment.succeeded', {
            paymentId: payment.id,
            clientId: payment.clientId,
            therapistId: payment.therapistId,
            amount: Number(payment.amount),
            currency: payment.currency,
            platformFee,
            therapistAmount,
            meetingId: payment.meetingId,
        });
        return updatedPayment;
    }
    /**
     * Handle failed payment
     */
    async handlePaymentFailure(payment) {
        const failureReasons = [
            'Insufficient funds',
            'Card declined',
            'Expired card',
            'Invalid card number',
            'Network error',
        ];
        const failureReason = failureReasons[Math.floor(Math.random() * failureReasons.length)];
        this.logger.warn(`Payment ${payment.id} failed: ${failureReason}`);
        const updatedPayment = await this.prisma.payment.update({
            where: { id: payment.id },
            data: {
                status: client_1.PaymentStatus.FAILED,
                failedAt: new Date(),
                failureReason,
            },
        });
        // Emit payment failure event
        this.eventEmitter.emit('payment.failed', {
            paymentId: payment.id,
            clientId: payment.clientId,
            therapistId: payment.therapistId,
            amount: Number(payment.amount),
            currency: payment.currency,
            failureReason,
            meetingId: payment.meetingId,
        });
        return updatedPayment;
    }
    // ===== PAYMENT QUERIES =====
    /**
     * Get payment by ID
     */
    async getPayment(id) {
        const payment = await this.prisma.payment.findUnique({
            where: { id },
            include: {
                client: {
                    select: {
                        user: {
                            select: { firstName: true, lastName: true, email: true }
                        }
                    }
                },
                therapist: {
                    select: {
                        user: {
                            select: { firstName: true, lastName: true, email: true }
                        }
                    }
                },
                paymentMethod: true,
                meeting: {
                    select: { startTime: true, endTime: true, title: true }
                },
            },
        });
        if (!payment) {
            throw new common_1.NotFoundException(`Payment ${id} not found`);
        }
        return payment;
    }
    /**
     * Get payments for a user (as client or therapist)
     */
    async getUserPayments(userId, options = {}) {
        const where = {};
        if (options.role === 'client') {
            where.clientId = userId;
        }
        else if (options.role === 'therapist') {
            where.therapistId = userId;
        }
        else {
            where.OR = [
                { clientId: userId },
                { therapistId: userId },
            ];
        }
        if (options.status) {
            where.status = options.status;
        }
        return this.prisma.payment.findMany({
            where,
            include: {
                client: {
                    select: {
                        user: {
                            select: { firstName: true, lastName: true, email: true }
                        }
                    }
                },
                therapist: {
                    select: {
                        user: {
                            select: { firstName: true, lastName: true, email: true }
                        }
                    }
                },
                paymentMethod: true,
                meeting: {
                    select: { startTime: true, endTime: true, title: true }
                },
            },
            orderBy: { createdAt: 'desc' },
            take: options.limit || 50,
            skip: options.offset || 0,
        });
    }
    /**
     * Retry a failed payment
     */
    async retryPayment(paymentId) {
        const payment = await this.prisma.payment.findUnique({
            where: { id: paymentId },
        });
        if (!payment) {
            throw new common_1.NotFoundException(`Payment ${paymentId} not found`);
        }
        if (payment.status !== client_1.PaymentStatus.FAILED) {
            throw new common_1.BadRequestException('Can only retry failed payments');
        }
        // Reset payment to pending and retry
        await this.prisma.payment.update({
            where: { id: paymentId },
            data: {
                status: client_1.PaymentStatus.PENDING,
                failureReason: null,
                failedAt: null,
            },
        });
        // Process payment again
        this.processPaymentAsync(paymentId).catch((error) => {
            this.logger.error(`Failed to retry payment ${paymentId}:`, error);
        });
        return { success: true, message: 'Payment retry initiated' };
    }
    // ===== ANALYTICS & REPORTING =====
    /**
     * Get payment statistics for therapists
     */
    async getTherapistPaymentStats(therapistId, startDate, endDate) {
        const where = {
            therapistId,
            status: client_1.PaymentStatus.COMPLETED,
        };
        if (startDate) {
            where.processedAt = { ...where.processedAt, gte: startDate };
        }
        if (endDate) {
            where.processedAt = { ...where.processedAt, lte: endDate };
        }
        const [totalPayments, stats] = await Promise.all([
            this.prisma.payment.count({ where }),
            this.prisma.payment.aggregate({
                where,
                _sum: { amount: true },
                _avg: { amount: true },
            }),
        ]);
        const totalRevenue = Number(stats._sum.amount || 0);
        const averageSessionRate = Number(stats._avg.amount || 0);
        const platformFeeRate = 0.05;
        const platformFees = totalRevenue * platformFeeRate;
        const netEarnings = totalRevenue - platformFees;
        return {
            totalSessions: totalPayments,
            totalRevenue,
            averageSessionRate,
            platformFees,
            netEarnings,
            period: {
                startDate,
                endDate,
            },
        };
    }
    /**
     * Get platform billing statistics (admin only)
     */
    async getPlatformStats(startDate, endDate) {
        const where = {};
        if (startDate) {
            where.createdAt = { ...where.createdAt, gte: startDate };
        }
        if (endDate) {
            where.createdAt = { ...where.createdAt, lte: endDate };
        }
        const [totalPayments, successfulPayments, failedPayments, revenueStats,] = await Promise.all([
            this.prisma.payment.count({ where }),
            this.prisma.payment.count({
                where: { ...where, status: client_1.PaymentStatus.COMPLETED }
            }),
            this.prisma.payment.count({
                where: { ...where, status: client_1.PaymentStatus.FAILED }
            }),
            this.prisma.payment.aggregate({
                where: { ...where, status: client_1.PaymentStatus.COMPLETED },
                _sum: { amount: true },
            }),
        ]);
        const totalRevenue = Number(revenueStats._sum.amount || 0);
        const platformFeeRate = 0.05;
        const platformRevenue = totalRevenue * platformFeeRate;
        const successRate = totalPayments > 0 ? (successfulPayments / totalPayments) * 100 : 0;
        return {
            totalPayments,
            successfulPayments,
            failedPayments,
            successRate,
            totalRevenue,
            platformRevenue,
            therapistPayouts: totalRevenue - platformRevenue,
            period: {
                startDate,
                endDate,
            },
        };
    }
};
exports.BillingService = BillingService;
exports.BillingService = BillingService = BillingService_1 = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [typeof (_a = typeof prisma_client_provider_1.PrismaService !== "undefined" && prisma_client_provider_1.PrismaService) === "function" ? _a : Object, typeof (_b = typeof event_emitter_1.EventEmitter2 !== "undefined" && event_emitter_1.EventEmitter2) === "function" ? _b : Object])
], BillingService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL2JpbGxpbmcvYmlsbGluZy5zZXJ2aWNlLnRzIiwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7O0FBQUEsMkNBS3dCO0FBQ3hCLGlGQUFxRTtBQUNyRSx5REFBc0Q7QUFDdEQsMkNBR3dCO0FBRXhCOzs7Ozs7Ozs7Ozs7R0FZRztBQUdJLElBQU0sY0FBYyxzQkFBcEIsTUFBTSxjQUFjO0lBSU47SUFDQTtJQUpGLE1BQU0sR0FBRyxJQUFJLGVBQU0sQ0FBQyxnQkFBYyxDQUFDLElBQUksQ0FBQyxDQUFDO0lBRTFELFlBQ21CLE1BQXFCLEVBQ3JCLFlBQTJCO1FBRDNCLFdBQU0sR0FBTixNQUFNLENBQWU7UUFDckIsaUJBQVksR0FBWixZQUFZLENBQWU7SUFDM0MsQ0FBQztJQUVKLDhCQUE4QjtJQUU5Qjs7T0FFRztJQUNILEtBQUssQ0FBQyxtQkFBbUIsQ0FBQyxJQU16QjtRQUNDLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLG9DQUFvQyxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQztRQUVuRSxpRUFBaUU7UUFDakUsSUFBSSxJQUFJLENBQUMsU0FBUyxFQUFFLENBQUM7WUFDbkIsTUFBTSxJQUFJLENBQUMsTUFBTSxDQUFDLGFBQWEsQ0FBQyxVQUFVLENBQUM7Z0JBQ3pDLEtBQUssRUFBRSxFQUFFLE1BQU0sRUFBRSxJQUFJLENBQUMsTUFBTSxFQUFFLFNBQVMsRUFBRSxJQUFJLEVBQUU7Z0JBQy9DLElBQUksRUFBRSxFQUFFLFNBQVMsRUFBRSxLQUFLLEVBQUU7YUFDM0IsQ0FBQyxDQUFDO1FBQ0wsQ0FBQztRQUVELE1BQU0sYUFBYSxHQUFHLE1BQU0sSUFBSSxDQUFDLE1BQU0sQ0FBQyxhQUFhLENBQUMsTUFBTSxDQUFDO1lBQzNELElBQUksRUFBRTtnQkFDSixNQUFNLEVBQUUsSUFBSSxDQUFDLE1BQU07Z0JBQ25CLElBQUksRUFBRSxJQUFJLENBQUMsSUFB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LEVBQUUsTUFBTSxFQUFFLHNCQUFhLENBQUMsTUFBTSxFQUFFO2FBQ2xELENBQUM7WUFDRixJQUFJLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUM7Z0JBQzVCLEtBQUssRUFBRSxFQUFFLEdBQUcsS0FBSyxFQUFFLE1BQU0sRUFBRSxzQkFBYSxDQUFDLFNBQVMsRUFBRTtnQkFDcEQsSUFBSSxFQUFFLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRTthQUN2QixDQUFDO1NBQ0gsQ0FBQyxDQUFDO1FBRUgsTUFBTSxZQUFZLEdBQUcsTUFBTSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsTUFBTSxJQUFJLENBQUMsQ0FBQyxDQUFDO1FBQzNELE1BQU0sZUFBZSxHQUFHLElBQUksQ0FBQztRQUM3QixNQUFNLGVBQWUsR0FBRyxZQUFZLEdBQUcsZUFBZSxDQUFDO1FBQ3ZELE1BQU0sV0FBVyxHQUFHLGFBQWEsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsa0JBQWtCLEdBQUcsYUFBYSxDQUFDLEdBQUcsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFFdkYsT0FBTztZQUNMLGFBQWE7WUFDYixrQkFBa0I7WUFDbEIsY0FBYztZQUNkLFdBQVc7WUFDWCxZQUFZO1lBQ1osZUFBZTtZQUNmLGdCQUFnQixFQUFFLFlBQVksR0FBRyxlQUFlO1lBQ2hELE1BQU0sRUFBRTtnQkFDTixTQUFTO2dCQUNULE9BQU87YUFDUjtTQUNGLENBQUM7SUFDSixDQUFDO0NBQ0YsQ0FBQTtBQTluQlksd0NBQWM7eUJBQWQsY0FBYztJQUQxQixJQUFBLG1CQUFVLEdBQUU7eURBS2dCLHNDQUFhLG9CQUFiLHNDQUFhLG9EQUNQLDZCQUFhLG9CQUFiLDZCQUFhO0dBTG5DLGNBQWMsQ0E4bkIxQiIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvaG9tZS93ZXRvb2EvRG9jdW1lbnRzL2NvZGUvcHJvamVjdHMvbWVudGFyYS9tZW50YXJhLWFwaS9zcmMvYmlsbGluZy9iaWxsaW5nLnNlcnZpY2UudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgSW5qZWN0YWJsZSxcbiAgTm90Rm91bmRFeGNlcHRpb24sXG4gIEJhZFJlcXVlc3RFeGNlcHRpb24sXG4gIExvZ2dlcixcbn0gZnJvbSAnQG5lc3Rqcy9jb21tb24nO1xuaW1wb3J0IHsgUHJpc21hU2VydmljZSB9IGZyb20gJ3NyYy9wcm92aWRlcnMvcHJpc21hLWNsaWVudC5wcm92aWRlcic7XG5pbXBvcnQgeyBFdmVudEVtaXR0ZXIyIH0gZnJvbSAnQG5lc3Rqcy9ldmVudC1lbWl0dGVyJztcbmltcG9ydCB7XG4gIFBheW1lbnRTdGF0dXMsXG4gIFBheW1lbnRNZXRob2RUeXBlLFxufSBmcm9tICdAcHJpc21hL2NsaWVudCc7XG5cbi8qKlxuICogRWR1Y2F0aW9uYWwgQmlsbGluZyBTZXJ2aWNlIGZvciBNZW50YWwgSGVhbHRoIFBsYXRmb3JtXG4gKiBcbiAqIFRoaXMgc2VydmljZSBwcm92aWRlcyBhIHNpbXBsaWZpZWQsIGVkdWNhdGlvbmFsIHBheW1lbnQgcHJvY2Vzc2luZyBzeXN0ZW1cbiAqIHN1aXRhYmxlIGZvciBhIHNjaG9vbCBwcm9qZWN0LiBJdCBzaW11bGF0ZXMgcmVhbCBwYXltZW50IGZsb3dzIHdpdGhvdXRcbiAqIHByb2Nlc3NpbmcgYWN0dWFsIG1vbmV5LlxuICogXG4gKiBGZWF0dXJlczpcbiAqIC0gTW9jayBwYXltZW50IHByb2Nlc3NpbmcgZm9yIHRoZXJhcHkgc2Vzc2lvbnNcbiAqIC0gUGF5bWVudCBtZXRob2QgbWFuYWdlbWVudFxuICogLSBFZHVjYXRpb25hbCBwYXltZW50IGZsb3dzXG4gKiAtIFJlYWxpc3RpYyBwYXltZW50IGZhaWx1cmVzIGFuZCByZXRyaWVzXG4gKi9cblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIEJpbGxpbmdTZXJ2aWNlIHtcbiAgcHJpdmF0ZSByZWFkb25seSBsb2dnZXIgPSBuZXcgTG9nZ2VyKEJpbGxpbmdTZXJ2aWNlLm5hbWUpO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgcmVhZG9ubHkgcHJpc21hOiBQcmlzbWFTZXJ2aWNlLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgZXZlbnRFbWl0dGVyOiBFdmVudEVtaXR0ZXIyLFxuICApIHt9XG5cbiAgLy8gPT09PT0gUEFZTUVOVCBNRVRIT0RTID09PT09XG5cbiAgLyoqXG4gICAqIENyZWF0ZSBhIG5ldyBwYXltZW50IG1ldGhvZCBmb3IgYSB1c2VyXG4gICAqL1xuICBhc3luYyBjcmVhdGVQYXltZW50TWV0aG9kKGRhdGE6IHtcbiAgICB1c2VySWQ6IHN0cmluZztcbiAgICB0eXBlOiBQYXltZW50TWV0aG9kVHlwZTtcbiAgICBjYXJkTGFzdDQ/OiBzdHJpbmc7XG4gICAgY2FyZEJyYW5kPzogc3RyaW5nO1xuICAgIGlzRGVmYXVsdD86IGJvb2xlYW47XG4gIH0pIHtcbiAgICB0aGlzLmxvZ2dlci5sb2coYENyZWF0aW5nIHBheW1lbnQgbWV0aG9kIGZvciB1c2VyICR7ZGF0YS51c2VySWR9YCk7XG5cbiAgICAvLyBJZiB0aGlzIGlzIHNldCBhcyBkZWZhdWx0LCB1bnNldCBvdGhlciBkZWZhdWx0IHBheW1lbnQgbWV0aG9kc1xuICAgIGlmIChkYXRhLmlzRGVmYXVsdCkge1xuICAgICAgYXdhaXQgdGhpcy5wcmlzbWEucGF5bWVudE1ldGhvZC51cGRhdGVNYW55KHtcbiAgICAgICAgd2hlcmU6IHsgdXNlcklkOiBkYXRhLnVzZXJJZCwgaXNEZWZhdWx0OiB0cnVlIH0sXG4gICAgICAgIGRhdGE6IHsgaXNEZWZhdWx0OiBmYWxzZSB9LFxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgY29uc3QgcGF5bWVudE1ldGhvZCA9IGF3YWl0IHRoaXMucHJpc21hLnBheW1lbnRNZXRob2QuY3JlYXRlKHtcbiAgICAgIGRhdGE6IHtcbiAgICAgICAgdXNlcklkOiBkYXRhLnVzZXJJZCxcbiAgICAgICAgdHlwZTogZGF0YS50eXBlLFxuICAgICAgICBjYXJkTGFzdDQ6IGRhdGEuY2FyZExhc3Q0LFxuICAgICAgICBjYXJkQnJhbmQ6IGRhdGEuY2FyZEJyYW5kLFxuICAgICAgICBpc0RlZmF1bHQ6IGRhdGEuaXNEZWZhdWx0IHx8IGZhbHNlLFxuICAgICAgfSxcbiAgICB9KTtcblxuICAgIHRoaXMuZXZlbnRFbWl0dGVyLmVtaXQoJ3BheW1lbnRfbWV0aG9kLmNyZWF0ZWQnLCB7XG4gICAgICB1c2VySWQ6IGRhdGEudXNlcklkLFxuICAgICAgcGF5bWVudE1ldGhvZElkOiBwYXltZW50TWV0aG9kLmlkLFxuICAgICAgdHlwZTogZGF0YS50eXBlLFxuICAgIH0pO1xuXG4gICAgcmV0dXJuIHBheW1lbnRNZXRob2Q7XG4gIH1cblxuICAvKipcbiAgICogR2V0IGFsbCBwYXltZW50IG1ldGhvZHMgZm9yIGEgdXNlclxuICAgKi9cbiAgYXN5bmMgZ2V0VXNlclBheW1lbnRNZXRob2RzKHVzZXJJZDogc3RyaW5nKSB7XG4gICAgcmV0dXJuIHRoaXMucHJpc21hLnBheW1lbnRNZXRob2QuZmluZE1hbnkoe1xuICAgICAgd2hlcmU6IHsgdXNlcklkIH0sXG4gICAgICBvcmRlckJ5OiBbeyBpc0RlZmF1bHQ6ICdkZXNjJyB9LCB7IGNyZWF0ZWRBdDogJ2Rlc2MnIH1dLFxuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIFVwZGF0ZSBwYXltZW50IG1ldGhvZCBzZXR0aW5nc1xuICAgKi9cbiAgYXN5bmMgdXBkYXRlUGF5bWVudE1ldGhvZChcbiAgICBpZDogc3RyaW5nLFxuICAgIGRhdGE6IHsgaXNEZWZhdWx0PzogYm9vbGVhbiB9XG4gICkge1xuICAgIGNvbnN0IHBheW1lbnRNZXRob2QgPSBhd2FpdCB0aGlzLnByaXNtYS5wYXltZW50TWV0aG9kLmZpbmRVbmlxdWUoe1xuICAgICAgd2hlcmU6IHsgaWQgfSxcbiAgICB9KTtcblxuICAgIGlmICghcGF5bWVudE1ldGhvZCkge1xuICAgICAgdGhyb3cgbmV3IE5vdEZvdW5kRXhjZXB0aW9uKGBQYXltZW50IG1ldGhvZCAke2lkfSBub3QgZm91bmRgKTtcbiAgICB9XG5cbiAgICAvLyBJZiBzZXR0aW5nIGFzIGRlZmF1bHQsIHVuc2V0IG90aGVyIGRlZmF1bHRzIGZvciB0aGlzIHVzZXJcbiAgICBpZiAoZGF0YS5pc0RlZmF1bHQpIHtcbiAgICAgIGF3YWl0IHRoaXMucHJpc21hLnBheW1lbnRNZXRob2QudXBkYXRlTWFueSh7XG4gICAgICAgIHdoZXJlOiB7IHVzZXJJZDogcGF5bWVudE1ldGhvZC51c2VySWQsIGlzRGVmYXVsdDogdHJ1ZSB9LFxuICAgICAgICBkYXRhOiB7IGlzRGVmYXVsdDogZmFsc2UgfSxcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIHJldHVybiB0aGlzLnByaXNtYS5wYXltZW50TWV0aG9kLnVwZGF0ZSh7XG4gICAgICB3aGVyZTogeyBpZCB9LFxuICAgICAgZGF0YSxcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBEZWxldGUgKHNvZnQgZGVsZXRlKSBhIHBheW1lbnQgbWV0aG9kXG4gICAqL1xuICBhc3luYyBkZWxldGVQYXltZW50TWV0aG9kKGlkOiBzdHJpbmcpIHtcbiAgICBjb25zdCBwYXltZW50TWV0aG9kID0gYXdhaXQgdGhpcy5wcmlzbWEucGF5bWVudE1ldGhvZC5maW5kVW5pcXVlKHtcbiAgICAgIHdoZXJlOiB7IGlkIH0sXG4gICAgfSk7XG5cbiAgICBpZiAoIXBheW1lbnRNZXRob2QpIHtcbiAgICAgIHRocm93IG5ldyBOb3RGb3VuZEV4Y2VwdGlvbihgUGF5bWVudCBtZXRob2QgJHtpZH0gbm90IGZvdW5kYCk7XG4gICAgfVxuXG4gICAgLy8gQ2Fubm90IGRlbGV0ZSB0aGUgb25seSBwYXltZW50IG1ldGhvZCBpZiB1c2VyIGhhcyBwZW5kaW5nIHBheW1lbnRzXG4gICAgY29uc3Qgb3RoZXJNZXRob2RzID0gYXdhaXQgdGhpcy5wcmlzbWEucGF5bWVudE1ldGhvZC5jb3VudCh7XG4gICAgICB3aGVyZTogeyBcbiAgICAgICAgdXNlcklkOiBwYXltZW50TWV0aG9kLnVzZXJJZCxcbiAgICAgICAgaWQ6IHsgbm90OiBpZCB9XG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgY29uc3QgcGVuZGluZ1BheW1lbnRzID0gYXdhaXQgdGhpcy5wcmlzbWEucGF5bWVudC5jb3VudCh7XG4gICAgICB3aGVyZToge1xuICAgICAgICBPUjogW1xuICAgICAgICAgIHsgY2xpZW50SWQ6IHBheW1lbnRNZXRob2QudXNlcklkIH0sXG4gICAgICAgICAgeyB0aGVyYXBpc3RJZDogcGF5bWVudE1ldGhvZC51c2VySWQgfVxuICAgICAgICBdLFxuICAgICAgICBzdGF0dXM6IFBheW1lbnRTdGF0dXMuUEVORElORyxcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICBpZiAob3RoZXJNZXRob2RzID09PSAwICYmIHBlbmRpbmdQYXltZW50cyA+IDApIHtcbiAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0RXhjZXB0aW9uKFxuICAgICAgICAnQ2Fubm90IGRlbGV0ZSB0aGUgb25seSBwYXltZW50IG1ldGhvZCB3aXRoIHBlbmRpbmcgcGF5bWVudHMnXG4gICAgICApO1xuICAgIH1cblxuICAgIGF3YWl0IHRoaXMucHJpc21hLnBheW1lbnRNZXRob2QuZGVsZXRlKHtcbiAgICAgIHdoZXJlOiB7IGlkIH0sXG4gICAgfSk7XG5cbiAgICB0aGlzLmV2ZW50RW1pdHRlci5lbWl0KCdwYXltZW50X21ldGhvZC5kZWxldGVkJywge1xuICAgICAgdXNlcklkOiBwYXltZW50TWV0aG9kLnVzZXJJZCxcbiAgICAgIHBheW1lbnRNZXRob2RJZDogaWQsXG4gICAgfSk7XG5cbiAgICByZXR1cm4geyBzdWNjZXNzOiB0cnVlIH07XG4gIH1cblxuICAvKipcbiAgICogQ3JlYXRlIGF1dG9tYXRpYyBtb2NrIHBheW1lbnQgZm9yIGJvb2tpbmcgKHVzZWQgd2hlbiBwYXltZW50IGlzIG1vY2tlZC9hdXRvbWF0aWMpXG4gICAqIFRoaXMgY3JlYXRlcyBhIENPTVBMRVRFRCBwYXltZW50IHJlY29yZCB3aXRob3V0IHJlcXVpcmluZyBwYXltZW50IG1ldGhvZCB2YWxpZGF0aW9uXG4gICAqL1xuICBhc3luYyBjcmVhdGVBdXRvbWF0aWNNb2NrUGF5bWVudChkYXRhOiB7XG4gICAgY2xpZW50SWQ6IHN0cmluZztcbiAgICB0aGVyYXBpc3RJZDogc3RyaW5nO1xuICAgIG1lZXRpbmdJZDogc3RyaW5nO1xuICAgIGFtb3VudDogbnVtYmVyO1xuICAgIGN1cnJlbmN5Pzogc3RyaW5nO1xuICAgIGRlc2NyaXB0aW9uPzogc3RyaW5nO1xuICB9LCB0eD86IGFueSkge1xuICAgIHRoaXMubG9nZ2VyLmxvZyhcbiAgICAgIGBDcmVhdGluZyBhdXRvbWF0aWMgbW9jayBwYXltZW50OiAke2RhdGEuYW1vdW50fSAke2RhdGEuY3VycmVuY3kgfHwgJ1VTRCd9IGZvciBtZWV0aW5nICR7ZGF0YS5tZWV0aW5nSWR9YFxuICAgICk7XG5cbiAgICBjb25zdCBwcmlzbWFDbGllbnQgPSB0eCB8fCB0aGlzLnByaXNtYTtcblxuICAgIC8vIENyZWF0ZSBjb21wbGV0ZWQgcGF5bWVudCByZWNvcmQgKG1vY2sgcGF5bWVudCBpcyBhbHdheXMgc3VjY2Vzc2Z1bClcbiAgICBjb25zdCBwYXltZW50ID0gYXdhaXQgcHJpc21hQ2xpZW50LnBheW1lbnQuY3JlYXRlKHtcbiAgICAgIGRhdGE6IHtcbiAgICAgICAgYW1vdW50OiBkYXRhLmFtb3VudCxcbiAgICAgICAgY3VycmVuY3k6IGRhdGEuY3VycmVuY3kgfHwgJ1VTRCcsXG4gICAgICAgIHN0YXR1czogJ0NPTVBMRVRFRCcsIC8vIE1vY2sgcGF5bWVudCBpcyBhbHdheXMgc3VjY2Vzc2Z1bFxuICAgICAgICBjbGllbnQ6IHsgY29ubmVjdDogeyB1c2VySWQ6IGRhdGEuY2xpZW50SWQgfSB9LFxuICAgICAgICB0aGVyYXBpc3Q6IHsgY29ubmVjdDogeyB1c2VySWQ6IGRhdGEudGhlcmFwaXN0SWQgfSB9LFxuICAgICAgICBtZWV0aW5nSWQ6IGRhdGEubWVldGluZ0lkLFxuICAgICAgICBwYXltZW50TWV0aG9kSWQ6IG51bGwsIC8vIE5vIHBheW1lbnQgbWV0aG9kIG5lZWRlZCBmb3IgbW9ja1xuICAgICAgICBwcm9jZXNzZWRBdDogbmV3IERhdGUoKSxcbiAgICAgICAgZmFpbHVyZVJlYXNvbjogbnVsbCxcbiAgICAgIH0sXG4gICAgICBpbmNsdWRlOiB7XG4gICAgICAgIGNsaWVudDoge1xuICAgICAgICAgIHNlbGVjdDogeyBcbiAgICAgICAgICAgIHVzZXI6IHtcbiAgICAgICAgICAgICAgc2VsZWN0OiB7IGZpcnN0TmFtZTogdHJ1ZSwgbGFzdE5hbWU6IHRydWUsIGVtYWlsOiB0cnVlIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIH0sXG4gICAgICAgIHRoZXJhcGlzdDoge1xuICAgICAgICAgIHNlbGVjdDogeyBcbiAgICAgICAgICAgIHVzZXI6IHtcbiAgICAgICAgICAgICAgc2VsZWN0OiB7IGZpcnN0TmFtZTogdHJ1ZSwgbGFzdE5hbWU6IHRydWUsIGVtYWlsOiB0cnVlIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgdGhpcy5sb2dnZXIubG9nKGBNb2NrIHBheW1lbnQgY3JlYXRlZCBzdWNjZXNzZnVsbHk6ICR7cGF5bWVudC5pZH1gKTtcbiAgICByZXR1cm4gcGF5bWVudDtcbiAgfVxuXG4gIC8vID09PT09IFBBWU1FTlQgUFJPQ0VTU0lORyA9PT09PVxuXG4gIC8qKlxuICAgKiBQcm9jZXNzIGEgcGF5bWVudCBmb3IgYSB0aGVyYXB5IHNlc3Npb25cbiAgICovXG4gIGFzeW5jIHByb2Nlc3NTZXNzaW9uUGF5bWVudChkYXRhOiB7XG4gICAgY2xpZW50SWQ6IHN0cmluZztcbiAgICB0aGVyYXBpc3RJZDogc3RyaW5nO1xuICAgIG1lZXRpbmdJZD86IHN0cmluZztcbiAgICBhbW91bnQ6IG51bWJlcjtcbiAgICBjdXJyZW5jeT86IHN0cmluZztcbiAgICBwYXltZW50TWV0aG9kSWQ6IHN0cmluZztcbiAgICBkZXNjcmlwdGlvbj86IHN0cmluZztcbiAgfSkge1xuICAgIHRoaXMubG9nZ2VyLmxvZyhcbiAgICAgIGBQcm9jZXNzaW5nIHNlc3Npb24gcGF5bWVudDogJHtkYXRhLmFtb3VudH0gJHtkYXRhLmN1cnJlbmN5IHx8ICdVU0QnfSBmcm9tIGNsaWVudCAke2RhdGEuY2xpZW50SWR9IHRvIHRoZXJhcGlzdCAke2RhdGEudGhlcmFwaXN0SWR9YFxuICAgICk7XG5cbiAgICAvLyBWYWxpZGF0ZSBwYXltZW50IG1ldGhvZCBiZWxvbmdzIHRvIGNsaWVudFxuICAgIGNvbnN0IHBheW1lbnRNZXRob2QgPSBhd2FpdCB0aGlzLnByaXNtYS5wYXltZW50TWV0aG9kLmZpbmRGaXJzdCh7XG4gICAgICB3aGVyZToge1xuICAgICAgICBpZDogZGF0YS5wYXltZW50TWV0aG9kSWQsXG4gICAgICAgIHVzZXJJZDogZGF0YS5jbGllbnRJZCxcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICBpZiAoIXBheW1lbnRNZXRob2QpIHtcbiAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0RXhjZXB0aW9uKCdJbnZhbGlkIHBheW1lbnQgbWV0aG9kJyk7XG4gICAgfVxuXG4gICAgLy8gQ3JlYXRlIHBheW1lbnQgcmVjb3JkXG4gICAgY29uc3QgcGF5bWVudERhdGE6IGFueSA9IHtcbiAgICAgIGFtb3VudDogZGF0YS5hbW91bnQsXG4gICAgICBjdXJyZW5jeTogZGF0YS5jdXJyZW5jeSB8fCAnVVNEJyxcbiAgICAgIHN0YXR1czogUGF5bWVudFN0YXR1cy5QRU5ESU5HLFxuICAgICAgY2xpZW50OiB7IGNvbm5lY3Q6IHsgdXNlcklkOiBkYXRhLmNsaWVudElkIH0gfSxcbiAgICAgIHRoZXJhcGlzdDogeyBjb25uZWN0OiB7IHVzZXJJZDogZGF0YS50aGVyYXBpc3RJZCB9IH0sXG4gICAgICBwYXltZW50TWV0aG9kSWQ6IGRhdGEucGF5bWVudE1ldGhvZElkLFxuICAgICAgZmFpbHVyZVJlYXNvbjogbnVsbCxcbiAgICB9O1xuXG4gICAgLy8gT25seSBpbmNsdWRlIG1lZXRpbmdJZCBpZiBpdCdzIGRlZmluZWRcbiAgICBpZiAoZGF0YS5tZWV0aW5nSWQpIHtcbiAgICAgIHBheW1lbnREYXRhLm1lZXRpbmdJZCA9IGRhdGEubWVldGluZ0lkO1xuICAgIH1cblxuICAgIGNvbnN0IHBheW1lbnQgPSBhd2FpdCB0aGlzLnByaXNtYS5wYXltZW50LmNyZWF0ZSh7XG4gICAgICBkYXRhOiBwYXltZW50RGF0YSxcbiAgICAgIGluY2x1ZGU6IHtcbiAgICAgICAgY2xpZW50OiB7XG4gICAgICAgICAgc2VsZWN0OiB7IFxuICAgICAgICAgICAgdXNlcjoge1xuICAgICAgICAgICAgICBzZWxlY3Q6IHsgZmlyc3ROYW1lOiB0cnVlLCBsYXN0TmFtZTogdHJ1ZSwgZW1haWw6IHRydWUgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfSxcbiAgICAgICAgdGhlcmFwaXN0OiB7XG4gICAgICAgICAgc2VsZWN0OiB7IFxuICAgICAgICAgICAgdXNlcjoge1xuICAgICAgICAgICAgICBzZWxlY3Q6IHsgZmlyc3ROYW1lOiB0cnVlLCBsYXN0TmFtZTogdHJ1ZSwgZW1haWw6IHRydWUgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfSxcbiAgICAgICAgcGF5bWVudE1ldGhvZDogdHJ1ZSxcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICAvLyBQcm9jZXNzIHBheW1lbnQgYXN5bmNocm9ub3VzbHlcbiAgICB0aGlzLnByb2Nlc3NQYXltZW50QXN5bmMocGF5bWVudC5pZCkuY2F0Y2goKGVycm9yKSA9PiB7XG4gICAgICB0aGlzLmxvZ2dlci5lcnJvcihgRmFpbGVkIHRvIHByb2Nlc3MgcGF5bWVudCAke3BheW1lbnQuaWR9OmAsIGVycm9yKTtcbiAgICB9KTtcblxuICAgIHJldHVybiBwYXltZW50O1xuICB9XG5cbiAgLyoqXG4gICAqIEFzeW5jaHJvbm91c2x5IHByb2Nlc3MgdGhlIHBheW1lbnQgd2l0aCBtb2NrIHBheW1lbnQgZ2F0ZXdheVxuICAgKi9cbiAgcHJpdmF0ZSBhc3luYyBwcm9jZXNzUGF5bWVudEFzeW5jKHBheW1lbnRJZDogc3RyaW5nKSB7XG4gICAgLy8gU2ltdWxhdGUgcGF5bWVudCBwcm9jZXNzaW5nIGRlbGF5XG4gICAgYXdhaXQgbmV3IFByb21pc2UocmVzb2x2ZSA9PiBzZXRUaW1lb3V0KHJlc29sdmUsIDIwMDAgKyBNYXRoLnJhbmRvbSgpICogMzAwMCkpO1xuXG4gICAgY29uc3QgcGF5bWVudCA9IGF3YWl0IHRoaXMucHJpc21hLnBheW1lbnQuZmluZFVuaXF1ZSh7XG4gICAgICB3aGVyZTogeyBpZDogcGF5bWVudElkIH0sXG4gICAgICBpbmNsdWRlOiB7XG4gICAgICAgIGNsaWVudDogeyBcbiAgICAgICAgICBzZWxlY3Q6IHsgXG4gICAgICAgICAgICB1c2VyOiB7XG4gICAgICAgICAgICAgIHNlbGVjdDogeyBmaXJzdE5hbWU6IHRydWUsIGxhc3ROYW1lOiB0cnVlLCBlbWFpbDogdHJ1ZSB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9LFxuICAgICAgICB0aGVyYXBpc3Q6IHsgXG4gICAgICAgICAgc2VsZWN0OiB7IFxuICAgICAgICAgICAgdXNlcjoge1xuICAgICAgICAgICAgICBzZWxlY3Q6IHsgZmlyc3ROYW1lOiB0cnVlLCBsYXN0TmFtZTogdHJ1ZSwgZW1haWw6IHRydWUgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfSxcbiAgICAgICAgcGF5bWVudE1ldGhvZDogdHJ1ZSxcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICBpZiAoIXBheW1lbnQpIHtcbiAgICAgIHRoaXMubG9nZ2VyLmVycm9yKGBQYXltZW50ICR7cGF5bWVudElkfSBub3QgZm91bmQgZHVyaW5nIHByb2Nlc3NpbmdgKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICAvLyBNb2NrIHBheW1lbnQgcHJvY2Vzc2luZyB3aXRoIHJlYWxpc3RpYyBzdWNjZXNzL2ZhaWx1cmUgcmF0ZXNcbiAgICBjb25zdCBzdWNjZXNzID0gdGhpcy5tb2NrUGF5bWVudEdhdGV3YXkocGF5bWVudCk7XG5cbiAgICBpZiAoc3VjY2Vzcykge1xuICAgICAgYXdhaXQgdGhpcy5oYW5kbGVQYXltZW50U3VjY2VzcyhwYXltZW50KTtcbiAgICB9IGVsc2Uge1xuICAgICAgYXdhaXQgdGhpcy5oYW5kbGVQYXltZW50RmFpbHVyZShwYXltZW50KTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogTW9jayBwYXltZW50IGdhdGV3YXkgc2ltdWxhdGlvblxuICAgKiBSZXR1cm5zIHRydWUgZm9yIHN1Y2Nlc3MsIGZhbHNlIGZvciBmYWlsdXJlXG4gICAqL1xuICBwcml2YXRlIG1vY2tQYXltZW50R2F0ZXdheShwYXltZW50OiBhbnkpOiBib29sZWFuIHtcbiAgICAvLyBTaW11bGF0ZSBkaWZmZXJlbnQgZmFpbHVyZSBzY2VuYXJpb3MgYmFzZWQgb24gY2FyZCBkZXRhaWxzXG4gICAgY29uc3QgY2FyZExhc3Q0ID0gcGF5bWVudC5wYXltZW50TWV0aG9kPy5jYXJkTGFzdDQ7XG4gICAgXG4gICAgLy8gVGVzdCBjYXJkIG51bWJlcnMgZm9yIHNwZWNpZmljIHNjZW5hcmlvc1xuICAgIGlmIChjYXJkTGFzdDQpIHtcbiAgICAgIHN3aXRjaCAoY2FyZExhc3Q0KSB7XG4gICAgICAgIGNhc2UgJzAwMDInOiAvLyBBbHdheXMgZGVjbGluZVxuICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgY2FzZSAnMDAwNCc6IC8vIEFsd2F5cyBkZWNsaW5lIHdpdGggaW5zdWZmaWNpZW50IGZ1bmRzXG4gICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICBjYXNlICcwMDA4JzogLy8gQWx3YXlzIGRlY2xpbmUgd2l0aCBleHBpcmVkIGNhcmRcbiAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIGNhc2UgJzAwMDEnOiAvLyBBbHdheXMgc3VjY2VlZFxuICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgIC8vIFJhbmRvbSBzdWNjZXNzL2ZhaWx1cmUgKDkwJSBzdWNjZXNzIHJhdGUpXG4gICAgICAgICAgcmV0dXJuIE1hdGgucmFuZG9tKCkgPiAwLjE7XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gRGVmYXVsdDogOTAlIHN1Y2Nlc3MgcmF0ZVxuICAgIHJldHVybiBNYXRoLnJhbmRvbSgpID4gMC4xO1xuICB9XG5cbiAgLyoqXG4gICAqIEhhbmRsZSBzdWNjZXNzZnVsIHBheW1lbnRcbiAgICovXG4gIHByaXZhdGUgYXN5bmMgaGFuZGxlUGF5bWVudFN1Y2Nlc3MocGF5bWVudDogYW55KSB7XG4gICAgdGhpcy5sb2dnZXIubG9nKGBQYXltZW50ICR7cGF5bWVudC5pZH0gcHJvY2Vzc2VkIHN1Y2Nlc3NmdWxseWApO1xuXG4gICAgY29uc3QgdXBkYXRlZFBheW1lbnQgPSBhd2FpdCB0aGlzLnByaXNtYS5wYXltZW50LnVwZGF0ZSh7XG4gICAgICB3aGVyZTogeyBpZDogcGF5bWVudC5pZCB9LFxuICAgICAgZGF0YToge1xuICAgICAgICBzdGF0dXM6IFBheW1lbnRTdGF0dXMuQ09NUExFVEVELFxuICAgICAgICBwcm9jZXNzZWRBdDogbmV3IERhdGUoKSxcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICAvLyBDYWxjdWxhdGUgcGxhdGZvcm0gZmVlIChlLmcuLCA1JSBwbGF0Zm9ybSBjb21taXNzaW9uKVxuICAgIGNvbnN0IHBsYXRmb3JtRmVlUmF0ZSA9IDAuMDU7XG4gICAgY29uc3QgcGxhdGZvcm1GZWUgPSBOdW1iZXIocGF5bWVudC5hbW91bnQpICogcGxhdGZvcm1GZWVSYXRlO1xuICAgIGNvbnN0IHRoZXJhcGlzdEFtb3VudCA9IE51bWJlcihwYXltZW50LmFtb3VudCkgLSBwbGF0Zm9ybUZlZTtcblxuICAgIC8vIEVtaXQgcGF5bWVudCBzdWNjZXNzIGV2ZW50XG4gICAgdGhpcy5ldmVudEVtaXR0ZXIuZW1pdCgncGF5bWVudC5zdWNjZWVkZWQnLCB7XG4gICAgICBwYXltZW50SWQ6IHBheW1lbnQuaWQsXG4gICAgICBjbGllbnRJZDogcGF5bWVudC5jbGllbnRJZCxcbiAgICAgIHRoZXJhcGlzdElkOiBwYXltZW50LnRoZXJhcGlzdElkLFxuICAgICAgYW1vdW50OiBOdW1iZXIocGF5bWVudC5hbW91bnQpLFxuICAgICAgY3VycmVuY3k6IHBheW1lbnQuY3VycmVuY3ksXG4gICAgICBwbGF0Zm9ybUZlZSxcbiAgICAgIHRoZXJhcGlzdEFtb3VudCxcbiAgICAgIG1lZXRpbmdJZDogcGF5bWVudC5tZWV0aW5nSWQsXG4gICAgfSk7XG5cbiAgICByZXR1cm4gdXBkYXRlZFBheW1lbnQ7XG4gIH1cblxuICAvKipcbiAgICogSGFuZGxlIGZhaWxlZCBwYXltZW50XG4gICAqL1xuICBwcml2YXRlIGFzeW5jIGhhbmRsZVBheW1lbnRGYWlsdXJlKHBheW1lbnQ6IGFueSkge1xuICAgIGNvbnN0IGZhaWx1cmVSZWFzb25zID0gW1xuICAgICAgJ0luc3VmZmljaWVudCBmdW5kcycsXG4gICAgICAnQ2FyZCBkZWNsaW5lZCcsXG4gICAgICAnRXhwaXJlZCBjYXJkJyxcbiAgICAgICdJbnZhbGlkIGNhcmQgbnVtYmVyJyxcbiAgICAgICdOZXR3b3JrIGVycm9yJyxcbiAgICBdO1xuXG4gICAgY29uc3QgZmFpbHVyZVJlYXNvbiA9IGZhaWx1cmVSZWFzb25zW01hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIGZhaWx1cmVSZWFzb25zLmxlbmd0aCldO1xuICAgIFxuICAgIHRoaXMubG9nZ2VyLndhcm4oYFBheW1lbnQgJHtwYXltZW50LmlkfSBmYWlsZWQ6ICR7ZmFpbHVyZVJlYXNvbn1gKTtcblxuICAgIGNvbnN0IHVwZGF0ZWRQYXltZW50ID0gYXdhaXQgdGhpcy5wcmlzbWEucGF5bWVudC51cGRhdGUoe1xuICAgICAgd2hlcmU6IHsgaWQ6IHBheW1lbnQuaWQgfSxcbiAgICAgIGRhdGE6IHtcbiAgICAgICAgc3RhdHVzOiBQYXltZW50U3RhdHVzLkZBSUxFRCxcbiAgICAgICAgZmFpbGVkQXQ6IG5ldyBEYXRlKCksXG4gICAgICAgIGZhaWx1cmVSZWFzb24sXG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgLy8gRW1pdCBwYXltZW50IGZhaWx1cmUgZXZlbnRcbiAgICB0aGlzLmV2ZW50RW1pdHRlci5lbWl0KCdwYXltZW50LmZhaWxlZCcsIHtcbiAgICAgIHBheW1lbnRJZDogcGF5bWVudC5pZCxcbiAgICAgIGNsaWVudElkOiBwYXltZW50LmNsaWVudElkLFxuICAgICAgdGhlcmFwaXN0SWQ6IHBheW1lbnQudGhlcmFwaXN0SWQsXG4gICAgICBhbW91bnQ6IE51bWJlcihwYXltZW50LmFtb3VudCksXG4gICAgICBjdXJyZW5jeTogcGF5bWVudC5jdXJyZW5jeSxcbiAgICAgIGZhaWx1cmVSZWFzb24sXG4gICAgICBtZWV0aW5nSWQ6IHBheW1lbnQubWVldGluZ0lkLFxuICAgIH0pO1xuXG4gICAgcmV0dXJuIHVwZGF0ZWRQYXltZW50O1xuICB9XG5cbiAgLy8gPT09PT0gUEFZTUVOVCBRVUVSSUVTID09PT09XG5cbiAgLyoqXG4gICAqIEdldCBwYXltZW50IGJ5IElEXG4gICAqL1xuICBhc3luYyBnZXRQYXltZW50KGlkOiBzdHJpbmcpIHtcbiAgICBjb25zdCBwYXltZW50ID0gYXdhaXQgdGhpcy5wcmlzbWEucGF5bWVudC5maW5kVW5pcXVlKHtcbiAgICAgIHdoZXJlOiB7IGlkIH0sXG4gICAgICBpbmNsdWRlOiB7XG4gICAgICAgIGNsaWVudDoge1xuICAgICAgICAgIHNlbGVjdDogeyBcbiAgICAgICAgICAgIHVzZXI6IHtcbiAgICAgICAgICAgICAgc2VsZWN0OiB7IGZpcnN0TmFtZTogdHJ1ZSwgbGFzdE5hbWU6IHRydWUsIGVtYWlsOiB0cnVlIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIH0sXG4gICAgICAgIHRoZXJhcGlzdDoge1xuICAgICAgICAgIHNlbGVjdDogeyBcbiAgICAgICAgICAgIHVzZXI6IHtcbiAgICAgICAgICAgICAgc2VsZWN0OiB7IGZpcnN0TmFtZTogdHJ1ZSwgbGFzdE5hbWU6IHRydWUsIGVtYWlsOiB0cnVlIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIH0sXG4gICAgICAgIHBheW1lbnRNZXRob2Q6IHRydWUsXG4gICAgICAgIG1lZXRpbmc6IHtcbiAgICAgICAgICBzZWxlY3Q6IHsgc3RhcnRUaW1lOiB0cnVlLCBlbmRUaW1lOiB0cnVlLCB0aXRsZTogdHJ1ZSB9XG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgaWYgKCFwYXltZW50KSB7XG4gICAgICB0aHJvdyBuZXcgTm90Rm91bmRFeGNlcHRpb24oYFBheW1lbnQgJHtpZH0gbm90IGZvdW5kYCk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHBheW1lbnQ7XG4gIH1cblxuICAvKipcbiAgICogR2V0IHBheW1lbnRzIGZvciBhIHVzZXIgKGFzIGNsaWVudCBvciB0aGVyYXBpc3QpXG4gICAqL1xuICBhc3luYyBnZXRVc2VyUGF5bWVudHMoXG4gICAgdXNlcklkOiBzdHJpbmcsXG4gICAgb3B0aW9uczoge1xuICAgICAgcm9sZT86ICdjbGllbnQnIHwgJ3RoZXJhcGlzdCc7XG4gICAgICBzdGF0dXM/OiBQYXltZW50U3RhdHVzO1xuICAgICAgbGltaXQ/OiBudW1iZXI7XG4gICAgICBvZmZzZXQ/OiBudW1iZXI7XG4gICAgfSA9IHt9XG4gICkge1xuICAgIGNvbnN0IHdoZXJlOiBhbnkgPSB7fTtcblxuICAgIGlmIChvcHRpb25zLnJvbGUgPT09ICdjbGllbnQnKSB7XG4gICAgICB3aGVyZS5jbGllbnRJZCA9IHVzZXJJZDtcbiAgICB9IGVsc2UgaWYgKG9wdGlvbnMucm9sZSA9PT0gJ3RoZXJhcGlzdCcpIHtcbiAgICAgIHdoZXJlLnRoZXJhcGlzdElkID0gdXNlcklkO1xuICAgIH0gZWxzZSB7XG4gICAgICB3aGVyZS5PUiA9IFtcbiAgICAgICAgeyBjbGllbnRJZDogdXNlcklkIH0sXG4gICAgICAgIHsgdGhlcmFwaXN0SWQ6IHVzZXJJZCB9LFxuICAgICAgXTtcbiAgICB9XG5cbiAgICBpZiAob3B0aW9ucy5zdGF0dXMpIHtcbiAgICAgIHdoZXJlLnN0YXR1cyA9IG9wdGlvbnMuc3RhdHVzO1xuICAgIH1cblxuICAgIHJldHVybiB0aGlzLnByaXNtYS5wYXltZW50LmZpbmRNYW55KHtcbiAgICAgIHdoZXJlLFxuICAgICAgaW5jbHVkZToge1xuICAgICAgICBjbGllbnQ6IHtcbiAgICAgICAgICBzZWxlY3Q6IHsgXG4gICAgICAgICAgICB1c2VyOiB7XG4gICAgICAgICAgICAgIHNlbGVjdDogeyBmaXJzdE5hbWU6IHRydWUsIGxhc3ROYW1lOiB0cnVlLCBlbWFpbDogdHJ1ZSB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9LFxuICAgICAgICB0aGVyYXBpc3Q6IHtcbiAgICAgICAgICBzZWxlY3Q6IHsgXG4gICAgICAgICAgICB1c2VyOiB7XG4gICAgICAgICAgICAgIHNlbGVjdDogeyBmaXJzdE5hbWU6IHRydWUsIGxhc3ROYW1lOiB0cnVlLCBlbWFpbDogdHJ1ZSB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9LFxuICAgICAgICBwYXltZW50TWV0aG9kOiB0cnVlLFxuICAgICAgICBtZWV0aW5nOiB7XG4gICAgICAgICAgc2VsZWN0OiB7IHN0YXJ0VGltZTogdHJ1ZSwgZW5kVGltZTogdHJ1ZSwgdGl0bGU6IHRydWUgfVxuICAgICAgICB9LFxuICAgICAgfSxcbiAgICAgIG9yZGVyQnk6IHsgY3JlYXRlZEF0OiAnZGVzYycgfSxcbiAgICAgIHRha2U6IG9wdGlvbnMubGltaXQgfHwgNTAsXG4gICAgICBza2lwOiBvcHRpb25zLm9mZnNldCB8fCAwLFxuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIFJldHJ5IGEgZmFpbGVkIHBheW1lbnRcbiAgICovXG4gIGFzeW5jIHJldHJ5UGF5bWVudChwYXltZW50SWQ6IHN0cmluZykge1xuICAgIGNvbnN0IHBheW1lbnQgPSBhd2FpdCB0aGlzLnByaXNtYS5wYXltZW50LmZpbmRVbmlxdWUoe1xuICAgICAgd2hlcmU6IHsgaWQ6IHBheW1lbnRJZCB9LFxuICAgIH0pO1xuXG4gICAgaWYgKCFwYXltZW50KSB7XG4gICAgICB0aHJvdyBuZXcgTm90Rm91bmRFeGNlcHRpb24oYFBheW1lbnQgJHtwYXltZW50SWR9IG5vdCBmb3VuZGApO1xuICAgIH1cblxuICAgIGlmIChwYXltZW50LnN0YXR1cyAhPT0gUGF5bWVudFN0YXR1cy5GQUlMRUQpIHtcbiAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0RXhjZXB0aW9uKCdDYW4gb25seSByZXRyeSBmYWlsZWQgcGF5bWVudHMnKTtcbiAgICB9XG5cbiAgICAvLyBSZXNldCBwYXltZW50IHRvIHBlbmRpbmcgYW5kIHJldHJ5XG4gICAgYXdhaXQgdGhpcy5wcmlzbWEucGF5bWVudC51cGRhdGUoe1xuICAgICAgd2hlcmU6IHsgaWQ6IHBheW1lbnRJZCB9LFxuICAgICAgZGF0YToge1xuICAgICAgICBzdGF0dXM6IFBheW1lbnRTdGF0dXMuUEVORElORyxcbiAgICAgICAgZmFpbHVyZVJlYXNvbjogbnVsbCxcbiAgICAgICAgZmFpbGVkQXQ6IG51bGwsXG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgLy8gUHJvY2VzcyBwYXltZW50IGFnYWluXG4gICAgdGhpcy5wcm9jZXNzUGF5bWVudEFzeW5jKHBheW1lbnRJZCkuY2F0Y2goKGVycm9yKSA9PiB7XG4gICAgICB0aGlzLmxvZ2dlci5lcnJvcihgRmFpbGVkIHRvIHJldHJ5IHBheW1lbnQgJHtwYXltZW50SWR9OmAsIGVycm9yKTtcbiAgICB9KTtcblxuICAgIHJldHVybiB7IHN1Y2Nlc3M6IHRydWUsIG1lc3NhZ2U6ICdQYXltZW50IHJldHJ5IGluaXRpYXRlZCcgfTtcbiAgfVxuXG4gIC8vID09PT09IEFOQUxZVElDUyAmIFJFUE9SVElORyA9PT09PVxuXG4gIC8qKlxuICAgKiBHZXQgcGF5bWVudCBzdGF0aXN0aWNzIGZvciB0aGVyYXBpc3RzXG4gICAqL1xuICBhc3luYyBnZXRUaGVyYXBpc3RQYXltZW50U3RhdHMoXG4gICAgdGhlcmFwaXN0SWQ6IHN0cmluZyxcbiAgICBzdGFydERhdGU/OiBEYXRlLFxuICAgIGVuZERhdGU/OiBEYXRlXG4gICkge1xuICAgIGNvbnN0IHdoZXJlOiBhbnkgPSB7XG4gICAgICB0aGVyYXBpc3RJZCxcbiAgICAgIHN0YXR1czogUGF5bWVudFN0YXR1cy5DT01QTEVURUQsXG4gICAgfTtcblxuICAgIGlmIChzdGFydERhdGUpIHtcbiAgICAgIHdoZXJlLnByb2Nlc3NlZEF0ID0geyAuLi53aGVyZS5wcm9jZXNzZWRBdCwgZ3RlOiBzdGFydERhdGUgfTtcbiAgICB9XG4gICAgaWYgKGVuZERhdGUpIHtcbiAgICAgIHdoZXJlLnByb2Nlc3NlZEF0ID0geyAuLi53aGVyZS5wcm9jZXNzZWRBdCwgbHRlOiBlbmREYXRlIH07XG4gICAgfVxuXG4gICAgY29uc3QgW3RvdGFsUGF5bWVudHMsIHN0YXRzXSA9IGF3YWl0IFByb21pc2UuYWxsKFtcbiAgICAgIHRoaXMucHJpc21hLnBheW1lbnQuY291bnQoeyB3aGVyZSB9KSxcbiAgICAgIHRoaXMucHJpc21hLnBheW1lbnQuYWdncmVnYXRlKHtcbiAgICAgICAgd2hlcmUsXG4gICAgICAgIF9zdW06IHsgYW1vdW50OiB0cnVlIH0sXG4gICAgICAgIF9hdmc6IHsgYW1vdW50OiB0cnVlIH0sXG4gICAgICB9KSxcbiAgICBdKTtcblxuICAgIGNvbnN0IHRvdGFsUmV2ZW51ZSA9IE51bWJlcihzdGF0cy5fc3VtLmFtb3VudCB8fCAwKTtcbiAgICBjb25zdCBhdmVyYWdlU2Vzc2lvblJhdGUgPSBOdW1iZXIoc3RhdHMuX2F2Zy5hbW91bnQgfHwgMCk7XG4gICAgY29uc3QgcGxhdGZvcm1GZWVSYXRlID0gMC4wNTtcbiAgICBjb25zdCBwbGF0Zm9ybUZlZXMgPSB0b3RhbFJldmVudWUgKiBwbGF0Zm9ybUZlZVJhdGU7XG4gICAgY29uc3QgbmV0RWFybmluZ3MgPSB0b3RhbFJldmVudWUgLSBwbGF0Zm9ybUZlZXM7XG5cbiAgICByZXR1cm4ge1xuICAgICAgdG90YWxTZXNzaW9uczogdG90YWxQYXltZW50cyxcbiAgICAgIHRvdGFsUmV2ZW51ZSxcbiAgICAgIGF2ZXJhZ2VTZXNzaW9uUmF0ZSxcbiAgICAgIHBsYXRmb3JtRmVlcyxcbiAgICAgIG5ldEVhcm5pbmdzLFxuICAgICAgcGVyaW9kOiB7XG4gICAgICAgIHN0YXJ0RGF0ZSxcbiAgICAgICAgZW5kRGF0ZSxcbiAgICAgIH0sXG4gICAgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgcGxhdGZvcm0gYmlsbGluZyBzdGF0aXN0aWNzIChhZG1pbiBvbmx5KVxuICAgKi9cbiAgYXN5bmMgZ2V0UGxhdGZvcm1TdGF0cyhzdGFydERhdGU/OiBEYXRlLCBlbmREYXRlPzogRGF0ZSkge1xuICAgIGNvbnN0IHdoZXJlOiBhbnkgPSB7fTtcblxuICAgIGlmIChzdGFydERhdGUpIHtcbiAgICAgIHdoZXJlLmNyZWF0ZWRBdCA9IHsgLi4ud2hlcmUuY3JlYXRlZEF0LCBndGU6IHN0YXJ0RGF0ZSB9O1xuICAgIH1cbiAgICBpZiAoZW5kRGF0ZSkge1xuICAgICAgd2hlcmUuY3JlYXRlZEF0ID0geyAuLi53aGVyZS5jcmVhdGVkQXQsIGx0ZTogZW5kRGF0ZSB9O1xuICAgIH1cblxuICAgIGNvbnN0IFtcbiAgICAgIHRvdGFsUGF5bWVudHMsXG4gICAgICBzdWNjZXNzZnVsUGF5bWVudHMsXG4gICAgICBmYWlsZWRQYXltZW50cyxcbiAgICAgIHJldmVudWVTdGF0cyxcbiAgICBdID0gYXdhaXQgUHJvbWlzZS5hbGwoW1xuICAgICAgdGhpcy5wcmlzbWEucGF5bWVudC5jb3VudCh7IHdoZXJlIH0pLFxuICAgICAgdGhpcy5wcmlzbWEucGF5bWVudC5jb3VudCh7IFxuICAgICAgICB3aGVyZTogeyAuLi53aGVyZSwgc3RhdHVzOiBQYXltZW50U3RhdHVzLkNPTVBMRVRFRCB9XG4gICAgICB9KSxcbiAgICAgIHRoaXMucHJpc21hLnBheW1lbnQuY291bnQoeyBcbiAgICAgICAgd2hlcmU6IHsgLi4ud2hlcmUsIHN0YXR1czogUGF5bWVudFN0YXR1cy5GQUlMRUQgfVxuICAgICAgfSksXG4gICAgICB0aGlzLnByaXNtYS5wYXltZW50LmFnZ3JlZ2F0ZSh7XG4gICAgICAgIHdoZXJlOiB7IC4uLndoZXJlLCBzdGF0dXM6IFBheW1lbnRTdGF0dXMuQ09NUExFVEVEIH0sXG4gICAgICAgIF9zdW06IHsgYW1vdW50OiB0cnVlIH0sXG4gICAgICB9KSxcbiAgICBdKTtcblxuICAgIGNvbnN0IHRvdGFsUmV2ZW51ZSA9IE51bWJlcihyZXZlbnVlU3RhdHMuX3N1bS5hbW91bnQgfHwgMCk7XG4gICAgY29uc3QgcGxhdGZvcm1GZWVSYXRlID0gMC4wNTtcbiAgICBjb25zdCBwbGF0Zm9ybVJldmVudWUgPSB0b3RhbFJldmVudWUgKiBwbGF0Zm9ybUZlZVJhdGU7XG4gICAgY29uc3Qgc3VjY2Vzc1JhdGUgPSB0b3RhbFBheW1lbnRzID4gMCA/IChzdWNjZXNzZnVsUGF5bWVudHMgLyB0b3RhbFBheW1lbnRzKSAqIDEwMCA6IDA7XG5cbiAgICByZXR1cm4ge1xuICAgICAgdG90YWxQYXltZW50cyxcbiAgICAgIHN1Y2Nlc3NmdWxQYXltZW50cyxcbiAgICAgIGZhaWxlZFBheW1lbnRzLFxuICAgICAgc3VjY2Vzc1JhdGUsXG4gICAgICB0b3RhbFJldmVudWUsXG4gICAgICBwbGF0Zm9ybVJldmVudWUsXG4gICAgICB0aGVyYXBpc3RQYXlvdXRzOiB0b3RhbFJldmVudWUgLSBwbGF0Zm9ybVJldmVudWUsXG4gICAgICBwZXJpb2Q6IHtcbiAgICAgICAgc3RhcnREYXRlLFxuICAgICAgICBlbmREYXRlLFxuICAgICAgfSxcbiAgICB9O1xuICB9XG59Il0sInZlcnNpb24iOjN9