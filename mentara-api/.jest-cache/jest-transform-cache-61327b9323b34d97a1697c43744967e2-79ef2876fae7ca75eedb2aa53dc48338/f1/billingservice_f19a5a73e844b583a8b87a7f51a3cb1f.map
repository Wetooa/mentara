{"file":"/home/wetooa/Documents/code/projects/mentara/mentara-api/src/billing/billing.service.ts","mappings":"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","names":[],"sources":["/home/wetooa/Documents/code/projects/mentara/mentara-api/src/billing/billing.service.ts"],"sourcesContent":["import {\n  Injectable,\n  NotFoundException,\n  BadRequestException,\n  Logger,\n} from '@nestjs/common';\nimport { PrismaService } from 'src/providers/prisma-client.provider';\nimport { EventEmitter2 } from '@nestjs/event-emitter';\nimport {\n  PaymentStatus,\n  PaymentMethodType,\n} from '@prisma/client';\n\n/**\n * Educational Billing Service for Mental Health Platform\n * \n * This service provides a simplified, educational payment processing system\n * suitable for a school project. It simulates real payment flows without\n * processing actual money.\n * \n * Features:\n * - Mock payment processing for therapy sessions\n * - Payment method management\n * - Educational payment flows\n * - Realistic payment failures and retries\n */\n\n@Injectable()\nexport class BillingService {\n  private readonly logger = new Logger(BillingService.name);\n\n  constructor(\n    private readonly prisma: PrismaService,\n    private readonly eventEmitter: EventEmitter2,\n  ) {}\n\n  // ===== PAYMENT METHODS =====\n\n  /**\n   * Create a new payment method for a user\n   */\n  async createPaymentMethod(data: {\n    userId: string;\n    type: PaymentMethodType;\n    cardLast4?: string;\n    cardBrand?: string;\n    isDefault?: boolean;\n  }) {\n    this.logger.log(`Creating payment method for user ${data.userId}`);\n\n    // If this is set as default, unset other default payment methods\n    if (data.isDefault) {\n      await this.prisma.paymentMethod.updateMany({\n        where: { userId: data.userId, isDefault: true },\n        data: { isDefault: false },\n      });\n    }\n\n    const paymentMethod = await this.prisma.paymentMethod.create({\n      data: {\n        userId: data.userId,\n        type: data.type,\n        cardLast4: data.cardLast4,\n        cardBrand: data.cardBrand,\n        isDefault: data.isDefault || false,\n      },\n    });\n\n    this.eventEmitter.emit('payment_method.created', {\n      userId: data.userId,\n      paymentMethodId: paymentMethod.id,\n      type: data.type,\n    });\n\n    return paymentMethod;\n  }\n\n  /**\n   * Get all payment methods for a user\n   */\n  async getUserPaymentMethods(userId: string) {\n    return this.prisma.paymentMethod.findMany({\n      where: { userId },\n      orderBy: [{ isDefault: 'desc' }, { createdAt: 'desc' }],\n    });\n  }\n\n  /**\n   * Update payment method settings\n   */\n  async updatePaymentMethod(\n    id: string,\n    data: { isDefault?: boolean }\n  ) {\n    const paymentMethod = await this.prisma.paymentMethod.findUnique({\n      where: { id },\n    });\n\n    if (!paymentMethod) {\n      throw new NotFoundException(`Payment method ${id} not found`);\n    }\n\n    // If setting as default, unset other defaults for this user\n    if (data.isDefault) {\n      await this.prisma.paymentMethod.updateMany({\n        where: { userId: paymentMethod.userId, isDefault: true },\n        data: { isDefault: false },\n      });\n    }\n\n    return this.prisma.paymentMethod.update({\n      where: { id },\n      data,\n    });\n  }\n\n  /**\n   * Delete (soft delete) a payment method\n   */\n  async deletePaymentMethod(id: string) {\n    const paymentMethod = await this.prisma.paymentMethod.findUnique({\n      where: { id },\n    });\n\n    if (!paymentMethod) {\n      throw new NotFoundException(`Payment method ${id} not found`);\n    }\n\n    // Cannot delete the only payment method if user has pending payments\n    const otherMethods = await this.prisma.paymentMethod.count({\n      where: { \n        userId: paymentMethod.userId,\n        id: { not: id }\n      },\n    });\n\n    const pendingPayments = await this.prisma.payment.count({\n      where: {\n        OR: [\n          { clientId: paymentMethod.userId },\n          { therapistId: paymentMethod.userId }\n        ],\n        status: PaymentStatus.PENDING,\n      },\n    });\n\n    if (otherMethods === 0 && pendingPayments > 0) {\n      throw new BadRequestException(\n        'Cannot delete the only payment method with pending payments'\n      );\n    }\n\n    await this.prisma.paymentMethod.delete({\n      where: { id },\n    });\n\n    this.eventEmitter.emit('payment_method.deleted', {\n      userId: paymentMethod.userId,\n      paymentMethodId: id,\n    });\n\n    return { success: true };\n  }\n\n  /**\n   * Create automatic mock payment for booking (used when payment is mocked/automatic)\n   * This creates a COMPLETED payment record without requiring payment method validation\n   */\n  async createAutomaticMockPayment(data: {\n    clientId: string;\n    therapistId: string;\n    meetingId: string;\n    amount: number;\n    currency?: string;\n    description?: string;\n  }, tx?: any) {\n    this.logger.log(\n      `Creating automatic mock payment: ${data.amount} ${data.currency || 'USD'} for meeting ${data.meetingId}`\n    );\n\n    const prismaClient = tx || this.prisma;\n\n    // Create completed payment record (mock payment is always successful)\n    const payment = await prismaClient.payment.create({\n      data: {\n        amount: data.amount,\n        currency: data.currency || 'USD',\n        status: 'COMPLETED', // Mock payment is always successful\n        client: { connect: { userId: data.clientId } },\n        therapist: { connect: { userId: data.therapistId } },\n        meetingId: data.meetingId,\n        paymentMethodId: null, // No payment method needed for mock\n        processedAt: new Date(),\n        failureReason: null,\n      },\n      include: {\n        client: {\n          select: { \n            user: {\n              select: { firstName: true, lastName: true, email: true }\n            }\n          }\n        },\n        therapist: {\n          select: { \n            user: {\n              select: { firstName: true, lastName: true, email: true }\n            }\n          }\n        },\n      },\n    });\n\n    this.logger.log(`Mock payment created successfully: ${payment.id}`);\n    return payment;\n  }\n\n  // ===== PAYMENT PROCESSING =====\n\n  /**\n   * Process a payment for a therapy session\n   */\n  async processSessionPayment(data: {\n    clientId: string;\n    therapistId: string;\n    meetingId?: string;\n    amount: number;\n    currency?: string;\n    paymentMethodId: string;\n    description?: string;\n  }) {\n    this.logger.log(\n      `Processing session payment: ${data.amount} ${data.currency || 'USD'} from client ${data.clientId} to therapist ${data.therapistId}`\n    );\n\n    // Validate payment method belongs to client\n    const paymentMethod = await this.prisma.paymentMethod.findFirst({\n      where: {\n        id: data.paymentMethodId,\n        userId: data.clientId,\n      },\n    });\n\n    if (!paymentMethod) {\n      throw new BadRequestException('Invalid payment method');\n    }\n\n    // Create payment record\n    const paymentData: any = {\n      amount: data.amount,\n      currency: data.currency || 'USD',\n      status: PaymentStatus.PENDING,\n      client: { connect: { userId: data.clientId } },\n      therapist: { connect: { userId: data.therapistId } },\n      paymentMethodId: data.paymentMethodId,\n      failureReason: null,\n    };\n\n    // Only include meetingId if it's defined\n    if (data.meetingId) {\n      paymentData.meetingId = data.meetingId;\n    }\n\n    const payment = await this.prisma.payment.create({\n      data: paymentData,\n      include: {\n        client: {\n          select: { \n            user: {\n              select: { firstName: true, lastName: true, email: true }\n            }\n          }\n        },\n        therapist: {\n          select: { \n            user: {\n              select: { firstName: true, lastName: true, email: true }\n            }\n          }\n        },\n        paymentMethod: true,\n      },\n    });\n\n    // Process payment asynchronously\n    this.processPaymentAsync(payment.id).catch((error) => {\n      this.logger.error(`Failed to process payment ${payment.id}:`, error);\n    });\n\n    return payment;\n  }\n\n  /**\n   * Asynchronously process the payment with mock payment gateway\n   */\n  private async processPaymentAsync(paymentId: string) {\n    // Simulate payment processing delay\n    await new Promise(resolve => setTimeout(resolve, 2000 + Math.random() * 3000));\n\n    const payment = await this.prisma.payment.findUnique({\n      where: { id: paymentId },\n      include: {\n        client: { \n          select: { \n            user: {\n              select: { firstName: true, lastName: true, email: true }\n            }\n          }\n        },\n        therapist: { \n          select: { \n            user: {\n              select: { firstName: true, lastName: true, email: true }\n            }\n          }\n        },\n        paymentMethod: true,\n      },\n    });\n\n    if (!payment) {\n      this.logger.error(`Payment ${paymentId} not found during processing`);\n      return;\n    }\n\n    // Mock payment processing with realistic success/failure rates\n    const success = this.mockPaymentGateway(payment);\n\n    if (success) {\n      await this.handlePaymentSuccess(payment);\n    } else {\n      await this.handlePaymentFailure(payment);\n    }\n  }\n\n  /**\n   * Mock payment gateway simulation\n   * Returns true for success, false for failure\n   */\n  private mockPaymentGateway(payment: any): boolean {\n    // Simulate different failure scenarios based on card details\n    const cardLast4 = payment.paymentMethod?.cardLast4;\n    \n    // Test card numbers for specific scenarios\n    if (cardLast4) {\n      switch (cardLast4) {\n        case '0002': // Always decline\n          return false;\n        case '0004': // Always decline with insufficient funds\n          return false;\n        case '0008': // Always decline with expired card\n          return false;\n        case '0001': // Always succeed\n          return true;\n        default:\n          // Random success/failure (90% success rate)\n          return Math.random() > 0.1;\n      }\n    }\n\n    // Default: 90% success rate\n    return Math.random() > 0.1;\n  }\n\n  /**\n   * Handle successful payment\n   */\n  private async handlePaymentSuccess(payment: any) {\n    this.logger.log(`Payment ${payment.id} processed successfully`);\n\n    const updatedPayment = await this.prisma.payment.update({\n      where: { id: payment.id },\n      data: {\n        status: PaymentStatus.COMPLETED,\n        processedAt: new Date(),\n      },\n    });\n\n    // Calculate platform fee (e.g., 5% platform commission)\n    const platformFeeRate = 0.05;\n    const platformFee = Number(payment.amount) * platformFeeRate;\n    const therapistAmount = Number(payment.amount) - platformFee;\n\n    // Emit payment success event\n    this.eventEmitter.emit('payment.succeeded', {\n      paymentId: payment.id,\n      clientId: payment.clientId,\n      therapistId: payment.therapistId,\n      amount: Number(payment.amount),\n      currency: payment.currency,\n      platformFee,\n      therapistAmount,\n      meetingId: payment.meetingId,\n    });\n\n    return updatedPayment;\n  }\n\n  /**\n   * Handle failed payment\n   */\n  private async handlePaymentFailure(payment: any) {\n    const failureReasons = [\n      'Insufficient funds',\n      'Card declined',\n      'Expired card',\n      'Invalid card number',\n      'Network error',\n    ];\n\n    const failureReason = failureReasons[Math.floor(Math.random() * failureReasons.length)];\n    \n    this.logger.warn(`Payment ${payment.id} failed: ${failureReason}`);\n\n    const updatedPayment = await this.prisma.payment.update({\n      where: { id: payment.id },\n      data: {\n        status: PaymentStatus.FAILED,\n        failedAt: new Date(),\n        failureReason,\n      },\n    });\n\n    // Emit payment failure event\n    this.eventEmitter.emit('payment.failed', {\n      paymentId: payment.id,\n      clientId: payment.clientId,\n      therapistId: payment.therapistId,\n      amount: Number(payment.amount),\n      currency: payment.currency,\n      failureReason,\n      meetingId: payment.meetingId,\n    });\n\n    return updatedPayment;\n  }\n\n  // ===== PAYMENT QUERIES =====\n\n  /**\n   * Get payment by ID\n   */\n  async getPayment(id: string) {\n    const payment = await this.prisma.payment.findUnique({\n      where: { id },\n      include: {\n        client: {\n          select: { \n            user: {\n              select: { firstName: true, lastName: true, email: true }\n            }\n          }\n        },\n        therapist: {\n          select: { \n            user: {\n              select: { firstName: true, lastName: true, email: true }\n            }\n          }\n        },\n        paymentMethod: true,\n        meeting: {\n          select: { startTime: true, endTime: true, title: true }\n        },\n      },\n    });\n\n    if (!payment) {\n      throw new NotFoundException(`Payment ${id} not found`);\n    }\n\n    return payment;\n  }\n\n  /**\n   * Get payments for a user (as client or therapist)\n   */\n  async getUserPayments(\n    userId: string,\n    options: {\n      role?: 'client' | 'therapist';\n      status?: PaymentStatus;\n      limit?: number;\n      offset?: number;\n    } = {}\n  ) {\n    const where: any = {};\n\n    if (options.role === 'client') {\n      where.clientId = userId;\n    } else if (options.role === 'therapist') {\n      where.therapistId = userId;\n    } else {\n      where.OR = [\n        { clientId: userId },\n        { therapistId: userId },\n      ];\n    }\n\n    if (options.status) {\n      where.status = options.status;\n    }\n\n    return this.prisma.payment.findMany({\n      where,\n      include: {\n        client: {\n          select: { \n            user: {\n              select: { firstName: true, lastName: true, email: true }\n            }\n          }\n        },\n        therapist: {\n          select: { \n            user: {\n              select: { firstName: true, lastName: true, email: true }\n            }\n          }\n        },\n        paymentMethod: true,\n        meeting: {\n          select: { startTime: true, endTime: true, title: true }\n        },\n      },\n      orderBy: { createdAt: 'desc' },\n      take: options.limit || 50,\n      skip: options.offset || 0,\n    });\n  }\n\n  /**\n   * Retry a failed payment\n   */\n  async retryPayment(paymentId: string) {\n    const payment = await this.prisma.payment.findUnique({\n      where: { id: paymentId },\n    });\n\n    if (!payment) {\n      throw new NotFoundException(`Payment ${paymentId} not found`);\n    }\n\n    if (payment.status !== PaymentStatus.FAILED) {\n      throw new BadRequestException('Can only retry failed payments');\n    }\n\n    // Reset payment to pending and retry\n    await this.prisma.payment.update({\n      where: { id: paymentId },\n      data: {\n        status: PaymentStatus.PENDING,\n        failureReason: null,\n        failedAt: null,\n      },\n    });\n\n    // Process payment again\n    this.processPaymentAsync(paymentId).catch((error) => {\n      this.logger.error(`Failed to retry payment ${paymentId}:`, error);\n    });\n\n    return { success: true, message: 'Payment retry initiated' };\n  }\n\n  // ===== ANALYTICS & REPORTING =====\n\n  /**\n   * Get payment statistics for therapists\n   */\n  async getTherapistPaymentStats(\n    therapistId: string,\n    startDate?: Date,\n    endDate?: Date\n  ) {\n    const where: any = {\n      therapistId,\n      status: PaymentStatus.COMPLETED,\n    };\n\n    if (startDate) {\n      where.processedAt = { ...where.processedAt, gte: startDate };\n    }\n    if (endDate) {\n      where.processedAt = { ...where.processedAt, lte: endDate };\n    }\n\n    const [totalPayments, stats] = await Promise.all([\n      this.prisma.payment.count({ where }),\n      this.prisma.payment.aggregate({\n        where,\n        _sum: { amount: true },\n        _avg: { amount: true },\n      }),\n    ]);\n\n    const totalRevenue = Number(stats._sum.amount || 0);\n    const averageSessionRate = Number(stats._avg.amount || 0);\n    const platformFeeRate = 0.05;\n    const platformFees = totalRevenue * platformFeeRate;\n    const netEarnings = totalRevenue - platformFees;\n\n    return {\n      totalSessions: totalPayments,\n      totalRevenue,\n      averageSessionRate,\n      platformFees,\n      netEarnings,\n      period: {\n        startDate,\n        endDate,\n      },\n    };\n  }\n\n  /**\n   * Get platform billing statistics (admin only)\n   */\n  async getPlatformStats(startDate?: Date, endDate?: Date) {\n    const where: any = {};\n\n    if (startDate) {\n      where.createdAt = { ...where.createdAt, gte: startDate };\n    }\n    if (endDate) {\n      where.createdAt = { ...where.createdAt, lte: endDate };\n    }\n\n    const [\n      totalPayments,\n      successfulPayments,\n      failedPayments,\n      revenueStats,\n    ] = await Promise.all([\n      this.prisma.payment.count({ where }),\n      this.prisma.payment.count({ \n        where: { ...where, status: PaymentStatus.COMPLETED }\n      }),\n      this.prisma.payment.count({ \n        where: { ...where, status: PaymentStatus.FAILED }\n      }),\n      this.prisma.payment.aggregate({\n        where: { ...where, status: PaymentStatus.COMPLETED },\n        _sum: { amount: true },\n      }),\n    ]);\n\n    const totalRevenue = Number(revenueStats._sum.amount || 0);\n    const platformFeeRate = 0.05;\n    const platformRevenue = totalRevenue * platformFeeRate;\n    const successRate = totalPayments > 0 ? (successfulPayments / totalPayments) * 100 : 0;\n\n    return {\n      totalPayments,\n      successfulPayments,\n      failedPayments,\n      successRate,\n      totalRevenue,\n      platformRevenue,\n      therapistPayouts: totalRevenue - platformRevenue,\n      period: {\n        startDate,\n        endDate,\n      },\n    };\n  }\n}"],"version":3}