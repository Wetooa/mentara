{"file":"/home/wetooa/Documents/code/projects/mentara/mentara-api/src/messaging/messaging.service.spec.ts","mappings":"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","names":[],"sources":["/home/wetooa/Documents/code/projects/mentara/mentara-api/src/messaging/messaging.service.spec.ts"],"sourcesContent":["import { Test, TestingModule } from '@nestjs/testing';\nimport {\n  NotFoundException,\n  ForbiddenException,\n  BadRequestException,\n} from '@nestjs/common';\nimport { MessagingService } from './messaging.service';\nimport { PrismaService } from '../providers/prisma-client.provider';\nimport { EventBusService } from '../common/events/event-bus.service';\nimport { ConversationType, MessageType, ParticipantRole } from '@prisma/client';\nimport {\n  MessageReadEvent,\n  ConversationCreatedEvent,\n} from '../common/events/messaging-events';\nimport { createMockPrismaService, TEST_USER_IDS } from '../test-utils';\n\ndescribe('MessagingService', () => {\n  let service: MessagingService;\n  let prismaService: jest.Mocked<PrismaService>;\n  let eventBusService: jest.Mocked<EventBusService>;\n\n  beforeEach(async () => {\n    const mockPrisma = createMockPrismaService();\n    const mockEventBus = {\n      emit: jest.fn(),\n    };\n\n    const module: TestingModule = await Test.createTestingModule({\n      providers: [\n        MessagingService,\n        {\n          provide: PrismaService,\n          useValue: mockPrisma,\n        },\n        {\n          provide: EventBusService,\n          useValue: mockEventBus,\n        },\n      ],\n    }).compile();\n\n    service = module.get<MessagingService>(MessagingService);\n    prismaService = module.get(PrismaService);\n    eventBusService = module.get(EventBusService);\n  });\n\n  afterEach(() => {\n    jest.clearAllMocks();\n  });\n\n  describe('Conversation Management', () => {\n    describe('createConversation', () => {\n      const mockCreateConversationDto = {\n        participantIds: [TEST_USER_IDS.THERAPIST],\n        type: ConversationType.DIRECT,\n        title: 'Direct Chat',\n      };\n\n      const mockCreatedConversation = {\n        id: 'conversation-1',\n        type: ConversationType.DIRECT,\n        title: 'Direct Chat',\n        participants: [\n          {\n            userId: TEST_USER_IDS.CLIENT,\n            role: ParticipantRole.ADMIN,\n            user: {\n              id: TEST_USER_IDS.CLIENT,\n              firstName: 'John',\n              lastName: 'Doe',\n              avatarUrl: 'avatar.jpg',\n              role: 'client',\n            },\n          },\n          {\n            userId: TEST_USER_IDS.THERAPIST,\n            role: ParticipantRole.MEMBER,\n            user: {\n              id: TEST_USER_IDS.THERAPIST,\n              firstName: 'Dr. Jane',\n              lastName: 'Smith',\n              avatarUrl: 'therapist-avatar.jpg',\n              role: 'therapist',\n            },\n          },\n        ],\n        messages: [],\n      };\n\n      it('should create a direct conversation successfully', async () => {\n        jest\n          .spyOn(service as any, 'findDirectConversation')\n          .mockResolvedValue(null);\n        (prismaService.conversation.create as jest.Mock).mockResolvedValue(\n          mockCreatedConversation,\n        );\n\n        const result = await service.createConversation(\n          TEST_USER_IDS.CLIENT,\n          mockCreateConversationDto,\n        );\n\n        expect(result).toEqual(mockCreatedConversation);\n        expect(prismaService.conversation.create).toHaveBeenCalledWith({\n          data: {\n            type: ConversationType.DIRECT,\n            title: 'Direct Chat',\n            participants: {\n              create: [\n                { userId: TEST_USER_IDS.CLIENT, role: ParticipantRole.ADMIN },\n                {\n                  userId: TEST_USER_IDS.THERAPIST,\n                  role: ParticipantRole.MEMBER,\n                },\n              ],\n            },\n          },\n          include: expect.objectContaining({\n            participants: expect.any(Object),\n            messages: expect.any(Object),\n          }),\n        });\n\n        expect(eventBusService.emit).toHaveBeenCalledWith(\n          expect.any(ConversationCreatedEvent),\n        );\n      });\n\n      it('should return existing direct conversation if it already exists', async () => {\n        const existingConversation = {\n          ...mockCreatedConversation,\n          id: 'existing-1',\n        };\n        jest\n          .spyOn(service as any, 'findDirectConversation')\n          .mockResolvedValue(existingConversation);\n\n        const result = await service.createConversation(\n          TEST_USER_IDS.CLIENT,\n          mockCreateConversationDto,\n        );\n\n        expect(result).toEqual(existingConversation);\n        expect(prismaService.conversation.create).not.toHaveBeenCalled();\n      });\n\n      it('should throw BadRequestException for invalid direct conversation participants', async () => {\n        const invalidDto = {\n          ...mockCreateConversationDto,\n          participantIds: [TEST_USER_IDS.THERAPIST, TEST_USER_IDS.ADMIN], // Too many participants\n        };\n\n        await expect(\n          service.createConversation(TEST_USER_IDS.CLIENT, invalidDto),\n        ).rejects.toThrow(BadRequestException);\n      });\n\n      it('should create group conversation with multiple participants', async () => {\n        const groupDto = {\n          participantIds: [TEST_USER_IDS.THERAPIST, TEST_USER_IDS.ADMIN],\n          type: ConversationType.GROUP,\n          title: 'Group Chat',\n        };\n\n        const groupConversation = {\n          ...mockCreatedConversation,\n          type: ConversationType.GROUP,\n          title: 'Group Chat',\n        };\n\n        (prismaService.conversation.create as jest.Mock).mockResolvedValue(\n          groupConversation,\n        );\n\n        const result = await service.createConversation(\n          TEST_USER_IDS.CLIENT,\n          groupDto,\n        );\n\n        expect(result).toEqual(groupConversation);\n        expect(prismaService.conversation.create).toHaveBeenCalledWith({\n          data: {\n            type: ConversationType.GROUP,\n            title: 'Group Chat',\n            participants: {\n              create: [\n                { userId: TEST_USER_IDS.CLIENT, role: ParticipantRole.ADMIN },\n                {\n                  userId: TEST_USER_IDS.THERAPIST,\n                  role: ParticipantRole.MEMBER,\n                },\n                { userId: TEST_USER_IDS.ADMIN, role: ParticipantRole.MEMBER },\n              ],\n            },\n          },\n          include: expect.any(Object),\n        });\n      });\n\n      it('should emit ConversationCreatedEvent with correct data', async () => {\n        jest\n          .spyOn(service as any, 'findDirectConversation')\n          .mockResolvedValue(null);\n        (prismaService.conversation.create as jest.Mock).mockResolvedValue(\n          mockCreatedConversation,\n        );\n\n        await service.createConversation(\n          TEST_USER_IDS.CLIENT,\n          mockCreateConversationDto,\n        );\n\n        expect(eventBusService.emit).toHaveBeenCalledWith(\n          expect.objectContaining({\n            conversationId: 'conversation-1',\n            createdBy: TEST_USER_IDS.CLIENT,\n            participantIds: [TEST_USER_IDS.CLIENT, TEST_USER_IDS.THERAPIST],\n            conversationType: 'direct',\n            title: 'Direct Chat',\n            isPrivate: true,\n          }),\n        );\n      });\n    });\n\n    describe('getUserConversations', () => {\n      const mockConversations = [\n        {\n          id: 'conversation-1',\n          type: ConversationType.DIRECT,\n          lastMessageAt: new Date(),\n          participants: [\n            {\n              userId: TEST_USER_IDS.CLIENT,\n              user: {\n                id: TEST_USER_IDS.CLIENT,\n                firstName: 'John',\n                lastName: 'Doe',\n                avatarUrl: 'avatar.jpg',\n                role: 'client',\n              },\n            },\n          ],\n          messages: [\n            {\n              id: 'message-1',\n              content: 'Hello',\n              sender: {\n                id: TEST_USER_IDS.THERAPIST,\n                firstName: 'Dr. Jane',\n                lastName: 'Smith',\n                avatarUrl: 'therapist-avatar.jpg',\n              },\n            },\n          ],\n          _count: {\n            messages: 2, // Unread messages\n          },\n        },\n      ];\n\n      it('should return user conversations with pagination', async () => {\n        (prismaService.conversation.findMany as jest.Mock).mockResolvedValue(\n          mockConversations,\n        );\n\n        const result = await service.getUserConversations(\n          TEST_USER_IDS.CLIENT,\n          1,\n          20,\n        );\n\n        expect(result).toEqual(mockConversations);\n        expect(prismaService.conversation.findMany).toHaveBeenCalledWith({\n          where: {\n            participants: {\n              some: {\n                userId: TEST_USER_IDS.CLIENT,\n                isActive: true,\n              },\n            },\n            isActive: true,\n          },\n          include: expect.objectContaining({\n            participants: expect.any(Object),\n            messages: expect.any(Object),\n            _count: expect.any(Object),\n          }),\n          orderBy: { lastMessageAt: 'desc' },\n          skip: 0,\n          take: 20,\n        });\n      });\n\n      it('should handle pagination correctly', async () => {\n        (prismaService.conversation.findMany as jest.Mock).mockResolvedValue(\n          mockConversations,\n        );\n\n        await service.getUserConversations(TEST_USER_IDS.CLIENT, 3, 10);\n\n        expect(prismaService.conversation.findMany).toHaveBeenCalledWith(\n          expect.objectContaining({\n            skip: 20, // (3-1) * 10\n            take: 10,\n          }),\n        );\n      });\n    });\n  });\n\n  describe('Message Management', () => {\n    describe('sendMessage', () => {\n      const mockSendMessageDto = {\n        content: 'Hello there!',\n        messageType: MessageType.TEXT,\n      };\n\n      const mockCreatedMessage = {\n        id: 'message-1',\n        conversationId: 'conversation-1',\n        senderId: TEST_USER_IDS.CLIENT,\n        content: 'Hello there!',\n        messageType: MessageType.TEXT,\n        replyToId: null,\n        attachmentUrl: null,\n        attachmentName: null,\n        attachmentSize: null,\n        createdAt: new Date(),\n        sender: {\n          id: TEST_USER_IDS.CLIENT,\n          firstName: 'John',\n          lastName: 'Doe',\n          avatarUrl: 'avatar.jpg',\n        },\n        replyTo: null,\n        reactions: [],\n      };\n\n      const mockConversation = {\n        id: 'conversation-1',\n        participants: [\n          { userId: TEST_USER_IDS.CLIENT },\n          { userId: TEST_USER_IDS.THERAPIST },\n        ],\n      };\n\n      it('should send message successfully', async () => {\n        jest.spyOn(service as any, 'verifyParticipant').mockResolvedValue(true);\n        (prismaService.message.create as jest.Mock).mockResolvedValue(\n          mockCreatedMessage,\n        );\n        (prismaService.conversation.update as jest.Mock).mockResolvedValue({\n          lastMessageAt: new Date(),\n        });\n        (prismaService.conversation.findUnique as jest.Mock).mockResolvedValue(\n          mockConversation,\n        );\n\n        const result = await service.sendMessage(\n          TEST_USER_IDS.CLIENT,\n          'conversation-1',\n          mockSendMessageDto,\n        );\n\n        expect(result).toEqual(mockCreatedMessage);\n        expect(service['verifyParticipant']).toHaveBeenCalledWith(\n          TEST_USER_IDS.CLIENT,\n          'conversation-1',\n        );\n        expect(prismaService.message.create).toHaveBeenCalledWith({\n          data: {\n            conversationId: 'conversation-1',\n            senderId: TEST_USER_IDS.CLIENT,\n            content: 'Hello there!',\n            messageType: MessageType.TEXT,\n            replyToId: undefined,\n            attachmentUrl: null,\n            attachmentName: null,\n            attachmentSize: null,\n          },\n          include: expect.any(Object),\n        });\n      });\n\n      it('should update conversation lastMessageAt', async () => {\n        jest.spyOn(service as any, 'verifyParticipant').mockResolvedValue(true);\n        (prismaService.message.create as jest.Mock).mockResolvedValue(\n          mockCreatedMessage,\n        );\n        (prismaService.conversation.update as jest.Mock).mockResolvedValue({\n          lastMessageAt: new Date(),\n        });\n        (prismaService.conversation.findUnique as jest.Mock).mockResolvedValue(\n          mockConversation,\n        );\n\n        await service.sendMessage(\n          TEST_USER_IDS.CLIENT,\n          'conversation-1',\n          mockSendMessageDto,\n        );\n\n        expect(prismaService.conversation.update).toHaveBeenCalledWith({\n          where: { id: 'conversation-1' },\n          data: { lastMessageAt: expect.any(Date) },\n        });\n      });\n\n      it('should emit MessageSentEvent', async () => {\n        jest.spyOn(service as any, 'verifyParticipant').mockResolvedValue(true);\n        (prismaService.message.create as jest.Mock).mockResolvedValue(\n          mockCreatedMessage,\n        );\n        (prismaService.conversation.update as jest.Mock).mockResolvedValue({\n          lastMessageAt: new Date(),\n        });\n        (prismaService.conversation.findUnique as jest.Mock).mockResolvedValue(\n          mockConversation,\n        );\n\n        await service.sendMessage(\n          TEST_USER_IDS.CLIENT,\n          'conversation-1',\n          mockSendMessageDto,\n        );\n\n        expect(eventBusService.emit).toHaveBeenCalledWith(\n          expect.objectContaining({\n            messageId: 'message-1',\n            conversationId: 'conversation-1',\n            senderId: TEST_USER_IDS.CLIENT,\n            content: 'Hello there!',\n            messageType: 'text',\n            recipientIds: [TEST_USER_IDS.THERAPIST],\n          }),\n        );\n      });\n\n      it('should handle reply messages', async () => {\n        const replyDto = {\n          ...mockSendMessageDto,\n          replyToId: 'original-message-id',\n        };\n\n        jest.spyOn(service as any, 'verifyParticipant').mockResolvedValue(true);\n        (prismaService.message.create as jest.Mock).mockResolvedValue({\n          ...mockCreatedMessage,\n          replyToId: 'original-message-id',\n        });\n        (prismaService.conversation.update as jest.Mock).mockResolvedValue({\n          lastMessageAt: new Date(),\n        });\n        (prismaService.conversation.findUnique as jest.Mock).mockResolvedValue(\n          mockConversation,\n        );\n\n        await service.sendMessage(\n          TEST_USER_IDS.CLIENT,\n          'conversation-1',\n          replyDto,\n        );\n\n        expect(prismaService.message.create).toHaveBeenCalledWith({\n          data: expect.objectContaining({\n            replyToId: 'original-message-id',\n          }),\n          include: expect.any(Object),\n        });\n      });\n\n      it('should handle file attachments', async () => {\n        const fileDto = {\n          ...mockSendMessageDto,\n          messageType: MessageType.FILE,\n          attachmentUrl: 'https://storage.com/file.pdf',\n          attachmentName: 'document.pdf',\n          attachmentSize: 1024,\n        };\n\n        jest.spyOn(service as any, 'verifyParticipant').mockResolvedValue(true);\n        (prismaService.message.create as jest.Mock).mockResolvedValue({\n          ...mockCreatedMessage,\n          messageType: MessageType.FILE,\n          attachmentUrl: 'https://storage.com/file.pdf',\n        });\n        (prismaService.conversation.update as jest.Mock).mockResolvedValue({\n          lastMessageAt: new Date(),\n        });\n        (prismaService.conversation.findUnique as jest.Mock).mockResolvedValue(\n          mockConversation,\n        );\n\n        await service.sendMessage(\n          TEST_USER_IDS.CLIENT,\n          'conversation-1',\n          fileDto,\n        );\n\n        expect(eventBusService.emit).toHaveBeenCalledWith(\n          expect.objectContaining({\n            messageType: 'file',\n            fileAttachments: ['https://storage.com/file.pdf'],\n          }),\n        );\n      });\n    });\n\n    describe('getConversationMessages', () => {\n      const mockMessages = [\n        {\n          id: 'message-2',\n          content: 'Second message',\n          createdAt: new Date('2024-01-02'),\n          sender: { firstName: 'Jane', lastName: 'Smith' },\n          replyTo: null,\n          reactions: [],\n          readReceipts: [],\n        },\n        {\n          id: 'message-1',\n          content: 'First message',\n          createdAt: new Date('2024-01-01'),\n          sender: { firstName: 'John', lastName: 'Doe' },\n          replyTo: null,\n          reactions: [],\n          readReceipts: [],\n        },\n      ];\n\n      it('should return messages in chronological order', async () => {\n        jest.spyOn(service as any, 'verifyParticipant').mockResolvedValue(true);\n        (prismaService.message.findMany as jest.Mock).mockResolvedValue(\n          mockMessages,\n        );\n\n        const result = await service.getConversationMessages(\n          TEST_USER_IDS.CLIENT,\n          'conversation-1',\n          1,\n          50,\n        );\n\n        // Should reverse the order to be chronological\n        expect(result).toEqual(mockMessages.reverse());\n        expect(service['verifyParticipant']).toHaveBeenCalledWith(\n          TEST_USER_IDS.CLIENT,\n          'conversation-1',\n        );\n      });\n\n      it('should handle pagination', async () => {\n        jest.spyOn(service as any, 'verifyParticipant').mockResolvedValue(true);\n        (prismaService.message.findMany as jest.Mock).mockResolvedValue(\n          mockMessages,\n        );\n\n        await service.getConversationMessages(\n          TEST_USER_IDS.CLIENT,\n          'conversation-1',\n          2,\n          25,\n        );\n\n        expect(prismaService.message.findMany).toHaveBeenCalledWith({\n          where: {\n            conversationId: 'conversation-1',\n            isDeleted: false,\n          },\n          include: expect.any(Object),\n          orderBy: { createdAt: 'desc' },\n          skip: 25, // (2-1) * 25\n          take: 25,\n        });\n      });\n    });\n\n    describe('updateMessage', () => {\n      const mockMessage = {\n        id: 'message-1',\n        senderId: TEST_USER_IDS.CLIENT,\n        isDeleted: false,\n      };\n\n      const mockUpdateDto = {\n        content: 'Updated message content',\n      };\n\n      it('should update message successfully', async () => {\n        const updatedMessage = {\n          ...mockMessage,\n          content: 'Updated message content',\n          isEdited: true,\n          editedAt: expect.any(Date),\n          sender: { firstName: 'John', lastName: 'Doe' },\n          reactions: [],\n        };\n\n        (prismaService.message.findUnique as jest.Mock).mockResolvedValue(\n          mockMessage,\n        );\n        (prismaService.message.update as jest.Mock).mockResolvedValue(\n          updatedMessage,\n        );\n\n        const result = await service.updateMessage(\n          TEST_USER_IDS.CLIENT,\n          'message-1',\n          mockUpdateDto,\n        );\n\n        expect(result).toEqual(updatedMessage);\n        expect(prismaService.message.update).toHaveBeenCalledWith({\n          where: { id: 'message-1' },\n          data: {\n            content: 'Updated message content',\n            isEdited: true,\n            editedAt: expect.any(Date),\n          },\n          include: expect.any(Object),\n        });\n      });\n\n      it('should throw NotFoundException when message not found', async () => {\n        (prismaService.message.findUnique as jest.Mock).mockResolvedValue(null);\n\n        await expect(\n          service.updateMessage(\n            TEST_USER_IDS.CLIENT,\n            'non-existent',\n            mockUpdateDto,\n          ),\n        ).rejects.toThrow(NotFoundException);\n      });\n\n      it('should throw ForbiddenException when user is not message sender', async () => {\n        const otherUserMessage = {\n          ...mockMessage,\n          senderId: 'other-user-id',\n        };\n\n        (prismaService.message.findUnique as jest.Mock).mockResolvedValue(\n          otherUserMessage,\n        );\n\n        await expect(\n          service.updateMessage(\n            TEST_USER_IDS.CLIENT,\n            'message-1',\n            mockUpdateDto,\n          ),\n        ).rejects.toThrow(ForbiddenException);\n      });\n\n      it('should throw BadRequestException when message is deleted', async () => {\n        const deletedMessage = {\n          ...mockMessage,\n          isDeleted: true,\n        };\n\n        (prismaService.message.findUnique as jest.Mock).mockResolvedValue(\n          deletedMessage,\n        );\n\n        await expect(\n          service.updateMessage(\n            TEST_USER_IDS.CLIENT,\n            'message-1',\n            mockUpdateDto,\n          ),\n        ).rejects.toThrow(BadRequestException);\n      });\n    });\n\n    describe('deleteMessage', () => {\n      const mockMessage = {\n        id: 'message-1',\n        senderId: TEST_USER_IDS.CLIENT,\n      };\n\n      it('should delete message successfully', async () => {\n        (prismaService.message.findUnique as jest.Mock).mockResolvedValue(\n          mockMessage,\n        );\n        (prismaService.message.update as jest.Mock).mockResolvedValue({\n          ...mockMessage,\n          isDeleted: true,\n        });\n\n        const result = await service.deleteMessage(\n          TEST_USER_IDS.CLIENT,\n          'message-1',\n        );\n\n        expect(result).toEqual({ success: true });\n        expect(prismaService.message.update).toHaveBeenCalledWith({\n          where: { id: 'message-1' },\n          data: { isDeleted: true },\n        });\n      });\n\n      it('should throw NotFoundException when message not found', async () => {\n        (prismaService.message.findUnique as jest.Mock).mockResolvedValue(null);\n\n        await expect(\n          service.deleteMessage(TEST_USER_IDS.CLIENT, 'non-existent'),\n        ).rejects.toThrow(NotFoundException);\n      });\n\n      it('should throw ForbiddenException when user is not message sender', async () => {\n        const otherUserMessage = {\n          ...mockMessage,\n          senderId: 'other-user-id',\n        };\n\n        (prismaService.message.findUnique as jest.Mock).mockResolvedValue(\n          otherUserMessage,\n        );\n\n        await expect(\n          service.deleteMessage(TEST_USER_IDS.CLIENT, 'message-1'),\n        ).rejects.toThrow(ForbiddenException);\n      });\n    });\n  });\n\n  describe('Read Receipts', () => {\n    describe('markMessageAsRead', () => {\n      const mockMessage = {\n        id: 'message-1',\n        senderId: TEST_USER_IDS.THERAPIST,\n        conversationId: 'conversation-1',\n      };\n\n      it('should mark message as read successfully', async () => {\n        (prismaService.message.findUnique as jest.Mock).mockResolvedValue(\n          mockMessage,\n        );\n        jest.spyOn(service as any, 'verifyParticipant').mockResolvedValue(true);\n        (\n          prismaService.messageReadReceipt.upsert as jest.Mock\n        ).mockResolvedValue({\n          messageId: 'message-1',\n          userId: TEST_USER_IDS.CLIENT,\n          readAt: new Date(),\n        });\n        (\n          prismaService.conversationParticipant.updateMany as jest.Mock\n        ).mockResolvedValue({\n          count: 1,\n        });\n\n        await service.markMessageAsRead(TEST_USER_IDS.CLIENT, 'message-1');\n\n        expect(prismaService.messageReadReceipt.upsert).toHaveBeenCalledWith({\n          where: {\n            messageId_userId: {\n              messageId: 'message-1',\n              userId: TEST_USER_IDS.CLIENT,\n            },\n          },\n          create: {\n            messageId: 'message-1',\n            userId: TEST_USER_IDS.CLIENT,\n          },\n          update: {\n            readAt: expect.any(Date),\n          },\n        });\n\n        expect(eventBusService.emit).toHaveBeenCalledWith(\n          expect.any(MessageReadEvent),\n        );\n      });\n\n      it('should not create read receipt for own messages', async () => {\n        const ownMessage = {\n          ...mockMessage,\n          senderId: TEST_USER_IDS.CLIENT,\n        };\n\n        (prismaService.message.findUnique as jest.Mock).mockResolvedValue(\n          ownMessage,\n        );\n\n        await service.markMessageAsRead(TEST_USER_IDS.CLIENT, 'message-1');\n\n        expect(prismaService.messageReadReceipt.upsert).not.toHaveBeenCalled();\n      });\n\n      it('should throw NotFoundException when message not found', async () => {\n        (prismaService.message.findUnique as jest.Mock).mockResolvedValue(null);\n\n        await expect(\n          service.markMessageAsRead(TEST_USER_IDS.CLIENT, 'non-existent'),\n        ).rejects.toThrow(NotFoundException);\n      });\n    });\n  });\n\n  describe('Message Reactions', () => {\n    describe('addMessageReaction', () => {\n      const mockMessage = {\n        id: 'message-1',\n        conversationId: 'conversation-1',\n      };\n\n      it('should add reaction successfully', async () => {\n        const mockReaction = {\n          id: 'reaction-1',\n          messageId: 'message-1',\n          userId: TEST_USER_IDS.CLIENT,\n          emoji: '',\n          user: {\n            id: TEST_USER_IDS.CLIENT,\n            firstName: 'John',\n            lastName: 'Doe',\n          },\n        };\n\n        (prismaService.message.findUnique as jest.Mock).mockResolvedValue(\n          mockMessage,\n        );\n        jest.spyOn(service as any, 'verifyParticipant').mockResolvedValue(true);\n        (prismaService.messageReaction.upsert as jest.Mock).mockResolvedValue(\n          mockReaction,\n        );\n\n        const result = await service.addMessageReaction(\n          TEST_USER_IDS.CLIENT,\n          'message-1',\n          '',\n        );\n\n        expect(result).toEqual(mockReaction);\n        expect(prismaService.messageReaction.upsert).toHaveBeenCalledWith({\n          where: {\n            messageId_userId_emoji: {\n              messageId: 'message-1',\n              userId: TEST_USER_IDS.CLIENT,\n              emoji: '',\n            },\n          },\n          create: {\n            messageId: 'message-1',\n            userId: TEST_USER_IDS.CLIENT,\n            emoji: '',\n          },\n          update: {\n            emoji: '',\n          },\n          include: expect.any(Object),\n        });\n      });\n\n      it('should throw NotFoundException when message not found', async () => {\n        (prismaService.message.findUnique as jest.Mock).mockResolvedValue(null);\n\n        await expect(\n          service.addMessageReaction(\n            TEST_USER_IDS.CLIENT,\n            'non-existent',\n            '',\n          ),\n        ).rejects.toThrow(NotFoundException);\n      });\n    });\n\n    describe('removeMessageReaction', () => {\n      it('should remove reaction successfully', async () => {\n        (\n          prismaService.messageReaction.deleteMany as jest.Mock\n        ).mockResolvedValue({\n          count: 1,\n        });\n\n        const result = await service.removeMessageReaction(\n          TEST_USER_IDS.CLIENT,\n          'message-1',\n          '',\n        );\n\n        expect(result).toEqual({ success: true });\n        expect(prismaService.messageReaction.deleteMany).toHaveBeenCalledWith({\n          where: {\n            messageId: 'message-1',\n            userId: TEST_USER_IDS.CLIENT,\n            emoji: '',\n          },\n        });\n      });\n    });\n  });\n\n  describe('User Blocking', () => {\n    describe('blockUser', () => {\n      it('should block user successfully', async () => {\n        (prismaService.userBlock.upsert as jest.Mock).mockResolvedValue({\n          id: 'block-1',\n          blockerId: TEST_USER_IDS.CLIENT,\n          blockedId: TEST_USER_IDS.THERAPIST,\n          reason: 'Inappropriate behavior',\n        });\n\n        const result = await service.blockUser(\n          TEST_USER_IDS.CLIENT,\n          TEST_USER_IDS.THERAPIST,\n          'Inappropriate behavior',\n        );\n\n        expect(result).toEqual({ success: true });\n        expect(prismaService.userBlock.upsert).toHaveBeenCalledWith({\n          where: {\n            blockerId_blockedId: {\n              blockerId: TEST_USER_IDS.CLIENT,\n              blockedId: TEST_USER_IDS.THERAPIST,\n            },\n          },\n          create: {\n            blockerId: TEST_USER_IDS.CLIENT,\n            blockedId: TEST_USER_IDS.THERAPIST,\n            reason: 'Inappropriate behavior',\n          },\n          update: {\n            reason: 'Inappropriate behavior',\n          },\n        });\n      });\n\n      it('should throw BadRequestException when trying to block self', async () => {\n        await expect(\n          service.blockUser(TEST_USER_IDS.CLIENT, TEST_USER_IDS.CLIENT),\n        ).rejects.toThrow(BadRequestException);\n      });\n    });\n\n    describe('unblockUser', () => {\n      it('should unblock user successfully', async () => {\n        (prismaService.userBlock.deleteMany as jest.Mock).mockResolvedValue({\n          count: 1,\n        });\n\n        const result = await service.unblockUser(\n          TEST_USER_IDS.CLIENT,\n          TEST_USER_IDS.THERAPIST,\n        );\n\n        expect(result).toEqual({ success: true });\n        expect(prismaService.userBlock.deleteMany).toHaveBeenCalledWith({\n          where: {\n            blockerId: TEST_USER_IDS.CLIENT,\n            blockedId: TEST_USER_IDS.THERAPIST,\n          },\n        });\n      });\n    });\n  });\n\n  describe('Helper Methods', () => {\n    describe('findDirectConversation', () => {\n      it('should find existing direct conversation', async () => {\n        const mockConversation = {\n          id: 'conversation-1',\n          type: ConversationType.DIRECT,\n          participants: [],\n        };\n\n        (prismaService.conversation.findFirst as jest.Mock).mockResolvedValue(\n          mockConversation,\n        );\n\n        const result = await service['findDirectConversation'](\n          TEST_USER_IDS.CLIENT,\n          TEST_USER_IDS.THERAPIST,\n        );\n\n        expect(result).toEqual(mockConversation);\n        expect(prismaService.conversation.findFirst).toHaveBeenCalledWith({\n          where: {\n            type: ConversationType.DIRECT,\n            participants: {\n              every: {\n                userId: { in: [TEST_USER_IDS.CLIENT, TEST_USER_IDS.THERAPIST] },\n              },\n            },\n          },\n          include: expect.any(Object),\n        });\n      });\n    });\n\n    describe('verifyParticipant', () => {\n      it('should return participant when valid and active', async () => {\n        const mockParticipant = {\n          id: 'participant-1',\n          conversationId: 'conversation-1',\n          userId: TEST_USER_IDS.CLIENT,\n          isActive: true,\n        };\n\n        (\n          prismaService.conversationParticipant.findUnique as jest.Mock\n        ).mockResolvedValue(mockParticipant);\n\n        const result = await service['verifyParticipant'](\n          TEST_USER_IDS.CLIENT,\n          'conversation-1',\n        );\n\n        expect(result).toEqual(mockParticipant);\n      });\n\n      it('should throw ForbiddenException when participant not found', async () => {\n        (\n          prismaService.conversationParticipant.findUnique as jest.Mock\n        ).mockResolvedValue(null);\n\n        await expect(\n          service['verifyParticipant'](TEST_USER_IDS.CLIENT, 'conversation-1'),\n        ).rejects.toThrow(ForbiddenException);\n      });\n\n      it('should throw ForbiddenException when participant is inactive', async () => {\n        const inactiveParticipant = {\n          id: 'participant-1',\n          conversationId: 'conversation-1',\n          userId: TEST_USER_IDS.CLIENT,\n          isActive: false,\n        };\n\n        (\n          prismaService.conversationParticipant.findUnique as jest.Mock\n        ).mockResolvedValue(inactiveParticipant);\n\n        await expect(\n          service['verifyParticipant'](TEST_USER_IDS.CLIENT, 'conversation-1'),\n        ).rejects.toThrow(ForbiddenException);\n      });\n    });\n  });\n\n  describe('Search Messages', () => {\n    describe('searchMessages', () => {\n      const mockSearchResults = [\n        {\n          id: 'message-1',\n          content: 'Hello world',\n          sender: {\n            id: TEST_USER_IDS.CLIENT,\n            firstName: 'John',\n            lastName: 'Doe',\n            avatarUrl: 'avatar.jpg',\n          },\n          conversation: {\n            id: 'conversation-1',\n            type: ConversationType.DIRECT,\n            title: null,\n          },\n        },\n      ];\n\n      it('should search messages across all conversations', async () => {\n        (prismaService.message.findMany as jest.Mock).mockResolvedValue(\n          mockSearchResults,\n        );\n\n        const result = await service.searchMessages(\n          TEST_USER_IDS.CLIENT,\n          'hello',\n          undefined,\n          1,\n          20,\n        );\n\n        expect(result).toEqual(mockSearchResults);\n        expect(prismaService.message.findMany).toHaveBeenCalledWith({\n          where: {\n            content: {\n              contains: 'hello',\n              mode: 'insensitive',\n            },\n            isDeleted: false,\n            conversation: {\n              participants: {\n                some: {\n                  userId: TEST_USER_IDS.CLIENT,\n                  isActive: true,\n                },\n              },\n            },\n          },\n          include: expect.any(Object),\n          orderBy: { createdAt: 'desc' },\n          skip: 0,\n          take: 20,\n        });\n      });\n\n      it('should search messages within specific conversation', async () => {\n        (prismaService.message.findMany as jest.Mock).mockResolvedValue(\n          mockSearchResults,\n        );\n\n        await service.searchMessages(\n          TEST_USER_IDS.CLIENT,\n          'hello',\n          'conversation-1',\n          1,\n          20,\n        );\n\n        expect(prismaService.message.findMany).toHaveBeenCalledWith({\n          where: expect.objectContaining({\n            conversationId: 'conversation-1',\n          }),\n          include: expect.any(Object),\n          orderBy: { createdAt: 'desc' },\n          skip: 0,\n          take: 20,\n        });\n      });\n\n      it('should handle pagination in search', async () => {\n        (prismaService.message.findMany as jest.Mock).mockResolvedValue(\n          mockSearchResults,\n        );\n\n        await service.searchMessages(\n          TEST_USER_IDS.CLIENT,\n          'hello',\n          undefined,\n          2,\n          10,\n        );\n\n        expect(prismaService.message.findMany).toHaveBeenCalledWith({\n          where: expect.any(Object),\n          include: expect.any(Object),\n          orderBy: { createdAt: 'desc' },\n          skip: 10, // (2-1) * 10\n          take: 10,\n        });\n      });\n    });\n  });\n});\n"],"version":3}