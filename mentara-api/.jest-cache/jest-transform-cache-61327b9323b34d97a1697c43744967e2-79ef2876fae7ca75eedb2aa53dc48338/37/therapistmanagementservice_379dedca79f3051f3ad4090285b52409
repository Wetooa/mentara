65b7b08d8739fdb9a98f7c9f70485e9f
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.TherapistManagementService = void 0;
const common_1 = require("@nestjs/common");
const prisma_client_provider_1 = require("../providers/prisma-client.provider");
const library_1 = require("@prisma/client/runtime/library");
let TherapistManagementService = class TherapistManagementService {
    prisma;
    constructor(prisma) {
        this.prisma = prisma;
    }
    calculateYearsOfExperience(startDate) {
        const now = new Date();
        let years = now.getFullYear() - startDate.getFullYear();
        if (now.getMonth() < startDate.getMonth() ||
            (now.getMonth() === startDate.getMonth() &&
                now.getDate() < startDate.getDate())) {
            years--;
        }
        return years;
    }
    async getTherapistProfile(userId) {
        try {
            const therapist = await this.prisma.therapist.findUniqueOrThrow({
                where: { userId },
                include: {
                    user: true,
                    therapistAvailabilities: true,
                    worksheets: true,
                    meetings: true,
                    assignedClients: true,
                },
            });
            return {
                ...therapist,
                treatmentSuccessRates: therapist.treatmentSuccessRates || {},
                hourlyRate: therapist.hourlyRate,
            };
        }
        catch (error) {
            console.error('Error retrieving therapist profile:', error instanceof Error ? error.message : error);
            throw new common_1.InternalServerErrorException('Failed to retrieve therapist profile');
        }
    }
    async updateTherapistProfile(userId, data) {
        try {
            // Update therapist profile data
            const therapistData = {};
            if (data.mobile !== undefined)
                therapistData.mobile = data.mobile;
            if (data.province !== undefined)
                therapistData.province = data.province;
            if (data.providerType !== undefined)
                therapistData.providerType = data.providerType;
            if (data.professionalLicenseType !== undefined)
                therapistData.professionalLicenseType = data.professionalLicenseType;
            if (data.isPRCLicensed !== undefined)
                therapistData.isPRCLicensed = data.isPRCLicensed;
            if (data.prcLicenseNumber !== undefined)
                therapistData.prcLicenseNumber = data.prcLicenseNumber;
            if (data.expirationDateOfLicense !== undefined)
                therapistData.expirationDateOfLicense = data.expirationDateOfLicense;
            if (data.practiceStartDate !== undefined)
                therapistData.practiceStartDate = data.practiceStartDate;
            if (data.areasOfExpertise !== undefined)
                therapistData.areasOfExpertise = data.areasOfExpertise;
            if (data.assessmentTools !== undefined)
                therapistData.assessmentTools = data.assessmentTools;
            if (data.therapeuticApproachesUsedList !== undefined)
                therapistData.therapeuticApproachesUsedList =
                    data.therapeuticApproachesUsedList;
            if (data.languagesOffered !== undefined)
                therapistData.languagesOffered = data.languagesOffered;
            if (data.providedOnlineTherapyBefore !== undefined)
                therapistData.providedOnlineTherapyBefore =
                    data.providedOnlineTherapyBefore;
            if (data.comfortableUsingVideoConferencing !== undefined)
                therapistData.comfortableUsingVideoConferencing =
                    data.comfortableUsingVideoConferencing;
            if (data.preferredSessionLength !== undefined)
                therapistData.preferredSessionLength = data.preferredSessionLength;
            if (data.privateConfidentialSpace !== undefined)
                therapistData.privateConfidentialSpace = data.privateConfidentialSpace;
            if (data.compliesWithDataPrivacyAct !== undefined)
                therapistData.compliesWithDataPrivacyAct =
                    data.compliesWithDataPrivacyAct;
            if (data.professionalLiabilityInsurance !== undefined)
                therapistData.professionalLiabilityInsurance =
                    data.professionalLiabilityInsurance;
            if (data.complaintsOrDisciplinaryActions !== undefined)
                therapistData.complaintsOrDisciplinaryActions =
                    data.complaintsOrDisciplinaryActions;
            if (data.willingToAbideByPlatformGuidelines !== undefined)
                therapistData.willingToAbideByPlatformGuidelines =
                    data.willingToAbideByPlatformGuidelines;
            if (data.expertise !== undefined)
                therapistData.expertise = data.expertise;
            if (data.approaches !== undefined)
                therapistData.approaches = data.approaches;
            if (data.languages !== undefined)
                therapistData.languages = data.languages;
            if (data.illnessSpecializations !== undefined)
                therapistData.illnessSpecializations = data.illnessSpecializations;
            if (data.acceptTypes !== undefined)
                therapistData.acceptTypes = data.acceptTypes;
            if (data.treatmentSuccessRates !== undefined)
                therapistData.treatmentSuccessRates = data.treatmentSuccessRates;
            if (data.sessionLength !== undefined)
                therapistData.sessionLength = data.sessionLength;
            if (data.hourlyRate !== undefined)
                therapistData.hourlyRate = new library_1.Decimal(data.hourlyRate);
            const updatedTherapist = await this.prisma.therapist.update({
                where: { userId },
                data: therapistData,
                include: {
                    user: true,
                },
            });
            return {
                ...updatedTherapist,
                treatmentSuccessRates: updatedTherapist.treatmentSuccessRates || {},
                hourlyRate: updatedTherapist.hourlyRate,
            };
        }
        catch (error) {
            console.error('Error updating therapist profile:', error instanceof Error ? error.message : error);
            throw new common_1.InternalServerErrorException('Failed to update therapist profile');
        }
    }
    async getAssignedPatients(therapistId) {
        try {
            const therapist = await this.prisma.therapist.findUniqueOrThrow({
                where: { userId: therapistId },
            });
            // Find all clients assigned to this therapist
            const assignedClients = await this.prisma.clientTherapist.findMany({
                where: { therapistId: therapist.userId, status: 'active' },
                include: { client: { include: { user: true } } },
            });
            return assignedClients.map((ct) => ({
                ...ct.client,
                user: ct.client.user,
            }));
        }
        catch (error) {
            console.error('Error retrieving assigned patients:', error instanceof Error ? error.message : error);
            throw new common_1.InternalServerErrorException('Failed to retrieve assigned patients');
        }
    }
    async getAllClients(therapistId) {
        try {
            // Find all clients assigned to this therapist
            const assignedClients = await this.prisma.clientTherapist.findMany({
                where: { therapistId: therapistId, status: 'active' },
                include: { client: { include: { user: true } } },
            });
            return assignedClients.map((ct) => ({
                ...ct.client,
            }));
        }
        catch (error) {
            console.error('Error retrieving all clients:', error instanceof Error ? error.message : error);
            throw new common_1.InternalServerErrorException('Failed to retrieve all clients');
        }
    }
    async getClientById(therapistId, clientId) {
        try {
            // Find the specific client assigned to this therapist
            const assignedClient = await this.prisma.clientTherapist.findFirst({
                where: { therapistId: therapistId, clientId: clientId },
                include: { client: { include: { user: true } } },
            });
            if (!assignedClient) {
                throw new common_1.NotFoundException('Client not found');
            }
            return assignedClient.client;
        }
        catch (error) {
            console.error('Error retrieving client by ID:', error instanceof Error ? error.message : error);
            throw new common_1.InternalServerErrorException('Failed to retrieve client by ID');
        }
    }
    async getProfile(therapistId) {
        try {
            const therapist = await this.prisma.therapist.findUniqueOrThrow({
                where: { userId: therapistId },
                include: {
                    user: true,
                },
            });
            return {
                ...therapist,
                treatmentSuccessRates: therapist.treatmentSuccessRates || {},
                hourlyRate: therapist.hourlyRate,
            };
        }
        catch (error) {
            console.error('Error retrieving therapist profile:', error instanceof Error ? error.message : error);
            throw new common_1.InternalServerErrorException('Failed to retrieve therapist profile');
        }
    }
    async updateProfile(therapistId, data) {
        try {
            const updatedTherapist = await this.prisma.therapist.update({
                where: { userId: therapistId },
                data,
                include: {
                    user: true,
                },
            });
            return {
                ...updatedTherapist,
                treatmentSuccessRates: updatedTherapist.treatmentSuccessRates || {},
                hourlyRate: updatedTherapist.hourlyRate,
            };
        }
        catch (error) {
            console.error('Error updating therapist profile:', error instanceof Error ? error.message : error);
            throw new common_1.InternalServerErrorException('Failed to update therapist profile');
        }
    }
};
exports.TherapistManagementService = TherapistManagementService;
exports.TherapistManagementService = TherapistManagementService = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [prisma_client_provider_1.PrismaService])
], TherapistManagementService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL3RoZXJhcGlzdC90aGVyYXBpc3QtbWFuYWdlbWVudC5zZXJ2aWNlLnRzIiwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7OztBQUFBLDJDQUl3QjtBQUN4QixnRkFBb0U7QUFFcEUsNERBQXlEO0FBUWxELElBQU0sMEJBQTBCLEdBQWhDLE1BQU0sMEJBQTBCO0lBQ1I7SUFBN0IsWUFBNkIsTUFBcUI7UUFBckIsV0FBTSxHQUFOLE1BQU0sQ0FBZTtJQUFHLENBQUM7SUFFOUMsMEJBQTBCLENBQUMsU0FBZTtRQUNoRCxNQUFNLEdBQUcsR0FBRyxJQUFJLElBQUksRUFBRSxDQUFDO1FBQ3ZCLElBQUksS0FBSyxHQUFHLEdBQUcsQ0FBQyxXQUFXLEVBQUUsR0FBRyxTQUFTLENBQUMsV0FBVyxFQUFFLENBQUM7UUFDeEQsSUFDRSxHQUFHLENBQUMsUUFBUSxFQUFFLEdBQUcsU0FBUyxDQUFDLFFBQVEsRUFBRTtZQUNyQyxDQUFDLEdBQUcsQ0FBQyxRQUFRLEVBQUUsS0FBSyxTQUFTLENBQUMsUUFBUSxFQUFFO2dCQUN0QyxHQUFHLENBQUMsT0FBTyxFQUFFLEdBQUcsU0FBUyxDQUFDLE9BQU8sRUFBRSxDQUFDLEVBQ3RDLENBQUM7WUFDRCxLQUFLLEVBQUUsQ0FBQztRQUNWLENBQUM7UUFDRCxPQUFPLEtBQUssQ0FBQztJQUNmLENBQUM7SUFFRCxLQUFLLENBQUMsbUJBQW1CLENBQUMsTUFBYztRQUN0QyxJQUFJLENBQUM7WUFDSCxNQUFNLFNBQVMsR0FBRyxNQUFNLElBQUksQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDLGlCQUFpQixDQUFDO2dCQUM5RCxLQUFLLEVBQUUsRUFBRSxNQUFNLEVBQUU7Z0JBQ2pCLE9BQU8sRUFBRTtvQkFDUCxJQUFJLEVBQUUsSUFBSTtvQkFDVix1QkFBdUIsRUFBRSxJQUFJO29CQUM3QixVQUFVLEVBQUUsSUFBSTtvQkFDaEIsUUFBUSxFQUFFLElBQUk7b0JB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Q2xCLGdCQUFnQixDQUFDLHFCQUE2QyxJQUFJLEVBQUU7Z0JBQ3ZFLFVBQVUsRUFBRSxnQkFBZ0IsQ0FBQyxVQUFVO2FBQ3hDLENBQUM7UUFDSixDQUFDO1FBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztZQUNmLE9BQU8sQ0FBQyxLQUFLLENBQ1gsbUNBQW1DLEVBQ25DLEtBQUssWUFBWSxLQUFLLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FDL0MsQ0FBQztZQUNGLE1BQU0sSUFBSSxxQ0FBNEIsQ0FDcEMsb0NBQW9DLENBQ3JDLENBQUM7UUFDSixDQUFDO0lBQ0gsQ0FBQztDQUNGLENBQUE7QUF2UVksZ0VBQTBCO3FDQUExQiwwQkFBMEI7SUFEdEMsSUFBQSxtQkFBVSxHQUFFO3FDQUUwQixzQ0FBYTtHQUR2QywwQkFBMEIsQ0F1UXRDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9ob21lL3dldG9vYS9Eb2N1bWVudHMvY29kZS9wcm9qZWN0cy9tZW50YXJhL21lbnRhcmEtYXBpL3NyYy90aGVyYXBpc3QvdGhlcmFwaXN0LW1hbmFnZW1lbnQuc2VydmljZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBJbmplY3RhYmxlLFxuICBOb3RGb3VuZEV4Y2VwdGlvbixcbiAgSW50ZXJuYWxTZXJ2ZXJFcnJvckV4Y2VwdGlvbixcbn0gZnJvbSAnQG5lc3Rqcy9jb21tb24nO1xuaW1wb3J0IHsgUHJpc21hU2VydmljZSB9IGZyb20gJy4uL3Byb3ZpZGVycy9wcmlzbWEtY2xpZW50LnByb3ZpZGVyJztcbmltcG9ydCB7IFByaXNtYSB9IGZyb20gJ0BwcmlzbWEvY2xpZW50JztcbmltcG9ydCB7IERlY2ltYWwgfSBmcm9tICdAcHJpc21hL2NsaWVudC9ydW50aW1lL2xpYnJhcnknO1xuaW1wb3J0IHtcbiAgQ2xpZW50UmVzcG9uc2UsXG4gIFRoZXJhcGlzdFJlc3BvbnNlLFxuICBUaGVyYXBpc3RVcGRhdGVEdG8sXG59IGZyb20gJ3NjaGVtYS9hdXRoJztcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIFRoZXJhcGlzdE1hbmFnZW1lbnRTZXJ2aWNlIHtcbiAgY29uc3RydWN0b3IocHJpdmF0ZSByZWFkb25seSBwcmlzbWE6IFByaXNtYVNlcnZpY2UpIHt9XG5cbiAgcHJpdmF0ZSBjYWxjdWxhdGVZZWFyc09mRXhwZXJpZW5jZShzdGFydERhdGU6IERhdGUpOiBudW1iZXIge1xuICAgIGNvbnN0IG5vdyA9IG5ldyBEYXRlKCk7XG4gICAgbGV0IHllYXJzID0gbm93LmdldEZ1bGxZZWFyKCkgLSBzdGFydERhdGUuZ2V0RnVsbFllYXIoKTtcbiAgICBpZiAoXG4gICAgICBub3cuZ2V0TW9udGgoKSA8IHN0YXJ0RGF0ZS5nZXRNb250aCgpIHx8XG4gICAgICAobm93LmdldE1vbnRoKCkgPT09IHN0YXJ0RGF0ZS5nZXRNb250aCgpICYmXG4gICAgICAgIG5vdy5nZXREYXRlKCkgPCBzdGFydERhdGUuZ2V0RGF0ZSgpKVxuICAgICkge1xuICAgICAgeWVhcnMtLTtcbiAgICB9XG4gICAgcmV0dXJuIHllYXJzO1xuICB9XG5cbiAgYXN5bmMgZ2V0VGhlcmFwaXN0UHJvZmlsZSh1c2VySWQ6IHN0cmluZyk6IFByb21pc2U8VGhlcmFwaXN0UmVzcG9uc2U+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgdGhlcmFwaXN0ID0gYXdhaXQgdGhpcy5wcmlzbWEudGhlcmFwaXN0LmZpbmRVbmlxdWVPclRocm93KHtcbiAgICAgICAgd2hlcmU6IHsgdXNlcklkIH0sXG4gICAgICAgIGluY2x1ZGU6IHtcbiAgICAgICAgICB1c2VyOiB0cnVlLFxuICAgICAgICAgIHRoZXJhcGlzdEF2YWlsYWJpbGl0aWVzOiB0cnVlLFxuICAgICAgICAgIHdvcmtzaGVldHM6IHRydWUsXG4gICAgICAgICAgbWVldGluZ3M6IHRydWUsXG4gICAgICAgICAgYXNzaWduZWRDbGllbnRzOiB0cnVlLFxuICAgICAgICB9LFxuICAgICAgfSk7XG4gICAgICByZXR1cm4ge1xuICAgICAgICAuLi50aGVyYXBpc3QsXG4gICAgICAgIHRyZWF0bWVudFN1Y2Nlc3NSYXRlczpcbiAgICAgICAgICAodGhlcmFwaXN0LnRyZWF0bWVudFN1Y2Nlc3NSYXRlcyBhcyBSZWNvcmQ8c3RyaW5nLCBhbnk+KSB8fCB7fSxcbiAgICAgICAgaG91cmx5UmF0ZTogdGhlcmFwaXN0LmhvdXJseVJhdGUsXG4gICAgICB9O1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBjb25zb2xlLmVycm9yKFxuICAgICAgICAnRXJyb3IgcmV0cmlldmluZyB0aGVyYXBpc3QgcHJvZmlsZTonLFxuICAgICAgICBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6IGVycm9yLFxuICAgICAgKTtcbiAgICAgIHRocm93IG5ldyBJbnRlcm5hbFNlcnZlckVycm9yRXhjZXB0aW9uKFxuICAgICAgICAnRmFpbGVkIHRvIHJldHJpZXZlIHRoZXJhcGlzdCBwcm9maWxlJyxcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgdXBkYXRlVGhlcmFwaXN0UHJvZmlsZShcbiAgICB1c2VySWQ6IHN0cmluZyxcbiAgICBkYXRhOiBUaGVyYXBpc3RVcGRhdGVEdG8sXG4gICk6IFByb21pc2U8VGhlcmFwaXN0UmVzcG9uc2U+IHtcbiAgICB0cnkge1xuICAgICAgLy8gVXBkYXRlIHRoZXJhcGlzdCBwcm9maWxlIGRhdGFcbiAgICAgIGNvbnN0IHRoZXJhcGlzdERhdGE6IGFueSA9IHt9O1xuICAgICAgaWYgKGRhdGEubW9iaWxlICE9PSB1bmRlZmluZWQpIHRoZXJhcGlzdERhdGEubW9iaWxlID0gZGF0YS5tb2JpbGU7XG4gICAgICBpZiAoZGF0YS5wcm92aW5jZSAhPT0gdW5kZWZpbmVkKSB0aGVyYXBpc3REYXRhLnByb3ZpbmNlID0gZGF0YS5wcm92aW5jZTtcbiAgICAgIGlmIChkYXRhLnByb3ZpZGVyVHlwZSAhPT0gdW5kZWZpbmVkKVxuICAgICAgICB0aGVyYXBpc3REYXRhLnByb3ZpZGVyVHlwZSA9IGRhdGEucHJvdmlkZXJUeXBlO1xuICAgICAgaWYgKGRhdGEucHJvZmVzc2lvbmFsTGljZW5zZVR5cGUgIT09IHVuZGVmaW5lZClcbiAgICAgICAgdGhlcmFwaXN0RGF0YS5wcm9mZXNzaW9uYWxMaWNlbnNlVHlwZSA9IGRhdGEucHJvZmVzc2lvbmFsTGljZW5zZVR5cGU7XG4gICAgICBpZiAoZGF0YS5pc1BSQ0xpY2Vuc2VkICE9PSB1bmRlZmluZWQpXG4gICAgICAgIHRoZXJhcGlzdERhdGEuaXNQUkNMaWNlbnNlZCA9IGRhdGEuaXNQUkNMaWNlbnNlZDtcbiAgICAgIGlmIChkYXRhLnByY0xpY2Vuc2VOdW1iZXIgIT09IHVuZGVmaW5lZClcbiAgICAgICAgdGhlcmFwaXN0RGF0YS5wcmNMaWNlbnNlTnVtYmVyID0gZGF0YS5wcmNMaWNlbnNlTnVtYmVyO1xuICAgICAgaWYgKGRhdGEuZXhwaXJhdGlvbkRhdGVPZkxpY2Vuc2UgIT09IHVuZGVmaW5lZClcbiAgICAgICAgdGhlcmFwaXN0RGF0YS5leHBpcmF0aW9uRGF0ZU9mTGljZW5zZSA9IGRhdGEuZXhwaXJhdGlvbkRhdGVPZkxpY2Vuc2U7XG4gICAgICBpZiAoZGF0YS5wcmFjdGljZVN0YXJ0RGF0ZSAhPT0gdW5kZWZpbmVkKVxuICAgICAgICB0aGVyYXBpc3REYXRhLnByYWN0aWNlU3RhcnREYXRlID0gZGF0YS5wcmFjdGljZVN0YXJ0RGF0ZTtcbiAgICAgIGlmIChkYXRhLmFyZWFzT2ZFeHBlcnRpc2UgIT09IHVuZGVmaW5lZClcbiAgICAgICAgdGhlcmFwaXN0RGF0YS5hcmVhc09mRXhwZXJ0aXNlID0gZGF0YS5hcmVhc09mRXhwZXJ0aXNlO1xuICAgICAgaWYgKGRhdGEuYXNzZXNzbWVudFRvb2xzICE9PSB1bmRlZmluZWQpXG4gICAgICAgIHRoZXJhcGlzdERhdGEuYXNzZXNzbWVudFRvb2xzID0gZGF0YS5hc3Nlc3NtZW50VG9vbHM7XG4gICAgICBpZiAoZGF0YS50aGVyYXBldXRpY0FwcHJvYWNoZXNVc2VkTGlzdCAhPT0gdW5kZWZpbmVkKVxuICAgICAgICB0aGVyYXBpc3REYXRhLnRoZXJhcGV1dGljQXBwcm9hY2hlc1VzZWRMaXN0ID1cbiAgICAgICAgICBkYXRhLnRoZXJhcGV1dGljQXBwcm9hY2hlc1VzZWRMaXN0O1xuICAgICAgaWYgKGRhdGEubGFuZ3VhZ2VzT2ZmZXJlZCAhPT0gdW5kZWZpbmVkKVxuICAgICAgICB0aGVyYXBpc3REYXRhLmxhbmd1YWdlc09mZmVyZWQgPSBkYXRhLmxhbmd1YWdlc09mZmVyZWQ7XG4gICAgICBpZiAoZGF0YS5wcm92aWRlZE9ubGluZVRoZXJhcHlCZWZvcmUgIT09IHVuZGVmaW5lZClcbiAgICAgICAgdGhlcmFwaXN0RGF0YS5wcm92aWRlZE9ubGluZVRoZXJhcHlCZWZvcmUgPVxuICAgICAgICAgIGRhdGEucHJvdmlkZWRPbmxpbmVUaGVyYXB5QmVmb3JlO1xuICAgICAgaWYgKGRhdGEuY29tZm9ydGFibGVVc2luZ1ZpZGVvQ29uZmVyZW5jaW5nICE9PSB1bmRlZmluZWQpXG4gICAgICAgIHRoZXJhcGlzdERhdGEuY29tZm9ydGFibGVVc2luZ1ZpZGVvQ29uZmVyZW5jaW5nID1cbiAgICAgICAgICBkYXRhLmNvbWZvcnRhYmxlVXNpbmdWaWRlb0NvbmZlcmVuY2luZztcbiAgICAgIGlmIChkYXRhLnByZWZlcnJlZFNlc3Npb25MZW5ndGggIT09IHVuZGVmaW5lZClcbiAgICAgICAgdGhlcmFwaXN0RGF0YS5wcmVmZXJyZWRTZXNzaW9uTGVuZ3RoID0gZGF0YS5wcmVmZXJyZWRTZXNzaW9uTGVuZ3RoO1xuICAgICAgaWYgKGRhdGEucHJpdmF0ZUNvbmZpZGVudGlhbFNwYWNlICE9PSB1bmRlZmluZWQpXG4gICAgICAgIHRoZXJhcGlzdERhdGEucHJpdmF0ZUNvbmZpZGVudGlhbFNwYWNlID0gZGF0YS5wcml2YXRlQ29uZmlkZW50aWFsU3BhY2U7XG4gICAgICBpZiAoZGF0YS5jb21wbGllc1dpdGhEYXRhUHJpdmFjeUFjdCAhPT0gdW5kZWZpbmVkKVxuICAgICAgICB0aGVyYXBpc3REYXRhLmNvbXBsaWVzV2l0aERhdGFQcml2YWN5QWN0ID1cbiAgICAgICAgICBkYXRhLmNvbXBsaWVzV2l0aERhdGFQcml2YWN5QWN0O1xuICAgICAgaWYgKGRhdGEucHJvZmVzc2lvbmFsTGlhYmlsaXR5SW5zdXJhbmNlICE9PSB1bmRlZmluZWQpXG4gICAgICAgIHRoZXJhcGlzdERhdGEucHJvZmVzc2lvbmFsTGlhYmlsaXR5SW5zdXJhbmNlID1cbiAgICAgICAgICBkYXRhLnByb2Zlc3Npb25hbExpYWJpbGl0eUluc3VyYW5jZTtcbiAgICAgIGlmIChkYXRhLmNvbXBsYWludHNPckRpc2NpcGxpbmFyeUFjdGlvbnMgIT09IHVuZGVmaW5lZClcbiAgICAgICAgdGhlcmFwaXN0RGF0YS5jb21wbGFpbnRzT3JEaXNjaXBsaW5hcnlBY3Rpb25zID1cbiAgICAgICAgICBkYXRhLmNvbXBsYWludHNPckRpc2NpcGxpbmFyeUFjdGlvbnM7XG4gICAgICBpZiAoZGF0YS53aWxsaW5nVG9BYmlkZUJ5UGxhdGZvcm1HdWlkZWxpbmVzICE9PSB1bmRlZmluZWQpXG4gICAgICAgIHRoZXJhcGlzdERhdGEud2lsbGluZ1RvQWJpZGVCeVBsYXRmb3JtR3VpZGVsaW5lcyA9XG4gICAgICAgICAgZGF0YS53aWxsaW5nVG9BYmlkZUJ5UGxhdGZvcm1HdWlkZWxpbmVzO1xuICAgICAgaWYgKGRhdGEuZXhwZXJ0aXNlICE9PSB1bmRlZmluZWQpXG4gICAgICAgIHRoZXJhcGlzdERhdGEuZXhwZXJ0aXNlID0gZGF0YS5leHBlcnRpc2U7XG4gICAgICBpZiAoZGF0YS5hcHByb2FjaGVzICE9PSB1bmRlZmluZWQpXG4gICAgICAgIHRoZXJhcGlzdERhdGEuYXBwcm9hY2hlcyA9IGRhdGEuYXBwcm9hY2hlcztcbiAgICAgIGlmIChkYXRhLmxhbmd1YWdlcyAhPT0gdW5kZWZpbmVkKVxuICAgICAgICB0aGVyYXBpc3REYXRhLmxhbmd1YWdlcyA9IGRhdGEubGFuZ3VhZ2VzO1xuICAgICAgaWYgKGRhdGEuaWxsbmVzc1NwZWNpYWxpemF0aW9ucyAhPT0gdW5kZWZpbmVkKVxuICAgICAgICB0aGVyYXBpc3REYXRhLmlsbG5lc3NTcGVjaWFsaXphdGlvbnMgPSBkYXRhLmlsbG5lc3NTcGVjaWFsaXphdGlvbnM7XG4gICAgICBpZiAoZGF0YS5hY2NlcHRUeXBlcyAhPT0gdW5kZWZpbmVkKVxuICAgICAgICB0aGVyYXBpc3REYXRhLmFjY2VwdFR5cGVzID0gZGF0YS5hY2NlcHRUeXBlcztcbiAgICAgIGlmIChkYXRhLnRyZWF0bWVudFN1Y2Nlc3NSYXRlcyAhPT0gdW5kZWZpbmVkKVxuICAgICAgICB0aGVyYXBpc3REYXRhLnRyZWF0bWVudFN1Y2Nlc3NSYXRlcyA9IGRhdGEudHJlYXRtZW50U3VjY2Vzc1JhdGVzO1xuICAgICAgaWYgKGRhdGEuc2Vzc2lvbkxlbmd0aCAhPT0gdW5kZWZpbmVkKVxuICAgICAgICB0aGVyYXBpc3REYXRhLnNlc3Npb25MZW5ndGggPSBkYXRhLnNlc3Npb25MZW5ndGg7XG4gICAgICBpZiAoZGF0YS5ob3VybHlSYXRlICE9PSB1bmRlZmluZWQpXG4gICAgICAgIHRoZXJhcGlzdERhdGEuaG91cmx5UmF0ZSA9IG5ldyBEZWNpbWFsKGRhdGEuaG91cmx5UmF0ZSk7XG5cbiAgICAgIGNvbnN0IHVwZGF0ZWRUaGVyYXBpc3QgPSBhd2FpdCB0aGlzLnByaXNtYS50aGVyYXBpc3QudXBkYXRlKHtcbiAgICAgICAgd2hlcmU6IHsgdXNlcklkIH0sXG4gICAgICAgIGRhdGE6IHRoZXJhcGlzdERhdGEsXG4gICAgICAgIGluY2x1ZGU6IHtcbiAgICAgICAgICB1c2VyOiB0cnVlLFxuICAgICAgICB9LFxuICAgICAgfSk7XG4gICAgICByZXR1cm4ge1xuICAgICAgICAuLi51cGRhdGVkVGhlcmFwaXN0LFxuICAgICAgICB0cmVhdG1lbnRTdWNjZXNzUmF0ZXM6XG4gICAgICAgICAgKHVwZGF0ZWRUaGVyYXBpc3QudHJlYXRtZW50U3VjY2Vzc1JhdGVzIGFzIFJlY29yZDxzdHJpbmcsIGFueT4pIHx8IHt9LFxuICAgICAgICBob3VybHlSYXRlOiB1cGRhdGVkVGhlcmFwaXN0LmhvdXJseVJhdGUsXG4gICAgICB9O1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBjb25zb2xlLmVycm9yKFxuICAgICAgICAnRXJyb3IgdXBkYXRpbmcgdGhlcmFwaXN0IHByb2ZpbGU6JyxcbiAgICAgICAgZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiBlcnJvcixcbiAgICAgICk7XG4gICAgICB0aHJvdyBuZXcgSW50ZXJuYWxTZXJ2ZXJFcnJvckV4Y2VwdGlvbihcbiAgICAgICAgJ0ZhaWxlZCB0byB1cGRhdGUgdGhlcmFwaXN0IHByb2ZpbGUnLFxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBnZXRBc3NpZ25lZFBhdGllbnRzKHRoZXJhcGlzdElkOiBzdHJpbmcpOiBQcm9taXNlPENsaWVudFJlc3BvbnNlW10+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgdGhlcmFwaXN0ID0gYXdhaXQgdGhpcy5wcmlzbWEudGhlcmFwaXN0LmZpbmRVbmlxdWVPclRocm93KHtcbiAgICAgICAgd2hlcmU6IHsgdXNlcklkOiB0aGVyYXBpc3RJZCB9LFxuICAgICAgfSk7XG5cbiAgICAgIC8vIEZpbmQgYWxsIGNsaWVudHMgYXNzaWduZWQgdG8gdGhpcyB0aGVyYXBpc3RcbiAgICAgIGNvbnN0IGFzc2lnbmVkQ2xpZW50cyA9IGF3YWl0IHRoaXMucHJpc21hLmNsaWVudFRoZXJhcGlzdC5maW5kTWFueSh7XG4gICAgICAgIHdoZXJlOiB7IHRoZXJhcGlzdElkOiB0aGVyYXBpc3QudXNlcklkLCBzdGF0dXM6ICdhY3RpdmUnIH0sXG4gICAgICAgIGluY2x1ZGU6IHsgY2xpZW50OiB7IGluY2x1ZGU6IHsgdXNlcjogdHJ1ZSB9IH0gfSxcbiAgICAgIH0pO1xuXG4gICAgICByZXR1cm4gYXNzaWduZWRDbGllbnRzLm1hcCgoY3QpID0+ICh7XG4gICAgICAgIC4uLmN0LmNsaWVudCxcbiAgICAgICAgdXNlcjogY3QuY2xpZW50LnVzZXIsXG4gICAgICB9KSk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoXG4gICAgICAgICdFcnJvciByZXRyaWV2aW5nIGFzc2lnbmVkIHBhdGllbnRzOicsXG4gICAgICAgIGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogZXJyb3IsXG4gICAgICApO1xuXG4gICAgICB0aHJvdyBuZXcgSW50ZXJuYWxTZXJ2ZXJFcnJvckV4Y2VwdGlvbihcbiAgICAgICAgJ0ZhaWxlZCB0byByZXRyaWV2ZSBhc3NpZ25lZCBwYXRpZW50cycsXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGdldEFsbENsaWVudHModGhlcmFwaXN0SWQ6IHN0cmluZyk6IFByb21pc2U8Q2xpZW50UmVzcG9uc2VbXT4ge1xuICAgIHRyeSB7XG4gICAgICAvLyBGaW5kIGFsbCBjbGllbnRzIGFzc2lnbmVkIHRvIHRoaXMgdGhlcmFwaXN0XG4gICAgICBjb25zdCBhc3NpZ25lZENsaWVudHMgPSBhd2FpdCB0aGlzLnByaXNtYS5jbGllbnRUaGVyYXBpc3QuZmluZE1hbnkoe1xuICAgICAgICB3aGVyZTogeyB0aGVyYXBpc3RJZDogdGhlcmFwaXN0SWQsIHN0YXR1czogJ2FjdGl2ZScgfSxcbiAgICAgICAgaW5jbHVkZTogeyBjbGllbnQ6IHsgaW5jbHVkZTogeyB1c2VyOiB0cnVlIH0gfSB9LFxuICAgICAgfSk7XG5cbiAgICAgIHJldHVybiBhc3NpZ25lZENsaWVudHMubWFwKChjdCkgPT4gKHtcbiAgICAgICAgLi4uY3QuY2xpZW50LFxuICAgICAgfSkpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBjb25zb2xlLmVycm9yKFxuICAgICAgICAnRXJyb3IgcmV0cmlldmluZyBhbGwgY2xpZW50czonLFxuICAgICAgICBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6IGVycm9yLFxuICAgICAgKTtcbiAgICAgIHRocm93IG5ldyBJbnRlcm5hbFNlcnZlckVycm9yRXhjZXB0aW9uKCdGYWlsZWQgdG8gcmV0cmlldmUgYWxsIGNsaWVudHMnKTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBnZXRDbGllbnRCeUlkKFxuICAgIHRoZXJhcGlzdElkOiBzdHJpbmcsXG4gICAgY2xpZW50SWQ6IHN0cmluZyxcbiAgKTogUHJvbWlzZTxDbGllbnRSZXNwb25zZT4ge1xuICAgIHRyeSB7XG4gICAgICAvLyBGaW5kIHRoZSBzcGVjaWZpYyBjbGllbnQgYXNzaWduZWQgdG8gdGhpcyB0aGVyYXBpc3RcbiAgICAgIGNvbnN0IGFzc2lnbmVkQ2xpZW50ID0gYXdhaXQgdGhpcy5wcmlzbWEuY2xpZW50VGhlcmFwaXN0LmZpbmRGaXJzdCh7XG4gICAgICAgIHdoZXJlOiB7IHRoZXJhcGlzdElkOiB0aGVyYXBpc3RJZCwgY2xpZW50SWQ6IGNsaWVudElkIH0sXG4gICAgICAgIGluY2x1ZGU6IHsgY2xpZW50OiB7IGluY2x1ZGU6IHsgdXNlcjogdHJ1ZSB9IH0gfSxcbiAgICAgIH0pO1xuICAgICAgaWYgKCFhc3NpZ25lZENsaWVudCkge1xuICAgICAgICB0aHJvdyBuZXcgTm90Rm91bmRFeGNlcHRpb24oJ0NsaWVudCBub3QgZm91bmQnKTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIGFzc2lnbmVkQ2xpZW50LmNsaWVudDtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc29sZS5lcnJvcihcbiAgICAgICAgJ0Vycm9yIHJldHJpZXZpbmcgY2xpZW50IGJ5IElEOicsXG4gICAgICAgIGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogZXJyb3IsXG4gICAgICApO1xuICAgICAgdGhyb3cgbmV3IEludGVybmFsU2VydmVyRXJyb3JFeGNlcHRpb24oJ0ZhaWxlZCB0byByZXRyaWV2ZSBjbGllbnQgYnkgSUQnKTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBnZXRQcm9maWxlKHRoZXJhcGlzdElkOiBzdHJpbmcpOiBQcm9taXNlPFRoZXJhcGlzdFJlc3BvbnNlPiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHRoZXJhcGlzdCA9IGF3YWl0IHRoaXMucHJpc21hLnRoZXJhcGlzdC5maW5kVW5pcXVlT3JUaHJvdyh7XG4gICAgICAgIHdoZXJlOiB7IHVzZXJJZDogdGhlcmFwaXN0SWQgfSxcbiAgICAgICAgaW5jbHVkZToge1xuICAgICAgICAgIHVzZXI6IHRydWUsXG4gICAgICAgIH0sXG4gICAgICB9KTtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIC4uLnRoZXJhcGlzdCxcbiAgICAgICAgdHJlYXRtZW50U3VjY2Vzc1JhdGVzOlxuICAgICAgICAgICh0aGVyYXBpc3QudHJlYXRtZW50U3VjY2Vzc1JhdGVzIGFzIFJlY29yZDxzdHJpbmcsIGFueT4pIHx8IHt9LFxuICAgICAgICBob3VybHlSYXRlOiB0aGVyYXBpc3QuaG91cmx5UmF0ZSxcbiAgICAgIH07XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoXG4gICAgICAgICdFcnJvciByZXRyaWV2aW5nIHRoZXJhcGlzdCBwcm9maWxlOicsXG4gICAgICAgIGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogZXJyb3IsXG4gICAgICApO1xuICAgICAgdGhyb3cgbmV3IEludGVybmFsU2VydmVyRXJyb3JFeGNlcHRpb24oXG4gICAgICAgICdGYWlsZWQgdG8gcmV0cmlldmUgdGhlcmFwaXN0IHByb2ZpbGUnLFxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICBhc3luYyB1cGRhdGVQcm9maWxlKFxuICAgIHRoZXJhcGlzdElkOiBzdHJpbmcsXG4gICAgZGF0YTogUHJpc21hLlRoZXJhcGlzdFVwZGF0ZUlucHV0LFxuICApOiBQcm9taXNlPFRoZXJhcGlzdFJlc3BvbnNlPiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHVwZGF0ZWRUaGVyYXBpc3QgPSBhd2FpdCB0aGlzLnByaXNtYS50aGVyYXBpc3QudXBkYXRlKHtcbiAgICAgICAgd2hlcmU6IHsgdXNlcklkOiB0aGVyYXBpc3RJZCB9LFxuICAgICAgICBkYXRhLFxuICAgICAgICBpbmNsdWRlOiB7XG4gICAgICAgICAgdXNlcjogdHJ1ZSxcbiAgICAgICAgfSxcbiAgICAgIH0pO1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgLi4udXBkYXRlZFRoZXJhcGlzdCxcbiAgICAgICAgdHJlYXRtZW50U3VjY2Vzc1JhdGVzOlxuICAgICAgICAgICh1cGRhdGVkVGhlcmFwaXN0LnRyZWF0bWVudFN1Y2Nlc3NSYXRlcyBhcyBSZWNvcmQ8c3RyaW5nLCBhbnk+KSB8fCB7fSxcbiAgICAgICAgaG91cmx5UmF0ZTogdXBkYXRlZFRoZXJhcGlzdC5ob3VybHlSYXRlLFxuICAgICAgfTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc29sZS5lcnJvcihcbiAgICAgICAgJ0Vycm9yIHVwZGF0aW5nIHRoZXJhcGlzdCBwcm9maWxlOicsXG4gICAgICAgIGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogZXJyb3IsXG4gICAgICApO1xuICAgICAgdGhyb3cgbmV3IEludGVybmFsU2VydmVyRXJyb3JFeGNlcHRpb24oXG4gICAgICAgICdGYWlsZWQgdG8gdXBkYXRlIHRoZXJhcGlzdCBwcm9maWxlJyxcbiAgICAgICk7XG4gICAgfVxuICB9XG59XG4iXSwidmVyc2lvbiI6M30=