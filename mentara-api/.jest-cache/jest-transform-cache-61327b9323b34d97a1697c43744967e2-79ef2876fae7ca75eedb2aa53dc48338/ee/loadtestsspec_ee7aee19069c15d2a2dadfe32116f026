f37e46392a2941d6f61de02862e5c235
"use strict";
/**
 * Load Testing Specification
 *
 * Integration tests for API performance under various load conditions
 */
Object.defineProperty(exports, "__esModule", { value: true });
const testing_1 = require("@nestjs/testing");
const app_module_1 = require("../../app.module");
const prisma_service_1 = require("../../database/prisma.service");
const load_testing_suite_1 = require("./load-testing.suite");
const index_1 = require("../index");
const fs = require("fs");
const path = require("path");
describe('API Load Testing', () => {
    let app;
    let prisma;
    let loadTestSuite;
    beforeAll(async () => {
        const moduleFixture = await testing_1.Test.createTestingModule({
            imports: [app_module_1.AppModule],
        })
            .overrideProvider('ClerkClient')
            .useValue((0, index_1.createMockClerkClient)())
            .overrideGuard('AuthGuard')
            .useValue((0, index_1.createMockAuthGuard)())
            .compile();
        app = moduleFixture.createNestApplication();
        prisma = app.get(prisma_service_1.PrismaService);
        await app.init();
        loadTestSuite = new load_testing_suite_1.LoadTestingSuite(app);
    });
    afterAll(async () => {
        await prisma.$disconnect();
        await app.close();
    });
    beforeEach(async () => {
        // Clean database before each test
        await prisma.$transaction([
            prisma.preAssessment.deleteMany(),
            prisma.client.deleteMany(),
            prisma.therapist.deleteMany(),
            prisma.user.deleteMany(),
        ]);
    });
    describe('Critical Endpoint Performance', () => {
        it('should handle light load (10 concurrent users)', async () => {
            const config = {
                concurrentUsers: 10,
                requestsPerUser: 10,
                rampUpTime: 5,
                testDuration: 30,
            };
            console.log('ðŸ”¥ Starting light load test...');
            const results = await loadTestSuite.runFullLoadTestSuite();
            // Assertions for light load
            results.forEach((result) => {
                expect(result.successfulRequests).toBeGreaterThan(0);
                expect(result.errorRate).toBeLessThan(10); // Allow up to 10% error rate for light load
                expect(result.averageResponseTime).toBeLessThan(5000); // 5 seconds max
            });
            // Generate and save report
            const report = loadTestSuite.generatePerformanceReport();
            await saveTestReport('light-load-test-report.json', report);
        }, 120000); // 2 minute timeout
        it('should handle medium load (25 concurrent users)', async () => {
            const config = {
                concurrentUsers: 25,
                requestsPerUser: 15,
                rampUpTime: 10,
                testDuration: 60,
            };
            console.log('ðŸ”¥ Starting medium load test...');
            const results = await loadTestSuite.runFullLoadTestSuite();
            // Assertions for medium load
            results.forEach((result) => {
                expect(result.successfulRequests).toBeGreaterThan(0);
                expect(result.errorRate).toBeLessThan(15); // Allow up to 15% error rate for medium load
                expect(result.averageResponseTime).toBeLessThan(10000); // 10 seconds max
            });
            const report = loadTestSuite.generatePerformanceReport();
            await saveTestReport('medium-load-test-report.json', report);
        }, 180000); // 3 minute timeout
        it('should maintain basic functionality under heavy load (50 concurrent users)', async () => {
            const config = {
                concurrentUsers: 50,
                requestsPerUser: 20,
                rampUpTime: 15,
                testDuration: 120,
            };
            console.log('ðŸ”¥ Starting heavy load test...');
            const results = await loadTestSuite.runFullLoadTestSuite();
            // More lenient assertions for heavy load
            results.forEach((result) => {
                // At minimum, some requests should succeed
                expect(result.successfulRequests).toBeGreaterThan(result.totalRequests * 0.5); // At least 50% success
                expect(result.errorRate).toBeLessThan(50); // Allow up to 50% error rate for heavy load
                expect(result.averageResponseTime).toBeLessThan(30000); // 30 seconds max
            });
            const report = loadTestSuite.generatePerformanceReport();
            await saveTestReport('heavy-load-test-report.json', report);
        }, 300000); // 5 minute timeout
    });
    describe('Endpoint-Specific Load Tests', () => {
        it('should test authentication endpoints under load', async () => {
            // Focused test on auth endpoints which are critical
            const authEndpoints = [
                { path: '/auth/me', method: 'GET', requiresAuth: true },
                { path: '/auth/register/client', method: 'POST', requiresAuth: false },
            ];
            console.log('ðŸ” Testing authentication endpoints...');
            // Test each endpoint individually with higher load
            for (const endpoint of authEndpoints) {
                console.log(`Testing ${endpoint.method} ${endpoint.path}...`);
                // Custom load test for this specific endpoint
                const result = await loadTestSuite['testEndpointLoad'](endpoint, {
                    concurrentUsers: 30,
                    requestsPerUser: 25,
                    rampUpTime: 10,
                    testDuration: 60,
                });
                // Auth endpoints should be highly reliable
                expect(result.errorRate).toBeLessThan(5);
                expect(result.averageResponseTime).toBeLessThan(2000);
                expect(result.requestsPerSecond).toBeGreaterThan(10);
            }
        }, 180000);
        it('should test real-time messaging endpoints', async () => {
            const messagingEndpoints = [
                { path: '/messaging/conversations', method: 'GET', requiresAuth: true },
                {
                    path: '/messaging/conversations',
                    method: 'POST',
                    requiresAuth: true,
                },
            ];
            console.log('ðŸ’¬ Testing messaging endpoints...');
            for (const endpoint of messagingEndpoints) {
                const result = await loadTestSuite['testEndpointLoad'](endpoint, {
                    concurrentUsers: 40,
                    requestsPerUser: 30,
                    rampUpTime: 12,
                    testDuration: 90,
                });
                // Messaging should be responsive for real-time feel
                expect(result.averageResponseTime).toBeLessThan(1500);
                expect(result.errorRate).toBeLessThan(8);
            }
        }, 200000);
        it('should test booking system under peak load', async () => {
            const bookingEndpoints = [
                { path: '/booking/meetings', method: 'GET', requiresAuth: true },
                { path: '/booking/availability', method: 'GET', requiresAuth: true },
            ];
            console.log('ðŸ“… Testing booking endpoints...');
            for (const endpoint of bookingEndpoints) {
                const result = await loadTestSuite['testEndpointLoad'](endpoint, {
                    concurrentUsers: 35,
                    requestsPerUser: 20,
                    rampUpTime: 8,
                    testDuration: 60,
                });
                // Booking system is business critical
                expect(result.errorRate).toBeLessThan(3);
                expect(result.averageResponseTime).toBeLessThan(3000);
                expect(result.memoryGrowth).toBeLessThan(30); // MB
            }
        }, 150000);
    });
    describe('Memory and Resource Management', () => {
        it('should not have significant memory leaks under sustained load', async () => {
            console.log('ðŸ§  Testing memory management...');
            const initialMemory = process.memoryUsage().heapUsed / 1024 / 1024;
            // Run multiple cycles of load tests
            for (let cycle = 0; cycle < 3; cycle++) {
                console.log(`Memory test cycle ${cycle + 1}/3...`);
                await loadTestSuite['testEndpointLoad']({ path: '/dashboard/user', method: 'GET', requiresAuth: true }, {
                    concurrentUsers: 20,
                    requestsPerUser: 15,
                    rampUpTime: 5,
                    testDuration: 30,
                });
                // Force garbage collection if available
                if (global.gc) {
                    global.gc();
                }
                await new Promise((resolve) => setTimeout(resolve, 1000)); // Brief pause
            }
            const finalMemory = process.memoryUsage().heapUsed / 1024 / 1024;
            const memoryGrowth = finalMemory - initialMemory;
            console.log(`Memory growth: ${memoryGrowth.toFixed(2)}MB`);
            // Memory should not grow excessively
            expect(memoryGrowth).toBeLessThan(100); // Less than 100MB growth
        }, 180000);
        it('should handle concurrent database operations efficiently', async () => {
            console.log('ðŸ—„ï¸ Testing database performance...');
            // Test endpoints that involve complex database operations
            const dbIntensiveEndpoints = [
                { path: '/search/therapists', method: 'GET', requiresAuth: true },
                { path: '/communities', method: 'GET', requiresAuth: true },
                { path: '/posts', method: 'GET', requiresAuth: true },
            ];
            for (const endpoint of dbIntensiveEndpoints) {
                const result = await loadTestSuite['testEndpointLoad'](endpoint, {
                    concurrentUsers: 25,
                    requestsPerUser: 10,
                    rampUpTime: 8,
                    testDuration: 45,
                });
                // Database operations should be reasonably fast
                expect(result.averageResponseTime).toBeLessThan(5000);
                expect(result.errorRate).toBeLessThan(10);
                console.log(`${endpoint.path}: ${result.averageResponseTime.toFixed(2)}ms avg, ${result.errorRate.toFixed(2)}% errors`);
            }
        }, 200000);
    });
    describe('Edge Cases and Stress Testing', () => {
        it('should gracefully handle request spikes', async () => {
            console.log('âš¡ Testing request spike handling...');
            // Simulate sudden traffic spike
            const spikeResult = await loadTestSuite['testEndpointLoad']({ path: '/auth/me', method: 'GET', requiresAuth: true }, {
                concurrentUsers: 100, // Sudden spike
                requestsPerUser: 5,
                rampUpTime: 2, // Very fast ramp up
                testDuration: 15,
            });
            // System should handle spikes without complete failure
            expect(spikeResult.successfulRequests).toBeGreaterThan(0);
            expect(spikeResult.errorRate).toBeLessThan(80); // Allow high error rate but not complete failure
            console.log(`Spike test: ${spikeResult.successfulRequests}/${spikeResult.totalRequests} successful`);
        }, 120000);
        it('should handle mixed endpoint load patterns', async () => {
            console.log('ðŸ”€ Testing mixed load patterns...');
            // Test multiple endpoints simultaneously (more realistic scenario)
            const mixedEndpoints = [
                { path: '/auth/me', method: 'GET', requiresAuth: true },
                { path: '/dashboard/user', method: 'GET', requiresAuth: true },
                {
                    path: '/notifications/unread-count',
                    method: 'GET',
                    requiresAuth: true,
                },
                { path: '/messaging/conversations', method: 'GET', requiresAuth: true },
            ];
            const promises = mixedEndpoints.map((endpoint) => loadTestSuite['testEndpointLoad'](endpoint, {
                concurrentUsers: 15,
                requestsPerUser: 12,
                rampUpTime: 6,
                testDuration: 40,
            }));
            const results = await Promise.all(promises);
            // All endpoints should maintain reasonable performance
            results.forEach((result, index) => {
                expect(result.errorRate).toBeLessThan(15);
                expect(result.averageResponseTime).toBeLessThan(8000);
                console.log(`${mixedEndpoints[index].path}: ${result.averageResponseTime.toFixed(2)}ms avg`);
            });
        }, 180000);
    });
});
// Helper function to save test reports
async function saveTestReport(filename, report) {
    const reportsDir = path.join(__dirname, '../../../test-reports/performance');
    // Create directory if it doesn't exist
    await fs.promises.mkdir(reportsDir, { recursive: true });
    const filePath = path.join(reportsDir, filename);
    await fs.promises.writeFile(filePath, report, 'utf8');
    console.log(`ðŸ“Š Performance report saved to: ${filePath}`);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL3Rlc3QtdXRpbHMvcGVyZm9ybWFuY2UvbG9hZC10ZXN0cy5zcGVjLnRzIiwibWFwcGluZ3MiOiI7QUFBQTs7OztHQUlHOztBQUVILDZDQUFzRDtBQUV0RCxpREFBNkM7QUFDN0Msa0VBQThEO0FBQzlELDZEQUF3RDtBQUN4RCxvQ0FBc0U7QUFDdEUseUJBQXlCO0FBQ3pCLDZCQUE2QjtBQUU3QixRQUFRLENBQUMsa0JBQWtCLEVBQUUsR0FBRyxFQUFFO0lBQ2hDLElBQUksR0FBcUIsQ0FBQztJQUMxQixJQUFJLE1BQXFCLENBQUM7SUFDMUIsSUFBSSxhQUErQixDQUFDO0lBRXBDLFNBQVMsQ0FBQyxLQUFLLElBQUksRUFBRTtRQUNuQixNQUFNLGFBQWEsR0FBa0IsTUFBTSxjQUFJLENBQUMsbUJBQW1CLENBQUM7WUFDbEUsT0FBTyxFQUFFLENBQUMsc0JBQVMsQ0FBQztTQUNyQixDQUFDO2FBQ0MsZ0JBQWdCLENBQUMsYUFBYSxDQUFDO2FBQy9CLFFBQVEsQ0FBQyxJQUFBLDZCQUFxQixHQUFFLENBQUM7YUFDakMsYUFBYSxDQUFDLFdBQVcsQ0FBQzthQUMxQixRQUFRLENBQUMsSUFBQSwyQkFBbUIsR0FBRSxDQUFDO2FBQy9CLE9BQU8sRUFBRSxDQUFDO1FBRWIsR0FBRyxHQUFHLGFBQWEsQ0FBQyxxQkFBcUIsRUFBRSxDQUFDO1FBQzVDLE1BQU0sR0FBRyxHQUFHLENBQUMsR0FBRyxDQUFnQiw4QkFBYSxDQUFDLENBQUM7UUFFL0MsTUFBTSxHQUFHLENBQUMsSUFBSSxFQUFFLENBQUM7UUFFakIsYUFBYSxHQUFHLElBQUkscUNBQWdCLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDNUMsQ0FBQyxDQUFDLENBQUM7SUFFSCxRQUFRLENBQUMsS0FBSyxJQUFJLEVBQUU7UUFDbEIsTUFBTSxNQUFNLENBQUMsV0FBVyxFQUFFLENBQUM7UUFDM0IsTUFBTSxHQUFHLENBQUMsS0FBSyxF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RyxDQUFDLG1DQUFtQyxRQUFRLEVBQUUsQ0FBQyxDQUFDO0FBQzdELENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL3Rlc3QtdXRpbHMvcGVyZm9ybWFuY2UvbG9hZC10ZXN0cy5zcGVjLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogTG9hZCBUZXN0aW5nIFNwZWNpZmljYXRpb25cbiAqXG4gKiBJbnRlZ3JhdGlvbiB0ZXN0cyBmb3IgQVBJIHBlcmZvcm1hbmNlIHVuZGVyIHZhcmlvdXMgbG9hZCBjb25kaXRpb25zXG4gKi9cblxuaW1wb3J0IHsgVGVzdCwgVGVzdGluZ01vZHVsZSB9IGZyb20gJ0BuZXN0anMvdGVzdGluZyc7XG5pbXBvcnQgeyBJTmVzdEFwcGxpY2F0aW9uIH0gZnJvbSAnQG5lc3Rqcy9jb21tb24nO1xuaW1wb3J0IHsgQXBwTW9kdWxlIH0gZnJvbSAnLi4vLi4vYXBwLm1vZHVsZSc7XG5pbXBvcnQgeyBQcmlzbWFTZXJ2aWNlIH0gZnJvbSAnLi4vLi4vZGF0YWJhc2UvcHJpc21hLnNlcnZpY2UnO1xuaW1wb3J0IHsgTG9hZFRlc3RpbmdTdWl0ZSB9IGZyb20gJy4vbG9hZC10ZXN0aW5nLnN1aXRlJztcbmltcG9ydCB7IGNyZWF0ZU1vY2tDbGVya0NsaWVudCwgY3JlYXRlTW9ja0F1dGhHdWFyZCB9IGZyb20gJy4uL2luZGV4JztcbmltcG9ydCAqIGFzIGZzIGZyb20gJ2ZzJztcbmltcG9ydCAqIGFzIHBhdGggZnJvbSAncGF0aCc7XG5cbmRlc2NyaWJlKCdBUEkgTG9hZCBUZXN0aW5nJywgKCkgPT4ge1xuICBsZXQgYXBwOiBJTmVzdEFwcGxpY2F0aW9uO1xuICBsZXQgcHJpc21hOiBQcmlzbWFTZXJ2aWNlO1xuICBsZXQgbG9hZFRlc3RTdWl0ZTogTG9hZFRlc3RpbmdTdWl0ZTtcblxuICBiZWZvcmVBbGwoYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IG1vZHVsZUZpeHR1cmU6IFRlc3RpbmdNb2R1bGUgPSBhd2FpdCBUZXN0LmNyZWF0ZVRlc3RpbmdNb2R1bGUoe1xuICAgICAgaW1wb3J0czogW0FwcE1vZHVsZV0sXG4gICAgfSlcbiAgICAgIC5vdmVycmlkZVByb3ZpZGVyKCdDbGVya0NsaWVudCcpXG4gICAgICAudXNlVmFsdWUoY3JlYXRlTW9ja0NsZXJrQ2xpZW50KCkpXG4gICAgICAub3ZlcnJpZGVHdWFyZCgnQXV0aEd1YXJkJylcbiAgICAgIC51c2VWYWx1ZShjcmVhdGVNb2NrQXV0aEd1YXJkKCkpXG4gICAgICAuY29tcGlsZSgpO1xuXG4gICAgYXBwID0gbW9kdWxlRml4dHVyZS5jcmVhdGVOZXN0QXBwbGljYXRpb24oKTtcbiAgICBwcmlzbWEgPSBhcHAuZ2V0PFByaXNtYVNlcnZpY2U+KFByaXNtYVNlcnZpY2UpO1xuXG4gICAgYXdhaXQgYXBwLmluaXQoKTtcblxuICAgIGxvYWRUZXN0U3VpdGUgPSBuZXcgTG9hZFRlc3RpbmdTdWl0ZShhcHApO1xuICB9KTtcblxuICBhZnRlckFsbChhc3luYyAoKSA9PiB7XG4gICAgYXdhaXQgcHJpc21hLiRkaXNjb25uZWN0KCk7XG4gICAgYXdhaXQgYXBwLmNsb3NlKCk7XG4gIH0pO1xuXG4gIGJlZm9yZUVhY2goYXN5bmMgKCkgPT4ge1xuICAgIC8vIENsZWFuIGRhdGFiYXNlIGJlZm9yZSBlYWNoIHRlc3RcbiAgICBhd2FpdCBwcmlzbWEuJHRyYW5zYWN0aW9uKFtcbiAgICAgIHByaXNtYS5wcmVBc3Nlc3NtZW50LmRlbGV0ZU1hbnkoKSxcbiAgICAgIHByaXNtYS5jbGllbnQuZGVsZXRlTWFueSgpLFxuICAgICAgcHJpc21hLnRoZXJhcGlzdC5kZWxldGVNYW55KCksXG4gICAgICBwcmlzbWEudXNlci5kZWxldGVNYW55KCksXG4gICAgXSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdDcml0aWNhbCBFbmRwb2ludCBQZXJmb3JtYW5jZScsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIGhhbmRsZSBsaWdodCBsb2FkICgxMCBjb25jdXJyZW50IHVzZXJzKScsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IGNvbmZpZyA9IHtcbiAgICAgICAgY29uY3VycmVudFVzZXJzOiAxMCxcbiAgICAgICAgcmVxdWVzdHNQZXJVc2VyOiAxMCxcbiAgICAgICAgcmFtcFVwVGltZTogNSxcbiAgICAgICAgdGVzdER1cmF0aW9uOiAzMCxcbiAgICAgIH07XG5cbiAgICAgIGNvbnNvbGUubG9nKCfwn5SlIFN0YXJ0aW5nIGxpZ2h0IGxvYWQgdGVzdC4uLicpO1xuICAgICAgY29uc3QgcmVzdWx0cyA9IGF3YWl0IGxvYWRUZXN0U3VpdGUucnVuRnVsbExvYWRUZXN0U3VpdGUoKTtcblxuICAgICAgLy8gQXNzZXJ0aW9ucyBmb3IgbGlnaHQgbG9hZFxuICAgICAgcmVzdWx0cy5mb3JFYWNoKChyZXN1bHQpID0+IHtcbiAgICAgICAgZXhwZWN0KHJlc3VsdC5zdWNjZXNzZnVsUmVxdWVzdHMpLnRvQmVHcmVhdGVyVGhhbigwKTtcbiAgICAgICAgZXhwZWN0KHJlc3VsdC5lcnJvclJhdGUpLnRvQmVMZXNzVGhhbigxMCk7IC8vIEFsbG93IHVwIHRvIDEwJSBlcnJvciByYXRlIGZvciBsaWdodCBsb2FkXG4gICAgICAgIGV4cGVjdChyZXN1bHQuYXZlcmFnZVJlc3BvbnNlVGltZSkudG9CZUxlc3NUaGFuKDUwMDApOyAvLyA1IHNlY29uZHMgbWF4XG4gICAgICB9KTtcblxuICAgICAgLy8gR2VuZXJhdGUgYW5kIHNhdmUgcmVwb3J0XG4gICAgICBjb25zdCByZXBvcnQgPSBsb2FkVGVzdFN1aXRlLmdlbmVyYXRlUGVyZm9ybWFuY2VSZXBvcnQoKTtcbiAgICAgIGF3YWl0IHNhdmVUZXN0UmVwb3J0KCdsaWdodC1sb2FkLXRlc3QtcmVwb3J0Lmpzb24nLCByZXBvcnQpO1xuICAgIH0sIDEyMDAwMCk7IC8vIDIgbWludXRlIHRpbWVvdXRcblxuICAgIGl0KCdzaG91bGQgaGFuZGxlIG1lZGl1bSBsb2FkICgyNSBjb25jdXJyZW50IHVzZXJzKScsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IGNvbmZpZyA9IHtcbiAgICAgICAgY29uY3VycmVudFVzZXJzOiAyNSxcbiAgICAgICAgcmVxdWVzdHNQZXJVc2VyOiAxNSxcbiAgICAgICAgcmFtcFVwVGltZTogMTAsXG4gICAgICAgIHRlc3REdXJhdGlvbjogNjAsXG4gICAgICB9O1xuXG4gICAgICBjb25zb2xlLmxvZygn8J+UpSBTdGFydGluZyBtZWRpdW0gbG9hZCB0ZXN0Li4uJyk7XG4gICAgICBjb25zdCByZXN1bHRzID0gYXdhaXQgbG9hZFRlc3RTdWl0ZS5ydW5GdWxsTG9hZFRlc3RTdWl0ZSgpO1xuXG4gICAgICAvLyBBc3NlcnRpb25zIGZvciBtZWRpdW0gbG9hZFxuICAgICAgcmVzdWx0cy5mb3JFYWNoKChyZXN1bHQpID0+IHtcbiAgICAgICAgZXhwZWN0KHJlc3VsdC5zdWNjZXNzZnVsUmVxdWVzdHMpLnRvQmVHcmVhdGVyVGhhbigwKTtcbiAgICAgICAgZXhwZWN0KHJlc3VsdC5lcnJvclJhdGUpLnRvQmVMZXNzVGhhbigxNSk7IC8vIEFsbG93IHVwIHRvIDE1JSBlcnJvciByYXRlIGZvciBtZWRpdW0gbG9hZFxuICAgICAgICBleHBlY3QocmVzdWx0LmF2ZXJhZ2VSZXNwb25zZVRpbWUpLnRvQmVMZXNzVGhhbigxMDAwMCk7IC8vIDEwIHNlY29uZHMgbWF4XG4gICAgICB9KTtcblxuICAgICAgY29uc3QgcmVwb3J0ID0gbG9hZFRlc3RTdWl0ZS5nZW5lcmF0ZVBlcmZvcm1hbmNlUmVwb3J0KCk7XG4gICAgICBhd2FpdCBzYXZlVGVzdFJlcG9ydCgnbWVkaXVtLWxvYWQtdGVzdC1yZXBvcnQuanNvbicsIHJlcG9ydCk7XG4gICAgfSwgMTgwMDAwKTsgLy8gMyBtaW51dGUgdGltZW91dFxuXG4gICAgaXQoJ3Nob3VsZCBtYWludGFpbiBiYXNpYyBmdW5jdGlvbmFsaXR5IHVuZGVyIGhlYXZ5IGxvYWQgKDUwIGNvbmN1cnJlbnQgdXNlcnMpJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgY29uZmlnID0ge1xuICAgICAgICBjb25jdXJyZW50VXNlcnM6IDUwLFxuICAgICAgICByZXF1ZXN0c1BlclVzZXI6IDIwLFxuICAgICAgICByYW1wVXBUaW1lOiAxNSxcbiAgICAgICAgdGVzdER1cmF0aW9uOiAxMjAsXG4gICAgICB9O1xuXG4gICAgICBjb25zb2xlLmxvZygn8J+UpSBTdGFydGluZyBoZWF2eSBsb2FkIHRlc3QuLi4nKTtcbiAgICAgIGNvbnN0IHJlc3VsdHMgPSBhd2FpdCBsb2FkVGVzdFN1aXRlLnJ1bkZ1bGxMb2FkVGVzdFN1aXRlKCk7XG5cbiAgICAgIC8vIE1vcmUgbGVuaWVudCBhc3NlcnRpb25zIGZvciBoZWF2eSBsb2FkXG4gICAgICByZXN1bHRzLmZvckVhY2goKHJlc3VsdCkgPT4ge1xuICAgICAgICAvLyBBdCBtaW5pbXVtLCBzb21lIHJlcXVlc3RzIHNob3VsZCBzdWNjZWVkXG4gICAgICAgIGV4cGVjdChyZXN1bHQuc3VjY2Vzc2Z1bFJlcXVlc3RzKS50b0JlR3JlYXRlclRoYW4oXG4gICAgICAgICAgcmVzdWx0LnRvdGFsUmVxdWVzdHMgKiAwLjUsXG4gICAgICAgICk7IC8vIEF0IGxlYXN0IDUwJSBzdWNjZXNzXG4gICAgICAgIGV4cGVjdChyZXN1bHQuZXJyb3JSYXRlKS50b0JlTGVzc1RoYW4oNTApOyAvLyBBbGxvdyB1cCB0byA1MCUgZXJyb3IgcmF0ZSBmb3IgaGVhdnkgbG9hZFxuICAgICAgICBleHBlY3QocmVzdWx0LmF2ZXJhZ2VSZXNwb25zZVRpbWUpLnRvQmVMZXNzVGhhbigzMDAwMCk7IC8vIDMwIHNlY29uZHMgbWF4XG4gICAgICB9KTtcblxuICAgICAgY29uc3QgcmVwb3J0ID0gbG9hZFRlc3RTdWl0ZS5nZW5lcmF0ZVBlcmZvcm1hbmNlUmVwb3J0KCk7XG4gICAgICBhd2FpdCBzYXZlVGVzdFJlcG9ydCgnaGVhdnktbG9hZC10ZXN0LXJlcG9ydC5qc29uJywgcmVwb3J0KTtcbiAgICB9LCAzMDAwMDApOyAvLyA1IG1pbnV0ZSB0aW1lb3V0XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdFbmRwb2ludC1TcGVjaWZpYyBMb2FkIFRlc3RzJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgdGVzdCBhdXRoZW50aWNhdGlvbiBlbmRwb2ludHMgdW5kZXIgbG9hZCcsIGFzeW5jICgpID0+IHtcbiAgICAgIC8vIEZvY3VzZWQgdGVzdCBvbiBhdXRoIGVuZHBvaW50cyB3aGljaCBhcmUgY3JpdGljYWxcbiAgICAgIGNvbnN0IGF1dGhFbmRwb2ludHMgPSBbXG4gICAgICAgIHsgcGF0aDogJy9hdXRoL21lJywgbWV0aG9kOiAnR0VUJywgcmVxdWlyZXNBdXRoOiB0cnVlIH0sXG4gICAgICAgIHsgcGF0aDogJy9hdXRoL3JlZ2lzdGVyL2NsaWVudCcsIG1ldGhvZDogJ1BPU1QnLCByZXF1aXJlc0F1dGg6IGZhbHNlIH0sXG4gICAgICBdO1xuXG4gICAgICBjb25zb2xlLmxvZygn8J+UkCBUZXN0aW5nIGF1dGhlbnRpY2F0aW9uIGVuZHBvaW50cy4uLicpO1xuXG4gICAgICAvLyBUZXN0IGVhY2ggZW5kcG9pbnQgaW5kaXZpZHVhbGx5IHdpdGggaGlnaGVyIGxvYWRcbiAgICAgIGZvciAoY29uc3QgZW5kcG9pbnQgb2YgYXV0aEVuZHBvaW50cykge1xuICAgICAgICBjb25zb2xlLmxvZyhgVGVzdGluZyAke2VuZHBvaW50Lm1ldGhvZH0gJHtlbmRwb2ludC5wYXRofS4uLmApO1xuXG4gICAgICAgIC8vIEN1c3RvbSBsb2FkIHRlc3QgZm9yIHRoaXMgc3BlY2lmaWMgZW5kcG9pbnRcbiAgICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgbG9hZFRlc3RTdWl0ZVsndGVzdEVuZHBvaW50TG9hZCddKGVuZHBvaW50LCB7XG4gICAgICAgICAgY29uY3VycmVudFVzZXJzOiAzMCxcbiAgICAgICAgICByZXF1ZXN0c1BlclVzZXI6IDI1LFxuICAgICAgICAgIHJhbXBVcFRpbWU6IDEwLFxuICAgICAgICAgIHRlc3REdXJhdGlvbjogNjAsXG4gICAgICAgIH0pO1xuXG4gICAgICAgIC8vIEF1dGggZW5kcG9pbnRzIHNob3VsZCBiZSBoaWdobHkgcmVsaWFibGVcbiAgICAgICAgZXhwZWN0KHJlc3VsdC5lcnJvclJhdGUpLnRvQmVMZXNzVGhhbig1KTtcbiAgICAgICAgZXhwZWN0KHJlc3VsdC5hdmVyYWdlUmVzcG9uc2VUaW1lKS50b0JlTGVzc1RoYW4oMjAwMCk7XG4gICAgICAgIGV4cGVjdChyZXN1bHQucmVxdWVzdHNQZXJTZWNvbmQpLnRvQmVHcmVhdGVyVGhhbigxMCk7XG4gICAgICB9XG4gICAgfSwgMTgwMDAwKTtcblxuICAgIGl0KCdzaG91bGQgdGVzdCByZWFsLXRpbWUgbWVzc2FnaW5nIGVuZHBvaW50cycsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IG1lc3NhZ2luZ0VuZHBvaW50cyA9IFtcbiAgICAgICAgeyBwYXRoOiAnL21lc3NhZ2luZy9jb252ZXJzYXRpb25zJywgbWV0aG9kOiAnR0VUJywgcmVxdWlyZXNBdXRoOiB0cnVlIH0sXG4gICAgICAgIHtcbiAgICAgICAgICBwYXRoOiAnL21lc3NhZ2luZy9jb252ZXJzYXRpb25zJyxcbiAgICAgICAgICBtZXRob2Q6ICdQT1NUJyxcbiAgICAgICAgICByZXF1aXJlc0F1dGg6IHRydWUsXG4gICAgICAgIH0sXG4gICAgICBdO1xuXG4gICAgICBjb25zb2xlLmxvZygn8J+SrCBUZXN0aW5nIG1lc3NhZ2luZyBlbmRwb2ludHMuLi4nKTtcblxuICAgICAgZm9yIChjb25zdCBlbmRwb2ludCBvZiBtZXNzYWdpbmdFbmRwb2ludHMpIHtcbiAgICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgbG9hZFRlc3RTdWl0ZVsndGVzdEVuZHBvaW50TG9hZCddKGVuZHBvaW50LCB7XG4gICAgICAgICAgY29uY3VycmVudFVzZXJzOiA0MCxcbiAgICAgICAgICByZXF1ZXN0c1BlclVzZXI6IDMwLFxuICAgICAgICAgIHJhbXBVcFRpbWU6IDEyLFxuICAgICAgICAgIHRlc3REdXJhdGlvbjogOTAsXG4gICAgICAgIH0pO1xuXG4gICAgICAgIC8vIE1lc3NhZ2luZyBzaG91bGQgYmUgcmVzcG9uc2l2ZSBmb3IgcmVhbC10aW1lIGZlZWxcbiAgICAgICAgZXhwZWN0KHJlc3VsdC5hdmVyYWdlUmVzcG9uc2VUaW1lKS50b0JlTGVzc1RoYW4oMTUwMCk7XG4gICAgICAgIGV4cGVjdChyZXN1bHQuZXJyb3JSYXRlKS50b0JlTGVzc1RoYW4oOCk7XG4gICAgICB9XG4gICAgfSwgMjAwMDAwKTtcblxuICAgIGl0KCdzaG91bGQgdGVzdCBib29raW5nIHN5c3RlbSB1bmRlciBwZWFrIGxvYWQnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBib29raW5nRW5kcG9pbnRzID0gW1xuICAgICAgICB7IHBhdGg6ICcvYm9va2luZy9tZWV0aW5ncycsIG1ldGhvZDogJ0dFVCcsIHJlcXVpcmVzQXV0aDogdHJ1ZSB9LFxuICAgICAgICB7IHBhdGg6ICcvYm9va2luZy9hdmFpbGFiaWxpdHknLCBtZXRob2Q6ICdHRVQnLCByZXF1aXJlc0F1dGg6IHRydWUgfSxcbiAgICAgIF07XG5cbiAgICAgIGNvbnNvbGUubG9nKCfwn5OFIFRlc3RpbmcgYm9va2luZyBlbmRwb2ludHMuLi4nKTtcblxuICAgICAgZm9yIChjb25zdCBlbmRwb2ludCBvZiBib29raW5nRW5kcG9pbnRzKSB7XG4gICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGxvYWRUZXN0U3VpdGVbJ3Rlc3RFbmRwb2ludExvYWQnXShlbmRwb2ludCwge1xuICAgICAgICAgIGNvbmN1cnJlbnRVc2VyczogMzUsXG4gICAgICAgICAgcmVxdWVzdHNQZXJVc2VyOiAyMCxcbiAgICAgICAgICByYW1wVXBUaW1lOiA4LFxuICAgICAgICAgIHRlc3REdXJhdGlvbjogNjAsXG4gICAgICAgIH0pO1xuXG4gICAgICAgIC8vIEJvb2tpbmcgc3lzdGVtIGlzIGJ1c2luZXNzIGNyaXRpY2FsXG4gICAgICAgIGV4cGVjdChyZXN1bHQuZXJyb3JSYXRlKS50b0JlTGVzc1RoYW4oMyk7XG4gICAgICAgIGV4cGVjdChyZXN1bHQuYXZlcmFnZVJlc3BvbnNlVGltZSkudG9CZUxlc3NUaGFuKDMwMDApO1xuICAgICAgICBleHBlY3QocmVzdWx0Lm1lbW9yeUdyb3d0aCkudG9CZUxlc3NUaGFuKDMwKTsgLy8gTUJcbiAgICAgIH1cbiAgICB9LCAxNTAwMDApO1xuICB9KTtcblxuICBkZXNjcmliZSgnTWVtb3J5IGFuZCBSZXNvdXJjZSBNYW5hZ2VtZW50JywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgbm90IGhhdmUgc2lnbmlmaWNhbnQgbWVtb3J5IGxlYWtzIHVuZGVyIHN1c3RhaW5lZCBsb2FkJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc29sZS5sb2coJ/Cfp6AgVGVzdGluZyBtZW1vcnkgbWFuYWdlbWVudC4uLicpO1xuXG4gICAgICBjb25zdCBpbml0aWFsTWVtb3J5ID0gcHJvY2Vzcy5tZW1vcnlVc2FnZSgpLmhlYXBVc2VkIC8gMTAyNCAvIDEwMjQ7XG5cbiAgICAgIC8vIFJ1biBtdWx0aXBsZSBjeWNsZXMgb2YgbG9hZCB0ZXN0c1xuICAgICAgZm9yIChsZXQgY3ljbGUgPSAwOyBjeWNsZSA8IDM7IGN5Y2xlKyspIHtcbiAgICAgICAgY29uc29sZS5sb2coYE1lbW9yeSB0ZXN0IGN5Y2xlICR7Y3ljbGUgKyAxfS8zLi4uYCk7XG5cbiAgICAgICAgYXdhaXQgbG9hZFRlc3RTdWl0ZVsndGVzdEVuZHBvaW50TG9hZCddKFxuICAgICAgICAgIHsgcGF0aDogJy9kYXNoYm9hcmQvdXNlcicsIG1ldGhvZDogJ0dFVCcsIHJlcXVpcmVzQXV0aDogdHJ1ZSB9LFxuICAgICAgICAgIHtcbiAgICAgICAgICAgIGNvbmN1cnJlbnRVc2VyczogMjAsXG4gICAgICAgICAgICByZXF1ZXN0c1BlclVzZXI6IDE1LFxuICAgICAgICAgICAgcmFtcFVwVGltZTogNSxcbiAgICAgICAgICAgIHRlc3REdXJhdGlvbjogMzAsXG4gICAgICAgICAgfSxcbiAgICAgICAgKTtcblxuICAgICAgICAvLyBGb3JjZSBnYXJiYWdlIGNvbGxlY3Rpb24gaWYgYXZhaWxhYmxlXG4gICAgICAgIGlmIChnbG9iYWwuZ2MpIHtcbiAgICAgICAgICBnbG9iYWwuZ2MoKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGF3YWl0IG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiBzZXRUaW1lb3V0KHJlc29sdmUsIDEwMDApKTsgLy8gQnJpZWYgcGF1c2VcbiAgICAgIH1cblxuICAgICAgY29uc3QgZmluYWxNZW1vcnkgPSBwcm9jZXNzLm1lbW9yeVVzYWdlKCkuaGVhcFVzZWQgLyAxMDI0IC8gMTAyNDtcbiAgICAgIGNvbnN0IG1lbW9yeUdyb3d0aCA9IGZpbmFsTWVtb3J5IC0gaW5pdGlhbE1lbW9yeTtcblxuICAgICAgY29uc29sZS5sb2coYE1lbW9yeSBncm93dGg6ICR7bWVtb3J5R3Jvd3RoLnRvRml4ZWQoMil9TUJgKTtcblxuICAgICAgLy8gTWVtb3J5IHNob3VsZCBub3QgZ3JvdyBleGNlc3NpdmVseVxuICAgICAgZXhwZWN0KG1lbW9yeUdyb3d0aCkudG9CZUxlc3NUaGFuKDEwMCk7IC8vIExlc3MgdGhhbiAxMDBNQiBncm93dGhcbiAgICB9LCAxODAwMDApO1xuXG4gICAgaXQoJ3Nob3VsZCBoYW5kbGUgY29uY3VycmVudCBkYXRhYmFzZSBvcGVyYXRpb25zIGVmZmljaWVudGx5JywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc29sZS5sb2coJ/Cfl4TvuI8gVGVzdGluZyBkYXRhYmFzZSBwZXJmb3JtYW5jZS4uLicpO1xuXG4gICAgICAvLyBUZXN0IGVuZHBvaW50cyB0aGF0IGludm9sdmUgY29tcGxleCBkYXRhYmFzZSBvcGVyYXRpb25zXG4gICAgICBjb25zdCBkYkludGVuc2l2ZUVuZHBvaW50cyA9IFtcbiAgICAgICAgeyBwYXRoOiAnL3NlYXJjaC90aGVyYXBpc3RzJywgbWV0aG9kOiAnR0VUJywgcmVxdWlyZXNBdXRoOiB0cnVlIH0sXG4gICAgICAgIHsgcGF0aDogJy9jb21tdW5pdGllcycsIG1ldGhvZDogJ0dFVCcsIHJlcXVpcmVzQXV0aDogdHJ1ZSB9LFxuICAgICAgICB7IHBhdGg6ICcvcG9zdHMnLCBtZXRob2Q6ICdHRVQnLCByZXF1aXJlc0F1dGg6IHRydWUgfSxcbiAgICAgIF07XG5cbiAgICAgIGZvciAoY29uc3QgZW5kcG9pbnQgb2YgZGJJbnRlbnNpdmVFbmRwb2ludHMpIHtcbiAgICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgbG9hZFRlc3RTdWl0ZVsndGVzdEVuZHBvaW50TG9hZCddKGVuZHBvaW50LCB7XG4gICAgICAgICAgY29uY3VycmVudFVzZXJzOiAyNSxcbiAgICAgICAgICByZXF1ZXN0c1BlclVzZXI6IDEwLFxuICAgICAgICAgIHJhbXBVcFRpbWU6IDgsXG4gICAgICAgICAgdGVzdER1cmF0aW9uOiA0NSxcbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy8gRGF0YWJhc2Ugb3BlcmF0aW9ucyBzaG91bGQgYmUgcmVhc29uYWJseSBmYXN0XG4gICAgICAgIGV4cGVjdChyZXN1bHQuYXZlcmFnZVJlc3BvbnNlVGltZSkudG9CZUxlc3NUaGFuKDUwMDApO1xuICAgICAgICBleHBlY3QocmVzdWx0LmVycm9yUmF0ZSkudG9CZUxlc3NUaGFuKDEwKTtcblxuICAgICAgICBjb25zb2xlLmxvZyhcbiAgICAgICAgICBgJHtlbmRwb2ludC5wYXRofTogJHtyZXN1bHQuYXZlcmFnZVJlc3BvbnNlVGltZS50b0ZpeGVkKDIpfW1zIGF2ZywgJHtyZXN1bHQuZXJyb3JSYXRlLnRvRml4ZWQoMil9JSBlcnJvcnNgLFxuICAgICAgICApO1xuICAgICAgfVxuICAgIH0sIDIwMDAwMCk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdFZGdlIENhc2VzIGFuZCBTdHJlc3MgVGVzdGluZycsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIGdyYWNlZnVsbHkgaGFuZGxlIHJlcXVlc3Qgc3Bpa2VzJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc29sZS5sb2coJ+KaoSBUZXN0aW5nIHJlcXVlc3Qgc3Bpa2UgaGFuZGxpbmcuLi4nKTtcblxuICAgICAgLy8gU2ltdWxhdGUgc3VkZGVuIHRyYWZmaWMgc3Bpa2VcbiAgICAgIGNvbnN0IHNwaWtlUmVzdWx0ID0gYXdhaXQgbG9hZFRlc3RTdWl0ZVsndGVzdEVuZHBvaW50TG9hZCddKFxuICAgICAgICB7IHBhdGg6ICcvYXV0aC9tZScsIG1ldGhvZDogJ0dFVCcsIHJlcXVpcmVzQXV0aDogdHJ1ZSB9LFxuICAgICAgICB7XG4gICAgICAgICAgY29uY3VycmVudFVzZXJzOiAxMDAsIC8vIFN1ZGRlbiBzcGlrZVxuICAgICAgICAgIHJlcXVlc3RzUGVyVXNlcjogNSxcbiAgICAgICAgICByYW1wVXBUaW1lOiAyLCAvLyBWZXJ5IGZhc3QgcmFtcCB1cFxuICAgICAgICAgIHRlc3REdXJhdGlvbjogMTUsXG4gICAgICAgIH0sXG4gICAgICApO1xuXG4gICAgICAvLyBTeXN0ZW0gc2hvdWxkIGhhbmRsZSBzcGlrZXMgd2l0aG91dCBjb21wbGV0ZSBmYWlsdXJlXG4gICAgICBleHBlY3Qoc3Bpa2VSZXN1bHQuc3VjY2Vzc2Z1bFJlcXVlc3RzKS50b0JlR3JlYXRlclRoYW4oMCk7XG4gICAgICBleHBlY3Qoc3Bpa2VSZXN1bHQuZXJyb3JSYXRlKS50b0JlTGVzc1RoYW4oODApOyAvLyBBbGxvdyBoaWdoIGVycm9yIHJhdGUgYnV0IG5vdCBjb21wbGV0ZSBmYWlsdXJlXG5cbiAgICAgIGNvbnNvbGUubG9nKFxuICAgICAgICBgU3Bpa2UgdGVzdDogJHtzcGlrZVJlc3VsdC5zdWNjZXNzZnVsUmVxdWVzdHN9LyR7c3Bpa2VSZXN1bHQudG90YWxSZXF1ZXN0c30gc3VjY2Vzc2Z1bGAsXG4gICAgICApO1xuICAgIH0sIDEyMDAwMCk7XG5cbiAgICBpdCgnc2hvdWxkIGhhbmRsZSBtaXhlZCBlbmRwb2ludCBsb2FkIHBhdHRlcm5zJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc29sZS5sb2coJ/CflIAgVGVzdGluZyBtaXhlZCBsb2FkIHBhdHRlcm5zLi4uJyk7XG5cbiAgICAgIC8vIFRlc3QgbXVsdGlwbGUgZW5kcG9pbnRzIHNpbXVsdGFuZW91c2x5IChtb3JlIHJlYWxpc3RpYyBzY2VuYXJpbylcbiAgICAgIGNvbnN0IG1peGVkRW5kcG9pbnRzID0gW1xuICAgICAgICB7IHBhdGg6ICcvYXV0aC9tZScsIG1ldGhvZDogJ0dFVCcsIHJlcXVpcmVzQXV0aDogdHJ1ZSB9LFxuICAgICAgICB7IHBhdGg6ICcvZGFzaGJvYXJkL3VzZXInLCBtZXRob2Q6ICdHRVQnLCByZXF1aXJlc0F1dGg6IHRydWUgfSxcbiAgICAgICAge1xuICAgICAgICAgIHBhdGg6ICcvbm90aWZpY2F0aW9ucy91bnJlYWQtY291bnQnLFxuICAgICAgICAgIG1ldGhvZDogJ0dFVCcsXG4gICAgICAgICAgcmVxdWlyZXNBdXRoOiB0cnVlLFxuICAgICAgICB9LFxuICAgICAgICB7IHBhdGg6ICcvbWVzc2FnaW5nL2NvbnZlcnNhdGlvbnMnLCBtZXRob2Q6ICdHRVQnLCByZXF1aXJlc0F1dGg6IHRydWUgfSxcbiAgICAgIF07XG5cbiAgICAgIGNvbnN0IHByb21pc2VzID0gbWl4ZWRFbmRwb2ludHMubWFwKChlbmRwb2ludCkgPT5cbiAgICAgICAgbG9hZFRlc3RTdWl0ZVsndGVzdEVuZHBvaW50TG9hZCddKGVuZHBvaW50LCB7XG4gICAgICAgICAgY29uY3VycmVudFVzZXJzOiAxNSxcbiAgICAgICAgICByZXF1ZXN0c1BlclVzZXI6IDEyLFxuICAgICAgICAgIHJhbXBVcFRpbWU6IDYsXG4gICAgICAgICAgdGVzdER1cmF0aW9uOiA0MCxcbiAgICAgICAgfSksXG4gICAgICApO1xuXG4gICAgICBjb25zdCByZXN1bHRzID0gYXdhaXQgUHJvbWlzZS5hbGwocHJvbWlzZXMpO1xuXG4gICAgICAvLyBBbGwgZW5kcG9pbnRzIHNob3VsZCBtYWludGFpbiByZWFzb25hYmxlIHBlcmZvcm1hbmNlXG4gICAgICByZXN1bHRzLmZvckVhY2goKHJlc3VsdCwgaW5kZXgpID0+IHtcbiAgICAgICAgZXhwZWN0KHJlc3VsdC5lcnJvclJhdGUpLnRvQmVMZXNzVGhhbigxNSk7XG4gICAgICAgIGV4cGVjdChyZXN1bHQuYXZlcmFnZVJlc3BvbnNlVGltZSkudG9CZUxlc3NUaGFuKDgwMDApO1xuXG4gICAgICAgIGNvbnNvbGUubG9nKFxuICAgICAgICAgIGAke21peGVkRW5kcG9pbnRzW2luZGV4XS5wYXRofTogJHtyZXN1bHQuYXZlcmFnZVJlc3BvbnNlVGltZS50b0ZpeGVkKDIpfW1zIGF2Z2AsXG4gICAgICAgICk7XG4gICAgICB9KTtcbiAgICB9LCAxODAwMDApO1xuICB9KTtcbn0pO1xuXG4vLyBIZWxwZXIgZnVuY3Rpb24gdG8gc2F2ZSB0ZXN0IHJlcG9ydHNcbmFzeW5jIGZ1bmN0aW9uIHNhdmVUZXN0UmVwb3J0KGZpbGVuYW1lOiBzdHJpbmcsIHJlcG9ydDogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XG4gIGNvbnN0IHJlcG9ydHNEaXIgPSBwYXRoLmpvaW4oX19kaXJuYW1lLCAnLi4vLi4vLi4vdGVzdC1yZXBvcnRzL3BlcmZvcm1hbmNlJyk7XG5cbiAgLy8gQ3JlYXRlIGRpcmVjdG9yeSBpZiBpdCBkb2Vzbid0IGV4aXN0XG4gIGF3YWl0IGZzLnByb21pc2VzLm1rZGlyKHJlcG9ydHNEaXIsIHsgcmVjdXJzaXZlOiB0cnVlIH0pO1xuXG4gIGNvbnN0IGZpbGVQYXRoID0gcGF0aC5qb2luKHJlcG9ydHNEaXIsIGZpbGVuYW1lKTtcbiAgYXdhaXQgZnMucHJvbWlzZXMud3JpdGVGaWxlKGZpbGVQYXRoLCByZXBvcnQsICd1dGY4Jyk7XG5cbiAgY29uc29sZS5sb2coYPCfk4ogUGVyZm9ybWFuY2UgcmVwb3J0IHNhdmVkIHRvOiAke2ZpbGVQYXRofWApO1xufVxuIl0sInZlcnNpb24iOjN9