8f7cf2f3af45f0fa1f28bae2ff0c0823
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var __param = (this && this.__param) || function (paramIndex, decorator) {
    return function (target, key) { decorator(target, key, paramIndex); }
};
var StripeWebhookController_1;
var _a, _b, _c, _d;
Object.defineProperty(exports, "__esModule", { value: true });
exports.StripeWebhookController = void 0;
const common_1 = require("@nestjs/common");
const swagger_1 = require("@nestjs/swagger");
const stripe_service_1 = require("../services/stripe.service");
const prisma_client_provider_1 = require("../../providers/prisma-client.provider");
const event_emitter_1 = require("@nestjs/event-emitter");
let StripeWebhookController = StripeWebhookController_1 = class StripeWebhookController {
    stripeService;
    prisma;
    eventEmitter;
    logger = new common_1.Logger(StripeWebhookController_1.name);
    constructor(stripeService, prisma, eventEmitter) {
        this.stripeService = stripeService;
        this.prisma = prisma;
        this.eventEmitter = eventEmitter;
    }
    async handleWebhook(request, body, signature) {
        const startTime = Date.now();
        try {
            // Validate required headers
            if (!signature) {
                this.logger.error('Missing Stripe signature header');
                throw new common_1.BadRequestException('Missing Stripe signature header');
            }
            // Get raw body for signature validation
            const rawBody = request.rawBody;
            if (!rawBody) {
                this.logger.error('Missing raw body for webhook validation');
                throw new common_1.BadRequestException('Missing raw body for webhook validation');
            }
            // Construct and validate webhook event
            const event = this.stripeService.constructWebhookEvent(rawBody, signature);
            this.logger.log(`Received Stripe webhook: ${event.type} (${event.id})`);
            // Check if we've already processed this event (idempotency)
            const existingEvent = await this.checkEventIdempotency(event.id);
            if (existingEvent) {
                this.logger.log(`Event ${event.id} already processed, skipping`);
                return {
                    received: true,
                    eventId: event.id,
                    eventType: event.type,
                    message: 'Event already processed',
                };
            }
            // Record the event as being processed
            await this.recordWebhookEvent(event);
            // Process the event
            await this.stripeService.handleWebhookEvent(event);
            // Mark event as successfully processed
            await this.markEventProcessed(event.id, true);
            // Log performance metrics
            const processingTime = Date.now() - startTime;
            this.logger.log(`Webhook ${event.type} processed successfully in ${processingTime}ms`);
            // Emit event for monitoring/analytics
            this.eventEmitter.emit('stripe.webhook.processed', {
                eventId: event.id,
                eventType: event.type,
                processingTime,
                success: true,
            });
            return {
                received: true,
                eventId: event.id,
                eventType: event.type,
                processingTime,
            };
        }
        catch (error) {
            const processingTime = Date.now() - startTime;
            // Log the error with context
            this.logger.error(`Webhook processing failed in ${processingTime}ms:`, {
                error: error instanceof Error ? error.message : String(error),
                stack: error instanceof Error ? error.stack : undefined,
                signature: signature?.substring(0, 20) + '...',
                bodyType: typeof body,
                rawBodyLength: request.rawBody?.length,
            });
            // Try to extract event info for logging even if processing failed
            let eventId = 'unknown';
            let eventType = 'unknown';
            try {
                if (body && typeof body === 'object') {
                    eventId = body.id || 'unknown';
                    eventType = body.type || 'unknown';
                }
            }
            catch (parseError) {
                // Ignore parsing errors for logging
            }
            // Mark event as failed if we have an event ID
            if (eventId !== 'unknown') {
                try {
                    await this.markEventProcessed(eventId, false, error instanceof Error ? error.message : String(error));
                }
                catch (dbError) {
                    this.logger.error('Failed to mark event as failed in database:', dbError);
                }
            }
            // Emit error event for monitoring
            this.eventEmitter.emit('stripe.webhook.error', {
                eventId,
                eventType,
                processingTime,
                error: error instanceof Error ? error.message : String(error),
                success: false,
            });
            // Return appropriate error response
            if (error instanceof common_1.BadRequestException) {
                throw error;
            }
            throw new common_1.InternalServerErrorException('Failed to process webhook');
        }
    }
    async testWebhook(body) {
        try {
            this.logger.log('Test webhook received:', body);
            return {
                received: true,
                timestamp: new Date().toISOString(),
                message: 'Test webhook processed successfully',
                body: body,
            };
        }
        catch (error) {
            this.logger.error('Test webhook processing failed:', error);
            throw new common_1.InternalServerErrorException('Failed to process test webhook');
        }
    }
    /**
     * Check if event has already been processed (idempotency)
     */
    async checkEventIdempotency(eventId) {
        try {
            const existingEvent = await this.prisma.stripeWebhookEvent.findUnique({
                where: { eventId },
            });
            return !!existingEvent;
        }
        catch (error) {
            this.logger.error(`Error checking event idempotency for ${eventId}:`, error);
            return false; // Allow processing if we can't check
        }
    }
    /**
     * Record webhook event in database
     */
    async recordWebhookEvent(event) {
        try {
            await this.prisma.stripeWebhookEvent.create({
                data: {
                    eventId: event.id,
                    eventType: event.type,
                    eventData: event.data,
                    livemode: event.livemode,
                    apiVersion: event.api_version,
                    created: new Date(event.created * 1000),
                    processed: false,
                },
            });
        }
        catch (error) {
            this.logger.error(`Error recording webhook event ${event.id}:`, error);
            // Don't throw here - we still want to process the event
        }
    }
    /**
     * Mark event as processed
     */
    async markEventProcessed(eventId, success, errorMessage) {
        try {
            await this.prisma.stripeWebhookEvent.update({
                where: { eventId },
                data: {
                    processed: true,
                    processedAt: new Date(),
                    success,
                    errorMessage: errorMessage || null,
                },
            });
        }
        catch (error) {
            this.logger.error(`Error marking event ${eventId} as processed:`, error);
            // Don't throw here - event processing was the important part
        }
    }
    /**
     * Get webhook processing statistics
     */
    async getWebhookStats() {
        try {
            const now = new Date();
            const oneDayAgo = new Date(now.getTime() - 24 * 60 * 60 * 1000);
            const oneWeekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            const [totalEvents, processedEvents, failedEvents, recentEvents, eventsByType,] = await Promise.all([
                this.prisma.stripeWebhookEvent.count(),
                this.prisma.stripeWebhookEvent.count({
                    where: { processed: true, success: true },
                }),
                this.prisma.stripeWebhookEvent.count({
                    where: { processed: true, success: false },
                }),
                this.prisma.stripeWebhookEvent.count({
                    where: { created: { gte: oneDayAgo } },
                }),
                this.prisma.stripeWebhookEvent.groupBy({
                    by: ['eventType'],
                    where: { created: { gte: oneWeekAgo } },
                    _count: { eventType: true },
                }),
            ]);
            const successRate = totalEvents > 0 ? (processedEvents / totalEvents) * 100 : 0;
            return {
                totalEvents,
                processedEvents,
                failedEvents,
                recentEvents,
                successRate: Math.round(successRate * 100) / 100,
                eventsByType: eventsByType.map((event) => ({
                    eventType: event.eventType,
                    count: event._count.eventType,
                })),
            };
        }
        catch (error) {
            this.logger.error('Error getting webhook statistics:', error);
            throw new common_1.InternalServerErrorException('Failed to get webhook statistics');
        }
    }
    /**
     * Get recent webhook events
     */
    async getRecentEvents() {
        try {
            const events = await this.prisma.stripeWebhookEvent.findMany({
                select: {
                    eventId: true,
                    eventType: true,
                    created: true,
                    processed: true,
                    processedAt: true,
                    success: true,
                    errorMessage: true,
                },
                orderBy: { created: 'desc' },
                take: 50,
            });
            return {
                events,
                count: events.length,
            };
        }
        catch (error) {
            this.logger.error('Error getting recent webhook events:', error);
            throw new common_1.InternalServerErrorException('Failed to get recent webhook events');
        }
    }
    /**
     * Retry failed webhook event
     */
    async retryFailedEvent(request) {
        try {
            const eventId = request.params.eventId;
            // Get the failed event
            const webhookEvent = await this.prisma.stripeWebhookEvent.findUnique({
                where: { eventId },
            });
            if (!webhookEvent) {
                throw new common_1.BadRequestException(`Webhook event ${eventId} not found`);
            }
            if (webhookEvent.success) {
                throw new common_1.BadRequestException(`Webhook event ${eventId} already processed successfully`);
            }
            // Reconstruct the Stripe event and retry processing
            const stripeEvent = {
                id: webhookEvent.eventId,
                type: webhookEvent.eventType,
                data: webhookEvent.eventData,
                created: Math.floor(webhookEvent.created.getTime() / 1000),
                livemode: webhookEvent.livemode,
                api_version: webhookEvent.apiVersion,
            };
            // Process the event
            await this.stripeService.handleWebhookEvent(stripeEvent);
            // Mark as successfully processed
            await this.markEventProcessed(eventId, true);
            this.logger.log(`Successfully retried webhook event ${eventId}`);
            return {
                success: true,
                eventId,
                message: 'Webhook event retried successfully',
            };
        }
        catch (error) {
            this.logger.error('Error retrying webhook event:', error);
            throw new common_1.InternalServerErrorException('Failed to retry webhook event');
        }
    }
};
exports.StripeWebhookController = StripeWebhookController;
__decorate([
    (0, common_1.Post)(),
    (0, common_1.HttpCode)(common_1.HttpStatus.OK),
    (0, swagger_1.ApiExcludeEndpoint)() // Hide from public API docs for security
    ,
    (0, swagger_1.ApiOperation)({
        summary: 'Handle Stripe webhook events',
        description: 'Receives and processes webhook events from Stripe',
    }),
    (0, swagger_1.ApiResponse)({
        status: 200,
        description: 'Webhook processed successfully',
        schema: {
            type: 'object',
            properties: {
                received: { type: 'boolean' },
                eventId: { type: 'string' },
                eventType: { type: 'string' },
            },
        },
    }),
    (0, swagger_1.ApiResponse)({
        status: 400,
        description: 'Invalid webhook signature or payload',
    }),
    (0, swagger_1.ApiResponse)({
        status: 500,
        description: 'Error processing webhook',
    }),
    __param(0, (0, common_1.Req)()),
    __param(1, (0, common_1.Body)()),
    __param(2, (0, common_1.Headers)('stripe-signature')),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [typeof (_d = typeof common_1.RawBodyRequest !== "undefined" && common_1.RawBodyRequest) === "function" ? _d : Object, Object, String]),
    __metadata("design:returntype", Promise)
], StripeWebhookController.prototype, "handleWebhook", null);
__decorate([
    (0, common_1.Post)('test'),
    (0, common_1.HttpCode)(common_1.HttpStatus.OK),
    (0, swagger_1.ApiOperation)({
        summary: 'Test webhook endpoint',
        description: 'Test endpoint for webhook connectivity (development only)',
    }),
    (0, swagger_1.ApiResponse)({
        status: 200,
        description: 'Test webhook received successfully',
    }),
    __param(0, (0, common_1.Body)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Object]),
    __metadata("design:returntype", Promise)
], StripeWebhookController.prototype, "testWebhook", null);
__decorate([
    (0, common_1.Post)('stats'),
    (0, common_1.HttpCode)(common_1.HttpStatus.OK),
    (0, swagger_1.ApiOperation)({
        summary: 'Get webhook processing statistics',
        description: 'Returns statistics about webhook processing (admin only)',
    }),
    (0, swagger_1.ApiResponse)({
        status: 200,
        description: 'Webhook statistics retrieved successfully',
    }),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", []),
    __metadata("design:returntype", Promise)
], StripeWebhookController.prototype, "getWebhookStats", null);
__decorate([
    (0, common_1.Post)('recent'),
    (0, common_1.HttpCode)(common_1.HttpStatus.OK),
    (0, swagger_1.ApiOperation)({
        summary: 'Get recent webhook events',
        description: 'Returns recent webhook events for debugging (admin only)',
    }),
    (0, swagger_1.ApiResponse)({
        status: 200,
        description: 'Recent webhook events retrieved successfully',
    }),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", []),
    __metadata("design:returntype", Promise)
], StripeWebhookController.prototype, "getRecentEvents", null);
__decorate([
    (0, common_1.Post)('retry/:eventId'),
    (0, common_1.HttpCode)(common_1.HttpStatus.OK),
    (0, swagger_1.ApiOperation)({
        summary: 'Retry failed webhook event',
        description: 'Manually retry processing a failed webhook event (admin only)',
    }),
    (0, swagger_1.ApiResponse)({
        status: 200,
        description: 'Webhook event retried successfully',
    }),
    __param(0, (0, common_1.Req)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Object]),
    __metadata("design:returntype", Promise)
], StripeWebhookController.prototype, "retryFailedEvent", null);
exports.StripeWebhookController = StripeWebhookController = StripeWebhookController_1 = __decorate([
    (0, swagger_1.ApiTags)('Stripe Webhooks'),
    (0, swagger_1.ApiTags)('stripe-webhook'),
    (0, swagger_1.ApiBearerAuth)('JWT-auth'),
    (0, common_1.Controller)('billing/stripe/webhooks'),
    __metadata("design:paramtypes", [typeof (_a = typeof stripe_service_1.StripeService !== "undefined" && stripe_service_1.StripeService) === "function" ? _a : Object, typeof (_b = typeof prisma_client_provider_1.PrismaService !== "undefined" && prisma_client_provider_1.PrismaService) === "function" ? _b : Object, typeof (_c = typeof event_emitter_1.EventEmitter2 !== "undefined" && event_emitter_1.EventEmitter2) === "function" ? _c : Object])
], StripeWebhookController);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL2JpbGxpbmcvY29udHJvbGxlcnMvc3RyaXBlLXdlYmhvb2suY29udHJvbGxlci50cyIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLDJDQVl3QjtBQUN4Qiw2Q0FNeUI7QUFFekIsK0RBQTJEO0FBQzNELG1GQUF1RTtBQUN2RSx5REFBc0Q7QUFNL0MsSUFBTSx1QkFBdUIsK0JBQTdCLE1BQU0sdUJBQXVCO0lBSWY7SUFDQTtJQUNBO0lBTEYsTUFBTSxHQUFHLElBQUksZUFBTSxDQUFDLHlCQUF1QixDQUFDLElBQUksQ0FBQyxDQUFDO0lBRW5FLFlBQ21CLGFBQTRCLEVBQzVCLE1BQXFCLEVBQ3JCLFlBQTJCO1FBRjNCLGtCQUFhLEdBQWIsYUFBYSxDQUFlO1FBQzVCLFdBQU0sR0FBTixNQUFNLENBQWU7UUFDckIsaUJBQVksR0FBWixZQUFZLENBQWU7SUFDM0MsQ0FBQztJQTZCRSxBQUFOLEtBQUssQ0FBQyxhQUFhLENBQ1YsT0FBZ0MsRUFDL0IsSUFBUyxFQUNZLFNBQWlCO1FBRTlDLE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQztRQUU3QixJQUFJLENBQUM7WUFDSCw0QkFBNEI7WUFDNUIsSUFBSSxDQUFDLFNBQVMsRUFBRSxDQUFDO2dCQUNmLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLGlDQUFpQyxDQUFDLENBQUM7Z0JBQ3JELE1BQU0sSUFBSSw0QkFBbUIsQ0FBQyxpQ0FBaUMsQ0FBQyxDQUFDO1lBQ25FLENBQUM7WUFFRCx3Q0FBd0M7WUFDeEMsTUFBTSxPQUFPLEdBQUcsT0FBTyxDQUFDLE9BQU8sQ0FBQztZQUNoQyxJQUFJLENBQUMsT0FBTyxFQUFFLENBQUM7Z0JBQ2IsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMseUNBQXlDLENBQUMsQ0FBQztnQkFDN0QsTUFBTSxJQUFJLDRCQUFtQixDQUMzQix5Q0FB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cm9qZWN0cy9tZW50YXJhL21lbnRhcmEtYXBpL3NyYy9iaWxsaW5nL2NvbnRyb2xsZXJzL3N0cmlwZS13ZWJob29rLmNvbnRyb2xsZXIudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgQ29udHJvbGxlcixcbiAgUG9zdCxcbiAgQm9keSxcbiAgSGVhZGVycyxcbiAgSHR0cENvZGUsXG4gIEh0dHBTdGF0dXMsXG4gIExvZ2dlcixcbiAgUmF3Qm9keVJlcXVlc3QsXG4gIFJlcSxcbiAgQmFkUmVxdWVzdEV4Y2VwdGlvbixcbiAgSW50ZXJuYWxTZXJ2ZXJFcnJvckV4Y2VwdGlvbixcbn0gZnJvbSAnQG5lc3Rqcy9jb21tb24nO1xuaW1wb3J0IHtcbiAgQXBpVGFncyxcbiAgQXBpT3BlcmF0aW9uLFxuICBBcGlSZXNwb25zZSxcbiAgQXBpRXhjbHVkZUVuZHBvaW50LFxuICBBcGlCZWFyZXJBdXRoLFxufSBmcm9tICdAbmVzdGpzL3N3YWdnZXInO1xuaW1wb3J0IHsgUmVxdWVzdCB9IGZyb20gJ2V4cHJlc3MnO1xuaW1wb3J0IHsgU3RyaXBlU2VydmljZSB9IGZyb20gJy4uL3NlcnZpY2VzL3N0cmlwZS5zZXJ2aWNlJztcbmltcG9ydCB7IFByaXNtYVNlcnZpY2UgfSBmcm9tICcuLi8uLi9wcm92aWRlcnMvcHJpc21hLWNsaWVudC5wcm92aWRlcic7XG5pbXBvcnQgeyBFdmVudEVtaXR0ZXIyIH0gZnJvbSAnQG5lc3Rqcy9ldmVudC1lbWl0dGVyJztcblxuQEFwaVRhZ3MoJ1N0cmlwZSBXZWJob29rcycpXG5AQXBpVGFncygnc3RyaXBlLXdlYmhvb2snKVxuQEFwaUJlYXJlckF1dGgoJ0pXVC1hdXRoJylcbkBDb250cm9sbGVyKCdiaWxsaW5nL3N0cmlwZS93ZWJob29rcycpXG5leHBvcnQgY2xhc3MgU3RyaXBlV2ViaG9va0NvbnRyb2xsZXIge1xuICBwcml2YXRlIHJlYWRvbmx5IGxvZ2dlciA9IG5ldyBMb2dnZXIoU3RyaXBlV2ViaG9va0NvbnRyb2xsZXIubmFtZSk7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSByZWFkb25seSBzdHJpcGVTZXJ2aWNlOiBTdHJpcGVTZXJ2aWNlLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgcHJpc21hOiBQcmlzbWFTZXJ2aWNlLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgZXZlbnRFbWl0dGVyOiBFdmVudEVtaXR0ZXIyLFxuICApIHt9XG5cbiAgQFBvc3QoKVxuICBASHR0cENvZGUoSHR0cFN0YXR1cy5PSylcbiAgQEFwaUV4Y2x1ZGVFbmRwb2ludCgpIC8vIEhpZGUgZnJvbSBwdWJsaWMgQVBJIGRvY3MgZm9yIHNlY3VyaXR5XG4gIEBBcGlPcGVyYXRpb24oe1xuICAgIHN1bW1hcnk6ICdIYW5kbGUgU3RyaXBlIHdlYmhvb2sgZXZlbnRzJyxcbiAgICBkZXNjcmlwdGlvbjogJ1JlY2VpdmVzIGFuZCBwcm9jZXNzZXMgd2ViaG9vayBldmVudHMgZnJvbSBTdHJpcGUnLFxuICB9KVxuICBAQXBpUmVzcG9uc2Uoe1xuICAgIHN0YXR1czogMjAwLFxuICAgIGRlc2NyaXB0aW9uOiAnV2ViaG9vayBwcm9jZXNzZWQgc3VjY2Vzc2Z1bGx5JyxcbiAgICBzY2hlbWE6IHtcbiAgICAgIHR5cGU6ICdvYmplY3QnLFxuICAgICAgcHJvcGVydGllczoge1xuICAgICAgICByZWNlaXZlZDogeyB0eXBlOiAnYm9vbGVhbicgfSxcbiAgICAgICAgZXZlbnRJZDogeyB0eXBlOiAnc3RyaW5nJyB9LFxuICAgICAgICBldmVudFR5cGU6IHsgdHlwZTogJ3N0cmluZycgfSxcbiAgICAgIH0sXG4gICAgfSxcbiAgfSlcbiAgQEFwaVJlc3BvbnNlKHtcbiAgICBzdGF0dXM6IDQwMCxcbiAgICBkZXNjcmlwdGlvbjogJ0ludmFsaWQgd2ViaG9vayBzaWduYXR1cmUgb3IgcGF5bG9hZCcsXG4gIH0pXG4gIEBBcGlSZXNwb25zZSh7XG4gICAgc3RhdHVzOiA1MDAsXG4gICAgZGVzY3JpcHRpb246ICdFcnJvciBwcm9jZXNzaW5nIHdlYmhvb2snLFxuICB9KVxuICBhc3luYyBoYW5kbGVXZWJob29rKFxuICAgIEBSZXEoKSByZXF1ZXN0OiBSYXdCb2R5UmVxdWVzdDxSZXF1ZXN0PixcbiAgICBAQm9keSgpIGJvZHk6IGFueSxcbiAgICBASGVhZGVycygnc3RyaXBlLXNpZ25hdHVyZScpIHNpZ25hdHVyZTogc3RyaW5nLFxuICApIHtcbiAgICBjb25zdCBzdGFydFRpbWUgPSBEYXRlLm5vdygpO1xuXG4gICAgdHJ5IHtcbiAgICAgIC8vIFZhbGlkYXRlIHJlcXVpcmVkIGhlYWRlcnNcbiAgICAgIGlmICghc2lnbmF0dXJlKSB7XG4gICAgICAgIHRoaXMubG9nZ2VyLmVycm9yKCdNaXNzaW5nIFN0cmlwZSBzaWduYXR1cmUgaGVhZGVyJyk7XG4gICAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0RXhjZXB0aW9uKCdNaXNzaW5nIFN0cmlwZSBzaWduYXR1cmUgaGVhZGVyJyk7XG4gICAgICB9XG5cbiAgICAgIC8vIEdldCByYXcgYm9keSBmb3Igc2lnbmF0dXJlIHZhbGlkYXRpb25cbiAgICAgIGNvbnN0IHJhd0JvZHkgPSByZXF1ZXN0LnJhd0JvZHk7XG4gICAgICBpZiAoIXJhd0JvZHkpIHtcbiAgICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoJ01pc3NpbmcgcmF3IGJvZHkgZm9yIHdlYmhvb2sgdmFsaWRhdGlvbicpO1xuICAgICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdEV4Y2VwdGlvbihcbiAgICAgICAgICAnTWlzc2luZyByYXcgYm9keSBmb3Igd2ViaG9vayB2YWxpZGF0aW9uJyxcbiAgICAgICAgKTtcbiAgICAgIH1cblxuICAgICAgLy8gQ29uc3RydWN0IGFuZCB2YWxpZGF0ZSB3ZWJob29rIGV2ZW50XG4gICAgICBjb25zdCBldmVudCA9IHRoaXMuc3RyaXBlU2VydmljZS5jb25zdHJ1Y3RXZWJob29rRXZlbnQoXG4gICAgICAgIHJhd0JvZHksXG4gICAgICAgIHNpZ25hdHVyZSxcbiAgICAgICk7XG5cbiAgICAgIHRoaXMubG9nZ2VyLmxvZyhgUmVjZWl2ZWQgU3RyaXBlIHdlYmhvb2s6ICR7ZXZlbnQudHlwZX0gKCR7ZXZlbnQuaWR9KWApO1xuXG4gICAgICAvLyBDaGVjayBpZiB3ZSd2ZSBhbHJlYWR5IHByb2Nlc3NlZCB0aGlzIGV2ZW50IChpZGVtcG90ZW5jeSlcbiAgICAgIGNvbnN0IGV4aXN0aW5nRXZlbnQgPSBhd2FpdCB0aGlzLmNoZWNrRXZlbnRJZGVtcG90ZW5jeShldmVudC5pZCk7XG4gICAgICBpZiAoZXhpc3RpbmdFdmVudCkge1xuICAgICAgICB0aGlzLmxvZ2dlci5sb2coYEV2ZW50ICR7ZXZlbnQuaWR9IGFscmVhZHkgcHJvY2Vzc2VkLCBza2lwcGluZ2ApO1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIHJlY2VpdmVkOiB0cnVlLFxuICAgICAgICAgIGV2ZW50SWQ6IGV2ZW50LmlkLFxuICAgICAgICAgIGV2ZW50VHlwZTogZXZlbnQudHlwZSxcbiAgICAgICAgICBtZXNzYWdlOiAnRXZlbnQgYWxyZWFkeSBwcm9jZXNzZWQnLFxuICAgICAgICB9O1xuICAgICAgfVxuXG4gICAgICAvLyBSZWNvcmQgdGhlIGV2ZW50IGFzIGJlaW5nIHByb2Nlc3NlZFxuICAgICAgYXdhaXQgdGhpcy5yZWNvcmRXZWJob29rRXZlbnQoZXZlbnQpO1xuXG4gICAgICAvLyBQcm9jZXNzIHRoZSBldmVudFxuICAgICAgYXdhaXQgdGhpcy5zdHJpcGVTZXJ2aWNlLmhhbmRsZVdlYmhvb2tFdmVudChldmVudCk7XG5cbiAgICAgIC8vIE1hcmsgZXZlbnQgYXMgc3VjY2Vzc2Z1bGx5IHByb2Nlc3NlZFxuICAgICAgYXdhaXQgdGhpcy5tYXJrRXZlbnRQcm9jZXNzZWQoZXZlbnQuaWQsIHRydWUpO1xuXG4gICAgICAvLyBMb2cgcGVyZm9ybWFuY2UgbWV0cmljc1xuICAgICAgY29uc3QgcHJvY2Vzc2luZ1RpbWUgPSBEYXRlLm5vdygpIC0gc3RhcnRUaW1lO1xuICAgICAgdGhpcy5sb2dnZXIubG9nKFxuICAgICAgICBgV2ViaG9vayAke2V2ZW50LnR5cGV9IHByb2Nlc3NlZCBzdWNjZXNzZnVsbHkgaW4gJHtwcm9jZXNzaW5nVGltZX1tc2AsXG4gICAgICApO1xuXG4gICAgICAvLyBFbWl0IGV2ZW50IGZvciBtb25pdG9yaW5nL2FuYWx5dGljc1xuICAgICAgdGhpcy5ldmVudEVtaXR0ZXIuZW1pdCgnc3RyaXBlLndlYmhvb2sucHJvY2Vzc2VkJywge1xuICAgICAgICBldmVudElkOiBldmVudC5pZCxcbiAgICAgICAgZXZlbnRUeXBlOiBldmVudC50eXBlLFxuICAgICAgICBwcm9jZXNzaW5nVGltZSxcbiAgICAgICAgc3VjY2VzczogdHJ1ZSxcbiAgICAgIH0pO1xuXG4gICAgICByZXR1cm4ge1xuICAgICAgICByZWNlaXZlZDogdHJ1ZSxcbiAgICAgICAgZXZlbnRJZDogZXZlbnQuaWQsXG4gICAgICAgIGV2ZW50VHlwZTogZXZlbnQudHlwZSxcbiAgICAgICAgcHJvY2Vzc2luZ1RpbWUsXG4gICAgICB9O1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBjb25zdCBwcm9jZXNzaW5nVGltZSA9IERhdGUubm93KCkgLSBzdGFydFRpbWU7XG5cbiAgICAgIC8vIExvZyB0aGUgZXJyb3Igd2l0aCBjb250ZXh0XG4gICAgICB0aGlzLmxvZ2dlci5lcnJvcihgV2ViaG9vayBwcm9jZXNzaW5nIGZhaWxlZCBpbiAke3Byb2Nlc3NpbmdUaW1lfW1zOmAsIHtcbiAgICAgICAgZXJyb3I6IGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogU3RyaW5nKGVycm9yKSxcbiAgICAgICAgc3RhY2s6IGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5zdGFjayA6IHVuZGVmaW5lZCxcbiAgICAgICAgc2lnbmF0dXJlOiBzaWduYXR1cmU/LnN1YnN0cmluZygwLCAyMCkgKyAnLi4uJyxcbiAgICAgICAgYm9keVR5cGU6IHR5cGVvZiBib2R5LFxuICAgICAgICByYXdCb2R5TGVuZ3RoOiByZXF1ZXN0LnJhd0JvZHk/Lmxlbmd0aCxcbiAgICAgIH0pO1xuXG4gICAgICAvLyBUcnkgdG8gZXh0cmFjdCBldmVudCBpbmZvIGZvciBsb2dnaW5nIGV2ZW4gaWYgcHJvY2Vzc2luZyBmYWlsZWRcbiAgICAgIGxldCBldmVudElkID0gJ3Vua25vd24nO1xuICAgICAgbGV0IGV2ZW50VHlwZSA9ICd1bmtub3duJztcblxuICAgICAgdHJ5IHtcbiAgICAgICAgaWYgKGJvZHkgJiYgdHlwZW9mIGJvZHkgPT09ICdvYmplY3QnKSB7XG4gICAgICAgICAgZXZlbnRJZCA9IGJvZHkuaWQgfHwgJ3Vua25vd24nO1xuICAgICAgICAgIGV2ZW50VHlwZSA9IGJvZHkudHlwZSB8fCAndW5rbm93bic7XG4gICAgICAgIH1cbiAgICAgIH0gY2F0Y2ggKHBhcnNlRXJyb3IpIHtcbiAgICAgICAgLy8gSWdub3JlIHBhcnNpbmcgZXJyb3JzIGZvciBsb2dnaW5nXG4gICAgICB9XG5cbiAgICAgIC8vIE1hcmsgZXZlbnQgYXMgZmFpbGVkIGlmIHdlIGhhdmUgYW4gZXZlbnQgSURcbiAgICAgIGlmIChldmVudElkICE9PSAndW5rbm93bicpIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICBhd2FpdCB0aGlzLm1hcmtFdmVudFByb2Nlc3NlZChcbiAgICAgICAgICAgIGV2ZW50SWQsXG4gICAgICAgICAgICBmYWxzZSxcbiAgICAgICAgICAgIGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogU3RyaW5nKGVycm9yKSxcbiAgICAgICAgICApO1xuICAgICAgICB9IGNhdGNoIChkYkVycm9yKSB7XG4gICAgICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoXG4gICAgICAgICAgICAnRmFpbGVkIHRvIG1hcmsgZXZlbnQgYXMgZmFpbGVkIGluIGRhdGFiYXNlOicsXG4gICAgICAgICAgICBkYkVycm9yLFxuICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgLy8gRW1pdCBlcnJvciBldmVudCBmb3IgbW9uaXRvcmluZ1xuICAgICAgdGhpcy5ldmVudEVtaXR0ZXIuZW1pdCgnc3RyaXBlLndlYmhvb2suZXJyb3InLCB7XG4gICAgICAgIGV2ZW50SWQsXG4gICAgICAgIGV2ZW50VHlwZSxcbiAgICAgICAgcHJvY2Vzc2luZ1RpbWUsXG4gICAgICAgIGVycm9yOiBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6IFN0cmluZyhlcnJvciksXG4gICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgfSk7XG5cbiAgICAgIC8vIFJldHVybiBhcHByb3ByaWF0ZSBlcnJvciByZXNwb25zZVxuICAgICAgaWYgKGVycm9yIGluc3RhbmNlb2YgQmFkUmVxdWVzdEV4Y2VwdGlvbikge1xuICAgICAgICB0aHJvdyBlcnJvcjtcbiAgICAgIH1cblxuICAgICAgdGhyb3cgbmV3IEludGVybmFsU2VydmVyRXJyb3JFeGNlcHRpb24oJ0ZhaWxlZCB0byBwcm9jZXNzIHdlYmhvb2snKTtcbiAgICB9XG4gIH1cblxuICBAUG9zdCgndGVzdCcpXG4gIEBIdHRwQ29kZShIdHRwU3RhdHVzLk9LKVxuICBAQXBpT3BlcmF0aW9uKHtcbiAgICBzdW1tYXJ5OiAnVGVzdCB3ZWJob29rIGVuZHBvaW50JyxcbiAgICBkZXNjcmlwdGlvbjogJ1Rlc3QgZW5kcG9pbnQgZm9yIHdlYmhvb2sgY29ubmVjdGl2aXR5IChkZXZlbG9wbWVudCBvbmx5KScsXG4gIH0pXG4gIEBBcGlSZXNwb25zZSh7XG4gICAgc3RhdHVzOiAyMDAsXG4gICAgZGVzY3JpcHRpb246ICdUZXN0IHdlYmhvb2sgcmVjZWl2ZWQgc3VjY2Vzc2Z1bGx5JyxcbiAgfSlcbiAgYXN5bmMgdGVzdFdlYmhvb2soQEJvZHkoKSBib2R5OiBhbnkpIHtcbiAgICB0cnkge1xuICAgICAgdGhpcy5sb2dnZXIubG9nKCdUZXN0IHdlYmhvb2sgcmVjZWl2ZWQ6JywgYm9keSk7XG5cbiAgICAgIHJldHVybiB7XG4gICAgICAgIHJlY2VpdmVkOiB0cnVlLFxuICAgICAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSxcbiAgICAgICAgbWVzc2FnZTogJ1Rlc3Qgd2ViaG9vayBwcm9jZXNzZWQgc3VjY2Vzc2Z1bGx5JyxcbiAgICAgICAgYm9keTogYm9keSxcbiAgICAgIH07XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRoaXMubG9nZ2VyLmVycm9yKCdUZXN0IHdlYmhvb2sgcHJvY2Vzc2luZyBmYWlsZWQ6JywgZXJyb3IpO1xuICAgICAgdGhyb3cgbmV3IEludGVybmFsU2VydmVyRXJyb3JFeGNlcHRpb24oJ0ZhaWxlZCB0byBwcm9jZXNzIHRlc3Qgd2ViaG9vaycpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBDaGVjayBpZiBldmVudCBoYXMgYWxyZWFkeSBiZWVuIHByb2Nlc3NlZCAoaWRlbXBvdGVuY3kpXG4gICAqL1xuICBwcml2YXRlIGFzeW5jIGNoZWNrRXZlbnRJZGVtcG90ZW5jeShldmVudElkOiBzdHJpbmcpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgZXhpc3RpbmdFdmVudCA9IGF3YWl0IHRoaXMucHJpc21hLnN0cmlwZVdlYmhvb2tFdmVudC5maW5kVW5pcXVlKHtcbiAgICAgICAgd2hlcmU6IHsgZXZlbnRJZCB9LFxuICAgICAgfSk7XG5cbiAgICAgIHJldHVybiAhIWV4aXN0aW5nRXZlbnQ7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRoaXMubG9nZ2VyLmVycm9yKFxuICAgICAgICBgRXJyb3IgY2hlY2tpbmcgZXZlbnQgaWRlbXBvdGVuY3kgZm9yICR7ZXZlbnRJZH06YCxcbiAgICAgICAgZXJyb3IsXG4gICAgICApO1xuICAgICAgcmV0dXJuIGZhbHNlOyAvLyBBbGxvdyBwcm9jZXNzaW5nIGlmIHdlIGNhbid0IGNoZWNrXG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFJlY29yZCB3ZWJob29rIGV2ZW50IGluIGRhdGFiYXNlXG4gICAqL1xuICBwcml2YXRlIGFzeW5jIHJlY29yZFdlYmhvb2tFdmVudChldmVudDogYW55KTogUHJvbWlzZTx2b2lkPiB7XG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IHRoaXMucHJpc21hLnN0cmlwZVdlYmhvb2tFdmVudC5jcmVhdGUoe1xuICAgICAgICBkYXRhOiB7XG4gICAgICAgICAgZXZlbnRJZDogZXZlbnQuaWQsXG4gICAgICAgICAgZXZlbnRUeXBlOiBldmVudC50eXBlLFxuICAgICAgICAgIGV2ZW50RGF0YTogZXZlbnQuZGF0YSxcbiAgICAgICAgICBsaXZlbW9kZTogZXZlbnQubGl2ZW1vZGUsXG4gICAgICAgICAgYXBpVmVyc2lvbjogZXZlbnQuYXBpX3ZlcnNpb24sXG4gICAgICAgICAgY3JlYXRlZDogbmV3IERhdGUoZXZlbnQuY3JlYXRlZCAqIDEwMDApLFxuICAgICAgICAgIHByb2Nlc3NlZDogZmFsc2UsXG4gICAgICAgIH0sXG4gICAgICB9KTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoYEVycm9yIHJlY29yZGluZyB3ZWJob29rIGV2ZW50ICR7ZXZlbnQuaWR9OmAsIGVycm9yKTtcbiAgICAgIC8vIERvbid0IHRocm93IGhlcmUgLSB3ZSBzdGlsbCB3YW50IHRvIHByb2Nlc3MgdGhlIGV2ZW50XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIE1hcmsgZXZlbnQgYXMgcHJvY2Vzc2VkXG4gICAqL1xuICBwcml2YXRlIGFzeW5jIG1hcmtFdmVudFByb2Nlc3NlZChcbiAgICBldmVudElkOiBzdHJpbmcsXG4gICAgc3VjY2VzczogYm9vbGVhbixcbiAgICBlcnJvck1lc3NhZ2U/OiBzdHJpbmcsXG4gICk6IFByb21pc2U8dm9pZD4ge1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCB0aGlzLnByaXNtYS5zdHJpcGVXZWJob29rRXZlbnQudXBkYXRlKHtcbiAgICAgICAgd2hlcmU6IHsgZXZlbnRJZCB9LFxuICAgICAgICBkYXRhOiB7XG4gICAgICAgICAgcHJvY2Vzc2VkOiB0cnVlLFxuICAgICAgICAgIHByb2Nlc3NlZEF0OiBuZXcgRGF0ZSgpLFxuICAgICAgICAgIHN1Y2Nlc3MsXG4gICAgICAgICAgZXJyb3JNZXNzYWdlOiBlcnJvck1lc3NhZ2UgfHwgbnVsbCxcbiAgICAgICAgfSxcbiAgICAgIH0pO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aGlzLmxvZ2dlci5lcnJvcihgRXJyb3IgbWFya2luZyBldmVudCAke2V2ZW50SWR9IGFzIHByb2Nlc3NlZDpgLCBlcnJvcik7XG4gICAgICAvLyBEb24ndCB0aHJvdyBoZXJlIC0gZXZlbnQgcHJvY2Vzc2luZyB3YXMgdGhlIGltcG9ydGFudCBwYXJ0XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEdldCB3ZWJob29rIHByb2Nlc3Npbmcgc3RhdGlzdGljc1xuICAgKi9cbiAgQFBvc3QoJ3N0YXRzJylcbiAgQEh0dHBDb2RlKEh0dHBTdGF0dXMuT0spXG4gIEBBcGlPcGVyYXRpb24oe1xuICAgIHN1bW1hcnk6ICdHZXQgd2ViaG9vayBwcm9jZXNzaW5nIHN0YXRpc3RpY3MnLFxuICAgIGRlc2NyaXB0aW9uOiAnUmV0dXJucyBzdGF0aXN0aWNzIGFib3V0IHdlYmhvb2sgcHJvY2Vzc2luZyAoYWRtaW4gb25seSknLFxuICB9KVxuICBAQXBpUmVzcG9uc2Uoe1xuICAgIHN0YXR1czogMjAwLFxuICAgIGRlc2NyaXB0aW9uOiAnV2ViaG9vayBzdGF0aXN0aWNzIHJldHJpZXZlZCBzdWNjZXNzZnVsbHknLFxuICB9KVxuICBhc3luYyBnZXRXZWJob29rU3RhdHMoKSB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IG5vdyA9IG5ldyBEYXRlKCk7XG4gICAgICBjb25zdCBvbmVEYXlBZ28gPSBuZXcgRGF0ZShub3cuZ2V0VGltZSgpIC0gMjQgKiA2MCAqIDYwICogMTAwMCk7XG4gICAgICBjb25zdCBvbmVXZWVrQWdvID0gbmV3IERhdGUobm93LmdldFRpbWUoKSAtIDcgKiAyNCAqIDYwICogNjAgKiAxMDAwKTtcblxuICAgICAgY29uc3QgW1xuICAgICAgICB0b3RhbEV2ZW50cyxcbiAgICAgICAgcHJvY2Vzc2VkRXZlbnRzLFxuICAgICAgICBmYWlsZWRFdmVudHMsXG4gICAgICAgIHJlY2VudEV2ZW50cyxcbiAgICAgICAgZXZlbnRzQnlUeXBlLFxuICAgICAgXSA9IGF3YWl0IFByb21pc2UuYWxsKFtcbiAgICAgICAgdGhpcy5wcmlzbWEuc3RyaXBlV2ViaG9va0V2ZW50LmNvdW50KCksXG4gICAgICAgIHRoaXMucHJpc21hLnN0cmlwZVdlYmhvb2tFdmVudC5jb3VudCh7XG4gICAgICAgICAgd2hlcmU6IHsgcHJvY2Vzc2VkOiB0cnVlLCBzdWNjZXNzOiB0cnVlIH0sXG4gICAgICAgIH0pLFxuICAgICAgICB0aGlzLnByaXNtYS5zdHJpcGVXZWJob29rRXZlbnQuY291bnQoe1xuICAgICAgICAgIHdoZXJlOiB7IHByb2Nlc3NlZDogdHJ1ZSwgc3VjY2VzczogZmFsc2UgfSxcbiAgICAgICAgfSksXG4gICAgICAgIHRoaXMucHJpc21hLnN0cmlwZVdlYmhvb2tFdmVudC5jb3VudCh7XG4gICAgICAgICAgd2hlcmU6IHsgY3JlYXRlZDogeyBndGU6IG9uZURheUFnbyB9IH0sXG4gICAgICAgIH0pLFxuICAgICAgICB0aGlzLnByaXNtYS5zdHJpcGVXZWJob29rRXZlbnQuZ3JvdXBCeSh7XG4gICAgICAgICAgYnk6IFsnZXZlbnRUeXBlJ10sXG4gICAgICAgICAgd2hlcmU6IHsgY3JlYXRlZDogeyBndGU6IG9uZVdlZWtBZ28gfSB9LFxuICAgICAgICAgIF9jb3VudDogeyBldmVudFR5cGU6IHRydWUgfSxcbiAgICAgICAgfSksXG4gICAgICBdKTtcblxuICAgICAgY29uc3Qgc3VjY2Vzc1JhdGUgPVxuICAgICAgICB0b3RhbEV2ZW50cyA+IDAgPyAocHJvY2Vzc2VkRXZlbnRzIC8gdG90YWxFdmVudHMpICogMTAwIDogMDtcblxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgdG90YWxFdmVudHMsXG4gICAgICAgIHByb2Nlc3NlZEV2ZW50cyxcbiAgICAgICAgZmFpbGVkRXZlbnRzLFxuICAgICAgICByZWNlbnRFdmVudHMsXG4gICAgICAgIHN1Y2Nlc3NSYXRlOiBNYXRoLnJvdW5kKHN1Y2Nlc3NSYXRlICogMTAwKSAvIDEwMCxcbiAgICAgICAgZXZlbnRzQnlUeXBlOiBldmVudHNCeVR5cGUubWFwKChldmVudCkgPT4gKHtcbiAgICAgICAgICBldmVudFR5cGU6IGV2ZW50LmV2ZW50VHlwZSxcbiAgICAgICAgICBjb3VudDogZXZlbnQuX2NvdW50LmV2ZW50VHlwZSxcbiAgICAgICAgfSkpLFxuICAgICAgfTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoJ0Vycm9yIGdldHRpbmcgd2ViaG9vayBzdGF0aXN0aWNzOicsIGVycm9yKTtcbiAgICAgIHRocm93IG5ldyBJbnRlcm5hbFNlcnZlckVycm9yRXhjZXB0aW9uKFxuICAgICAgICAnRmFpbGVkIHRvIGdldCB3ZWJob29rIHN0YXRpc3RpY3MnLFxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogR2V0IHJlY2VudCB3ZWJob29rIGV2ZW50c1xuICAgKi9cbiAgQFBvc3QoJ3JlY2VudCcpXG4gIEBIdHRwQ29kZShIdHRwU3RhdHVzLk9LKVxuICBAQXBpT3BlcmF0aW9uKHtcbiAgICBzdW1tYXJ5OiAnR2V0IHJlY2VudCB3ZWJob29rIGV2ZW50cycsXG4gICAgZGVzY3JpcHRpb246ICdSZXR1cm5zIHJlY2VudCB3ZWJob29rIGV2ZW50cyBmb3IgZGVidWdnaW5nIChhZG1pbiBvbmx5KScsXG4gIH0pXG4gIEBBcGlSZXNwb25zZSh7XG4gICAgc3RhdHVzOiAyMDAsXG4gICAgZGVzY3JpcHRpb246ICdSZWNlbnQgd2ViaG9vayBldmVudHMgcmV0cmlldmVkIHN1Y2Nlc3NmdWxseScsXG4gIH0pXG4gIGFzeW5jIGdldFJlY2VudEV2ZW50cygpIHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgZXZlbnRzID0gYXdhaXQgdGhpcy5wcmlzbWEuc3RyaXBlV2ViaG9va0V2ZW50LmZpbmRNYW55KHtcbiAgICAgICAgc2VsZWN0OiB7XG4gICAgICAgICAgZXZlbnRJZDogdHJ1ZSxcbiAgICAgICAgICBldmVudFR5cGU6IHRydWUsXG4gICAgICAgICAgY3JlYXRlZDogdHJ1ZSxcbiAgICAgICAgICBwcm9jZXNzZWQ6IHRydWUsXG4gICAgICAgICAgcHJvY2Vzc2VkQXQ6IHRydWUsXG4gICAgICAgICAgc3VjY2VzczogdHJ1ZSxcbiAgICAgICAgICBlcnJvck1lc3NhZ2U6IHRydWUsXG4gICAgICAgIH0sXG4gICAgICAgIG9yZGVyQnk6IHsgY3JlYXRlZDogJ2Rlc2MnIH0sXG4gICAgICAgIHRha2U6IDUwLFxuICAgICAgfSk7XG5cbiAgICAgIHJldHVybiB7XG4gICAgICAgIGV2ZW50cyxcbiAgICAgICAgY291bnQ6IGV2ZW50cy5sZW5ndGgsXG4gICAgICB9O1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aGlzLmxvZ2dlci5lcnJvcignRXJyb3IgZ2V0dGluZyByZWNlbnQgd2ViaG9vayBldmVudHM6JywgZXJyb3IpO1xuICAgICAgdGhyb3cgbmV3IEludGVybmFsU2VydmVyRXJyb3JFeGNlcHRpb24oXG4gICAgICAgICdGYWlsZWQgdG8gZ2V0IHJlY2VudCB3ZWJob29rIGV2ZW50cycsXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBSZXRyeSBmYWlsZWQgd2ViaG9vayBldmVudFxuICAgKi9cbiAgQFBvc3QoJ3JldHJ5LzpldmVudElkJylcbiAgQEh0dHBDb2RlKEh0dHBTdGF0dXMuT0spXG4gIEBBcGlPcGVyYXRpb24oe1xuICAgIHN1bW1hcnk6ICdSZXRyeSBmYWlsZWQgd2ViaG9vayBldmVudCcsXG4gICAgZGVzY3JpcHRpb246XG4gICAgICAnTWFudWFsbHkgcmV0cnkgcHJvY2Vzc2luZyBhIGZhaWxlZCB3ZWJob29rIGV2ZW50IChhZG1pbiBvbmx5KScsXG4gIH0pXG4gIEBBcGlSZXNwb25zZSh7XG4gICAgc3RhdHVzOiAyMDAsXG4gICAgZGVzY3JpcHRpb246ICdXZWJob29rIGV2ZW50IHJldHJpZWQgc3VjY2Vzc2Z1bGx5JyxcbiAgfSlcbiAgYXN5bmMgcmV0cnlGYWlsZWRFdmVudChAUmVxKCkgcmVxdWVzdDogYW55KSB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGV2ZW50SWQgPSByZXF1ZXN0LnBhcmFtcy5ldmVudElkO1xuXG4gICAgICAvLyBHZXQgdGhlIGZhaWxlZCBldmVudFxuICAgICAgY29uc3Qgd2ViaG9va0V2ZW50ID0gYXdhaXQgdGhpcy5wcmlzbWEuc3RyaXBlV2ViaG9va0V2ZW50LmZpbmRVbmlxdWUoe1xuICAgICAgICB3aGVyZTogeyBldmVudElkIH0sXG4gICAgICB9KTtcblxuICAgICAgaWYgKCF3ZWJob29rRXZlbnQpIHtcbiAgICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFeGNlcHRpb24oYFdlYmhvb2sgZXZlbnQgJHtldmVudElkfSBub3QgZm91bmRgKTtcbiAgICAgIH1cblxuICAgICAgaWYgKHdlYmhvb2tFdmVudC5zdWNjZXNzKSB7XG4gICAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0RXhjZXB0aW9uKFxuICAgICAgICAgIGBXZWJob29rIGV2ZW50ICR7ZXZlbnRJZH0gYWxyZWFkeSBwcm9jZXNzZWQgc3VjY2Vzc2Z1bGx5YCxcbiAgICAgICAgKTtcbiAgICAgIH1cblxuICAgICAgLy8gUmVjb25zdHJ1Y3QgdGhlIFN0cmlwZSBldmVudCBhbmQgcmV0cnkgcHJvY2Vzc2luZ1xuICAgICAgY29uc3Qgc3RyaXBlRXZlbnQgPSB7XG4gICAgICAgIGlkOiB3ZWJob29rRXZlbnQuZXZlbnRJZCxcbiAgICAgICAgdHlwZTogd2ViaG9va0V2ZW50LmV2ZW50VHlwZSxcbiAgICAgICAgZGF0YTogd2ViaG9va0V2ZW50LmV2ZW50RGF0YSxcbiAgICAgICAgY3JlYXRlZDogTWF0aC5mbG9vcih3ZWJob29rRXZlbnQuY3JlYXRlZC5nZXRUaW1lKCkgLyAxMDAwKSxcbiAgICAgICAgbGl2ZW1vZGU6IHdlYmhvb2tFdmVudC5saXZlbW9kZSxcbiAgICAgICAgYXBpX3ZlcnNpb246IHdlYmhvb2tFdmVudC5hcGlWZXJzaW9uLFxuICAgICAgfTtcblxuICAgICAgLy8gUHJvY2VzcyB0aGUgZXZlbnRcbiAgICAgIGF3YWl0IHRoaXMuc3RyaXBlU2VydmljZS5oYW5kbGVXZWJob29rRXZlbnQoc3RyaXBlRXZlbnQgYXMgYW55KTtcblxuICAgICAgLy8gTWFyayBhcyBzdWNjZXNzZnVsbHkgcHJvY2Vzc2VkXG4gICAgICBhd2FpdCB0aGlzLm1hcmtFdmVudFByb2Nlc3NlZChldmVudElkLCB0cnVlKTtcblxuICAgICAgdGhpcy5sb2dnZXIubG9nKGBTdWNjZXNzZnVsbHkgcmV0cmllZCB3ZWJob29rIGV2ZW50ICR7ZXZlbnRJZH1gKTtcblxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgc3VjY2VzczogdHJ1ZSxcbiAgICAgICAgZXZlbnRJZCxcbiAgICAgICAgbWVzc2FnZTogJ1dlYmhvb2sgZXZlbnQgcmV0cmllZCBzdWNjZXNzZnVsbHknLFxuICAgICAgfTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoJ0Vycm9yIHJldHJ5aW5nIHdlYmhvb2sgZXZlbnQ6JywgZXJyb3IpO1xuICAgICAgdGhyb3cgbmV3IEludGVybmFsU2VydmVyRXJyb3JFeGNlcHRpb24oJ0ZhaWxlZCB0byByZXRyeSB3ZWJob29rIGV2ZW50Jyk7XG4gICAgfVxuICB9XG59XG4iXSwidmVyc2lvbiI6M30=