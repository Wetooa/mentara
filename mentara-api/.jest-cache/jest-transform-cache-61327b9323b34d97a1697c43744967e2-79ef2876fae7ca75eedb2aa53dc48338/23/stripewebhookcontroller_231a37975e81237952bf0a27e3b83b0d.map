{"file":"/home/wetooa/Documents/code/projects/mentara/mentara-api/src/billing/controllers/stripe-webhook.controller.ts","mappings":"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","names":[],"sources":["/home/wetooa/Documents/code/projects/mentara/mentara-api/src/billing/controllers/stripe-webhook.controller.ts"],"sourcesContent":["import {\n  Controller,\n  Post,\n  Body,\n  Headers,\n  HttpCode,\n  HttpStatus,\n  Logger,\n  RawBodyRequest,\n  Req,\n  BadRequestException,\n  InternalServerErrorException,\n} from '@nestjs/common';\nimport {\n  ApiTags,\n  ApiOperation,\n  ApiResponse,\n  ApiExcludeEndpoint,\n  ApiBearerAuth,\n} from '@nestjs/swagger';\nimport { Request } from 'express';\nimport { StripeService } from '../services/stripe.service';\nimport { PrismaService } from '../../providers/prisma-client.provider';\nimport { EventEmitter2 } from '@nestjs/event-emitter';\n\n@ApiTags('Stripe Webhooks')\n@ApiTags('stripe-webhook')\n@ApiBearerAuth('JWT-auth')\n@Controller('billing/stripe/webhooks')\nexport class StripeWebhookController {\n  private readonly logger = new Logger(StripeWebhookController.name);\n\n  constructor(\n    private readonly stripeService: StripeService,\n    private readonly prisma: PrismaService,\n    private readonly eventEmitter: EventEmitter2,\n  ) {}\n\n  @Post()\n  @HttpCode(HttpStatus.OK)\n  @ApiExcludeEndpoint() // Hide from public API docs for security\n  @ApiOperation({\n    summary: 'Handle Stripe webhook events',\n    description: 'Receives and processes webhook events from Stripe',\n  })\n  @ApiResponse({\n    status: 200,\n    description: 'Webhook processed successfully',\n    schema: {\n      type: 'object',\n      properties: {\n        received: { type: 'boolean' },\n        eventId: { type: 'string' },\n        eventType: { type: 'string' },\n      },\n    },\n  })\n  @ApiResponse({\n    status: 400,\n    description: 'Invalid webhook signature or payload',\n  })\n  @ApiResponse({\n    status: 500,\n    description: 'Error processing webhook',\n  })\n  async handleWebhook(\n    @Req() request: RawBodyRequest<Request>,\n    @Body() body: any,\n    @Headers('stripe-signature') signature: string,\n  ) {\n    const startTime = Date.now();\n\n    try {\n      // Validate required headers\n      if (!signature) {\n        this.logger.error('Missing Stripe signature header');\n        throw new BadRequestException('Missing Stripe signature header');\n      }\n\n      // Get raw body for signature validation\n      const rawBody = request.rawBody;\n      if (!rawBody) {\n        this.logger.error('Missing raw body for webhook validation');\n        throw new BadRequestException(\n          'Missing raw body for webhook validation',\n        );\n      }\n\n      // Construct and validate webhook event\n      const event = this.stripeService.constructWebhookEvent(\n        rawBody,\n        signature,\n      );\n\n      this.logger.log(`Received Stripe webhook: ${event.type} (${event.id})`);\n\n      // Check if we've already processed this event (idempotency)\n      const existingEvent = await this.checkEventIdempotency(event.id);\n      if (existingEvent) {\n        this.logger.log(`Event ${event.id} already processed, skipping`);\n        return {\n          received: true,\n          eventId: event.id,\n          eventType: event.type,\n          message: 'Event already processed',\n        };\n      }\n\n      // Record the event as being processed\n      await this.recordWebhookEvent(event);\n\n      // Process the event\n      await this.stripeService.handleWebhookEvent(event);\n\n      // Mark event as successfully processed\n      await this.markEventProcessed(event.id, true);\n\n      // Log performance metrics\n      const processingTime = Date.now() - startTime;\n      this.logger.log(\n        `Webhook ${event.type} processed successfully in ${processingTime}ms`,\n      );\n\n      // Emit event for monitoring/analytics\n      this.eventEmitter.emit('stripe.webhook.processed', {\n        eventId: event.id,\n        eventType: event.type,\n        processingTime,\n        success: true,\n      });\n\n      return {\n        received: true,\n        eventId: event.id,\n        eventType: event.type,\n        processingTime,\n      };\n    } catch (error) {\n      const processingTime = Date.now() - startTime;\n\n      // Log the error with context\n      this.logger.error(`Webhook processing failed in ${processingTime}ms:`, {\n        error: error instanceof Error ? error.message : String(error),\n        stack: error instanceof Error ? error.stack : undefined,\n        signature: signature?.substring(0, 20) + '...',\n        bodyType: typeof body,\n        rawBodyLength: request.rawBody?.length,\n      });\n\n      // Try to extract event info for logging even if processing failed\n      let eventId = 'unknown';\n      let eventType = 'unknown';\n\n      try {\n        if (body && typeof body === 'object') {\n          eventId = body.id || 'unknown';\n          eventType = body.type || 'unknown';\n        }\n      } catch (parseError) {\n        // Ignore parsing errors for logging\n      }\n\n      // Mark event as failed if we have an event ID\n      if (eventId !== 'unknown') {\n        try {\n          await this.markEventProcessed(\n            eventId,\n            false,\n            error instanceof Error ? error.message : String(error),\n          );\n        } catch (dbError) {\n          this.logger.error(\n            'Failed to mark event as failed in database:',\n            dbError,\n          );\n        }\n      }\n\n      // Emit error event for monitoring\n      this.eventEmitter.emit('stripe.webhook.error', {\n        eventId,\n        eventType,\n        processingTime,\n        error: error instanceof Error ? error.message : String(error),\n        success: false,\n      });\n\n      // Return appropriate error response\n      if (error instanceof BadRequestException) {\n        throw error;\n      }\n\n      throw new InternalServerErrorException('Failed to process webhook');\n    }\n  }\n\n  @Post('test')\n  @HttpCode(HttpStatus.OK)\n  @ApiOperation({\n    summary: 'Test webhook endpoint',\n    description: 'Test endpoint for webhook connectivity (development only)',\n  })\n  @ApiResponse({\n    status: 200,\n    description: 'Test webhook received successfully',\n  })\n  async testWebhook(@Body() body: any) {\n    try {\n      this.logger.log('Test webhook received:', body);\n\n      return {\n        received: true,\n        timestamp: new Date().toISOString(),\n        message: 'Test webhook processed successfully',\n        body: body,\n      };\n    } catch (error) {\n      this.logger.error('Test webhook processing failed:', error);\n      throw new InternalServerErrorException('Failed to process test webhook');\n    }\n  }\n\n  /**\n   * Check if event has already been processed (idempotency)\n   */\n  private async checkEventIdempotency(eventId: string): Promise<boolean> {\n    try {\n      const existingEvent = await this.prisma.stripeWebhookEvent.findUnique({\n        where: { eventId },\n      });\n\n      return !!existingEvent;\n    } catch (error) {\n      this.logger.error(\n        `Error checking event idempotency for ${eventId}:`,\n        error,\n      );\n      return false; // Allow processing if we can't check\n    }\n  }\n\n  /**\n   * Record webhook event in database\n   */\n  private async recordWebhookEvent(event: any): Promise<void> {\n    try {\n      await this.prisma.stripeWebhookEvent.create({\n        data: {\n          eventId: event.id,\n          eventType: event.type,\n          eventData: event.data,\n          livemode: event.livemode,\n          apiVersion: event.api_version,\n          created: new Date(event.created * 1000),\n          processed: false,\n        },\n      });\n    } catch (error) {\n      this.logger.error(`Error recording webhook event ${event.id}:`, error);\n      // Don't throw here - we still want to process the event\n    }\n  }\n\n  /**\n   * Mark event as processed\n   */\n  private async markEventProcessed(\n    eventId: string,\n    success: boolean,\n    errorMessage?: string,\n  ): Promise<void> {\n    try {\n      await this.prisma.stripeWebhookEvent.update({\n        where: { eventId },\n        data: {\n          processed: true,\n          processedAt: new Date(),\n          success,\n          errorMessage: errorMessage || null,\n        },\n      });\n    } catch (error) {\n      this.logger.error(`Error marking event ${eventId} as processed:`, error);\n      // Don't throw here - event processing was the important part\n    }\n  }\n\n  /**\n   * Get webhook processing statistics\n   */\n  @Post('stats')\n  @HttpCode(HttpStatus.OK)\n  @ApiOperation({\n    summary: 'Get webhook processing statistics',\n    description: 'Returns statistics about webhook processing (admin only)',\n  })\n  @ApiResponse({\n    status: 200,\n    description: 'Webhook statistics retrieved successfully',\n  })\n  async getWebhookStats() {\n    try {\n      const now = new Date();\n      const oneDayAgo = new Date(now.getTime() - 24 * 60 * 60 * 1000);\n      const oneWeekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);\n\n      const [\n        totalEvents,\n        processedEvents,\n        failedEvents,\n        recentEvents,\n        eventsByType,\n      ] = await Promise.all([\n        this.prisma.stripeWebhookEvent.count(),\n        this.prisma.stripeWebhookEvent.count({\n          where: { processed: true, success: true },\n        }),\n        this.prisma.stripeWebhookEvent.count({\n          where: { processed: true, success: false },\n        }),\n        this.prisma.stripeWebhookEvent.count({\n          where: { created: { gte: oneDayAgo } },\n        }),\n        this.prisma.stripeWebhookEvent.groupBy({\n          by: ['eventType'],\n          where: { created: { gte: oneWeekAgo } },\n          _count: { eventType: true },\n        }),\n      ]);\n\n      const successRate =\n        totalEvents > 0 ? (processedEvents / totalEvents) * 100 : 0;\n\n      return {\n        totalEvents,\n        processedEvents,\n        failedEvents,\n        recentEvents,\n        successRate: Math.round(successRate * 100) / 100,\n        eventsByType: eventsByType.map((event) => ({\n          eventType: event.eventType,\n          count: event._count.eventType,\n        })),\n      };\n    } catch (error) {\n      this.logger.error('Error getting webhook statistics:', error);\n      throw new InternalServerErrorException(\n        'Failed to get webhook statistics',\n      );\n    }\n  }\n\n  /**\n   * Get recent webhook events\n   */\n  @Post('recent')\n  @HttpCode(HttpStatus.OK)\n  @ApiOperation({\n    summary: 'Get recent webhook events',\n    description: 'Returns recent webhook events for debugging (admin only)',\n  })\n  @ApiResponse({\n    status: 200,\n    description: 'Recent webhook events retrieved successfully',\n  })\n  async getRecentEvents() {\n    try {\n      const events = await this.prisma.stripeWebhookEvent.findMany({\n        select: {\n          eventId: true,\n          eventType: true,\n          created: true,\n          processed: true,\n          processedAt: true,\n          success: true,\n          errorMessage: true,\n        },\n        orderBy: { created: 'desc' },\n        take: 50,\n      });\n\n      return {\n        events,\n        count: events.length,\n      };\n    } catch (error) {\n      this.logger.error('Error getting recent webhook events:', error);\n      throw new InternalServerErrorException(\n        'Failed to get recent webhook events',\n      );\n    }\n  }\n\n  /**\n   * Retry failed webhook event\n   */\n  @Post('retry/:eventId')\n  @HttpCode(HttpStatus.OK)\n  @ApiOperation({\n    summary: 'Retry failed webhook event',\n    description:\n      'Manually retry processing a failed webhook event (admin only)',\n  })\n  @ApiResponse({\n    status: 200,\n    description: 'Webhook event retried successfully',\n  })\n  async retryFailedEvent(@Req() request: any) {\n    try {\n      const eventId = request.params.eventId;\n\n      // Get the failed event\n      const webhookEvent = await this.prisma.stripeWebhookEvent.findUnique({\n        where: { eventId },\n      });\n\n      if (!webhookEvent) {\n        throw new BadRequestException(`Webhook event ${eventId} not found`);\n      }\n\n      if (webhookEvent.success) {\n        throw new BadRequestException(\n          `Webhook event ${eventId} already processed successfully`,\n        );\n      }\n\n      // Reconstruct the Stripe event and retry processing\n      const stripeEvent = {\n        id: webhookEvent.eventId,\n        type: webhookEvent.eventType,\n        data: webhookEvent.eventData,\n        created: Math.floor(webhookEvent.created.getTime() / 1000),\n        livemode: webhookEvent.livemode,\n        api_version: webhookEvent.apiVersion,\n      };\n\n      // Process the event\n      await this.stripeService.handleWebhookEvent(stripeEvent as any);\n\n      // Mark as successfully processed\n      await this.markEventProcessed(eventId, true);\n\n      this.logger.log(`Successfully retried webhook event ${eventId}`);\n\n      return {\n        success: true,\n        eventId,\n        message: 'Webhook event retried successfully',\n      };\n    } catch (error) {\n      this.logger.error('Error retrying webhook event:', error);\n      throw new InternalServerErrorException('Failed to retry webhook event');\n    }\n  }\n}\n"],"version":3}