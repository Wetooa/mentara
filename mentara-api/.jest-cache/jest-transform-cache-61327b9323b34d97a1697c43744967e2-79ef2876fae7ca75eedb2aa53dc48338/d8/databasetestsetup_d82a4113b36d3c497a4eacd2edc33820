c5293d46ff1871850fde199f7ab4a7ce
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.DatabaseTestSetup = void 0;
const testing_1 = require("@nestjs/testing");
const prisma_client_provider_1 = require("../providers/prisma-client.provider");
const postgresql_1 = require("@testcontainers/postgresql");
class DatabaseTestSetup {
    static container;
    static prismaService;
    static cleanupStats = [];
    static async startContainer() {
        if (!this.container) {
            this.container = await new postgresql_1.PostgreSqlContainer('postgres:15')
                .withDatabase('mentara_test')
                .withUsername('test_user')
                .withPassword('test_password')
                .withExposedPorts(5432)
                .withEnvironment({
                POSTGRES_INITDB_ARGS: '--auth-host=scram-sha-256',
            })
                .start();
        }
        return this.container;
    }
    static async setupTestDatabase() {
        const container = await this.startContainer();
        // Set environment variable for test database
        process.env.DATABASE_URL = container.getConnectionUri();
        const module = await testing_1.Test.createTestingModule({
            providers: [prisma_client_provider_1.PrismaService],
        }).compile();
        this.prismaService = module.get(prisma_client_provider_1.PrismaService);
        // Run migrations
        // eslint-disable-next-line @typescript-eslint/no-require-imports
        const { execSync } = require('child_process');
        execSync('npx prisma migrate deploy', {
            env: { ...process.env, DATABASE_URL: container.getConnectionUri() },
        });
        return this.prismaService;
    }
    /**
     * Enhanced database cleanup with comprehensive table coverage
     * Includes all 18+ Prisma models and their relationships
     */
    static async cleanupDatabase() {
        const startTime = Date.now();
        const stats = {
            tablesProcessed: 0,
            recordsDeleted: 0,
            errors: [],
            duration: 0,
        };
        if (!this.prismaService) {
            stats.errors.push('PrismaService not initialized');
            return stats;
        }
        // Comprehensive table cleanup order respecting all foreign key constraints
        // Order is critical: child tables first, parent tables last
        const tableCleanupOrder = [
            // Messaging system (deepest dependencies)
            'TypingIndicator',
            'MessageReaction',
            'MessageReadReceipt',
            'Message',
            'ConversationParticipant',
            'Conversation',
            'UserBlock',
            // Community content (posts, comments, replies)
            'ReplyHeart',
            'Reply',
            'CommentHeart',
            'Comment',
            'PostHeart',
            'Post',
            'Membership',
            'Room',
            'RoomGroup',
            'Community',
            // Analytics and matching
            'RecommendationFeedback',
            'AlgorithmPerformance',
            'ClientCompatibility',
            'MatchHistory',
            'MatchingWeight',
            // Reviews and ratings
            'ReviewHelpful',
            'Review',
            // Sessions and meetings
            'SessionLog',
            'Meeting',
            'TherapyProgress',
            'TherapistAvailability',
            // Assessments and worksheets
            'Assessment',
            'MentalHealthIndicator',
            'Worksheet',
            'PreAssessment',
            // File management
            'FileDownload',
            'FileShare',
            'FileVersion',
            'File',
            // Billing and subscriptions
            'DiscountRedemption',
            'PaymentMethod',
            'Subscription',
            // Notifications and activities
            'Notification',
            'NotificationSettings',
            'UserActivity',
            'AuditLog',
            // Client-therapist relationships
            'ClientPreference',
            'ClientMedicalHistory',
            'ClientTherapist',
            // Role-specific profiles
            'Therapist',
            'Client',
            'Moderator',
            'ModeratorCommunity',
            'Admin',
            // Core user table (must be last)
            'User',
        ];
        // Process each table with enhanced error handling and statistics
        for (const tableName of tableCleanupOrder) {
            try {
                // Get count before deletion for statistics
                const countQuery = `SELECT COUNT(*) as count FROM "${tableName}"`;
                const countResult = await this.prismaService.$queryRawUnsafe(countQuery);
                const recordCount = parseInt(countResult[0]?.count || '0', 10);
                if (recordCount > 0) {
                    // Use TRUNCATE for better performance and to reset sequences
                    await this.prismaService.$executeRawUnsafe(`TRUNCATE TABLE "${tableName}" RESTART IDENTITY CASCADE;`);
                    stats.recordsDeleted += recordCount;
                }
                stats.tablesProcessed++;
            }
            catch (error) {
                // Log error but continue with cleanup
                const errorMessage = error instanceof Error ? error.message : String(error);
                // Only log as error if it's not a "table doesn't exist" error
                if (!errorMessage.includes('does not exist')) {
                    stats.errors.push(`${tableName}: ${errorMessage}`);
                }
                // Try alternative cleanup method for problematic tables
                try {
                    await this.prismaService.$executeRawUnsafe(`DELETE FROM "${tableName}";`);
                    stats.tablesProcessed++;
                }
                catch (alternativeError) {
                    const altErrorMessage = alternativeError instanceof Error
                        ? alternativeError.message
                        : String(alternativeError);
                    if (!altErrorMessage.includes('does not exist')) {
                        stats.errors.push(`${tableName} (alternative): ${altErrorMessage}`);
                    }
                }
            }
        }
        // Reset all sequences to ensure consistent test data
        try {
            const sequenceResetQueries = [
                "SELECT setval(pg_get_serial_sequence('\"User\"', 'id'), 1, false);",
                "SELECT setval(pg_get_serial_sequence('\"Community\"', 'id'), 1, false);",
                "SELECT setval(pg_get_serial_sequence('\"Conversation\"', 'id'), 1, false);",
                "SELECT setval(pg_get_serial_sequence('\"Meeting\"', 'id'), 1, false);",
            ];
            for (const query of sequenceResetQueries) {
                try {
                    await this.prismaService.$executeRawUnsafe(query);
                }
                catch {
                    // Ignore sequence reset errors (sequence might not exist)
                }
            }
        }
        catch {
            // Ignore sequence reset errors
        }
        stats.duration = Date.now() - startTime;
        this.cleanupStats.push(stats);
        // Log cleanup statistics in debug mode
        if (process.env.DEBUG_TESTS === 'true') {
            console.log(`üßπ Database Cleanup Complete:
        üìä Tables Processed: ${stats.tablesProcessed}
        üóëÔ∏è  Records Deleted: ${stats.recordsDeleted}
        ‚è±Ô∏è  Duration: ${stats.duration}ms
        ‚ùå Errors: ${stats.errors.length}
      `);
            if (stats.errors.length > 0) {
                console.log('Cleanup Errors:', stats.errors);
            }
        }
        return stats;
    }
    /**
     * Enhanced cleanup for specific test scenarios
     */
    static async cleanupMessagingData() {
        if (!this.prismaService)
            return;
        const messagingTables = [
            'TypingIndicator',
            'MessageReaction',
            'MessageReadReceipt',
            'Message',
            'ConversationParticipant',
            'Conversation',
            'UserBlock',
        ];
        for (const table of messagingTables) {
            try {
                await this.prismaService.$executeRawUnsafe(`TRUNCATE TABLE "${table}" RESTART IDENTITY CASCADE;`);
            }
            catch {
                // Ignore errors for non-existent tables
            }
        }
    }
    static async cleanupAnalyticsData() {
        if (!this.prismaService)
            return;
        const analyticsTables = [
            'RecommendationFeedback',
            'AlgorithmPerformance',
            'ClientCompatibility',
            'MatchHistory',
            'MatchingWeight',
        ];
        for (const table of analyticsTables) {
            try {
                await this.prismaService.$executeRawUnsafe(`TRUNCATE TABLE "${table}" RESTART IDENTITY CASCADE;`);
            }
            catch {
                // Ignore errors for non-existent tables
            }
        }
    }
    static async cleanupCommunityData() {
        if (!this.prismaService)
            return;
        const communityTables = [
            'ReplyHeart',
            'Reply',
            'CommentHeart',
            'Comment',
            'PostHeart',
            'Post',
            'Membership',
            'Room',
            'RoomGroup',
            'Community',
        ];
        for (const table of communityTables) {
            try {
                await this.prismaService.$executeRawUnsafe(`TRUNCATE TABLE "${table}" RESTART IDENTITY CASCADE;`);
            }
            catch {
                // Ignore errors for non-existent tables
            }
        }
    }
    /**
     * Verify database connectivity and schema integrity
     */
    static async verifyDatabaseHealth() {
        const health = {
            isConnected: false,
            schemaValid: false,
            tableCount: 0,
            errors: [],
        };
        try {
            // Test basic connectivity
            await this.prismaService.$queryRaw `SELECT 1`;
            health.isConnected = true;
            // Count tables in the database
            const tableCountResult = await this.prismaService.$queryRaw `
        SELECT COUNT(*) as count 
        FROM information_schema.tables 
        WHERE table_schema = 'public'
      `;
            health.tableCount = Number(tableCountResult[0]?.count || 0);
            // Verify key tables exist
            const keyTables = ['User', 'Client', 'Therapist', 'Meeting', 'Community'];
            for (const table of keyTables) {
                try {
                    await this.prismaService.$queryRawUnsafe(`SELECT 1 FROM "${table}" LIMIT 1`);
                }
                catch (error) {
                    health.errors.push(`Missing or inaccessible table: ${table}`);
                }
            }
            health.schemaValid = health.errors.length === 0;
        }
        catch (error) {
            const errorMessage = error instanceof Error ? error.message : String(error);
            health.errors.push(`Database connection error: ${errorMessage}`);
        }
        return health;
    }
    /**
     * Get cleanup statistics for performance monitoring
     */
    static getCleanupStatistics() {
        return [...this.cleanupStats];
    }
    /**
     * Reset cleanup statistics
     */
    static resetCleanupStatistics() {
        this.cleanupStats = [];
    }
    static async stopContainer() {
        if (this.container) {
            await this.container.stop();
        }
    }
    static getPrismaService() {
        return this.prismaService;
    }
    /**
     * Enhanced container management with health checks
     */
    static async restartContainer() {
        if (this.container) {
            await this.container.stop();
            this.container = null;
        }
        await this.startContainer();
    }
    /**
     * Performance monitoring for test database operations
     */
    static async measureDatabasePerformance(operation, operationName) {
        const startTime = Date.now();
        const startMemory = process.memoryUsage().heapUsed;
        try {
            const result = await operation();
            const endTime = Date.now();
            const endMemory = process.memoryUsage().heapUsed;
            const performance = {
                result,
                duration: endTime - startTime,
                memoryUsage: endMemory - startMemory,
            };
            if (process.env.TRACK_TEST_PERFORMANCE === 'true') {
                console.log(`üìä ${operationName} Performance:
          ‚è±Ô∏è  Duration: ${performance.duration}ms
          üß† Memory: ${(performance.memoryUsage / 1024 / 1024).toFixed(2)}MB
        `);
            }
            return performance;
        }
        catch (error) {
            const endTime = Date.now();
            console.error(`‚ùå ${operationName} failed after ${endTime - startTime}ms:`, error);
            throw error;
        }
    }
}
exports.DatabaseTestSetup = DatabaseTestSetup;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL3Rlc3QtdXRpbHMvZGF0YWJhc2UtdGVzdC5zZXR1cC50cyIsIm1hcHBpbmdzIjoiOzs7QUFBQSw2Q0FBc0Q7QUFDdEQsZ0ZBQW9FO0FBQ3BFLDJEQUdvQztBQVNwQyxNQUFhLGlCQUFpQjtJQUNwQixNQUFNLENBQUMsU0FBUyxDQUE2QjtJQUM3QyxNQUFNLENBQUMsYUFBYSxDQUFnQjtJQUNwQyxNQUFNLENBQUMsWUFBWSxHQUFtQixFQUFFLENBQUM7SUFFakQsTUFBTSxDQUFDLEtBQUssQ0FBQyxjQUFjO1FBQ3pCLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFLENBQUM7WUFDcEIsSUFBSSxDQUFDLFNBQVMsR0FBRyxNQUFNLElBQUksZ0NBQW1CLENBQUMsYUFBYSxDQUFDO2lCQUMxRCxZQUFZLENBQUMsY0FBYyxDQUFDO2lCQUM1QixZQUFZLENBQUMsV0FBVyxDQUFDO2lCQUN6QixZQUFZLENBQUMsZUFBZSxDQUFDO2lCQUM3QixnQkFBZ0IsQ0FBQyxJQUFJLENBQUM7aUJBQ3RCLGVBQWUsQ0FBQztnQkFDZixvQkFBb0IsRUFBRSwyQkFBMkI7YUFDbEQsQ0FBQztpQkFDRCxLQUFLLEVBQUUsQ0FBQztRQUNiLENBQUM7UUFDRCxPQUFPLElBQUksQ0FBQyxTQUFTLENBQUM7SUFDeEIsQ0FBQztJQUVELE1BQU0sQ0FBQyxLQUFLLENBQUMsaUJBQWlCO1FBQzVCLE1BQU0sU0FBUyxHQUFHLE1BQU0sSUFBSSxDQUFDLGNBQWMsRUFBRSxDQUFDO1FBRTlDLDZDQUE2QztRQUM3QyxPQUFPLENBQUMsR0FBRyxDQUFDLFlBQVksR0FBRyxTQUFTLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztRQUV4RCxNQUFNLE1BQU0sR0FBa0IsTUFBTSxjQUFJLENBQUMsbUJBQW1CLENBQUM7WUFDM0QsU0FBUyxFQUFFLENBQUMsc0NBQWEsQ0FBQztTQUMzQixDQUFDLENBQUMsT0FBTyxFQUFFLENB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UyxLQUFLLEVBQzNELEtBQUssQ0FDTixDQUFDO1lBQ0YsTUFBTSxLQUFLLENBQUM7UUFDZCxDQUFDO0lBQ0gsQ0FBQzs7QUE3YUgsOENBOGFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9ob21lL3dldG9vYS9Eb2N1bWVudHMvY29kZS9wcm9qZWN0cy9tZW50YXJhL21lbnRhcmEtYXBpL3NyYy90ZXN0LXV0aWxzL2RhdGFiYXNlLXRlc3Quc2V0dXAudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgVGVzdCwgVGVzdGluZ01vZHVsZSB9IGZyb20gJ0BuZXN0anMvdGVzdGluZyc7XG5pbXBvcnQgeyBQcmlzbWFTZXJ2aWNlIH0gZnJvbSAnLi4vcHJvdmlkZXJzL3ByaXNtYS1jbGllbnQucHJvdmlkZXInO1xuaW1wb3J0IHtcbiAgUG9zdGdyZVNxbENvbnRhaW5lcixcbiAgU3RhcnRlZFBvc3RncmVTcWxDb250YWluZXIsXG59IGZyb20gJ0B0ZXN0Y29udGFpbmVycy9wb3N0Z3Jlc3FsJztcblxuaW50ZXJmYWNlIENsZWFudXBTdGF0cyB7XG4gIHRhYmxlc1Byb2Nlc3NlZDogbnVtYmVyO1xuICByZWNvcmRzRGVsZXRlZDogbnVtYmVyO1xuICBlcnJvcnM6IHN0cmluZ1tdO1xuICBkdXJhdGlvbjogbnVtYmVyO1xufVxuXG5leHBvcnQgY2xhc3MgRGF0YWJhc2VUZXN0U2V0dXAge1xuICBwcml2YXRlIHN0YXRpYyBjb250YWluZXI6IFN0YXJ0ZWRQb3N0Z3JlU3FsQ29udGFpbmVyO1xuICBwcml2YXRlIHN0YXRpYyBwcmlzbWFTZXJ2aWNlOiBQcmlzbWFTZXJ2aWNlO1xuICBwcml2YXRlIHN0YXRpYyBjbGVhbnVwU3RhdHM6IENsZWFudXBTdGF0c1tdID0gW107XG5cbiAgc3RhdGljIGFzeW5jIHN0YXJ0Q29udGFpbmVyKCk6IFByb21pc2U8U3RhcnRlZFBvc3RncmVTcWxDb250YWluZXI+IHtcbiAgICBpZiAoIXRoaXMuY29udGFpbmVyKSB7XG4gICAgICB0aGlzLmNvbnRhaW5lciA9IGF3YWl0IG5ldyBQb3N0Z3JlU3FsQ29udGFpbmVyKCdwb3N0Z3JlczoxNScpXG4gICAgICAgIC53aXRoRGF0YWJhc2UoJ21lbnRhcmFfdGVzdCcpXG4gICAgICAgIC53aXRoVXNlcm5hbWUoJ3Rlc3RfdXNlcicpXG4gICAgICAgIC53aXRoUGFzc3dvcmQoJ3Rlc3RfcGFzc3dvcmQnKVxuICAgICAgICAud2l0aEV4cG9zZWRQb3J0cyg1NDMyKVxuICAgICAgICAud2l0aEVudmlyb25tZW50KHtcbiAgICAgICAgICBQT1NUR1JFU19JTklUREJfQVJHUzogJy0tYXV0aC1ob3N0PXNjcmFtLXNoYS0yNTYnLFxuICAgICAgICB9KVxuICAgICAgICAuc3RhcnQoKTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuY29udGFpbmVyO1xuICB9XG5cbiAgc3RhdGljIGFzeW5jIHNldHVwVGVzdERhdGFiYXNlKCk6IFByb21pc2U8UHJpc21hU2VydmljZT4ge1xuICAgIGNvbnN0IGNvbnRhaW5lciA9IGF3YWl0IHRoaXMuc3RhcnRDb250YWluZXIoKTtcblxuICAgIC8vIFNldCBlbnZpcm9ubWVudCB2YXJpYWJsZSBmb3IgdGVzdCBkYXRhYmFzZVxuICAgIHByb2Nlc3MuZW52LkRBVEFCQVNFX1VSTCA9IGNvbnRhaW5lci5nZXRDb25uZWN0aW9uVXJpKCk7XG5cbiAgICBjb25zdCBtb2R1bGU6IFRlc3RpbmdNb2R1bGUgPSBhd2FpdCBUZXN0LmNyZWF0ZVRlc3RpbmdNb2R1bGUoe1xuICAgICAgcHJvdmlkZXJzOiBbUHJpc21hU2VydmljZV0sXG4gICAgfSkuY29tcGlsZSgpO1xuXG4gICAgdGhpcy5wcmlzbWFTZXJ2aWNlID0gbW9kdWxlLmdldDxQcmlzbWFTZXJ2aWNlPihQcmlzbWFTZXJ2aWNlKTtcblxuICAgIC8vIFJ1biBtaWdyYXRpb25zXG4gICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby1yZXF1aXJlLWltcG9ydHNcbiAgICBjb25zdCB7IGV4ZWNTeW5jIH0gPSByZXF1aXJlKCdjaGlsZF9wcm9jZXNzJyk7XG4gICAgZXhlY1N5bmMoJ25weCBwcmlzbWEgbWlncmF0ZSBkZXBsb3knLCB7XG4gICAgICBlbnY6IHsgLi4ucHJvY2Vzcy5lbnYsIERBVEFCQVNFX1VSTDogY29udGFpbmVyLmdldENvbm5lY3Rpb25VcmkoKSB9LFxuICAgIH0pO1xuXG4gICAgcmV0dXJuIHRoaXMucHJpc21hU2VydmljZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBFbmhhbmNlZCBkYXRhYmFzZSBjbGVhbnVwIHdpdGggY29tcHJlaGVuc2l2ZSB0YWJsZSBjb3ZlcmFnZVxuICAgKiBJbmNsdWRlcyBhbGwgMTgrIFByaXNtYSBtb2RlbHMgYW5kIHRoZWlyIHJlbGF0aW9uc2hpcHNcbiAgICovXG4gIHN0YXRpYyBhc3luYyBjbGVhbnVwRGF0YWJhc2UoKTogUHJvbWlzZTxDbGVhbnVwU3RhdHM+IHtcbiAgICBjb25zdCBzdGFydFRpbWUgPSBEYXRlLm5vdygpO1xuICAgIGNvbnN0IHN0YXRzOiBDbGVhbnVwU3RhdHMgPSB7XG4gICAgICB0YWJsZXNQcm9jZXNzZWQ6IDAsXG4gICAgICByZWNvcmRzRGVsZXRlZDogMCxcbiAgICAgIGVycm9yczogW10sXG4gICAgICBkdXJhdGlvbjogMCxcbiAgICB9O1xuXG4gICAgaWYgKCF0aGlzLnByaXNtYVNlcnZpY2UpIHtcbiAgICAgIHN0YXRzLmVycm9ycy5wdXNoKCdQcmlzbWFTZXJ2aWNlIG5vdCBpbml0aWFsaXplZCcpO1xuICAgICAgcmV0dXJuIHN0YXRzO1xuICAgIH1cblxuICAgIC8vIENvbXByZWhlbnNpdmUgdGFibGUgY2xlYW51cCBvcmRlciByZXNwZWN0aW5nIGFsbCBmb3JlaWduIGtleSBjb25zdHJhaW50c1xuICAgIC8vIE9yZGVyIGlzIGNyaXRpY2FsOiBjaGlsZCB0YWJsZXMgZmlyc3QsIHBhcmVudCB0YWJsZXMgbGFzdFxuICAgIGNvbnN0IHRhYmxlQ2xlYW51cE9yZGVyID0gW1xuICAgICAgLy8gTWVzc2FnaW5nIHN5c3RlbSAoZGVlcGVzdCBkZXBlbmRlbmNpZXMpXG4gICAgICAnVHlwaW5nSW5kaWNhdG9yJyxcbiAgICAgICdNZXNzYWdlUmVhY3Rpb24nLFxuICAgICAgJ01lc3NhZ2VSZWFkUmVjZWlwdCcsXG4gICAgICAnTWVzc2FnZScsXG4gICAgICAnQ29udmVyc2F0aW9uUGFydGljaXBhbnQnLFxuICAgICAgJ0NvbnZlcnNhdGlvbicsXG4gICAgICAnVXNlckJsb2NrJyxcblxuICAgICAgLy8gQ29tbXVuaXR5IGNvbnRlbnQgKHBvc3RzLCBjb21tZW50cywgcmVwbGllcylcbiAgICAgICdSZXBseUhlYXJ0JyxcbiAgICAgICdSZXBseScsXG4gICAgICAnQ29tbWVudEhlYXJ0JyxcbiAgICAgICdDb21tZW50JyxcbiAgICAgICdQb3N0SGVhcnQnLFxuICAgICAgJ1Bvc3QnLFxuICAgICAgJ01lbWJlcnNoaXAnLFxuICAgICAgJ1Jvb20nLFxuICAgICAgJ1Jvb21Hcm91cCcsXG4gICAgICAnQ29tbXVuaXR5JyxcblxuICAgICAgLy8gQW5hbHl0aWNzIGFuZCBtYXRjaGluZ1xuICAgICAgJ1JlY29tbWVuZGF0aW9uRmVlZGJhY2snLFxuICAgICAgJ0FsZ29yaXRobVBlcmZvcm1hbmNlJyxcbiAgICAgICdDbGllbnRDb21wYXRpYmlsaXR5JyxcbiAgICAgICdNYXRjaEhpc3RvcnknLFxuICAgICAgJ01hdGNoaW5nV2VpZ2h0JyxcblxuICAgICAgLy8gUmV2aWV3cyBhbmQgcmF0aW5nc1xuICAgICAgJ1Jldmlld0hlbHBmdWwnLFxuICAgICAgJ1JldmlldycsXG5cbiAgICAgIC8vIFNlc3Npb25zIGFuZCBtZWV0aW5nc1xuICAgICAgJ1Nlc3Npb25Mb2cnLFxuICAgICAgJ01lZXRpbmcnLFxuICAgICAgJ1RoZXJhcHlQcm9ncmVzcycsXG4gICAgICAnVGhlcmFwaXN0QXZhaWxhYmlsaXR5JyxcblxuICAgICAgLy8gQXNzZXNzbWVudHMgYW5kIHdvcmtzaGVldHNcbiAgICAgICdBc3Nlc3NtZW50JyxcbiAgICAgICdNZW50YWxIZWFsdGhJbmRpY2F0b3InLFxuICAgICAgJ1dvcmtzaGVldCcsXG4gICAgICAnUHJlQXNzZXNzbWVudCcsXG5cbiAgICAgIC8vIEZpbGUgbWFuYWdlbWVudFxuICAgICAgJ0ZpbGVEb3dubG9hZCcsXG4gICAgICAnRmlsZVNoYXJlJyxcbiAgICAgICdGaWxlVmVyc2lvbicsXG4gICAgICAnRmlsZScsXG5cbiAgICAgIC8vIEJpbGxpbmcgYW5kIHN1YnNjcmlwdGlvbnNcbiAgICAgICdEaXNjb3VudFJlZGVtcHRpb24nLFxuICAgICAgJ1BheW1lbnRNZXRob2QnLFxuICAgICAgJ1N1YnNjcmlwdGlvbicsXG5cbiAgICAgIC8vIE5vdGlmaWNhdGlvbnMgYW5kIGFjdGl2aXRpZXNcbiAgICAgICdOb3RpZmljYXRpb24nLFxuICAgICAgJ05vdGlmaWNhdGlvblNldHRpbmdzJyxcbiAgICAgICdVc2VyQWN0aXZpdHknLFxuICAgICAgJ0F1ZGl0TG9nJyxcblxuICAgICAgLy8gQ2xpZW50LXRoZXJhcGlzdCByZWxhdGlvbnNoaXBzXG4gICAgICAnQ2xpZW50UHJlZmVyZW5jZScsXG4gICAgICAnQ2xpZW50TWVkaWNhbEhpc3RvcnknLFxuICAgICAgJ0NsaWVudFRoZXJhcGlzdCcsXG5cbiAgICAgIC8vIFJvbGUtc3BlY2lmaWMgcHJvZmlsZXNcbiAgICAgICdUaGVyYXBpc3QnLFxuICAgICAgJ0NsaWVudCcsXG4gICAgICAnTW9kZXJhdG9yJyxcbiAgICAgICdNb2RlcmF0b3JDb21tdW5pdHknLFxuICAgICAgJ0FkbWluJyxcblxuICAgICAgLy8gQ29yZSB1c2VyIHRhYmxlIChtdXN0IGJlIGxhc3QpXG4gICAgICAnVXNlcicsXG4gICAgXTtcblxuICAgIC8vIFByb2Nlc3MgZWFjaCB0YWJsZSB3aXRoIGVuaGFuY2VkIGVycm9yIGhhbmRsaW5nIGFuZCBzdGF0aXN0aWNzXG4gICAgZm9yIChjb25zdCB0YWJsZU5hbWUgb2YgdGFibGVDbGVhbnVwT3JkZXIpIHtcbiAgICAgIHRyeSB7XG4gICAgICAgIC8vIEdldCBjb3VudCBiZWZvcmUgZGVsZXRpb24gZm9yIHN0YXRpc3RpY3NcbiAgICAgICAgY29uc3QgY291bnRRdWVyeSA9IGBTRUxFQ1QgQ09VTlQoKikgYXMgY291bnQgRlJPTSBcIiR7dGFibGVOYW1lfVwiYDtcbiAgICAgICAgY29uc3QgY291bnRSZXN1bHQgPVxuICAgICAgICAgIGF3YWl0IHRoaXMucHJpc21hU2VydmljZS4kcXVlcnlSYXdVbnNhZmU8W3sgY291bnQ6IHN0cmluZyB9XT4oXG4gICAgICAgICAgICBjb3VudFF1ZXJ5LFxuICAgICAgICAgICk7XG4gICAgICAgIGNvbnN0IHJlY29yZENvdW50ID0gcGFyc2VJbnQoY291bnRSZXN1bHRbMF0/LmNvdW50IHx8ICcwJywgMTApO1xuXG4gICAgICAgIGlmIChyZWNvcmRDb3VudCA+IDApIHtcbiAgICAgICAgICAvLyBVc2UgVFJVTkNBVEUgZm9yIGJldHRlciBwZXJmb3JtYW5jZSBhbmQgdG8gcmVzZXQgc2VxdWVuY2VzXG4gICAgICAgICAgYXdhaXQgdGhpcy5wcmlzbWFTZXJ2aWNlLiRleGVjdXRlUmF3VW5zYWZlKFxuICAgICAgICAgICAgYFRSVU5DQVRFIFRBQkxFIFwiJHt0YWJsZU5hbWV9XCIgUkVTVEFSVCBJREVOVElUWSBDQVNDQURFO2AsXG4gICAgICAgICAgKTtcbiAgICAgICAgICBzdGF0cy5yZWNvcmRzRGVsZXRlZCArPSByZWNvcmRDb3VudDtcbiAgICAgICAgfVxuXG4gICAgICAgIHN0YXRzLnRhYmxlc1Byb2Nlc3NlZCsrO1xuICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgLy8gTG9nIGVycm9yIGJ1dCBjb250aW51ZSB3aXRoIGNsZWFudXBcbiAgICAgICAgY29uc3QgZXJyb3JNZXNzYWdlID1cbiAgICAgICAgICBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6IFN0cmluZyhlcnJvcik7XG5cbiAgICAgICAgLy8gT25seSBsb2cgYXMgZXJyb3IgaWYgaXQncyBub3QgYSBcInRhYmxlIGRvZXNuJ3QgZXhpc3RcIiBlcnJvclxuICAgICAgICBpZiAoIWVycm9yTWVzc2FnZS5pbmNsdWRlcygnZG9lcyBub3QgZXhpc3QnKSkge1xuICAgICAgICAgIHN0YXRzLmVycm9ycy5wdXNoKGAke3RhYmxlTmFtZX06ICR7ZXJyb3JNZXNzYWdlfWApO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gVHJ5IGFsdGVybmF0aXZlIGNsZWFudXAgbWV0aG9kIGZvciBwcm9ibGVtYXRpYyB0YWJsZXNcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICBhd2FpdCB0aGlzLnByaXNtYVNlcnZpY2UuJGV4ZWN1dGVSYXdVbnNhZmUoXG4gICAgICAgICAgICBgREVMRVRFIEZST00gXCIke3RhYmxlTmFtZX1cIjtgLFxuICAgICAgICAgICk7XG4gICAgICAgICAgc3RhdHMudGFibGVzUHJvY2Vzc2VkKys7XG4gICAgICAgIH0gY2F0Y2ggKGFsdGVybmF0aXZlRXJyb3IpIHtcbiAgICAgICAgICBjb25zdCBhbHRFcnJvck1lc3NhZ2UgPVxuICAgICAgICAgICAgYWx0ZXJuYXRpdmVFcnJvciBpbnN0YW5jZW9mIEVycm9yXG4gICAgICAgICAgICAgID8gYWx0ZXJuYXRpdmVFcnJvci5tZXNzYWdlXG4gICAgICAgICAgICAgIDogU3RyaW5nKGFsdGVybmF0aXZlRXJyb3IpO1xuICAgICAgICAgIGlmICghYWx0RXJyb3JNZXNzYWdlLmluY2x1ZGVzKCdkb2VzIG5vdCBleGlzdCcpKSB7XG4gICAgICAgICAgICBzdGF0cy5lcnJvcnMucHVzaChgJHt0YWJsZU5hbWV9IChhbHRlcm5hdGl2ZSk6ICR7YWx0RXJyb3JNZXNzYWdlfWApO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cblxuICAgIC8vIFJlc2V0IGFsbCBzZXF1ZW5jZXMgdG8gZW5zdXJlIGNvbnNpc3RlbnQgdGVzdCBkYXRhXG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHNlcXVlbmNlUmVzZXRRdWVyaWVzID0gW1xuICAgICAgICBcIlNFTEVDVCBzZXR2YWwocGdfZ2V0X3NlcmlhbF9zZXF1ZW5jZSgnXFxcIlVzZXJcXFwiJywgJ2lkJyksIDEsIGZhbHNlKTtcIixcbiAgICAgICAgXCJTRUxFQ1Qgc2V0dmFsKHBnX2dldF9zZXJpYWxfc2VxdWVuY2UoJ1xcXCJDb21tdW5pdHlcXFwiJywgJ2lkJyksIDEsIGZhbHNlKTtcIixcbiAgICAgICAgXCJTRUxFQ1Qgc2V0dmFsKHBnX2dldF9zZXJpYWxfc2VxdWVuY2UoJ1xcXCJDb252ZXJzYXRpb25cXFwiJywgJ2lkJyksIDEsIGZhbHNlKTtcIixcbiAgICAgICAgXCJTRUxFQ1Qgc2V0dmFsKHBnX2dldF9zZXJpYWxfc2VxdWVuY2UoJ1xcXCJNZWV0aW5nXFxcIicsICdpZCcpLCAxLCBmYWxzZSk7XCIsXG4gICAgICBdO1xuXG4gICAgICBmb3IgKGNvbnN0IHF1ZXJ5IG9mIHNlcXVlbmNlUmVzZXRRdWVyaWVzKSB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgYXdhaXQgdGhpcy5wcmlzbWFTZXJ2aWNlLiRleGVjdXRlUmF3VW5zYWZlKHF1ZXJ5KTtcbiAgICAgICAgfSBjYXRjaCB7XG4gICAgICAgICAgLy8gSWdub3JlIHNlcXVlbmNlIHJlc2V0IGVycm9ycyAoc2VxdWVuY2UgbWlnaHQgbm90IGV4aXN0KVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfSBjYXRjaCB7XG4gICAgICAvLyBJZ25vcmUgc2VxdWVuY2UgcmVzZXQgZXJyb3JzXG4gICAgfVxuXG4gICAgc3RhdHMuZHVyYXRpb24gPSBEYXRlLm5vdygpIC0gc3RhcnRUaW1lO1xuICAgIHRoaXMuY2xlYW51cFN0YXRzLnB1c2goc3RhdHMpO1xuXG4gICAgLy8gTG9nIGNsZWFudXAgc3RhdGlzdGljcyBpbiBkZWJ1ZyBtb2RlXG4gICAgaWYgKHByb2Nlc3MuZW52LkRFQlVHX1RFU1RTID09PSAndHJ1ZScpIHtcbiAgICAgIGNvbnNvbGUubG9nKGDwn6e5IERhdGFiYXNlIENsZWFudXAgQ29tcGxldGU6XG4gICAgICAgIPCfk4ogVGFibGVzIFByb2Nlc3NlZDogJHtzdGF0cy50YWJsZXNQcm9jZXNzZWR9XG4gICAgICAgIPCfl5HvuI8gIFJlY29yZHMgRGVsZXRlZDogJHtzdGF0cy5yZWNvcmRzRGVsZXRlZH1cbiAgICAgICAg4o+x77iPICBEdXJhdGlvbjogJHtzdGF0cy5kdXJhdGlvbn1tc1xuICAgICAgICDinYwgRXJyb3JzOiAke3N0YXRzLmVycm9ycy5sZW5ndGh9XG4gICAgICBgKTtcblxuICAgICAgaWYgKHN0YXRzLmVycm9ycy5sZW5ndGggPiAwKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKCdDbGVhbnVwIEVycm9yczonLCBzdGF0cy5lcnJvcnMpO1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBzdGF0cztcbiAgfVxuXG4gIC8qKlxuICAgKiBFbmhhbmNlZCBjbGVhbnVwIGZvciBzcGVjaWZpYyB0ZXN0IHNjZW5hcmlvc1xuICAgKi9cbiAgc3RhdGljIGFzeW5jIGNsZWFudXBNZXNzYWdpbmdEYXRhKCk6IFByb21pc2U8dm9pZD4ge1xuICAgIGlmICghdGhpcy5wcmlzbWFTZXJ2aWNlKSByZXR1cm47XG5cbiAgICBjb25zdCBtZXNzYWdpbmdUYWJsZXMgPSBbXG4gICAgICAnVHlwaW5nSW5kaWNhdG9yJyxcbiAgICAgICdNZXNzYWdlUmVhY3Rpb24nLFxuICAgICAgJ01lc3NhZ2VSZWFkUmVjZWlwdCcsXG4gICAgICAnTWVzc2FnZScsXG4gICAgICAnQ29udmVyc2F0aW9uUGFydGljaXBhbnQnLFxuICAgICAgJ0NvbnZlcnNhdGlvbicsXG4gICAgICAnVXNlckJsb2NrJyxcbiAgICBdO1xuXG4gICAgZm9yIChjb25zdCB0YWJsZSBvZiBtZXNzYWdpbmdUYWJsZXMpIHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGF3YWl0IHRoaXMucHJpc21hU2VydmljZS4kZXhlY3V0ZVJhd1Vuc2FmZShcbiAgICAgICAgICBgVFJVTkNBVEUgVEFCTEUgXCIke3RhYmxlfVwiIFJFU1RBUlQgSURFTlRJVFkgQ0FTQ0FERTtgLFxuICAgICAgICApO1xuICAgICAgfSBjYXRjaCB7XG4gICAgICAgIC8vIElnbm9yZSBlcnJvcnMgZm9yIG5vbi1leGlzdGVudCB0YWJsZXNcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBzdGF0aWMgYXN5bmMgY2xlYW51cEFuYWx5dGljc0RhdGEoKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgaWYgKCF0aGlzLnByaXNtYVNlcnZpY2UpIHJldHVybjtcblxuICAgIGNvbnN0IGFuYWx5dGljc1RhYmxlcyA9IFtcbiAgICAgICdSZWNvbW1lbmRhdGlvbkZlZWRiYWNrJyxcbiAgICAgICdBbGdvcml0aG1QZXJmb3JtYW5jZScsXG4gICAgICAnQ2xpZW50Q29tcGF0aWJpbGl0eScsXG4gICAgICAnTWF0Y2hIaXN0b3J5JyxcbiAgICAgICdNYXRjaGluZ1dlaWdodCcsXG4gICAgXTtcblxuICAgIGZvciAoY29uc3QgdGFibGUgb2YgYW5hbHl0aWNzVGFibGVzKSB7XG4gICAgICB0cnkge1xuICAgICAgICBhd2FpdCB0aGlzLnByaXNtYVNlcnZpY2UuJGV4ZWN1dGVSYXdVbnNhZmUoXG4gICAgICAgICAgYFRSVU5DQVRFIFRBQkxFIFwiJHt0YWJsZX1cIiBSRVNUQVJUIElERU5USVRZIENBU0NBREU7YCxcbiAgICAgICAgKTtcbiAgICAgIH0gY2F0Y2gge1xuICAgICAgICAvLyBJZ25vcmUgZXJyb3JzIGZvciBub24tZXhpc3RlbnQgdGFibGVzXG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgc3RhdGljIGFzeW5jIGNsZWFudXBDb21tdW5pdHlEYXRhKCk6IFByb21pc2U8dm9pZD4ge1xuICAgIGlmICghdGhpcy5wcmlzbWFTZXJ2aWNlKSByZXR1cm47XG5cbiAgICBjb25zdCBjb21tdW5pdHlUYWJsZXMgPSBbXG4gICAgICAnUmVwbHlIZWFydCcsXG4gICAgICAnUmVwbHknLFxuICAgICAgJ0NvbW1lbnRIZWFydCcsXG4gICAgICAnQ29tbWVudCcsXG4gICAgICAnUG9zdEhlYXJ0JyxcbiAgICAgICdQb3N0JyxcbiAgICAgICdNZW1iZXJzaGlwJyxcbiAgICAgICdSb29tJyxcbiAgICAgICdSb29tR3JvdXAnLFxuICAgICAgJ0NvbW11bml0eScsXG4gICAgXTtcblxuICAgIGZvciAoY29uc3QgdGFibGUgb2YgY29tbXVuaXR5VGFibGVzKSB7XG4gICAgICB0cnkge1xuICAgICAgICBhd2FpdCB0aGlzLnByaXNtYVNlcnZpY2UuJGV4ZWN1dGVSYXdVbnNhZmUoXG4gICAgICAgICAgYFRSVU5DQVRFIFRBQkxFIFwiJHt0YWJsZX1cIiBSRVNUQVJUIElERU5USVRZIENBU0NBREU7YCxcbiAgICAgICAgKTtcbiAgICAgIH0gY2F0Y2gge1xuICAgICAgICAvLyBJZ25vcmUgZXJyb3JzIGZvciBub24tZXhpc3RlbnQgdGFibGVzXG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFZlcmlmeSBkYXRhYmFzZSBjb25uZWN0aXZpdHkgYW5kIHNjaGVtYSBpbnRlZ3JpdHlcbiAgICovXG4gIHN0YXRpYyBhc3luYyB2ZXJpZnlEYXRhYmFzZUhlYWx0aCgpOiBQcm9taXNlPHtcbiAgICBpc0Nvbm5lY3RlZDogYm9vbGVhbjtcbiAgICBzY2hlbWFWYWxpZDogYm9vbGVhbjtcbiAgICB0YWJsZUNvdW50OiBudW1iZXI7XG4gICAgZXJyb3JzOiBzdHJpbmdbXTtcbiAgfT4ge1xuICAgIGNvbnN0IGhlYWx0aCA9IHtcbiAgICAgIGlzQ29ubmVjdGVkOiBmYWxzZSxcbiAgICAgIHNjaGVtYVZhbGlkOiBmYWxzZSxcbiAgICAgIHRhYmxlQ291bnQ6IDAsXG4gICAgICBlcnJvcnM6IFtdIGFzIHN0cmluZ1tdLFxuICAgIH07XG5cbiAgICB0cnkge1xuICAgICAgLy8gVGVzdCBiYXNpYyBjb25uZWN0aXZpdHlcbiAgICAgIGF3YWl0IHRoaXMucHJpc21hU2VydmljZS4kcXVlcnlSYXdgU0VMRUNUIDFgO1xuICAgICAgaGVhbHRoLmlzQ29ubmVjdGVkID0gdHJ1ZTtcblxuICAgICAgLy8gQ291bnQgdGFibGVzIGluIHRoZSBkYXRhYmFzZVxuICAgICAgY29uc3QgdGFibGVDb3VudFJlc3VsdCA9IGF3YWl0IHRoaXMucHJpc21hU2VydmljZS4kcXVlcnlSYXc8XG4gICAgICAgIFt7IGNvdW50OiBiaWdpbnQgfV1cbiAgICAgID5gXG4gICAgICAgIFNFTEVDVCBDT1VOVCgqKSBhcyBjb3VudCBcbiAgICAgICAgRlJPTSBpbmZvcm1hdGlvbl9zY2hlbWEudGFibGVzIFxuICAgICAgICBXSEVSRSB0YWJsZV9zY2hlbWEgPSAncHVibGljJ1xuICAgICAgYDtcbiAgICAgIGhlYWx0aC50YWJsZUNvdW50ID0gTnVtYmVyKHRhYmxlQ291bnRSZXN1bHRbMF0/LmNvdW50IHx8IDApO1xuXG4gICAgICAvLyBWZXJpZnkga2V5IHRhYmxlcyBleGlzdFxuICAgICAgY29uc3Qga2V5VGFibGVzID0gWydVc2VyJywgJ0NsaWVudCcsICdUaGVyYXBpc3QnLCAnTWVldGluZycsICdDb21tdW5pdHknXTtcbiAgICAgIGZvciAoY29uc3QgdGFibGUgb2Yga2V5VGFibGVzKSB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgYXdhaXQgdGhpcy5wcmlzbWFTZXJ2aWNlLiRxdWVyeVJhd1Vuc2FmZShcbiAgICAgICAgICAgIGBTRUxFQ1QgMSBGUk9NIFwiJHt0YWJsZX1cIiBMSU1JVCAxYCxcbiAgICAgICAgICApO1xuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgIGhlYWx0aC5lcnJvcnMucHVzaChgTWlzc2luZyBvciBpbmFjY2Vzc2libGUgdGFibGU6ICR7dGFibGV9YCk7XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgaGVhbHRoLnNjaGVtYVZhbGlkID0gaGVhbHRoLmVycm9ycy5sZW5ndGggPT09IDA7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnN0IGVycm9yTWVzc2FnZSA9XG4gICAgICAgIGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogU3RyaW5nKGVycm9yKTtcbiAgICAgIGhlYWx0aC5lcnJvcnMucHVzaChgRGF0YWJhc2UgY29ubmVjdGlvbiBlcnJvcjogJHtlcnJvck1lc3NhZ2V9YCk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGhlYWx0aDtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgY2xlYW51cCBzdGF0aXN0aWNzIGZvciBwZXJmb3JtYW5jZSBtb25pdG9yaW5nXG4gICAqL1xuICBzdGF0aWMgZ2V0Q2xlYW51cFN0YXRpc3RpY3MoKTogQ2xlYW51cFN0YXRzW10ge1xuICAgIHJldHVybiBbLi4udGhpcy5jbGVhbnVwU3RhdHNdO1xuICB9XG5cbiAgLyoqXG4gICAqIFJlc2V0IGNsZWFudXAgc3RhdGlzdGljc1xuICAgKi9cbiAgc3RhdGljIHJlc2V0Q2xlYW51cFN0YXRpc3RpY3MoKTogdm9pZCB7XG4gICAgdGhpcy5jbGVhbnVwU3RhdHMgPSBbXTtcbiAgfVxuXG4gIHN0YXRpYyBhc3luYyBzdG9wQ29udGFpbmVyKCk6IFByb21pc2U8dm9pZD4ge1xuICAgIGlmICh0aGlzLmNvbnRhaW5lcikge1xuICAgICAgYXdhaXQgdGhpcy5jb250YWluZXIuc3RvcCgpO1xuICAgIH1cbiAgfVxuXG4gIHN0YXRpYyBnZXRQcmlzbWFTZXJ2aWNlKCk6IFByaXNtYVNlcnZpY2Uge1xuICAgIHJldHVybiB0aGlzLnByaXNtYVNlcnZpY2U7XG4gIH1cblxuICAvKipcbiAgICogRW5oYW5jZWQgY29udGFpbmVyIG1hbmFnZW1lbnQgd2l0aCBoZWFsdGggY2hlY2tzXG4gICAqL1xuICBzdGF0aWMgYXN5bmMgcmVzdGFydENvbnRhaW5lcigpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBpZiAodGhpcy5jb250YWluZXIpIHtcbiAgICAgIGF3YWl0IHRoaXMuY29udGFpbmVyLnN0b3AoKTtcbiAgICAgIHRoaXMuY29udGFpbmVyID0gbnVsbCBhcyBhbnk7XG4gICAgfVxuICAgIGF3YWl0IHRoaXMuc3RhcnRDb250YWluZXIoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBQZXJmb3JtYW5jZSBtb25pdG9yaW5nIGZvciB0ZXN0IGRhdGFiYXNlIG9wZXJhdGlvbnNcbiAgICovXG4gIHN0YXRpYyBhc3luYyBtZWFzdXJlRGF0YWJhc2VQZXJmb3JtYW5jZTxUPihcbiAgICBvcGVyYXRpb246ICgpID0+IFByb21pc2U8VD4sXG4gICAgb3BlcmF0aW9uTmFtZTogc3RyaW5nLFxuICApOiBQcm9taXNlPHsgcmVzdWx0OiBUOyBkdXJhdGlvbjogbnVtYmVyOyBtZW1vcnlVc2FnZTogbnVtYmVyIH0+IHtcbiAgICBjb25zdCBzdGFydFRpbWUgPSBEYXRlLm5vdygpO1xuICAgIGNvbnN0IHN0YXJ0TWVtb3J5ID0gcHJvY2Vzcy5tZW1vcnlVc2FnZSgpLmhlYXBVc2VkO1xuXG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IG9wZXJhdGlvbigpO1xuICAgICAgY29uc3QgZW5kVGltZSA9IERhdGUubm93KCk7XG4gICAgICBjb25zdCBlbmRNZW1vcnkgPSBwcm9jZXNzLm1lbW9yeVVzYWdlKCkuaGVhcFVzZWQ7XG5cbiAgICAgIGNvbnN0IHBlcmZvcm1hbmNlID0ge1xuICAgICAgICByZXN1bHQsXG4gICAgICAgIGR1cmF0aW9uOiBlbmRUaW1lIC0gc3RhcnRUaW1lLFxuICAgICAgICBtZW1vcnlVc2FnZTogZW5kTWVtb3J5IC0gc3RhcnRNZW1vcnksXG4gICAgICB9O1xuXG4gICAgICBpZiAocHJvY2Vzcy5lbnYuVFJBQ0tfVEVTVF9QRVJGT1JNQU5DRSA9PT0gJ3RydWUnKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKGDwn5OKICR7b3BlcmF0aW9uTmFtZX0gUGVyZm9ybWFuY2U6XG4gICAgICAgICAg4o+x77iPICBEdXJhdGlvbjogJHtwZXJmb3JtYW5jZS5kdXJhdGlvbn1tc1xuICAgICAgICAgIPCfp6AgTWVtb3J5OiAkeyhwZXJmb3JtYW5jZS5tZW1vcnlVc2FnZSAvIDEwMjQgLyAxMDI0KS50b0ZpeGVkKDIpfU1CXG4gICAgICAgIGApO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gcGVyZm9ybWFuY2U7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnN0IGVuZFRpbWUgPSBEYXRlLm5vdygpO1xuICAgICAgY29uc29sZS5lcnJvcihcbiAgICAgICAgYOKdjCAke29wZXJhdGlvbk5hbWV9IGZhaWxlZCBhZnRlciAke2VuZFRpbWUgLSBzdGFydFRpbWV9bXM6YCxcbiAgICAgICAgZXJyb3IsXG4gICAgICApO1xuICAgICAgdGhyb3cgZXJyb3I7XG4gICAgfVxuICB9XG59XG4iXSwidmVyc2lvbiI6M30=