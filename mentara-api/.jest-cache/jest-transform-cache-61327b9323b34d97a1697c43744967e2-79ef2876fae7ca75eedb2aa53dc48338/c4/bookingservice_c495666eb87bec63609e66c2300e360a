bae24d36985016c4fa908ca079376a5b
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.BookingService = void 0;
const common_1 = require("@nestjs/common");
const prisma_client_provider_1 = require("../providers/prisma-client.provider");
const event_bus_service_1 = require("../common/events/event-bus.service");
const slot_generator_service_1 = require("./services/slot-generator.service");
const conflict_detection_service_1 = require("./services/conflict-detection.service");
const availability_validator_service_1 = require("./services/availability-validator.service");
const booking_events_1 = require("../common/events/booking-events");
let BookingService = class BookingService {
    prisma;
    eventBus;
    slotGenerator;
    conflictDetection;
    availabilityValidator;
    constructor(prisma, eventBus, slotGenerator, conflictDetection, availabilityValidator) {
        this.prisma = prisma;
        this.eventBus = eventBus;
        this.slotGenerator = slotGenerator;
        this.conflictDetection = conflictDetection;
        this.availabilityValidator = availabilityValidator;
    }
    // Meeting Management
    async createMeeting(createMeetingDto, clientId) {
        try {
            const { startTime, therapistId, duration } = createMeetingDto;
            const startTimeDate = new Date(startTime);
            // Comprehensive validation using our new services
            await this.availabilityValidator.validateMeetingCreation({
                therapistId,
                clientId,
                startTime: startTimeDate,
                duration,
            });
            // Check for conflicts using our dedicated service
            await this.conflictDetection.validateNoConflicts(therapistId, clientId, startTimeDate, duration);
            // Create the meeting
            const meeting = await this.prisma.meeting.create({
                data: {
                    ...createMeetingDto,
                    status: 'SCHEDULED',
                    clientId,
                },
                include: {
                    client: {
                        select: {
                            user: {
                                select: {
                                    firstName: true,
                                    lastName: true,
                                    email: true,
                                },
                            },
                        },
                    },
                    therapist: {
                        select: {
                            user: {
                                select: {
                                    firstName: true,
                                    lastName: true,
                                    email: true,
                                },
                            },
                        },
                    },
                },
            });
            // Publish appointment booked event
            await this.eventBus.emit(new booking_events_1.AppointmentBookedEvent({
                appointmentId: meeting.id,
                clientId: meeting.clientId,
                therapistId: meeting.therapistId,
                startTime: meeting.startTime,
                meetingType: meeting.meetingType,
                duration: meeting.duration,
                title: meeting.title || 'Therapy Session',
                description: meeting.description || undefined,
                isInitialConsultation: false,
            }));
            return meeting;
        }
        catch (error) {
            throw new common_1.BadRequestException(error instanceof Error ? error.message : String(error));
        }
    }
    async getMeetings(userId, role) {
        try {
            const where = role === 'therapist' ? { therapistId: userId } : { clientId: userId };
            return await this.prisma.meeting.findMany({
                where,
                include: {
                    client: {
                        select: {
                            user: {
                                select: {
                                    firstName: true,
                                    lastName: true,
                                    email: true,
                                },
                            },
                        },
                    },
                    therapist: {
                        select: {
                            user: {
                                select: {
                                    firstName: true,
                                    lastName: true,
                                    email: true,
                                },
                            },
                        },
                    },
                },
                orderBy: { startTime: 'desc' },
            });
        }
        catch (error) {
            throw new common_1.BadRequestException(error instanceof Error ? error.message : String(error));
        }
    }
    async getMeeting(id, userId, role) {
        try {
            const meeting = await this.prisma.meeting.findUnique({
                where: { id },
                include: {
                    client: {
                        select: {
                            user: {
                                select: {
                                    firstName: true,
                                    lastName: true,
                                    email: true,
                                },
                            },
                        },
                    },
                    therapist: {
                        select: {
                            user: {
                                select: {
                                    firstName: true,
                                    lastName: true,
                                    email: true,
                                },
                            },
                        },
                    },
                },
            });
            if (!meeting) {
                throw new common_1.NotFoundException('Meeting not found');
            }
            // Verify user has access to this meeting
            if (role === 'therapist' && meeting.therapistId !== userId) {
                throw new common_1.ForbiddenException('Access denied');
            }
            if (role === 'client' && meeting.clientId !== userId) {
                throw new common_1.ForbiddenException('Access denied');
            }
            return meeting;
        }
        catch (error) {
            throw new common_1.BadRequestException(error instanceof Error ? error.message : String(error));
        }
    }
    async updateMeeting(id, updateMeetingDto, userId, role) {
        try {
            const meeting = await this.getMeeting(id, userId, role);
            // Only allow updates if meeting is not completed or cancelled
            if (['COMPLETED', 'CANCELLED'].includes(meeting.status)) {
                throw new common_1.BadRequestException('Cannot update completed or cancelled meetings');
            }
            // If updating time, validate the new schedule
            if (updateMeetingDto.startTime || updateMeetingDto.duration) {
                const newStartTime = updateMeetingDto.startTime
                    ? new Date(updateMeetingDto.startTime)
                    : meeting.startTime;
                const newDuration = updateMeetingDto.duration || meeting.duration;
                // Check for conflicts with the update
                const conflicts = await this.conflictDetection.checkUpdateConflicts(id, meeting.therapistId, meeting.clientId, newStartTime, newDuration);
                if (conflicts.hasConflict) {
                    throw new common_1.BadRequestException(`Schedule update would cause conflicts: ${conflicts.conflictingMeetings.length} conflicting meetings found`);
                }
                // Validate therapist availability for new time
                if (updateMeetingDto.startTime) {
                    await this.availabilityValidator.validateTherapistAvailability(meeting.therapistId, newStartTime, newDuration);
                }
            }
            const updatedMeeting = await this.prisma.meeting.update({
                where: { id },
                data: {
                    title: updateMeetingDto.title,
                    description: updateMeetingDto.description,
                    startTime: updateMeetingDto.startTime,
                    duration: updateMeetingDto.duration,
                    meetingType: updateMeetingDto.meetingType,
                    therapistId: updateMeetingDto.therapistId,
                    ...(updateMeetingDto.status && {
                        status: updateMeetingDto.status,
                    }),
                },
                include: {
                    client: {
                        select: {
                            user: {
                                select: {
                                    firstName: true,
                                    lastName: true,
                                    email: true,
                                },
                            },
                        },
                    },
                    therapist: {
                        select: {
                            user: {
                                select: {
                                    firstName: true,
                                    lastName: true,
                                    email: true,
                                },
                            },
                        },
                    },
                },
            });
            // Publish appropriate events
            if (updateMeetingDto.status === 'COMPLETED') {
                await this.eventBus.emit(new booking_events_1.AppointmentCompletedEvent({
                    appointmentId: updatedMeeting.id,
                    clientId: updatedMeeting.clientId,
                    therapistId: updatedMeeting.therapistId,
                    completedAt: new Date(),
                    duration: updatedMeeting.duration,
                    sessionNotes: updateMeetingDto.description || '',
                    attendanceStatus: 'ATTENDED',
                }));
            }
            else if (updateMeetingDto.startTime &&
                new Date(updateMeetingDto.startTime).getTime() !==
                    meeting.startTime.getTime()) {
                await this.eventBus.emit(new booking_events_1.AppointmentRescheduledEvent({
                    appointmentId: updatedMeeting.id,
                    clientId: updatedMeeting.clientId,
                    therapistId: updatedMeeting.therapistId,
                    rescheduledBy: userId,
                    originalStartTime: meeting.startTime,
                    newStartTime: new Date(updateMeetingDto.startTime),
                    rescheduleReason: `Rescheduled by ${role}`,
                }));
            }
            return updatedMeeting;
        }
        catch (error) {
            throw new common_1.BadRequestException(error instanceof Error ? error.message : String(error));
        }
    }
    async cancelMeeting(id, userId, role) {
        try {
            const meeting = await this.getMeeting(id, userId, role);
            if (meeting.status === 'CANCELLED') {
                throw new common_1.BadRequestException('Meeting is already cancelled');
            }
            if (meeting.status === 'COMPLETED') {
                throw new common_1.BadRequestException('Cannot cancel completed meetings');
            }
            const cancelledMeeting = await this.prisma.meeting.update({
                where: { id },
                data: { status: 'CANCELLED' },
                include: {
                    client: {
                        select: {
                            user: {
                                select: {
                                    firstName: true,
                                    lastName: true,
                                    email: true,
                                },
                            },
                        },
                    },
                    therapist: {
                        select: {
                            user: {
                                select: {
                                    firstName: true,
                                    lastName: true,
                                    email: true,
                                },
                            },
                        },
                    },
                },
            });
            // Calculate cancellation notice
            const cancellationNotice = Math.floor((meeting.startTime.getTime() - Date.now()) / (1000 * 60 * 60));
            // Publish cancellation event
            await this.eventBus.emit(new booking_events_1.AppointmentCancelledEvent({
                appointmentId: cancelledMeeting.id,
                clientId: cancelledMeeting.clientId,
                therapistId: cancelledMeeting.therapistId,
                cancelledBy: userId,
                cancellationReason: role === 'client'
                    ? 'Cancelled by client'
                    : 'Cancelled by therapist',
                originalStartTime: meeting.startTime,
                cancelledAt: new Date(),
                cancellationNotice: Math.max(0, cancellationNotice),
            }));
            return cancelledMeeting;
        }
        catch (error) {
            throw new common_1.BadRequestException(error instanceof Error ? error.message : String(error));
        }
    }
    // Availability Management
    async createAvailability(createAvailabilityDto, therapistId) {
        try {
            const { dayOfWeek, startTime, endTime, notes } = createAvailabilityDto;
            // Validate using our new service
            await this.availabilityValidator.validateAvailabilityCreation({
                therapistId,
                dayOfWeek,
                startTime,
                endTime,
            });
            return this.prisma.therapistAvailability.create({
                data: {
                    therapistId,
                    dayOfWeek,
                    startTime,
                    endTime,
                    notes,
                },
            });
        }
        catch (error) {
            throw new common_1.BadRequestException(error instanceof Error ? error.message : String(error));
        }
    }
    async getAvailability(therapistId) {
        try {
            return await this.prisma.therapistAvailability.findMany({
                where: { therapistId },
                orderBy: [{ dayOfWeek: 'asc' }, { startTime: 'asc' }],
            });
        }
        catch (error) {
            throw new common_1.BadRequestException(error instanceof Error ? error.message : String(error));
        }
    }
    async updateAvailability(id, updateAvailabilityDto, therapistId) {
        try {
            const availability = await this.prisma.therapistAvailability.findFirst({
                where: { id, therapistId },
            });
            if (!availability) {
                throw new common_1.NotFoundException('Availability slot not found');
            }
            return this.prisma.therapistAvailability.update({
                where: { id },
                data: updateAvailabilityDto,
            });
        }
        catch (error) {
            throw new common_1.BadRequestException(error instanceof Error ? error.message : String(error));
        }
    }
    async deleteAvailability(id, therapistId) {
        try {
            const availability = await this.prisma.therapistAvailability.findFirst({
                where: { id, therapistId },
            });
            if (!availability) {
                throw new common_1.NotFoundException('Availability slot not found');
            }
            return this.prisma.therapistAvailability.delete({
                where: { id },
            });
        }
        catch (error) {
            throw new common_1.BadRequestException(error instanceof Error ? error.message : String(error));
        }
    }
    // Simplified slot generation using our new service
    async getAvailableSlots(therapistId, date) {
        try {
            return await this.slotGenerator.generateAvailableSlots(therapistId, date);
        }
        catch (error) {
            throw new common_1.BadRequestException(error instanceof Error ? error.message : String(error));
        }
    }
    // Duration management
    getDurations() {
        return [
            { id: '30', name: '30 minutes', duration: 30 },
            { id: '60', name: '60 minutes', duration: 60 },
            { id: '90', name: '90 minutes', duration: 90 },
            { id: '120', name: '120 minutes', duration: 120 },
        ];
    }
    // Enhanced validation method using our services
    async validateMeetingTime(therapistId, clientId, startTime, duration) {
        const startTimeDate = new Date(startTime);
        await this.availabilityValidator.validateMeetingCreation({
            therapistId,
            clientId,
            startTime: startTimeDate,
            duration,
        });
        await this.conflictDetection.validateNoConflicts(therapistId, clientId, startTimeDate, duration);
        return true;
    }
};
exports.BookingService = BookingService;
exports.BookingService = BookingService = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [prisma_client_provider_1.PrismaService,
        event_bus_service_1.EventBusService,
        slot_generator_service_1.SlotGeneratorService,
        conflict_detection_service_1.ConflictDetectionService,
        availability_validator_service_1.AvailabilityValidatorService])
], BookingService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL2Jvb2tpbmcvYm9va2luZy5zZXJ2aWNlLnRzIiwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7OztBQUFBLDJDQUt3QjtBQUN4QixnRkFBb0U7QUFRcEUsMEVBQXFFO0FBQ3JFLDhFQUF5RTtBQUN6RSxzRkFBaUY7QUFDakYsOEZBQXlGO0FBQ3pGLG9FQUt5QztBQUdsQyxJQUFNLGNBQWMsR0FBcEIsTUFBTSxjQUFjO0lBRU47SUFDQTtJQUNBO0lBQ0E7SUFDQTtJQUxuQixZQUNtQixNQUFxQixFQUNyQixRQUF5QixFQUN6QixhQUFtQyxFQUNuQyxpQkFBMkMsRUFDM0MscUJBQW1EO1FBSm5ELFdBQU0sR0FBTixNQUFNLENBQWU7UUFDckIsYUFBUSxHQUFSLFFBQVEsQ0FBaUI7UUFDekIsa0JBQWEsR0FBYixhQUFhLENBQXNCO1FBQ25DLHNCQUFpQixHQUFqQixpQkFBaUIsQ0FBMEI7UUFDM0MsMEJBQXFCLEdBQXJCLHFCQUFxQixDQUE4QjtJQUNuRSxDQUFDO0lBRUoscUJBQXFCO0lBQ3JCLEtBQUssQ0FBQyxhQUFhLENBQUMsZ0JBQWtDLEVBQUUsUUFBZ0I7UUFDdEUsSUFBSSxDQUFDO1lBQ0gsTUFBTSxFQUFFLFNBQVMsRUFBRSxXQUFXLEVBQUUsUUFBUSxFQUFFLEdBQUcsZ0JBQWdCLENBQUM7WUFDOUQsTUFBTSxhQUFhLEdBQUcsSUFBSSxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7WUFFMUMsa0RBQWtEO1lBQ2xELE1BQU0sSUFBSSxDQUFDLHFCQUFxQixDQUFDLHVCQUF1QixDQUFDO2dCQUN2RCxXQUFXO2dCQUNYLFFBQVE7Z0JBQ1IsU0FBUyxFQUFFLGFBQWE7Z0JBQ3hCLFFBQVE7YUFDVCxDQUFDLENBQUM7WUFFSCxrREFBa0Q7WUFDbEQsTUFBTSxJQUFJLENBQUMsaUJBQWlCLENBQUMsbUJBQW1CLENBQzlDLFdBQVcsRUFDWCxRQUFRLEVBQ1IsYUFBYSxFQUNiLFFBQVEs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LEVBQUU7WUFDOUMsRUFBRSxFQUFFLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxZQUFZLEVBQUUsUUFBUSxFQUFFLEVBQUUsRUFBRTtZQUM5QyxFQUFFLEVBQUUsRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLFlBQVksRUFBRSxRQUFRLEVBQUUsRUFBRSxFQUFFO1lBQzlDLEVBQUUsRUFBRSxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUUsYUFBYSxFQUFFLFFBQVEsRUFBRSxHQUFHLEVBQUU7U0FDbEQsQ0FBQztJQUNKLENBQUM7SUFFRCxnREFBZ0Q7SUFDaEQsS0FBSyxDQUFDLG1CQUFtQixDQUN2QixXQUFtQixFQUNuQixRQUFnQixFQUNoQixTQUF3QixFQUN4QixRQUFnQjtRQUVoQixNQUFNLGFBQWEsR0FBRyxJQUFJLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUUxQyxNQUFNLElBQUksQ0FBQyxxQkFBcUIsQ0FBQyx1QkFBdUIsQ0FBQztZQUN2RCxXQUFXO1lBQ1gsUUFBUTtZQUNSLFNBQVMsRUFBRSxhQUFhO1lBQ3hCLFFBQVE7U0FDVCxDQUFDLENBQUM7UUFFSCxNQUFNLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxtQkFBbUIsQ0FDOUMsV0FBVyxFQUNYLFFBQVEsRUFDUixhQUFhLEVBQ2IsUUFBUSxDQUNULENBQUM7UUFFRixPQUFPLElBQUksQ0FBQztJQUNkLENBQUM7Q0FDRixDQUFBO0FBbGdCWSx3Q0FBYzt5QkFBZCxjQUFjO0lBRDFCLElBQUEsbUJBQVUsR0FBRTtxQ0FHZ0Isc0NBQWE7UUFDWCxtQ0FBZTtRQUNWLDZDQUFvQjtRQUNoQixxREFBd0I7UUFDcEIsNkRBQTRCO0dBTjNELGNBQWMsQ0FrZ0IxQiIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvaG9tZS93ZXRvb2EvRG9jdW1lbnRzL2NvZGUvcHJvamVjdHMvbWVudGFyYS9tZW50YXJhLWFwaS9zcmMvYm9va2luZy9ib29raW5nLnNlcnZpY2UudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgSW5qZWN0YWJsZSxcbiAgQmFkUmVxdWVzdEV4Y2VwdGlvbixcbiAgTm90Rm91bmRFeGNlcHRpb24sXG4gIEZvcmJpZGRlbkV4Y2VwdGlvbixcbn0gZnJvbSAnQG5lc3Rqcy9jb21tb24nO1xuaW1wb3J0IHsgUHJpc21hU2VydmljZSB9IGZyb20gJy4uL3Byb3ZpZGVycy9wcmlzbWEtY2xpZW50LnByb3ZpZGVyJztcbmltcG9ydCB7IE1lZXRpbmdTdGF0dXMgfSBmcm9tICdAcHJpc21hL2NsaWVudCc7XG5pbXBvcnQge1xuICBNZWV0aW5nQ3JlYXRlRHRvLFxuICBNZWV0aW5nVXBkYXRlRHRvLFxuICBUaGVyYXBpc3RBdmFpbGFiaWxpdHlDcmVhdGVEdG8sXG4gIFRoZXJhcGlzdEF2YWlsYWJpbGl0eVVwZGF0ZUR0byxcbn0gZnJvbSAnLi4vLi4vc2NoZW1hL2Jvb2tpbmcnO1xuaW1wb3J0IHsgRXZlbnRCdXNTZXJ2aWNlIH0gZnJvbSAnLi4vY29tbW9uL2V2ZW50cy9ldmVudC1idXMuc2VydmljZSc7XG5pbXBvcnQgeyBTbG90R2VuZXJhdG9yU2VydmljZSB9IGZyb20gJy4vc2VydmljZXMvc2xvdC1nZW5lcmF0b3Iuc2VydmljZSc7XG5pbXBvcnQgeyBDb25mbGljdERldGVjdGlvblNlcnZpY2UgfSBmcm9tICcuL3NlcnZpY2VzL2NvbmZsaWN0LWRldGVjdGlvbi5zZXJ2aWNlJztcbmltcG9ydCB7IEF2YWlsYWJpbGl0eVZhbGlkYXRvclNlcnZpY2UgfSBmcm9tICcuL3NlcnZpY2VzL2F2YWlsYWJpbGl0eS12YWxpZGF0b3Iuc2VydmljZSc7XG5pbXBvcnQge1xuICBBcHBvaW50bWVudEJvb2tlZEV2ZW50LFxuICBBcHBvaW50bWVudENhbmNlbGxlZEV2ZW50LFxuICBBcHBvaW50bWVudENvbXBsZXRlZEV2ZW50LFxuICBBcHBvaW50bWVudFJlc2NoZWR1bGVkRXZlbnQsXG59IGZyb20gJy4uL2NvbW1vbi9ldmVudHMvYm9va2luZy1ldmVudHMnO1xuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgQm9va2luZ1NlcnZpY2Uge1xuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHJlYWRvbmx5IHByaXNtYTogUHJpc21hU2VydmljZSxcbiAgICBwcml2YXRlIHJlYWRvbmx5IGV2ZW50QnVzOiBFdmVudEJ1c1NlcnZpY2UsXG4gICAgcHJpdmF0ZSByZWFkb25seSBzbG90R2VuZXJhdG9yOiBTbG90R2VuZXJhdG9yU2VydmljZSxcbiAgICBwcml2YXRlIHJlYWRvbmx5IGNvbmZsaWN0RGV0ZWN0aW9uOiBDb25mbGljdERldGVjdGlvblNlcnZpY2UsXG4gICAgcHJpdmF0ZSByZWFkb25seSBhdmFpbGFiaWxpdHlWYWxpZGF0b3I6IEF2YWlsYWJpbGl0eVZhbGlkYXRvclNlcnZpY2UsXG4gICkge31cblxuICAvLyBNZWV0aW5nIE1hbmFnZW1lbnRcbiAgYXN5bmMgY3JlYXRlTWVldGluZyhjcmVhdGVNZWV0aW5nRHRvOiBNZWV0aW5nQ3JlYXRlRHRvLCBjbGllbnRJZDogc3RyaW5nKSB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHsgc3RhcnRUaW1lLCB0aGVyYXBpc3RJZCwgZHVyYXRpb24gfSA9IGNyZWF0ZU1lZXRpbmdEdG87XG4gICAgICBjb25zdCBzdGFydFRpbWVEYXRlID0gbmV3IERhdGUoc3RhcnRUaW1lKTtcblxuICAgICAgLy8gQ29tcHJlaGVuc2l2ZSB2YWxpZGF0aW9uIHVzaW5nIG91ciBuZXcgc2VydmljZXNcbiAgICAgIGF3YWl0IHRoaXMuYXZhaWxhYmlsaXR5VmFsaWRhdG9yLnZhbGlkYXRlTWVldGluZ0NyZWF0aW9uKHtcbiAgICAgICAgdGhlcmFwaXN0SWQsXG4gICAgICAgIGNsaWVudElkLFxuICAgICAgICBzdGFydFRpbWU6IHN0YXJ0VGltZURhdGUsXG4gICAgICAgIGR1cmF0aW9uLFxuICAgICAgfSk7XG5cbiAgICAgIC8vIENoZWNrIGZvciBjb25mbGljdHMgdXNpbmcgb3VyIGRlZGljYXRlZCBzZXJ2aWNlXG4gICAgICBhd2FpdCB0aGlzLmNvbmZsaWN0RGV0ZWN0aW9uLnZhbGlkYXRlTm9Db25mbGljdHMoXG4gICAgICAgIHRoZXJhcGlzdElkLFxuICAgICAgICBjbGllbnRJZCxcbiAgICAgICAgc3RhcnRUaW1lRGF0ZSxcbiAgICAgICAgZHVyYXRpb24sXG4gICAgICApO1xuXG4gICAgICAvLyBDcmVhdGUgdGhlIG1lZXRpbmdcbiAgICAgIGNvbnN0IG1lZXRpbmcgPSBhd2FpdCB0aGlzLnByaXNtYS5tZWV0aW5nLmNyZWF0ZSh7XG4gICAgICAgIGRhdGE6IHtcbiAgICAgICAgICAuLi5jcmVhdGVNZWV0aW5nRHRvLFxuICAgICAgICAgIHN0YXR1czogJ1NDSEVEVUxFRCcsXG4gICAgICAgICAgY2xpZW50SWQsXG4gICAgICAgIH0sXG4gICAgICAgIGluY2x1ZGU6IHtcbiAgICAgICAgICBjbGllbnQ6IHtcbiAgICAgICAgICAgIHNlbGVjdDoge1xuICAgICAgICAgICAgICB1c2VyOiB7XG4gICAgICAgICAgICAgICAgc2VsZWN0OiB7XG4gICAgICAgICAgICAgICAgICBmaXJzdE5hbWU6IHRydWUsXG4gICAgICAgICAgICAgICAgICBsYXN0TmFtZTogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgIGVtYWlsOiB0cnVlLFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0sXG4gICAgICAgICAgdGhlcmFwaXN0OiB7XG4gICAgICAgICAgICBzZWxlY3Q6IHtcbiAgICAgICAgICAgICAgdXNlcjoge1xuICAgICAgICAgICAgICAgIHNlbGVjdDoge1xuICAgICAgICAgICAgICAgICAgZmlyc3ROYW1lOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgbGFzdE5hbWU6IHRydWUsXG4gICAgICAgICAgICAgICAgICBlbWFpbDogdHJ1ZSxcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgfSk7XG5cbiAgICAgIC8vIFB1Ymxpc2ggYXBwb2ludG1lbnQgYm9va2VkIGV2ZW50XG4gICAgICBhd2FpdCB0aGlzLmV2ZW50QnVzLmVtaXQoXG4gICAgICAgIG5ldyBBcHBvaW50bWVudEJvb2tlZEV2ZW50KHtcbiAgICAgICAgICBhcHBvaW50bWVudElkOiBtZWV0aW5nLmlkLFxuICAgICAgICAgIGNsaWVudElkOiBtZWV0aW5nLmNsaWVudElkLFxuICAgICAgICAgIHRoZXJhcGlzdElkOiBtZWV0aW5nLnRoZXJhcGlzdElkLFxuICAgICAgICAgIHN0YXJ0VGltZTogbWVldGluZy5zdGFydFRpbWUsXG4gICAgICAgICAgbWVldGluZ1R5cGU6IG1lZXRpbmcubWVldGluZ1R5cGUgYXNcbiAgICAgICAgICAgIHwgJ3ZpZGVvJ1xuICAgICAgICAgICAgfCAnYXVkaW8nXG4gICAgICAgICAgICB8ICdpbl9wZXJzb24nXG4gICAgICAgICAgICB8ICdjaGF0JyxcbiAgICAgICAgICBkdXJhdGlvbjogbWVldGluZy5kdXJhdGlvbixcbiAgICAgICAgICB0aXRsZTogbWVldGluZy50aXRsZSB8fCAnVGhlcmFweSBTZXNzaW9uJyxcbiAgICAgICAgICBkZXNjcmlwdGlvbjogbWVldGluZy5kZXNjcmlwdGlvbiB8fCB1bmRlZmluZWQsXG4gICAgICAgICAgaXNJbml0aWFsQ29uc3VsdGF0aW9uOiBmYWxzZSxcbiAgICAgICAgfSksXG4gICAgICApO1xuXG4gICAgICByZXR1cm4gbWVldGluZztcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFeGNlcHRpb24oXG4gICAgICAgIGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogU3RyaW5nKGVycm9yKSxcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgZ2V0TWVldGluZ3ModXNlcklkOiBzdHJpbmcsIHJvbGU6IHN0cmluZykge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCB3aGVyZSA9XG4gICAgICAgIHJvbGUgPT09ICd0aGVyYXBpc3QnID8geyB0aGVyYXBpc3RJZDogdXNlcklkIH0gOiB7IGNsaWVudElkOiB1c2VySWQgfTtcblxuICAgICAgcmV0dXJuIGF3YWl0IHRoaXMucHJpc21hLm1lZXRpbmcuZmluZE1hbnkoe1xuICAgICAgICB3aGVyZSxcbiAgICAgICAgaW5jbHVkZToge1xuICAgICAgICAgIGNsaWVudDoge1xuICAgICAgICAgICAgc2VsZWN0OiB7XG4gICAgICAgICAgICAgIHVzZXI6IHtcbiAgICAgICAgICAgICAgICBzZWxlY3Q6IHtcbiAgICAgICAgICAgICAgICAgIGZpcnN0TmFtZTogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgIGxhc3ROYW1lOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgZW1haWw6IHRydWUsXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgICB0aGVyYXBpc3Q6IHtcbiAgICAgICAgICAgIHNlbGVjdDoge1xuICAgICAgICAgICAgICB1c2VyOiB7XG4gICAgICAgICAgICAgICAgc2VsZWN0OiB7XG4gICAgICAgICAgICAgICAgICBmaXJzdE5hbWU6IHRydWUsXG4gICAgICAgICAgICAgICAgICBsYXN0TmFtZTogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgIGVtYWlsOiB0cnVlLFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICAgIG9yZGVyQnk6IHsgc3RhcnRUaW1lOiAnZGVzYycgfSxcbiAgICAgIH0pO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdEV4Y2VwdGlvbihcbiAgICAgICAgZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiBTdHJpbmcoZXJyb3IpLFxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBnZXRNZWV0aW5nKGlkOiBzdHJpbmcsIHVzZXJJZDogc3RyaW5nLCByb2xlOiBzdHJpbmcpIHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgbWVldGluZyA9IGF3YWl0IHRoaXMucHJpc21hLm1lZXRpbmcuZmluZFVuaXF1ZSh7XG4gICAgICAgIHdoZXJlOiB7IGlkIH0sXG4gICAgICAgIGluY2x1ZGU6IHtcbiAgICAgICAgICBjbGllbnQ6IHtcbiAgICAgICAgICAgIHNlbGVjdDoge1xuICAgICAgICAgICAgICB1c2VyOiB7XG4gICAgICAgICAgICAgICAgc2VsZWN0OiB7XG4gICAgICAgICAgICAgICAgICBmaXJzdE5hbWU6IHRydWUsXG4gICAgICAgICAgICAgICAgICBsYXN0TmFtZTogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgIGVtYWlsOiB0cnVlLFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0sXG4gICAgICAgICAgdGhlcmFwaXN0OiB7XG4gICAgICAgICAgICBzZWxlY3Q6IHtcbiAgICAgICAgICAgICAgdXNlcjoge1xuICAgICAgICAgICAgICAgIHNlbGVjdDoge1xuICAgICAgICAgICAgICAgICAgZmlyc3ROYW1lOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgbGFzdE5hbWU6IHRydWUsXG4gICAgICAgICAgICAgICAgICBlbWFpbDogdHJ1ZSxcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgfSk7XG5cbiAgICAgIGlmICghbWVldGluZykge1xuICAgICAgICB0aHJvdyBuZXcgTm90Rm91bmRFeGNlcHRpb24oJ01lZXRpbmcgbm90IGZvdW5kJyk7XG4gICAgICB9XG5cbiAgICAgIC8vIFZlcmlmeSB1c2VyIGhhcyBhY2Nlc3MgdG8gdGhpcyBtZWV0aW5nXG4gICAgICBpZiAocm9sZSA9PT0gJ3RoZXJhcGlzdCcgJiYgbWVldGluZy50aGVyYXBpc3RJZCAhPT0gdXNlcklkKSB7XG4gICAgICAgIHRocm93IG5ldyBGb3JiaWRkZW5FeGNlcHRpb24oJ0FjY2VzcyBkZW5pZWQnKTtcbiAgICAgIH1cbiAgICAgIGlmIChyb2xlID09PSAnY2xpZW50JyAmJiBtZWV0aW5nLmNsaWVudElkICE9PSB1c2VySWQpIHtcbiAgICAgICAgdGhyb3cgbmV3IEZvcmJpZGRlbkV4Y2VwdGlvbignQWNjZXNzIGRlbmllZCcpO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gbWVldGluZztcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFeGNlcHRpb24oXG4gICAgICAgIGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogU3RyaW5nKGVycm9yKSxcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgdXBkYXRlTWVldGluZyhcbiAgICBpZDogc3RyaW5nLFxuICAgIHVwZGF0ZU1lZXRpbmdEdG86IE1lZXRpbmdVcGRhdGVEdG8sXG4gICAgdXNlcklkOiBzdHJpbmcsXG4gICAgcm9sZTogc3RyaW5nLFxuICApIHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgbWVldGluZyA9IGF3YWl0IHRoaXMuZ2V0TWVldGluZyhpZCwgdXNlcklkLCByb2xlKTtcblxuICAgICAgLy8gT25seSBhbGxvdyB1cGRhdGVzIGlmIG1lZXRpbmcgaXMgbm90IGNvbXBsZXRlZCBvciBjYW5jZWxsZWRcbiAgICAgIGlmIChbJ0NPTVBMRVRFRCcsICdDQU5DRUxMRUQnXS5pbmNsdWRlcyhtZWV0aW5nLnN0YXR1cykpIHtcbiAgICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFeGNlcHRpb24oXG4gICAgICAgICAgJ0Nhbm5vdCB1cGRhdGUgY29tcGxldGVkIG9yIGNhbmNlbGxlZCBtZWV0aW5ncycsXG4gICAgICAgICk7XG4gICAgICB9XG5cbiAgICAgIC8vIElmIHVwZGF0aW5nIHRpbWUsIHZhbGlkYXRlIHRoZSBuZXcgc2NoZWR1bGVcbiAgICAgIGlmICh1cGRhdGVNZWV0aW5nRHRvLnN0YXJ0VGltZSB8fCB1cGRhdGVNZWV0aW5nRHRvLmR1cmF0aW9uKSB7XG4gICAgICAgIGNvbnN0IG5ld1N0YXJ0VGltZSA9IHVwZGF0ZU1lZXRpbmdEdG8uc3RhcnRUaW1lXG4gICAgICAgICAgPyBuZXcgRGF0ZSh1cGRhdGVNZWV0aW5nRHRvLnN0YXJ0VGltZSlcbiAgICAgICAgICA6IG1lZXRpbmcuc3RhcnRUaW1lO1xuICAgICAgICBjb25zdCBuZXdEdXJhdGlvbiA9IHVwZGF0ZU1lZXRpbmdEdG8uZHVyYXRpb24gfHwgbWVldGluZy5kdXJhdGlvbjtcblxuICAgICAgICAvLyBDaGVjayBmb3IgY29uZmxpY3RzIHdpdGggdGhlIHVwZGF0ZVxuICAgICAgICBjb25zdCBjb25mbGljdHMgPSBhd2FpdCB0aGlzLmNvbmZsaWN0RGV0ZWN0aW9uLmNoZWNrVXBkYXRlQ29uZmxpY3RzKFxuICAgICAgICAgIGlkLFxuICAgICAgICAgIG1lZXRpbmcudGhlcmFwaXN0SWQsXG4gICAgICAgICAgbWVldGluZy5jbGllbnRJZCxcbiAgICAgICAgICBuZXdTdGFydFRpbWUsXG4gICAgICAgICAgbmV3RHVyYXRpb24sXG4gICAgICAgICk7XG5cbiAgICAgICAgaWYgKGNvbmZsaWN0cy5oYXNDb25mbGljdCkge1xuICAgICAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0RXhjZXB0aW9uKFxuICAgICAgICAgICAgYFNjaGVkdWxlIHVwZGF0ZSB3b3VsZCBjYXVzZSBjb25mbGljdHM6ICR7Y29uZmxpY3RzLmNvbmZsaWN0aW5nTWVldGluZ3MubGVuZ3RofSBjb25mbGljdGluZyBtZWV0aW5ncyBmb3VuZGAsXG4gICAgICAgICAgKTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIFZhbGlkYXRlIHRoZXJhcGlzdCBhdmFpbGFiaWxpdHkgZm9yIG5ldyB0aW1lXG4gICAgICAgIGlmICh1cGRhdGVNZWV0aW5nRHRvLnN0YXJ0VGltZSkge1xuICAgICAgICAgIGF3YWl0IHRoaXMuYXZhaWxhYmlsaXR5VmFsaWRhdG9yLnZhbGlkYXRlVGhlcmFwaXN0QXZhaWxhYmlsaXR5KFxuICAgICAgICAgICAgbWVldGluZy50aGVyYXBpc3RJZCxcbiAgICAgICAgICAgIG5ld1N0YXJ0VGltZSxcbiAgICAgICAgICAgIG5ld0R1cmF0aW9uLFxuICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgY29uc3QgdXBkYXRlZE1lZXRpbmcgPSBhd2FpdCB0aGlzLnByaXNtYS5tZWV0aW5nLnVwZGF0ZSh7XG4gICAgICAgIHdoZXJlOiB7IGlkIH0sXG4gICAgICAgIGRhdGE6IHtcbiAgICAgICAgICB0aXRsZTogdXBkYXRlTWVldGluZ0R0by50aXRsZSxcbiAgICAgICAgICBkZXNjcmlwdGlvbjogdXBkYXRlTWVldGluZ0R0by5kZXNjcmlwdGlvbixcbiAgICAgICAgICBzdGFydFRpbWU6IHVwZGF0ZU1lZXRpbmdEdG8uc3RhcnRUaW1lLFxuICAgICAgICAgIGR1cmF0aW9uOiB1cGRhdGVNZWV0aW5nRHRvLmR1cmF0aW9uLFxuICAgICAgICAgIG1lZXRpbmdUeXBlOiB1cGRhdGVNZWV0aW5nRHRvLm1lZXRpbmdUeXBlLFxuICAgICAgICAgIHRoZXJhcGlzdElkOiB1cGRhdGVNZWV0aW5nRHRvLnRoZXJhcGlzdElkLFxuICAgICAgICAgIC4uLih1cGRhdGVNZWV0aW5nRHRvLnN0YXR1cyAmJiB7XG4gICAgICAgICAgICBzdGF0dXM6IHVwZGF0ZU1lZXRpbmdEdG8uc3RhdHVzIGFzIE1lZXRpbmdTdGF0dXMsXG4gICAgICAgICAgfSksXG4gICAgICAgIH0sXG4gICAgICAgIGluY2x1ZGU6IHtcbiAgICAgICAgICBjbGllbnQ6IHtcbiAgICAgICAgICAgIHNlbGVjdDoge1xuICAgICAgICAgICAgICB1c2VyOiB7XG4gICAgICAgICAgICAgICAgc2VsZWN0OiB7XG4gICAgICAgICAgICAgICAgICBmaXJzdE5hbWU6IHRydWUsXG4gICAgICAgICAgICAgICAgICBsYXN0TmFtZTogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgIGVtYWlsOiB0cnVlLFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0sXG4gICAgICAgICAgdGhlcmFwaXN0OiB7XG4gICAgICAgICAgICBzZWxlY3Q6IHtcbiAgICAgICAgICAgICAgdXNlcjoge1xuICAgICAgICAgICAgICAgIHNlbGVjdDoge1xuICAgICAgICAgICAgICAgICAgZmlyc3ROYW1lOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgbGFzdE5hbWU6IHRydWUsXG4gICAgICAgICAgICAgICAgICBlbWFpbDogdHJ1ZSxcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgfSk7XG5cbiAgICAgIC8vIFB1Ymxpc2ggYXBwcm9wcmlhdGUgZXZlbnRzXG4gICAgICBpZiAodXBkYXRlTWVldGluZ0R0by5zdGF0dXMgPT09ICdDT01QTEVURUQnKSB7XG4gICAgICAgIGF3YWl0IHRoaXMuZXZlbnRCdXMuZW1pdChcbiAgICAgICAgICBuZXcgQXBwb2ludG1lbnRDb21wbGV0ZWRFdmVudCh7XG4gICAgICAgICAgICBhcHBvaW50bWVudElkOiB1cGRhdGVkTWVldGluZy5pZCxcbiAgICAgICAgICAgIGNsaWVudElkOiB1cGRhdGVkTWVldGluZy5jbGllbnRJZCxcbiAgICAgICAgICAgIHRoZXJhcGlzdElkOiB1cGRhdGVkTWVldGluZy50aGVyYXBpc3RJZCxcbiAgICAgICAgICAgIGNvbXBsZXRlZEF0OiBuZXcgRGF0ZSgpLFxuICAgICAgICAgICAgZHVyYXRpb246IHVwZGF0ZWRNZWV0aW5nLmR1cmF0aW9uLFxuICAgICAgICAgICAgc2Vzc2lvbk5vdGVzOiB1cGRhdGVNZWV0aW5nRHRvLmRlc2NyaXB0aW9uIHx8ICcnLFxuICAgICAgICAgICAgYXR0ZW5kYW5jZVN0YXR1czogJ0FUVEVOREVEJyxcbiAgICAgICAgICB9KSxcbiAgICAgICAgKTtcbiAgICAgIH0gZWxzZSBpZiAoXG4gICAgICAgIHVwZGF0ZU1lZXRpbmdEdG8uc3RhcnRUaW1lICYmXG4gICAgICAgIG5ldyBEYXRlKHVwZGF0ZU1lZXRpbmdEdG8uc3RhcnRUaW1lKS5nZXRUaW1lKCkgIT09XG4gICAgICAgICAgbWVldGluZy5zdGFydFRpbWUuZ2V0VGltZSgpXG4gICAgICApIHtcbiAgICAgICAgYXdhaXQgdGhpcy5ldmVudEJ1cy5lbWl0KFxuICAgICAgICAgIG5ldyBBcHBvaW50bWVudFJlc2NoZWR1bGVkRXZlbnQoe1xuICAgICAgICAgICAgYXBwb2ludG1lbnRJZDogdXBkYXRlZE1lZXRpbmcuaWQsXG4gICAgICAgICAgICBjbGllbnRJZDogdXBkYXRlZE1lZXRpbmcuY2xpZW50SWQsXG4gICAgICAgICAgICB0aGVyYXBpc3RJZDogdXBkYXRlZE1lZXRpbmcudGhlcmFwaXN0SWQsXG4gICAgICAgICAgICByZXNjaGVkdWxlZEJ5OiB1c2VySWQsXG4gICAgICAgICAgICBvcmlnaW5hbFN0YXJ0VGltZTogbWVldGluZy5zdGFydFRpbWUsXG4gICAgICAgICAgICBuZXdTdGFydFRpbWU6IG5ldyBEYXRlKHVwZGF0ZU1lZXRpbmdEdG8uc3RhcnRUaW1lKSxcbiAgICAgICAgICAgIHJlc2NoZWR1bGVSZWFzb246IGBSZXNjaGVkdWxlZCBieSAke3JvbGV9YCxcbiAgICAgICAgICB9KSxcbiAgICAgICAgKTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHVwZGF0ZWRNZWV0aW5nO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdEV4Y2VwdGlvbihcbiAgICAgICAgZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiBTdHJpbmcoZXJyb3IpLFxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBjYW5jZWxNZWV0aW5nKGlkOiBzdHJpbmcsIHVzZXJJZDogc3RyaW5nLCByb2xlOiBzdHJpbmcpIHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgbWVldGluZyA9IGF3YWl0IHRoaXMuZ2V0TWVldGluZyhpZCwgdXNlcklkLCByb2xlKTtcblxuICAgICAgaWYgKG1lZXRpbmcuc3RhdHVzID09PSAnQ0FOQ0VMTEVEJykge1xuICAgICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdEV4Y2VwdGlvbignTWVldGluZyBpcyBhbHJlYWR5IGNhbmNlbGxlZCcpO1xuICAgICAgfVxuXG4gICAgICBpZiAobWVldGluZy5zdGF0dXMgPT09ICdDT01QTEVURUQnKSB7XG4gICAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0RXhjZXB0aW9uKCdDYW5ub3QgY2FuY2VsIGNvbXBsZXRlZCBtZWV0aW5ncycpO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBjYW5jZWxsZWRNZWV0aW5nID0gYXdhaXQgdGhpcy5wcmlzbWEubWVldGluZy51cGRhdGUoe1xuICAgICAgICB3aGVyZTogeyBpZCB9LFxuICAgICAgICBkYXRhOiB7IHN0YXR1czogJ0NBTkNFTExFRCcgfSxcbiAgICAgICAgaW5jbHVkZToge1xuICAgICAgICAgIGNsaWVudDoge1xuICAgICAgICAgICAgc2VsZWN0OiB7XG4gICAgICAgICAgICAgIHVzZXI6IHtcbiAgICAgICAgICAgICAgICBzZWxlY3Q6IHtcbiAgICAgICAgICAgICAgICAgIGZpcnN0TmFtZTogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgIGxhc3ROYW1lOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgZW1haWw6IHRydWUsXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgICB0aGVyYXBpc3Q6IHtcbiAgICAgICAgICAgIHNlbGVjdDoge1xuICAgICAgICAgICAgICB1c2VyOiB7XG4gICAgICAgICAgICAgICAgc2VsZWN0OiB7XG4gICAgICAgICAgICAgICAgICBmaXJzdE5hbWU6IHRydWUsXG4gICAgICAgICAgICAgICAgICBsYXN0TmFtZTogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgIGVtYWlsOiB0cnVlLFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICB9KTtcblxuICAgICAgLy8gQ2FsY3VsYXRlIGNhbmNlbGxhdGlvbiBub3RpY2VcbiAgICAgIGNvbnN0IGNhbmNlbGxhdGlvbk5vdGljZSA9IE1hdGguZmxvb3IoXG4gICAgICAgIChtZWV0aW5nLnN0YXJ0VGltZS5nZXRUaW1lKCkgLSBEYXRlLm5vdygpKSAvICgxMDAwICogNjAgKiA2MCksXG4gICAgICApO1xuXG4gICAgICAvLyBQdWJsaXNoIGNhbmNlbGxhdGlvbiBldmVudFxuICAgICAgYXdhaXQgdGhpcy5ldmVudEJ1cy5lbWl0KFxuICAgICAgICBuZXcgQXBwb2ludG1lbnRDYW5jZWxsZWRFdmVudCh7XG4gICAgICAgICAgYXBwb2ludG1lbnRJZDogY2FuY2VsbGVkTWVldGluZy5pZCxcbiAgICAgICAgICBjbGllbnRJZDogY2FuY2VsbGVkTWVldGluZy5jbGllbnRJZCxcbiAgICAgICAgICB0aGVyYXBpc3RJZDogY2FuY2VsbGVkTWVldGluZy50aGVyYXBpc3RJZCxcbiAgICAgICAgICBjYW5jZWxsZWRCeTogdXNlcklkLFxuICAgICAgICAgIGNhbmNlbGxhdGlvblJlYXNvbjpcbiAgICAgICAgICAgIHJvbGUgPT09ICdjbGllbnQnXG4gICAgICAgICAgICAgID8gJ0NhbmNlbGxlZCBieSBjbGllbnQnXG4gICAgICAgICAgICAgIDogJ0NhbmNlbGxlZCBieSB0aGVyYXBpc3QnLFxuICAgICAgICAgIG9yaWdpbmFsU3RhcnRUaW1lOiBtZWV0aW5nLnN0YXJ0VGltZSxcbiAgICAgICAgICBjYW5jZWxsZWRBdDogbmV3IERhdGUoKSxcbiAgICAgICAgICBjYW5jZWxsYXRpb25Ob3RpY2U6IE1hdGgubWF4KDAsIGNhbmNlbGxhdGlvbk5vdGljZSksXG4gICAgICAgIH0pLFxuICAgICAgKTtcblxuICAgICAgcmV0dXJuIGNhbmNlbGxlZE1lZXRpbmc7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0RXhjZXB0aW9uKFxuICAgICAgICBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6IFN0cmluZyhlcnJvciksXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIC8vIEF2YWlsYWJpbGl0eSBNYW5hZ2VtZW50XG4gIGFzeW5jIGNyZWF0ZUF2YWlsYWJpbGl0eShcbiAgICBjcmVhdGVBdmFpbGFiaWxpdHlEdG86IFRoZXJhcGlzdEF2YWlsYWJpbGl0eUNyZWF0ZUR0byxcbiAgICB0aGVyYXBpc3RJZDogc3RyaW5nLFxuICApIHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgeyBkYXlPZldlZWssIHN0YXJ0VGltZSwgZW5kVGltZSwgbm90ZXMgfSA9IGNyZWF0ZUF2YWlsYWJpbGl0eUR0bztcblxuICAgICAgLy8gVmFsaWRhdGUgdXNpbmcgb3VyIG5ldyBzZXJ2aWNlXG4gICAgICBhd2FpdCB0aGlzLmF2YWlsYWJpbGl0eVZhbGlkYXRvci52YWxpZGF0ZUF2YWlsYWJpbGl0eUNyZWF0aW9uKHtcbiAgICAgICAgdGhlcmFwaXN0SWQsXG4gICAgICAgIGRheU9mV2VlayxcbiAgICAgICAgc3RhcnRUaW1lLFxuICAgICAgICBlbmRUaW1lLFxuICAgICAgfSk7XG5cbiAgICAgIHJldHVybiB0aGlzLnByaXNtYS50aGVyYXBpc3RBdmFpbGFiaWxpdHkuY3JlYXRlKHtcbiAgICAgICAgZGF0YToge1xuICAgICAgICAgIHRoZXJhcGlzdElkLFxuICAgICAgICAgIGRheU9mV2VlayxcbiAgICAgICAgICBzdGFydFRpbWUsXG4gICAgICAgICAgZW5kVGltZSxcbiAgICAgICAgICBub3RlcyxcbiAgICAgICAgfSxcbiAgICAgIH0pO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdEV4Y2VwdGlvbihcbiAgICAgICAgZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiBTdHJpbmcoZXJyb3IpLFxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBnZXRBdmFpbGFiaWxpdHkodGhlcmFwaXN0SWQ6IHN0cmluZykge1xuICAgIHRyeSB7XG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy5wcmlzbWEudGhlcmFwaXN0QXZhaWxhYmlsaXR5LmZpbmRNYW55KHtcbiAgICAgICAgd2hlcmU6IHsgdGhlcmFwaXN0SWQgfSxcbiAgICAgICAgb3JkZXJCeTogW3sgZGF5T2ZXZWVrOiAnYXNjJyB9LCB7IHN0YXJ0VGltZTogJ2FzYycgfV0sXG4gICAgICB9KTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFeGNlcHRpb24oXG4gICAgICAgIGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogU3RyaW5nKGVycm9yKSxcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgdXBkYXRlQXZhaWxhYmlsaXR5KFxuICAgIGlkOiBzdHJpbmcsXG4gICAgdXBkYXRlQXZhaWxhYmlsaXR5RHRvOiBUaGVyYXBpc3RBdmFpbGFiaWxpdHlVcGRhdGVEdG8sXG4gICAgdGhlcmFwaXN0SWQ6IHN0cmluZyxcbiAgKSB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGF2YWlsYWJpbGl0eSA9IGF3YWl0IHRoaXMucHJpc21hLnRoZXJhcGlzdEF2YWlsYWJpbGl0eS5maW5kRmlyc3Qoe1xuICAgICAgICB3aGVyZTogeyBpZCwgdGhlcmFwaXN0SWQgfSxcbiAgICAgIH0pO1xuXG4gICAgICBpZiAoIWF2YWlsYWJpbGl0eSkge1xuICAgICAgICB0aHJvdyBuZXcgTm90Rm91bmRFeGNlcHRpb24oJ0F2YWlsYWJpbGl0eSBzbG90IG5vdCBmb3VuZCcpO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gdGhpcy5wcmlzbWEudGhlcmFwaXN0QXZhaWxhYmlsaXR5LnVwZGF0ZSh7XG4gICAgICAgIHdoZXJlOiB7IGlkIH0sXG4gICAgICAgIGRhdGE6IHVwZGF0ZUF2YWlsYWJpbGl0eUR0byxcbiAgICAgIH0pO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdEV4Y2VwdGlvbihcbiAgICAgICAgZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiBTdHJpbmcoZXJyb3IpLFxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBkZWxldGVBdmFpbGFiaWxpdHkoaWQ6IHN0cmluZywgdGhlcmFwaXN0SWQ6IHN0cmluZykge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBhdmFpbGFiaWxpdHkgPSBhd2FpdCB0aGlzLnByaXNtYS50aGVyYXBpc3RBdmFpbGFiaWxpdHkuZmluZEZpcnN0KHtcbiAgICAgICAgd2hlcmU6IHsgaWQsIHRoZXJhcGlzdElkIH0sXG4gICAgICB9KTtcblxuICAgICAgaWYgKCFhdmFpbGFiaWxpdHkpIHtcbiAgICAgICAgdGhyb3cgbmV3IE5vdEZvdW5kRXhjZXB0aW9uKCdBdmFpbGFiaWxpdHkgc2xvdCBub3QgZm91bmQnKTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHRoaXMucHJpc21hLnRoZXJhcGlzdEF2YWlsYWJpbGl0eS5kZWxldGUoe1xuICAgICAgICB3aGVyZTogeyBpZCB9LFxuICAgICAgfSk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0RXhjZXB0aW9uKFxuICAgICAgICBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6IFN0cmluZyhlcnJvciksXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIC8vIFNpbXBsaWZpZWQgc2xvdCBnZW5lcmF0aW9uIHVzaW5nIG91ciBuZXcgc2VydmljZVxuICBhc3luYyBnZXRBdmFpbGFibGVTbG90cyh0aGVyYXBpc3RJZDogc3RyaW5nLCBkYXRlOiBzdHJpbmcpIHtcbiAgICB0cnkge1xuICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuc2xvdEdlbmVyYXRvci5nZW5lcmF0ZUF2YWlsYWJsZVNsb3RzKHRoZXJhcGlzdElkLCBkYXRlKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFeGNlcHRpb24oXG4gICAgICAgIGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogU3RyaW5nKGVycm9yKSxcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgLy8gRHVyYXRpb24gbWFuYWdlbWVudFxuICBnZXREdXJhdGlvbnMoKSB7XG4gICAgcmV0dXJuIFtcbiAgICAgIHsgaWQ6ICczMCcsIG5hbWU6ICczMCBtaW51dGVzJywgZHVyYXRpb246IDMwIH0sXG4gICAgICB7IGlkOiAnNjAnLCBuYW1lOiAnNjAgbWludXRlcycsIGR1cmF0aW9uOiA2MCB9LFxuICAgICAgeyBpZDogJzkwJywgbmFtZTogJzkwIG1pbnV0ZXMnLCBkdXJhdGlvbjogOTAgfSxcbiAgICAgIHsgaWQ6ICcxMjAnLCBuYW1lOiAnMTIwIG1pbnV0ZXMnLCBkdXJhdGlvbjogMTIwIH0sXG4gICAgXTtcbiAgfVxuXG4gIC8vIEVuaGFuY2VkIHZhbGlkYXRpb24gbWV0aG9kIHVzaW5nIG91ciBzZXJ2aWNlc1xuICBhc3luYyB2YWxpZGF0ZU1lZXRpbmdUaW1lKFxuICAgIHRoZXJhcGlzdElkOiBzdHJpbmcsXG4gICAgY2xpZW50SWQ6IHN0cmluZyxcbiAgICBzdGFydFRpbWU6IHN0cmluZyB8IERhdGUsXG4gICAgZHVyYXRpb246IG51bWJlcixcbiAgKSB7XG4gICAgY29uc3Qgc3RhcnRUaW1lRGF0ZSA9IG5ldyBEYXRlKHN0YXJ0VGltZSk7XG5cbiAgICBhd2FpdCB0aGlzLmF2YWlsYWJpbGl0eVZhbGlkYXRvci52YWxpZGF0ZU1lZXRpbmdDcmVhdGlvbih7XG4gICAgICB0aGVyYXBpc3RJZCxcbiAgICAgIGNsaWVudElkLFxuICAgICAgc3RhcnRUaW1lOiBzdGFydFRpbWVEYXRlLFxuICAgICAgZHVyYXRpb24sXG4gICAgfSk7XG5cbiAgICBhd2FpdCB0aGlzLmNvbmZsaWN0RGV0ZWN0aW9uLnZhbGlkYXRlTm9Db25mbGljdHMoXG4gICAgICB0aGVyYXBpc3RJZCxcbiAgICAgIGNsaWVudElkLFxuICAgICAgc3RhcnRUaW1lRGF0ZSxcbiAgICAgIGR1cmF0aW9uLFxuICAgICk7XG5cbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxufVxuIl0sInZlcnNpb24iOjN9