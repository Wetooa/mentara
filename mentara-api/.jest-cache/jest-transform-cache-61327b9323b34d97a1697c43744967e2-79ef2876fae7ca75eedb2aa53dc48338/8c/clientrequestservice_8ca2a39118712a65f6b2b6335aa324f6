f92d9d299edbd4753eacdd5c5f838ba1
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var ClientRequestService_1;
var _a, _b;
Object.defineProperty(exports, "__esModule", { value: true });
exports.ClientRequestService = void 0;
const common_1 = require("@nestjs/common");
const prisma_client_provider_1 = require("../../providers/prisma-client.provider");
const notifications_service_1 = require("../../notifications/notifications.service");
let ClientRequestService = ClientRequestService_1 = class ClientRequestService {
    prisma;
    notificationsService;
    logger = new common_1.Logger(ClientRequestService_1.name);
    constructor(prisma, notificationsService) {
        this.prisma = prisma;
        this.notificationsService = notificationsService;
    }
    // ===== SENDING THERAPIST REQUESTS =====
    async sendTherapistRequest(clientId, therapistId, requestDto) {
        try {
            return await this.prisma.$transaction(async (tx) => {
                // 1. Verify client exists and is active
                const client = await tx.client.findUnique({
                    where: { userId: clientId },
                    include: { user: true },
                });
                if (!client) {
                    throw new common_1.NotFoundException(`Client with ID ${clientId} not found`);
                }
                if (!client.user.isActive) {
                    throw new common_1.ForbiddenException('Client account is not active');
                }
                // 2. Verify therapist exists and is approved
                const therapist = await tx.therapist.findUnique({
                    where: { userId: therapistId },
                    include: { user: true },
                });
                if (!therapist) {
                    throw new common_1.NotFoundException(`Therapist with ID ${therapistId} not found`);
                }
                if (therapist.status !== 'approved') {
                    throw new common_1.BadRequestException('Cannot send request to unapproved therapist');
                }
                if (!therapist.user.isActive) {
                    throw new common_1.BadRequestException('Therapist is not currently active');
                }
                // 3. Check for existing active requests
                const existingRequest = await tx.clientTherapistRequest.findFirst({
                    where: {
                        clientId,
                        therapistId,
                        status: { in: ['PENDING', 'ACCEPTED'] },
                    },
                });
                if (existingRequest) {
                    throw new common_1.ConflictException(`An active request already exists between client ${clientId} and therapist ${therapistId}`);
                }
                // 4. Check for existing client-therapist relationship
                const existingRelationship = await tx.clientTherapist.findFirst({
                    where: {
                        clientId,
                        therapistId,
                        status: 'active',
                    },
                });
                if (existingRelationship) {
                    throw new common_1.ConflictException('Client already has an active relationship with this therapist');
                }
                // 5. Create the request with auto-expiry (7 days)
                const expiryDate = new Date();
                expiryDate.setDate(expiryDate.getDate() + 7);
                const request = await tx.clientTherapistRequest.create({
                    data: {
                        clientId,
                        therapistId,
                        status: 'PENDING',
                        priority: requestDto.priority || 'NORMAL',
                        clientMessage: requestDto.message,
                        recommendationRank: requestDto.recommendationRank,
                        matchScore: requestDto.matchScore,
                        expiresAt: expiryDate,
                    },
                    include: {
                        client: {
                            include: {
                                user: {
                                    select: {
                                        firstName: true,
                                        lastName: true,
                                        avatarUrl: true,
                                    },
                                },
                            },
                        },
                        therapist: {
                            include: {
                                user: {
                                    select: {
                                        firstName: true,
                                        lastName: true,
                                        avatarUrl: true,
                                    },
                                },
                            },
                        },
                    },
                });
                // 6. Send notification to therapist
                await this.notificationsService.create({
                    userId: therapistId,
                    title: 'New Client Request',
                    message: `${client.user.firstName} ${client.user.lastName} has sent you a therapy request.`,
                    type: 'CLIENT_REQUEST_RECEIVED',
                    priority: requestDto.priority === 'HIGH' || requestDto.priority === 'URGENT'
                        ? 'HIGH'
                        : 'NORMAL',
                    actionUrl: `/therapist/requests/${request.id}`,
                    data: {
                        requestId: request.id,
                        clientId,
                        clientName: `${client.user.firstName} ${client.user.lastName}`,
                    },
                });
                // 7. Create audit log
                await tx.auditLog.create({
                    data: {
                        userId: clientId,
                        action: 'SEND_THERAPIST_REQUEST',
                        entity: 'client_therapist_request',
                        entityId: request.id,
                        metadata: {
                            clientId,
                            therapistId,
                            priority: requestDto.priority,
                            hasMessage: !!requestDto.message,
                            recommendationRank: requestDto.recommendationRank,
                            timestamp: new Date().toISOString(),
                        },
                    },
                });
                this.logger.log(`Client ${clientId} sent request to therapist ${therapistId} with priority ${requestDto.priority}`);
                return {
                    success: true,
                    request,
                    message: 'Therapist request sent successfully',
                    expiresAt: expiryDate,
                };
            });
        }
        catch (error) {
            this.logger.error(`Failed to send therapist request from ${clientId} to ${therapistId}:`, error);
            throw error;
        }
    }
    async sendMultipleTherapistRequests(clientId, requestData) {
        try {
            const { therapistIds, message, priority = 'NORMAL' } = requestData;
            // Validate therapist IDs limit
            if (therapistIds.length > 10) {
                throw new common_1.BadRequestException('Cannot send requests to more than 10 therapists at once');
            }
            const results = {
                successful: [],
                failed: [],
                totalSent: 0,
            };
            // Process requests in parallel with controlled concurrency (max 3 concurrent)
            // This avoids database lock contention while maintaining good performance
            const concurrencyLimit = 3;
            const chunks = this.chunkArray(therapistIds, concurrencyLimit);
            for (const chunk of chunks) {
                const chunkPromises = chunk.map(async (therapistId) => {
                    try {
                        const result = await this.sendTherapistRequest(clientId, therapistId, {
                            message,
                            priority: priority,
                        });
                        return {
                            success: true,
                            therapistId,
                            requestId: result.request.id,
                        };
                    }
                    catch (error) {
                        this.logger.warn(`Failed to send request to therapist ${therapistId}`, {
                            error: error instanceof Error ? error.message : String(error),
                            clientId,
                            therapistId,
                        });
                        return {
                            success: false,
                            therapistId,
                            error: error instanceof Error ? error.message : 'Unknown error',
                        };
                    }
                });
                // Wait for all requests in this chunk to complete
                const chunkResults = await Promise.all(chunkPromises);
                // Process results
                chunkResults.forEach((result) => {
                    if (result.success) {
                        results.successful.push({
                            therapistId: result.therapistId,
                            requestId: result.requestId,
                            status: 'sent',
                        });
                        results.totalSent++;
                    }
                    else {
                        results.failed.push({
                            therapistId: result.therapistId,
                            error: result.error,
                        });
                    }
                });
                // Add small delay between chunks to prevent overwhelming the database
                if (chunks.indexOf(chunk) < chunks.length - 1) {
                    await new Promise((resolve) => setTimeout(resolve, 100));
                }
            }
            this.logger.log(`Client ${clientId} sent bulk requests: ${results.totalSent} successful, ${results.failed.length} failed`);
            return {
                success: true,
                results,
                summary: {
                    totalRequested: therapistIds.length,
                    totalSent: results.totalSent,
                    totalFailed: results.failed.length,
                },
            };
        }
        catch (error) {
            this.logger.error(`Failed to send multiple therapist requests for client ${clientId}:`, error);
            throw error;
        }
    }
    // ===== RETRIEVING CLIENT REQUESTS =====
    async getClientRequests(clientId, filters) {
        try {
            const { status, priority, therapistId, requestedAfter, requestedBefore, page = 1, limit = 20, sortBy = 'requestedAt', sortOrder = 'desc', } = filters;
            const skip = (page - 1) * limit;
            const where = {
                clientId,
            };
            // Apply filters
            if (status)
                where.status = status;
            if (priority)
                where.priority = priority;
            if (therapistId)
                where.therapistId = therapistId;
            if (requestedAfter || requestedBefore) {
                const requestedAtFilter = {};
                if (requestedAfter)
                    requestedAtFilter.gte = new Date(requestedAfter);
                if (requestedBefore)
                    requestedAtFilter.lte = new Date(requestedBefore);
                where.requestedAt = requestedAtFilter;
            }
            const [requests, totalCount] = await Promise.all([
                this.prisma.clientTherapistRequest.findMany({
                    where,
                    skip,
                    take: limit,
                    orderBy: { [sortBy]: sortOrder },
                    include: {
                        therapist: {
                            include: {
                                user: {
                                    select: {
                                        firstName: true,
                                        lastName: true,
                                        avatarUrl: true,
                                    },
                                },
                            },
                        },
                    },
                }),
                this.prisma.clientTherapistRequest.count({ where }),
            ]);
            this.logger.log(`Retrieved ${requests.length} requests for client ${clientId}`);
            return {
                requests,
                pagination: {
                    page,
                    limit,
                    totalCount,
                    totalPages: Math.ceil(totalCount / limit),
                },
                filters,
            };
        }
        catch (error) {
            this.logger.error(`Failed to retrieve requests for client ${clientId}:`, error);
            throw error;
        }
    }
    // ===== REQUEST MANAGEMENT =====
    async cancelRequest(requestId, clientId, reason) {
        try {
            return await this.prisma.$transaction(async (tx) => {
                // 1. Verify request exists and belongs to client
                const existingRequest = await tx.clientTherapistRequest.findUnique({
                    where: { id: requestId },
                    include: {
                        therapist: {
                            include: {
                                user: {
                                    select: {
                                        firstName: true,
                                        lastName: true,
                                    },
                                },
                            },
                        },
                    },
                });
                if (!existingRequest) {
                    throw new common_1.NotFoundException(`Request with ID ${requestId} not found`);
                }
                if (existingRequest.clientId !== clientId) {
                    throw new common_1.ForbiddenException('You can only cancel your own requests');
                }
                if (existingRequest.status !== 'PENDING') {
                    throw new common_1.BadRequestException(`Cannot cancel request with status ${existingRequest.status}`);
                }
                // 2. Update request status to cancelled
                const cancelledRequest = await tx.clientTherapistRequest.update({
                    where: { id: requestId },
                    data: {
                        status: 'CANCELLED',
                        respondedAt: new Date(),
                    },
                });
                // 3. Notify therapist of cancellation
                await this.notificationsService.create({
                    userId: existingRequest.therapistId,
                    title: 'Client Request Cancelled',
                    message: `A client request has been cancelled.${reason ? ` Reason: ${reason}` : ''}`,
                    type: 'CLIENT_REQUEST_CANCELLED',
                    priority: 'NORMAL',
                    actionUrl: '/therapist/requests',
                });
                // 4. Create audit log
                await tx.auditLog.create({
                    data: {
                        userId: clientId,
                        action: 'CANCEL_THERAPIST_REQUEST',
                        entity: 'client_therapist_request',
                        entityId: requestId,
                        metadata: {
                            requestId,
                            therapistId: existingRequest.therapistId,
                            reason,
                            timestamp: new Date().toISOString(),
                        },
                    },
                });
                this.logger.log(`Client ${clientId} cancelled request ${requestId}`);
                return {
                    success: true,
                    request: cancelledRequest,
                    message: 'Request cancelled successfully',
                };
            });
        }
        catch (error) {
            this.logger.error(`Failed to cancel request ${requestId} for client ${clientId}:`, error);
            throw error;
        }
    }
    // ===== STATISTICS AND ANALYTICS =====
    async getClientRequestStatistics(clientId) {
        try {
            const [totalSent, pending, accepted, declined, expired, cancelled, recentRequests,] = await Promise.all([
                // Total requests sent
                this.prisma.clientTherapistRequest.count({
                    where: { clientId },
                }),
                // Pending requests
                this.prisma.clientTherapistRequest.count({
                    where: { clientId, status: 'PENDING' },
                }),
                // Accepted requests
                this.prisma.clientTherapistRequest.count({
                    where: { clientId, status: 'ACCEPTED' },
                }),
                // Declined requests
                this.prisma.clientTherapistRequest.count({
                    where: { clientId, status: 'DECLINED' },
                }),
                // Expired requests
                this.prisma.clientTherapistRequest.count({
                    where: { clientId, status: 'EXPIRED' },
                }),
                // Cancelled requests
                this.prisma.clientTherapistRequest.count({
                    where: { clientId, status: 'CANCELLED' },
                }),
                // Recent requests for response time calculation
                this.prisma.clientTherapistRequest.findMany({
                    where: {
                        clientId,
                        respondedAt: { not: null },
                    },
                    select: {
                        requestedAt: true,
                        respondedAt: true,
                    },
                    orderBy: { respondedAt: 'desc' },
                    take: 10,
                }),
            ]);
            // Calculate acceptance rate
            const totalResponded = accepted + declined;
            const acceptanceRate = totalResponded > 0 ? (accepted / totalResponded) * 100 : 0;
            // Calculate average response time
            const responseTimes = recentRequests
                .filter((req) => req.respondedAt)
                .map((req) => {
                const responseTime = req.respondedAt.getTime() - req.requestedAt.getTime();
                return responseTime / (1000 * 60 * 60); // Convert to hours
            });
            const averageResponseTime = responseTimes.length > 0
                ? responseTimes.reduce((sum, time) => sum + time, 0) /
                    responseTimes.length
                : 0;
            // Get last request and response dates
            const lastRequest = await this.prisma.clientTherapistRequest.findFirst({
                where: { clientId },
                orderBy: { requestedAt: 'desc' },
                select: { requestedAt: true },
            });
            const lastResponse = await this.prisma.clientTherapistRequest.findFirst({
                where: { clientId, respondedAt: { not: null } },
                orderBy: { respondedAt: 'desc' },
                select: { respondedAt: true },
            });
            this.logger.log(`Generated request statistics for client ${clientId}`);
            return {
                totalSent,
                pending,
                accepted,
                declined,
                expired,
                cancelled,
                acceptanceRate: Math.round(acceptanceRate * 100) / 100,
                averageResponseTime: Math.round(averageResponseTime * 100) / 100,
                lastRequestAt: lastRequest?.requestedAt || null,
                lastResponseAt: lastResponse?.respondedAt || null,
            };
        }
        catch (error) {
            this.logger.error(`Failed to generate statistics for client ${clientId}:`, error);
            throw error;
        }
    }
    // ===== UTILITY METHODS =====
    async expireStaleRequests() {
        try {
            const now = new Date();
            const expiredRequests = await this.prisma.clientTherapistRequest.updateMany({
                where: {
                    status: 'PENDING',
                    expiresAt: { lte: now },
                },
                data: {
                    status: 'EXPIRED',
                    respondedAt: now,
                },
            });
            this.logger.log(`Expired ${expiredRequests.count} stale requests`);
            return {
                success: true,
                expiredCount: expiredRequests.count,
            };
        }
        catch (error) {
            this.logger.error('Failed to expire stale requests:', error);
            throw error;
        }
    }
    /**
     * Helper method to split array into chunks for controlled parallel processing
     */
    chunkArray(array, chunkSize) {
        const chunks = [];
        for (let i = 0; i < array.length; i += chunkSize) {
            chunks.push(array.slice(i, i + chunkSize));
        }
        return chunks;
    }
};
exports.ClientRequestService = ClientRequestService;
exports.ClientRequestService = ClientRequestService = ClientRequestService_1 = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [typeof (_a = typeof prisma_client_provider_1.PrismaService !== "undefined" && prisma_client_provider_1.PrismaService) === "function" ? _a : Object, typeof (_b = typeof notifications_service_1.NotificationsService !== "undefined" && notifications_service_1.NotificationsService) === "function" ? _b : Object])
], ClientRequestService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL2NsaWVudC9zZXJ2aWNlcy9jbGllbnQtcmVxdWVzdC5zZXJ2aWNlLnRzIiwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7O0FBQUEsMkNBT3dCO0FBQ3hCLG1GQUF1RTtBQUN2RSxxRkFBaUY7QUFTMUUsSUFBTSxvQkFBb0IsNEJBQTFCLE1BQU0sb0JBQW9CO0lBSVo7SUFDQTtJQUpGLE1BQU0sR0FBRyxJQUFJLGVBQU0sQ0FBQyxzQkFBb0IsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUVoRSxZQUNtQixNQUFxQixFQUNyQixvQkFBMEM7UUFEMUMsV0FBTSxHQUFOLE1BQU0sQ0FBZTtRQUNyQix5QkFBb0IsR0FBcEIsb0JBQW9CLENBQXNCO0lBQzFELENBQUM7SUFFSix5Q0FBeUM7SUFFekMsS0FBSyxDQUFDLG9CQUFvQixDQUN4QixRQUFnQixFQUNoQixXQUFtQixFQUNuQixVQUFtQztRQUVuQyxJQUFJLENBQUM7WUFDSCxPQUFPLE1BQU0sSUFBSSxDQUFDLE1BQU0sQ0FBQyxZQUFZLENBQUMsS0FBSyxFQUFFLEVBQUUsRUFBRSxFQUFFO2dCQUNqRCx3Q0FBd0M7Z0JBQ3hDLE1BQU0sTUFBTSxHQUFHLE1BQU0sRUFBRSxDQUFDLE1BQU0sQ0FBQyxVQUFVLENBQUM7b0JBQ3hDLEtBQUssRUFBRSxFQUFFLE1BQU0sRUFBRSxRQUFRLEVBQUU7b0JBQzNCLE9BQU8sRUFBRSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUU7aUJBQ3hCLENBQUMsQ0FBQztnQkFFSCxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUM7b0JBQ1osTUFBTSxJQUFJLDBCQUFpQixDQUFDLGtCQUFrQixRQUFRLFlBQVksQ0FBQyxDQUFDO2dCQUN0RSxDQUFDO2dCQUVELElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDO29CQUMxQixNQUFNLElBQUksMkJBQWtCLENBQUMsOEJBQThCLENBQUMs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LENBQUMsRUFBRSxDQUFDLEdBQUcsS0FBSyxDQUFDLE1BQU0sRUFBRSxDQUFDLElBQUksU0FBUyxFQUFFLENBQUM7WUFDakQsTUFBTSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRSxDQUFDLEdBQUcsU0FBUyxDQUFDLENBQUMsQ0FBQztRQUM3QyxDQUFDO1FBQ0QsT0FBTyxNQUFNLENBQUM7SUFDaEIsQ0FBQztDQUNGLENBQUE7QUF0bUJZLG9EQUFvQjsrQkFBcEIsb0JBQW9CO0lBRGhDLElBQUEsbUJBQVUsR0FBRTt5REFLZ0Isc0NBQWEsb0JBQWIsc0NBQWEsb0RBQ0MsNENBQW9CLG9CQUFwQiw0Q0FBb0I7R0FMbEQsb0JBQW9CLENBc21CaEMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL2NsaWVudC9zZXJ2aWNlcy9jbGllbnQtcmVxdWVzdC5zZXJ2aWNlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIEluamVjdGFibGUsXG4gIExvZ2dlcixcbiAgTm90Rm91bmRFeGNlcHRpb24sXG4gIENvbmZsaWN0RXhjZXB0aW9uLFxuICBCYWRSZXF1ZXN0RXhjZXB0aW9uLFxuICBGb3JiaWRkZW5FeGNlcHRpb24sXG59IGZyb20gJ0BuZXN0anMvY29tbW9uJztcbmltcG9ydCB7IFByaXNtYVNlcnZpY2UgfSBmcm9tICcuLi8uLi9wcm92aWRlcnMvcHJpc21hLWNsaWVudC5wcm92aWRlcic7XG5pbXBvcnQgeyBOb3RpZmljYXRpb25zU2VydmljZSB9IGZyb20gJy4uLy4uL25vdGlmaWNhdGlvbnMvbm90aWZpY2F0aW9ucy5zZXJ2aWNlJztcbmltcG9ydCB7IFByaXNtYSB9IGZyb20gJ0BwcmlzbWEvY2xpZW50JztcbmltcG9ydCB7XG4gIHR5cGUgU2VuZFRoZXJhcGlzdFJlcXVlc3REdG8sXG4gIHR5cGUgQ2xpZW50UmVxdWVzdEZpbHRlcnNEdG8sXG4gIHR5cGUgQ2FuY2VsQ2xpZW50UmVxdWVzdER0byxcbn0gZnJvbSAnbWVudGFyYS1jb21tb25zJztcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIENsaWVudFJlcXVlc3RTZXJ2aWNlIHtcbiAgcHJpdmF0ZSByZWFkb25seSBsb2dnZXIgPSBuZXcgTG9nZ2VyKENsaWVudFJlcXVlc3RTZXJ2aWNlLm5hbWUpO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgcmVhZG9ubHkgcHJpc21hOiBQcmlzbWFTZXJ2aWNlLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgbm90aWZpY2F0aW9uc1NlcnZpY2U6IE5vdGlmaWNhdGlvbnNTZXJ2aWNlLFxuICApIHt9XG5cbiAgLy8gPT09PT0gU0VORElORyBUSEVSQVBJU1QgUkVRVUVTVFMgPT09PT1cblxuICBhc3luYyBzZW5kVGhlcmFwaXN0UmVxdWVzdChcbiAgICBjbGllbnRJZDogc3RyaW5nLFxuICAgIHRoZXJhcGlzdElkOiBzdHJpbmcsXG4gICAgcmVxdWVzdER0bzogU2VuZFRoZXJhcGlzdFJlcXVlc3REdG8sXG4gICkge1xuICAgIHRyeSB7XG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy5wcmlzbWEuJHRyYW5zYWN0aW9uKGFzeW5jICh0eCkgPT4ge1xuICAgICAgICAvLyAxLiBWZXJpZnkgY2xpZW50IGV4aXN0cyBhbmQgaXMgYWN0aXZlXG4gICAgICAgIGNvbnN0IGNsaWVudCA9IGF3YWl0IHR4LmNsaWVudC5maW5kVW5pcXVlKHtcbiAgICAgICAgICB3aGVyZTogeyB1c2VySWQ6IGNsaWVudElkIH0sXG4gICAgICAgICAgaW5jbHVkZTogeyB1c2VyOiB0cnVlIH0sXG4gICAgICAgIH0pO1xuXG4gICAgICAgIGlmICghY2xpZW50KSB7XG4gICAgICAgICAgdGhyb3cgbmV3IE5vdEZvdW5kRXhjZXB0aW9uKGBDbGllbnQgd2l0aCBJRCAke2NsaWVudElkfSBub3QgZm91bmRgKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghY2xpZW50LnVzZXIuaXNBY3RpdmUpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRm9yYmlkZGVuRXhjZXB0aW9uKCdDbGllbnQgYWNjb3VudCBpcyBub3QgYWN0aXZlJyk7XG4gICAgICAgIH1cblxuICAgICAgICAvLyAyLiBWZXJpZnkgdGhlcmFwaXN0IGV4aXN0cyBhbmQgaXMgYXBwcm92ZWRcbiAgICAgICAgY29uc3QgdGhlcmFwaXN0ID0gYXdhaXQgdHgudGhlcmFwaXN0LmZpbmRVbmlxdWUoe1xuICAgICAgICAgIHdoZXJlOiB7IHVzZXJJZDogdGhlcmFwaXN0SWQgfSxcbiAgICAgICAgICBpbmNsdWRlOiB7IHVzZXI6IHRydWUgfSxcbiAgICAgICAgfSk7XG5cbiAgICAgICAgaWYgKCF0aGVyYXBpc3QpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgTm90Rm91bmRFeGNlcHRpb24oXG4gICAgICAgICAgICBgVGhlcmFwaXN0IHdpdGggSUQgJHt0aGVyYXBpc3RJZH0gbm90IGZvdW5kYCxcbiAgICAgICAgICApO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHRoZXJhcGlzdC5zdGF0dXMgIT09ICdhcHByb3ZlZCcpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdEV4Y2VwdGlvbihcbiAgICAgICAgICAgICdDYW5ub3Qgc2VuZCByZXF1ZXN0IHRvIHVuYXBwcm92ZWQgdGhlcmFwaXN0JyxcbiAgICAgICAgICApO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCF0aGVyYXBpc3QudXNlci5pc0FjdGl2ZSkge1xuICAgICAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0RXhjZXB0aW9uKCdUaGVyYXBpc3QgaXMgbm90IGN1cnJlbnRseSBhY3RpdmUnKTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIDMuIENoZWNrIGZvciBleGlzdGluZyBhY3RpdmUgcmVxdWVzdHNcbiAgICAgICAgY29uc3QgZXhpc3RpbmdSZXF1ZXN0ID0gYXdhaXQgdHguY2xpZW50VGhlcmFwaXN0UmVxdWVzdC5maW5kRmlyc3Qoe1xuICAgICAgICAgIHdoZXJlOiB7XG4gICAgICAgICAgICBjbGllbnRJZCxcbiAgICAgICAgICAgIHRoZXJhcGlzdElkLFxuICAgICAgICAgICAgc3RhdHVzOiB7IGluOiBbJ1BFTkRJTkcnLCAnQUNDRVBURUQnXSB9LFxuICAgICAgICAgIH0sXG4gICAgICAgIH0pO1xuXG4gICAgICAgIGlmIChleGlzdGluZ1JlcXVlc3QpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgQ29uZmxpY3RFeGNlcHRpb24oXG4gICAgICAgICAgICBgQW4gYWN0aXZlIHJlcXVlc3QgYWxyZWFkeSBleGlzdHMgYmV0d2VlbiBjbGllbnQgJHtjbGllbnRJZH0gYW5kIHRoZXJhcGlzdCAke3RoZXJhcGlzdElkfWAsXG4gICAgICAgICAgKTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIDQuIENoZWNrIGZvciBleGlzdGluZyBjbGllbnQtdGhlcmFwaXN0IHJlbGF0aW9uc2hpcFxuICAgICAgICBjb25zdCBleGlzdGluZ1JlbGF0aW9uc2hpcCA9IGF3YWl0IHR4LmNsaWVudFRoZXJhcGlzdC5maW5kRmlyc3Qoe1xuICAgICAgICAgIHdoZXJlOiB7XG4gICAgICAgICAgICBjbGllbnRJZCxcbiAgICAgICAgICAgIHRoZXJhcGlzdElkLFxuICAgICAgICAgICAgc3RhdHVzOiAnYWN0aXZlJyxcbiAgICAgICAgICB9LFxuICAgICAgICB9KTtcblxuICAgICAgICBpZiAoZXhpc3RpbmdSZWxhdGlvbnNoaXApIHtcbiAgICAgICAgICB0aHJvdyBuZXcgQ29uZmxpY3RFeGNlcHRpb24oXG4gICAgICAgICAgICAnQ2xpZW50IGFscmVhZHkgaGFzIGFuIGFjdGl2ZSByZWxhdGlvbnNoaXAgd2l0aCB0aGlzIHRoZXJhcGlzdCcsXG4gICAgICAgICAgKTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIDUuIENyZWF0ZSB0aGUgcmVxdWVzdCB3aXRoIGF1dG8tZXhwaXJ5ICg3IGRheXMpXG4gICAgICAgIGNvbnN0IGV4cGlyeURhdGUgPSBuZXcgRGF0ZSgpO1xuICAgICAgICBleHBpcnlEYXRlLnNldERhdGUoZXhwaXJ5RGF0ZS5nZXREYXRlKCkgKyA3KTtcblxuICAgICAgICBjb25zdCByZXF1ZXN0ID0gYXdhaXQgdHguY2xpZW50VGhlcmFwaXN0UmVxdWVzdC5jcmVhdGUoe1xuICAgICAgICAgIGRhdGE6IHtcbiAgICAgICAgICAgIGNsaWVudElkLFxuICAgICAgICAgICAgdGhlcmFwaXN0SWQsXG4gICAgICAgICAgICBzdGF0dXM6ICdQRU5ESU5HJyxcbiAgICAgICAgICAgIHByaW9yaXR5OiByZXF1ZXN0RHRvLnByaW9yaXR5IHx8ICdOT1JNQUwnLFxuICAgICAgICAgICAgY2xpZW50TWVzc2FnZTogcmVxdWVzdER0by5tZXNzYWdlLFxuICAgICAgICAgICAgcmVjb21tZW5kYXRpb25SYW5rOiByZXF1ZXN0RHRvLnJlY29tbWVuZGF0aW9uUmFuayxcbiAgICAgICAgICAgIG1hdGNoU2NvcmU6IHJlcXVlc3REdG8ubWF0Y2hTY29yZSxcbiAgICAgICAgICAgIGV4cGlyZXNBdDogZXhwaXJ5RGF0ZSxcbiAgICAgICAgICB9LFxuICAgICAgICAgIGluY2x1ZGU6IHtcbiAgICAgICAgICAgIGNsaWVudDoge1xuICAgICAgICAgICAgICBpbmNsdWRlOiB7XG4gICAgICAgICAgICAgICAgdXNlcjoge1xuICAgICAgICAgICAgICAgICAgc2VsZWN0OiB7XG4gICAgICAgICAgICAgICAgICAgIGZpcnN0TmFtZTogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgICAgbGFzdE5hbWU6IHRydWUsXG4gICAgICAgICAgICAgICAgICAgIGF2YXRhclVybDogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB0aGVyYXBpc3Q6IHtcbiAgICAgICAgICAgICAgaW5jbHVkZToge1xuICAgICAgICAgICAgICAgIHVzZXI6IHtcbiAgICAgICAgICAgICAgICAgIHNlbGVjdDoge1xuICAgICAgICAgICAgICAgICAgICBmaXJzdE5hbWU6IHRydWUsXG4gICAgICAgICAgICAgICAgICAgIGxhc3ROYW1lOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgICBhdmF0YXJVcmw6IHRydWUsXG4gICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0sXG4gICAgICAgIH0pO1xuXG4gICAgICAgIC8vIDYuIFNlbmQgbm90aWZpY2F0aW9uIHRvIHRoZXJhcGlzdFxuICAgICAgICBhd2FpdCB0aGlzLm5vdGlmaWNhdGlvbnNTZXJ2aWNlLmNyZWF0ZSh7XG4gICAgICAgICAgdXNlcklkOiB0aGVyYXBpc3RJZCxcbiAgICAgICAgICB0aXRsZTogJ05ldyBDbGllbnQgUmVxdWVzdCcsXG4gICAgICAgICAgbWVzc2FnZTogYCR7Y2xpZW50LnVzZXIuZmlyc3ROYW1lfSAke2NsaWVudC51c2VyLmxhc3ROYW1lfSBoYXMgc2VudCB5b3UgYSB0aGVyYXB5IHJlcXVlc3QuYCxcbiAgICAgICAgICB0eXBlOiAnQ0xJRU5UX1JFUVVFU1RfUkVDRUlWRUQnLFxuICAgICAgICAgIHByaW9yaXR5OlxuICAgICAgICAgICAgcmVxdWVzdER0by5wcmlvcml0eSA9PT0gJ0hJR0gnIHx8IHJlcXVlc3REdG8ucHJpb3JpdHkgPT09ICdVUkdFTlQnXG4gICAgICAgICAgICAgID8gJ0hJR0gnXG4gICAgICAgICAgICAgIDogJ05PUk1BTCcsXG4gICAgICAgICAgYWN0aW9uVXJsOiBgL3RoZXJhcGlzdC9yZXF1ZXN0cy8ke3JlcXVlc3QuaWR9YCxcbiAgICAgICAgICBkYXRhOiB7XG4gICAgICAgICAgICByZXF1ZXN0SWQ6IHJlcXVlc3QuaWQsXG4gICAgICAgICAgICBjbGllbnRJZCxcbiAgICAgICAgICAgIGNsaWVudE5hbWU6IGAke2NsaWVudC51c2VyLmZpcnN0TmFtZX0gJHtjbGllbnQudXNlci5sYXN0TmFtZX1gLFxuICAgICAgICAgIH0sXG4gICAgICAgIH0pO1xuXG4gICAgICAgIC8vIDcuIENyZWF0ZSBhdWRpdCBsb2dcbiAgICAgICAgYXdhaXQgdHguYXVkaXRMb2cuY3JlYXRlKHtcbiAgICAgICAgICBkYXRhOiB7XG4gICAgICAgICAgICB1c2VySWQ6IGNsaWVudElkLFxuICAgICAgICAgICAgYWN0aW9uOiAnU0VORF9USEVSQVBJU1RfUkVRVUVTVCcsXG4gICAgICAgICAgICBlbnRpdHk6ICdjbGllbnRfdGhlcmFwaXN0X3JlcXVlc3QnLFxuICAgICAgICAgICAgZW50aXR5SWQ6IHJlcXVlc3QuaWQsXG4gICAgICAgICAgICBtZXRhZGF0YToge1xuICAgICAgICAgICAgICBjbGllbnRJZCxcbiAgICAgICAgICAgICAgdGhlcmFwaXN0SWQsXG4gICAgICAgICAgICAgIHByaW9yaXR5OiByZXF1ZXN0RHRvLnByaW9yaXR5LFxuICAgICAgICAgICAgICBoYXNNZXNzYWdlOiAhIXJlcXVlc3REdG8ubWVzc2FnZSxcbiAgICAgICAgICAgICAgcmVjb21tZW5kYXRpb25SYW5rOiByZXF1ZXN0RHRvLnJlY29tbWVuZGF0aW9uUmFuayxcbiAgICAgICAgICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0sXG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRoaXMubG9nZ2VyLmxvZyhcbiAgICAgICAgICBgQ2xpZW50ICR7Y2xpZW50SWR9IHNlbnQgcmVxdWVzdCB0byB0aGVyYXBpc3QgJHt0aGVyYXBpc3RJZH0gd2l0aCBwcmlvcml0eSAke3JlcXVlc3REdG8ucHJpb3JpdHl9YCxcbiAgICAgICAgKTtcblxuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICAgICAgcmVxdWVzdCxcbiAgICAgICAgICBtZXNzYWdlOiAnVGhlcmFwaXN0IHJlcXVlc3Qgc2VudCBzdWNjZXNzZnVsbHknLFxuICAgICAgICAgIGV4cGlyZXNBdDogZXhwaXJ5RGF0ZSxcbiAgICAgICAgfTtcbiAgICAgIH0pO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aGlzLmxvZ2dlci5lcnJvcihcbiAgICAgICAgYEZhaWxlZCB0byBzZW5kIHRoZXJhcGlzdCByZXF1ZXN0IGZyb20gJHtjbGllbnRJZH0gdG8gJHt0aGVyYXBpc3RJZH06YCxcbiAgICAgICAgZXJyb3IsXG4gICAgICApO1xuICAgICAgdGhyb3cgZXJyb3I7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgc2VuZE11bHRpcGxlVGhlcmFwaXN0UmVxdWVzdHMoXG4gICAgY2xpZW50SWQ6IHN0cmluZyxcbiAgICByZXF1ZXN0RGF0YToge1xuICAgICAgdGhlcmFwaXN0SWRzOiBzdHJpbmdbXTtcbiAgICAgIG1lc3NhZ2U/OiBzdHJpbmc7XG4gICAgICBwcmlvcml0eT86IHN0cmluZztcbiAgICB9LFxuICApIHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgeyB0aGVyYXBpc3RJZHMsIG1lc3NhZ2UsIHByaW9yaXR5ID0gJ05PUk1BTCcgfSA9IHJlcXVlc3REYXRhO1xuXG4gICAgICAvLyBWYWxpZGF0ZSB0aGVyYXBpc3QgSURzIGxpbWl0XG4gICAgICBpZiAodGhlcmFwaXN0SWRzLmxlbmd0aCA+IDEwKSB7XG4gICAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0RXhjZXB0aW9uKFxuICAgICAgICAgICdDYW5ub3Qgc2VuZCByZXF1ZXN0cyB0byBtb3JlIHRoYW4gMTAgdGhlcmFwaXN0cyBhdCBvbmNlJyxcbiAgICAgICAgKTtcbiAgICAgIH1cblxuICAgICAgY29uc3QgcmVzdWx0czoge1xuICAgICAgICBzdWNjZXNzZnVsOiBBcnJheTx7XG4gICAgICAgICAgdGhlcmFwaXN0SWQ6IHN0cmluZztcbiAgICAgICAgICByZXF1ZXN0SWQ6IHN0cmluZztcbiAgICAgICAgICBzdGF0dXM6IHN0cmluZztcbiAgICAgICAgfT47XG4gICAgICAgIGZhaWxlZDogQXJyYXk8eyB0aGVyYXBpc3RJZDogc3RyaW5nOyBlcnJvcjogc3RyaW5nIH0+O1xuICAgICAgICB0b3RhbFNlbnQ6IG51bWJlcjtcbiAgICAgIH0gPSB7XG4gICAgICAgIHN1Y2Nlc3NmdWw6IFtdLFxuICAgICAgICBmYWlsZWQ6IFtdLFxuICAgICAgICB0b3RhbFNlbnQ6IDAsXG4gICAgICB9O1xuXG4gICAgICAvLyBQcm9jZXNzIHJlcXVlc3RzIGluIHBhcmFsbGVsIHdpdGggY29udHJvbGxlZCBjb25jdXJyZW5jeSAobWF4IDMgY29uY3VycmVudClcbiAgICAgIC8vIFRoaXMgYXZvaWRzIGRhdGFiYXNlIGxvY2sgY29udGVudGlvbiB3aGlsZSBtYWludGFpbmluZyBnb29kIHBlcmZvcm1hbmNlXG4gICAgICBjb25zdCBjb25jdXJyZW5jeUxpbWl0ID0gMztcbiAgICAgIGNvbnN0IGNodW5rcyA9IHRoaXMuY2h1bmtBcnJheSh0aGVyYXBpc3RJZHMsIGNvbmN1cnJlbmN5TGltaXQpO1xuXG4gICAgICBmb3IgKGNvbnN0IGNodW5rIG9mIGNodW5rcykge1xuICAgICAgICBjb25zdCBjaHVua1Byb21pc2VzID0gY2h1bmsubWFwKGFzeW5jICh0aGVyYXBpc3RJZCkgPT4ge1xuICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCB0aGlzLnNlbmRUaGVyYXBpc3RSZXF1ZXN0KFxuICAgICAgICAgICAgICBjbGllbnRJZCxcbiAgICAgICAgICAgICAgdGhlcmFwaXN0SWQsXG4gICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICBtZXNzYWdlLFxuICAgICAgICAgICAgICAgIHByaW9yaXR5OiBwcmlvcml0eSBhcyAnTE9XJyB8ICdOT1JNQUwnIHwgJ0hJR0gnIHwgJ1VSR0VOVCcsXG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICApO1xuXG4gICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgICAgICAgICB0aGVyYXBpc3RJZCxcbiAgICAgICAgICAgICAgcmVxdWVzdElkOiByZXN1bHQucmVxdWVzdC5pZCxcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIHRoaXMubG9nZ2VyLndhcm4oXG4gICAgICAgICAgICAgIGBGYWlsZWQgdG8gc2VuZCByZXF1ZXN0IHRvIHRoZXJhcGlzdCAke3RoZXJhcGlzdElkfWAsXG4gICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICBlcnJvcjogZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiBTdHJpbmcoZXJyb3IpLFxuICAgICAgICAgICAgICAgIGNsaWVudElkLFxuICAgICAgICAgICAgICAgIHRoZXJhcGlzdElkLFxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgKTtcblxuICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgICAgICAgIHRoZXJhcGlzdElkLFxuICAgICAgICAgICAgICBlcnJvcjogZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiAnVW5rbm93biBlcnJvcicsXG4gICAgICAgICAgICB9O1xuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy8gV2FpdCBmb3IgYWxsIHJlcXVlc3RzIGluIHRoaXMgY2h1bmsgdG8gY29tcGxldGVcbiAgICAgICAgY29uc3QgY2h1bmtSZXN1bHRzID0gYXdhaXQgUHJvbWlzZS5hbGwoY2h1bmtQcm9taXNlcyk7XG5cbiAgICAgICAgLy8gUHJvY2VzcyByZXN1bHRzXG4gICAgICAgIGNodW5rUmVzdWx0cy5mb3JFYWNoKChyZXN1bHQpID0+IHtcbiAgICAgICAgICBpZiAocmVzdWx0LnN1Y2Nlc3MpIHtcbiAgICAgICAgICAgIHJlc3VsdHMuc3VjY2Vzc2Z1bC5wdXNoKHtcbiAgICAgICAgICAgICAgdGhlcmFwaXN0SWQ6IHJlc3VsdC50aGVyYXBpc3RJZCxcbiAgICAgICAgICAgICAgcmVxdWVzdElkOiByZXN1bHQucmVxdWVzdElkISxcbiAgICAgICAgICAgICAgc3RhdHVzOiAnc2VudCcsXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIHJlc3VsdHMudG90YWxTZW50Kys7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJlc3VsdHMuZmFpbGVkLnB1c2goe1xuICAgICAgICAgICAgICB0aGVyYXBpc3RJZDogcmVzdWx0LnRoZXJhcGlzdElkLFxuICAgICAgICAgICAgICBlcnJvcjogcmVzdWx0LmVycm9yISxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy8gQWRkIHNtYWxsIGRlbGF5IGJldHdlZW4gY2h1bmtzIHRvIHByZXZlbnQgb3ZlcndoZWxtaW5nIHRoZSBkYXRhYmFzZVxuICAgICAgICBpZiAoY2h1bmtzLmluZGV4T2YoY2h1bmspIDwgY2h1bmtzLmxlbmd0aCAtIDEpIHtcbiAgICAgICAgICBhd2FpdCBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gc2V0VGltZW91dChyZXNvbHZlLCAxMDApKTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICB0aGlzLmxvZ2dlci5sb2coXG4gICAgICAgIGBDbGllbnQgJHtjbGllbnRJZH0gc2VudCBidWxrIHJlcXVlc3RzOiAke3Jlc3VsdHMudG90YWxTZW50fSBzdWNjZXNzZnVsLCAke3Jlc3VsdHMuZmFpbGVkLmxlbmd0aH0gZmFpbGVkYCxcbiAgICAgICk7XG5cbiAgICAgIHJldHVybiB7XG4gICAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICAgIHJlc3VsdHMsXG4gICAgICAgIHN1bW1hcnk6IHtcbiAgICAgICAgICB0b3RhbFJlcXVlc3RlZDogdGhlcmFwaXN0SWRzLmxlbmd0aCxcbiAgICAgICAgICB0b3RhbFNlbnQ6IHJlc3VsdHMudG90YWxTZW50LFxuICAgICAgICAgIHRvdGFsRmFpbGVkOiByZXN1bHRzLmZhaWxlZC5sZW5ndGgsXG4gICAgICAgIH0sXG4gICAgICB9O1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aGlzLmxvZ2dlci5lcnJvcihcbiAgICAgICAgYEZhaWxlZCB0byBzZW5kIG11bHRpcGxlIHRoZXJhcGlzdCByZXF1ZXN0cyBmb3IgY2xpZW50ICR7Y2xpZW50SWR9OmAsXG4gICAgICAgIGVycm9yLFxuICAgICAgKTtcbiAgICAgIHRocm93IGVycm9yO1xuICAgIH1cbiAgfVxuXG4gIC8vID09PT09IFJFVFJJRVZJTkcgQ0xJRU5UIFJFUVVFU1RTID09PT09XG5cbiAgYXN5bmMgZ2V0Q2xpZW50UmVxdWVzdHMoY2xpZW50SWQ6IHN0cmluZywgZmlsdGVyczogQ2xpZW50UmVxdWVzdEZpbHRlcnNEdG8pIHtcbiAgICB0cnkge1xuICAgICAgY29uc3Qge1xuICAgICAgICBzdGF0dXMsXG4gICAgICAgIHByaW9yaXR5LFxuICAgICAgICB0aGVyYXBpc3RJZCxcbiAgICAgICAgcmVxdWVzdGVkQWZ0ZXIsXG4gICAgICAgIHJlcXVlc3RlZEJlZm9yZSxcbiAgICAgICAgcGFnZSA9IDEsXG4gICAgICAgIGxpbWl0ID0gMjAsXG4gICAgICAgIHNvcnRCeSA9ICdyZXF1ZXN0ZWRBdCcsXG4gICAgICAgIHNvcnRPcmRlciA9ICdkZXNjJyxcbiAgICAgIH0gPSBmaWx0ZXJzO1xuXG4gICAgICBjb25zdCBza2lwID0gKHBhZ2UgLSAxKSAqIGxpbWl0O1xuICAgICAgY29uc3Qgd2hlcmU6IFByaXNtYS5DbGllbnRUaGVyYXBpc3RSZXF1ZXN0V2hlcmVJbnB1dCA9IHtcbiAgICAgICAgY2xpZW50SWQsXG4gICAgICB9O1xuXG4gICAgICAvLyBBcHBseSBmaWx0ZXJzXG4gICAgICBpZiAoc3RhdHVzKSB3aGVyZS5zdGF0dXMgPSBzdGF0dXM7XG4gICAgICBpZiAocHJpb3JpdHkpIHdoZXJlLnByaW9yaXR5ID0gcHJpb3JpdHk7XG4gICAgICBpZiAodGhlcmFwaXN0SWQpIHdoZXJlLnRoZXJhcGlzdElkID0gdGhlcmFwaXN0SWQ7XG4gICAgICBpZiAocmVxdWVzdGVkQWZ0ZXIgfHwgcmVxdWVzdGVkQmVmb3JlKSB7XG4gICAgICAgIGNvbnN0IHJlcXVlc3RlZEF0RmlsdGVyOiBhbnkgPSB7fTtcbiAgICAgICAgaWYgKHJlcXVlc3RlZEFmdGVyKSByZXF1ZXN0ZWRBdEZpbHRlci5ndGUgPSBuZXcgRGF0ZShyZXF1ZXN0ZWRBZnRlcik7XG4gICAgICAgIGlmIChyZXF1ZXN0ZWRCZWZvcmUpIHJlcXVlc3RlZEF0RmlsdGVyLmx0ZSA9IG5ldyBEYXRlKHJlcXVlc3RlZEJlZm9yZSk7XG4gICAgICAgIHdoZXJlLnJlcXVlc3RlZEF0ID0gcmVxdWVzdGVkQXRGaWx0ZXI7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IFtyZXF1ZXN0cywgdG90YWxDb3VudF0gPSBhd2FpdCBQcm9taXNlLmFsbChbXG4gICAgICAgIHRoaXMucHJpc21hLmNsaWVudFRoZXJhcGlzdFJlcXVlc3QuZmluZE1hbnkoe1xuICAgICAgICAgIHdoZXJlLFxuICAgICAgICAgIHNraXAsXG4gICAgICAgICAgdGFrZTogbGltaXQsXG4gICAgICAgICAgb3JkZXJCeTogeyBbc29ydEJ5XTogc29ydE9yZGVyIH0sXG4gICAgICAgICAgaW5jbHVkZToge1xuICAgICAgICAgICAgdGhlcmFwaXN0OiB7XG4gICAgICAgICAgICAgIGluY2x1ZGU6IHtcbiAgICAgICAgICAgICAgICB1c2VyOiB7XG4gICAgICAgICAgICAgICAgICBzZWxlY3Q6IHtcbiAgICAgICAgICAgICAgICAgICAgZmlyc3ROYW1lOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgICBsYXN0TmFtZTogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgICAgYXZhdGFyVXJsOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9LFxuICAgICAgICB9KSxcbiAgICAgICAgdGhpcy5wcmlzbWEuY2xpZW50VGhlcmFwaXN0UmVxdWVzdC5jb3VudCh7IHdoZXJlIH0pLFxuICAgICAgXSk7XG5cbiAgICAgIHRoaXMubG9nZ2VyLmxvZyhcbiAgICAgICAgYFJldHJpZXZlZCAke3JlcXVlc3RzLmxlbmd0aH0gcmVxdWVzdHMgZm9yIGNsaWVudCAke2NsaWVudElkfWAsXG4gICAgICApO1xuXG4gICAgICByZXR1cm4ge1xuICAgICAgICByZXF1ZXN0cyxcbiAgICAgICAgcGFnaW5hdGlvbjoge1xuICAgICAgICAgIHBhZ2UsXG4gICAgICAgICAgbGltaXQsXG4gICAgICAgICAgdG90YWxDb3VudCxcbiAgICAgICAgICB0b3RhbFBhZ2VzOiBNYXRoLmNlaWwodG90YWxDb3VudCAvIGxpbWl0KSxcbiAgICAgICAgfSxcbiAgICAgICAgZmlsdGVycyxcbiAgICAgIH07XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRoaXMubG9nZ2VyLmVycm9yKFxuICAgICAgICBgRmFpbGVkIHRvIHJldHJpZXZlIHJlcXVlc3RzIGZvciBjbGllbnQgJHtjbGllbnRJZH06YCxcbiAgICAgICAgZXJyb3IsXG4gICAgICApO1xuICAgICAgdGhyb3cgZXJyb3I7XG4gICAgfVxuICB9XG5cbiAgLy8gPT09PT0gUkVRVUVTVCBNQU5BR0VNRU5UID09PT09XG5cbiAgYXN5bmMgY2FuY2VsUmVxdWVzdChyZXF1ZXN0SWQ6IHN0cmluZywgY2xpZW50SWQ6IHN0cmluZywgcmVhc29uPzogc3RyaW5nKSB7XG4gICAgdHJ5IHtcbiAgICAgIHJldHVybiBhd2FpdCB0aGlzLnByaXNtYS4kdHJhbnNhY3Rpb24oYXN5bmMgKHR4KSA9PiB7XG4gICAgICAgIC8vIDEuIFZlcmlmeSByZXF1ZXN0IGV4aXN0cyBhbmQgYmVsb25ncyB0byBjbGllbnRcbiAgICAgICAgY29uc3QgZXhpc3RpbmdSZXF1ZXN0ID0gYXdhaXQgdHguY2xpZW50VGhlcmFwaXN0UmVxdWVzdC5maW5kVW5pcXVlKHtcbiAgICAgICAgICB3aGVyZTogeyBpZDogcmVxdWVzdElkIH0sXG4gICAgICAgICAgaW5jbHVkZToge1xuICAgICAgICAgICAgdGhlcmFwaXN0OiB7XG4gICAgICAgICAgICAgIGluY2x1ZGU6IHtcbiAgICAgICAgICAgICAgICB1c2VyOiB7XG4gICAgICAgICAgICAgICAgICBzZWxlY3Q6IHtcbiAgICAgICAgICAgICAgICAgICAgZmlyc3ROYW1lOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgICBsYXN0TmFtZTogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgfSk7XG5cbiAgICAgICAgaWYgKCFleGlzdGluZ1JlcXVlc3QpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgTm90Rm91bmRFeGNlcHRpb24oYFJlcXVlc3Qgd2l0aCBJRCAke3JlcXVlc3RJZH0gbm90IGZvdW5kYCk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoZXhpc3RpbmdSZXF1ZXN0LmNsaWVudElkICE9PSBjbGllbnRJZCkge1xuICAgICAgICAgIHRocm93IG5ldyBGb3JiaWRkZW5FeGNlcHRpb24oJ1lvdSBjYW4gb25seSBjYW5jZWwgeW91ciBvd24gcmVxdWVzdHMnKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChleGlzdGluZ1JlcXVlc3Quc3RhdHVzICE9PSAnUEVORElORycpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdEV4Y2VwdGlvbihcbiAgICAgICAgICAgIGBDYW5ub3QgY2FuY2VsIHJlcXVlc3Qgd2l0aCBzdGF0dXMgJHtleGlzdGluZ1JlcXVlc3Quc3RhdHVzfWAsXG4gICAgICAgICAgKTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIDIuIFVwZGF0ZSByZXF1ZXN0IHN0YXR1cyB0byBjYW5jZWxsZWRcbiAgICAgICAgY29uc3QgY2FuY2VsbGVkUmVxdWVzdCA9IGF3YWl0IHR4LmNsaWVudFRoZXJhcGlzdFJlcXVlc3QudXBkYXRlKHtcbiAgICAgICAgICB3aGVyZTogeyBpZDogcmVxdWVzdElkIH0sXG4gICAgICAgICAgZGF0YToge1xuICAgICAgICAgICAgc3RhdHVzOiAnQ0FOQ0VMTEVEJyxcbiAgICAgICAgICAgIHJlc3BvbmRlZEF0OiBuZXcgRGF0ZSgpLFxuICAgICAgICAgIH0sXG4gICAgICAgIH0pO1xuXG4gICAgICAgIC8vIDMuIE5vdGlmeSB0aGVyYXBpc3Qgb2YgY2FuY2VsbGF0aW9uXG4gICAgICAgIGF3YWl0IHRoaXMubm90aWZpY2F0aW9uc1NlcnZpY2UuY3JlYXRlKHtcbiAgICAgICAgICB1c2VySWQ6IGV4aXN0aW5nUmVxdWVzdC50aGVyYXBpc3RJZCxcbiAgICAgICAgICB0aXRsZTogJ0NsaWVudCBSZXF1ZXN0IENhbmNlbGxlZCcsXG4gICAgICAgICAgbWVzc2FnZTogYEEgY2xpZW50IHJlcXVlc3QgaGFzIGJlZW4gY2FuY2VsbGVkLiR7cmVhc29uID8gYCBSZWFzb246ICR7cmVhc29ufWAgOiAnJ31gLFxuICAgICAgICAgIHR5cGU6ICdDTElFTlRfUkVRVUVTVF9DQU5DRUxMRUQnLFxuICAgICAgICAgIHByaW9yaXR5OiAnTk9STUFMJyxcbiAgICAgICAgICBhY3Rpb25Vcmw6ICcvdGhlcmFwaXN0L3JlcXVlc3RzJyxcbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy8gNC4gQ3JlYXRlIGF1ZGl0IGxvZ1xuICAgICAgICBhd2FpdCB0eC5hdWRpdExvZy5jcmVhdGUoe1xuICAgICAgICAgIGRhdGE6IHtcbiAgICAgICAgICAgIHVzZXJJZDogY2xpZW50SWQsXG4gICAgICAgICAgICBhY3Rpb246ICdDQU5DRUxfVEhFUkFQSVNUX1JFUVVFU1QnLFxuICAgICAgICAgICAgZW50aXR5OiAnY2xpZW50X3RoZXJhcGlzdF9yZXF1ZXN0JyxcbiAgICAgICAgICAgIGVudGl0eUlkOiByZXF1ZXN0SWQsXG4gICAgICAgICAgICBtZXRhZGF0YToge1xuICAgICAgICAgICAgICByZXF1ZXN0SWQsXG4gICAgICAgICAgICAgIHRoZXJhcGlzdElkOiBleGlzdGluZ1JlcXVlc3QudGhlcmFwaXN0SWQsXG4gICAgICAgICAgICAgIHJlYXNvbixcbiAgICAgICAgICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0sXG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRoaXMubG9nZ2VyLmxvZyhgQ2xpZW50ICR7Y2xpZW50SWR9IGNhbmNlbGxlZCByZXF1ZXN0ICR7cmVxdWVzdElkfWApO1xuXG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgc3VjY2VzczogdHJ1ZSxcbiAgICAgICAgICByZXF1ZXN0OiBjYW5jZWxsZWRSZXF1ZXN0LFxuICAgICAgICAgIG1lc3NhZ2U6ICdSZXF1ZXN0IGNhbmNlbGxlZCBzdWNjZXNzZnVsbHknLFxuICAgICAgICB9O1xuICAgICAgfSk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRoaXMubG9nZ2VyLmVycm9yKFxuICAgICAgICBgRmFpbGVkIHRvIGNhbmNlbCByZXF1ZXN0ICR7cmVxdWVzdElkfSBmb3IgY2xpZW50ICR7Y2xpZW50SWR9OmAsXG4gICAgICAgIGVycm9yLFxuICAgICAgKTtcbiAgICAgIHRocm93IGVycm9yO1xuICAgIH1cbiAgfVxuXG4gIC8vID09PT09IFNUQVRJU1RJQ1MgQU5EIEFOQUxZVElDUyA9PT09PVxuXG4gIGFzeW5jIGdldENsaWVudFJlcXVlc3RTdGF0aXN0aWNzKGNsaWVudElkOiBzdHJpbmcpIHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgW1xuICAgICAgICB0b3RhbFNlbnQsXG4gICAgICAgIHBlbmRpbmcsXG4gICAgICAgIGFjY2VwdGVkLFxuICAgICAgICBkZWNsaW5lZCxcbiAgICAgICAgZXhwaXJlZCxcbiAgICAgICAgY2FuY2VsbGVkLFxuICAgICAgICByZWNlbnRSZXF1ZXN0cyxcbiAgICAgIF0gPSBhd2FpdCBQcm9taXNlLmFsbChbXG4gICAgICAgIC8vIFRvdGFsIHJlcXVlc3RzIHNlbnRcbiAgICAgICAgdGhpcy5wcmlzbWEuY2xpZW50VGhlcmFwaXN0UmVxdWVzdC5jb3VudCh7XG4gICAgICAgICAgd2hlcmU6IHsgY2xpZW50SWQgfSxcbiAgICAgICAgfSksXG4gICAgICAgIC8vIFBlbmRpbmcgcmVxdWVzdHNcbiAgICAgICAgdGhpcy5wcmlzbWEuY2xpZW50VGhlcmFwaXN0UmVxdWVzdC5jb3VudCh7XG4gICAgICAgICAgd2hlcmU6IHsgY2xpZW50SWQsIHN0YXR1czogJ1BFTkRJTkcnIH0sXG4gICAgICAgIH0pLFxuICAgICAgICAvLyBBY2NlcHRlZCByZXF1ZXN0c1xuICAgICAgICB0aGlzLnByaXNtYS5jbGllbnRUaGVyYXBpc3RSZXF1ZXN0LmNvdW50KHtcbiAgICAgICAgICB3aGVyZTogeyBjbGllbnRJZCwgc3RhdHVzOiAnQUNDRVBURUQnIH0sXG4gICAgICAgIH0pLFxuICAgICAgICAvLyBEZWNsaW5lZCByZXF1ZXN0c1xuICAgICAgICB0aGlzLnByaXNtYS5jbGllbnRUaGVyYXBpc3RSZXF1ZXN0LmNvdW50KHtcbiAgICAgICAgICB3aGVyZTogeyBjbGllbnRJZCwgc3RhdHVzOiAnREVDTElORUQnIH0sXG4gICAgICAgIH0pLFxuICAgICAgICAvLyBFeHBpcmVkIHJlcXVlc3RzXG4gICAgICAgIHRoaXMucHJpc21hLmNsaWVudFRoZXJhcGlzdFJlcXVlc3QuY291bnQoe1xuICAgICAgICAgIHdoZXJlOiB7IGNsaWVudElkLCBzdGF0dXM6ICdFWFBJUkVEJyB9LFxuICAgICAgICB9KSxcbiAgICAgICAgLy8gQ2FuY2VsbGVkIHJlcXVlc3RzXG4gICAgICAgIHRoaXMucHJpc21hLmNsaWVudFRoZXJhcGlzdFJlcXVlc3QuY291bnQoe1xuICAgICAgICAgIHdoZXJlOiB7IGNsaWVudElkLCBzdGF0dXM6ICdDQU5DRUxMRUQnIH0sXG4gICAgICAgIH0pLFxuICAgICAgICAvLyBSZWNlbnQgcmVxdWVzdHMgZm9yIHJlc3BvbnNlIHRpbWUgY2FsY3VsYXRpb25cbiAgICAgICAgdGhpcy5wcmlzbWEuY2xpZW50VGhlcmFwaXN0UmVxdWVzdC5maW5kTWFueSh7XG4gICAgICAgICAgd2hlcmU6IHtcbiAgICAgICAgICAgIGNsaWVudElkLFxuICAgICAgICAgICAgcmVzcG9uZGVkQXQ6IHsgbm90OiBudWxsIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgICBzZWxlY3Q6IHtcbiAgICAgICAgICAgIHJlcXVlc3RlZEF0OiB0cnVlLFxuICAgICAgICAgICAgcmVzcG9uZGVkQXQ6IHRydWUsXG4gICAgICAgICAgfSxcbiAgICAgICAgICBvcmRlckJ5OiB7IHJlc3BvbmRlZEF0OiAnZGVzYycgfSxcbiAgICAgICAgICB0YWtlOiAxMCxcbiAgICAgICAgfSksXG4gICAgICBdKTtcblxuICAgICAgLy8gQ2FsY3VsYXRlIGFjY2VwdGFuY2UgcmF0ZVxuICAgICAgY29uc3QgdG90YWxSZXNwb25kZWQgPSBhY2NlcHRlZCArIGRlY2xpbmVkO1xuICAgICAgY29uc3QgYWNjZXB0YW5jZVJhdGUgPVxuICAgICAgICB0b3RhbFJlc3BvbmRlZCA+IDAgPyAoYWNjZXB0ZWQgLyB0b3RhbFJlc3BvbmRlZCkgKiAxMDAgOiAwO1xuXG4gICAgICAvLyBDYWxjdWxhdGUgYXZlcmFnZSByZXNwb25zZSB0aW1lXG4gICAgICBjb25zdCByZXNwb25zZVRpbWVzID0gcmVjZW50UmVxdWVzdHNcbiAgICAgICAgLmZpbHRlcigocmVxKSA9PiByZXEucmVzcG9uZGVkQXQpXG4gICAgICAgIC5tYXAoKHJlcSkgPT4ge1xuICAgICAgICAgIGNvbnN0IHJlc3BvbnNlVGltZSA9XG4gICAgICAgICAgICByZXEucmVzcG9uZGVkQXQhLmdldFRpbWUoKSAtIHJlcS5yZXF1ZXN0ZWRBdC5nZXRUaW1lKCk7XG4gICAgICAgICAgcmV0dXJuIHJlc3BvbnNlVGltZSAvICgxMDAwICogNjAgKiA2MCk7IC8vIENvbnZlcnQgdG8gaG91cnNcbiAgICAgICAgfSk7XG5cbiAgICAgIGNvbnN0IGF2ZXJhZ2VSZXNwb25zZVRpbWUgPVxuICAgICAgICByZXNwb25zZVRpbWVzLmxlbmd0aCA+IDBcbiAgICAgICAgICA/IHJlc3BvbnNlVGltZXMucmVkdWNlKChzdW0sIHRpbWUpID0+IHN1bSArIHRpbWUsIDApIC9cbiAgICAgICAgICAgIHJlc3BvbnNlVGltZXMubGVuZ3RoXG4gICAgICAgICAgOiAwO1xuXG4gICAgICAvLyBHZXQgbGFzdCByZXF1ZXN0IGFuZCByZXNwb25zZSBkYXRlc1xuICAgICAgY29uc3QgbGFzdFJlcXVlc3QgPSBhd2FpdCB0aGlzLnByaXNtYS5jbGllbnRUaGVyYXBpc3RSZXF1ZXN0LmZpbmRGaXJzdCh7XG4gICAgICAgIHdoZXJlOiB7IGNsaWVudElkIH0sXG4gICAgICAgIG9yZGVyQnk6IHsgcmVxdWVzdGVkQXQ6ICdkZXNjJyB9LFxuICAgICAgICBzZWxlY3Q6IHsgcmVxdWVzdGVkQXQ6IHRydWUgfSxcbiAgICAgIH0pO1xuXG4gICAgICBjb25zdCBsYXN0UmVzcG9uc2UgPSBhd2FpdCB0aGlzLnByaXNtYS5jbGllbnRUaGVyYXBpc3RSZXF1ZXN0LmZpbmRGaXJzdCh7XG4gICAgICAgIHdoZXJlOiB7IGNsaWVudElkLCByZXNwb25kZWRBdDogeyBub3Q6IG51bGwgfSB9LFxuICAgICAgICBvcmRlckJ5OiB7IHJlc3BvbmRlZEF0OiAnZGVzYycgfSxcbiAgICAgICAgc2VsZWN0OiB7IHJlc3BvbmRlZEF0OiB0cnVlIH0sXG4gICAgICB9KTtcblxuICAgICAgdGhpcy5sb2dnZXIubG9nKGBHZW5lcmF0ZWQgcmVxdWVzdCBzdGF0aXN0aWNzIGZvciBjbGllbnQgJHtjbGllbnRJZH1gKTtcblxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgdG90YWxTZW50LFxuICAgICAgICBwZW5kaW5nLFxuICAgICAgICBhY2NlcHRlZCxcbiAgICAgICAgZGVjbGluZWQsXG4gICAgICAgIGV4cGlyZWQsXG4gICAgICAgIGNhbmNlbGxlZCxcbiAgICAgICAgYWNjZXB0YW5jZVJhdGU6IE1hdGgucm91bmQoYWNjZXB0YW5jZVJhdGUgKiAxMDApIC8gMTAwLFxuICAgICAgICBhdmVyYWdlUmVzcG9uc2VUaW1lOiBNYXRoLnJvdW5kKGF2ZXJhZ2VSZXNwb25zZVRpbWUgKiAxMDApIC8gMTAwLFxuICAgICAgICBsYXN0UmVxdWVzdEF0OiBsYXN0UmVxdWVzdD8ucmVxdWVzdGVkQXQgfHwgbnVsbCxcbiAgICAgICAgbGFzdFJlc3BvbnNlQXQ6IGxhc3RSZXNwb25zZT8ucmVzcG9uZGVkQXQgfHwgbnVsbCxcbiAgICAgIH07XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRoaXMubG9nZ2VyLmVycm9yKFxuICAgICAgICBgRmFpbGVkIHRvIGdlbmVyYXRlIHN0YXRpc3RpY3MgZm9yIGNsaWVudCAke2NsaWVudElkfTpgLFxuICAgICAgICBlcnJvcixcbiAgICAgICk7XG4gICAgICB0aHJvdyBlcnJvcjtcbiAgICB9XG4gIH1cblxuICAvLyA9PT09PSBVVElMSVRZIE1FVEhPRFMgPT09PT1cblxuICBhc3luYyBleHBpcmVTdGFsZVJlcXVlc3RzKCkge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBub3cgPSBuZXcgRGF0ZSgpO1xuXG4gICAgICBjb25zdCBleHBpcmVkUmVxdWVzdHMgPVxuICAgICAgICBhd2FpdCB0aGlzLnByaXNtYS5jbGllbnRUaGVyYXBpc3RSZXF1ZXN0LnVwZGF0ZU1hbnkoe1xuICAgICAgICAgIHdoZXJlOiB7XG4gICAgICAgICAgICBzdGF0dXM6ICdQRU5ESU5HJyxcbiAgICAgICAgICAgIGV4cGlyZXNBdDogeyBsdGU6IG5vdyB9LFxuICAgICAgICAgIH0sXG4gICAgICAgICAgZGF0YToge1xuICAgICAgICAgICAgc3RhdHVzOiAnRVhQSVJFRCcsXG4gICAgICAgICAgICByZXNwb25kZWRBdDogbm93LFxuICAgICAgICAgIH0sXG4gICAgICAgIH0pO1xuXG4gICAgICB0aGlzLmxvZ2dlci5sb2coYEV4cGlyZWQgJHtleHBpcmVkUmVxdWVzdHMuY291bnR9IHN0YWxlIHJlcXVlc3RzYCk7XG5cbiAgICAgIHJldHVybiB7XG4gICAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICAgIGV4cGlyZWRDb3VudDogZXhwaXJlZFJlcXVlc3RzLmNvdW50LFxuICAgICAgfTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoJ0ZhaWxlZCB0byBleHBpcmUgc3RhbGUgcmVxdWVzdHM6JywgZXJyb3IpO1xuICAgICAgdGhyb3cgZXJyb3I7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEhlbHBlciBtZXRob2QgdG8gc3BsaXQgYXJyYXkgaW50byBjaHVua3MgZm9yIGNvbnRyb2xsZWQgcGFyYWxsZWwgcHJvY2Vzc2luZ1xuICAgKi9cbiAgcHJpdmF0ZSBjaHVua0FycmF5PFQ+KGFycmF5OiBUW10sIGNodW5rU2l6ZTogbnVtYmVyKTogVFtdW10ge1xuICAgIGNvbnN0IGNodW5rczogVFtdW10gPSBbXTtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGFycmF5Lmxlbmd0aDsgaSArPSBjaHVua1NpemUpIHtcbiAgICAgIGNodW5rcy5wdXNoKGFycmF5LnNsaWNlKGksIGkgKyBjaHVua1NpemUpKTtcbiAgICB9XG4gICAgcmV0dXJuIGNodW5rcztcbiAgfVxufVxuIl0sInZlcnNpb24iOjN9