e97143bca9161d8b3c22800d6099d576
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.SecurityGuard = void 0;
const common_1 = require("@nestjs/common");
let SecurityGuard = class SecurityGuard {
    suspiciousPatterns = [
        // SQL Injection patterns
        /union\s+select/i,
        /drop\s+table/i,
        /insert\s+into/i,
        /delete\s+from/i,
        /update\s+.*set/i,
        /script\s*>/i,
        // XSS patterns
        /<script/i,
        /javascript:/i,
        /vbscript:/i,
        /onload\s*=/i,
        /onerror\s*=/i,
        // Command injection patterns
        /\|\s*cat\s+/,
        /;\s*rm\s+-rf/,
        /&&\s*curl/,
        /`.*`/,
        // Path traversal patterns
        /\.\.\//,
        /\.\.\\\\\\\\\\\\\\\\w+/,
        /\.\.\%2f/i,
        /\.\.\%5c/i,
    ];
    maxRequestSize = 10 * 1024 * 1024; // 10MB
    maxHeaderLength = 8192; // 8KB
    maxUrlLength = 2048; // 2KB
    canActivate(context) {
        const request = context.switchToHttp().getRequest();
        // Check request size
        if (this.getRequestSize(request) > this.maxRequestSize) {
            throw new common_1.ForbiddenException('Request too large');
        }
        // Check URL length
        if (request.url.length > this.maxUrlLength) {
            throw new common_1.ForbiddenException('URL too long');
        }
        // Check headers
        this.validateHeaders(request);
        // Check for suspicious patterns in URL
        this.validateInput(request.url, 'URL');
        // Check query parameters
        Object.entries(request.query || {}).forEach(([key, value]) => {
            this.validateInput(key, 'Query parameter key');
            this.validateInput(String(value), 'Query parameter value');
        });
        // Check body if it exists
        if (request.body) {
            this.validateRequestBody(request.body);
        }
        return true;
    }
    getRequestSize(request) {
        const contentLength = request.headers['content-length'];
        return contentLength ? parseInt(contentLength, 10) : 0;
    }
    validateHeaders(request) {
        Object.entries(request.headers).forEach(([name, value]) => {
            const headerValue = Array.isArray(value)
                ? value.join('')
                : String(value || '');
            if (headerValue.length > this.maxHeaderLength) {
                throw new common_1.ForbiddenException(`Header ${name} too long`);
            }
            this.validateInput(headerValue, `Header ${name}`);
        });
    }
    validateInput(input, context) {
        for (const pattern of this.suspiciousPatterns) {
            if (pattern.test(input)) {
                throw new common_1.ForbiddenException(`Suspicious content detected in ${context}`);
            }
        }
    }
    validateRequestBody(body, depth = 0) {
        // Prevent deep nesting attacks
        if (depth > 10) {
            throw new common_1.ForbiddenException('Request body too deeply nested');
        }
        if (typeof body === 'string') {
            this.validateInput(body, 'Request body');
        }
        else if (Array.isArray(body)) {
            if (body.length > 1000) {
                throw new common_1.ForbiddenException('Array too large');
            }
            body.forEach((item) => this.validateRequestBody(item, depth + 1));
        }
        else if (typeof body === 'object' && body !== null) {
            const keys = Object.keys(body);
            if (keys.length > 100) {
                throw new common_1.ForbiddenException('Too many object properties');
            }
            keys.forEach((key) => {
                this.validateInput(key, 'Object key');
                this.validateRequestBody(body[key], depth + 1);
            });
        }
    }
};
exports.SecurityGuard = SecurityGuard;
exports.SecurityGuard = SecurityGuard = __decorate([
    (0, common_1.Injectable)()
], SecurityGuard);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL2NvbW1vbi9ndWFyZHMvc2VjdXJpdHkuZ3VhcmQudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7O0FBQUEsMkNBS3dCO0FBSWpCLElBQU0sYUFBYSxHQUFuQixNQUFNLGFBQWE7SUFDUCxrQkFBa0IsR0FBRztRQUNwQyx5QkFBeUI7UUFDekIsaUJBQWlCO1FBQ2pCLGVBQWU7UUFDZixnQkFBZ0I7UUFDaEIsZ0JBQWdCO1FBQ2hCLGlCQUFpQjtRQUNqQixhQUFhO1FBRWIsZUFBZTtRQUNmLFVBQVU7UUFDVixjQUFjO1FBQ2QsWUFBWTtRQUNaLGFBQWE7UUFDYixjQUFjO1FBRWQsNkJBQTZCO1FBQzdCLGFBQWE7UUFDYixjQUFjO1FBQ2QsV0FBVztRQUNYLE1BQU07UUFFTiwwQkFBMEI7UUFDMUIsUUFBUTtRQUNSLHdCQUF3QjtRQUN4QixXQUFXO1FBQ1gsV0FBVztLQUNaLENBQUM7SUFFZSxjQUFjLEdBQUcsRUFBRSxHQUFHLElBQUksR0FBRyxJQUFJLENBQUMsQ0FBQyxPQUFPO0lBQzFDLGVBQWUsR0FBRyxJQUFJLENBQUMsQ0FBQyxNQUFNO0lBQzlCLFlBQVksR0FBRyxJQUFJLENBQUMsQ0FBQyxNQUFNO0lBRTVDLFdBQVcsQ0FBQyxPQUF5QjtRQUNuQyxNQUFNLE9BQU8sR0FBRyxPQUFPLENBQUMsWUFBWSxFQUFFLENBQUMsVUFBVSxFQUFXLENBQUM7UUFFN0QscUJBQXFCO1FBQ3JCLElBQUksSUFBSSxDQUFDLGNBQWMsQ0FBQyxPQUFPLENBQUMsR0FBRyxJQUFJLENBQUMsY0FBYyxFQUFFLENBQUM7WUFDdkQsTUFBTSxJQUFJLDJCQUFrQixDQUFDLG1CQUFtQixDQUFDLENBQUM7UUFDcEQsQ0FBQztRQUVELG1CQUFtQjtRQUNuQixJQUFJLE9BQU8sQ0FBQyxHQUFHLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQyxZQUFZLEVBQUUsQ0FBQztZQUMzQyxNQUFNLElBQUksMkJBQWtC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TUFBTSxJQUFJLDJCQUFrQixDQUFDLGlCQUFpQixDQUFDLENBQUM7WUFDbEQsQ0FBQztZQUNELElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxJQUFJLEVBQUUsS0FBSyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDcEUsQ0FBQzthQUFNLElBQUksT0FBTyxJQUFJLEtBQUssUUFBUSxJQUFJLElBQUksS0FBSyxJQUFJLEVBQUUsQ0FBQztZQUNyRCxNQUFNLElBQUksR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQy9CLElBQUksSUFBSSxDQUFDLE1BQU0sR0FBRyxHQUFHLEVBQUUsQ0FBQztnQkFDdEIsTUFBTSxJQUFJLDJCQUFrQixDQUFDLDRCQUE0QixDQUFDLENBQUM7WUFDN0QsQ0FBQztZQUVELElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQyxHQUFHLEVBQUUsRUFBRTtnQkFDbkIsSUFBSSxDQUFDLGFBQWEsQ0FBQyxHQUFHLEVBQUUsWUFBWSxDQUFDLENBQUM7Z0JBQ3RDLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsS0FBSyxHQUFHLENBQUMsQ0FBQyxDQUFDO1lBQ2pELENBQUMsQ0FBQyxDQUFDO1FBQ0wsQ0FBQztJQUNILENBQUM7Q0FDRixDQUFBO0FBekhZLHNDQUFhO3dCQUFiLGFBQWE7SUFEekIsSUFBQSxtQkFBVSxHQUFFO0dBQ0EsYUFBYSxDQXlIekIiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL2NvbW1vbi9ndWFyZHMvc2VjdXJpdHkuZ3VhcmQudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgSW5qZWN0YWJsZSxcbiAgQ2FuQWN0aXZhdGUsXG4gIEV4ZWN1dGlvbkNvbnRleHQsXG4gIEZvcmJpZGRlbkV4Y2VwdGlvbixcbn0gZnJvbSAnQG5lc3Rqcy9jb21tb24nO1xuaW1wb3J0IHsgUmVxdWVzdCB9IGZyb20gJ2V4cHJlc3MnO1xuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgU2VjdXJpdHlHdWFyZCBpbXBsZW1lbnRzIENhbkFjdGl2YXRlIHtcbiAgcHJpdmF0ZSByZWFkb25seSBzdXNwaWNpb3VzUGF0dGVybnMgPSBbXG4gICAgLy8gU1FMIEluamVjdGlvbiBwYXR0ZXJuc1xuICAgIC91bmlvblxccytzZWxlY3QvaSxcbiAgICAvZHJvcFxccyt0YWJsZS9pLFxuICAgIC9pbnNlcnRcXHMraW50by9pLFxuICAgIC9kZWxldGVcXHMrZnJvbS9pLFxuICAgIC91cGRhdGVcXHMrLipzZXQvaSxcbiAgICAvc2NyaXB0XFxzKj4vaSxcblxuICAgIC8vIFhTUyBwYXR0ZXJuc1xuICAgIC88c2NyaXB0L2ksXG4gICAgL2phdmFzY3JpcHQ6L2ksXG4gICAgL3Zic2NyaXB0Oi9pLFxuICAgIC9vbmxvYWRcXHMqPS9pLFxuICAgIC9vbmVycm9yXFxzKj0vaSxcblxuICAgIC8vIENvbW1hbmQgaW5qZWN0aW9uIHBhdHRlcm5zXG4gICAgL1xcfFxccypjYXRcXHMrLyxcbiAgICAvO1xccypybVxccystcmYvLFxuICAgIC8mJlxccypjdXJsLyxcbiAgICAvYC4qYC8sXG5cbiAgICAvLyBQYXRoIHRyYXZlcnNhbCBwYXR0ZXJuc1xuICAgIC9cXC5cXC5cXC8vLFxuICAgIC9cXC5cXC5cXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXHcrLyxcbiAgICAvXFwuXFwuXFwlMmYvaSxcbiAgICAvXFwuXFwuXFwlNWMvaSxcbiAgXTtcblxuICBwcml2YXRlIHJlYWRvbmx5IG1heFJlcXVlc3RTaXplID0gMTAgKiAxMDI0ICogMTAyNDsgLy8gMTBNQlxuICBwcml2YXRlIHJlYWRvbmx5IG1heEhlYWRlckxlbmd0aCA9IDgxOTI7IC8vIDhLQlxuICBwcml2YXRlIHJlYWRvbmx5IG1heFVybExlbmd0aCA9IDIwNDg7IC8vIDJLQlxuXG4gIGNhbkFjdGl2YXRlKGNvbnRleHQ6IEV4ZWN1dGlvbkNvbnRleHQpOiBib29sZWFuIHtcbiAgICBjb25zdCByZXF1ZXN0ID0gY29udGV4dC5zd2l0Y2hUb0h0dHAoKS5nZXRSZXF1ZXN0PFJlcXVlc3Q+KCk7XG5cbiAgICAvLyBDaGVjayByZXF1ZXN0IHNpemVcbiAgICBpZiAodGhpcy5nZXRSZXF1ZXN0U2l6ZShyZXF1ZXN0KSA+IHRoaXMubWF4UmVxdWVzdFNpemUpIHtcbiAgICAgIHRocm93IG5ldyBGb3JiaWRkZW5FeGNlcHRpb24oJ1JlcXVlc3QgdG9vIGxhcmdlJyk7XG4gICAgfVxuXG4gICAgLy8gQ2hlY2sgVVJMIGxlbmd0aFxuICAgIGlmIChyZXF1ZXN0LnVybC5sZW5ndGggPiB0aGlzLm1heFVybExlbmd0aCkge1xuICAgICAgdGhyb3cgbmV3IEZvcmJpZGRlbkV4Y2VwdGlvbignVVJMIHRvbyBsb25nJyk7XG4gICAgfVxuXG4gICAgLy8gQ2hlY2sgaGVhZGVyc1xuICAgIHRoaXMudmFsaWRhdGVIZWFkZXJzKHJlcXVlc3QpO1xuXG4gICAgLy8gQ2hlY2sgZm9yIHN1c3BpY2lvdXMgcGF0dGVybnMgaW4gVVJMXG4gICAgdGhpcy52YWxpZGF0ZUlucHV0KHJlcXVlc3QudXJsLCAnVVJMJyk7XG5cbiAgICAvLyBDaGVjayBxdWVyeSBwYXJhbWV0ZXJzXG4gICAgT2JqZWN0LmVudHJpZXMocmVxdWVzdC5xdWVyeSB8fCB7fSkuZm9yRWFjaCgoW2tleSwgdmFsdWVdKSA9PiB7XG4gICAgICB0aGlzLnZhbGlkYXRlSW5wdXQoa2V5LCAnUXVlcnkgcGFyYW1ldGVyIGtleScpO1xuICAgICAgdGhpcy52YWxpZGF0ZUlucHV0KFN0cmluZyh2YWx1ZSksICdRdWVyeSBwYXJhbWV0ZXIgdmFsdWUnKTtcbiAgICB9KTtcblxuICAgIC8vIENoZWNrIGJvZHkgaWYgaXQgZXhpc3RzXG4gICAgaWYgKHJlcXVlc3QuYm9keSkge1xuICAgICAgdGhpcy52YWxpZGF0ZVJlcXVlc3RCb2R5KHJlcXVlc3QuYm9keSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRydWU7XG4gIH1cblxuICBwcml2YXRlIGdldFJlcXVlc3RTaXplKHJlcXVlc3Q6IFJlcXVlc3QpOiBudW1iZXIge1xuICAgIGNvbnN0IGNvbnRlbnRMZW5ndGggPSByZXF1ZXN0LmhlYWRlcnNbJ2NvbnRlbnQtbGVuZ3RoJ107XG4gICAgcmV0dXJuIGNvbnRlbnRMZW5ndGggPyBwYXJzZUludChjb250ZW50TGVuZ3RoLCAxMCkgOiAwO1xuICB9XG5cbiAgcHJpdmF0ZSB2YWxpZGF0ZUhlYWRlcnMocmVxdWVzdDogUmVxdWVzdCk6IHZvaWQge1xuICAgIE9iamVjdC5lbnRyaWVzKHJlcXVlc3QuaGVhZGVycykuZm9yRWFjaCgoW25hbWUsIHZhbHVlXSkgPT4ge1xuICAgICAgY29uc3QgaGVhZGVyVmFsdWUgPSBBcnJheS5pc0FycmF5KHZhbHVlKVxuICAgICAgICA/IHZhbHVlLmpvaW4oJycpXG4gICAgICAgIDogU3RyaW5nKHZhbHVlIHx8ICcnKTtcblxuICAgICAgaWYgKGhlYWRlclZhbHVlLmxlbmd0aCA+IHRoaXMubWF4SGVhZGVyTGVuZ3RoKSB7XG4gICAgICAgIHRocm93IG5ldyBGb3JiaWRkZW5FeGNlcHRpb24oYEhlYWRlciAke25hbWV9IHRvbyBsb25nYCk7XG4gICAgICB9XG5cbiAgICAgIHRoaXMudmFsaWRhdGVJbnB1dChoZWFkZXJWYWx1ZSwgYEhlYWRlciAke25hbWV9YCk7XG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIHZhbGlkYXRlSW5wdXQoaW5wdXQ6IHN0cmluZywgY29udGV4dDogc3RyaW5nKTogdm9pZCB7XG4gICAgZm9yIChjb25zdCBwYXR0ZXJuIG9mIHRoaXMuc3VzcGljaW91c1BhdHRlcm5zKSB7XG4gICAgICBpZiAocGF0dGVybi50ZXN0KGlucHV0KSkge1xuICAgICAgICB0aHJvdyBuZXcgRm9yYmlkZGVuRXhjZXB0aW9uKFxuICAgICAgICAgIGBTdXNwaWNpb3VzIGNvbnRlbnQgZGV0ZWN0ZWQgaW4gJHtjb250ZXh0fWAsXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSB2YWxpZGF0ZVJlcXVlc3RCb2R5KGJvZHk6IGFueSwgZGVwdGggPSAwKTogdm9pZCB7XG4gICAgLy8gUHJldmVudCBkZWVwIG5lc3RpbmcgYXR0YWNrc1xuICAgIGlmIChkZXB0aCA+IDEwKSB7XG4gICAgICB0aHJvdyBuZXcgRm9yYmlkZGVuRXhjZXB0aW9uKCdSZXF1ZXN0IGJvZHkgdG9vIGRlZXBseSBuZXN0ZWQnKTtcbiAgICB9XG5cbiAgICBpZiAodHlwZW9mIGJvZHkgPT09ICdzdHJpbmcnKSB7XG4gICAgICB0aGlzLnZhbGlkYXRlSW5wdXQoYm9keSwgJ1JlcXVlc3QgYm9keScpO1xuICAgIH0gZWxzZSBpZiAoQXJyYXkuaXNBcnJheShib2R5KSkge1xuICAgICAgaWYgKGJvZHkubGVuZ3RoID4gMTAwMCkge1xuICAgICAgICB0aHJvdyBuZXcgRm9yYmlkZGVuRXhjZXB0aW9uKCdBcnJheSB0b28gbGFyZ2UnKTtcbiAgICAgIH1cbiAgICAgIGJvZHkuZm9yRWFjaCgoaXRlbSkgPT4gdGhpcy52YWxpZGF0ZVJlcXVlc3RCb2R5KGl0ZW0sIGRlcHRoICsgMSkpO1xuICAgIH0gZWxzZSBpZiAodHlwZW9mIGJvZHkgPT09ICdvYmplY3QnICYmIGJvZHkgIT09IG51bGwpIHtcbiAgICAgIGNvbnN0IGtleXMgPSBPYmplY3Qua2V5cyhib2R5KTtcbiAgICAgIGlmIChrZXlzLmxlbmd0aCA+IDEwMCkge1xuICAgICAgICB0aHJvdyBuZXcgRm9yYmlkZGVuRXhjZXB0aW9uKCdUb28gbWFueSBvYmplY3QgcHJvcGVydGllcycpO1xuICAgICAgfVxuXG4gICAgICBrZXlzLmZvckVhY2goKGtleSkgPT4ge1xuICAgICAgICB0aGlzLnZhbGlkYXRlSW5wdXQoa2V5LCAnT2JqZWN0IGtleScpO1xuICAgICAgICB0aGlzLnZhbGlkYXRlUmVxdWVzdEJvZHkoYm9keVtrZXldLCBkZXB0aCArIDEpO1xuICAgICAgfSk7XG4gICAgfVxuICB9XG59XG4iXSwidmVyc2lvbiI6M30=