{"file":"/home/wetooa/Documents/code/projects/mentara/mentara-api/src/common/guards/security.guard.ts","mappings":";;;;;;;;;AAAA,2CAKwB;AAIjB,IAAM,aAAa,GAAnB,MAAM,aAAa;IACP,kBAAkB,GAAG;QACpC,yBAAyB;QACzB,iBAAiB;QACjB,eAAe;QACf,gBAAgB;QAChB,gBAAgB;QAChB,iBAAiB;QACjB,aAAa;QAEb,eAAe;QACf,UAAU;QACV,cAAc;QACd,YAAY;QACZ,aAAa;QACb,cAAc;QAEd,6BAA6B;QAC7B,aAAa;QACb,cAAc;QACd,WAAW;QACX,MAAM;QAEN,0BAA0B;QAC1B,QAAQ;QACR,wBAAwB;QACxB,WAAW;QACX,WAAW;KACZ,CAAC;IAEe,cAAc,GAAG,EAAE,GAAG,IAAI,GAAG,IAAI,CAAC,CAAC,OAAO;IAC1C,eAAe,GAAG,IAAI,CAAC,CAAC,MAAM;IAC9B,YAAY,GAAG,IAAI,CAAC,CAAC,MAAM;IAE5C,WAAW,CAAC,OAAyB;QACnC,MAAM,OAAO,GAAG,OAAO,CAAC,YAAY,EAAE,CAAC,UAAU,EAAW,CAAC;QAE7D,qBAAqB;QACrB,IAAI,IAAI,CAAC,cAAc,CAAC,OAAO,CAAC,GAAG,IAAI,CAAC,cAAc,EAAE,CAAC;YACvD,MAAM,IAAI,2BAAkB,CAAC,mBAAmB,CAAC,CAAC;QACpD,CAAC;QAED,mBAAmB;QACnB,IAAI,OAAO,CAAC,GAAG,CAAC,MAAM,GAAG,IAAI,CAAC,YAAY,EAAE,CAAC;YAC3C,MAAM,IAAI,2BAAkB,CAAC,cAAc,CAAC,CAAC;QAC/C,CAAC;QAED,gBAAgB;QAChB,IAAI,CAAC,eAAe,CAAC,OAAO,CAAC,CAAC;QAE9B,uCAAuC;QACvC,IAAI,CAAC,aAAa,CAAC,OAAO,CAAC,GAAG,EAAE,KAAK,CAAC,CAAC;QAEvC,yBAAyB;QACzB,MAAM,CAAC,OAAO,CAAC,OAAO,CAAC,KAAK,IAAI,EAAE,CAAC,CAAC,OAAO,CAAC,CAAC,CAAC,GAAG,EAAE,KAAK,CAAC,EAAE,EAAE;YAC3D,IAAI,CAAC,aAAa,CAAC,GAAG,EAAE,qBAAqB,CAAC,CAAC;YAC/C,IAAI,CAAC,aAAa,CAAC,MAAM,CAAC,KAAK,CAAC,EAAE,uBAAuB,CAAC,CAAC;QAC7D,CAAC,CAAC,CAAC;QAEH,0BAA0B;QAC1B,IAAI,OAAO,CAAC,IAAI,EAAE,CAAC;YACjB,IAAI,CAAC,mBAAmB,CAAC,OAAO,CAAC,IAAI,CAAC,CAAC;QACzC,CAAC;QAED,OAAO,IAAI,CAAC;IACd,CAAC;IAEO,cAAc,CAAC,OAAgB;QACrC,MAAM,aAAa,GAAG,OAAO,CAAC,OAAO,CAAC,gBAAgB,CAAC,CAAC;QACxD,OAAO,aAAa,CAAC,CAAC,CAAC,QAAQ,CAAC,aAAa,EAAE,EAAE,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC;IACzD,CAAC;IAEO,eAAe,CAAC,OAAgB;QACtC,MAAM,CAAC,OAAO,CAAC,OAAO,CAAC,OAAO,CAAC,CAAC,OAAO,CAAC,CAAC,CAAC,IAAI,EAAE,KAAK,CAAC,EAAE,EAAE;YACxD,MAAM,WAAW,GAAG,KAAK,CAAC,OAAO,CAAC,KAAK,CAAC;gBACtC,CAAC,CAAC,KAAK,CAAC,IAAI,CAAC,EAAE,CAAC;gBAChB,CAAC,CAAC,MAAM,CAAC,KAAK,IAAI,EAAE,CAAC,CAAC;YAExB,IAAI,WAAW,CAAC,MAAM,GAAG,IAAI,CAAC,eAAe,EAAE,CAAC;gBAC9C,MAAM,IAAI,2BAAkB,CAAC,UAAU,IAAI,WAAW,CAAC,CAAC;YAC1D,CAAC;YAED,IAAI,CAAC,aAAa,CAAC,WAAW,EAAE,UAAU,IAAI,EAAE,CAAC,CAAC;QACpD,CAAC,CAAC,CAAC;IACL,CAAC;IAEO,aAAa,CAAC,KAAa,EAAE,OAAe;QAClD,KAAK,MAAM,OAAO,IAAI,IAAI,CAAC,kBAAkB,EAAE,CAAC;YAC9C,IAAI,OAAO,CAAC,IAAI,CAAC,KAAK,CAAC,EAAE,CAAC;gBACxB,MAAM,IAAI,2BAAkB,CAC1B,kCAAkC,OAAO,EAAE,CAC5C,CAAC;YACJ,CAAC;QACH,CAAC;IACH,CAAC;IAEO,mBAAmB,CAAC,IAAS,EAAE,KAAK,GAAG,CAAC;QAC9C,+BAA+B;QAC/B,IAAI,KAAK,GAAG,EAAE,EAAE,CAAC;YACf,MAAM,IAAI,2BAAkB,CAAC,gCAAgC,CAAC,CAAC;QACjE,CAAC;QAED,IAAI,OAAO,IAAI,KAAK,QAAQ,EAAE,CAAC;YAC7B,IAAI,CAAC,aAAa,CAAC,IAAI,EAAE,cAAc,CAAC,CAAC;QAC3C,CAAC;aAAM,IAAI,KAAK,CAAC,OAAO,CAAC,IAAI,CAAC,EAAE,CAAC;YAC/B,IAAI,IAAI,CAAC,MAAM,GAAG,IAAI,EAAE,CAAC;gBACvB,MAAM,IAAI,2BAAkB,CAAC,iBAAiB,CAAC,CAAC;YAClD,CAAC;YACD,IAAI,CAAC,OAAO,CAAC,CAAC,IAAI,EAAE,EAAE,CAAC,IAAI,CAAC,mBAAmB,CAAC,IAAI,EAAE,KAAK,GAAG,CAAC,CAAC,CAAC,CAAC;QACpE,CAAC;aAAM,IAAI,OAAO,IAAI,KAAK,QAAQ,IAAI,IAAI,KAAK,IAAI,EAAE,CAAC;YACrD,MAAM,IAAI,GAAG,MAAM,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;YAC/B,IAAI,IAAI,CAAC,MAAM,GAAG,GAAG,EAAE,CAAC;gBACtB,MAAM,IAAI,2BAAkB,CAAC,4BAA4B,CAAC,CAAC;YAC7D,CAAC;YAED,IAAI,CAAC,OAAO,CAAC,CAAC,GAAG,EAAE,EAAE;gBACnB,IAAI,CAAC,aAAa,CAAC,GAAG,EAAE,YAAY,CAAC,CAAC;gBACtC,IAAI,CAAC,mBAAmB,CAAC,IAAI,CAAC,GAAG,CAAC,EAAE,KAAK,GAAG,CAAC,CAAC,CAAC;YACjD,CAAC,CAAC,CAAC;QACL,CAAC;IACH,CAAC;CACF,CAAA;AAzHY,sCAAa;wBAAb,aAAa;IADzB,IAAA,mBAAU,GAAE;GACA,aAAa,CAyHzB","names":[],"sources":["/home/wetooa/Documents/code/projects/mentara/mentara-api/src/common/guards/security.guard.ts"],"sourcesContent":["import {\n  Injectable,\n  CanActivate,\n  ExecutionContext,\n  ForbiddenException,\n} from '@nestjs/common';\nimport { Request } from 'express';\n\n@Injectable()\nexport class SecurityGuard implements CanActivate {\n  private readonly suspiciousPatterns = [\n    // SQL Injection patterns\n    /union\\s+select/i,\n    /drop\\s+table/i,\n    /insert\\s+into/i,\n    /delete\\s+from/i,\n    /update\\s+.*set/i,\n    /script\\s*>/i,\n\n    // XSS patterns\n    /<script/i,\n    /javascript:/i,\n    /vbscript:/i,\n    /onload\\s*=/i,\n    /onerror\\s*=/i,\n\n    // Command injection patterns\n    /\\|\\s*cat\\s+/,\n    /;\\s*rm\\s+-rf/,\n    /&&\\s*curl/,\n    /`.*`/,\n\n    // Path traversal patterns\n    /\\.\\.\\//,\n    /\\.\\.\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\w+/,\n    /\\.\\.\\%2f/i,\n    /\\.\\.\\%5c/i,\n  ];\n\n  private readonly maxRequestSize = 10 * 1024 * 1024; // 10MB\n  private readonly maxHeaderLength = 8192; // 8KB\n  private readonly maxUrlLength = 2048; // 2KB\n\n  canActivate(context: ExecutionContext): boolean {\n    const request = context.switchToHttp().getRequest<Request>();\n\n    // Check request size\n    if (this.getRequestSize(request) > this.maxRequestSize) {\n      throw new ForbiddenException('Request too large');\n    }\n\n    // Check URL length\n    if (request.url.length > this.maxUrlLength) {\n      throw new ForbiddenException('URL too long');\n    }\n\n    // Check headers\n    this.validateHeaders(request);\n\n    // Check for suspicious patterns in URL\n    this.validateInput(request.url, 'URL');\n\n    // Check query parameters\n    Object.entries(request.query || {}).forEach(([key, value]) => {\n      this.validateInput(key, 'Query parameter key');\n      this.validateInput(String(value), 'Query parameter value');\n    });\n\n    // Check body if it exists\n    if (request.body) {\n      this.validateRequestBody(request.body);\n    }\n\n    return true;\n  }\n\n  private getRequestSize(request: Request): number {\n    const contentLength = request.headers['content-length'];\n    return contentLength ? parseInt(contentLength, 10) : 0;\n  }\n\n  private validateHeaders(request: Request): void {\n    Object.entries(request.headers).forEach(([name, value]) => {\n      const headerValue = Array.isArray(value)\n        ? value.join('')\n        : String(value || '');\n\n      if (headerValue.length > this.maxHeaderLength) {\n        throw new ForbiddenException(`Header ${name} too long`);\n      }\n\n      this.validateInput(headerValue, `Header ${name}`);\n    });\n  }\n\n  private validateInput(input: string, context: string): void {\n    for (const pattern of this.suspiciousPatterns) {\n      if (pattern.test(input)) {\n        throw new ForbiddenException(\n          `Suspicious content detected in ${context}`,\n        );\n      }\n    }\n  }\n\n  private validateRequestBody(body: any, depth = 0): void {\n    // Prevent deep nesting attacks\n    if (depth > 10) {\n      throw new ForbiddenException('Request body too deeply nested');\n    }\n\n    if (typeof body === 'string') {\n      this.validateInput(body, 'Request body');\n    } else if (Array.isArray(body)) {\n      if (body.length > 1000) {\n        throw new ForbiddenException('Array too large');\n      }\n      body.forEach((item) => this.validateRequestBody(item, depth + 1));\n    } else if (typeof body === 'object' && body !== null) {\n      const keys = Object.keys(body);\n      if (keys.length > 100) {\n        throw new ForbiddenException('Too many object properties');\n      }\n\n      keys.forEach((key) => {\n        this.validateInput(key, 'Object key');\n        this.validateRequestBody(body[key], depth + 1);\n      });\n    }\n  }\n}\n"],"version":3}