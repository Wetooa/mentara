{"file":"/home/wetooa/Documents/code/projects/mentara/mentara-api/src/audit-logs/audit-logs.service.ts","mappings":"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","names":[],"sources":["/home/wetooa/Documents/code/projects/mentara/mentara-api/src/audit-logs/audit-logs.service.ts"],"sourcesContent":["import { Injectable } from '@nestjs/common';\nimport { PrismaService } from 'src/providers/prisma-client.provider';\nimport {\n  AuditAction,\n  EventSeverity,\n  SystemEventType,\n  DataClassification,\n} from '@prisma/client';\n\n@Injectable()\nexport class AuditLogsService {\n  constructor(private readonly prisma: PrismaService) {}\n\n  async createAuditLog(data: {\n    action: AuditAction;\n    entity: string;\n    entityId: string;\n    userId?: string;\n    userRole?: string;\n    oldValues?: any;\n    newValues?: any;\n    description?: string;\n    metadata?: any;\n    ipAddress?: string;\n    userAgent?: string;\n    requestId?: string;\n  }) {\n    return this.prisma.auditLog.create({\n      data,\n      include: {\n        user: {\n          select: {\n            id: true,\n            firstName: true,\n            lastName: true,\n            email: true,\n            role: true,\n          },\n        },\n      },\n    });\n  }\n\n  async findAuditLogs(\n    userId?: string,\n    action?: AuditAction,\n    entity?: string,\n    entityId?: string,\n    startDate?: Date,\n    endDate?: Date,\n    limit = 100,\n  ) {\n    const where: any = {};\n\n    if (userId) where.userId = userId;\n    if (action) where.action = action;\n    if (entity) where.entity = entity;\n    if (entityId) where.entityId = entityId;\n    if (startDate) where.createdAt = { ...where.createdAt, gte: startDate };\n    if (endDate) where.createdAt = { ...where.createdAt, lte: endDate };\n\n    return this.prisma.auditLog.findMany({\n      where,\n      include: {\n        user: {\n          select: {\n            id: true,\n            firstName: true,\n            lastName: true,\n            email: true,\n            role: true,\n          },\n        },\n      },\n      orderBy: { createdAt: 'desc' },\n      take: limit,\n    });\n  }\n\n  async createSystemEvent(data: {\n    eventType: SystemEventType;\n    severity: EventSeverity;\n    title: string;\n    description: string;\n    component?: string;\n    metadata?: any;\n    errorCode?: string;\n    stackTrace?: string;\n  }) {\n    return this.prisma.systemEvent.create({\n      data,\n    });\n  }\n\n  async findSystemEvents(\n    eventType?: SystemEventType,\n    severity?: EventSeverity,\n    component?: string,\n    isResolved?: boolean,\n    startDate?: Date,\n    endDate?: Date,\n    limit = 100,\n  ) {\n    const where: any = {};\n\n    if (eventType) where.eventType = eventType;\n    if (severity) where.severity = severity;\n    if (component) where.component = component;\n    if (isResolved !== undefined) where.isResolved = isResolved;\n    if (startDate) where.createdAt = { ...where.createdAt, gte: startDate };\n    if (endDate) where.createdAt = { ...where.createdAt, lte: endDate };\n\n    return this.prisma.systemEvent.findMany({\n      where,\n      orderBy: { createdAt: 'desc' },\n      take: limit,\n    });\n  }\n\n  async resolveSystemEvent(id: string, resolvedBy: string, resolution: string) {\n    return this.prisma.systemEvent.update({\n      where: { id },\n      data: {\n        isResolved: true,\n        resolvedAt: new Date(),\n        resolvedBy,\n        resolution,\n      },\n    });\n  }\n\n  async createDataChangeLog(data: {\n    tableName: string;\n    recordId: string;\n    operation: 'INSERT' | 'UPDATE' | 'DELETE';\n    changedFields?: string[];\n    oldData?: any;\n    newData?: any;\n    changedBy?: string;\n    reason?: string;\n    dataClass?: DataClassification;\n  }) {\n    return this.prisma.dataChangeLog.create({\n      data: {\n        ...data,\n        dataClass: data.dataClass || DataClassification.INTERNAL,\n      },\n    });\n  }\n\n  async findDataChangeLogs(\n    tableName?: string,\n    recordId?: string,\n    operation?: string,\n    changedBy?: string,\n    startDate?: Date,\n    endDate?: Date,\n    limit = 100,\n  ) {\n    const where: any = {};\n\n    if (tableName) where.tableName = tableName;\n    if (recordId) where.recordId = recordId;\n    if (operation) where.operation = operation;\n    if (changedBy) where.changedBy = changedBy;\n    if (startDate) where.createdAt = { ...where.createdAt, gte: startDate };\n    if (endDate) where.createdAt = { ...where.createdAt, lte: endDate };\n\n    return this.prisma.dataChangeLog.findMany({\n      where,\n      orderBy: { createdAt: 'desc' },\n      take: limit,\n    });\n  }\n\n  // Helper methods for common audit scenarios\n\n  async logUserLogin(userId: string, ipAddress?: string, userAgent?: string) {\n    return this.createAuditLog({\n      action: AuditAction.USER_LOGIN,\n      entity: 'User',\n      entityId: userId,\n      userId,\n      description: 'User logged in',\n      ipAddress,\n      userAgent,\n    });\n  }\n\n  async logUserLogout(userId: string, ipAddress?: string, userAgent?: string) {\n    return this.createAuditLog({\n      action: AuditAction.USER_LOGOUT,\n      entity: 'User',\n      entityId: userId,\n      userId,\n      description: 'User logged out',\n      ipAddress,\n      userAgent,\n    });\n  }\n\n  async logProfileUpdate(\n    userId: string,\n    oldValues: any,\n    newValues: any,\n    ipAddress?: string,\n    userAgent?: string,\n  ) {\n    return this.createAuditLog({\n      action: AuditAction.USER_UPDATE_PROFILE,\n      entity: 'User',\n      entityId: userId,\n      userId,\n      oldValues,\n      newValues,\n      description: 'User updated profile',\n      ipAddress,\n      userAgent,\n    });\n  }\n\n  async logTherapistApplicationSubmit(\n    userId: string,\n    applicationData: any,\n    ipAddress?: string,\n    userAgent?: string,\n  ) {\n    return this.createAuditLog({\n      action: AuditAction.THERAPIST_APPLICATION_SUBMIT,\n      entity: 'Therapist',\n      entityId: userId,\n      userId,\n      newValues: applicationData,\n      description: 'Therapist application submitted',\n      ipAddress,\n      userAgent,\n    });\n  }\n\n  async logTherapistApplicationReview(\n    therapistId: string,\n    reviewedBy: string,\n    status: 'approved' | 'rejected',\n    oldStatus: string,\n    ipAddress?: string,\n    userAgent?: string,\n  ) {\n    const action =\n      status === 'approved'\n        ? AuditAction.THERAPIST_APPLICATION_APPROVE\n        : AuditAction.THERAPIST_APPLICATION_REJECT;\n\n    return this.createAuditLog({\n      action,\n      entity: 'Therapist',\n      entityId: therapistId,\n      userId: reviewedBy,\n      oldValues: { status: oldStatus },\n      newValues: { status },\n      description: `Therapist application ${status}`,\n      ipAddress,\n      userAgent,\n    });\n  }\n\n  async logMeetingCreate(\n    meetingId: string,\n    createdBy: string,\n    meetingData: any,\n    ipAddress?: string,\n    userAgent?: string,\n  ) {\n    return this.createAuditLog({\n      action: AuditAction.MEETING_CREATE,\n      entity: 'Meeting',\n      entityId: meetingId,\n      userId: createdBy,\n      newValues: meetingData,\n      description: 'Meeting created',\n      ipAddress,\n      userAgent,\n    });\n  }\n\n  async logMeetingUpdate(\n    meetingId: string,\n    updatedBy: string,\n    oldValues: any,\n    newValues: any,\n    ipAddress?: string,\n    userAgent?: string,\n  ) {\n    return this.createAuditLog({\n      action: AuditAction.MEETING_UPDATE,\n      entity: 'Meeting',\n      entityId: meetingId,\n      userId: updatedBy,\n      oldValues,\n      newValues,\n      description: 'Meeting updated',\n      ipAddress,\n      userAgent,\n    });\n  }\n\n  async logSystemError(component: string, error: Error, metadata?: any) {\n    return this.createSystemEvent({\n      eventType: SystemEventType.THIRD_PARTY_API_ERROR,\n      severity: EventSeverity.ERROR,\n      title: `Error in ${component}`,\n      description: error.message,\n      component,\n      metadata: {\n        ...metadata,\n        errorName: error.name,\n      },\n      stackTrace: error.stack,\n    });\n  }\n\n  async getAuditStatistics(startDate?: Date, endDate?: Date) {\n    const where: any = {};\n    if (startDate) where.createdAt = { ...where.createdAt, gte: startDate };\n    if (endDate) where.createdAt = { ...where.createdAt, lte: endDate };\n\n    const [totalLogs, actionStats, entityStats, userStats] = await Promise.all([\n      this.prisma.auditLog.count({ where }),\n      this.prisma.auditLog.groupBy({\n        by: ['action'],\n        where,\n        _count: { action: true },\n      }),\n      this.prisma.auditLog.groupBy({\n        by: ['entity'],\n        where,\n        _count: { entity: true },\n      }),\n      this.prisma.auditLog.groupBy({\n        by: ['userId'],\n        where: { ...where, userId: { not: null } },\n        _count: { userId: true },\n        take: 10,\n        orderBy: { _count: { userId: 'desc' } },\n      }),\n    ]);\n\n    return {\n      totalLogs,\n      actionStats,\n      entityStats,\n      topUsers: userStats,\n    };\n  }\n}\n"],"version":3}