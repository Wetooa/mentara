2a172d6c3f18b5cb9128f0794ec10bbc
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.AuditLogsService = void 0;
const common_1 = require("@nestjs/common");
const prisma_client_provider_1 = require("src/providers/prisma-client.provider");
const client_1 = require("@prisma/client");
let AuditLogsService = class AuditLogsService {
    prisma;
    constructor(prisma) {
        this.prisma = prisma;
    }
    async createAuditLog(data) {
        return this.prisma.auditLog.create({
            data,
            include: {
                user: {
                    select: {
                        id: true,
                        firstName: true,
                        lastName: true,
                        email: true,
                        role: true,
                    },
                },
            },
        });
    }
    async findAuditLogs(userId, action, entity, entityId, startDate, endDate, limit = 100) {
        const where = {};
        if (userId)
            where.userId = userId;
        if (action)
            where.action = action;
        if (entity)
            where.entity = entity;
        if (entityId)
            where.entityId = entityId;
        if (startDate)
            where.createdAt = { ...where.createdAt, gte: startDate };
        if (endDate)
            where.createdAt = { ...where.createdAt, lte: endDate };
        return this.prisma.auditLog.findMany({
            where,
            include: {
                user: {
                    select: {
                        id: true,
                        firstName: true,
                        lastName: true,
                        email: true,
                        role: true,
                    },
                },
            },
            orderBy: { createdAt: 'desc' },
            take: limit,
        });
    }
    async createSystemEvent(data) {
        return this.prisma.systemEvent.create({
            data,
        });
    }
    async findSystemEvents(eventType, severity, component, isResolved, startDate, endDate, limit = 100) {
        const where = {};
        if (eventType)
            where.eventType = eventType;
        if (severity)
            where.severity = severity;
        if (component)
            where.component = component;
        if (isResolved !== undefined)
            where.isResolved = isResolved;
        if (startDate)
            where.createdAt = { ...where.createdAt, gte: startDate };
        if (endDate)
            where.createdAt = { ...where.createdAt, lte: endDate };
        return this.prisma.systemEvent.findMany({
            where,
            orderBy: { createdAt: 'desc' },
            take: limit,
        });
    }
    async resolveSystemEvent(id, resolvedBy, resolution) {
        return this.prisma.systemEvent.update({
            where: { id },
            data: {
                isResolved: true,
                resolvedAt: new Date(),
                resolvedBy,
                resolution,
            },
        });
    }
    async createDataChangeLog(data) {
        return this.prisma.dataChangeLog.create({
            data: {
                ...data,
                dataClass: data.dataClass || client_1.DataClassification.INTERNAL,
            },
        });
    }
    async findDataChangeLogs(tableName, recordId, operation, changedBy, startDate, endDate, limit = 100) {
        const where = {};
        if (tableName)
            where.tableName = tableName;
        if (recordId)
            where.recordId = recordId;
        if (operation)
            where.operation = operation;
        if (changedBy)
            where.changedBy = changedBy;
        if (startDate)
            where.createdAt = { ...where.createdAt, gte: startDate };
        if (endDate)
            where.createdAt = { ...where.createdAt, lte: endDate };
        return this.prisma.dataChangeLog.findMany({
            where,
            orderBy: { createdAt: 'desc' },
            take: limit,
        });
    }
    // Helper methods for common audit scenarios
    async logUserLogin(userId, ipAddress, userAgent) {
        return this.createAuditLog({
            action: client_1.AuditAction.USER_LOGIN,
            entity: 'User',
            entityId: userId,
            userId,
            description: 'User logged in',
            ipAddress,
            userAgent,
        });
    }
    async logUserLogout(userId, ipAddress, userAgent) {
        return this.createAuditLog({
            action: client_1.AuditAction.USER_LOGOUT,
            entity: 'User',
            entityId: userId,
            userId,
            description: 'User logged out',
            ipAddress,
            userAgent,
        });
    }
    async logProfileUpdate(userId, oldValues, newValues, ipAddress, userAgent) {
        return this.createAuditLog({
            action: client_1.AuditAction.USER_UPDATE_PROFILE,
            entity: 'User',
            entityId: userId,
            userId,
            oldValues,
            newValues,
            description: 'User updated profile',
            ipAddress,
            userAgent,
        });
    }
    async logTherapistApplicationSubmit(userId, applicationData, ipAddress, userAgent) {
        return this.createAuditLog({
            action: client_1.AuditAction.THERAPIST_APPLICATION_SUBMIT,
            entity: 'Therapist',
            entityId: userId,
            userId,
            newValues: applicationData,
            description: 'Therapist application submitted',
            ipAddress,
            userAgent,
        });
    }
    async logTherapistApplicationReview(therapistId, reviewedBy, status, oldStatus, ipAddress, userAgent) {
        const action = status === 'approved'
            ? client_1.AuditAction.THERAPIST_APPLICATION_APPROVE
            : client_1.AuditAction.THERAPIST_APPLICATION_REJECT;
        return this.createAuditLog({
            action,
            entity: 'Therapist',
            entityId: therapistId,
            userId: reviewedBy,
            oldValues: { status: oldStatus },
            newValues: { status },
            description: `Therapist application ${status}`,
            ipAddress,
            userAgent,
        });
    }
    async logMeetingCreate(meetingId, createdBy, meetingData, ipAddress, userAgent) {
        return this.createAuditLog({
            action: client_1.AuditAction.MEETING_CREATE,
            entity: 'Meeting',
            entityId: meetingId,
            userId: createdBy,
            newValues: meetingData,
            description: 'Meeting created',
            ipAddress,
            userAgent,
        });
    }
    async logMeetingUpdate(meetingId, updatedBy, oldValues, newValues, ipAddress, userAgent) {
        return this.createAuditLog({
            action: client_1.AuditAction.MEETING_UPDATE,
            entity: 'Meeting',
            entityId: meetingId,
            userId: updatedBy,
            oldValues,
            newValues,
            description: 'Meeting updated',
            ipAddress,
            userAgent,
        });
    }
    async logSystemError(component, error, metadata) {
        return this.createSystemEvent({
            eventType: client_1.SystemEventType.THIRD_PARTY_API_ERROR,
            severity: client_1.EventSeverity.ERROR,
            title: `Error in ${component}`,
            description: error.message,
            component,
            metadata: {
                ...metadata,
                errorName: error.name,
            },
            stackTrace: error.stack,
        });
    }
    async getAuditStatistics(startDate, endDate) {
        const where = {};
        if (startDate)
            where.createdAt = { ...where.createdAt, gte: startDate };
        if (endDate)
            where.createdAt = { ...where.createdAt, lte: endDate };
        const [totalLogs, actionStats, entityStats, userStats] = await Promise.all([
            this.prisma.auditLog.count({ where }),
            this.prisma.auditLog.groupBy({
                by: ['action'],
                where,
                _count: { action: true },
            }),
            this.prisma.auditLog.groupBy({
                by: ['entity'],
                where,
                _count: { entity: true },
            }),
            this.prisma.auditLog.groupBy({
                by: ['userId'],
                where: { ...where, userId: { not: null } },
                _count: { userId: true },
                take: 10,
                orderBy: { _count: { userId: 'desc' } },
            }),
        ]);
        return {
            totalLogs,
            actionStats,
            entityStats,
            topUsers: userStats,
        };
    }
};
exports.AuditLogsService = AuditLogsService;
exports.AuditLogsService = AuditLogsService = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [prisma_client_provider_1.PrismaService])
], AuditLogsService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL2F1ZGl0LWxvZ3MvYXVkaXQtbG9ncy5zZXJ2aWNlLnRzIiwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7OztBQUFBLDJDQUE0QztBQUM1QyxpRkFBcUU7QUFDckUsMkNBS3dCO0FBR2pCLElBQU0sZ0JBQWdCLEdBQXRCLE1BQU0sZ0JBQWdCO0lBQ0U7SUFBN0IsWUFBNkIsTUFBcUI7UUFBckIsV0FBTSxHQUFOLE1BQU0sQ0FBZTtJQUFHLENBQUM7SUFFdEQsS0FBSyxDQUFDLGNBQWMsQ0FBQyxJQWFwQjtRQUNDLE9BQU8sSUFBSSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDO1lBQ2pDLElBQUk7WUFDSixPQUFPLEVBQUU7Z0JBQ1AsSUFBSSxFQUFFO29CQUNKLE1BQU0sRUFBRTt3QkFDTixFQUFFLEVBQUUsSUFBSTt3QkFDUixTQUFTLEVBQUUsSUFBSTt3QkFDZixRQUFRLEVBQUUsSUFBSTt3QkFDZCxLQUFLLEVBQUUsSUFBSTt3QkFDWCxJQUFJLEVBQUUsSUFBSTtxQkFDWDtpQkFDRjthQUNGO1NBQ0YsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVELEtBQUssQ0FBQyxhQUFhLENBQ2pCLE1BQWUsRUFDZixNQUFvQixFQUNwQixNQUFlLEVBQ2YsUUFBaUIsRUFDakIsU0FBZ0IsRUFDaEIsT0FBYyxFQUNkLEtBQUssR0FBRyxHQUFHO1FBRVgsTUFBTSxLQUFLLEdBQVEsRUFBRSxDQUFDO1FBRXRCLElBQUksTUFBTTtZQUFFLEtBQUssQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDO1FBQ2xDLElBQUksTUFBTTtZQUFFLEtBQUssQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDO1FBQ2xDLElBQUksTUFBTTtZQUFFLEtBQUssQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDO1FBQ2xDLElBQUksUUFBUTtZQUFFLEtBQUssQ0FBQyxRQUFRLEdBQUcsUUFBUSxDQUFDO1FBQ3hDLElBQUks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Z0JBQ2QsS0FBSztnQkFDTCxNQUFNLEVBQUUsRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFO2FBQ3pCLENBQUM7WUFDRixJQUFJLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUM7Z0JBQzNCLEVBQUUsRUFBRSxDQUFDLFFBQVEsQ0FBQztnQkFDZCxLQUFLO2dCQUNMLE1BQU0sRUFBRSxFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUU7YUFDekIsQ0FBQztZQUNGLElBQUksQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQztnQkFDM0IsRUFBRSxFQUFFLENBQUMsUUFBUSxDQUFDO2dCQUNkLEtBQUssRUFBRSxFQUFFLEdBQUcsS0FBSyxFQUFFLE1BQU0sRUFBRSxFQUFFLEdBQUcsRUFBRSxJQUFJLEVBQUUsRUFBRTtnQkFDMUMsTUFBTSxFQUFFLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRTtnQkFDeEIsSUFBSSxFQUFFLEVBQUU7Z0JBQ1IsT0FBTyxFQUFFLEVBQUUsTUFBTSxFQUFFLEVBQUUsTUFBTSxFQUFFLE1BQU0sRUFBRSxFQUFFO2FBQ3hDLENBQUM7U0FDSCxDQUFDLENBQUM7UUFFSCxPQUFPO1lBQ0wsU0FBUztZQUNULFdBQVc7WUFDWCxXQUFXO1lBQ1gsUUFBUSxFQUFFLFNBQVM7U0FDcEIsQ0FBQztJQUNKLENBQUM7Q0FDRixDQUFBO0FBdlZZLDRDQUFnQjsyQkFBaEIsZ0JBQWdCO0lBRDVCLElBQUEsbUJBQVUsR0FBRTtxQ0FFMEIsc0NBQWE7R0FEdkMsZ0JBQWdCLENBdVY1QiIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvaG9tZS93ZXRvb2EvRG9jdW1lbnRzL2NvZGUvcHJvamVjdHMvbWVudGFyYS9tZW50YXJhLWFwaS9zcmMvYXVkaXQtbG9ncy9hdWRpdC1sb2dzLnNlcnZpY2UudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0BuZXN0anMvY29tbW9uJztcbmltcG9ydCB7IFByaXNtYVNlcnZpY2UgfSBmcm9tICdzcmMvcHJvdmlkZXJzL3ByaXNtYS1jbGllbnQucHJvdmlkZXInO1xuaW1wb3J0IHtcbiAgQXVkaXRBY3Rpb24sXG4gIEV2ZW50U2V2ZXJpdHksXG4gIFN5c3RlbUV2ZW50VHlwZSxcbiAgRGF0YUNsYXNzaWZpY2F0aW9uLFxufSBmcm9tICdAcHJpc21hL2NsaWVudCc7XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBBdWRpdExvZ3NTZXJ2aWNlIHtcbiAgY29uc3RydWN0b3IocHJpdmF0ZSByZWFkb25seSBwcmlzbWE6IFByaXNtYVNlcnZpY2UpIHt9XG5cbiAgYXN5bmMgY3JlYXRlQXVkaXRMb2coZGF0YToge1xuICAgIGFjdGlvbjogQXVkaXRBY3Rpb247XG4gICAgZW50aXR5OiBzdHJpbmc7XG4gICAgZW50aXR5SWQ6IHN0cmluZztcbiAgICB1c2VySWQ/OiBzdHJpbmc7XG4gICAgdXNlclJvbGU/OiBzdHJpbmc7XG4gICAgb2xkVmFsdWVzPzogYW55O1xuICAgIG5ld1ZhbHVlcz86IGFueTtcbiAgICBkZXNjcmlwdGlvbj86IHN0cmluZztcbiAgICBtZXRhZGF0YT86IGFueTtcbiAgICBpcEFkZHJlc3M/OiBzdHJpbmc7XG4gICAgdXNlckFnZW50Pzogc3RyaW5nO1xuICAgIHJlcXVlc3RJZD86IHN0cmluZztcbiAgfSkge1xuICAgIHJldHVybiB0aGlzLnByaXNtYS5hdWRpdExvZy5jcmVhdGUoe1xuICAgICAgZGF0YSxcbiAgICAgIGluY2x1ZGU6IHtcbiAgICAgICAgdXNlcjoge1xuICAgICAgICAgIHNlbGVjdDoge1xuICAgICAgICAgICAgaWQ6IHRydWUsXG4gICAgICAgICAgICBmaXJzdE5hbWU6IHRydWUsXG4gICAgICAgICAgICBsYXN0TmFtZTogdHJ1ZSxcbiAgICAgICAgICAgIGVtYWlsOiB0cnVlLFxuICAgICAgICAgICAgcm9sZTogdHJ1ZSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgfSxcbiAgICB9KTtcbiAgfVxuXG4gIGFzeW5jIGZpbmRBdWRpdExvZ3MoXG4gICAgdXNlcklkPzogc3RyaW5nLFxuICAgIGFjdGlvbj86IEF1ZGl0QWN0aW9uLFxuICAgIGVudGl0eT86IHN0cmluZyxcbiAgICBlbnRpdHlJZD86IHN0cmluZyxcbiAgICBzdGFydERhdGU/OiBEYXRlLFxuICAgIGVuZERhdGU/OiBEYXRlLFxuICAgIGxpbWl0ID0gMTAwLFxuICApIHtcbiAgICBjb25zdCB3aGVyZTogYW55ID0ge307XG5cbiAgICBpZiAodXNlcklkKSB3aGVyZS51c2VySWQgPSB1c2VySWQ7XG4gICAgaWYgKGFjdGlvbikgd2hlcmUuYWN0aW9uID0gYWN0aW9uO1xuICAgIGlmIChlbnRpdHkpIHdoZXJlLmVudGl0eSA9IGVudGl0eTtcbiAgICBpZiAoZW50aXR5SWQpIHdoZXJlLmVudGl0eUlkID0gZW50aXR5SWQ7XG4gICAgaWYgKHN0YXJ0RGF0ZSkgd2hlcmUuY3JlYXRlZEF0ID0geyAuLi53aGVyZS5jcmVhdGVkQXQsIGd0ZTogc3RhcnREYXRlIH07XG4gICAgaWYgKGVuZERhdGUpIHdoZXJlLmNyZWF0ZWRBdCA9IHsgLi4ud2hlcmUuY3JlYXRlZEF0LCBsdGU6IGVuZERhdGUgfTtcblxuICAgIHJldHVybiB0aGlzLnByaXNtYS5hdWRpdExvZy5maW5kTWFueSh7XG4gICAgICB3aGVyZSxcbiAgICAgIGluY2x1ZGU6IHtcbiAgICAgICAgdXNlcjoge1xuICAgICAgICAgIHNlbGVjdDoge1xuICAgICAgICAgICAgaWQ6IHRydWUsXG4gICAgICAgICAgICBmaXJzdE5hbWU6IHRydWUsXG4gICAgICAgICAgICBsYXN0TmFtZTogdHJ1ZSxcbiAgICAgICAgICAgIGVtYWlsOiB0cnVlLFxuICAgICAgICAgICAgcm9sZTogdHJ1ZSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgfSxcbiAgICAgIG9yZGVyQnk6IHsgY3JlYXRlZEF0OiAnZGVzYycgfSxcbiAgICAgIHRha2U6IGxpbWl0LFxuICAgIH0pO1xuICB9XG5cbiAgYXN5bmMgY3JlYXRlU3lzdGVtRXZlbnQoZGF0YToge1xuICAgIGV2ZW50VHlwZTogU3lzdGVtRXZlbnRUeXBlO1xuICAgIHNldmVyaXR5OiBFdmVudFNldmVyaXR5O1xuICAgIHRpdGxlOiBzdHJpbmc7XG4gICAgZGVzY3JpcHRpb246IHN0cmluZztcbiAgICBjb21wb25lbnQ/OiBzdHJpbmc7XG4gICAgbWV0YWRhdGE/OiBhbnk7XG4gICAgZXJyb3JDb2RlPzogc3RyaW5nO1xuICAgIHN0YWNrVHJhY2U/OiBzdHJpbmc7XG4gIH0pIHtcbiAgICByZXR1cm4gdGhpcy5wcmlzbWEuc3lzdGVtRXZlbnQuY3JlYXRlKHtcbiAgICAgIGRhdGEsXG4gICAgfSk7XG4gIH1cblxuICBhc3luYyBmaW5kU3lzdGVtRXZlbnRzKFxuICAgIGV2ZW50VHlwZT86IFN5c3RlbUV2ZW50VHlwZSxcbiAgICBzZXZlcml0eT86IEV2ZW50U2V2ZXJpdHksXG4gICAgY29tcG9uZW50Pzogc3RyaW5nLFxuICAgIGlzUmVzb2x2ZWQ/OiBib29sZWFuLFxuICAgIHN0YXJ0RGF0ZT86IERhdGUsXG4gICAgZW5kRGF0ZT86IERhdGUsXG4gICAgbGltaXQgPSAxMDAsXG4gICkge1xuICAgIGNvbnN0IHdoZXJlOiBhbnkgPSB7fTtcblxuICAgIGlmIChldmVudFR5cGUpIHdoZXJlLmV2ZW50VHlwZSA9IGV2ZW50VHlwZTtcbiAgICBpZiAoc2V2ZXJpdHkpIHdoZXJlLnNldmVyaXR5ID0gc2V2ZXJpdHk7XG4gICAgaWYgKGNvbXBvbmVudCkgd2hlcmUuY29tcG9uZW50ID0gY29tcG9uZW50O1xuICAgIGlmIChpc1Jlc29sdmVkICE9PSB1bmRlZmluZWQpIHdoZXJlLmlzUmVzb2x2ZWQgPSBpc1Jlc29sdmVkO1xuICAgIGlmIChzdGFydERhdGUpIHdoZXJlLmNyZWF0ZWRBdCA9IHsgLi4ud2hlcmUuY3JlYXRlZEF0LCBndGU6IHN0YXJ0RGF0ZSB9O1xuICAgIGlmIChlbmREYXRlKSB3aGVyZS5jcmVhdGVkQXQgPSB7IC4uLndoZXJlLmNyZWF0ZWRBdCwgbHRlOiBlbmREYXRlIH07XG5cbiAgICByZXR1cm4gdGhpcy5wcmlzbWEuc3lzdGVtRXZlbnQuZmluZE1hbnkoe1xuICAgICAgd2hlcmUsXG4gICAgICBvcmRlckJ5OiB7IGNyZWF0ZWRBdDogJ2Rlc2MnIH0sXG4gICAgICB0YWtlOiBsaW1pdCxcbiAgICB9KTtcbiAgfVxuXG4gIGFzeW5jIHJlc29sdmVTeXN0ZW1FdmVudChpZDogc3RyaW5nLCByZXNvbHZlZEJ5OiBzdHJpbmcsIHJlc29sdXRpb246IHN0cmluZykge1xuICAgIHJldHVybiB0aGlzLnByaXNtYS5zeXN0ZW1FdmVudC51cGRhdGUoe1xuICAgICAgd2hlcmU6IHsgaWQgfSxcbiAgICAgIGRhdGE6IHtcbiAgICAgICAgaXNSZXNvbHZlZDogdHJ1ZSxcbiAgICAgICAgcmVzb2x2ZWRBdDogbmV3IERhdGUoKSxcbiAgICAgICAgcmVzb2x2ZWRCeSxcbiAgICAgICAgcmVzb2x1dGlvbixcbiAgICAgIH0sXG4gICAgfSk7XG4gIH1cblxuICBhc3luYyBjcmVhdGVEYXRhQ2hhbmdlTG9nKGRhdGE6IHtcbiAgICB0YWJsZU5hbWU6IHN0cmluZztcbiAgICByZWNvcmRJZDogc3RyaW5nO1xuICAgIG9wZXJhdGlvbjogJ0lOU0VSVCcgfCAnVVBEQVRFJyB8ICdERUxFVEUnO1xuICAgIGNoYW5nZWRGaWVsZHM/OiBzdHJpbmdbXTtcbiAgICBvbGREYXRhPzogYW55O1xuICAgIG5ld0RhdGE/OiBhbnk7XG4gICAgY2hhbmdlZEJ5Pzogc3RyaW5nO1xuICAgIHJlYXNvbj86IHN0cmluZztcbiAgICBkYXRhQ2xhc3M/OiBEYXRhQ2xhc3NpZmljYXRpb247XG4gIH0pIHtcbiAgICByZXR1cm4gdGhpcy5wcmlzbWEuZGF0YUNoYW5nZUxvZy5jcmVhdGUoe1xuICAgICAgZGF0YToge1xuICAgICAgICAuLi5kYXRhLFxuICAgICAgICBkYXRhQ2xhc3M6IGRhdGEuZGF0YUNsYXNzIHx8IERhdGFDbGFzc2lmaWNhdGlvbi5JTlRFUk5BTCxcbiAgICAgIH0sXG4gICAgfSk7XG4gIH1cblxuICBhc3luYyBmaW5kRGF0YUNoYW5nZUxvZ3MoXG4gICAgdGFibGVOYW1lPzogc3RyaW5nLFxuICAgIHJlY29yZElkPzogc3RyaW5nLFxuICAgIG9wZXJhdGlvbj86IHN0cmluZyxcbiAgICBjaGFuZ2VkQnk/OiBzdHJpbmcsXG4gICAgc3RhcnREYXRlPzogRGF0ZSxcbiAgICBlbmREYXRlPzogRGF0ZSxcbiAgICBsaW1pdCA9IDEwMCxcbiAgKSB7XG4gICAgY29uc3Qgd2hlcmU6IGFueSA9IHt9O1xuXG4gICAgaWYgKHRhYmxlTmFtZSkgd2hlcmUudGFibGVOYW1lID0gdGFibGVOYW1lO1xuICAgIGlmIChyZWNvcmRJZCkgd2hlcmUucmVjb3JkSWQgPSByZWNvcmRJZDtcbiAgICBpZiAob3BlcmF0aW9uKSB3aGVyZS5vcGVyYXRpb24gPSBvcGVyYXRpb247XG4gICAgaWYgKGNoYW5nZWRCeSkgd2hlcmUuY2hhbmdlZEJ5ID0gY2hhbmdlZEJ5O1xuICAgIGlmIChzdGFydERhdGUpIHdoZXJlLmNyZWF0ZWRBdCA9IHsgLi4ud2hlcmUuY3JlYXRlZEF0LCBndGU6IHN0YXJ0RGF0ZSB9O1xuICAgIGlmIChlbmREYXRlKSB3aGVyZS5jcmVhdGVkQXQgPSB7IC4uLndoZXJlLmNyZWF0ZWRBdCwgbHRlOiBlbmREYXRlIH07XG5cbiAgICByZXR1cm4gdGhpcy5wcmlzbWEuZGF0YUNoYW5nZUxvZy5maW5kTWFueSh7XG4gICAgICB3aGVyZSxcbiAgICAgIG9yZGVyQnk6IHsgY3JlYXRlZEF0OiAnZGVzYycgfSxcbiAgICAgIHRha2U6IGxpbWl0LFxuICAgIH0pO1xuICB9XG5cbiAgLy8gSGVscGVyIG1ldGhvZHMgZm9yIGNvbW1vbiBhdWRpdCBzY2VuYXJpb3NcblxuICBhc3luYyBsb2dVc2VyTG9naW4odXNlcklkOiBzdHJpbmcsIGlwQWRkcmVzcz86IHN0cmluZywgdXNlckFnZW50Pzogc3RyaW5nKSB7XG4gICAgcmV0dXJuIHRoaXMuY3JlYXRlQXVkaXRMb2coe1xuICAgICAgYWN0aW9uOiBBdWRpdEFjdGlvbi5VU0VSX0xPR0lOLFxuICAgICAgZW50aXR5OiAnVXNlcicsXG4gICAgICBlbnRpdHlJZDogdXNlcklkLFxuICAgICAgdXNlcklkLFxuICAgICAgZGVzY3JpcHRpb246ICdVc2VyIGxvZ2dlZCBpbicsXG4gICAgICBpcEFkZHJlc3MsXG4gICAgICB1c2VyQWdlbnQsXG4gICAgfSk7XG4gIH1cblxuICBhc3luYyBsb2dVc2VyTG9nb3V0KHVzZXJJZDogc3RyaW5nLCBpcEFkZHJlc3M/OiBzdHJpbmcsIHVzZXJBZ2VudD86IHN0cmluZykge1xuICAgIHJldHVybiB0aGlzLmNyZWF0ZUF1ZGl0TG9nKHtcbiAgICAgIGFjdGlvbjogQXVkaXRBY3Rpb24uVVNFUl9MT0dPVVQsXG4gICAgICBlbnRpdHk6ICdVc2VyJyxcbiAgICAgIGVudGl0eUlkOiB1c2VySWQsXG4gICAgICB1c2VySWQsXG4gICAgICBkZXNjcmlwdGlvbjogJ1VzZXIgbG9nZ2VkIG91dCcsXG4gICAgICBpcEFkZHJlc3MsXG4gICAgICB1c2VyQWdlbnQsXG4gICAgfSk7XG4gIH1cblxuICBhc3luYyBsb2dQcm9maWxlVXBkYXRlKFxuICAgIHVzZXJJZDogc3RyaW5nLFxuICAgIG9sZFZhbHVlczogYW55LFxuICAgIG5ld1ZhbHVlczogYW55LFxuICAgIGlwQWRkcmVzcz86IHN0cmluZyxcbiAgICB1c2VyQWdlbnQ/OiBzdHJpbmcsXG4gICkge1xuICAgIHJldHVybiB0aGlzLmNyZWF0ZUF1ZGl0TG9nKHtcbiAgICAgIGFjdGlvbjogQXVkaXRBY3Rpb24uVVNFUl9VUERBVEVfUFJPRklMRSxcbiAgICAgIGVudGl0eTogJ1VzZXInLFxuICAgICAgZW50aXR5SWQ6IHVzZXJJZCxcbiAgICAgIHVzZXJJZCxcbiAgICAgIG9sZFZhbHVlcyxcbiAgICAgIG5ld1ZhbHVlcyxcbiAgICAgIGRlc2NyaXB0aW9uOiAnVXNlciB1cGRhdGVkIHByb2ZpbGUnLFxuICAgICAgaXBBZGRyZXNzLFxuICAgICAgdXNlckFnZW50LFxuICAgIH0pO1xuICB9XG5cbiAgYXN5bmMgbG9nVGhlcmFwaXN0QXBwbGljYXRpb25TdWJtaXQoXG4gICAgdXNlcklkOiBzdHJpbmcsXG4gICAgYXBwbGljYXRpb25EYXRhOiBhbnksXG4gICAgaXBBZGRyZXNzPzogc3RyaW5nLFxuICAgIHVzZXJBZ2VudD86IHN0cmluZyxcbiAgKSB7XG4gICAgcmV0dXJuIHRoaXMuY3JlYXRlQXVkaXRMb2coe1xuICAgICAgYWN0aW9uOiBBdWRpdEFjdGlvbi5USEVSQVBJU1RfQVBQTElDQVRJT05fU1VCTUlULFxuICAgICAgZW50aXR5OiAnVGhlcmFwaXN0JyxcbiAgICAgIGVudGl0eUlkOiB1c2VySWQsXG4gICAgICB1c2VySWQsXG4gICAgICBuZXdWYWx1ZXM6IGFwcGxpY2F0aW9uRGF0YSxcbiAgICAgIGRlc2NyaXB0aW9uOiAnVGhlcmFwaXN0IGFwcGxpY2F0aW9uIHN1Ym1pdHRlZCcsXG4gICAgICBpcEFkZHJlc3MsXG4gICAgICB1c2VyQWdlbnQsXG4gICAgfSk7XG4gIH1cblxuICBhc3luYyBsb2dUaGVyYXBpc3RBcHBsaWNhdGlvblJldmlldyhcbiAgICB0aGVyYXBpc3RJZDogc3RyaW5nLFxuICAgIHJldmlld2VkQnk6IHN0cmluZyxcbiAgICBzdGF0dXM6ICdhcHByb3ZlZCcgfCAncmVqZWN0ZWQnLFxuICAgIG9sZFN0YXR1czogc3RyaW5nLFxuICAgIGlwQWRkcmVzcz86IHN0cmluZyxcbiAgICB1c2VyQWdlbnQ/OiBzdHJpbmcsXG4gICkge1xuICAgIGNvbnN0IGFjdGlvbiA9XG4gICAgICBzdGF0dXMgPT09ICdhcHByb3ZlZCdcbiAgICAgICAgPyBBdWRpdEFjdGlvbi5USEVSQVBJU1RfQVBQTElDQVRJT05fQVBQUk9WRVxuICAgICAgICA6IEF1ZGl0QWN0aW9uLlRIRVJBUElTVF9BUFBMSUNBVElPTl9SRUpFQ1Q7XG5cbiAgICByZXR1cm4gdGhpcy5jcmVhdGVBdWRpdExvZyh7XG4gICAgICBhY3Rpb24sXG4gICAgICBlbnRpdHk6ICdUaGVyYXBpc3QnLFxuICAgICAgZW50aXR5SWQ6IHRoZXJhcGlzdElkLFxuICAgICAgdXNlcklkOiByZXZpZXdlZEJ5LFxuICAgICAgb2xkVmFsdWVzOiB7IHN0YXR1czogb2xkU3RhdHVzIH0sXG4gICAgICBuZXdWYWx1ZXM6IHsgc3RhdHVzIH0sXG4gICAgICBkZXNjcmlwdGlvbjogYFRoZXJhcGlzdCBhcHBsaWNhdGlvbiAke3N0YXR1c31gLFxuICAgICAgaXBBZGRyZXNzLFxuICAgICAgdXNlckFnZW50LFxuICAgIH0pO1xuICB9XG5cbiAgYXN5bmMgbG9nTWVldGluZ0NyZWF0ZShcbiAgICBtZWV0aW5nSWQ6IHN0cmluZyxcbiAgICBjcmVhdGVkQnk6IHN0cmluZyxcbiAgICBtZWV0aW5nRGF0YTogYW55LFxuICAgIGlwQWRkcmVzcz86IHN0cmluZyxcbiAgICB1c2VyQWdlbnQ/OiBzdHJpbmcsXG4gICkge1xuICAgIHJldHVybiB0aGlzLmNyZWF0ZUF1ZGl0TG9nKHtcbiAgICAgIGFjdGlvbjogQXVkaXRBY3Rpb24uTUVFVElOR19DUkVBVEUsXG4gICAgICBlbnRpdHk6ICdNZWV0aW5nJyxcbiAgICAgIGVudGl0eUlkOiBtZWV0aW5nSWQsXG4gICAgICB1c2VySWQ6IGNyZWF0ZWRCeSxcbiAgICAgIG5ld1ZhbHVlczogbWVldGluZ0RhdGEsXG4gICAgICBkZXNjcmlwdGlvbjogJ01lZXRpbmcgY3JlYXRlZCcsXG4gICAgICBpcEFkZHJlc3MsXG4gICAgICB1c2VyQWdlbnQsXG4gICAgfSk7XG4gIH1cblxuICBhc3luYyBsb2dNZWV0aW5nVXBkYXRlKFxuICAgIG1lZXRpbmdJZDogc3RyaW5nLFxuICAgIHVwZGF0ZWRCeTogc3RyaW5nLFxuICAgIG9sZFZhbHVlczogYW55LFxuICAgIG5ld1ZhbHVlczogYW55LFxuICAgIGlwQWRkcmVzcz86IHN0cmluZyxcbiAgICB1c2VyQWdlbnQ/OiBzdHJpbmcsXG4gICkge1xuICAgIHJldHVybiB0aGlzLmNyZWF0ZUF1ZGl0TG9nKHtcbiAgICAgIGFjdGlvbjogQXVkaXRBY3Rpb24uTUVFVElOR19VUERBVEUsXG4gICAgICBlbnRpdHk6ICdNZWV0aW5nJyxcbiAgICAgIGVudGl0eUlkOiBtZWV0aW5nSWQsXG4gICAgICB1c2VySWQ6IHVwZGF0ZWRCeSxcbiAgICAgIG9sZFZhbHVlcyxcbiAgICAgIG5ld1ZhbHVlcyxcbiAgICAgIGRlc2NyaXB0aW9uOiAnTWVldGluZyB1cGRhdGVkJyxcbiAgICAgIGlwQWRkcmVzcyxcbiAgICAgIHVzZXJBZ2VudCxcbiAgICB9KTtcbiAgfVxuXG4gIGFzeW5jIGxvZ1N5c3RlbUVycm9yKGNvbXBvbmVudDogc3RyaW5nLCBlcnJvcjogRXJyb3IsIG1ldGFkYXRhPzogYW55KSB7XG4gICAgcmV0dXJuIHRoaXMuY3JlYXRlU3lzdGVtRXZlbnQoe1xuICAgICAgZXZlbnRUeXBlOiBTeXN0ZW1FdmVudFR5cGUuVEhJUkRfUEFSVFlfQVBJX0VSUk9SLFxuICAgICAgc2V2ZXJpdHk6IEV2ZW50U2V2ZXJpdHkuRVJST1IsXG4gICAgICB0aXRsZTogYEVycm9yIGluICR7Y29tcG9uZW50fWAsXG4gICAgICBkZXNjcmlwdGlvbjogZXJyb3IubWVzc2FnZSxcbiAgICAgIGNvbXBvbmVudCxcbiAgICAgIG1ldGFkYXRhOiB7XG4gICAgICAgIC4uLm1ldGFkYXRhLFxuICAgICAgICBlcnJvck5hbWU6IGVycm9yLm5hbWUsXG4gICAgICB9LFxuICAgICAgc3RhY2tUcmFjZTogZXJyb3Iuc3RhY2ssXG4gICAgfSk7XG4gIH1cblxuICBhc3luYyBnZXRBdWRpdFN0YXRpc3RpY3Moc3RhcnREYXRlPzogRGF0ZSwgZW5kRGF0ZT86IERhdGUpIHtcbiAgICBjb25zdCB3aGVyZTogYW55ID0ge307XG4gICAgaWYgKHN0YXJ0RGF0ZSkgd2hlcmUuY3JlYXRlZEF0ID0geyAuLi53aGVyZS5jcmVhdGVkQXQsIGd0ZTogc3RhcnREYXRlIH07XG4gICAgaWYgKGVuZERhdGUpIHdoZXJlLmNyZWF0ZWRBdCA9IHsgLi4ud2hlcmUuY3JlYXRlZEF0LCBsdGU6IGVuZERhdGUgfTtcblxuICAgIGNvbnN0IFt0b3RhbExvZ3MsIGFjdGlvblN0YXRzLCBlbnRpdHlTdGF0cywgdXNlclN0YXRzXSA9IGF3YWl0IFByb21pc2UuYWxsKFtcbiAgICAgIHRoaXMucHJpc21hLmF1ZGl0TG9nLmNvdW50KHsgd2hlcmUgfSksXG4gICAgICB0aGlzLnByaXNtYS5hdWRpdExvZy5ncm91cEJ5KHtcbiAgICAgICAgYnk6IFsnYWN0aW9uJ10sXG4gICAgICAgIHdoZXJlLFxuICAgICAgICBfY291bnQ6IHsgYWN0aW9uOiB0cnVlIH0sXG4gICAgICB9KSxcbiAgICAgIHRoaXMucHJpc21hLmF1ZGl0TG9nLmdyb3VwQnkoe1xuICAgICAgICBieTogWydlbnRpdHknXSxcbiAgICAgICAgd2hlcmUsXG4gICAgICAgIF9jb3VudDogeyBlbnRpdHk6IHRydWUgfSxcbiAgICAgIH0pLFxuICAgICAgdGhpcy5wcmlzbWEuYXVkaXRMb2cuZ3JvdXBCeSh7XG4gICAgICAgIGJ5OiBbJ3VzZXJJZCddLFxuICAgICAgICB3aGVyZTogeyAuLi53aGVyZSwgdXNlcklkOiB7IG5vdDogbnVsbCB9IH0sXG4gICAgICAgIF9jb3VudDogeyB1c2VySWQ6IHRydWUgfSxcbiAgICAgICAgdGFrZTogMTAsXG4gICAgICAgIG9yZGVyQnk6IHsgX2NvdW50OiB7IHVzZXJJZDogJ2Rlc2MnIH0gfSxcbiAgICAgIH0pLFxuICAgIF0pO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIHRvdGFsTG9ncyxcbiAgICAgIGFjdGlvblN0YXRzLFxuICAgICAgZW50aXR5U3RhdHMsXG4gICAgICB0b3BVc2VyczogdXNlclN0YXRzLFxuICAgIH07XG4gIH1cbn1cbiJdLCJ2ZXJzaW9uIjozfQ==