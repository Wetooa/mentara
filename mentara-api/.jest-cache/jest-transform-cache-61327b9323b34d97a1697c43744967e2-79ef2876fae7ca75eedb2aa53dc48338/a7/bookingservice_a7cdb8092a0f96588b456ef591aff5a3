6864264228e4dd3fb2d0fc0216a438ba
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var BookingService_1;
var _a, _b, _c, _d, _e, _f;
Object.defineProperty(exports, "__esModule", { value: true });
exports.BookingService = void 0;
const common_1 = require("@nestjs/common");
const prisma_client_provider_1 = require("../providers/prisma-client.provider");
const event_bus_service_1 = require("../common/events/event-bus.service");
const slot_generator_service_1 = require("./services/slot-generator.service");
const conflict_detection_service_1 = require("./services/conflict-detection.service");
const availability_validator_service_1 = require("./services/availability-validator.service");
const billing_service_1 = require("../billing/billing.service");
const booking_events_1 = require("../common/events/booking-events");
let BookingService = BookingService_1 = class BookingService {
    prisma;
    eventBus;
    slotGenerator;
    conflictDetection;
    availabilityValidator;
    billingService;
    logger = new common_1.Logger(BookingService_1.name);
    constructor(prisma, eventBus, slotGenerator, conflictDetection, availabilityValidator, billingService) {
        this.prisma = prisma;
        this.eventBus = eventBus;
        this.slotGenerator = slotGenerator;
        this.conflictDetection = conflictDetection;
        this.availabilityValidator = availabilityValidator;
        this.billingService = billingService;
    }
    // Meeting Management
    async createMeeting(createMeetingDto, clientId) {
        const { startTime, therapistId, duration } = createMeetingDto;
        const startTimeDate = new Date(startTime || createMeetingDto.dateTime);
        const endTimeDate = new Date(startTimeDate.getTime() + duration * 60000);
        // Use database transaction to prevent race conditions
        return this.prisma.$transaction(async (tx) => {
            // First, acquire locks on both therapist and client schedules
            // This prevents concurrent bookings from interfering
            const [therapistLock, clientLock] = await Promise.all([
                tx.user.findUnique({
                    where: { id: therapistId },
                    select: { id: true },
                }),
                tx.user.findUnique({
                    where: { id: clientId },
                    select: { id: true },
                }),
            ]);
            if (!therapistLock || !clientLock) {
                throw new common_1.BadRequestException('Therapist or client not found');
            }
            // Check for conflicts within transaction (atomic operation)
            const conflictingMeetings = await tx.meeting.findMany({
                where: {
                    OR: [
                        {
                            therapistId,
                            startTime: { lt: endTimeDate },
                            endTime: { gt: startTimeDate },
                            status: { in: ['SCHEDULED', 'CONFIRMED', 'IN_PROGRESS'] },
                        },
                        {
                            clientId,
                            startTime: { lt: endTimeDate },
                            endTime: { gt: startTimeDate },
                            status: { in: ['SCHEDULED', 'CONFIRMED', 'IN_PROGRESS'] },
                        },
                    ],
                },
            });
            if (conflictingMeetings.length > 0) {
                throw new common_1.BadRequestException(`Schedule conflict detected: ${conflictingMeetings.length} conflicting meetings found`);
            }
            // Validate therapist availability using the validator service
            await this.availabilityValidator.validateTherapistAvailabilityWithTransaction(therapistId, startTimeDate, duration, tx);
            // Create the meeting within the transaction
            const meeting = await tx.meeting.create({
                data: {
                    ...createMeetingDto,
                    startTime: startTimeDate,
                    endTime: endTimeDate,
                    status: 'SCHEDULED',
                    clientId,
                },
                include: {
                    client: {
                        select: {
                            user: {
                                select: {
                                    firstName: true,
                                    lastName: true,
                                    email: true,
                                },
                            },
                        },
                    },
                    therapist: {
                        select: {
                            user: {
                                select: {
                                    firstName: true,
                                    lastName: true,
                                    email: true,
                                },
                            },
                        },
                    },
                },
            });
            // NOTE: Payment processing now handled separately when client pays for session
            // The meeting is created first, then payment is processed via billing controller
            // This allows for better payment flow and error handling
            // Publish appointment booked event
            await this.eventBus.emit(new booking_events_1.AppointmentBookedEvent({
                appointmentId: meeting.id,
                clientId: meeting.clientId,
                therapistId: meeting.therapistId,
                startTime: meeting.startTime,
                meetingType: meeting.meetingType,
                duration: meeting.duration,
                title: meeting.title || 'Therapy Session',
                description: meeting.description || undefined,
                isInitialConsultation: false,
            }));
            // Transform the response to match frontend expectations
            return {
                ...meeting,
                dateTime: meeting.startTime, // Map startTime to dateTime for frontend compatibility
                therapistName: meeting.therapist?.user
                    ? `${meeting.therapist.user.firstName} ${meeting.therapist.user.lastName}`
                    : 'Unknown Therapist',
            };
        }, {
            isolationLevel: 'Serializable', // Highest isolation level to prevent race conditions
            timeout: 10000, // 10 second timeout
            maxWait: 5000, // Max wait time for transaction lock
        });
    }
    async getMeetings(userId, role, queryOptions) {
        try {
            const where = role === 'therapist' ? { therapistId: userId } : { clientId: userId };
            // Handle status filtering
            if (queryOptions?.status) {
                const statusValues = queryOptions.status
                    .split(',')
                    .map((s) => s.trim().toUpperCase());
                where.status = { in: statusValues };
            }
            const meetings = await this.prisma.meeting.findMany({
                where,
                include: {
                    client: {
                        select: {
                            user: {
                                select: {
                                    firstName: true,
                                    lastName: true,
                                    email: true,
                                },
                            },
                        },
                    },
                    therapist: {
                        select: {
                            user: {
                                select: {
                                    firstName: true,
                                    lastName: true,
                                    email: true,
                                },
                            },
                        },
                    },
                },
                orderBy: { startTime: 'desc' },
                take: queryOptions?.limit,
                skip: queryOptions?.offset,
            });
            // Transform the response to match frontend expectations
            return meetings.map((meeting) => ({
                ...meeting,
                dateTime: meeting.startTime, // Map startTime to dateTime for frontend compatibility
                therapistName: meeting.therapist?.user
                    ? `${meeting.therapist.user.firstName} ${meeting.therapist.user.lastName}`
                    : 'Unknown Therapist',
            }));
        }
        catch (error) {
            throw new common_1.BadRequestException(error instanceof Error ? error.message : String(error));
        }
    }
    async getMeeting(id, userId, role) {
        try {
            const meeting = await this.prisma.meeting.findUnique({
                where: { id },
                include: {
                    client: {
                        select: {
                            user: {
                                select: {
                                    firstName: true,
                                    lastName: true,
                                    email: true,
                                },
                            },
                        },
                    },
                    therapist: {
                        select: {
                            user: {
                                select: {
                                    firstName: true,
                                    lastName: true,
                                    email: true,
                                },
                            },
                        },
                    },
                },
            });
            if (!meeting) {
                throw new common_1.NotFoundException('Meeting not found');
            }
            // Verify user has access to this meeting
            if (role === 'therapist' && meeting.therapistId !== userId) {
                throw new common_1.ForbiddenException('Access denied');
            }
            if (role === 'client' && meeting.clientId !== userId) {
                throw new common_1.ForbiddenException('Access denied');
            }
            // Transform the response to match frontend expectations
            return {
                ...meeting,
                dateTime: meeting.startTime, // Map startTime to dateTime for frontend compatibility
                therapistName: meeting.therapist?.user
                    ? `${meeting.therapist.user.firstName} ${meeting.therapist.user.lastName}`
                    : 'Unknown Therapist',
            };
        }
        catch (error) {
            throw new common_1.BadRequestException(error instanceof Error ? error.message : String(error));
        }
    }
    async updateMeeting(id, updateMeetingDto, userId, role) {
        try {
            const meeting = await this.getMeeting(id, userId, role);
            // Only allow updates if meeting is not completed or cancelled
            if (['COMPLETED', 'CANCELLED'].includes(meeting.status)) {
                throw new common_1.BadRequestException('Cannot update completed or cancelled meetings');
            }
            // If updating time, validate the new schedule
            if (updateMeetingDto.startTime || updateMeetingDto.duration) {
                const newStartTime = updateMeetingDto.startTime
                    ? new Date(updateMeetingDto.startTime)
                    : meeting.startTime;
                const newDuration = updateMeetingDto.duration || meeting.duration;
                // Check for conflicts with the update
                const conflicts = await this.conflictDetection.checkUpdateConflicts(id, meeting.therapistId, meeting.clientId, newStartTime, newDuration);
                if (conflicts.hasConflict) {
                    throw new common_1.BadRequestException(`Schedule update would cause conflicts: ${conflicts.conflictingMeetings.length} conflicting meetings found`);
                }
                // Validate therapist availability for new time
                if (updateMeetingDto.startTime) {
                    await this.availabilityValidator.validateTherapistAvailability(meeting.therapistId, newStartTime, newDuration);
                }
            }
            const updatedMeeting = await this.prisma.meeting.update({
                where: { id },
                data: {
                    title: updateMeetingDto.title,
                    description: updateMeetingDto.description,
                    startTime: updateMeetingDto.startTime,
                    duration: updateMeetingDto.duration,
                    meetingType: updateMeetingDto.meetingType,
                    meetingUrl: updateMeetingDto.meetingUrl,
                    ...(updateMeetingDto.status && {
                        status: updateMeetingDto.status,
                    }),
                },
                include: {
                    client: {
                        select: {
                            user: {
                                select: {
                                    firstName: true,
                                    lastName: true,
                                    email: true,
                                },
                            },
                        },
                    },
                    therapist: {
                        select: {
                            user: {
                                select: {
                                    firstName: true,
                                    lastName: true,
                                    email: true,
                                },
                            },
                        },
                    },
                },
            });
            // Publish appropriate events
            if (updateMeetingDto.status === 'completed') {
                await this.eventBus.emit(new booking_events_1.AppointmentCompletedEvent({
                    appointmentId: updatedMeeting.id,
                    clientId: updatedMeeting.clientId,
                    therapistId: updatedMeeting.therapistId,
                    completedAt: new Date(),
                    duration: updatedMeeting.duration,
                    sessionNotes: updateMeetingDto.description || '',
                    attendanceStatus: 'ATTENDED',
                }));
            }
            else if (updateMeetingDto.startTime &&
                new Date(updateMeetingDto.startTime).getTime() !==
                    meeting.startTime.getTime()) {
                await this.eventBus.emit(new booking_events_1.AppointmentRescheduledEvent({
                    appointmentId: updatedMeeting.id,
                    clientId: updatedMeeting.clientId,
                    therapistId: updatedMeeting.therapistId,
                    rescheduledBy: userId,
                    originalStartTime: meeting.startTime,
                    newStartTime: new Date(updateMeetingDto.startTime),
                    rescheduleReason: `Rescheduled by ${role}`,
                }));
            }
            return updatedMeeting;
        }
        catch (error) {
            throw new common_1.BadRequestException(error instanceof Error ? error.message : String(error));
        }
    }
    async cancelMeeting(id, userId, role) {
        try {
            const meeting = await this.getMeeting(id, userId, role);
            if (meeting.status === 'CANCELLED') {
                throw new common_1.BadRequestException('Meeting is already cancelled');
            }
            if (meeting.status === 'COMPLETED') {
                throw new common_1.BadRequestException('Cannot cancel completed meetings');
            }
            const cancelledMeeting = await this.prisma.meeting.update({
                where: { id },
                data: { status: 'CANCELLED' },
                include: {
                    client: {
                        select: {
                            user: {
                                select: {
                                    firstName: true,
                                    lastName: true,
                                    email: true,
                                },
                            },
                        },
                    },
                    therapist: {
                        select: {
                            user: {
                                select: {
                                    firstName: true,
                                    lastName: true,
                                    email: true,
                                },
                            },
                        },
                    },
                },
            });
            // Calculate cancellation notice
            const cancellationNotice = Math.floor((meeting.startTime.getTime() - Date.now()) / (1000 * 60 * 60));
            // Handle payment refund for cancelled sessions
            try {
                // Find payment record associated with this meeting using the updated API
                const payments = await this.billingService.getUserPayments(userId, {
                    limit: 100,
                });
                const meetingPayment = payments.find((p) => p.meetingId === meeting.id);
                if (meetingPayment && cancellationNotice >= 24) {
                    // 24-hour cancellation policy
                    // NOTE: Refund logic would need to be implemented in billing service
                    // For now, we'll emit an event that a refund is needed
                    this.logger.log(`Refund needed for cancelled session ${meeting.id} - ${cancellationNotice}h notice`);
                    // TODO: Implement refund processing in billing service
                }
            }
            catch (refundError) {
                // Log refund error but don't fail the cancellation
                console.error('Failed to process refund for cancelled meeting:', refundError);
            }
            // Publish cancellation event
            await this.eventBus.emit(new booking_events_1.AppointmentCancelledEvent({
                appointmentId: cancelledMeeting.id,
                clientId: cancelledMeeting.clientId,
                therapistId: cancelledMeeting.therapistId,
                cancelledBy: userId,
                cancellationReason: role === 'client'
                    ? 'Cancelled by client'
                    : 'Cancelled by therapist',
                originalStartTime: meeting.startTime,
                cancelledAt: new Date(),
                cancellationNotice: Math.max(0, cancellationNotice),
            }));
            return cancelledMeeting;
        }
        catch (error) {
            throw new common_1.BadRequestException(error instanceof Error ? error.message : String(error));
        }
    }
    // Availability Management
    async createAvailability(createAvailabilityDto, therapistId) {
        try {
            const { dayOfWeek, startTime, endTime, notes } = createAvailabilityDto;
            // Validate using our new service
            await this.availabilityValidator.validateAvailabilityCreation({
                therapistId,
                dayOfWeek,
                startTime,
                endTime,
            });
            return this.prisma.therapistAvailability.create({
                data: {
                    therapistId,
                    dayOfWeek: dayOfWeek.toString(),
                    startTime,
                    endTime,
                    notes,
                },
            });
        }
        catch (error) {
            throw new common_1.BadRequestException(error instanceof Error ? error.message : String(error));
        }
    }
    async getAvailability(therapistId) {
        try {
            return await this.prisma.therapistAvailability.findMany({
                where: { therapistId },
                orderBy: [{ dayOfWeek: 'asc' }, { startTime: 'asc' }],
            });
        }
        catch (error) {
            throw new common_1.BadRequestException(error instanceof Error ? error.message : String(error));
        }
    }
    async updateAvailability(id, updateAvailabilityDto, therapistId) {
        try {
            const availability = await this.prisma.therapistAvailability.findFirst({
                where: { id, therapistId },
            });
            if (!availability) {
                throw new common_1.NotFoundException('Availability slot not found');
            }
            // Convert dayOfWeek to string if present
            const { dayOfWeek, ...rest } = updateAvailabilityDto;
            const updateData = {
                ...rest,
                ...(dayOfWeek !== undefined && {
                    dayOfWeek: dayOfWeek.toString(),
                }),
            };
            return this.prisma.therapistAvailability.update({
                where: { id },
                data: updateData,
            });
        }
        catch (error) {
            throw new common_1.BadRequestException(error instanceof Error ? error.message : String(error));
        }
    }
    async deleteAvailability(id, therapistId) {
        try {
            const availability = await this.prisma.therapistAvailability.findFirst({
                where: { id, therapistId },
            });
            if (!availability) {
                throw new common_1.NotFoundException('Availability slot not found');
            }
            return this.prisma.therapistAvailability.delete({
                where: { id },
            });
        }
        catch (error) {
            throw new common_1.BadRequestException(error instanceof Error ? error.message : String(error));
        }
    }
    // Simplified slot generation using our new service
    async getAvailableSlots(therapistId, date) {
        try {
            return await this.slotGenerator.generateAvailableSlots(therapistId, date);
        }
        catch (error) {
            throw new common_1.BadRequestException(error instanceof Error ? error.message : String(error));
        }
    }
    // Duration management
    getDurations() {
        return [
            { id: '30', name: '30 minutes', duration: 30 },
            { id: '60', name: '60 minutes', duration: 60 },
            { id: '90', name: '90 minutes', duration: 90 },
            { id: '120', name: '120 minutes', duration: 120 },
        ];
    }
    // Enhanced validation method using our services
    async validateMeetingTime(therapistId, clientId, startTime, duration) {
        const startTimeDate = new Date(startTime);
        await this.availabilityValidator.validateMeetingCreation({
            therapistId,
            clientId,
            startTime: startTimeDate,
            duration,
        });
        await this.conflictDetection.validateNoConflicts(therapistId, clientId, startTimeDate, duration);
        return true;
    }
};
exports.BookingService = BookingService;
exports.BookingService = BookingService = BookingService_1 = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [typeof (_a = typeof prisma_client_provider_1.PrismaService !== "undefined" && prisma_client_provider_1.PrismaService) === "function" ? _a : Object, typeof (_b = typeof event_bus_service_1.EventBusService !== "undefined" && event_bus_service_1.EventBusService) === "function" ? _b : Object, typeof (_c = typeof slot_generator_service_1.SlotGeneratorService !== "undefined" && slot_generator_service_1.SlotGeneratorService) === "function" ? _c : Object, typeof (_d = typeof conflict_detection_service_1.ConflictDetectionService !== "undefined" && conflict_detection_service_1.ConflictDetectionService) === "function" ? _d : Object, typeof (_e = typeof availability_validator_service_1.AvailabilityValidatorService !== "undefined" && availability_validator_service_1.AvailabilityValidatorService) === "function" ? _e : Object, typeof (_f = typeof billing_service_1.BillingService !== "undefined" && billing_service_1.BillingService) === "function" ? _f : Object])
], BookingService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL2Jvb2tpbmcvYm9va2luZy5zZXJ2aWNlLnRzIiwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7O0FBQUEsMkNBTXdCO0FBQ3hCLGdGQUFvRTtBQVFwRSwwRUFBcUU7QUFDckUsOEVBQXlFO0FBQ3pFLHNGQUFpRjtBQUNqRiw4RkFBeUY7QUFDekYsZ0VBQTREO0FBQzVELG9FQUt5QztBQUdsQyxJQUFNLGNBQWMsc0JBQXBCLE1BQU0sY0FBYztJQUlOO0lBQ0E7SUFDQTtJQUNBO0lBQ0E7SUFDQTtJQVJGLE1BQU0sR0FBRyxJQUFJLGVBQU0sQ0FBQyxnQkFBYyxDQUFDLElBQUksQ0FBQyxDQUFDO0lBRTFELFlBQ21CLE1BQXFCLEVBQ3JCLFFBQXlCLEVBQ3pCLGFBQW1DLEVBQ25DLGlCQUEyQyxFQUMzQyxxQkFBbUQsRUFDbkQsY0FBOEI7UUFMOUIsV0FBTSxHQUFOLE1BQU0sQ0FBZTtRQUNyQixhQUFRLEdBQVIsUUFBUSxDQUFpQjtRQUN6QixrQkFBYSxHQUFiLGFBQWEsQ0FBc0I7UUFDbkMsc0JBQWlCLEdBQWpCLGlCQUFpQixDQUEwQjtRQUMzQywwQkFBcUIsR0FBckIscUJBQXFCLENBQThCO1FBQ25ELG1CQUFjLEdBQWQsY0FBYyxDQUFnQjtJQUM5QyxDQUFDO0lBRUoscUJBQXFCO0lBQ3JCLEtBQUssQ0FBQyxhQUFhLENBQUMsZ0JBQWtDLEVBQUUsUUFBZ0I7UUFDdEUsTUFBTSxFQUFFLFNBQVMsRUFBRSxXQUFXLEVBQUUsUUFBUSxFQUFFLEdBQUcsZ0JBQWdCLENBQUM7UUFDOUQsTUFBTSxhQUFhLEdBQUcsSUFBSSxJQUFJLENBQUMsU0FBUyxJQUFJLGdCQUFnQixDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQ3ZFLE1BQU0sV0FBVyxHQUFHLElBQUksSUFBSSxDQUFDLGFBQWEsQ0FBQyxPQUFPLEVBQUUsR0FBRyxRQUFRLEdBQUcsS0FBSyxDQUFDLENBQUM7UUFFekUsc0RBQXNE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U0FBUyxDQUFDLENBQUM7UUFFMUMsTUFBTSxJQUFJLENBQUMscUJBQXFCLENBQUMsdUJBQXVCLENBQUM7WUFDdkQsV0FBVztZQUNYLFFBQVE7WUFDUixTQUFTLEVBQUUsYUFBYTtZQUN4QixRQUFRO1NBQ1QsQ0FBQyxDQUFDO1FBRUgsTUFBTSxJQUFJLENBQUMsaUJBQWlCLENBQUMsbUJBQW1CLENBQzlDLFdBQVcsRUFDWCxRQUFRLEVBQ1IsYUFBYSxFQUNiLFFBQVEsQ0FDVCxDQUFDO1FBRUYsT0FBTyxJQUFJLENBQUM7SUFDZCxDQUFDO0NBQ0YsQ0FBQTtBQTluQlksd0NBQWM7eUJBQWQsY0FBYztJQUQxQixJQUFBLG1CQUFVLEdBQUU7eURBS2dCLHNDQUFhLG9CQUFiLHNDQUFhLG9EQUNYLG1DQUFlLG9CQUFmLG1DQUFlLG9EQUNWLDZDQUFvQixvQkFBcEIsNkNBQW9CLG9EQUNoQixxREFBd0Isb0JBQXhCLHFEQUF3QixvREFDcEIsNkRBQTRCLG9CQUE1Qiw2REFBNEIsb0RBQ25DLGdDQUFjLG9CQUFkLGdDQUFjO0dBVHRDLGNBQWMsQ0E4bkIxQiIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvaG9tZS93ZXRvb2EvRG9jdW1lbnRzL2NvZGUvcHJvamVjdHMvbWVudGFyYS9tZW50YXJhLWFwaS9zcmMvYm9va2luZy9ib29raW5nLnNlcnZpY2UudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgSW5qZWN0YWJsZSxcbiAgQmFkUmVxdWVzdEV4Y2VwdGlvbixcbiAgTm90Rm91bmRFeGNlcHRpb24sXG4gIEZvcmJpZGRlbkV4Y2VwdGlvbixcbiAgTG9nZ2VyLFxufSBmcm9tICdAbmVzdGpzL2NvbW1vbic7XG5pbXBvcnQgeyBQcmlzbWFTZXJ2aWNlIH0gZnJvbSAnLi4vcHJvdmlkZXJzL3ByaXNtYS1jbGllbnQucHJvdmlkZXInO1xuaW1wb3J0IHsgTWVldGluZ1N0YXR1cyB9IGZyb20gJ0BwcmlzbWEvY2xpZW50JztcbmltcG9ydCB0eXBlIHtcbiAgTWVldGluZ0NyZWF0ZUR0byxcbiAgTWVldGluZ1VwZGF0ZUR0byxcbiAgVGhlcmFwaXN0QXZhaWxhYmlsaXR5Q3JlYXRlRHRvLFxuICBUaGVyYXBpc3RBdmFpbGFiaWxpdHlVcGRhdGVEdG8sXG59IGZyb20gJy4vdHlwZXMnO1xuaW1wb3J0IHsgRXZlbnRCdXNTZXJ2aWNlIH0gZnJvbSAnLi4vY29tbW9uL2V2ZW50cy9ldmVudC1idXMuc2VydmljZSc7XG5pbXBvcnQgeyBTbG90R2VuZXJhdG9yU2VydmljZSB9IGZyb20gJy4vc2VydmljZXMvc2xvdC1nZW5lcmF0b3Iuc2VydmljZSc7XG5pbXBvcnQgeyBDb25mbGljdERldGVjdGlvblNlcnZpY2UgfSBmcm9tICcuL3NlcnZpY2VzL2NvbmZsaWN0LWRldGVjdGlvbi5zZXJ2aWNlJztcbmltcG9ydCB7IEF2YWlsYWJpbGl0eVZhbGlkYXRvclNlcnZpY2UgfSBmcm9tICcuL3NlcnZpY2VzL2F2YWlsYWJpbGl0eS12YWxpZGF0b3Iuc2VydmljZSc7XG5pbXBvcnQgeyBCaWxsaW5nU2VydmljZSB9IGZyb20gJy4uL2JpbGxpbmcvYmlsbGluZy5zZXJ2aWNlJztcbmltcG9ydCB7XG4gIEFwcG9pbnRtZW50Qm9va2VkRXZlbnQsXG4gIEFwcG9pbnRtZW50Q2FuY2VsbGVkRXZlbnQsXG4gIEFwcG9pbnRtZW50Q29tcGxldGVkRXZlbnQsXG4gIEFwcG9pbnRtZW50UmVzY2hlZHVsZWRFdmVudCxcbn0gZnJvbSAnLi4vY29tbW9uL2V2ZW50cy9ib29raW5nLWV2ZW50cyc7XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBCb29raW5nU2VydmljZSB7XG4gIHByaXZhdGUgcmVhZG9ubHkgbG9nZ2VyID0gbmV3IExvZ2dlcihCb29raW5nU2VydmljZS5uYW1lKTtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHJlYWRvbmx5IHByaXNtYTogUHJpc21hU2VydmljZSxcbiAgICBwcml2YXRlIHJlYWRvbmx5IGV2ZW50QnVzOiBFdmVudEJ1c1NlcnZpY2UsXG4gICAgcHJpdmF0ZSByZWFkb25seSBzbG90R2VuZXJhdG9yOiBTbG90R2VuZXJhdG9yU2VydmljZSxcbiAgICBwcml2YXRlIHJlYWRvbmx5IGNvbmZsaWN0RGV0ZWN0aW9uOiBDb25mbGljdERldGVjdGlvblNlcnZpY2UsXG4gICAgcHJpdmF0ZSByZWFkb25seSBhdmFpbGFiaWxpdHlWYWxpZGF0b3I6IEF2YWlsYWJpbGl0eVZhbGlkYXRvclNlcnZpY2UsXG4gICAgcHJpdmF0ZSByZWFkb25seSBiaWxsaW5nU2VydmljZTogQmlsbGluZ1NlcnZpY2UsXG4gICkge31cblxuICAvLyBNZWV0aW5nIE1hbmFnZW1lbnRcbiAgYXN5bmMgY3JlYXRlTWVldGluZyhjcmVhdGVNZWV0aW5nRHRvOiBNZWV0aW5nQ3JlYXRlRHRvLCBjbGllbnRJZDogc3RyaW5nKSB7XG4gICAgY29uc3QgeyBzdGFydFRpbWUsIHRoZXJhcGlzdElkLCBkdXJhdGlvbiB9ID0gY3JlYXRlTWVldGluZ0R0bztcbiAgICBjb25zdCBzdGFydFRpbWVEYXRlID0gbmV3IERhdGUoc3RhcnRUaW1lIHx8IGNyZWF0ZU1lZXRpbmdEdG8uZGF0ZVRpbWUpO1xuICAgIGNvbnN0IGVuZFRpbWVEYXRlID0gbmV3IERhdGUoc3RhcnRUaW1lRGF0ZS5nZXRUaW1lKCkgKyBkdXJhdGlvbiAqIDYwMDAwKTtcblxuICAgIC8vIFVzZSBkYXRhYmFzZSB0cmFuc2FjdGlvbiB0byBwcmV2ZW50IHJhY2UgY29uZGl0aW9uc1xuICAgIHJldHVybiB0aGlzLnByaXNtYS4kdHJhbnNhY3Rpb24oXG4gICAgICBhc3luYyAodHgpID0+IHtcbiAgICAgICAgLy8gRmlyc3QsIGFjcXVpcmUgbG9ja3Mgb24gYm90aCB0aGVyYXBpc3QgYW5kIGNsaWVudCBzY2hlZHVsZXNcbiAgICAgICAgLy8gVGhpcyBwcmV2ZW50cyBjb25jdXJyZW50IGJvb2tpbmdzIGZyb20gaW50ZXJmZXJpbmdcbiAgICAgICAgY29uc3QgW3RoZXJhcGlzdExvY2ssIGNsaWVudExvY2tdID0gYXdhaXQgUHJvbWlzZS5hbGwoW1xuICAgICAgICAgIHR4LnVzZXIuZmluZFVuaXF1ZSh7XG4gICAgICAgICAgICB3aGVyZTogeyBpZDogdGhlcmFwaXN0SWQgfSxcbiAgICAgICAgICAgIHNlbGVjdDogeyBpZDogdHJ1ZSB9LFxuICAgICAgICAgIH0pLFxuICAgICAgICAgIHR4LnVzZXIuZmluZFVuaXF1ZSh7XG4gICAgICAgICAgICB3aGVyZTogeyBpZDogY2xpZW50SWQgfSxcbiAgICAgICAgICAgIHNlbGVjdDogeyBpZDogdHJ1ZSB9LFxuICAgICAgICAgIH0pLFxuICAgICAgICBdKTtcblxuICAgICAgICBpZiAoIXRoZXJhcGlzdExvY2sgfHwgIWNsaWVudExvY2spIHtcbiAgICAgICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdEV4Y2VwdGlvbignVGhlcmFwaXN0IG9yIGNsaWVudCBub3QgZm91bmQnKTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIENoZWNrIGZvciBjb25mbGljdHMgd2l0aGluIHRyYW5zYWN0aW9uIChhdG9taWMgb3BlcmF0aW9uKVxuICAgICAgICBjb25zdCBjb25mbGljdGluZ01lZXRpbmdzID0gYXdhaXQgdHgubWVldGluZy5maW5kTWFueSh7XG4gICAgICAgICAgd2hlcmU6IHtcbiAgICAgICAgICAgIE9SOiBbXG4gICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICB0aGVyYXBpc3RJZCxcbiAgICAgICAgICAgICAgICBzdGFydFRpbWU6IHsgbHQ6IGVuZFRpbWVEYXRlIH0sXG4gICAgICAgICAgICAgICAgZW5kVGltZTogeyBndDogc3RhcnRUaW1lRGF0ZSB9LFxuICAgICAgICAgICAgICAgIHN0YXR1czogeyBpbjogWydTQ0hFRFVMRUQnLCAnQ09ORklSTUVEJywgJ0lOX1BST0dSRVNTJ10gfSxcbiAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIGNsaWVudElkLFxuICAgICAgICAgICAgICAgIHN0YXJ0VGltZTogeyBsdDogZW5kVGltZURhdGUgfSxcbiAgICAgICAgICAgICAgICBlbmRUaW1lOiB7IGd0OiBzdGFydFRpbWVEYXRlIH0sXG4gICAgICAgICAgICAgICAgc3RhdHVzOiB7IGluOiBbJ1NDSEVEVUxFRCcsICdDT05GSVJNRUQnLCAnSU5fUFJPR1JFU1MnXSB9LFxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgXSxcbiAgICAgICAgICB9LFxuICAgICAgICB9KTtcblxuICAgICAgICBpZiAoY29uZmxpY3RpbmdNZWV0aW5ncy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFeGNlcHRpb24oXG4gICAgICAgICAgICBgU2NoZWR1bGUgY29uZmxpY3QgZGV0ZWN0ZWQ6ICR7Y29uZmxpY3RpbmdNZWV0aW5ncy5sZW5ndGh9IGNvbmZsaWN0aW5nIG1lZXRpbmdzIGZvdW5kYCxcbiAgICAgICAgICApO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gVmFsaWRhdGUgdGhlcmFwaXN0IGF2YWlsYWJpbGl0eSB1c2luZyB0aGUgdmFsaWRhdG9yIHNlcnZpY2VcbiAgICAgICAgYXdhaXQgdGhpcy5hdmFpbGFiaWxpdHlWYWxpZGF0b3IudmFsaWRhdGVUaGVyYXBpc3RBdmFpbGFiaWxpdHlXaXRoVHJhbnNhY3Rpb24oXG4gICAgICAgICAgdGhlcmFwaXN0SWQsXG4gICAgICAgICAgc3RhcnRUaW1lRGF0ZSxcbiAgICAgICAgICBkdXJhdGlvbixcbiAgICAgICAgICB0eCwgLy8gUGFzcyB0cmFuc2FjdGlvbiBjbGllbnRcbiAgICAgICAgKTtcblxuICAgICAgICAvLyBDcmVhdGUgdGhlIG1lZXRpbmcgd2l0aGluIHRoZSB0cmFuc2FjdGlvblxuICAgICAgICBjb25zdCBtZWV0aW5nID0gYXdhaXQgdHgubWVldGluZy5jcmVhdGUoe1xuICAgICAgICAgIGRhdGE6IHtcbiAgICAgICAgICAgIC4uLmNyZWF0ZU1lZXRpbmdEdG8sXG4gICAgICAgICAgICBzdGFydFRpbWU6IHN0YXJ0VGltZURhdGUsXG4gICAgICAgICAgICBlbmRUaW1lOiBlbmRUaW1lRGF0ZSxcbiAgICAgICAgICAgIHN0YXR1czogJ1NDSEVEVUxFRCcsXG4gICAgICAgICAgICBjbGllbnRJZCxcbiAgICAgICAgICB9LFxuICAgICAgICAgIGluY2x1ZGU6IHtcbiAgICAgICAgICAgIGNsaWVudDoge1xuICAgICAgICAgICAgICBzZWxlY3Q6IHtcbiAgICAgICAgICAgICAgICB1c2VyOiB7XG4gICAgICAgICAgICAgICAgICBzZWxlY3Q6IHtcbiAgICAgICAgICAgICAgICAgICAgZmlyc3ROYW1lOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgICBsYXN0TmFtZTogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgICAgZW1haWw6IHRydWUsXG4gICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgdGhlcmFwaXN0OiB7XG4gICAgICAgICAgICAgIHNlbGVjdDoge1xuICAgICAgICAgICAgICAgIHVzZXI6IHtcbiAgICAgICAgICAgICAgICAgIHNlbGVjdDoge1xuICAgICAgICAgICAgICAgICAgICBmaXJzdE5hbWU6IHRydWUsXG4gICAgICAgICAgICAgICAgICAgIGxhc3ROYW1lOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgICBlbWFpbDogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy8gTk9URTogUGF5bWVudCBwcm9jZXNzaW5nIG5vdyBoYW5kbGVkIHNlcGFyYXRlbHkgd2hlbiBjbGllbnQgcGF5cyBmb3Igc2Vzc2lvblxuICAgICAgICAvLyBUaGUgbWVldGluZyBpcyBjcmVhdGVkIGZpcnN0LCB0aGVuIHBheW1lbnQgaXMgcHJvY2Vzc2VkIHZpYSBiaWxsaW5nIGNvbnRyb2xsZXJcbiAgICAgICAgLy8gVGhpcyBhbGxvd3MgZm9yIGJldHRlciBwYXltZW50IGZsb3cgYW5kIGVycm9yIGhhbmRsaW5nXG5cbiAgICAgICAgLy8gUHVibGlzaCBhcHBvaW50bWVudCBib29rZWQgZXZlbnRcbiAgICAgICAgYXdhaXQgdGhpcy5ldmVudEJ1cy5lbWl0KFxuICAgICAgICAgIG5ldyBBcHBvaW50bWVudEJvb2tlZEV2ZW50KHtcbiAgICAgICAgICAgIGFwcG9pbnRtZW50SWQ6IG1lZXRpbmcuaWQsXG4gICAgICAgICAgICBjbGllbnRJZDogbWVldGluZy5jbGllbnRJZCxcbiAgICAgICAgICAgIHRoZXJhcGlzdElkOiBtZWV0aW5nLnRoZXJhcGlzdElkLFxuICAgICAgICAgICAgc3RhcnRUaW1lOiBtZWV0aW5nLnN0YXJ0VGltZSxcbiAgICAgICAgICAgIG1lZXRpbmdUeXBlOiBtZWV0aW5nLm1lZXRpbmdUeXBlIGFzXG4gICAgICAgICAgICAgIHwgJ3ZpZGVvJ1xuICAgICAgICAgICAgICB8ICdhdWRpbydcbiAgICAgICAgICAgICAgfCAnaW5fcGVyc29uJ1xuICAgICAgICAgICAgICB8ICdjaGF0JyxcbiAgICAgICAgICAgIGR1cmF0aW9uOiBtZWV0aW5nLmR1cmF0aW9uLFxuICAgICAgICAgICAgdGl0bGU6IG1lZXRpbmcudGl0bGUgfHwgJ1RoZXJhcHkgU2Vzc2lvbicsXG4gICAgICAgICAgICBkZXNjcmlwdGlvbjogbWVldGluZy5kZXNjcmlwdGlvbiB8fCB1bmRlZmluZWQsXG4gICAgICAgICAgICBpc0luaXRpYWxDb25zdWx0YXRpb246IGZhbHNlLFxuICAgICAgICAgIH0pLFxuICAgICAgICApO1xuXG4gICAgICAgIC8vIFRyYW5zZm9ybSB0aGUgcmVzcG9uc2UgdG8gbWF0Y2ggZnJvbnRlbmQgZXhwZWN0YXRpb25zXG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgLi4ubWVldGluZyxcbiAgICAgICAgICBkYXRlVGltZTogbWVldGluZy5zdGFydFRpbWUsIC8vIE1hcCBzdGFydFRpbWUgdG8gZGF0ZVRpbWUgZm9yIGZyb250ZW5kIGNvbXBhdGliaWxpdHlcbiAgICAgICAgICB0aGVyYXBpc3ROYW1lOiBtZWV0aW5nLnRoZXJhcGlzdD8udXNlclxuICAgICAgICAgICAgPyBgJHttZWV0aW5nLnRoZXJhcGlzdC51c2VyLmZpcnN0TmFtZX0gJHttZWV0aW5nLnRoZXJhcGlzdC51c2VyLmxhc3ROYW1lfWBcbiAgICAgICAgICAgIDogJ1Vua25vd24gVGhlcmFwaXN0JyxcbiAgICAgICAgfTtcbiAgICAgIH0sXG4gICAgICB7XG4gICAgICAgIGlzb2xhdGlvbkxldmVsOiAnU2VyaWFsaXphYmxlJywgLy8gSGlnaGVzdCBpc29sYXRpb24gbGV2ZWwgdG8gcHJldmVudCByYWNlIGNvbmRpdGlvbnNcbiAgICAgICAgdGltZW91dDogMTAwMDAsIC8vIDEwIHNlY29uZCB0aW1lb3V0XG4gICAgICAgIG1heFdhaXQ6IDUwMDAsIC8vIE1heCB3YWl0IHRpbWUgZm9yIHRyYW5zYWN0aW9uIGxvY2tcbiAgICAgIH0sXG4gICAgKTtcbiAgfVxuXG4gIGFzeW5jIGdldE1lZXRpbmdzKFxuICAgIHVzZXJJZDogc3RyaW5nLFxuICAgIHJvbGU6IHN0cmluZyxcbiAgICBxdWVyeU9wdGlvbnM/OiB7XG4gICAgICBzdGF0dXM/OiBzdHJpbmc7XG4gICAgICBsaW1pdD86IG51bWJlcjtcbiAgICAgIG9mZnNldD86IG51bWJlcjtcbiAgICB9LFxuICApIHtcbiAgICB0cnkge1xuICAgICAgY29uc3Qgd2hlcmU6IGFueSA9XG4gICAgICAgIHJvbGUgPT09ICd0aGVyYXBpc3QnID8geyB0aGVyYXBpc3RJZDogdXNlcklkIH0gOiB7IGNsaWVudElkOiB1c2VySWQgfTtcblxuICAgICAgLy8gSGFuZGxlIHN0YXR1cyBmaWx0ZXJpbmdcbiAgICAgIGlmIChxdWVyeU9wdGlvbnM/LnN0YXR1cykge1xuICAgICAgICBjb25zdCBzdGF0dXNWYWx1ZXMgPSBxdWVyeU9wdGlvbnMuc3RhdHVzXG4gICAgICAgICAgLnNwbGl0KCcsJylcbiAgICAgICAgICAubWFwKChzKSA9PiBzLnRyaW0oKS50b1VwcGVyQ2FzZSgpKTtcbiAgICAgICAgd2hlcmUuc3RhdHVzID0geyBpbjogc3RhdHVzVmFsdWVzIH07XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IG1lZXRpbmdzID0gYXdhaXQgdGhpcy5wcmlzbWEubWVldGluZy5maW5kTWFueSh7XG4gICAgICAgIHdoZXJlLFxuICAgICAgICBpbmNsdWRlOiB7XG4gICAgICAgICAgY2xpZW50OiB7XG4gICAgICAgICAgICBzZWxlY3Q6IHtcbiAgICAgICAgICAgICAgdXNlcjoge1xuICAgICAgICAgICAgICAgIHNlbGVjdDoge1xuICAgICAgICAgICAgICAgICAgZmlyc3ROYW1lOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgbGFzdE5hbWU6IHRydWUsXG4gICAgICAgICAgICAgICAgICBlbWFpbDogdHJ1ZSxcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9LFxuICAgICAgICAgIHRoZXJhcGlzdDoge1xuICAgICAgICAgICAgc2VsZWN0OiB7XG4gICAgICAgICAgICAgIHVzZXI6IHtcbiAgICAgICAgICAgICAgICBzZWxlY3Q6IHtcbiAgICAgICAgICAgICAgICAgIGZpcnN0TmFtZTogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgIGxhc3ROYW1lOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgZW1haWw6IHRydWUsXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgICAgb3JkZXJCeTogeyBzdGFydFRpbWU6ICdkZXNjJyB9LFxuICAgICAgICB0YWtlOiBxdWVyeU9wdGlvbnM/LmxpbWl0LFxuICAgICAgICBza2lwOiBxdWVyeU9wdGlvbnM/Lm9mZnNldCxcbiAgICAgIH0pO1xuXG4gICAgICAvLyBUcmFuc2Zvcm0gdGhlIHJlc3BvbnNlIHRvIG1hdGNoIGZyb250ZW5kIGV4cGVjdGF0aW9uc1xuICAgICAgcmV0dXJuIG1lZXRpbmdzLm1hcCgobWVldGluZykgPT4gKHtcbiAgICAgICAgLi4ubWVldGluZyxcbiAgICAgICAgZGF0ZVRpbWU6IG1lZXRpbmcuc3RhcnRUaW1lLCAvLyBNYXAgc3RhcnRUaW1lIHRvIGRhdGVUaW1lIGZvciBmcm9udGVuZCBjb21wYXRpYmlsaXR5XG4gICAgICAgIHRoZXJhcGlzdE5hbWU6IG1lZXRpbmcudGhlcmFwaXN0Py51c2VyXG4gICAgICAgICAgPyBgJHttZWV0aW5nLnRoZXJhcGlzdC51c2VyLmZpcnN0TmFtZX0gJHttZWV0aW5nLnRoZXJhcGlzdC51c2VyLmxhc3ROYW1lfWBcbiAgICAgICAgICA6ICdVbmtub3duIFRoZXJhcGlzdCcsXG4gICAgICB9KSk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0RXhjZXB0aW9uKFxuICAgICAgICBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6IFN0cmluZyhlcnJvciksXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGdldE1lZXRpbmcoaWQ6IHN0cmluZywgdXNlcklkOiBzdHJpbmcsIHJvbGU6IHN0cmluZykge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBtZWV0aW5nID0gYXdhaXQgdGhpcy5wcmlzbWEubWVldGluZy5maW5kVW5pcXVlKHtcbiAgICAgICAgd2hlcmU6IHsgaWQgfSxcbiAgICAgICAgaW5jbHVkZToge1xuICAgICAgICAgIGNsaWVudDoge1xuICAgICAgICAgICAgc2VsZWN0OiB7XG4gICAgICAgICAgICAgIHVzZXI6IHtcbiAgICAgICAgICAgICAgICBzZWxlY3Q6IHtcbiAgICAgICAgICAgICAgICAgIGZpcnN0TmFtZTogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgIGxhc3ROYW1lOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgZW1haWw6IHRydWUsXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgICB0aGVyYXBpc3Q6IHtcbiAgICAgICAgICAgIHNlbGVjdDoge1xuICAgICAgICAgICAgICB1c2VyOiB7XG4gICAgICAgICAgICAgICAgc2VsZWN0OiB7XG4gICAgICAgICAgICAgICAgICBmaXJzdE5hbWU6IHRydWUsXG4gICAgICAgICAgICAgICAgICBsYXN0TmFtZTogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgIGVtYWlsOiB0cnVlLFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICB9KTtcblxuICAgICAgaWYgKCFtZWV0aW5nKSB7XG4gICAgICAgIHRocm93IG5ldyBOb3RGb3VuZEV4Y2VwdGlvbignTWVldGluZyBub3QgZm91bmQnKTtcbiAgICAgIH1cblxuICAgICAgLy8gVmVyaWZ5IHVzZXIgaGFzIGFjY2VzcyB0byB0aGlzIG1lZXRpbmdcbiAgICAgIGlmIChyb2xlID09PSAndGhlcmFwaXN0JyAmJiBtZWV0aW5nLnRoZXJhcGlzdElkICE9PSB1c2VySWQpIHtcbiAgICAgICAgdGhyb3cgbmV3IEZvcmJpZGRlbkV4Y2VwdGlvbignQWNjZXNzIGRlbmllZCcpO1xuICAgICAgfVxuICAgICAgaWYgKHJvbGUgPT09ICdjbGllbnQnICYmIG1lZXRpbmcuY2xpZW50SWQgIT09IHVzZXJJZCkge1xuICAgICAgICB0aHJvdyBuZXcgRm9yYmlkZGVuRXhjZXB0aW9uKCdBY2Nlc3MgZGVuaWVkJyk7XG4gICAgICB9XG5cbiAgICAgIC8vIFRyYW5zZm9ybSB0aGUgcmVzcG9uc2UgdG8gbWF0Y2ggZnJvbnRlbmQgZXhwZWN0YXRpb25zXG4gICAgICByZXR1cm4ge1xuICAgICAgICAuLi5tZWV0aW5nLFxuICAgICAgICBkYXRlVGltZTogbWVldGluZy5zdGFydFRpbWUsIC8vIE1hcCBzdGFydFRpbWUgdG8gZGF0ZVRpbWUgZm9yIGZyb250ZW5kIGNvbXBhdGliaWxpdHlcbiAgICAgICAgdGhlcmFwaXN0TmFtZTogbWVldGluZy50aGVyYXBpc3Q/LnVzZXJcbiAgICAgICAgICA/IGAke21lZXRpbmcudGhlcmFwaXN0LnVzZXIuZmlyc3ROYW1lfSAke21lZXRpbmcudGhlcmFwaXN0LnVzZXIubGFzdE5hbWV9YFxuICAgICAgICAgIDogJ1Vua25vd24gVGhlcmFwaXN0JyxcbiAgICAgIH07XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0RXhjZXB0aW9uKFxuICAgICAgICBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6IFN0cmluZyhlcnJvciksXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIHVwZGF0ZU1lZXRpbmcoXG4gICAgaWQ6IHN0cmluZyxcbiAgICB1cGRhdGVNZWV0aW5nRHRvOiBNZWV0aW5nVXBkYXRlRHRvLFxuICAgIHVzZXJJZDogc3RyaW5nLFxuICAgIHJvbGU6IHN0cmluZyxcbiAgKSB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IG1lZXRpbmcgPSBhd2FpdCB0aGlzLmdldE1lZXRpbmcoaWQsIHVzZXJJZCwgcm9sZSk7XG5cbiAgICAgIC8vIE9ubHkgYWxsb3cgdXBkYXRlcyBpZiBtZWV0aW5nIGlzIG5vdCBjb21wbGV0ZWQgb3IgY2FuY2VsbGVkXG4gICAgICBpZiAoWydDT01QTEVURUQnLCAnQ0FOQ0VMTEVEJ10uaW5jbHVkZXMobWVldGluZy5zdGF0dXMpKSB7XG4gICAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0RXhjZXB0aW9uKFxuICAgICAgICAgICdDYW5ub3QgdXBkYXRlIGNvbXBsZXRlZCBvciBjYW5jZWxsZWQgbWVldGluZ3MnLFxuICAgICAgICApO1xuICAgICAgfVxuXG4gICAgICAvLyBJZiB1cGRhdGluZyB0aW1lLCB2YWxpZGF0ZSB0aGUgbmV3IHNjaGVkdWxlXG4gICAgICBpZiAodXBkYXRlTWVldGluZ0R0by5zdGFydFRpbWUgfHwgdXBkYXRlTWVldGluZ0R0by5kdXJhdGlvbikge1xuICAgICAgICBjb25zdCBuZXdTdGFydFRpbWUgPSB1cGRhdGVNZWV0aW5nRHRvLnN0YXJ0VGltZVxuICAgICAgICAgID8gbmV3IERhdGUodXBkYXRlTWVldGluZ0R0by5zdGFydFRpbWUpXG4gICAgICAgICAgOiBtZWV0aW5nLnN0YXJ0VGltZTtcbiAgICAgICAgY29uc3QgbmV3RHVyYXRpb24gPSB1cGRhdGVNZWV0aW5nRHRvLmR1cmF0aW9uIHx8IG1lZXRpbmcuZHVyYXRpb247XG5cbiAgICAgICAgLy8gQ2hlY2sgZm9yIGNvbmZsaWN0cyB3aXRoIHRoZSB1cGRhdGVcbiAgICAgICAgY29uc3QgY29uZmxpY3RzID0gYXdhaXQgdGhpcy5jb25mbGljdERldGVjdGlvbi5jaGVja1VwZGF0ZUNvbmZsaWN0cyhcbiAgICAgICAgICBpZCxcbiAgICAgICAgICBtZWV0aW5nLnRoZXJhcGlzdElkLFxuICAgICAgICAgIG1lZXRpbmcuY2xpZW50SWQsXG4gICAgICAgICAgbmV3U3RhcnRUaW1lLFxuICAgICAgICAgIG5ld0R1cmF0aW9uLFxuICAgICAgICApO1xuXG4gICAgICAgIGlmIChjb25mbGljdHMuaGFzQ29uZmxpY3QpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdEV4Y2VwdGlvbihcbiAgICAgICAgICAgIGBTY2hlZHVsZSB1cGRhdGUgd291bGQgY2F1c2UgY29uZmxpY3RzOiAke2NvbmZsaWN0cy5jb25mbGljdGluZ01lZXRpbmdzLmxlbmd0aH0gY29uZmxpY3RpbmcgbWVldGluZ3MgZm91bmRgLFxuICAgICAgICAgICk7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBWYWxpZGF0ZSB0aGVyYXBpc3QgYXZhaWxhYmlsaXR5IGZvciBuZXcgdGltZVxuICAgICAgICBpZiAodXBkYXRlTWVldGluZ0R0by5zdGFydFRpbWUpIHtcbiAgICAgICAgICBhd2FpdCB0aGlzLmF2YWlsYWJpbGl0eVZhbGlkYXRvci52YWxpZGF0ZVRoZXJhcGlzdEF2YWlsYWJpbGl0eShcbiAgICAgICAgICAgIG1lZXRpbmcudGhlcmFwaXN0SWQsXG4gICAgICAgICAgICBuZXdTdGFydFRpbWUsXG4gICAgICAgICAgICBuZXdEdXJhdGlvbixcbiAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHVwZGF0ZWRNZWV0aW5nID0gYXdhaXQgdGhpcy5wcmlzbWEubWVldGluZy51cGRhdGUoe1xuICAgICAgICB3aGVyZTogeyBpZCB9LFxuICAgICAgICBkYXRhOiB7XG4gICAgICAgICAgdGl0bGU6IHVwZGF0ZU1lZXRpbmdEdG8udGl0bGUsXG4gICAgICAgICAgZGVzY3JpcHRpb246IHVwZGF0ZU1lZXRpbmdEdG8uZGVzY3JpcHRpb24sXG4gICAgICAgICAgc3RhcnRUaW1lOiB1cGRhdGVNZWV0aW5nRHRvLnN0YXJ0VGltZSxcbiAgICAgICAgICBkdXJhdGlvbjogdXBkYXRlTWVldGluZ0R0by5kdXJhdGlvbixcbiAgICAgICAgICBtZWV0aW5nVHlwZTogdXBkYXRlTWVldGluZ0R0by5tZWV0aW5nVHlwZSxcbiAgICAgICAgICBtZWV0aW5nVXJsOiB1cGRhdGVNZWV0aW5nRHRvLm1lZXRpbmdVcmwsXG4gICAgICAgICAgLi4uKHVwZGF0ZU1lZXRpbmdEdG8uc3RhdHVzICYmIHtcbiAgICAgICAgICAgIHN0YXR1czogdXBkYXRlTWVldGluZ0R0by5zdGF0dXMgYXMgTWVldGluZ1N0YXR1cyxcbiAgICAgICAgICB9KSxcbiAgICAgICAgfSxcbiAgICAgICAgaW5jbHVkZToge1xuICAgICAgICAgIGNsaWVudDoge1xuICAgICAgICAgICAgc2VsZWN0OiB7XG4gICAgICAgICAgICAgIHVzZXI6IHtcbiAgICAgICAgICAgICAgICBzZWxlY3Q6IHtcbiAgICAgICAgICAgICAgICAgIGZpcnN0TmFtZTogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgIGxhc3ROYW1lOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgZW1haWw6IHRydWUsXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgICB0aGVyYXBpc3Q6IHtcbiAgICAgICAgICAgIHNlbGVjdDoge1xuICAgICAgICAgICAgICB1c2VyOiB7XG4gICAgICAgICAgICAgICAgc2VsZWN0OiB7XG4gICAgICAgICAgICAgICAgICBmaXJzdE5hbWU6IHRydWUsXG4gICAgICAgICAgICAgICAgICBsYXN0TmFtZTogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgIGVtYWlsOiB0cnVlLFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICB9KTtcblxuICAgICAgLy8gUHVibGlzaCBhcHByb3ByaWF0ZSBldmVudHNcbiAgICAgIGlmICh1cGRhdGVNZWV0aW5nRHRvLnN0YXR1cyA9PT0gJ2NvbXBsZXRlZCcpIHtcbiAgICAgICAgYXdhaXQgdGhpcy5ldmVudEJ1cy5lbWl0KFxuICAgICAgICAgIG5ldyBBcHBvaW50bWVudENvbXBsZXRlZEV2ZW50KHtcbiAgICAgICAgICAgIGFwcG9pbnRtZW50SWQ6IHVwZGF0ZWRNZWV0aW5nLmlkLFxuICAgICAgICAgICAgY2xpZW50SWQ6IHVwZGF0ZWRNZWV0aW5nLmNsaWVudElkLFxuICAgICAgICAgICAgdGhlcmFwaXN0SWQ6IHVwZGF0ZWRNZWV0aW5nLnRoZXJhcGlzdElkLFxuICAgICAgICAgICAgY29tcGxldGVkQXQ6IG5ldyBEYXRlKCksXG4gICAgICAgICAgICBkdXJhdGlvbjogdXBkYXRlZE1lZXRpbmcuZHVyYXRpb24sXG4gICAgICAgICAgICBzZXNzaW9uTm90ZXM6IHVwZGF0ZU1lZXRpbmdEdG8uZGVzY3JpcHRpb24gfHwgJycsXG4gICAgICAgICAgICBhdHRlbmRhbmNlU3RhdHVzOiAnQVRURU5ERUQnLFxuICAgICAgICAgIH0pLFxuICAgICAgICApO1xuICAgICAgfSBlbHNlIGlmIChcbiAgICAgICAgdXBkYXRlTWVldGluZ0R0by5zdGFydFRpbWUgJiZcbiAgICAgICAgbmV3IERhdGUodXBkYXRlTWVldGluZ0R0by5zdGFydFRpbWUpLmdldFRpbWUoKSAhPT1cbiAgICAgICAgICBtZWV0aW5nLnN0YXJ0VGltZS5nZXRUaW1lKClcbiAgICAgICkge1xuICAgICAgICBhd2FpdCB0aGlzLmV2ZW50QnVzLmVtaXQoXG4gICAgICAgICAgbmV3IEFwcG9pbnRtZW50UmVzY2hlZHVsZWRFdmVudCh7XG4gICAgICAgICAgICBhcHBvaW50bWVudElkOiB1cGRhdGVkTWVldGluZy5pZCxcbiAgICAgICAgICAgIGNsaWVudElkOiB1cGRhdGVkTWVldGluZy5jbGllbnRJZCxcbiAgICAgICAgICAgIHRoZXJhcGlzdElkOiB1cGRhdGVkTWVldGluZy50aGVyYXBpc3RJZCxcbiAgICAgICAgICAgIHJlc2NoZWR1bGVkQnk6IHVzZXJJZCxcbiAgICAgICAgICAgIG9yaWdpbmFsU3RhcnRUaW1lOiBtZWV0aW5nLnN0YXJ0VGltZSxcbiAgICAgICAgICAgIG5ld1N0YXJ0VGltZTogbmV3IERhdGUodXBkYXRlTWVldGluZ0R0by5zdGFydFRpbWUpLFxuICAgICAgICAgICAgcmVzY2hlZHVsZVJlYXNvbjogYFJlc2NoZWR1bGVkIGJ5ICR7cm9sZX1gLFxuICAgICAgICAgIH0pLFxuICAgICAgICApO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gdXBkYXRlZE1lZXRpbmc7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0RXhjZXB0aW9uKFxuICAgICAgICBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6IFN0cmluZyhlcnJvciksXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGNhbmNlbE1lZXRpbmcoaWQ6IHN0cmluZywgdXNlcklkOiBzdHJpbmcsIHJvbGU6IHN0cmluZykge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBtZWV0aW5nID0gYXdhaXQgdGhpcy5nZXRNZWV0aW5nKGlkLCB1c2VySWQsIHJvbGUpO1xuXG4gICAgICBpZiAobWVldGluZy5zdGF0dXMgPT09ICdDQU5DRUxMRUQnKSB7XG4gICAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0RXhjZXB0aW9uKCdNZWV0aW5nIGlzIGFscmVhZHkgY2FuY2VsbGVkJyk7XG4gICAgICB9XG5cbiAgICAgIGlmIChtZWV0aW5nLnN0YXR1cyA9PT0gJ0NPTVBMRVRFRCcpIHtcbiAgICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFeGNlcHRpb24oJ0Nhbm5vdCBjYW5jZWwgY29tcGxldGVkIG1lZXRpbmdzJyk7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IGNhbmNlbGxlZE1lZXRpbmcgPSBhd2FpdCB0aGlzLnByaXNtYS5tZWV0aW5nLnVwZGF0ZSh7XG4gICAgICAgIHdoZXJlOiB7IGlkIH0sXG4gICAgICAgIGRhdGE6IHsgc3RhdHVzOiAnQ0FOQ0VMTEVEJyB9LFxuICAgICAgICBpbmNsdWRlOiB7XG4gICAgICAgICAgY2xpZW50OiB7XG4gICAgICAgICAgICBzZWxlY3Q6IHtcbiAgICAgICAgICAgICAgdXNlcjoge1xuICAgICAgICAgICAgICAgIHNlbGVjdDoge1xuICAgICAgICAgICAgICAgICAgZmlyc3ROYW1lOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgbGFzdE5hbWU6IHRydWUsXG4gICAgICAgICAgICAgICAgICBlbWFpbDogdHJ1ZSxcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9LFxuICAgICAgICAgIHRoZXJhcGlzdDoge1xuICAgICAgICAgICAgc2VsZWN0OiB7XG4gICAgICAgICAgICAgIHVzZXI6IHtcbiAgICAgICAgICAgICAgICBzZWxlY3Q6IHtcbiAgICAgICAgICAgICAgICAgIGZpcnN0TmFtZTogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgIGxhc3ROYW1lOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgZW1haWw6IHRydWUsXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgIH0pO1xuXG4gICAgICAvLyBDYWxjdWxhdGUgY2FuY2VsbGF0aW9uIG5vdGljZVxuICAgICAgY29uc3QgY2FuY2VsbGF0aW9uTm90aWNlID0gTWF0aC5mbG9vcihcbiAgICAgICAgKG1lZXRpbmcuc3RhcnRUaW1lLmdldFRpbWUoKSAtIERhdGUubm93KCkpIC8gKDEwMDAgKiA2MCAqIDYwKSxcbiAgICAgICk7XG5cbiAgICAgIC8vIEhhbmRsZSBwYXltZW50IHJlZnVuZCBmb3IgY2FuY2VsbGVkIHNlc3Npb25zXG4gICAgICB0cnkge1xuICAgICAgICAvLyBGaW5kIHBheW1lbnQgcmVjb3JkIGFzc29jaWF0ZWQgd2l0aCB0aGlzIG1lZXRpbmcgdXNpbmcgdGhlIHVwZGF0ZWQgQVBJXG4gICAgICAgIGNvbnN0IHBheW1lbnRzID0gYXdhaXQgdGhpcy5iaWxsaW5nU2VydmljZS5nZXRVc2VyUGF5bWVudHModXNlcklkLCB7XG4gICAgICAgICAgbGltaXQ6IDEwMCxcbiAgICAgICAgfSk7XG4gICAgICAgIGNvbnN0IG1lZXRpbmdQYXltZW50ID0gcGF5bWVudHMuZmluZCgocCkgPT4gcC5tZWV0aW5nSWQgPT09IG1lZXRpbmcuaWQpO1xuXG4gICAgICAgIGlmIChtZWV0aW5nUGF5bWVudCAmJiBjYW5jZWxsYXRpb25Ob3RpY2UgPj0gMjQpIHtcbiAgICAgICAgICAvLyAyNC1ob3VyIGNhbmNlbGxhdGlvbiBwb2xpY3lcbiAgICAgICAgICAvLyBOT1RFOiBSZWZ1bmQgbG9naWMgd291bGQgbmVlZCB0byBiZSBpbXBsZW1lbnRlZCBpbiBiaWxsaW5nIHNlcnZpY2VcbiAgICAgICAgICAvLyBGb3Igbm93LCB3ZSdsbCBlbWl0IGFuIGV2ZW50IHRoYXQgYSByZWZ1bmQgaXMgbmVlZGVkXG4gICAgICAgICAgdGhpcy5sb2dnZXIubG9nKFxuICAgICAgICAgICAgYFJlZnVuZCBuZWVkZWQgZm9yIGNhbmNlbGxlZCBzZXNzaW9uICR7bWVldGluZy5pZH0gLSAke2NhbmNlbGxhdGlvbk5vdGljZX1oIG5vdGljZWAsXG4gICAgICAgICAgKTtcbiAgICAgICAgICAvLyBUT0RPOiBJbXBsZW1lbnQgcmVmdW5kIHByb2Nlc3NpbmcgaW4gYmlsbGluZyBzZXJ2aWNlXG4gICAgICAgIH1cbiAgICAgIH0gY2F0Y2ggKHJlZnVuZEVycm9yKSB7XG4gICAgICAgIC8vIExvZyByZWZ1bmQgZXJyb3IgYnV0IGRvbid0IGZhaWwgdGhlIGNhbmNlbGxhdGlvblxuICAgICAgICBjb25zb2xlLmVycm9yKFxuICAgICAgICAgICdGYWlsZWQgdG8gcHJvY2VzcyByZWZ1bmQgZm9yIGNhbmNlbGxlZCBtZWV0aW5nOicsXG4gICAgICAgICAgcmVmdW5kRXJyb3IsXG4gICAgICAgICk7XG4gICAgICB9XG5cbiAgICAgIC8vIFB1Ymxpc2ggY2FuY2VsbGF0aW9uIGV2ZW50XG4gICAgICBhd2FpdCB0aGlzLmV2ZW50QnVzLmVtaXQoXG4gICAgICAgIG5ldyBBcHBvaW50bWVudENhbmNlbGxlZEV2ZW50KHtcbiAgICAgICAgICBhcHBvaW50bWVudElkOiBjYW5jZWxsZWRNZWV0aW5nLmlkLFxuICAgICAgICAgIGNsaWVudElkOiBjYW5jZWxsZWRNZWV0aW5nLmNsaWVudElkLFxuICAgICAgICAgIHRoZXJhcGlzdElkOiBjYW5jZWxsZWRNZWV0aW5nLnRoZXJhcGlzdElkLFxuICAgICAgICAgIGNhbmNlbGxlZEJ5OiB1c2VySWQsXG4gICAgICAgICAgY2FuY2VsbGF0aW9uUmVhc29uOlxuICAgICAgICAgICAgcm9sZSA9PT0gJ2NsaWVudCdcbiAgICAgICAgICAgICAgPyAnQ2FuY2VsbGVkIGJ5IGNsaWVudCdcbiAgICAgICAgICAgICAgOiAnQ2FuY2VsbGVkIGJ5IHRoZXJhcGlzdCcsXG4gICAgICAgICAgb3JpZ2luYWxTdGFydFRpbWU6IG1lZXRpbmcuc3RhcnRUaW1lLFxuICAgICAgICAgIGNhbmNlbGxlZEF0OiBuZXcgRGF0ZSgpLFxuICAgICAgICAgIGNhbmNlbGxhdGlvbk5vdGljZTogTWF0aC5tYXgoMCwgY2FuY2VsbGF0aW9uTm90aWNlKSxcbiAgICAgICAgfSksXG4gICAgICApO1xuXG4gICAgICByZXR1cm4gY2FuY2VsbGVkTWVldGluZztcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFeGNlcHRpb24oXG4gICAgICAgIGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogU3RyaW5nKGVycm9yKSxcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgLy8gQXZhaWxhYmlsaXR5IE1hbmFnZW1lbnRcbiAgYXN5bmMgY3JlYXRlQXZhaWxhYmlsaXR5KFxuICAgIGNyZWF0ZUF2YWlsYWJpbGl0eUR0bzogVGhlcmFwaXN0QXZhaWxhYmlsaXR5Q3JlYXRlRHRvLFxuICAgIHRoZXJhcGlzdElkOiBzdHJpbmcsXG4gICkge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCB7IGRheU9mV2Vlaywgc3RhcnRUaW1lLCBlbmRUaW1lLCBub3RlcyB9ID0gY3JlYXRlQXZhaWxhYmlsaXR5RHRvO1xuXG4gICAgICAvLyBWYWxpZGF0ZSB1c2luZyBvdXIgbmV3IHNlcnZpY2VcbiAgICAgIGF3YWl0IHRoaXMuYXZhaWxhYmlsaXR5VmFsaWRhdG9yLnZhbGlkYXRlQXZhaWxhYmlsaXR5Q3JlYXRpb24oe1xuICAgICAgICB0aGVyYXBpc3RJZCxcbiAgICAgICAgZGF5T2ZXZWVrLFxuICAgICAgICBzdGFydFRpbWUsXG4gICAgICAgIGVuZFRpbWUsXG4gICAgICB9KTtcblxuICAgICAgcmV0dXJuIHRoaXMucHJpc21hLnRoZXJhcGlzdEF2YWlsYWJpbGl0eS5jcmVhdGUoe1xuICAgICAgICBkYXRhOiB7XG4gICAgICAgICAgdGhlcmFwaXN0SWQsXG4gICAgICAgICAgZGF5T2ZXZWVrOiBkYXlPZldlZWsudG9TdHJpbmcoKSxcbiAgICAgICAgICBzdGFydFRpbWUsXG4gICAgICAgICAgZW5kVGltZSxcbiAgICAgICAgICBub3RlcyxcbiAgICAgICAgfSxcbiAgICAgIH0pO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdEV4Y2VwdGlvbihcbiAgICAgICAgZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiBTdHJpbmcoZXJyb3IpLFxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBnZXRBdmFpbGFiaWxpdHkodGhlcmFwaXN0SWQ6IHN0cmluZykge1xuICAgIHRyeSB7XG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy5wcmlzbWEudGhlcmFwaXN0QXZhaWxhYmlsaXR5LmZpbmRNYW55KHtcbiAgICAgICAgd2hlcmU6IHsgdGhlcmFwaXN0SWQgfSxcbiAgICAgICAgb3JkZXJCeTogW3sgZGF5T2ZXZWVrOiAnYXNjJyB9LCB7IHN0YXJ0VGltZTogJ2FzYycgfV0sXG4gICAgICB9KTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFeGNlcHRpb24oXG4gICAgICAgIGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogU3RyaW5nKGVycm9yKSxcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgdXBkYXRlQXZhaWxhYmlsaXR5KFxuICAgIGlkOiBzdHJpbmcsXG4gICAgdXBkYXRlQXZhaWxhYmlsaXR5RHRvOiBUaGVyYXBpc3RBdmFpbGFiaWxpdHlVcGRhdGVEdG8sXG4gICAgdGhlcmFwaXN0SWQ6IHN0cmluZyxcbiAgKSB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGF2YWlsYWJpbGl0eSA9IGF3YWl0IHRoaXMucHJpc21hLnRoZXJhcGlzdEF2YWlsYWJpbGl0eS5maW5kRmlyc3Qoe1xuICAgICAgICB3aGVyZTogeyBpZCwgdGhlcmFwaXN0SWQgfSxcbiAgICAgIH0pO1xuXG4gICAgICBpZiAoIWF2YWlsYWJpbGl0eSkge1xuICAgICAgICB0aHJvdyBuZXcgTm90Rm91bmRFeGNlcHRpb24oJ0F2YWlsYWJpbGl0eSBzbG90IG5vdCBmb3VuZCcpO1xuICAgICAgfVxuXG4gICAgICAvLyBDb252ZXJ0IGRheU9mV2VlayB0byBzdHJpbmcgaWYgcHJlc2VudFxuICAgICAgY29uc3QgeyBkYXlPZldlZWssIC4uLnJlc3QgfSA9IHVwZGF0ZUF2YWlsYWJpbGl0eUR0bztcbiAgICAgIGNvbnN0IHVwZGF0ZURhdGEgPSB7XG4gICAgICAgIC4uLnJlc3QsXG4gICAgICAgIC4uLihkYXlPZldlZWsgIT09IHVuZGVmaW5lZCAmJiB7XG4gICAgICAgICAgZGF5T2ZXZWVrOiBkYXlPZldlZWsudG9TdHJpbmcoKSxcbiAgICAgICAgfSksXG4gICAgICB9O1xuXG4gICAgICByZXR1cm4gdGhpcy5wcmlzbWEudGhlcmFwaXN0QXZhaWxhYmlsaXR5LnVwZGF0ZSh7XG4gICAgICAgIHdoZXJlOiB7IGlkIH0sXG4gICAgICAgIGRhdGE6IHVwZGF0ZURhdGEsXG4gICAgICB9KTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFeGNlcHRpb24oXG4gICAgICAgIGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogU3RyaW5nKGVycm9yKSxcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgZGVsZXRlQXZhaWxhYmlsaXR5KGlkOiBzdHJpbmcsIHRoZXJhcGlzdElkOiBzdHJpbmcpIHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgYXZhaWxhYmlsaXR5ID0gYXdhaXQgdGhpcy5wcmlzbWEudGhlcmFwaXN0QXZhaWxhYmlsaXR5LmZpbmRGaXJzdCh7XG4gICAgICAgIHdoZXJlOiB7IGlkLCB0aGVyYXBpc3RJZCB9LFxuICAgICAgfSk7XG5cbiAgICAgIGlmICghYXZhaWxhYmlsaXR5KSB7XG4gICAgICAgIHRocm93IG5ldyBOb3RGb3VuZEV4Y2VwdGlvbignQXZhaWxhYmlsaXR5IHNsb3Qgbm90IGZvdW5kJyk7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiB0aGlzLnByaXNtYS50aGVyYXBpc3RBdmFpbGFiaWxpdHkuZGVsZXRlKHtcbiAgICAgICAgd2hlcmU6IHsgaWQgfSxcbiAgICAgIH0pO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdEV4Y2VwdGlvbihcbiAgICAgICAgZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiBTdHJpbmcoZXJyb3IpLFxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICAvLyBTaW1wbGlmaWVkIHNsb3QgZ2VuZXJhdGlvbiB1c2luZyBvdXIgbmV3IHNlcnZpY2VcbiAgYXN5bmMgZ2V0QXZhaWxhYmxlU2xvdHModGhlcmFwaXN0SWQ6IHN0cmluZywgZGF0ZTogc3RyaW5nKSB7XG4gICAgdHJ5IHtcbiAgICAgIHJldHVybiBhd2FpdCB0aGlzLnNsb3RHZW5lcmF0b3IuZ2VuZXJhdGVBdmFpbGFibGVTbG90cyh0aGVyYXBpc3RJZCwgZGF0ZSk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0RXhjZXB0aW9uKFxuICAgICAgICBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6IFN0cmluZyhlcnJvciksXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIC8vIER1cmF0aW9uIG1hbmFnZW1lbnRcbiAgZ2V0RHVyYXRpb25zKCkge1xuICAgIHJldHVybiBbXG4gICAgICB7IGlkOiAnMzAnLCBuYW1lOiAnMzAgbWludXRlcycsIGR1cmF0aW9uOiAzMCB9LFxuICAgICAgeyBpZDogJzYwJywgbmFtZTogJzYwIG1pbnV0ZXMnLCBkdXJhdGlvbjogNjAgfSxcbiAgICAgIHsgaWQ6ICc5MCcsIG5hbWU6ICc5MCBtaW51dGVzJywgZHVyYXRpb246IDkwIH0sXG4gICAgICB7IGlkOiAnMTIwJywgbmFtZTogJzEyMCBtaW51dGVzJywgZHVyYXRpb246IDEyMCB9LFxuICAgIF07XG4gIH1cblxuICAvLyBFbmhhbmNlZCB2YWxpZGF0aW9uIG1ldGhvZCB1c2luZyBvdXIgc2VydmljZXNcbiAgYXN5bmMgdmFsaWRhdGVNZWV0aW5nVGltZShcbiAgICB0aGVyYXBpc3RJZDogc3RyaW5nLFxuICAgIGNsaWVudElkOiBzdHJpbmcsXG4gICAgc3RhcnRUaW1lOiBzdHJpbmcgfCBEYXRlLFxuICAgIGR1cmF0aW9uOiBudW1iZXIsXG4gICkge1xuICAgIGNvbnN0IHN0YXJ0VGltZURhdGUgPSBuZXcgRGF0ZShzdGFydFRpbWUpO1xuXG4gICAgYXdhaXQgdGhpcy5hdmFpbGFiaWxpdHlWYWxpZGF0b3IudmFsaWRhdGVNZWV0aW5nQ3JlYXRpb24oe1xuICAgICAgdGhlcmFwaXN0SWQsXG4gICAgICBjbGllbnRJZCxcbiAgICAgIHN0YXJ0VGltZTogc3RhcnRUaW1lRGF0ZSxcbiAgICAgIGR1cmF0aW9uLFxuICAgIH0pO1xuXG4gICAgYXdhaXQgdGhpcy5jb25mbGljdERldGVjdGlvbi52YWxpZGF0ZU5vQ29uZmxpY3RzKFxuICAgICAgdGhlcmFwaXN0SWQsXG4gICAgICBjbGllbnRJZCxcbiAgICAgIHN0YXJ0VGltZURhdGUsXG4gICAgICBkdXJhdGlvbixcbiAgICApO1xuXG4gICAgcmV0dXJuIHRydWU7XG4gIH1cbn1cbiJdLCJ2ZXJzaW9uIjozfQ==