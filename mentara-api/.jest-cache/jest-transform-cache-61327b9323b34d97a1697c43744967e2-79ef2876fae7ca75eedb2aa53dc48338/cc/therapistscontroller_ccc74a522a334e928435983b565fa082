8d1a8eea7b58266f6a89e96edbf51cae
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var __param = (this && this.__param) || function (paramIndex, decorator) {
    return function (target, key) { decorator(target, key, paramIndex); }
};
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
exports.TherapistsController = void 0;
const common_1 = require("@nestjs/common");
const prisma_client_provider_1 = require("../providers/prisma-client.provider");
const jwt_auth_guard_1 = require("../auth/guards/jwt-auth.guard");
const current_user_id_decorator_1 = require("../auth/decorators/current-user-id.decorator");
const swagger_1 = require("@nestjs/swagger");
let TherapistsController = class TherapistsController {
    prisma;
    constructor(prisma) {
        this.prisma = prisma;
    }
    async getAllTherapists(userId, limit, offset) {
        try {
            const take = limit ? Math.min(limit, 1000) : undefined; // Allow unlimited, max 1000 for safety
            const skip = offset ? Math.max(offset, 0) : 0;
            // Get all approved therapists with their user information
            const [therapists, totalCount] = await Promise.all([
                this.prisma.therapist.findMany({
                    where: {
                        status: 'APPROVED',
                    },
                    take,
                    skip,
                    include: {
                        user: {
                            select: {
                                id: true,
                                firstName: true,
                                lastName: true,
                                email: true,
                                avatarUrl: true,
                                bio: true,
                                createdAt: true,
                            },
                        },
                        reviews: {
                            select: {
                                rating: true,
                                content: true,
                                createdAt: true,
                                client: {
                                    select: {
                                        user: {
                                            select: {
                                                firstName: true,
                                                lastName: true,
                                            },
                                        },
                                    },
                                },
                            },
                            orderBy: {
                                createdAt: 'desc',
                            },
                            take: 5, // Latest 5 reviews
                        },
                    },
                    orderBy: {
                        createdAt: 'desc',
                    },
                }),
                this.prisma.therapist.count({
                    where: {
                        status: 'APPROVED',
                    },
                }),
            ]);
            // Transform data to match frontend expectations
            const transformedTherapists = therapists.map((therapist) => {
                const averageRating = therapist.reviews.length > 0
                    ? therapist.reviews.reduce((sum, review) => sum + review.rating, 0) / therapist.reviews.length
                    : 0;
                return {
                    id: therapist.userId,
                    userId: therapist.userId,
                    firstName: therapist.user.firstName,
                    lastName: therapist.user.lastName,
                    name: `${therapist.user.firstName} ${therapist.user.lastName}`,
                    email: therapist.user.email,
                    avatarUrl: therapist.user.avatarUrl,
                    profileImage: therapist.user.avatarUrl,
                    bio: therapist.user.bio,
                    title: 'Licensed Therapist', // Could be made dynamic later
                    specialties: therapist.areasOfExpertise || [],
                    areasOfExpertise: therapist.areasOfExpertise || [],
                    approaches: therapist.approaches || [],
                    languages: therapist.languages || [],
                    illnessSpecializations: therapist.illnessSpecializations || [],
                    experience: therapist.yearsOfExperience || 0,
                    yearsOfExperience: therapist.yearsOfExperience || 0,
                    sessionPrice: `$${therapist.hourlyRate.toString()}`,
                    hourlyRate: Number(therapist.hourlyRate),
                    rating: Number(averageRating.toFixed(1)),
                    totalReviews: therapist.reviews.length,
                    location: therapist.province,
                    province: therapist.province,
                    timezone: therapist.timezone,
                    isActive: true, // All approved therapists are considered active
                    acceptsInsurance: therapist.acceptsInsurance,
                    acceptedInsuranceTypes: therapist.acceptedInsuranceTypes || [],
                    sessionLength: therapist.sessionLength,
                    preferredSessionLength: therapist.preferredSessionLength || [],
                    createdAt: therapist.createdAt,
                    updatedAt: therapist.updatedAt,
                };
            });
            // Handle pagination calculation safely
            const pageSize = take || totalCount || 1; // Use take if provided, otherwise totalCount, or 1 as fallback
            return {
                success: true,
                data: {
                    therapists: transformedTherapists,
                    totalCount,
                    currentPage: take ? Math.floor(skip / take) + 1 : 1,
                    totalPages: Math.ceil(totalCount / pageSize),
                    hasNextPage: take ? skip + take < totalCount : false,
                    hasPreviousPage: skip > 0,
                },
            };
        }
        catch (error) {
            throw new common_1.InternalServerErrorException(error instanceof Error ? error.message : 'Failed to fetch therapists');
        }
    }
    async getTherapistProfile(therapistId) {
        try {
            const therapist = await this.prisma.therapist.findFirst({
                where: {
                    userId: therapistId,
                    status: 'APPROVED',
                },
                include: {
                    user: {
                        select: {
                            id: true,
                            firstName: true,
                            lastName: true,
                            email: true,
                            avatarUrl: true,
                            bio: true,
                            createdAt: true,
                        },
                    },
                    reviews: {
                        select: {
                            id: true,
                            rating: true,
                            content: true,
                            createdAt: true,
                            client: {
                                select: {
                                    user: {
                                        select: {
                                            firstName: true,
                                            lastName: true,
                                            avatarUrl: true,
                                        },
                                    },
                                },
                            },
                        },
                        orderBy: {
                            createdAt: 'desc',
                        },
                        take: 10, // Get more reviews for profile page
                    },
                    therapistAvailabilities: {
                        select: {
                            dayOfWeek: true,
                            startTime: true,
                            endTime: true,
                            isAvailable: true,
                        },
                        where: {
                            isAvailable: true,
                        },
                    },
                },
            });
            if (!therapist) {
                throw new common_1.NotFoundException(`Therapist with ID ${therapistId} not found`);
            }
            const averageRating = therapist.reviews.length > 0
                ? therapist.reviews.reduce((sum, review) => sum + review.rating, 0) /
                    therapist.reviews.length
                : 0;
            const transformedTherapist = {
                id: therapist.userId,
                userId: therapist.userId,
                firstName: therapist.user.firstName,
                lastName: therapist.user.lastName,
                name: `${therapist.user.firstName} ${therapist.user.lastName}`,
                email: therapist.user.email,
                avatarUrl: therapist.user.avatarUrl,
                profileImage: therapist.user.avatarUrl,
                bio: therapist.user.bio,
                title: 'Licensed Therapist',
                specialties: therapist.areasOfExpertise || [],
                areasOfExpertise: therapist.areasOfExpertise || [],
                approaches: therapist.approaches || [],
                languages: therapist.languages || [],
                illnessSpecializations: therapist.illnessSpecializations || [],
                experience: therapist.yearsOfExperience || 0,
                yearsOfExperience: therapist.yearsOfExperience || 0,
                sessionPrice: `$${therapist.hourlyRate.toString()}`,
                hourlyRate: therapist.hourlyRate,
                rating: Number(averageRating.toFixed(1)),
                totalReviews: therapist.reviews.length,
                location: therapist.province,
                province: therapist.province,
                timezone: therapist.timezone,
                isActive: true,
                acceptsInsurance: therapist.acceptsInsurance,
                acceptedInsuranceTypes: therapist.acceptedInsuranceTypes || [],
                sessionLength: therapist.sessionLength,
                preferredSessionLength: therapist.preferredSessionLength || [],
                availability: therapist.therapistAvailabilities,
                reviews: therapist.reviews.map((review) => ({
                    id: review.id,
                    rating: review.rating,
                    comment: review.content,
                    createdAt: review.createdAt,
                    clientName: `${review.client.user.firstName} ${review.client.user.lastName[0]}.`,
                    clientAvatar: review.client.user.avatarUrl,
                })),
                createdAt: therapist.createdAt,
                updatedAt: therapist.updatedAt,
                // Additional profile fields
                educationBackground: therapist.educationBackground,
                specialCertifications: therapist.specialCertifications || [],
                practiceLocation: therapist.practiceLocation,
                therapeuticApproachesUsedList: therapist.therapeuticApproachesUsedList || [],
                assessmentTools: therapist.assessmentTools || [],
                languagesOffered: therapist.languagesOffered || [],
                providedOnlineTherapyBefore: therapist.providedOnlineTherapyBefore,
                comfortableUsingVideoConferencing: therapist.comfortableUsingVideoConferencing,
                professionalLicenseType: therapist.professionalLicenseType,
                licenseVerified: therapist.licenseVerified,
                practiceStartDate: therapist.practiceStartDate,
            };
            return {
                success: true,
                data: transformedTherapist,
            };
        }
        catch (error) {
            if (error instanceof common_1.NotFoundException) {
                throw error;
            }
            throw new common_1.InternalServerErrorException(error instanceof Error
                ? error.message
                : 'Failed to fetch therapist profile');
        }
    }
};
exports.TherapistsController = TherapistsController;
__decorate([
    (0, common_1.Get)(),
    (0, swagger_1.ApiOperation)({
        summary: 'Get all approved therapists',
        description: 'Retrieve all therapists with APPROVED status',
    }),
    (0, swagger_1.ApiResponse)({
        status: 200,
        description: 'Retrieved successfully',
    }),
    (0, swagger_1.ApiResponse)({ status: 401, description: 'Unauthorized' }),
    (0, common_1.HttpCode)(common_1.HttpStatus.OK),
    __param(0, (0, current_user_id_decorator_1.CurrentUserId)()),
    __param(1, (0, common_1.Query)('limit')),
    __param(2, (0, common_1.Query)('offset')),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [String, Number, Number]),
    __metadata("design:returntype", Promise)
], TherapistsController.prototype, "getAllTherapists", null);
__decorate([
    (0, common_1.Get)(':id'),
    (0, swagger_1.ApiOperation)({
        summary: 'Get therapist profile by ID',
        description: 'Retrieve detailed therapist profile information',
    }),
    (0, swagger_1.ApiParam)({
        name: 'id',
        description: 'Therapist user ID',
        type: 'string',
    }),
    (0, swagger_1.ApiResponse)({
        status: 200,
        description: 'Retrieved successfully',
    }),
    (0, swagger_1.ApiResponse)({ status: 404, description: 'Therapist not found' }),
    (0, swagger_1.ApiResponse)({ status: 401, description: 'Unauthorized' }),
    (0, common_1.HttpCode)(common_1.HttpStatus.OK),
    __param(0, (0, common_1.Param)('id')),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [String]),
    __metadata("design:returntype", Promise)
], TherapistsController.prototype, "getTherapistProfile", null);
exports.TherapistsController = TherapistsController = __decorate([
    (0, swagger_1.ApiTags)('therapists'),
    (0, swagger_1.ApiBearerAuth)('JWT-auth'),
    (0, common_1.Controller)('therapists'),
    (0, common_1.UseGuards)(jwt_auth_guard_1.JwtAuthGuard),
    __metadata("design:paramtypes", [typeof (_a = typeof prisma_client_provider_1.PrismaService !== "undefined" && prisma_client_provider_1.PrismaService) === "function" ? _a : Object])
], TherapistsController);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL3RoZXJhcGlzdC90aGVyYXBpc3RzLmNvbnRyb2xsZXIudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLDJDQVV3QjtBQUN4QixnRkFBb0U7QUFDcEUsa0VBQTZEO0FBQzdELDRGQUE2RTtBQUM3RSw2Q0FNeUI7QUFNbEIsSUFBTSxvQkFBb0IsR0FBMUIsTUFBTSxvQkFBb0I7SUFDRjtJQUE3QixZQUE2QixNQUFxQjtRQUFyQixXQUFNLEdBQU4sTUFBTSxDQUFlO0lBQUcsQ0FBQztJQWFoRCxBQUFOLEtBQUssQ0FBQyxnQkFBZ0IsQ0FDSCxNQUFjLEVBQ2YsS0FBYyxFQUNiLE1BQWU7UUFFaEMsSUFBSSxDQUFDO1lBQ0gsTUFBTSxJQUFJLEdBQUcsS0FBSyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEtBQUssRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsdUNBQXVDO1lBQy9GLE1BQU0sSUFBSSxHQUFHLE1BQU0sQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUU5QywwREFBMEQ7WUFDMUQsTUFBTSxDQUFDLFVBQVUsRUFBRSxVQUFVLENBQUMsR0FBRyxNQUFNLE9BQU8sQ0FBQyxHQUFHLENBQUM7Z0JBQ2pELElBQUksQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FBQztvQkFDN0IsS0FBSyxFQUFFO3dCQUNMLE1BQU0sRUFBRSxVQUFVO3FCQUNuQjtvQkFDRCxJQUFJO29CQUNKLElBQUk7b0JBQ0osT0FBTyxFQUFFO3dCQUNQLElBQUksRUFBRTs0QkFDSixNQUFNLEVBQUU7Z0NBQ04sRUFBRSxFQUFFLElBQUk7Z0NBQ1IsU0FBUyxFQUFFLElBQUk7Z0NBQ2YsUUFBUSxFQUFFLElBQUk7Z0NBQ2Qs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O1FBQ1YsV0FBVyxFQUFFLG1CQUFtQjtRQUNoQyxJQUFJLEVBQUUsUUFBUTtLQUNmLENBQUM7SUFDRCxJQUFBLHFCQUFXLEVBQUM7UUFDWCxNQUFNLEVBQUUsR0FBRztRQUNYLFdBQVcsRUFBRSx3QkFBd0I7S0FDdEMsQ0FBQztJQUNELElBQUEscUJBQVcsRUFBQyxFQUFFLE1BQU0sRUFBRSxHQUFHLEVBQUUsV0FBVyxFQUFFLHFCQUFxQixFQUFFLENBQUM7SUFDaEUsSUFBQSxxQkFBVyxFQUFDLEVBQUUsTUFBTSxFQUFFLEdBQUcsRUFBRSxXQUFXLEVBQUUsY0FBYyxFQUFFLENBQUM7SUFDekQsSUFBQSxpQkFBUSxFQUFDLG1CQUFVLENBQUMsRUFBRSxDQUFDO0lBQ0csV0FBQSxJQUFBLGNBQUssRUFBQyxJQUFJLENBQUMsQ0FBQTs7OzsrREE0SXJDOytCQTNTVSxvQkFBb0I7SUFKaEMsSUFBQSxpQkFBTyxFQUFDLFlBQVksQ0FBQztJQUNyQixJQUFBLHVCQUFhLEVBQUMsVUFBVSxDQUFDO0lBQ3pCLElBQUEsbUJBQVUsRUFBQyxZQUFZLENBQUM7SUFDeEIsSUFBQSxrQkFBUyxFQUFDLDZCQUFZLENBQUM7eURBRWUsc0NBQWEsb0JBQWIsc0NBQWE7R0FEdkMsb0JBQW9CLENBNFNoQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvaG9tZS93ZXRvb2EvRG9jdW1lbnRzL2NvZGUvcHJvamVjdHMvbWVudGFyYS9tZW50YXJhLWFwaS9zcmMvdGhlcmFwaXN0L3RoZXJhcGlzdHMuY29udHJvbGxlci50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBDb250cm9sbGVyLFxuICBHZXQsXG4gIFF1ZXJ5LFxuICBQYXJhbSxcbiAgVXNlR3VhcmRzLFxuICBIdHRwQ29kZSxcbiAgSHR0cFN0YXR1cyxcbiAgSW50ZXJuYWxTZXJ2ZXJFcnJvckV4Y2VwdGlvbixcbiAgTm90Rm91bmRFeGNlcHRpb24sXG59IGZyb20gJ0BuZXN0anMvY29tbW9uJztcbmltcG9ydCB7IFByaXNtYVNlcnZpY2UgfSBmcm9tICcuLi9wcm92aWRlcnMvcHJpc21hLWNsaWVudC5wcm92aWRlcic7XG5pbXBvcnQgeyBKd3RBdXRoR3VhcmQgfSBmcm9tICcuLi9hdXRoL2d1YXJkcy9qd3QtYXV0aC5ndWFyZCc7XG5pbXBvcnQgeyBDdXJyZW50VXNlcklkIH0gZnJvbSAnLi4vYXV0aC9kZWNvcmF0b3JzL2N1cnJlbnQtdXNlci1pZC5kZWNvcmF0b3InO1xuaW1wb3J0IHtcbiAgQXBpVGFncyxcbiAgQXBpT3BlcmF0aW9uLFxuICBBcGlSZXNwb25zZSxcbiAgQXBpQmVhcmVyQXV0aCxcbiAgQXBpUGFyYW0sXG59IGZyb20gJ0BuZXN0anMvc3dhZ2dlcic7XG5cbkBBcGlUYWdzKCd0aGVyYXBpc3RzJylcbkBBcGlCZWFyZXJBdXRoKCdKV1QtYXV0aCcpXG5AQ29udHJvbGxlcigndGhlcmFwaXN0cycpXG5AVXNlR3VhcmRzKEp3dEF1dGhHdWFyZClcbmV4cG9ydCBjbGFzcyBUaGVyYXBpc3RzQ29udHJvbGxlciB7XG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgcmVhZG9ubHkgcHJpc21hOiBQcmlzbWFTZXJ2aWNlKSB7fVxuXG4gIEBHZXQoKVxuICBAQXBpT3BlcmF0aW9uKHtcbiAgICBzdW1tYXJ5OiAnR2V0IGFsbCBhcHByb3ZlZCB0aGVyYXBpc3RzJyxcbiAgICBkZXNjcmlwdGlvbjogJ1JldHJpZXZlIGFsbCB0aGVyYXBpc3RzIHdpdGggQVBQUk9WRUQgc3RhdHVzJyxcbiAgfSlcbiAgQEFwaVJlc3BvbnNlKHtcbiAgICBzdGF0dXM6IDIwMCxcbiAgICBkZXNjcmlwdGlvbjogJ1JldHJpZXZlZCBzdWNjZXNzZnVsbHknLFxuICB9KVxuICBAQXBpUmVzcG9uc2UoeyBzdGF0dXM6IDQwMSwgZGVzY3JpcHRpb246ICdVbmF1dGhvcml6ZWQnIH0pXG4gIEBIdHRwQ29kZShIdHRwU3RhdHVzLk9LKVxuICBhc3luYyBnZXRBbGxUaGVyYXBpc3RzKFxuICAgIEBDdXJyZW50VXNlcklkKCkgdXNlcklkOiBzdHJpbmcsXG4gICAgQFF1ZXJ5KCdsaW1pdCcpIGxpbWl0PzogbnVtYmVyLFxuICAgIEBRdWVyeSgnb2Zmc2V0Jykgb2Zmc2V0PzogbnVtYmVyLFxuICApIHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgdGFrZSA9IGxpbWl0ID8gTWF0aC5taW4obGltaXQsIDEwMDApIDogdW5kZWZpbmVkOyAvLyBBbGxvdyB1bmxpbWl0ZWQsIG1heCAxMDAwIGZvciBzYWZldHlcbiAgICAgIGNvbnN0IHNraXAgPSBvZmZzZXQgPyBNYXRoLm1heChvZmZzZXQsIDApIDogMDtcblxuICAgICAgLy8gR2V0IGFsbCBhcHByb3ZlZCB0aGVyYXBpc3RzIHdpdGggdGhlaXIgdXNlciBpbmZvcm1hdGlvblxuICAgICAgY29uc3QgW3RoZXJhcGlzdHMsIHRvdGFsQ291bnRdID0gYXdhaXQgUHJvbWlzZS5hbGwoW1xuICAgICAgICB0aGlzLnByaXNtYS50aGVyYXBpc3QuZmluZE1hbnkoe1xuICAgICAgICAgIHdoZXJlOiB7XG4gICAgICAgICAgICBzdGF0dXM6ICdBUFBST1ZFRCcsXG4gICAgICAgICAgfSxcbiAgICAgICAgICB0YWtlLFxuICAgICAgICAgIHNraXAsXG4gICAgICAgICAgaW5jbHVkZToge1xuICAgICAgICAgICAgdXNlcjoge1xuICAgICAgICAgICAgICBzZWxlY3Q6IHtcbiAgICAgICAgICAgICAgICBpZDogdHJ1ZSxcbiAgICAgICAgICAgICAgICBmaXJzdE5hbWU6IHRydWUsXG4gICAgICAgICAgICAgICAgbGFzdE5hbWU6IHRydWUsXG4gICAgICAgICAgICAgICAgZW1haWw6IHRydWUsXG4gICAgICAgICAgICAgICAgYXZhdGFyVXJsOiB0cnVlLFxuICAgICAgICAgICAgICAgIGJpbzogdHJ1ZSxcbiAgICAgICAgICAgICAgICBjcmVhdGVkQXQ6IHRydWUsXG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgcmV2aWV3czoge1xuICAgICAgICAgICAgICBzZWxlY3Q6IHtcbiAgICAgICAgICAgICAgICByYXRpbmc6IHRydWUsXG4gICAgICAgICAgICAgICAgY29udGVudDogdHJ1ZSxcbiAgICAgICAgICAgICAgICBjcmVhdGVkQXQ6IHRydWUsXG4gICAgICAgICAgICAgICAgY2xpZW50OiB7XG4gICAgICAgICAgICAgICAgICBzZWxlY3Q6IHtcbiAgICAgICAgICAgICAgICAgICAgdXNlcjoge1xuICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdDoge1xuICAgICAgICAgICAgICAgICAgICAgICAgZmlyc3ROYW1lOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgICAgICAgbGFzdE5hbWU6IHRydWUsXG4gICAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgb3JkZXJCeToge1xuICAgICAgICAgICAgICAgIGNyZWF0ZWRBdDogJ2Rlc2MnLFxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICB0YWtlOiA1LCAvLyBMYXRlc3QgNSByZXZpZXdzXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0sXG4gICAgICAgICAgb3JkZXJCeToge1xuICAgICAgICAgICAgY3JlYXRlZEF0OiAnZGVzYycsXG4gICAgICAgICAgfSxcbiAgICAgICAgfSksXG4gICAgICAgIHRoaXMucHJpc21hLnRoZXJhcGlzdC5jb3VudCh7XG4gICAgICAgICAgd2hlcmU6IHtcbiAgICAgICAgICAgIHN0YXR1czogJ0FQUFJPVkVEJyxcbiAgICAgICAgICB9LFxuICAgICAgICB9KSxcbiAgICAgIF0pO1xuXG4gICAgICAvLyBUcmFuc2Zvcm0gZGF0YSB0byBtYXRjaCBmcm9udGVuZCBleHBlY3RhdGlvbnNcbiAgICAgIGNvbnN0IHRyYW5zZm9ybWVkVGhlcmFwaXN0cyA9IHRoZXJhcGlzdHMubWFwKCh0aGVyYXBpc3QpID0+IHtcbiAgICAgICAgY29uc3QgYXZlcmFnZVJhdGluZyA9XG4gICAgICAgICAgdGhlcmFwaXN0LnJldmlld3MubGVuZ3RoID4gMFxuICAgICAgICAgICAgPyB0aGVyYXBpc3QucmV2aWV3cy5yZWR1Y2UoXG4gICAgICAgICAgICAgICAgKHN1bSwgcmV2aWV3KSA9PiBzdW0gKyByZXZpZXcucmF0aW5nLFxuICAgICAgICAgICAgICAgIDAsXG4gICAgICAgICAgICAgICkgLyB0aGVyYXBpc3QucmV2aWV3cy5sZW5ndGhcbiAgICAgICAgICAgIDogMDtcblxuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIGlkOiB0aGVyYXBpc3QudXNlcklkLFxuICAgICAgICAgIHVzZXJJZDogdGhlcmFwaXN0LnVzZXJJZCxcbiAgICAgICAgICBmaXJzdE5hbWU6IHRoZXJhcGlzdC51c2VyLmZpcnN0TmFtZSxcbiAgICAgICAgICBsYXN0TmFtZTogdGhlcmFwaXN0LnVzZXIubGFzdE5hbWUsXG4gICAgICAgICAgbmFtZTogYCR7dGhlcmFwaXN0LnVzZXIuZmlyc3ROYW1lfSAke3RoZXJhcGlzdC51c2VyLmxhc3ROYW1lfWAsXG4gICAgICAgICAgZW1haWw6IHRoZXJhcGlzdC51c2VyLmVtYWlsLFxuICAgICAgICAgIGF2YXRhclVybDogdGhlcmFwaXN0LnVzZXIuYXZhdGFyVXJsLFxuICAgICAgICAgIHByb2ZpbGVJbWFnZTogdGhlcmFwaXN0LnVzZXIuYXZhdGFyVXJsLFxuICAgICAgICAgIGJpbzogdGhlcmFwaXN0LnVzZXIuYmlvLFxuICAgICAgICAgIHRpdGxlOiAnTGljZW5zZWQgVGhlcmFwaXN0JywgLy8gQ291bGQgYmUgbWFkZSBkeW5hbWljIGxhdGVyXG4gICAgICAgICAgc3BlY2lhbHRpZXM6IHRoZXJhcGlzdC5hcmVhc09mRXhwZXJ0aXNlIHx8IFtdLFxuICAgICAgICAgIGFyZWFzT2ZFeHBlcnRpc2U6IHRoZXJhcGlzdC5hcmVhc09mRXhwZXJ0aXNlIHx8IFtdLFxuICAgICAgICAgIGFwcHJvYWNoZXM6IHRoZXJhcGlzdC5hcHByb2FjaGVzIHx8IFtdLFxuICAgICAgICAgIGxhbmd1YWdlczogdGhlcmFwaXN0Lmxhbmd1YWdlcyB8fCBbXSxcbiAgICAgICAgICBpbGxuZXNzU3BlY2lhbGl6YXRpb25zOiB0aGVyYXBpc3QuaWxsbmVzc1NwZWNpYWxpemF0aW9ucyB8fCBbXSxcbiAgICAgICAgICBleHBlcmllbmNlOiB0aGVyYXBpc3QueWVhcnNPZkV4cGVyaWVuY2UgfHwgMCxcbiAgICAgICAgICB5ZWFyc09mRXhwZXJpZW5jZTogdGhlcmFwaXN0LnllYXJzT2ZFeHBlcmllbmNlIHx8IDAsXG4gICAgICAgICAgc2Vzc2lvblByaWNlOiBgJCR7dGhlcmFwaXN0LmhvdXJseVJhdGUudG9TdHJpbmcoKX1gLFxuICAgICAgICAgIGhvdXJseVJhdGU6IE51bWJlcih0aGVyYXBpc3QuaG91cmx5UmF0ZSksXG4gICAgICAgICAgcmF0aW5nOiBOdW1iZXIoYXZlcmFnZVJhdGluZy50b0ZpeGVkKDEpKSxcbiAgICAgICAgICB0b3RhbFJldmlld3M6ICh0aGVyYXBpc3QgYXMgYW55KS5yZXZpZXdzLmxlbmd0aCxcbiAgICAgICAgICBsb2NhdGlvbjogdGhlcmFwaXN0LnByb3ZpbmNlLFxuICAgICAgICAgIHByb3ZpbmNlOiB0aGVyYXBpc3QucHJvdmluY2UsXG4gICAgICAgICAgdGltZXpvbmU6IHRoZXJhcGlzdC50aW1lem9uZSxcbiAgICAgICAgICBpc0FjdGl2ZTogdHJ1ZSwgLy8gQWxsIGFwcHJvdmVkIHRoZXJhcGlzdHMgYXJlIGNvbnNpZGVyZWQgYWN0aXZlXG4gICAgICAgICAgYWNjZXB0c0luc3VyYW5jZTogdGhlcmFwaXN0LmFjY2VwdHNJbnN1cmFuY2UsXG4gICAgICAgICAgYWNjZXB0ZWRJbnN1cmFuY2VUeXBlczogdGhlcmFwaXN0LmFjY2VwdGVkSW5zdXJhbmNlVHlwZXMgfHwgW10sXG4gICAgICAgICAgc2Vzc2lvbkxlbmd0aDogdGhlcmFwaXN0LnNlc3Npb25MZW5ndGgsXG4gICAgICAgICAgcHJlZmVycmVkU2Vzc2lvbkxlbmd0aDogdGhlcmFwaXN0LnByZWZlcnJlZFNlc3Npb25MZW5ndGggfHwgW10sXG4gICAgICAgICAgY3JlYXRlZEF0OiB0aGVyYXBpc3QuY3JlYXRlZEF0LFxuICAgICAgICAgIHVwZGF0ZWRBdDogdGhlcmFwaXN0LnVwZGF0ZWRBdCxcbiAgICAgICAgfTtcbiAgICAgIH0pO1xuXG4gICAgICAvLyBIYW5kbGUgcGFnaW5hdGlvbiBjYWxjdWxhdGlvbiBzYWZlbHlcbiAgICAgIGNvbnN0IHBhZ2VTaXplID0gdGFrZSB8fCB0b3RhbENvdW50IHx8IDE7IC8vIFVzZSB0YWtlIGlmIHByb3ZpZGVkLCBvdGhlcndpc2UgdG90YWxDb3VudCwgb3IgMSBhcyBmYWxsYmFja1xuICAgICAgXG4gICAgICByZXR1cm4ge1xuICAgICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgICBkYXRhOiB7XG4gICAgICAgICAgdGhlcmFwaXN0czogdHJhbnNmb3JtZWRUaGVyYXBpc3RzLFxuICAgICAgICAgIHRvdGFsQ291bnQsXG4gICAgICAgICAgY3VycmVudFBhZ2U6IHRha2UgPyBNYXRoLmZsb29yKHNraXAgLyB0YWtlKSArIDEgOiAxLFxuICAgICAgICAgIHRvdGFsUGFnZXM6IE1hdGguY2VpbCh0b3RhbENvdW50IC8gcGFnZVNpemUpLFxuICAgICAgICAgIGhhc05leHRQYWdlOiB0YWtlID8gc2tpcCArIHRha2UgPCB0b3RhbENvdW50IDogZmFsc2UsXG4gICAgICAgICAgaGFzUHJldmlvdXNQYWdlOiBza2lwID4gMCxcbiAgICAgICAgfSxcbiAgICAgIH07XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRocm93IG5ldyBJbnRlcm5hbFNlcnZlckVycm9yRXhjZXB0aW9uKFxuICAgICAgICBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6ICdGYWlsZWQgdG8gZmV0Y2ggdGhlcmFwaXN0cycsXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIEBHZXQoJzppZCcpXG4gIEBBcGlPcGVyYXRpb24oe1xuICAgIHN1bW1hcnk6ICdHZXQgdGhlcmFwaXN0IHByb2ZpbGUgYnkgSUQnLFxuICAgIGRlc2NyaXB0aW9uOiAnUmV0cmlldmUgZGV0YWlsZWQgdGhlcmFwaXN0IHByb2ZpbGUgaW5mb3JtYXRpb24nLFxuICB9KVxuICBAQXBpUGFyYW0oe1xuICAgIG5hbWU6ICdpZCcsXG4gICAgZGVzY3JpcHRpb246ICdUaGVyYXBpc3QgdXNlciBJRCcsXG4gICAgdHlwZTogJ3N0cmluZycsXG4gIH0pXG4gIEBBcGlSZXNwb25zZSh7XG4gICAgc3RhdHVzOiAyMDAsXG4gICAgZGVzY3JpcHRpb246ICdSZXRyaWV2ZWQgc3VjY2Vzc2Z1bGx5JyxcbiAgfSlcbiAgQEFwaVJlc3BvbnNlKHsgc3RhdHVzOiA0MDQsIGRlc2NyaXB0aW9uOiAnVGhlcmFwaXN0IG5vdCBmb3VuZCcgfSlcbiAgQEFwaVJlc3BvbnNlKHsgc3RhdHVzOiA0MDEsIGRlc2NyaXB0aW9uOiAnVW5hdXRob3JpemVkJyB9KVxuICBASHR0cENvZGUoSHR0cFN0YXR1cy5PSylcbiAgYXN5bmMgZ2V0VGhlcmFwaXN0UHJvZmlsZShAUGFyYW0oJ2lkJykgdGhlcmFwaXN0SWQ6IHN0cmluZykge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCB0aGVyYXBpc3QgPSBhd2FpdCB0aGlzLnByaXNtYS50aGVyYXBpc3QuZmluZEZpcnN0KHtcbiAgICAgICAgd2hlcmU6IHtcbiAgICAgICAgICB1c2VySWQ6IHRoZXJhcGlzdElkLFxuICAgICAgICAgIHN0YXR1czogJ0FQUFJPVkVEJyxcbiAgICAgICAgfSxcbiAgICAgICAgaW5jbHVkZToge1xuICAgICAgICAgIHVzZXI6IHtcbiAgICAgICAgICAgIHNlbGVjdDoge1xuICAgICAgICAgICAgICBpZDogdHJ1ZSxcbiAgICAgICAgICAgICAgZmlyc3ROYW1lOiB0cnVlLFxuICAgICAgICAgICAgICBsYXN0TmFtZTogdHJ1ZSxcbiAgICAgICAgICAgICAgZW1haWw6IHRydWUsXG4gICAgICAgICAgICAgIGF2YXRhclVybDogdHJ1ZSxcbiAgICAgICAgICAgICAgYmlvOiB0cnVlLFxuICAgICAgICAgICAgICBjcmVhdGVkQXQ6IHRydWUsXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0sXG4gICAgICAgICAgcmV2aWV3czoge1xuICAgICAgICAgICAgc2VsZWN0OiB7XG4gICAgICAgICAgICAgIGlkOiB0cnVlLFxuICAgICAgICAgICAgICByYXRpbmc6IHRydWUsXG4gICAgICAgICAgICAgIGNvbnRlbnQ6IHRydWUsXG4gICAgICAgICAgICAgIGNyZWF0ZWRBdDogdHJ1ZSxcbiAgICAgICAgICAgICAgY2xpZW50OiB7XG4gICAgICAgICAgICAgICAgc2VsZWN0OiB7XG4gICAgICAgICAgICAgICAgICB1c2VyOiB7XG4gICAgICAgICAgICAgICAgICAgIHNlbGVjdDoge1xuICAgICAgICAgICAgICAgICAgICAgIGZpcnN0TmFtZTogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgICAgICBsYXN0TmFtZTogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgICAgICBhdmF0YXJVcmw6IHRydWUsXG4gICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgb3JkZXJCeToge1xuICAgICAgICAgICAgICBjcmVhdGVkQXQ6ICdkZXNjJyxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB0YWtlOiAxMCwgLy8gR2V0IG1vcmUgcmV2aWV3cyBmb3IgcHJvZmlsZSBwYWdlXG4gICAgICAgICAgfSxcbiAgICAgICAgICB0aGVyYXBpc3RBdmFpbGFiaWxpdGllczoge1xuICAgICAgICAgICAgc2VsZWN0OiB7XG4gICAgICAgICAgICAgIGRheU9mV2VlazogdHJ1ZSxcbiAgICAgICAgICAgICAgc3RhcnRUaW1lOiB0cnVlLFxuICAgICAgICAgICAgICBlbmRUaW1lOiB0cnVlLFxuICAgICAgICAgICAgICBpc0F2YWlsYWJsZTogdHJ1ZSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB3aGVyZToge1xuICAgICAgICAgICAgICBpc0F2YWlsYWJsZTogdHJ1ZSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgIH0pO1xuXG4gICAgICBpZiAoIXRoZXJhcGlzdCkge1xuICAgICAgICB0aHJvdyBuZXcgTm90Rm91bmRFeGNlcHRpb24oXG4gICAgICAgICAgYFRoZXJhcGlzdCB3aXRoIElEICR7dGhlcmFwaXN0SWR9IG5vdCBmb3VuZGAsXG4gICAgICAgICk7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IGF2ZXJhZ2VSYXRpbmcgPVxuICAgICAgICB0aGVyYXBpc3QucmV2aWV3cy5sZW5ndGggPiAwXG4gICAgICAgICAgPyB0aGVyYXBpc3QucmV2aWV3cy5yZWR1Y2UoKHN1bSwgcmV2aWV3KSA9PiBzdW0gKyByZXZpZXcucmF0aW5nLCAwKSAvXG4gICAgICAgICAgICB0aGVyYXBpc3QucmV2aWV3cy5sZW5ndGhcbiAgICAgICAgICA6IDA7XG5cbiAgICAgIGNvbnN0IHRyYW5zZm9ybWVkVGhlcmFwaXN0ID0ge1xuICAgICAgICBpZDogdGhlcmFwaXN0LnVzZXJJZCxcbiAgICAgICAgdXNlcklkOiB0aGVyYXBpc3QudXNlcklkLFxuICAgICAgICBmaXJzdE5hbWU6IHRoZXJhcGlzdC51c2VyLmZpcnN0TmFtZSxcbiAgICAgICAgbGFzdE5hbWU6IHRoZXJhcGlzdC51c2VyLmxhc3ROYW1lLFxuICAgICAgICBuYW1lOiBgJHt0aGVyYXBpc3QudXNlci5maXJzdE5hbWV9ICR7dGhlcmFwaXN0LnVzZXIubGFzdE5hbWV9YCxcbiAgICAgICAgZW1haWw6IHRoZXJhcGlzdC51c2VyLmVtYWlsLFxuICAgICAgICBhdmF0YXJVcmw6IHRoZXJhcGlzdC51c2VyLmF2YXRhclVybCxcbiAgICAgICAgcHJvZmlsZUltYWdlOiB0aGVyYXBpc3QudXNlci5hdmF0YXJVcmwsXG4gICAgICAgIGJpbzogdGhlcmFwaXN0LnVzZXIuYmlvLFxuICAgICAgICB0aXRsZTogJ0xpY2Vuc2VkIFRoZXJhcGlzdCcsXG4gICAgICAgIHNwZWNpYWx0aWVzOiB0aGVyYXBpc3QuYXJlYXNPZkV4cGVydGlzZSB8fCBbXSxcbiAgICAgICAgYXJlYXNPZkV4cGVydGlzZTogdGhlcmFwaXN0LmFyZWFzT2ZFeHBlcnRpc2UgfHwgW10sXG4gICAgICAgIGFwcHJvYWNoZXM6IHRoZXJhcGlzdC5hcHByb2FjaGVzIHx8IFtdLFxuICAgICAgICBsYW5ndWFnZXM6IHRoZXJhcGlzdC5sYW5ndWFnZXMgfHwgW10sXG4gICAgICAgIGlsbG5lc3NTcGVjaWFsaXphdGlvbnM6IHRoZXJhcGlzdC5pbGxuZXNzU3BlY2lhbGl6YXRpb25zIHx8IFtdLFxuICAgICAgICBleHBlcmllbmNlOiB0aGVyYXBpc3QueWVhcnNPZkV4cGVyaWVuY2UgfHwgMCxcbiAgICAgICAgeWVhcnNPZkV4cGVyaWVuY2U6IHRoZXJhcGlzdC55ZWFyc09mRXhwZXJpZW5jZSB8fCAwLFxuICAgICAgICBzZXNzaW9uUHJpY2U6IGAkJHt0aGVyYXBpc3QuaG91cmx5UmF0ZS50b1N0cmluZygpfWAsXG4gICAgICAgIGhvdXJseVJhdGU6IHRoZXJhcGlzdC5ob3VybHlSYXRlLFxuICAgICAgICByYXRpbmc6IE51bWJlcihhdmVyYWdlUmF0aW5nLnRvRml4ZWQoMSkpLFxuICAgICAgICB0b3RhbFJldmlld3M6ICh0aGVyYXBpc3QgYXMgYW55KS5yZXZpZXdzLmxlbmd0aCxcbiAgICAgICAgbG9jYXRpb246IHRoZXJhcGlzdC5wcm92aW5jZSxcbiAgICAgICAgcHJvdmluY2U6IHRoZXJhcGlzdC5wcm92aW5jZSxcbiAgICAgICAgdGltZXpvbmU6IHRoZXJhcGlzdC50aW1lem9uZSxcbiAgICAgICAgaXNBY3RpdmU6IHRydWUsXG4gICAgICAgIGFjY2VwdHNJbnN1cmFuY2U6IHRoZXJhcGlzdC5hY2NlcHRzSW5zdXJhbmNlLFxuICAgICAgICBhY2NlcHRlZEluc3VyYW5jZVR5cGVzOiB0aGVyYXBpc3QuYWNjZXB0ZWRJbnN1cmFuY2VUeXBlcyB8fCBbXSxcbiAgICAgICAgc2Vzc2lvbkxlbmd0aDogdGhlcmFwaXN0LnNlc3Npb25MZW5ndGgsXG4gICAgICAgIHByZWZlcnJlZFNlc3Npb25MZW5ndGg6IHRoZXJhcGlzdC5wcmVmZXJyZWRTZXNzaW9uTGVuZ3RoIHx8IFtdLFxuICAgICAgICBhdmFpbGFiaWxpdHk6IHRoZXJhcGlzdC50aGVyYXBpc3RBdmFpbGFiaWxpdGllcyxcbiAgICAgICAgcmV2aWV3czogdGhlcmFwaXN0LnJldmlld3MubWFwKChyZXZpZXcpID0+ICh7XG4gICAgICAgICAgaWQ6IHJldmlldy5pZCxcbiAgICAgICAgICByYXRpbmc6IHJldmlldy5yYXRpbmcsXG4gICAgICAgICAgY29tbWVudDogcmV2aWV3LmNvbnRlbnQsXG4gICAgICAgICAgY3JlYXRlZEF0OiByZXZpZXcuY3JlYXRlZEF0LFxuICAgICAgICAgIGNsaWVudE5hbWU6IGAke3Jldmlldy5jbGllbnQudXNlci5maXJzdE5hbWV9ICR7cmV2aWV3LmNsaWVudC51c2VyLmxhc3ROYW1lWzBdfS5gLFxuICAgICAgICAgIGNsaWVudEF2YXRhcjogcmV2aWV3LmNsaWVudC51c2VyLmF2YXRhclVybCxcbiAgICAgICAgfSkpLFxuICAgICAgICBjcmVhdGVkQXQ6IHRoZXJhcGlzdC5jcmVhdGVkQXQsXG4gICAgICAgIHVwZGF0ZWRBdDogdGhlcmFwaXN0LnVwZGF0ZWRBdCxcblxuICAgICAgICAvLyBBZGRpdGlvbmFsIHByb2ZpbGUgZmllbGRzXG4gICAgICAgIGVkdWNhdGlvbkJhY2tncm91bmQ6IHRoZXJhcGlzdC5lZHVjYXRpb25CYWNrZ3JvdW5kLFxuICAgICAgICBzcGVjaWFsQ2VydGlmaWNhdGlvbnM6IHRoZXJhcGlzdC5zcGVjaWFsQ2VydGlmaWNhdGlvbnMgfHwgW10sXG4gICAgICAgIHByYWN0aWNlTG9jYXRpb246IHRoZXJhcGlzdC5wcmFjdGljZUxvY2F0aW9uLFxuICAgICAgICB0aGVyYXBldXRpY0FwcHJvYWNoZXNVc2VkTGlzdDpcbiAgICAgICAgICB0aGVyYXBpc3QudGhlcmFwZXV0aWNBcHByb2FjaGVzVXNlZExpc3QgfHwgW10sXG4gICAgICAgIGFzc2Vzc21lbnRUb29sczogdGhlcmFwaXN0LmFzc2Vzc21lbnRUb29scyB8fCBbXSxcbiAgICAgICAgbGFuZ3VhZ2VzT2ZmZXJlZDogdGhlcmFwaXN0Lmxhbmd1YWdlc09mZmVyZWQgfHwgW10sXG4gICAgICAgIHByb3ZpZGVkT25saW5lVGhlcmFweUJlZm9yZTogdGhlcmFwaXN0LnByb3ZpZGVkT25saW5lVGhlcmFweUJlZm9yZSxcbiAgICAgICAgY29tZm9ydGFibGVVc2luZ1ZpZGVvQ29uZmVyZW5jaW5nOlxuICAgICAgICAgIHRoZXJhcGlzdC5jb21mb3J0YWJsZVVzaW5nVmlkZW9Db25mZXJlbmNpbmcsXG4gICAgICAgIHByb2Zlc3Npb25hbExpY2Vuc2VUeXBlOiB0aGVyYXBpc3QucHJvZmVzc2lvbmFsTGljZW5zZVR5cGUsXG4gICAgICAgIGxpY2Vuc2VWZXJpZmllZDogdGhlcmFwaXN0LmxpY2Vuc2VWZXJpZmllZCxcbiAgICAgICAgcHJhY3RpY2VTdGFydERhdGU6IHRoZXJhcGlzdC5wcmFjdGljZVN0YXJ0RGF0ZSxcbiAgICAgIH07XG5cbiAgICAgIHJldHVybiB7XG4gICAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICAgIGRhdGE6IHRyYW5zZm9ybWVkVGhlcmFwaXN0LFxuICAgICAgfTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgaWYgKGVycm9yIGluc3RhbmNlb2YgTm90Rm91bmRFeGNlcHRpb24pIHtcbiAgICAgICAgdGhyb3cgZXJyb3I7XG4gICAgICB9XG4gICAgICB0aHJvdyBuZXcgSW50ZXJuYWxTZXJ2ZXJFcnJvckV4Y2VwdGlvbihcbiAgICAgICAgZXJyb3IgaW5zdGFuY2VvZiBFcnJvclxuICAgICAgICAgID8gZXJyb3IubWVzc2FnZVxuICAgICAgICAgIDogJ0ZhaWxlZCB0byBmZXRjaCB0aGVyYXBpc3QgcHJvZmlsZScsXG4gICAgICApO1xuICAgIH1cbiAgfVxufVxuIl0sInZlcnNpb24iOjN9