61efe2009d949b8300b922d5060efc21
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var __param = (this && this.__param) || function (paramIndex, decorator) {
    return function (target, key) { decorator(target, key, paramIndex); }
};
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
exports.BookingController = void 0;
const common_1 = require("@nestjs/common");
const jwt_auth_guard_1 = require("../auth/guards/jwt-auth.guard");
const current_user_id_decorator_1 = require("../auth/decorators/current-user-id.decorator");
const current_user_role_decorator_1 = require("../auth/decorators/current-user-role.decorator");
const zod_validation_pipe_1 = require("../common/pipes/zod-validation.pipe");
const booking_service_1 = require("./booking.service");
const booking_schemas_1 = require("./validation/booking.schemas");
let BookingController = class BookingController {
    bookingService;
    constructor(bookingService) {
        this.bookingService = bookingService;
    }
    // Meeting endpoints
    async createMeeting(createMeetingDto, userId, role) {
        // Only clients can book meetings, but we'll validate the relationship in the service
        if (role !== 'client') {
            throw new common_1.ForbiddenException('Only clients can book meetings');
        }
        return this.bookingService.createMeeting(createMeetingDto, userId);
    }
    async getMeetings(userId, role) {
        return this.bookingService.getMeetings(userId, role);
    }
    async getMeeting(params, userId, role) {
        return this.bookingService.getMeeting(params.id, userId, role);
    }
    async updateMeeting(params, updateMeetingDto, userId, role) {
        return this.bookingService.updateMeeting(params.id, updateMeetingDto, userId, role);
    }
    async cancelMeeting(params, userId, role) {
        return this.bookingService.cancelMeeting(params.id, userId, role);
    }
    // Availability endpoints (therapist only)
    async createAvailability(createAvailabilityDto, therapistId, role) {
        if (role !== 'therapist') {
            throw new common_1.UnauthorizedException('Only therapists can manage availability');
        }
        return this.bookingService.createAvailability(createAvailabilityDto, therapistId);
    }
    async getAvailability(therapistId, role) {
        if (role !== 'therapist') {
            throw new common_1.UnauthorizedException('Only therapists can view their availability');
        }
        return this.bookingService.getAvailability(therapistId);
    }
    async updateAvailability(params, updateAvailabilityDto, therapistId, role) {
        if (role !== 'therapist') {
            throw new common_1.UnauthorizedException('Only therapists can update availability');
        }
        return this.bookingService.updateAvailability(params.id, updateAvailabilityDto, therapistId);
    }
    async deleteAvailability(params, therapistId, role) {
        if (role !== 'therapist') {
            throw new common_1.UnauthorizedException('Only therapists can delete availability');
        }
        return this.bookingService.deleteAvailability(params.id, therapistId);
    }
    // Duration endpoints (public)
    getDurations() {
        return this.bookingService.getDurations();
    }
    // Available slots endpoint
    async getAvailableSlots(query) {
        return this.bookingService.getAvailableSlots(query.therapistId, query.date);
    }
};
exports.BookingController = BookingController;
__decorate([
    (0, common_1.Post)('meetings'),
    __param(0, (0, common_1.Body)()),
    __param(1, (0, current_user_id_decorator_1.CurrentUserId)()),
    __param(2, (0, current_user_role_decorator_1.CurrentUserRole)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Object, String, String]),
    __metadata("design:returntype", Promise)
], BookingController.prototype, "createMeeting", null);
__decorate([
    (0, common_1.Get)('meetings'),
    __param(0, (0, current_user_id_decorator_1.CurrentUserId)()),
    __param(1, (0, current_user_role_decorator_1.CurrentUserRole)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [String, String]),
    __metadata("design:returntype", Promise)
], BookingController.prototype, "getMeetings", null);
__decorate([
    (0, common_1.Get)('meetings/:id'),
    __param(0, (0, common_1.Param)(new zod_validation_pipe_1.ZodValidationPipe(booking_schemas_1.BookingMeetingParamsDtoSchema))),
    __param(1, (0, current_user_id_decorator_1.CurrentUserId)()),
    __param(2, (0, current_user_role_decorator_1.CurrentUserRole)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Object, String, String]),
    __metadata("design:returntype", Promise)
], BookingController.prototype, "getMeeting", null);
__decorate([
    (0, common_1.Put)('meetings/:id'),
    __param(0, (0, common_1.Param)(new zod_validation_pipe_1.ZodValidationPipe(booking_schemas_1.BookingMeetingParamsDtoSchema))),
    __param(1, (0, common_1.Body)()),
    __param(2, (0, current_user_id_decorator_1.CurrentUserId)()),
    __param(3, (0, current_user_role_decorator_1.CurrentUserRole)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Object, Object, String, String]),
    __metadata("design:returntype", Promise)
], BookingController.prototype, "updateMeeting", null);
__decorate([
    (0, common_1.Delete)('meetings/:id/cancel'),
    __param(0, (0, common_1.Param)(new zod_validation_pipe_1.ZodValidationPipe(booking_schemas_1.BookingMeetingParamsDtoSchema))),
    __param(1, (0, current_user_id_decorator_1.CurrentUserId)()),
    __param(2, (0, current_user_role_decorator_1.CurrentUserRole)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Object, String, String]),
    __metadata("design:returntype", Promise)
], BookingController.prototype, "cancelMeeting", null);
__decorate([
    (0, common_1.Post)('availability'),
    __param(0, (0, common_1.Body)()),
    __param(1, (0, current_user_id_decorator_1.CurrentUserId)()),
    __param(2, (0, current_user_role_decorator_1.CurrentUserRole)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Object, String, String]),
    __metadata("design:returntype", Promise)
], BookingController.prototype, "createAvailability", null);
__decorate([
    (0, common_1.Get)('availability'),
    __param(0, (0, current_user_id_decorator_1.CurrentUserId)()),
    __param(1, (0, current_user_role_decorator_1.CurrentUserRole)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [String, String]),
    __metadata("design:returntype", Promise)
], BookingController.prototype, "getAvailability", null);
__decorate([
    (0, common_1.Put)('availability/:id'),
    __param(0, (0, common_1.Param)(new zod_validation_pipe_1.ZodValidationPipe(booking_schemas_1.AvailabilityParamsDtoSchema))),
    __param(1, (0, common_1.Body)()),
    __param(2, (0, current_user_id_decorator_1.CurrentUserId)()),
    __param(3, (0, current_user_role_decorator_1.CurrentUserRole)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Object, Object, String, String]),
    __metadata("design:returntype", Promise)
], BookingController.prototype, "updateAvailability", null);
__decorate([
    (0, common_1.Delete)('availability/:id'),
    __param(0, (0, common_1.Param)(new zod_validation_pipe_1.ZodValidationPipe(booking_schemas_1.AvailabilityParamsDtoSchema))),
    __param(1, (0, current_user_id_decorator_1.CurrentUserId)()),
    __param(2, (0, current_user_role_decorator_1.CurrentUserRole)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Object, String, String]),
    __metadata("design:returntype", Promise)
], BookingController.prototype, "deleteAvailability", null);
__decorate([
    (0, common_1.Get)('durations'),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", []),
    __metadata("design:returntype", void 0)
], BookingController.prototype, "getDurations", null);
__decorate([
    (0, common_1.Get)('slots'),
    __param(0, (0, common_1.Query)(new zod_validation_pipe_1.ZodValidationPipe(booking_schemas_1.GetAvailableSlotsQueryDtoSchema))),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Object]),
    __metadata("design:returntype", Promise)
], BookingController.prototype, "getAvailableSlots", null);
exports.BookingController = BookingController = __decorate([
    (0, common_1.Controller)('booking'),
    (0, common_1.UseGuards)(jwt_auth_guard_1.JwtAuthGuard),
    __metadata("design:paramtypes", [typeof (_a = typeof booking_service_1.BookingService !== "undefined" && booking_service_1.BookingService) === "function" ? _a : Object])
], BookingController);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL2Jvb2tpbmcvYm9va2luZy5jb250cm9sbGVyLnRzIiwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQSwyQ0FZd0I7QUFDeEIsa0VBQTZEO0FBQzdELDRGQUE2RTtBQUM3RSxnR0FBaUY7QUFDakYsNkVBQXdFO0FBQ3hFLHVEQUFtRDtBQUNuRCxrRUFJc0M7QUFhL0IsSUFBTSxpQkFBaUIsR0FBdkIsTUFBTSxpQkFBaUI7SUFDQztJQUE3QixZQUE2QixjQUE4QjtRQUE5QixtQkFBYyxHQUFkLGNBQWMsQ0FBZ0I7SUFBRyxDQUFDO0lBRS9ELG9CQUFvQjtJQUVkLEFBQU4sS0FBSyxDQUFDLGFBQWEsQ0FDVCxnQkFBa0MsRUFDekIsTUFBYyxFQUNaLElBQVk7UUFFL0IscUZBQXFGO1FBQ3JGLElBQUksSUFBSSxLQUFLLFFBQVEsRUFBRSxDQUFDO1lBQ3RCLE1BQU0sSUFBSSwyQkFBa0IsQ0FBQyxnQ0FBZ0MsQ0FBQyxDQUFDO1FBQ2pFLENBQUM7UUFDRCxPQUFPLElBQUksQ0FBQyxjQUFjLENBQUMsYUFBYSxDQUFDLGdCQUFnQixFQUFFLE1BQU0sQ0FBQyxDQUFDO0lBQ3JFLENBQUM7SUFHSyxBQUFOLEtBQUssQ0FBQyxXQUFXLENBQ0UsTUFBYyxFQUNaLElBQVk7UUFFL0IsT0FBTyxJQUFJLENBQUMsY0FBYyxDQUFDLFdBQVcsQ0FBQyxNQUFNLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFDdkQsQ0FBQztJQUdLLEFBQU4sS0FBSyxDQUFDLFVBQVUsQ0FFZCxNQUErQixFQUNkLE1BQWMsRUFDWixJQUFZO1FBRS9CLE9BQU8sSUFBSSxDQUFDLGNBQWMsQ0FBQyxVQUFVLENBQUMsTUFBTSxDQUFDLEVBQUUsRUFBRSxNQUFNLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFDakUsQ0FBQztJQUdLLEFBQU4sS0FBSyxDQUFDLGFBQWEsQ0FFakIsTUFBK0IsRUFDdkIsZ0JBQWtDLEVBQ3pC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Q0FBQTtJQUNmLFdBQUEsSUFBQSw2Q0FBZSxHQUFFLENBQUE7Ozs7MkRBWW5CO0FBR0s7SUFETCxJQUFBLGVBQU0sRUFBQyxrQkFBa0IsQ0FBQztJQUV4QixXQUFBLElBQUEsY0FBSyxFQUFDLElBQUksdUNBQWlCLENBQUMsNkNBQTJCLENBQUMsQ0FBQyxDQUFBO0lBRXpELFdBQUEsSUFBQSx5Q0FBYSxHQUFFLENBQUE7SUFDZixXQUFBLElBQUEsNkNBQWUsR0FBRSxDQUFBOzs7OzJEQVFuQjtBQUlEO0lBREMsSUFBQSxZQUFHLEVBQUMsV0FBVyxDQUFDOzs7O3FEQUdoQjtBQUlLO0lBREwsSUFBQSxZQUFHLEVBQUMsT0FBTyxDQUFDO0lBRVYsV0FBQSxJQUFBLGNBQUssRUFBQyxJQUFJLHVDQUFpQixDQUFDLGlEQUErQixDQUFDLENBQUMsQ0FBQTs7OzswREFJL0Q7NEJBNUlVLGlCQUFpQjtJQUY3QixJQUFBLG1CQUFVLEVBQUMsU0FBUyxDQUFDO0lBQ3JCLElBQUEsa0JBQVMsRUFBQyw2QkFBWSxDQUFDO3lEQUV1QixnQ0FBYyxvQkFBZCxnQ0FBYztHQURoRCxpQkFBaUIsQ0E2STdCIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9ob21lL3dldG9vYS9Eb2N1bWVudHMvY29kZS9wcm9qZWN0cy9tZW50YXJhL21lbnRhcmEtYXBpL3NyYy9ib29raW5nL2Jvb2tpbmcuY29udHJvbGxlci50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBCb2R5LFxuICBDb250cm9sbGVyLFxuICBEZWxldGUsXG4gIEdldCxcbiAgUGFyYW0sXG4gIFBvc3QsXG4gIFB1dCxcbiAgUXVlcnksXG4gIFVzZUd1YXJkcyxcbiAgVW5hdXRob3JpemVkRXhjZXB0aW9uLFxuICBGb3JiaWRkZW5FeGNlcHRpb24sXG59IGZyb20gJ0BuZXN0anMvY29tbW9uJztcbmltcG9ydCB7IEp3dEF1dGhHdWFyZCB9IGZyb20gJy4uL2F1dGgvZ3VhcmRzL2p3dC1hdXRoLmd1YXJkJztcbmltcG9ydCB7IEN1cnJlbnRVc2VySWQgfSBmcm9tICcuLi9hdXRoL2RlY29yYXRvcnMvY3VycmVudC11c2VyLWlkLmRlY29yYXRvcic7XG5pbXBvcnQgeyBDdXJyZW50VXNlclJvbGUgfSBmcm9tICcuLi9hdXRoL2RlY29yYXRvcnMvY3VycmVudC11c2VyLXJvbGUuZGVjb3JhdG9yJztcbmltcG9ydCB7IFpvZFZhbGlkYXRpb25QaXBlIH0gZnJvbSAnLi4vY29tbW9uL3BpcGVzL3pvZC12YWxpZGF0aW9uLnBpcGUnO1xuaW1wb3J0IHsgQm9va2luZ1NlcnZpY2UgfSBmcm9tICcuL2Jvb2tpbmcuc2VydmljZSc7XG5pbXBvcnQge1xuICBCb29raW5nTWVldGluZ1BhcmFtc0R0b1NjaGVtYSxcbiAgQXZhaWxhYmlsaXR5UGFyYW1zRHRvU2NoZW1hLFxuICBHZXRBdmFpbGFibGVTbG90c1F1ZXJ5RHRvU2NoZW1hLFxufSBmcm9tICcuL3ZhbGlkYXRpb24vYm9va2luZy5zY2hlbWFzJztcbmltcG9ydCB0eXBlIHtcbiAgVGhlcmFwaXN0QXZhaWxhYmlsaXR5Q3JlYXRlRHRvLFxuICBUaGVyYXBpc3RBdmFpbGFiaWxpdHlVcGRhdGVEdG8sXG4gIE1lZXRpbmdDcmVhdGVEdG8sXG4gIE1lZXRpbmdVcGRhdGVEdG8sXG4gIEJvb2tpbmdNZWV0aW5nUGFyYW1zRHRvLFxuICBBdmFpbGFiaWxpdHlQYXJhbXNEdG8sXG4gIEdldEF2YWlsYWJsZVNsb3RzUXVlcnlEdG8sXG59IGZyb20gJy4vdHlwZXMnO1xuXG5AQ29udHJvbGxlcignYm9va2luZycpXG5AVXNlR3VhcmRzKEp3dEF1dGhHdWFyZClcbmV4cG9ydCBjbGFzcyBCb29raW5nQ29udHJvbGxlciB7XG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgcmVhZG9ubHkgYm9va2luZ1NlcnZpY2U6IEJvb2tpbmdTZXJ2aWNlKSB7fVxuXG4gIC8vIE1lZXRpbmcgZW5kcG9pbnRzXG4gIEBQb3N0KCdtZWV0aW5ncycpXG4gIGFzeW5jIGNyZWF0ZU1lZXRpbmcoXG4gICAgQEJvZHkoKSBjcmVhdGVNZWV0aW5nRHRvOiBNZWV0aW5nQ3JlYXRlRHRvLFxuICAgIEBDdXJyZW50VXNlcklkKCkgdXNlcklkOiBzdHJpbmcsXG4gICAgQEN1cnJlbnRVc2VyUm9sZSgpIHJvbGU6IHN0cmluZyxcbiAgKSB7XG4gICAgLy8gT25seSBjbGllbnRzIGNhbiBib29rIG1lZXRpbmdzLCBidXQgd2UnbGwgdmFsaWRhdGUgdGhlIHJlbGF0aW9uc2hpcCBpbiB0aGUgc2VydmljZVxuICAgIGlmIChyb2xlICE9PSAnY2xpZW50Jykge1xuICAgICAgdGhyb3cgbmV3IEZvcmJpZGRlbkV4Y2VwdGlvbignT25seSBjbGllbnRzIGNhbiBib29rIG1lZXRpbmdzJyk7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLmJvb2tpbmdTZXJ2aWNlLmNyZWF0ZU1lZXRpbmcoY3JlYXRlTWVldGluZ0R0bywgdXNlcklkKTtcbiAgfVxuXG4gIEBHZXQoJ21lZXRpbmdzJylcbiAgYXN5bmMgZ2V0TWVldGluZ3MoXG4gICAgQEN1cnJlbnRVc2VySWQoKSB1c2VySWQ6IHN0cmluZyxcbiAgICBAQ3VycmVudFVzZXJSb2xlKCkgcm9sZTogc3RyaW5nLFxuICApIHtcbiAgICByZXR1cm4gdGhpcy5ib29raW5nU2VydmljZS5nZXRNZWV0aW5ncyh1c2VySWQsIHJvbGUpO1xuICB9XG5cbiAgQEdldCgnbWVldGluZ3MvOmlkJylcbiAgYXN5bmMgZ2V0TWVldGluZyhcbiAgICBAUGFyYW0obmV3IFpvZFZhbGlkYXRpb25QaXBlKEJvb2tpbmdNZWV0aW5nUGFyYW1zRHRvU2NoZW1hKSlcbiAgICBwYXJhbXM6IEJvb2tpbmdNZWV0aW5nUGFyYW1zRHRvLFxuICAgIEBDdXJyZW50VXNlcklkKCkgdXNlcklkOiBzdHJpbmcsXG4gICAgQEN1cnJlbnRVc2VyUm9sZSgpIHJvbGU6IHN0cmluZyxcbiAgKSB7XG4gICAgcmV0dXJuIHRoaXMuYm9va2luZ1NlcnZpY2UuZ2V0TWVldGluZyhwYXJhbXMuaWQsIHVzZXJJZCwgcm9sZSk7XG4gIH1cblxuICBAUHV0KCdtZWV0aW5ncy86aWQnKVxuICBhc3luYyB1cGRhdGVNZWV0aW5nKFxuICAgIEBQYXJhbShuZXcgWm9kVmFsaWRhdGlvblBpcGUoQm9va2luZ01lZXRpbmdQYXJhbXNEdG9TY2hlbWEpKVxuICAgIHBhcmFtczogQm9va2luZ01lZXRpbmdQYXJhbXNEdG8sXG4gICAgQEJvZHkoKSB1cGRhdGVNZWV0aW5nRHRvOiBNZWV0aW5nVXBkYXRlRHRvLFxuICAgIEBDdXJyZW50VXNlcklkKCkgdXNlcklkOiBzdHJpbmcsXG4gICAgQEN1cnJlbnRVc2VyUm9sZSgpIHJvbGU6IHN0cmluZyxcbiAgKSB7XG4gICAgcmV0dXJuIHRoaXMuYm9va2luZ1NlcnZpY2UudXBkYXRlTWVldGluZyhcbiAgICAgIHBhcmFtcy5pZCxcbiAgICAgIHVwZGF0ZU1lZXRpbmdEdG8sXG4gICAgICB1c2VySWQsXG4gICAgICByb2xlLFxuICAgICk7XG4gIH1cblxuICBARGVsZXRlKCdtZWV0aW5ncy86aWQvY2FuY2VsJylcbiAgYXN5bmMgY2FuY2VsTWVldGluZyhcbiAgICBAUGFyYW0obmV3IFpvZFZhbGlkYXRpb25QaXBlKEJvb2tpbmdNZWV0aW5nUGFyYW1zRHRvU2NoZW1hKSlcbiAgICBwYXJhbXM6IEJvb2tpbmdNZWV0aW5nUGFyYW1zRHRvLFxuICAgIEBDdXJyZW50VXNlcklkKCkgdXNlcklkOiBzdHJpbmcsXG4gICAgQEN1cnJlbnRVc2VyUm9sZSgpIHJvbGU6IHN0cmluZyxcbiAgKSB7XG4gICAgcmV0dXJuIHRoaXMuYm9va2luZ1NlcnZpY2UuY2FuY2VsTWVldGluZyhwYXJhbXMuaWQsIHVzZXJJZCwgcm9sZSk7XG4gIH1cblxuICAvLyBBdmFpbGFiaWxpdHkgZW5kcG9pbnRzICh0aGVyYXBpc3Qgb25seSlcbiAgQFBvc3QoJ2F2YWlsYWJpbGl0eScpXG4gIGFzeW5jIGNyZWF0ZUF2YWlsYWJpbGl0eShcbiAgICBAQm9keSgpIGNyZWF0ZUF2YWlsYWJpbGl0eUR0bzogVGhlcmFwaXN0QXZhaWxhYmlsaXR5Q3JlYXRlRHRvLFxuICAgIEBDdXJyZW50VXNlcklkKCkgdGhlcmFwaXN0SWQ6IHN0cmluZyxcbiAgICBAQ3VycmVudFVzZXJSb2xlKCkgcm9sZTogc3RyaW5nLFxuICApIHtcbiAgICBpZiAocm9sZSAhPT0gJ3RoZXJhcGlzdCcpIHtcbiAgICAgIHRocm93IG5ldyBVbmF1dGhvcml6ZWRFeGNlcHRpb24oXG4gICAgICAgICdPbmx5IHRoZXJhcGlzdHMgY2FuIG1hbmFnZSBhdmFpbGFiaWxpdHknLFxuICAgICAgKTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuYm9va2luZ1NlcnZpY2UuY3JlYXRlQXZhaWxhYmlsaXR5KFxuICAgICAgY3JlYXRlQXZhaWxhYmlsaXR5RHRvLFxuICAgICAgdGhlcmFwaXN0SWQsXG4gICAgKTtcbiAgfVxuXG4gIEBHZXQoJ2F2YWlsYWJpbGl0eScpXG4gIGFzeW5jIGdldEF2YWlsYWJpbGl0eShcbiAgICBAQ3VycmVudFVzZXJJZCgpIHRoZXJhcGlzdElkOiBzdHJpbmcsXG4gICAgQEN1cnJlbnRVc2VyUm9sZSgpIHJvbGU6IHN0cmluZyxcbiAgKSB7XG4gICAgaWYgKHJvbGUgIT09ICd0aGVyYXBpc3QnKSB7XG4gICAgICB0aHJvdyBuZXcgVW5hdXRob3JpemVkRXhjZXB0aW9uKFxuICAgICAgICAnT25seSB0aGVyYXBpc3RzIGNhbiB2aWV3IHRoZWlyIGF2YWlsYWJpbGl0eScsXG4gICAgICApO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy5ib29raW5nU2VydmljZS5nZXRBdmFpbGFiaWxpdHkodGhlcmFwaXN0SWQpO1xuICB9XG5cbiAgQFB1dCgnYXZhaWxhYmlsaXR5LzppZCcpXG4gIGFzeW5jIHVwZGF0ZUF2YWlsYWJpbGl0eShcbiAgICBAUGFyYW0obmV3IFpvZFZhbGlkYXRpb25QaXBlKEF2YWlsYWJpbGl0eVBhcmFtc0R0b1NjaGVtYSkpXG4gICAgcGFyYW1zOiBBdmFpbGFiaWxpdHlQYXJhbXNEdG8sXG4gICAgQEJvZHkoKSB1cGRhdGVBdmFpbGFiaWxpdHlEdG86IFRoZXJhcGlzdEF2YWlsYWJpbGl0eVVwZGF0ZUR0byxcbiAgICBAQ3VycmVudFVzZXJJZCgpIHRoZXJhcGlzdElkOiBzdHJpbmcsXG4gICAgQEN1cnJlbnRVc2VyUm9sZSgpIHJvbGU6IHN0cmluZyxcbiAgKSB7XG4gICAgaWYgKHJvbGUgIT09ICd0aGVyYXBpc3QnKSB7XG4gICAgICB0aHJvdyBuZXcgVW5hdXRob3JpemVkRXhjZXB0aW9uKFxuICAgICAgICAnT25seSB0aGVyYXBpc3RzIGNhbiB1cGRhdGUgYXZhaWxhYmlsaXR5JyxcbiAgICAgICk7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLmJvb2tpbmdTZXJ2aWNlLnVwZGF0ZUF2YWlsYWJpbGl0eShcbiAgICAgIHBhcmFtcy5pZCxcbiAgICAgIHVwZGF0ZUF2YWlsYWJpbGl0eUR0byxcbiAgICAgIHRoZXJhcGlzdElkLFxuICAgICk7XG4gIH1cblxuICBARGVsZXRlKCdhdmFpbGFiaWxpdHkvOmlkJylcbiAgYXN5bmMgZGVsZXRlQXZhaWxhYmlsaXR5KFxuICAgIEBQYXJhbShuZXcgWm9kVmFsaWRhdGlvblBpcGUoQXZhaWxhYmlsaXR5UGFyYW1zRHRvU2NoZW1hKSlcbiAgICBwYXJhbXM6IEF2YWlsYWJpbGl0eVBhcmFtc0R0byxcbiAgICBAQ3VycmVudFVzZXJJZCgpIHRoZXJhcGlzdElkOiBzdHJpbmcsXG4gICAgQEN1cnJlbnRVc2VyUm9sZSgpIHJvbGU6IHN0cmluZyxcbiAgKSB7XG4gICAgaWYgKHJvbGUgIT09ICd0aGVyYXBpc3QnKSB7XG4gICAgICB0aHJvdyBuZXcgVW5hdXRob3JpemVkRXhjZXB0aW9uKFxuICAgICAgICAnT25seSB0aGVyYXBpc3RzIGNhbiBkZWxldGUgYXZhaWxhYmlsaXR5JyxcbiAgICAgICk7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLmJvb2tpbmdTZXJ2aWNlLmRlbGV0ZUF2YWlsYWJpbGl0eShwYXJhbXMuaWQsIHRoZXJhcGlzdElkKTtcbiAgfVxuXG4gIC8vIER1cmF0aW9uIGVuZHBvaW50cyAocHVibGljKVxuICBAR2V0KCdkdXJhdGlvbnMnKVxuICBnZXREdXJhdGlvbnMoKSB7XG4gICAgcmV0dXJuIHRoaXMuYm9va2luZ1NlcnZpY2UuZ2V0RHVyYXRpb25zKCk7XG4gIH1cblxuICAvLyBBdmFpbGFibGUgc2xvdHMgZW5kcG9pbnRcbiAgQEdldCgnc2xvdHMnKVxuICBhc3luYyBnZXRBdmFpbGFibGVTbG90cyhcbiAgICBAUXVlcnkobmV3IFpvZFZhbGlkYXRpb25QaXBlKEdldEF2YWlsYWJsZVNsb3RzUXVlcnlEdG9TY2hlbWEpKVxuICAgIHF1ZXJ5OiBHZXRBdmFpbGFibGVTbG90c1F1ZXJ5RHRvLFxuICApIHtcbiAgICByZXR1cm4gdGhpcy5ib29raW5nU2VydmljZS5nZXRBdmFpbGFibGVTbG90cyhxdWVyeS50aGVyYXBpc3RJZCwgcXVlcnkuZGF0ZSk7XG4gIH1cbn1cbiJdLCJ2ZXJzaW9uIjozfQ==