{"file":"/home/wetooa/Documents/code/projects/mentara/mentara-api/src/common/services/supabase-storage.service.ts","mappings":"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","names":[],"sources":["/home/wetooa/Documents/code/projects/mentara/mentara-api/src/common/services/supabase-storage.service.ts"],"sourcesContent":["import { Injectable, Logger } from '@nestjs/common';\nimport { ConfigService } from '@nestjs/config';\nimport axios from 'axios';\nimport { v4 as uuidv4 } from 'uuid';\n\nexport interface FileUploadResult {\n  filename: string;\n  url: string;\n  bucket: string;\n}\n\n@Injectable()\nexport class SupabaseStorageService {\n  private readonly logger = new Logger(SupabaseStorageService.name);\n  private readonly supabaseUrl: string;\n  private readonly supabaseApiKey: string;\n\n  constructor(private configService: ConfigService) {\n    this.supabaseUrl = this.configService.get<string>('SUPABASE_URL') || '';\n    this.supabaseApiKey =\n      this.configService.get<string>('SUPABASE_API_KEY') || '';\n\n    if (!this.supabaseUrl || !this.supabaseApiKey) {\n      throw new Error(\n        'Supabase configuration is missing. Please set SUPABASE_URL and SUPABASE_API_KEY environment variables.',\n      );\n    }\n  }\n\n  /**\n   * Upload a file to Supabase Storage\n   * @param file - The file to upload\n   * @param bucket - The storage bucket name\n   * @returns Promise<FileUploadResult> - Upload result with filename and URL\n   */\n  async uploadFile(\n    file: Express.Multer.File,\n    bucket: string,\n  ): Promise<FileUploadResult> {\n    this.logger.log(\n      `Uploading file to Supabase: ${file.originalname} (bucket: ${bucket})`,\n    );\n\n    try {\n      // Generate unique filename to avoid conflicts\n      const originalFilename = file.originalname;\n      const fileExtension = this.getFileExtension(originalFilename);\n      const uniqueFilename = `${uuidv4()}${fileExtension}`;\n\n      // Upload to Supabase\n      await this.uploadToSupabase(\n        bucket,\n        uniqueFilename,\n        file.buffer,\n        file.mimetype,\n      );\n\n      // Generate public URL\n      const publicUrl = `${this.supabaseUrl}/storage/v1/object/public/${bucket}/${uniqueFilename}`;\n\n      this.logger.log(\n        `File uploaded successfully to Supabase: ${uniqueFilename}`,\n      );\n\n      return {\n        filename: uniqueFilename,\n        url: publicUrl,\n        bucket,\n      };\n    } catch (error: any) {\n      this.logger.error(\n        `Error uploading file to Supabase: ${file.originalname}`,\n        error,\n      );\n      throw new Error(\n        `Failed to upload file to Supabase: ${error?.message || 'Unknown error'}`,\n      );\n    }\n  }\n\n  /**\n   * Upload multiple files to Supabase Storage\n   * @param files - Array of files to upload\n   * @param bucket - The storage bucket name\n   * @returns Promise<FileUploadResult[]> - Array of upload results\n   */\n  async uploadFiles(\n    files: Express.Multer.File[],\n    bucket: string,\n  ): Promise<FileUploadResult[]> {\n    if (!files || files.length === 0) {\n      return [];\n    }\n\n    this.logger.log(\n      `Uploading ${files.length} files to Supabase bucket: ${bucket}`,\n    );\n\n    try {\n      const uploadPromises = files.map((file) => this.uploadFile(file, bucket));\n      const results = await Promise.all(uploadPromises);\n\n      this.logger.log(\n        `Successfully uploaded ${results.length} files to Supabase`,\n      );\n      return results;\n    } catch (error: any) {\n      this.logger.error(`Error uploading multiple files to Supabase`, error);\n      throw new Error(\n        `Failed to upload files to Supabase: ${error?.message || 'Unknown error'}`,\n      );\n    }\n  }\n\n  /**\n   * Delete a file from Supabase Storage\n   * @param bucket - The storage bucket name\n   * @param filename - The filename to delete\n   */\n  async deleteFile(bucket: string, filename: string): Promise<void> {\n    this.logger.log(\n      `Deleting file from Supabase: ${filename} (bucket: ${bucket})`,\n    );\n\n    try {\n      const url = `${this.supabaseUrl}/storage/v1/object/${bucket}/${filename}`;\n\n      const response = await axios.delete(url, {\n        headers: {\n          Authorization: `Bearer ${this.supabaseApiKey}`,\n        },\n      });\n\n      if (response.status === 200) {\n        this.logger.log(`File deleted successfully from Supabase: ${filename}`);\n      } else {\n        this.logger.error(\n          `Failed to delete file from Supabase. Status: ${response.status}, Response: ${response.data}`,\n        );\n        throw new Error(\n          `Supabase delete failed with status: ${response.status}`,\n        );\n      }\n    } catch (error: any) {\n      this.logger.error(\n        `Error deleting file from Supabase: ${filename}`,\n        error,\n      );\n      throw new Error(\n        `Failed to delete file from Supabase: ${error?.message || 'Unknown error'}`,\n      );\n    }\n  }\n\n  /**\n   * Get file extension from filename\n   * @param filename - The original filename\n   * @returns string - The file extension including the dot\n   */\n  private getFileExtension(filename: string): string {\n    const lastDotIndex = filename.lastIndexOf('.');\n    return lastDotIndex === -1 ? '' : filename.substring(lastDotIndex);\n  }\n\n  /**\n   * Upload file content to Supabase Storage\n   * @param bucket - The storage bucket name\n   * @param path - The file path/name in the bucket\n   * @param fileBuffer - The file content as buffer\n   * @param mimeType - The MIME type of the file\n   */\n  private async uploadToSupabase(\n    bucket: string,\n    path: string,\n    fileBuffer: Buffer,\n    mimeType: string,\n  ): Promise<void> {\n    const url = `${this.supabaseUrl}/storage/v1/object/${bucket}/${path}`;\n\n    try {\n      const response = await axios.post(url, fileBuffer, {\n        headers: {\n          'Content-Type': mimeType,\n          Authorization: `Bearer ${this.supabaseApiKey}`,\n        },\n      });\n\n      if (response.status === 200 || response.status === 201) {\n        this.logger.debug(`File uploaded successfully to Supabase: ${path}`);\n      } else {\n        this.logger.error(\n          `Failed to upload file to Supabase. Status: ${response.status}, Response: ${response.data}`,\n        );\n        throw new Error(\n          `Supabase upload failed with status: ${response.status}`,\n        );\n      }\n    } catch (error: any) {\n      if (error?.response) {\n        this.logger.error(\n          `Supabase API error: ${error.response.status} - ${error.response.data}`,\n        );\n        throw new Error(\n          `Supabase upload failed: ${error.response.data?.message || error.response.statusText}`,\n        );\n      } else {\n        this.logger.error(\n          `Network error during Supabase upload: ${error.message}`,\n        );\n        throw new Error(`Failed to upload to Supabase: ${error.message}`);\n      }\n    }\n  }\n\n  /**\n   * Validate file for upload\n   * @param file - The file to validate\n   * @param maxSizeInBytes - Maximum file size allowed\n   * @param allowedMimeTypes - Array of allowed MIME types\n   */\n  validateFile(\n    file: Express.Multer.File,\n    maxSizeInBytes: number = 10 * 1024 * 1024, // 10MB default\n    allowedMimeTypes: string[] = [\n      'image/jpeg',\n      'image/png',\n      'image/gif',\n      'image/webp',\n      'application/pdf',\n      'text/plain',\n      'text/csv',\n      'application/vnd.openxmlformats-officedocument.wordprocessingml.document', // .docx\n      'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', // .xlsx\n      'application/vnd.openxmlformats-officedocument.presentationml.presentation', // .pptx\n      'application/msword', // .doc\n      'application/vnd.ms-excel', // .xls\n      'application/vnd.ms-powerpoint', // .ppt\n    ],\n  ): { isValid: boolean; error?: string } {\n    // File size validation\n    if (file.size > maxSizeInBytes) {\n      return {\n        isValid: false,\n        error: `File size exceeds ${Math.floor(maxSizeInBytes / (1024 * 1024))}MB limit`,\n      };\n    }\n\n    // MIME type validation\n    if (!allowedMimeTypes.includes(file.mimetype)) {\n      return {\n        isValid: false,\n        error: `File type ${file.mimetype} is not allowed`,\n      };\n    }\n\n    // Filename validation - prevent path traversal\n    const safeFilename = file.originalname.replace(/[^a-zA-Z0-9.-]/g, '_');\n    if (safeFilename !== file.originalname) {\n      return {\n        isValid: false,\n        error: 'Filename contains invalid characters',\n      };\n    }\n\n    return { isValid: true };\n  }\n\n  /**\n   * Get supported storage buckets\n   */\n  static getSupportedBuckets() {\n    return {\n      USER_PROFILES: 'user-profiles',\n      POST_ATTACHMENTS: 'post-attachments',\n      MESSAGES: 'messages',\n      DOCUMENTS: 'documents',\n      WORKSHEETS: 'worksheets',\n    } as const;\n  }\n}\n"],"version":3}