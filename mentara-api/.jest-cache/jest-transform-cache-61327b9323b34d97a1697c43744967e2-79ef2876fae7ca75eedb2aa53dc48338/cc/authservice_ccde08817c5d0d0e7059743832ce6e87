156a21595522acf37521e027f94479f1
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var _a, _b, _c, _d, _e;
Object.defineProperty(exports, "__esModule", { value: true });
exports.AuthService = void 0;
const common_1 = require("@nestjs/common");
const prisma_client_provider_1 = require("src/providers/prisma-client.provider");
// Remove unused imports - these DTOs don't exist in mentara-commons
const event_bus_service_1 = require("../common/events/event-bus.service");
const user_events_1 = require("../common/events/user-events");
const token_service_1 = require("./services/token.service");
const email_verification_service_1 = require("./services/email-verification.service");
const password_reset_service_1 = require("./services/password-reset.service");
let AuthService = class AuthService {
    prisma;
    eventBus;
    tokenService;
    emailVerificationService;
    passwordResetService;
    constructor(prisma, eventBus, tokenService, emailVerificationService, passwordResetService) {
        this.prisma = prisma;
        this.eventBus = eventBus;
        this.tokenService = tokenService;
        this.emailVerificationService = emailVerificationService;
        this.passwordResetService = passwordResetService;
    }
    async registerClient(email, password, firstName, lastName, additionalData) {
        try {
            // Use the existing local registration method
            const { user } = await this.registerUserWithEmail(email, password, firstName, lastName, 'client', additionalData);
            // Generate tokens for immediate login after registration
            const tokens = await this.tokenService.generateTokenPair(user.id, user.email, user.role);
            return {
                user,
                tokens,
                message: 'Client registered successfully. Please check your email to verify your account.',
            };
        }
        catch (error) {
            console.error('Client registration error:', error instanceof Error ? error.message : error);
            if (error instanceof common_1.ConflictException) {
                throw error;
            }
            throw new common_1.InternalServerErrorException('Client registration failed');
        }
    }
    async registerTherapist(email, password, firstName, lastName, additionalData) {
        try {
            // Use the existing local registration method
            const { user } = await this.registerUserWithEmail(email, password, firstName, lastName, 'therapist', additionalData);
            // Generate tokens for immediate login after registration
            const tokens = await this.tokenService.generateTokenPair(user.id, user.email, user.role);
            return {
                user,
                tokens,
                message: 'Therapist registered successfully. Please check your email to verify your account. Your application is pending approval.',
            };
        }
        catch (error) {
            console.error('Therapist registration error:', error instanceof Error ? error.message : error);
            if (error instanceof common_1.ConflictException) {
                throw error;
            }
            throw new common_1.InternalServerErrorException('Therapist registration failed');
        }
    }
    async getUsers() {
        return this.prisma.user.findMany({
            where: {
                deactivatedAt: null,
            },
            select: {
                id: true,
                email: true,
                firstName: true,
                lastName: true,
                role: true,
                emailVerified: true,
                createdAt: true,
                updatedAt: true,
                client: {
                    select: {
                        userId: true,
                    },
                },
                therapist: {
                    select: {
                        userId: true,
                        status: true,
                    },
                },
            },
            orderBy: {
                createdAt: 'desc',
            },
        });
    }
    async getUser(userId) {
        const user = await this.prisma.user.findUnique({
            where: {
                id: userId,
                deactivatedAt: null,
            },
            select: {
                id: true,
                email: true,
                firstName: true,
                lastName: true,
                role: true,
                emailVerified: true,
                createdAt: true,
                updatedAt: true,
                client: {
                    select: {
                        userId: true,
                    },
                },
                therapist: {
                    select: {
                        userId: true,
                        status: true,
                    },
                },
            },
        });
        if (!user) {
            throw new common_1.UnauthorizedException('User not found');
        }
        return user;
    }
    async forceLogout(userId) {
        try {
            // Revoke all JWT refresh tokens for the user
            await this.tokenService.revokeAllUserTokens(userId);
            return { success: true, message: 'User sessions revoked successfully' };
        }
        catch (error) {
            console.error('Force logout error:', error instanceof Error ? error.message : error);
            throw new common_1.InternalServerErrorException('Force logout failed');
        }
    }
    // Local Authentication Methods
    async registerUserWithEmail(email, password, firstName, lastName, role = 'client', additionalData) {
        // Check if user already exists
        const existingUser = await this.prisma.user.findUnique({
            where: { email },
        });
        if (existingUser) {
            throw new common_1.ConflictException('User with this email already exists');
        }
        // Hash password
        const hashedPassword = await this.tokenService.hashPassword(password);
        // Generate email verification token
        const { hashedToken, expiresAt } = await this.tokenService.generateEmailVerificationToken();
        // Create user
        const userData = {
            email,
            password: hashedPassword,
            firstName,
            lastName,
            role,
            emailVerifyToken: hashedToken,
            emailVerifyTokenExp: expiresAt,
            ...additionalData,
        };
        const user = await this.prisma.user.create({
            data: userData,
            select: {
                id: true,
                email: true,
                firstName: true,
                lastName: true,
                role: true,
                emailVerified: true,
            },
        });
        // Create role-specific record
        if (role === 'client') {
            await this.prisma.client.create({
                data: { userId: user.id },
            });
        }
        else if (role === 'therapist') {
            await this.prisma.therapist.create({
                data: {
                    userId: user.id,
                    status: 'pending',
                    mobile: '',
                    province: '',
                    providerType: '',
                    professionalLicenseType: '',
                    isPRCLicensed: '',
                    prcLicenseNumber: '',
                    expirationDateOfLicense: new Date(),
                    practiceStartDate: new Date(),
                    sessionLength: '',
                    hourlyRate: 0,
                    providedOnlineTherapyBefore: false,
                    comfortableUsingVideoConferencing: false,
                    compliesWithDataPrivacyAct: false,
                    willingToAbideByPlatformGuidelines: false,
                    treatmentSuccessRates: {},
                },
            });
        }
        // Send verification email
        await this.emailVerificationService.sendVerificationEmail(user.id);
        // Publish registration event
        await this.eventBus.emit(new user_events_1.UserRegisteredEvent({
            userId: user.id,
            email: user.email,
            firstName: user.firstName,
            lastName: user.lastName,
            role,
            registrationMethod: 'email',
        }));
        return {
            user,
            message: 'User registered successfully. Please check your email to verify your account.',
        };
    }
    async loginWithEmail(email, password, ipAddress, userAgent) {
        const user = await this.prisma.user.findUnique({
            where: { email },
            select: {
                id: true,
                email: true,
                firstName: true,
                lastName: true,
                role: true,
                password: true,
                emailVerified: true,
                deactivatedAt: true,
                lockoutUntil: true,
                failedLoginCount: true,
                client: true,
                therapist: true,
            },
        });
        if (!user) {
            throw new common_1.UnauthorizedException('Invalid credentials');
        }
        if (user.deactivatedAt) {
            throw new common_1.UnauthorizedException('Account has been deactivated');
        }
        if (!user.password) {
            throw new common_1.UnauthorizedException('Please complete account setup or reset your password');
        }
        // Check account lockout
        const isLockedOut = await this.tokenService.checkAccountLockout(user.id);
        if (isLockedOut) {
            throw new common_1.UnauthorizedException('Account is temporarily locked due to too many failed login attempts');
        }
        // Verify password
        const isPasswordValid = await this.tokenService.comparePassword(password, user.password);
        if (!isPasswordValid) {
            await this.tokenService.handleFailedLogin(user.id);
            throw new common_1.UnauthorizedException('Invalid credentials');
        }
        // Check email verification
        if (!user.emailVerified) {
            throw new common_1.UnauthorizedException('Please verify your email address before logging in');
        }
        // Reset failed login count and update last login
        await this.tokenService.resetFailedLoginCount(user.id);
        // Generate tokens
        const tokens = await this.tokenService.generateTokenPair(user.id, user.email, user.role, ipAddress, userAgent);
        // Remove sensitive data from user object
        const { password: _, lockoutUntil: __, failedLoginCount: ___, ...safeUser } = user;
        return { user: safeUser, tokens };
    }
    async refreshTokens(refreshToken, ipAddress, userAgent) {
        return this.tokenService.refreshAccessToken(refreshToken, ipAddress, userAgent);
    }
    async logout(refreshToken) {
        await this.tokenService.revokeRefreshToken(refreshToken);
    }
    async validateUser(userId) {
        return this.prisma.user.findUnique({
            where: {
                id: userId,
                deactivatedAt: null,
            },
            select: {
                id: true,
                email: true,
                firstName: true,
                lastName: true,
                role: true,
                client: true,
                therapist: true,
            },
        });
    }
    // Email verification methods
    async verifyEmail(token) {
        return this.emailVerificationService.verifyEmail(token);
    }
    async resendVerificationEmail(email) {
        return this.emailVerificationService.resendVerificationEmail(email);
    }
    // Password reset methods
    async requestPasswordReset(email) {
        return this.passwordResetService.requestPasswordReset(email);
    }
    async resetPassword(token, newPassword) {
        return this.passwordResetService.resetPassword(token, newPassword);
    }
    async validateResetToken(token) {
        return this.passwordResetService.validateResetToken(token);
    }
    // Account management methods
    async changePassword(userId, currentPassword, newPassword) {
        const user = await this.prisma.user.findUnique({
            where: { id: userId },
            select: { password: true, deactivatedAt: true },
        });
        if (!user || user.deactivatedAt) {
            throw new common_1.UnauthorizedException('User not found or deactivated');
        }
        if (!user.password) {
            throw new common_1.BadRequestException('Please complete account setup first');
        }
        // Verify current password
        const isCurrentPasswordValid = await this.tokenService.comparePassword(currentPassword, user.password);
        if (!isCurrentPasswordValid) {
            throw new common_1.UnauthorizedException('Current password is incorrect');
        }
        // Check if new password is different
        const isSamePassword = await this.tokenService.comparePassword(newPassword, user.password);
        if (isSamePassword) {
            throw new common_1.BadRequestException('New password must be different from current password');
        }
        // Hash new password
        const hashedPassword = await this.tokenService.hashPassword(newPassword);
        // Update password
        await this.prisma.user.update({
            where: { id: userId },
            data: { password: hashedPassword },
        });
        // Revoke all refresh tokens for security
        await this.tokenService.revokeAllUserTokens(userId);
        return {
            success: true,
            message: 'Password changed successfully. Please log in again.',
        };
    }
    async deactivateAccount(userId, reason, deactivatedBy) {
        await this.prisma.user.update({
            where: { id: userId },
            data: {
                deactivatedAt: new Date(),
                deactivatedBy,
                deactivationReason: reason,
            },
        });
        // Revoke all tokens
        await this.tokenService.revokeAllUserTokens(userId);
        return {
            success: true,
            message: 'Account deactivated successfully',
        };
    }
    async reactivateAccount(userId) {
        await this.prisma.user.update({
            where: { id: userId },
            data: {
                deactivatedAt: null,
                deactivatedBy: null,
                deactivationReason: null,
                failedLoginCount: 0,
                lockoutUntil: null,
            },
        });
        return {
            success: true,
            message: 'Account reactivated successfully',
        };
    }
    async handleOAuthLogin(oauthUser, provider) {
        try {
            // Check if user exists
            const existingUser = await this.prisma.user.findUnique({
                where: { email: oauthUser.email },
            });
            if (existingUser) {
                // User exists, generate tokens and return
                const tokens = await this.tokenService.generateTokenPair(existingUser.id, existingUser.email, existingUser.role);
                return {
                    user: {
                        id: existingUser.id,
                        email: existingUser.email,
                        firstName: existingUser.firstName,
                        lastName: existingUser.lastName,
                        role: existingUser.role,
                        emailVerified: existingUser.emailVerified,
                    },
                    accessToken: tokens.accessToken,
                    refreshToken: tokens.refreshToken,
                    expiresIn: tokens.expiresIn,
                    message: 'Login successful',
                };
            }
            else {
                // Create new user from OAuth data
                const newUser = await this.prisma.user.create({
                    data: {
                        email: oauthUser.email,
                        firstName: oauthUser.firstName,
                        lastName: oauthUser.lastName,
                        role: 'client', // Default role
                        emailVerified: true, // OAuth emails are pre-verified
                        avatarUrl: oauthUser.picture,
                    },
                    select: {
                        id: true,
                        email: true,
                        firstName: true,
                        lastName: true,
                        role: true,
                        emailVerified: true,
                    },
                });
                // Create client record for new user
                await this.prisma.client.create({
                    data: { userId: newUser.id },
                });
                const tokens = await this.tokenService.generateTokenPair(newUser.id, newUser.email, newUser.role);
                // Emit user registration event
                this.eventBus.emit(new user_events_1.UserRegisteredEvent({
                    userId: newUser.id,
                    email: newUser.email,
                    firstName: newUser.firstName,
                    lastName: newUser.lastName,
                    role: newUser.role,
                    registrationMethod: 'oauth',
                }));
                return {
                    user: newUser,
                    accessToken: tokens.accessToken,
                    refreshToken: tokens.refreshToken,
                    expiresIn: tokens.expiresIn,
                    message: 'Account created successfully',
                };
            }
        }
        catch (error) {
            throw new common_1.InternalServerErrorException(`OAuth login failed: ${error instanceof Error ? error.message : 'Unknown error'}`);
        }
    }
    // ===== FIRST-TIME USER FLOW METHODS =====
    async getFirstSignInStatus(userId) {
        const client = await this.prisma.client.findUnique({
            where: { userId },
            select: {
                hasSeenTherapistRecommendations: true,
                createdAt: true,
            },
        });
        if (!client) {
            throw new common_1.UnauthorizedException('Client profile not found');
        }
        return {
            isFirstTime: !client.hasSeenTherapistRecommendations,
            needsWelcomeFlow: !client.hasSeenTherapistRecommendations,
            memberSince: client.createdAt,
        };
    }
    async markRecommendationsSeen(userId) {
        const updatedClient = await this.prisma.client.update({
            where: { userId },
            data: { hasSeenTherapistRecommendations: true },
            select: {
                hasSeenTherapistRecommendations: true,
                updatedAt: true,
            },
        });
        return {
            success: true,
            hasSeenRecommendations: updatedClient.hasSeenTherapistRecommendations,
            markedAt: updatedClient.updatedAt,
            message: 'Recommendations marked as seen successfully',
        };
    }
};
exports.AuthService = AuthService;
exports.AuthService = AuthService = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [typeof (_a = typeof prisma_client_provider_1.PrismaService !== "undefined" && prisma_client_provider_1.PrismaService) === "function" ? _a : Object, typeof (_b = typeof event_bus_service_1.EventBusService !== "undefined" && event_bus_service_1.EventBusService) === "function" ? _b : Object, typeof (_c = typeof token_service_1.TokenService !== "undefined" && token_service_1.TokenService) === "function" ? _c : Object, typeof (_d = typeof email_verification_service_1.EmailVerificationService !== "undefined" && email_verification_service_1.EmailVerificationService) === "function" ? _d : Object, typeof (_e = typeof password_reset_service_1.PasswordResetService !== "undefined" && password_reset_service_1.PasswordResetService) === "function" ? _e : Object])
], AuthService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL2F1dGgvYXV0aC5zZXJ2aWNlLnRzIiwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7QUFBQSwyQ0FNd0I7QUFDeEIsaUZBQXFFO0FBQ3JFLG9FQUFvRTtBQUNwRSwwRUFBcUU7QUFDckUsOERBQW1FO0FBQ25FLDREQUFtRTtBQUNuRSxzRkFBaUY7QUFDakYsOEVBQXlFO0FBR2xFLElBQU0sV0FBVyxHQUFqQixNQUFNLFdBQVc7SUFFSDtJQUNBO0lBQ0E7SUFDQTtJQUNBO0lBTG5CLFlBQ21CLE1BQXFCLEVBQ3JCLFFBQXlCLEVBQ3pCLFlBQTBCLEVBQzFCLHdCQUFrRCxFQUNsRCxvQkFBMEM7UUFKMUMsV0FBTSxHQUFOLE1BQU0sQ0FBZTtRQUNyQixhQUFRLEdBQVIsUUFBUSxDQUFpQjtRQUN6QixpQkFBWSxHQUFaLFlBQVksQ0FBYztRQUMxQiw2QkFBd0IsR0FBeEIsd0JBQXdCLENBQTBCO1FBQ2xELHlCQUFvQixHQUFwQixvQkFBb0IsQ0FBc0I7SUFDMUQsQ0FBQztJQUVKLEtBQUssQ0FBQyxjQUFjLENBQ2xCLEtBQWEsRUFDYixRQUFnQixFQUNoQixTQUFpQixFQUNqQixRQUFnQixFQUNoQixjQUFvQjtRQUVwQixJQUFJLENBQUM7WUFDSCw2Q0FBNkM7WUFDN0MsTUFBTSxFQUFFLElBQUksRUFBRSxHQUFHLE1BQU0sSUFBSSxDQUFDLHFCQUFxQixDQUMvQyxLQUFLLEVBQ0wsUUFBUSxFQUNSLFNBQVMsRUFDVCxRQUFRLEVBQ1IsUUFBUSxFQUNSLGNBQWMsQ0FDZixDQUFDO1lBRUYseURBQXlEO1lBQ3pELE1BQU0sTUFBTSxHQUFHLE1BQU0sSUFBSSxDQUFDLFlBQVksQ0FBQyxpQkFBaUIsQ0FDdEQsSUFBSSxDQUFDLEVBQUUsRUFDUCxJQUFJLENBQUMsS0FBSyxFQUNWLElBQUksQ0FBQyxJQUFJLENBQ1YsQ0FBQztZQUVGLE9BQU87Z0JBQ0wsSUFBSTtnQkFDSixNQUFNO2dC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Q0YsQ0FBQyxDQUFDO1FBRUgsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDO1lBQ1osTUFBTSxJQUFJLDhCQUFxQixDQUFDLDBCQUEwQixDQUFDLENBQUM7UUFDOUQsQ0FBQztRQUVELE9BQU87WUFDTCxXQUFXLEVBQUUsQ0FBQyxNQUFNLENBQUMsK0JBQStCO1lBQ3BELGdCQUFnQixFQUFFLENBQUMsTUFBTSxDQUFDLCtCQUErQjtZQUN6RCxXQUFXLEVBQUUsTUFBTSxDQUFDLFNBQVM7U0FDOUIsQ0FBQztJQUNKLENBQUM7SUFFRCxLQUFLLENBQUMsdUJBQXVCLENBQUMsTUFBYztRQUMxQyxNQUFNLGFBQWEsR0FBRyxNQUFNLElBQUksQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQztZQUNwRCxLQUFLLEVBQUUsRUFBRSxNQUFNLEVBQUU7WUFDakIsSUFBSSxFQUFFLEVBQUUsK0JBQStCLEVBQUUsSUFBSSxFQUFFO1lBQy9DLE1BQU0sRUFBRTtnQkFDTiwrQkFBK0IsRUFBRSxJQUFJO2dCQUNyQyxTQUFTLEVBQUUsSUFBSTthQUNoQjtTQUNGLENBQUMsQ0FBQztRQUVILE9BQU87WUFDTCxPQUFPLEVBQUUsSUFBSTtZQUNiLHNCQUFzQixFQUFFLGFBQWEsQ0FBQywrQkFBK0I7WUFDckUsUUFBUSxFQUFFLGFBQWEsQ0FBQyxTQUFTO1lBQ2pDLE9BQU8sRUFBRSw2Q0FBNkM7U0FDdkQsQ0FBQztJQUNKLENBQUM7Q0FDRixDQUFBO0FBbHBCWSxrQ0FBVztzQkFBWCxXQUFXO0lBRHZCLElBQUEsbUJBQVUsR0FBRTt5REFHZ0Isc0NBQWEsb0JBQWIsc0NBQWEsb0RBQ1gsbUNBQWUsb0JBQWYsbUNBQWUsb0RBQ1gsNEJBQVksb0JBQVosNEJBQVksb0RBQ0EscURBQXdCLG9CQUF4QixxREFBd0Isb0RBQzVCLDZDQUFvQixvQkFBcEIsNkNBQW9CO0dBTmxELFdBQVcsQ0FrcEJ2QiIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvaG9tZS93ZXRvb2EvRG9jdW1lbnRzL2NvZGUvcHJvamVjdHMvbWVudGFyYS9tZW50YXJhLWFwaS9zcmMvYXV0aC9hdXRoLnNlcnZpY2UudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgQ29uZmxpY3RFeGNlcHRpb24sXG4gIEluamVjdGFibGUsXG4gIEludGVybmFsU2VydmVyRXJyb3JFeGNlcHRpb24sXG4gIFVuYXV0aG9yaXplZEV4Y2VwdGlvbixcbiAgQmFkUmVxdWVzdEV4Y2VwdGlvbixcbn0gZnJvbSAnQG5lc3Rqcy9jb21tb24nO1xuaW1wb3J0IHsgUHJpc21hU2VydmljZSB9IGZyb20gJ3NyYy9wcm92aWRlcnMvcHJpc21hLWNsaWVudC5wcm92aWRlcic7XG4vLyBSZW1vdmUgdW51c2VkIGltcG9ydHMgLSB0aGVzZSBEVE9zIGRvbid0IGV4aXN0IGluIG1lbnRhcmEtY29tbW9uc1xuaW1wb3J0IHsgRXZlbnRCdXNTZXJ2aWNlIH0gZnJvbSAnLi4vY29tbW9uL2V2ZW50cy9ldmVudC1idXMuc2VydmljZSc7XG5pbXBvcnQgeyBVc2VyUmVnaXN0ZXJlZEV2ZW50IH0gZnJvbSAnLi4vY29tbW9uL2V2ZW50cy91c2VyLWV2ZW50cyc7XG5pbXBvcnQgeyBUb2tlblNlcnZpY2UsIFRva2VuUGFpciB9IGZyb20gJy4vc2VydmljZXMvdG9rZW4uc2VydmljZSc7XG5pbXBvcnQgeyBFbWFpbFZlcmlmaWNhdGlvblNlcnZpY2UgfSBmcm9tICcuL3NlcnZpY2VzL2VtYWlsLXZlcmlmaWNhdGlvbi5zZXJ2aWNlJztcbmltcG9ydCB7IFBhc3N3b3JkUmVzZXRTZXJ2aWNlIH0gZnJvbSAnLi9zZXJ2aWNlcy9wYXNzd29yZC1yZXNldC5zZXJ2aWNlJztcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIEF1dGhTZXJ2aWNlIHtcbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSByZWFkb25seSBwcmlzbWE6IFByaXNtYVNlcnZpY2UsXG4gICAgcHJpdmF0ZSByZWFkb25seSBldmVudEJ1czogRXZlbnRCdXNTZXJ2aWNlLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgdG9rZW5TZXJ2aWNlOiBUb2tlblNlcnZpY2UsXG4gICAgcHJpdmF0ZSByZWFkb25seSBlbWFpbFZlcmlmaWNhdGlvblNlcnZpY2U6IEVtYWlsVmVyaWZpY2F0aW9uU2VydmljZSxcbiAgICBwcml2YXRlIHJlYWRvbmx5IHBhc3N3b3JkUmVzZXRTZXJ2aWNlOiBQYXNzd29yZFJlc2V0U2VydmljZSxcbiAgKSB7fVxuXG4gIGFzeW5jIHJlZ2lzdGVyQ2xpZW50KFxuICAgIGVtYWlsOiBzdHJpbmcsXG4gICAgcGFzc3dvcmQ6IHN0cmluZyxcbiAgICBmaXJzdE5hbWU6IHN0cmluZyxcbiAgICBsYXN0TmFtZTogc3RyaW5nLFxuICAgIGFkZGl0aW9uYWxEYXRhPzogYW55LFxuICApOiBQcm9taXNlPHsgdXNlcjogYW55OyB0b2tlbnM6IFRva2VuUGFpcjsgbWVzc2FnZTogc3RyaW5nIH0+IHtcbiAgICB0cnkge1xuICAgICAgLy8gVXNlIHRoZSBleGlzdGluZyBsb2NhbCByZWdpc3RyYXRpb24gbWV0aG9kXG4gICAgICBjb25zdCB7IHVzZXIgfSA9IGF3YWl0IHRoaXMucmVnaXN0ZXJVc2VyV2l0aEVtYWlsKFxuICAgICAgICBlbWFpbCxcbiAgICAgICAgcGFzc3dvcmQsXG4gICAgICAgIGZpcnN0TmFtZSxcbiAgICAgICAgbGFzdE5hbWUsXG4gICAgICAgICdjbGllbnQnLFxuICAgICAgICBhZGRpdGlvbmFsRGF0YSxcbiAgICAgICk7XG5cbiAgICAgIC8vIEdlbmVyYXRlIHRva2VucyBmb3IgaW1tZWRpYXRlIGxvZ2luIGFmdGVyIHJlZ2lzdHJhdGlvblxuICAgICAgY29uc3QgdG9rZW5zID0gYXdhaXQgdGhpcy50b2tlblNlcnZpY2UuZ2VuZXJhdGVUb2tlblBhaXIoXG4gICAgICAgIHVzZXIuaWQsXG4gICAgICAgIHVzZXIuZW1haWwsXG4gICAgICAgIHVzZXIucm9sZSxcbiAgICAgICk7XG5cbiAgICAgIHJldHVybiB7XG4gICAgICAgIHVzZXIsXG4gICAgICAgIHRva2VucyxcbiAgICAgICAgbWVzc2FnZTpcbiAgICAgICAgICAnQ2xpZW50IHJlZ2lzdGVyZWQgc3VjY2Vzc2Z1bGx5LiBQbGVhc2UgY2hlY2sgeW91ciBlbWFpbCB0byB2ZXJpZnkgeW91ciBhY2NvdW50LicsXG4gICAgICB9O1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBjb25zb2xlLmVycm9yKFxuICAgICAgICAnQ2xpZW50IHJlZ2lzdHJhdGlvbiBlcnJvcjonLFxuICAgICAgICBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6IGVycm9yLFxuICAgICAgKTtcbiAgICAgIGlmIChlcnJvciBpbnN0YW5jZW9mIENvbmZsaWN0RXhjZXB0aW9uKSB7XG4gICAgICAgIHRocm93IGVycm9yO1xuICAgICAgfVxuICAgICAgdGhyb3cgbmV3IEludGVybmFsU2VydmVyRXJyb3JFeGNlcHRpb24oJ0NsaWVudCByZWdpc3RyYXRpb24gZmFpbGVkJyk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgcmVnaXN0ZXJUaGVyYXBpc3QoXG4gICAgZW1haWw6IHN0cmluZyxcbiAgICBwYXNzd29yZDogc3RyaW5nLFxuICAgIGZpcnN0TmFtZTogc3RyaW5nLFxuICAgIGxhc3ROYW1lOiBzdHJpbmcsXG4gICAgYWRkaXRpb25hbERhdGE/OiBhbnksXG4gICk6IFByb21pc2U8eyB1c2VyOiBhbnk7IHRva2VuczogVG9rZW5QYWlyOyBtZXNzYWdlOiBzdHJpbmcgfT4ge1xuICAgIHRyeSB7XG4gICAgICAvLyBVc2UgdGhlIGV4aXN0aW5nIGxvY2FsIHJlZ2lzdHJhdGlvbiBtZXRob2RcbiAgICAgIGNvbnN0IHsgdXNlciB9ID0gYXdhaXQgdGhpcy5yZWdpc3RlclVzZXJXaXRoRW1haWwoXG4gICAgICAgIGVtYWlsLFxuICAgICAgICBwYXNzd29yZCxcbiAgICAgICAgZmlyc3ROYW1lLFxuICAgICAgICBsYXN0TmFtZSxcbiAgICAgICAgJ3RoZXJhcGlzdCcsXG4gICAgICAgIGFkZGl0aW9uYWxEYXRhLFxuICAgICAgKTtcblxuICAgICAgLy8gR2VuZXJhdGUgdG9rZW5zIGZvciBpbW1lZGlhdGUgbG9naW4gYWZ0ZXIgcmVnaXN0cmF0aW9uXG4gICAgICBjb25zdCB0b2tlbnMgPSBhd2FpdCB0aGlzLnRva2VuU2VydmljZS5nZW5lcmF0ZVRva2VuUGFpcihcbiAgICAgICAgdXNlci5pZCxcbiAgICAgICAgdXNlci5lbWFpbCxcbiAgICAgICAgdXNlci5yb2xlLFxuICAgICAgKTtcblxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgdXNlcixcbiAgICAgICAgdG9rZW5zLFxuICAgICAgICBtZXNzYWdlOlxuICAgICAgICAgICdUaGVyYXBpc3QgcmVnaXN0ZXJlZCBzdWNjZXNzZnVsbHkuIFBsZWFzZSBjaGVjayB5b3VyIGVtYWlsIHRvIHZlcmlmeSB5b3VyIGFjY291bnQuIFlvdXIgYXBwbGljYXRpb24gaXMgcGVuZGluZyBhcHByb3ZhbC4nLFxuICAgICAgfTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc29sZS5lcnJvcihcbiAgICAgICAgJ1RoZXJhcGlzdCByZWdpc3RyYXRpb24gZXJyb3I6JyxcbiAgICAgICAgZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiBlcnJvcixcbiAgICAgICk7XG4gICAgICBpZiAoZXJyb3IgaW5zdGFuY2VvZiBDb25mbGljdEV4Y2VwdGlvbikge1xuICAgICAgICB0aHJvdyBlcnJvcjtcbiAgICAgIH1cbiAgICAgIHRocm93IG5ldyBJbnRlcm5hbFNlcnZlckVycm9yRXhjZXB0aW9uKCdUaGVyYXBpc3QgcmVnaXN0cmF0aW9uIGZhaWxlZCcpO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGdldFVzZXJzKCkge1xuICAgIHJldHVybiB0aGlzLnByaXNtYS51c2VyLmZpbmRNYW55KHtcbiAgICAgIHdoZXJlOiB7XG4gICAgICAgIGRlYWN0aXZhdGVkQXQ6IG51bGwsXG4gICAgICB9LFxuICAgICAgc2VsZWN0OiB7XG4gICAgICAgIGlkOiB0cnVlLFxuICAgICAgICBlbWFpbDogdHJ1ZSxcbiAgICAgICAgZmlyc3ROYW1lOiB0cnVlLFxuICAgICAgICBsYXN0TmFtZTogdHJ1ZSxcbiAgICAgICAgcm9sZTogdHJ1ZSxcbiAgICAgICAgZW1haWxWZXJpZmllZDogdHJ1ZSxcbiAgICAgICAgY3JlYXRlZEF0OiB0cnVlLFxuICAgICAgICB1cGRhdGVkQXQ6IHRydWUsXG4gICAgICAgIGNsaWVudDoge1xuICAgICAgICAgIHNlbGVjdDoge1xuICAgICAgICAgICAgdXNlcklkOiB0cnVlLFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICAgIHRoZXJhcGlzdDoge1xuICAgICAgICAgIHNlbGVjdDoge1xuICAgICAgICAgICAgdXNlcklkOiB0cnVlLFxuICAgICAgICAgICAgc3RhdHVzOiB0cnVlLFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgICAgb3JkZXJCeToge1xuICAgICAgICBjcmVhdGVkQXQ6ICdkZXNjJyxcbiAgICAgIH0sXG4gICAgfSk7XG4gIH1cblxuICBhc3luYyBnZXRVc2VyKHVzZXJJZDogc3RyaW5nKSB7XG4gICAgY29uc3QgdXNlciA9IGF3YWl0IHRoaXMucHJpc21hLnVzZXIuZmluZFVuaXF1ZSh7XG4gICAgICB3aGVyZToge1xuICAgICAgICBpZDogdXNlcklkLFxuICAgICAgICBkZWFjdGl2YXRlZEF0OiBudWxsLFxuICAgICAgfSxcbiAgICAgIHNlbGVjdDoge1xuICAgICAgICBpZDogdHJ1ZSxcbiAgICAgICAgZW1haWw6IHRydWUsXG4gICAgICAgIGZpcnN0TmFtZTogdHJ1ZSxcbiAgICAgICAgbGFzdE5hbWU6IHRydWUsXG4gICAgICAgIHJvbGU6IHRydWUsXG4gICAgICAgIGVtYWlsVmVyaWZpZWQ6IHRydWUsXG4gICAgICAgIGNyZWF0ZWRBdDogdHJ1ZSxcbiAgICAgICAgdXBkYXRlZEF0OiB0cnVlLFxuICAgICAgICBjbGllbnQ6IHtcbiAgICAgICAgICBzZWxlY3Q6IHtcbiAgICAgICAgICAgIHVzZXJJZDogdHJ1ZSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgICB0aGVyYXBpc3Q6IHtcbiAgICAgICAgICBzZWxlY3Q6IHtcbiAgICAgICAgICAgIHVzZXJJZDogdHJ1ZSxcbiAgICAgICAgICAgIHN0YXR1czogdHJ1ZSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgfSxcbiAgICB9KTtcblxuICAgIGlmICghdXNlcikge1xuICAgICAgdGhyb3cgbmV3IFVuYXV0aG9yaXplZEV4Y2VwdGlvbignVXNlciBub3QgZm91bmQnKTtcbiAgICB9XG5cbiAgICByZXR1cm4gdXNlcjtcbiAgfVxuXG4gIGFzeW5jIGZvcmNlTG9nb3V0KHVzZXJJZDogc3RyaW5nKSB7XG4gICAgdHJ5IHtcbiAgICAgIC8vIFJldm9rZSBhbGwgSldUIHJlZnJlc2ggdG9rZW5zIGZvciB0aGUgdXNlclxuICAgICAgYXdhaXQgdGhpcy50b2tlblNlcnZpY2UucmV2b2tlQWxsVXNlclRva2Vucyh1c2VySWQpO1xuXG4gICAgICByZXR1cm4geyBzdWNjZXNzOiB0cnVlLCBtZXNzYWdlOiAnVXNlciBzZXNzaW9ucyByZXZva2VkIHN1Y2Nlc3NmdWxseScgfTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc29sZS5lcnJvcihcbiAgICAgICAgJ0ZvcmNlIGxvZ291dCBlcnJvcjonLFxuICAgICAgICBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6IGVycm9yLFxuICAgICAgKTtcbiAgICAgIHRocm93IG5ldyBJbnRlcm5hbFNlcnZlckVycm9yRXhjZXB0aW9uKCdGb3JjZSBsb2dvdXQgZmFpbGVkJyk7XG4gICAgfVxuICB9XG5cbiAgLy8gTG9jYWwgQXV0aGVudGljYXRpb24gTWV0aG9kc1xuICBhc3luYyByZWdpc3RlclVzZXJXaXRoRW1haWwoXG4gICAgZW1haWw6IHN0cmluZyxcbiAgICBwYXNzd29yZDogc3RyaW5nLFxuICAgIGZpcnN0TmFtZTogc3RyaW5nLFxuICAgIGxhc3ROYW1lOiBzdHJpbmcsXG4gICAgcm9sZTogJ2NsaWVudCcgfCAndGhlcmFwaXN0JyA9ICdjbGllbnQnLFxuICAgIGFkZGl0aW9uYWxEYXRhPzogYW55LFxuICApOiBQcm9taXNlPHsgdXNlcjogYW55OyBtZXNzYWdlOiBzdHJpbmcgfT4ge1xuICAgIC8vIENoZWNrIGlmIHVzZXIgYWxyZWFkeSBleGlzdHNcbiAgICBjb25zdCBleGlzdGluZ1VzZXIgPSBhd2FpdCB0aGlzLnByaXNtYS51c2VyLmZpbmRVbmlxdWUoe1xuICAgICAgd2hlcmU6IHsgZW1haWwgfSxcbiAgICB9KTtcblxuICAgIGlmIChleGlzdGluZ1VzZXIpIHtcbiAgICAgIHRocm93IG5ldyBDb25mbGljdEV4Y2VwdGlvbignVXNlciB3aXRoIHRoaXMgZW1haWwgYWxyZWFkeSBleGlzdHMnKTtcbiAgICB9XG5cbiAgICAvLyBIYXNoIHBhc3N3b3JkXG4gICAgY29uc3QgaGFzaGVkUGFzc3dvcmQgPSBhd2FpdCB0aGlzLnRva2VuU2VydmljZS5oYXNoUGFzc3dvcmQocGFzc3dvcmQpO1xuXG4gICAgLy8gR2VuZXJhdGUgZW1haWwgdmVyaWZpY2F0aW9uIHRva2VuXG4gICAgY29uc3QgeyBoYXNoZWRUb2tlbiwgZXhwaXJlc0F0IH0gPVxuICAgICAgYXdhaXQgdGhpcy50b2tlblNlcnZpY2UuZ2VuZXJhdGVFbWFpbFZlcmlmaWNhdGlvblRva2VuKCk7XG5cbiAgICAvLyBDcmVhdGUgdXNlclxuICAgIGNvbnN0IHVzZXJEYXRhID0ge1xuICAgICAgZW1haWwsXG4gICAgICBwYXNzd29yZDogaGFzaGVkUGFzc3dvcmQsXG4gICAgICBmaXJzdE5hbWUsXG4gICAgICBsYXN0TmFtZSxcbiAgICAgIHJvbGUsXG4gICAgICBlbWFpbFZlcmlmeVRva2VuOiBoYXNoZWRUb2tlbixcbiAgICAgIGVtYWlsVmVyaWZ5VG9rZW5FeHA6IGV4cGlyZXNBdCxcbiAgICAgIC4uLmFkZGl0aW9uYWxEYXRhLFxuICAgIH07XG5cbiAgICBjb25zdCB1c2VyID0gYXdhaXQgdGhpcy5wcmlzbWEudXNlci5jcmVhdGUoe1xuICAgICAgZGF0YTogdXNlckRhdGEsXG4gICAgICBzZWxlY3Q6IHtcbiAgICAgICAgaWQ6IHRydWUsXG4gICAgICAgIGVtYWlsOiB0cnVlLFxuICAgICAgICBmaXJzdE5hbWU6IHRydWUsXG4gICAgICAgIGxhc3ROYW1lOiB0cnVlLFxuICAgICAgICByb2xlOiB0cnVlLFxuICAgICAgICBlbWFpbFZlcmlmaWVkOiB0cnVlLFxuICAgICAgfSxcbiAgICB9KTtcblxuICAgIC8vIENyZWF0ZSByb2xlLXNwZWNpZmljIHJlY29yZFxuICAgIGlmIChyb2xlID09PSAnY2xpZW50Jykge1xuICAgICAgYXdhaXQgdGhpcy5wcmlzbWEuY2xpZW50LmNyZWF0ZSh7XG4gICAgICAgIGRhdGE6IHsgdXNlcklkOiB1c2VyLmlkIH0sXG4gICAgICB9KTtcbiAgICB9IGVsc2UgaWYgKHJvbGUgPT09ICd0aGVyYXBpc3QnKSB7XG4gICAgICBhd2FpdCB0aGlzLnByaXNtYS50aGVyYXBpc3QuY3JlYXRlKHtcbiAgICAgICAgZGF0YToge1xuICAgICAgICAgIHVzZXJJZDogdXNlci5pZCxcbiAgICAgICAgICBzdGF0dXM6ICdwZW5kaW5nJyxcbiAgICAgICAgICBtb2JpbGU6ICcnLFxuICAgICAgICAgIHByb3ZpbmNlOiAnJyxcbiAgICAgICAgICBwcm92aWRlclR5cGU6ICcnLFxuICAgICAgICAgIHByb2Zlc3Npb25hbExpY2Vuc2VUeXBlOiAnJyxcbiAgICAgICAgICBpc1BSQ0xpY2Vuc2VkOiAnJyxcbiAgICAgICAgICBwcmNMaWNlbnNlTnVtYmVyOiAnJyxcbiAgICAgICAgICBleHBpcmF0aW9uRGF0ZU9mTGljZW5zZTogbmV3IERhdGUoKSxcbiAgICAgICAgICBwcmFjdGljZVN0YXJ0RGF0ZTogbmV3IERhdGUoKSxcbiAgICAgICAgICBzZXNzaW9uTGVuZ3RoOiAnJyxcbiAgICAgICAgICBob3VybHlSYXRlOiAwLFxuICAgICAgICAgIHByb3ZpZGVkT25saW5lVGhlcmFweUJlZm9yZTogZmFsc2UsXG4gICAgICAgICAgY29tZm9ydGFibGVVc2luZ1ZpZGVvQ29uZmVyZW5jaW5nOiBmYWxzZSxcbiAgICAgICAgICBjb21wbGllc1dpdGhEYXRhUHJpdmFjeUFjdDogZmFsc2UsXG4gICAgICAgICAgd2lsbGluZ1RvQWJpZGVCeVBsYXRmb3JtR3VpZGVsaW5lczogZmFsc2UsXG4gICAgICAgICAgdHJlYXRtZW50U3VjY2Vzc1JhdGVzOiB7fSxcbiAgICAgICAgfSxcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIC8vIFNlbmQgdmVyaWZpY2F0aW9uIGVtYWlsXG4gICAgYXdhaXQgdGhpcy5lbWFpbFZlcmlmaWNhdGlvblNlcnZpY2Uuc2VuZFZlcmlmaWNhdGlvbkVtYWlsKHVzZXIuaWQpO1xuXG4gICAgLy8gUHVibGlzaCByZWdpc3RyYXRpb24gZXZlbnRcbiAgICBhd2FpdCB0aGlzLmV2ZW50QnVzLmVtaXQoXG4gICAgICBuZXcgVXNlclJlZ2lzdGVyZWRFdmVudCh7XG4gICAgICAgIHVzZXJJZDogdXNlci5pZCxcbiAgICAgICAgZW1haWw6IHVzZXIuZW1haWwsXG4gICAgICAgIGZpcnN0TmFtZTogdXNlci5maXJzdE5hbWUsXG4gICAgICAgIGxhc3ROYW1lOiB1c2VyLmxhc3ROYW1lLFxuICAgICAgICByb2xlLFxuICAgICAgICByZWdpc3RyYXRpb25NZXRob2Q6ICdlbWFpbCcsXG4gICAgICB9KSxcbiAgICApO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIHVzZXIsXG4gICAgICBtZXNzYWdlOlxuICAgICAgICAnVXNlciByZWdpc3RlcmVkIHN1Y2Nlc3NmdWxseS4gUGxlYXNlIGNoZWNrIHlvdXIgZW1haWwgdG8gdmVyaWZ5IHlvdXIgYWNjb3VudC4nLFxuICAgIH07XG4gIH1cblxuICBhc3luYyBsb2dpbldpdGhFbWFpbChcbiAgICBlbWFpbDogc3RyaW5nLFxuICAgIHBhc3N3b3JkOiBzdHJpbmcsXG4gICAgaXBBZGRyZXNzPzogc3RyaW5nLFxuICAgIHVzZXJBZ2VudD86IHN0cmluZyxcbiAgKTogUHJvbWlzZTx7IHVzZXI6IGFueTsgdG9rZW5zOiBUb2tlblBhaXIgfT4ge1xuICAgIGNvbnN0IHVzZXIgPSBhd2FpdCB0aGlzLnByaXNtYS51c2VyLmZpbmRVbmlxdWUoe1xuICAgICAgd2hlcmU6IHsgZW1haWwgfSxcbiAgICAgIHNlbGVjdDoge1xuICAgICAgICBpZDogdHJ1ZSxcbiAgICAgICAgZW1haWw6IHRydWUsXG4gICAgICAgIGZpcnN0TmFtZTogdHJ1ZSxcbiAgICAgICAgbGFzdE5hbWU6IHRydWUsXG4gICAgICAgIHJvbGU6IHRydWUsXG4gICAgICAgIHBhc3N3b3JkOiB0cnVlLFxuICAgICAgICBlbWFpbFZlcmlmaWVkOiB0cnVlLFxuICAgICAgICBkZWFjdGl2YXRlZEF0OiB0cnVlLFxuICAgICAgICBsb2Nrb3V0VW50aWw6IHRydWUsXG4gICAgICAgIGZhaWxlZExvZ2luQ291bnQ6IHRydWUsXG4gICAgICAgIGNsaWVudDogdHJ1ZSxcbiAgICAgICAgdGhlcmFwaXN0OiB0cnVlLFxuICAgICAgfSxcbiAgICB9KTtcblxuICAgIGlmICghdXNlcikge1xuICAgICAgdGhyb3cgbmV3IFVuYXV0aG9yaXplZEV4Y2VwdGlvbignSW52YWxpZCBjcmVkZW50aWFscycpO1xuICAgIH1cblxuICAgIGlmICh1c2VyLmRlYWN0aXZhdGVkQXQpIHtcbiAgICAgIHRocm93IG5ldyBVbmF1dGhvcml6ZWRFeGNlcHRpb24oJ0FjY291bnQgaGFzIGJlZW4gZGVhY3RpdmF0ZWQnKTtcbiAgICB9XG5cbiAgICBpZiAoIXVzZXIucGFzc3dvcmQpIHtcbiAgICAgIHRocm93IG5ldyBVbmF1dGhvcml6ZWRFeGNlcHRpb24oXG4gICAgICAgICdQbGVhc2UgY29tcGxldGUgYWNjb3VudCBzZXR1cCBvciByZXNldCB5b3VyIHBhc3N3b3JkJyxcbiAgICAgICk7XG4gICAgfVxuXG4gICAgLy8gQ2hlY2sgYWNjb3VudCBsb2Nrb3V0XG4gICAgY29uc3QgaXNMb2NrZWRPdXQgPSBhd2FpdCB0aGlzLnRva2VuU2VydmljZS5jaGVja0FjY291bnRMb2Nrb3V0KHVzZXIuaWQpO1xuICAgIGlmIChpc0xvY2tlZE91dCkge1xuICAgICAgdGhyb3cgbmV3IFVuYXV0aG9yaXplZEV4Y2VwdGlvbihcbiAgICAgICAgJ0FjY291bnQgaXMgdGVtcG9yYXJpbHkgbG9ja2VkIGR1ZSB0byB0b28gbWFueSBmYWlsZWQgbG9naW4gYXR0ZW1wdHMnLFxuICAgICAgKTtcbiAgICB9XG5cbiAgICAvLyBWZXJpZnkgcGFzc3dvcmRcbiAgICBjb25zdCBpc1Bhc3N3b3JkVmFsaWQgPSBhd2FpdCB0aGlzLnRva2VuU2VydmljZS5jb21wYXJlUGFzc3dvcmQoXG4gICAgICBwYXNzd29yZCxcbiAgICAgIHVzZXIucGFzc3dvcmQsXG4gICAgKTtcbiAgICBpZiAoIWlzUGFzc3dvcmRWYWxpZCkge1xuICAgICAgYXdhaXQgdGhpcy50b2tlblNlcnZpY2UuaGFuZGxlRmFpbGVkTG9naW4odXNlci5pZCk7XG4gICAgICB0aHJvdyBuZXcgVW5hdXRob3JpemVkRXhjZXB0aW9uKCdJbnZhbGlkIGNyZWRlbnRpYWxzJyk7XG4gICAgfVxuXG4gICAgLy8gQ2hlY2sgZW1haWwgdmVyaWZpY2F0aW9uXG4gICAgaWYgKCF1c2VyLmVtYWlsVmVyaWZpZWQpIHtcbiAgICAgIHRocm93IG5ldyBVbmF1dGhvcml6ZWRFeGNlcHRpb24oXG4gICAgICAgICdQbGVhc2UgdmVyaWZ5IHlvdXIgZW1haWwgYWRkcmVzcyBiZWZvcmUgbG9nZ2luZyBpbicsXG4gICAgICApO1xuICAgIH1cblxuICAgIC8vIFJlc2V0IGZhaWxlZCBsb2dpbiBjb3VudCBhbmQgdXBkYXRlIGxhc3QgbG9naW5cbiAgICBhd2FpdCB0aGlzLnRva2VuU2VydmljZS5yZXNldEZhaWxlZExvZ2luQ291bnQodXNlci5pZCk7XG5cbiAgICAvLyBHZW5lcmF0ZSB0b2tlbnNcbiAgICBjb25zdCB0b2tlbnMgPSBhd2FpdCB0aGlzLnRva2VuU2VydmljZS5nZW5lcmF0ZVRva2VuUGFpcihcbiAgICAgIHVzZXIuaWQsXG4gICAgICB1c2VyLmVtYWlsLFxuICAgICAgdXNlci5yb2xlLFxuICAgICAgaXBBZGRyZXNzLFxuICAgICAgdXNlckFnZW50LFxuICAgICk7XG5cbiAgICAvLyBSZW1vdmUgc2Vuc2l0aXZlIGRhdGEgZnJvbSB1c2VyIG9iamVjdFxuICAgIGNvbnN0IHtcbiAgICAgIHBhc3N3b3JkOiBfLFxuICAgICAgbG9ja291dFVudGlsOiBfXyxcbiAgICAgIGZhaWxlZExvZ2luQ291bnQ6IF9fXyxcbiAgICAgIC4uLnNhZmVVc2VyXG4gICAgfSA9IHVzZXI7XG5cbiAgICByZXR1cm4geyB1c2VyOiBzYWZlVXNlciwgdG9rZW5zIH07XG4gIH1cblxuICBhc3luYyByZWZyZXNoVG9rZW5zKFxuICAgIHJlZnJlc2hUb2tlbjogc3RyaW5nLFxuICAgIGlwQWRkcmVzcz86IHN0cmluZyxcbiAgICB1c2VyQWdlbnQ/OiBzdHJpbmcsXG4gICk6IFByb21pc2U8VG9rZW5QYWlyPiB7XG4gICAgcmV0dXJuIHRoaXMudG9rZW5TZXJ2aWNlLnJlZnJlc2hBY2Nlc3NUb2tlbihcbiAgICAgIHJlZnJlc2hUb2tlbixcbiAgICAgIGlwQWRkcmVzcyxcbiAgICAgIHVzZXJBZ2VudCxcbiAgICApO1xuICB9XG5cbiAgYXN5bmMgbG9nb3V0KHJlZnJlc2hUb2tlbjogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgYXdhaXQgdGhpcy50b2tlblNlcnZpY2UucmV2b2tlUmVmcmVzaFRva2VuKHJlZnJlc2hUb2tlbik7XG4gIH1cblxuICBhc3luYyB2YWxpZGF0ZVVzZXIodXNlcklkOiBzdHJpbmcpIHtcbiAgICByZXR1cm4gdGhpcy5wcmlzbWEudXNlci5maW5kVW5pcXVlKHtcbiAgICAgIHdoZXJlOiB7XG4gICAgICAgIGlkOiB1c2VySWQsXG4gICAgICAgIGRlYWN0aXZhdGVkQXQ6IG51bGwsXG4gICAgICB9LFxuICAgICAgc2VsZWN0OiB7XG4gICAgICAgIGlkOiB0cnVlLFxuICAgICAgICBlbWFpbDogdHJ1ZSxcbiAgICAgICAgZmlyc3ROYW1lOiB0cnVlLFxuICAgICAgICBsYXN0TmFtZTogdHJ1ZSxcbiAgICAgICAgcm9sZTogdHJ1ZSxcbiAgICAgICAgY2xpZW50OiB0cnVlLFxuICAgICAgICB0aGVyYXBpc3Q6IHRydWUsXG4gICAgICB9LFxuICAgIH0pO1xuICB9XG5cbiAgLy8gRW1haWwgdmVyaWZpY2F0aW9uIG1ldGhvZHNcbiAgYXN5bmMgdmVyaWZ5RW1haWwoXG4gICAgdG9rZW46IHN0cmluZyxcbiAgKTogUHJvbWlzZTx7IHN1Y2Nlc3M6IGJvb2xlYW47IG1lc3NhZ2U6IHN0cmluZyB9PiB7XG4gICAgcmV0dXJuIHRoaXMuZW1haWxWZXJpZmljYXRpb25TZXJ2aWNlLnZlcmlmeUVtYWlsKHRva2VuKTtcbiAgfVxuXG4gIGFzeW5jIHJlc2VuZFZlcmlmaWNhdGlvbkVtYWlsKGVtYWlsOiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICByZXR1cm4gdGhpcy5lbWFpbFZlcmlmaWNhdGlvblNlcnZpY2UucmVzZW5kVmVyaWZpY2F0aW9uRW1haWwoZW1haWwpO1xuICB9XG5cbiAgLy8gUGFzc3dvcmQgcmVzZXQgbWV0aG9kc1xuICBhc3luYyByZXF1ZXN0UGFzc3dvcmRSZXNldChlbWFpbDogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgcmV0dXJuIHRoaXMucGFzc3dvcmRSZXNldFNlcnZpY2UucmVxdWVzdFBhc3N3b3JkUmVzZXQoZW1haWwpO1xuICB9XG5cbiAgYXN5bmMgcmVzZXRQYXNzd29yZChcbiAgICB0b2tlbjogc3RyaW5nLFxuICAgIG5ld1Bhc3N3b3JkOiBzdHJpbmcsXG4gICk6IFByb21pc2U8eyBzdWNjZXNzOiBib29sZWFuOyBtZXNzYWdlOiBzdHJpbmcgfT4ge1xuICAgIHJldHVybiB0aGlzLnBhc3N3b3JkUmVzZXRTZXJ2aWNlLnJlc2V0UGFzc3dvcmQodG9rZW4sIG5ld1Bhc3N3b3JkKTtcbiAgfVxuXG4gIGFzeW5jIHZhbGlkYXRlUmVzZXRUb2tlbihcbiAgICB0b2tlbjogc3RyaW5nLFxuICApOiBQcm9taXNlPHsgdmFsaWQ6IGJvb2xlYW47IGVtYWlsPzogc3RyaW5nIH0+IHtcbiAgICByZXR1cm4gdGhpcy5wYXNzd29yZFJlc2V0U2VydmljZS52YWxpZGF0ZVJlc2V0VG9rZW4odG9rZW4pO1xuICB9XG5cbiAgLy8gQWNjb3VudCBtYW5hZ2VtZW50IG1ldGhvZHNcbiAgYXN5bmMgY2hhbmdlUGFzc3dvcmQoXG4gICAgdXNlcklkOiBzdHJpbmcsXG4gICAgY3VycmVudFBhc3N3b3JkOiBzdHJpbmcsXG4gICAgbmV3UGFzc3dvcmQ6IHN0cmluZyxcbiAgKTogUHJvbWlzZTx7IHN1Y2Nlc3M6IGJvb2xlYW47IG1lc3NhZ2U6IHN0cmluZyB9PiB7XG4gICAgY29uc3QgdXNlciA9IGF3YWl0IHRoaXMucHJpc21hLnVzZXIuZmluZFVuaXF1ZSh7XG4gICAgICB3aGVyZTogeyBpZDogdXNlcklkIH0sXG4gICAgICBzZWxlY3Q6IHsgcGFzc3dvcmQ6IHRydWUsIGRlYWN0aXZhdGVkQXQ6IHRydWUgfSxcbiAgICB9KTtcblxuICAgIGlmICghdXNlciB8fCB1c2VyLmRlYWN0aXZhdGVkQXQpIHtcbiAgICAgIHRocm93IG5ldyBVbmF1dGhvcml6ZWRFeGNlcHRpb24oJ1VzZXIgbm90IGZvdW5kIG9yIGRlYWN0aXZhdGVkJyk7XG4gICAgfVxuXG4gICAgaWYgKCF1c2VyLnBhc3N3b3JkKSB7XG4gICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdEV4Y2VwdGlvbignUGxlYXNlIGNvbXBsZXRlIGFjY291bnQgc2V0dXAgZmlyc3QnKTtcbiAgICB9XG5cbiAgICAvLyBWZXJpZnkgY3VycmVudCBwYXNzd29yZFxuICAgIGNvbnN0IGlzQ3VycmVudFBhc3N3b3JkVmFsaWQgPSBhd2FpdCB0aGlzLnRva2VuU2VydmljZS5jb21wYXJlUGFzc3dvcmQoXG4gICAgICBjdXJyZW50UGFzc3dvcmQsXG4gICAgICB1c2VyLnBhc3N3b3JkLFxuICAgICk7XG4gICAgaWYgKCFpc0N1cnJlbnRQYXNzd29yZFZhbGlkKSB7XG4gICAgICB0aHJvdyBuZXcgVW5hdXRob3JpemVkRXhjZXB0aW9uKCdDdXJyZW50IHBhc3N3b3JkIGlzIGluY29ycmVjdCcpO1xuICAgIH1cblxuICAgIC8vIENoZWNrIGlmIG5ldyBwYXNzd29yZCBpcyBkaWZmZXJlbnRcbiAgICBjb25zdCBpc1NhbWVQYXNzd29yZCA9IGF3YWl0IHRoaXMudG9rZW5TZXJ2aWNlLmNvbXBhcmVQYXNzd29yZChcbiAgICAgIG5ld1Bhc3N3b3JkLFxuICAgICAgdXNlci5wYXNzd29yZCxcbiAgICApO1xuICAgIGlmIChpc1NhbWVQYXNzd29yZCkge1xuICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFeGNlcHRpb24oXG4gICAgICAgICdOZXcgcGFzc3dvcmQgbXVzdCBiZSBkaWZmZXJlbnQgZnJvbSBjdXJyZW50IHBhc3N3b3JkJyxcbiAgICAgICk7XG4gICAgfVxuXG4gICAgLy8gSGFzaCBuZXcgcGFzc3dvcmRcbiAgICBjb25zdCBoYXNoZWRQYXNzd29yZCA9IGF3YWl0IHRoaXMudG9rZW5TZXJ2aWNlLmhhc2hQYXNzd29yZChuZXdQYXNzd29yZCk7XG5cbiAgICAvLyBVcGRhdGUgcGFzc3dvcmRcbiAgICBhd2FpdCB0aGlzLnByaXNtYS51c2VyLnVwZGF0ZSh7XG4gICAgICB3aGVyZTogeyBpZDogdXNlcklkIH0sXG4gICAgICBkYXRhOiB7IHBhc3N3b3JkOiBoYXNoZWRQYXNzd29yZCB9LFxuICAgIH0pO1xuXG4gICAgLy8gUmV2b2tlIGFsbCByZWZyZXNoIHRva2VucyBmb3Igc2VjdXJpdHlcbiAgICBhd2FpdCB0aGlzLnRva2VuU2VydmljZS5yZXZva2VBbGxVc2VyVG9rZW5zKHVzZXJJZCk7XG5cbiAgICByZXR1cm4ge1xuICAgICAgc3VjY2VzczogdHJ1ZSxcbiAgICAgIG1lc3NhZ2U6ICdQYXNzd29yZCBjaGFuZ2VkIHN1Y2Nlc3NmdWxseS4gUGxlYXNlIGxvZyBpbiBhZ2Fpbi4nLFxuICAgIH07XG4gIH1cblxuICBhc3luYyBkZWFjdGl2YXRlQWNjb3VudChcbiAgICB1c2VySWQ6IHN0cmluZyxcbiAgICByZWFzb24/OiBzdHJpbmcsXG4gICAgZGVhY3RpdmF0ZWRCeT86IHN0cmluZyxcbiAgKTogUHJvbWlzZTx7IHN1Y2Nlc3M6IGJvb2xlYW47IG1lc3NhZ2U6IHN0cmluZyB9PiB7XG4gICAgYXdhaXQgdGhpcy5wcmlzbWEudXNlci51cGRhdGUoe1xuICAgICAgd2hlcmU6IHsgaWQ6IHVzZXJJZCB9LFxuICAgICAgZGF0YToge1xuICAgICAgICBkZWFjdGl2YXRlZEF0OiBuZXcgRGF0ZSgpLFxuICAgICAgICBkZWFjdGl2YXRlZEJ5LFxuICAgICAgICBkZWFjdGl2YXRpb25SZWFzb246IHJlYXNvbixcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICAvLyBSZXZva2UgYWxsIHRva2Vuc1xuICAgIGF3YWl0IHRoaXMudG9rZW5TZXJ2aWNlLnJldm9rZUFsbFVzZXJUb2tlbnModXNlcklkKTtcblxuICAgIHJldHVybiB7XG4gICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgbWVzc2FnZTogJ0FjY291bnQgZGVhY3RpdmF0ZWQgc3VjY2Vzc2Z1bGx5JyxcbiAgICB9O1xuICB9XG5cbiAgYXN5bmMgcmVhY3RpdmF0ZUFjY291bnQoXG4gICAgdXNlcklkOiBzdHJpbmcsXG4gICk6IFByb21pc2U8eyBzdWNjZXNzOiBib29sZWFuOyBtZXNzYWdlOiBzdHJpbmcgfT4ge1xuICAgIGF3YWl0IHRoaXMucHJpc21hLnVzZXIudXBkYXRlKHtcbiAgICAgIHdoZXJlOiB7IGlkOiB1c2VySWQgfSxcbiAgICAgIGRhdGE6IHtcbiAgICAgICAgZGVhY3RpdmF0ZWRBdDogbnVsbCxcbiAgICAgICAgZGVhY3RpdmF0ZWRCeTogbnVsbCxcbiAgICAgICAgZGVhY3RpdmF0aW9uUmVhc29uOiBudWxsLFxuICAgICAgICBmYWlsZWRMb2dpbkNvdW50OiAwLFxuICAgICAgICBsb2Nrb3V0VW50aWw6IG51bGwsXG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICBtZXNzYWdlOiAnQWNjb3VudCByZWFjdGl2YXRlZCBzdWNjZXNzZnVsbHknLFxuICAgIH07XG4gIH1cblxuICBhc3luYyBoYW5kbGVPQXV0aExvZ2luKG9hdXRoVXNlcjogYW55LCBwcm92aWRlcjogc3RyaW5nKSB7XG4gICAgdHJ5IHtcbiAgICAgIC8vIENoZWNrIGlmIHVzZXIgZXhpc3RzXG4gICAgICBjb25zdCBleGlzdGluZ1VzZXIgPSBhd2FpdCB0aGlzLnByaXNtYS51c2VyLmZpbmRVbmlxdWUoe1xuICAgICAgICB3aGVyZTogeyBlbWFpbDogb2F1dGhVc2VyLmVtYWlsIH0sXG4gICAgICB9KTtcblxuICAgICAgaWYgKGV4aXN0aW5nVXNlcikge1xuICAgICAgICAvLyBVc2VyIGV4aXN0cywgZ2VuZXJhdGUgdG9rZW5zIGFuZCByZXR1cm5cbiAgICAgICAgY29uc3QgdG9rZW5zID0gYXdhaXQgdGhpcy50b2tlblNlcnZpY2UuZ2VuZXJhdGVUb2tlblBhaXIoXG4gICAgICAgICAgZXhpc3RpbmdVc2VyLmlkLFxuICAgICAgICAgIGV4aXN0aW5nVXNlci5lbWFpbCxcbiAgICAgICAgICBleGlzdGluZ1VzZXIucm9sZSxcbiAgICAgICAgKTtcblxuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIHVzZXI6IHtcbiAgICAgICAgICAgIGlkOiBleGlzdGluZ1VzZXIuaWQsXG4gICAgICAgICAgICBlbWFpbDogZXhpc3RpbmdVc2VyLmVtYWlsLFxuICAgICAgICAgICAgZmlyc3ROYW1lOiBleGlzdGluZ1VzZXIuZmlyc3ROYW1lLFxuICAgICAgICAgICAgbGFzdE5hbWU6IGV4aXN0aW5nVXNlci5sYXN0TmFtZSxcbiAgICAgICAgICAgIHJvbGU6IGV4aXN0aW5nVXNlci5yb2xlLFxuICAgICAgICAgICAgZW1haWxWZXJpZmllZDogZXhpc3RpbmdVc2VyLmVtYWlsVmVyaWZpZWQsXG4gICAgICAgICAgfSxcbiAgICAgICAgICBhY2Nlc3NUb2tlbjogdG9rZW5zLmFjY2Vzc1Rva2VuLFxuICAgICAgICAgIHJlZnJlc2hUb2tlbjogdG9rZW5zLnJlZnJlc2hUb2tlbixcbiAgICAgICAgICBleHBpcmVzSW46IHRva2Vucy5leHBpcmVzSW4sXG4gICAgICAgICAgbWVzc2FnZTogJ0xvZ2luIHN1Y2Nlc3NmdWwnLFxuICAgICAgICB9O1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgLy8gQ3JlYXRlIG5ldyB1c2VyIGZyb20gT0F1dGggZGF0YVxuICAgICAgICBjb25zdCBuZXdVc2VyID0gYXdhaXQgdGhpcy5wcmlzbWEudXNlci5jcmVhdGUoe1xuICAgICAgICAgIGRhdGE6IHtcbiAgICAgICAgICAgIGVtYWlsOiBvYXV0aFVzZXIuZW1haWwsXG4gICAgICAgICAgICBmaXJzdE5hbWU6IG9hdXRoVXNlci5maXJzdE5hbWUsXG4gICAgICAgICAgICBsYXN0TmFtZTogb2F1dGhVc2VyLmxhc3ROYW1lLFxuICAgICAgICAgICAgcm9sZTogJ2NsaWVudCcsIC8vIERlZmF1bHQgcm9sZVxuICAgICAgICAgICAgZW1haWxWZXJpZmllZDogdHJ1ZSwgLy8gT0F1dGggZW1haWxzIGFyZSBwcmUtdmVyaWZpZWRcbiAgICAgICAgICAgIGF2YXRhclVybDogb2F1dGhVc2VyLnBpY3R1cmUsXG4gICAgICAgICAgfSxcbiAgICAgICAgICBzZWxlY3Q6IHtcbiAgICAgICAgICAgIGlkOiB0cnVlLFxuICAgICAgICAgICAgZW1haWw6IHRydWUsXG4gICAgICAgICAgICBmaXJzdE5hbWU6IHRydWUsXG4gICAgICAgICAgICBsYXN0TmFtZTogdHJ1ZSxcbiAgICAgICAgICAgIHJvbGU6IHRydWUsXG4gICAgICAgICAgICBlbWFpbFZlcmlmaWVkOiB0cnVlLFxuICAgICAgICAgIH0sXG4gICAgICAgIH0pO1xuXG4gICAgICAgIC8vIENyZWF0ZSBjbGllbnQgcmVjb3JkIGZvciBuZXcgdXNlclxuICAgICAgICBhd2FpdCB0aGlzLnByaXNtYS5jbGllbnQuY3JlYXRlKHtcbiAgICAgICAgICBkYXRhOiB7IHVzZXJJZDogbmV3VXNlci5pZCB9LFxuICAgICAgICB9KTtcblxuICAgICAgICBjb25zdCB0b2tlbnMgPSBhd2FpdCB0aGlzLnRva2VuU2VydmljZS5nZW5lcmF0ZVRva2VuUGFpcihcbiAgICAgICAgICBuZXdVc2VyLmlkLFxuICAgICAgICAgIG5ld1VzZXIuZW1haWwsXG4gICAgICAgICAgbmV3VXNlci5yb2xlLFxuICAgICAgICApO1xuXG4gICAgICAgIC8vIEVtaXQgdXNlciByZWdpc3RyYXRpb24gZXZlbnRcbiAgICAgICAgdGhpcy5ldmVudEJ1cy5lbWl0KFxuICAgICAgICAgIG5ldyBVc2VyUmVnaXN0ZXJlZEV2ZW50KHtcbiAgICAgICAgICAgIHVzZXJJZDogbmV3VXNlci5pZCxcbiAgICAgICAgICAgIGVtYWlsOiBuZXdVc2VyLmVtYWlsLFxuICAgICAgICAgICAgZmlyc3ROYW1lOiBuZXdVc2VyLmZpcnN0TmFtZSxcbiAgICAgICAgICAgIGxhc3ROYW1lOiBuZXdVc2VyLmxhc3ROYW1lLFxuICAgICAgICAgICAgcm9sZTogbmV3VXNlci5yb2xlIGFzXG4gICAgICAgICAgICAgIHwgJ2NsaWVudCdcbiAgICAgICAgICAgICAgfCAndGhlcmFwaXN0J1xuICAgICAgICAgICAgICB8ICdtb2RlcmF0b3InXG4gICAgICAgICAgICAgIHwgJ2FkbWluJyxcbiAgICAgICAgICAgIHJlZ2lzdHJhdGlvbk1ldGhvZDogJ29hdXRoJyxcbiAgICAgICAgICB9KSxcbiAgICAgICAgKTtcblxuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIHVzZXI6IG5ld1VzZXIsXG4gICAgICAgICAgYWNjZXNzVG9rZW46IHRva2Vucy5hY2Nlc3NUb2tlbixcbiAgICAgICAgICByZWZyZXNoVG9rZW46IHRva2Vucy5yZWZyZXNoVG9rZW4sXG4gICAgICAgICAgZXhwaXJlc0luOiB0b2tlbnMuZXhwaXJlc0luLFxuICAgICAgICAgIG1lc3NhZ2U6ICdBY2NvdW50IGNyZWF0ZWQgc3VjY2Vzc2Z1bGx5JyxcbiAgICAgICAgfTtcbiAgICAgIH1cbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhyb3cgbmV3IEludGVybmFsU2VydmVyRXJyb3JFeGNlcHRpb24oXG4gICAgICAgIGBPQXV0aCBsb2dpbiBmYWlsZWQ6ICR7ZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiAnVW5rbm93biBlcnJvcid9YCxcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgLy8gPT09PT0gRklSU1QtVElNRSBVU0VSIEZMT1cgTUVUSE9EUyA9PT09PVxuXG4gIGFzeW5jIGdldEZpcnN0U2lnbkluU3RhdHVzKHVzZXJJZDogc3RyaW5nKSB7XG4gICAgY29uc3QgY2xpZW50ID0gYXdhaXQgdGhpcy5wcmlzbWEuY2xpZW50LmZpbmRVbmlxdWUoe1xuICAgICAgd2hlcmU6IHsgdXNlcklkIH0sXG4gICAgICBzZWxlY3Q6IHtcbiAgICAgICAgaGFzU2VlblRoZXJhcGlzdFJlY29tbWVuZGF0aW9uczogdHJ1ZSxcbiAgICAgICAgY3JlYXRlZEF0OiB0cnVlLFxuICAgICAgfSxcbiAgICB9KTtcblxuICAgIGlmICghY2xpZW50KSB7XG4gICAgICB0aHJvdyBuZXcgVW5hdXRob3JpemVkRXhjZXB0aW9uKCdDbGllbnQgcHJvZmlsZSBub3QgZm91bmQnKTtcbiAgICB9XG5cbiAgICByZXR1cm4ge1xuICAgICAgaXNGaXJzdFRpbWU6ICFjbGllbnQuaGFzU2VlblRoZXJhcGlzdFJlY29tbWVuZGF0aW9ucyxcbiAgICAgIG5lZWRzV2VsY29tZUZsb3c6ICFjbGllbnQuaGFzU2VlblRoZXJhcGlzdFJlY29tbWVuZGF0aW9ucyxcbiAgICAgIG1lbWJlclNpbmNlOiBjbGllbnQuY3JlYXRlZEF0LFxuICAgIH07XG4gIH1cblxuICBhc3luYyBtYXJrUmVjb21tZW5kYXRpb25zU2Vlbih1c2VySWQ6IHN0cmluZykge1xuICAgIGNvbnN0IHVwZGF0ZWRDbGllbnQgPSBhd2FpdCB0aGlzLnByaXNtYS5jbGllbnQudXBkYXRlKHtcbiAgICAgIHdoZXJlOiB7IHVzZXJJZCB9LFxuICAgICAgZGF0YTogeyBoYXNTZWVuVGhlcmFwaXN0UmVjb21tZW5kYXRpb25zOiB0cnVlIH0sXG4gICAgICBzZWxlY3Q6IHtcbiAgICAgICAgaGFzU2VlblRoZXJhcGlzdFJlY29tbWVuZGF0aW9uczogdHJ1ZSxcbiAgICAgICAgdXBkYXRlZEF0OiB0cnVlLFxuICAgICAgfSxcbiAgICB9KTtcblxuICAgIHJldHVybiB7XG4gICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgaGFzU2VlblJlY29tbWVuZGF0aW9uczogdXBkYXRlZENsaWVudC5oYXNTZWVuVGhlcmFwaXN0UmVjb21tZW5kYXRpb25zLFxuICAgICAgbWFya2VkQXQ6IHVwZGF0ZWRDbGllbnQudXBkYXRlZEF0LFxuICAgICAgbWVzc2FnZTogJ1JlY29tbWVuZGF0aW9ucyBtYXJrZWQgYXMgc2VlbiBzdWNjZXNzZnVsbHknLFxuICAgIH07XG4gIH1cbn1cbiJdLCJ2ZXJzaW9uIjozfQ==