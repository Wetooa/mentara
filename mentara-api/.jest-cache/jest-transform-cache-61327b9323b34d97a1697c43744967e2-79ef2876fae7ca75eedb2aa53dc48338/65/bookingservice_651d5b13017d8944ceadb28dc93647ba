c984aea1c5c6633b4214cfc041b67924
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var BookingService_1;
var _a, _b, _c, _d, _e, _f;
Object.defineProperty(exports, "__esModule", { value: true });
exports.BookingService = void 0;
const common_1 = require("@nestjs/common");
const prisma_client_provider_1 = require("../providers/prisma-client.provider");
const event_bus_service_1 = require("../common/events/event-bus.service");
const slot_generator_service_1 = require("./services/slot-generator.service");
const conflict_detection_service_1 = require("./services/conflict-detection.service");
const availability_validator_service_1 = require("./services/availability-validator.service");
const billing_service_1 = require("../billing/billing.service");
const booking_events_1 = require("../common/events/booking-events");
let BookingService = BookingService_1 = class BookingService {
    prisma;
    eventBus;
    slotGenerator;
    conflictDetection;
    availabilityValidator;
    billingService;
    logger = new common_1.Logger(BookingService_1.name);
    constructor(prisma, eventBus, slotGenerator, conflictDetection, availabilityValidator, billingService) {
        this.prisma = prisma;
        this.eventBus = eventBus;
        this.slotGenerator = slotGenerator;
        this.conflictDetection = conflictDetection;
        this.availabilityValidator = availabilityValidator;
        this.billingService = billingService;
    }
    // Meeting Management
    async createMeeting(createMeetingDto, clientId) {
        const { startTime, therapistId, duration } = createMeetingDto;
        const startTimeDate = new Date(startTime || createMeetingDto.dateTime);
        const endTimeDate = new Date(startTimeDate.getTime() + duration * 60000);
        // Use database transaction to prevent race conditions
        return this.prisma.$transaction(async (tx) => {
            // First, acquire locks on both therapist and client schedules
            // This prevents concurrent bookings from interfering
            const [therapistLock, clientLock] = await Promise.all([
                tx.user.findUnique({
                    where: { id: therapistId },
                    select: { id: true },
                }),
                tx.user.findUnique({
                    where: { id: clientId },
                    select: { id: true },
                }),
            ]);
            if (!therapistLock || !clientLock) {
                throw new common_1.BadRequestException('Therapist or client not found');
            }
            // Check for conflicts within transaction (atomic operation)
            const conflictingMeetings = await tx.meeting.findMany({
                where: {
                    OR: [
                        {
                            therapistId,
                            startTime: { lt: endTimeDate },
                            endTime: { gt: startTimeDate },
                            status: { in: ['SCHEDULED', 'CONFIRMED', 'IN_PROGRESS'] },
                        },
                        {
                            clientId,
                            startTime: { lt: endTimeDate },
                            endTime: { gt: startTimeDate },
                            status: { in: ['SCHEDULED', 'CONFIRMED', 'IN_PROGRESS'] },
                        },
                    ],
                },
            });
            if (conflictingMeetings.length > 0) {
                throw new common_1.BadRequestException(`Schedule conflict detected: ${conflictingMeetings.length} conflicting meetings found`);
            }
            // Validate therapist availability within transaction
            // Get therapist's timezone preference
            const therapist = await tx.therapist.findUnique({
                where: { userId: therapistId },
                select: { timezone: true },
            });
            const therapistTimezone = therapist?.timezone || 'UTC';
            // Convert to therapist's timezone for availability check
            const therapistLocalTime = new Date(startTimeDate.toLocaleString('en-US', {
                timeZone: therapistTimezone,
            }));
            const therapistLocalEndTime = new Date(endTimeDate.toLocaleString('en-US', { timeZone: therapistTimezone }));
            const dayOfWeek = therapistLocalTime
                .toLocaleDateString('en-US', { weekday: 'long' })
                .toUpperCase();
            const timeOnly = therapistLocalTime.toTimeString().slice(0, 5); // HH:MM format
            const endTimeOnly = therapistLocalEndTime.toTimeString().slice(0, 5);
            const availability = await tx.therapistAvailability.findFirst({
                where: {
                    therapistId,
                    dayOfWeek,
                    startTime: { lte: timeOnly },
                    endTime: { gte: endTimeOnly },
                    isAvailable: true,
                },
            });
            if (!availability) {
                throw new common_1.BadRequestException(`Therapist is not available at the requested time (${timeOnly}-${endTimeOnly} ${dayOfWeek} in ${therapistTimezone})`);
            }
            // Create the meeting within the transaction
            const meeting = await tx.meeting.create({
                data: {
                    ...createMeetingDto,
                    startTime: startTimeDate,
                    endTime: endTimeDate,
                    status: 'SCHEDULED',
                    clientId,
                },
                include: {
                    client: {
                        select: {
                            user: {
                                select: {
                                    firstName: true,
                                    lastName: true,
                                    email: true,
                                },
                            },
                        },
                    },
                    therapist: {
                        select: {
                            user: {
                                select: {
                                    firstName: true,
                                    lastName: true,
                                    email: true,
                                },
                            },
                        },
                    },
                },
            });
            // NOTE: Payment processing now handled separately when client pays for session
            // The meeting is created first, then payment is processed via billing controller
            // This allows for better payment flow and error handling
            // Publish appointment booked event
            await this.eventBus.emit(new booking_events_1.AppointmentBookedEvent({
                appointmentId: meeting.id,
                clientId: meeting.clientId,
                therapistId: meeting.therapistId,
                startTime: meeting.startTime,
                meetingType: meeting.meetingType,
                duration: meeting.duration,
                title: meeting.title || 'Therapy Session',
                description: meeting.description || undefined,
                isInitialConsultation: false,
            }));
            // Transform the response to match frontend expectations
            return {
                ...meeting,
                dateTime: meeting.startTime, // Map startTime to dateTime for frontend compatibility
                therapistName: meeting.therapist?.user
                    ? `${meeting.therapist.user.firstName} ${meeting.therapist.user.lastName}`
                    : 'Unknown Therapist',
            };
        }, {
            isolationLevel: 'Serializable', // Highest isolation level to prevent race conditions
            timeout: 10000, // 10 second timeout
            maxWait: 5000, // Max wait time for transaction lock
        });
    }
    async getMeetings(userId, role, queryOptions) {
        try {
            const where = role === 'therapist' ? { therapistId: userId } : { clientId: userId };
            // Handle status filtering
            if (queryOptions?.status) {
                const statusValues = queryOptions.status
                    .split(',')
                    .map((s) => s.trim().toUpperCase());
                where.status = { in: statusValues };
            }
            const meetings = await this.prisma.meeting.findMany({
                where,
                include: {
                    client: {
                        select: {
                            user: {
                                select: {
                                    firstName: true,
                                    lastName: true,
                                    email: true,
                                },
                            },
                        },
                    },
                    therapist: {
                        select: {
                            user: {
                                select: {
                                    firstName: true,
                                    lastName: true,
                                    email: true,
                                },
                            },
                        },
                    },
                },
                orderBy: { startTime: 'desc' },
                take: queryOptions?.limit,
                skip: queryOptions?.offset,
            });
            // Transform the response to match frontend expectations
            return meetings.map((meeting) => ({
                ...meeting,
                dateTime: meeting.startTime, // Map startTime to dateTime for frontend compatibility
                therapistName: meeting.therapist?.user
                    ? `${meeting.therapist.user.firstName} ${meeting.therapist.user.lastName}`
                    : 'Unknown Therapist',
            }));
        }
        catch (error) {
            throw new common_1.BadRequestException(error instanceof Error ? error.message : String(error));
        }
    }
    async getMeeting(id, userId, role) {
        try {
            const meeting = await this.prisma.meeting.findUnique({
                where: { id },
                include: {
                    client: {
                        select: {
                            user: {
                                select: {
                                    firstName: true,
                                    lastName: true,
                                    email: true,
                                },
                            },
                        },
                    },
                    therapist: {
                        select: {
                            user: {
                                select: {
                                    firstName: true,
                                    lastName: true,
                                    email: true,
                                },
                            },
                        },
                    },
                },
            });
            if (!meeting) {
                throw new common_1.NotFoundException('Meeting not found');
            }
            // Verify user has access to this meeting
            if (role === 'therapist' && meeting.therapistId !== userId) {
                throw new common_1.ForbiddenException('Access denied');
            }
            if (role === 'client' && meeting.clientId !== userId) {
                throw new common_1.ForbiddenException('Access denied');
            }
            // Transform the response to match frontend expectations
            return {
                ...meeting,
                dateTime: meeting.startTime, // Map startTime to dateTime for frontend compatibility
                therapistName: meeting.therapist?.user
                    ? `${meeting.therapist.user.firstName} ${meeting.therapist.user.lastName}`
                    : 'Unknown Therapist',
            };
        }
        catch (error) {
            throw new common_1.BadRequestException(error instanceof Error ? error.message : String(error));
        }
    }
    async updateMeeting(id, updateMeetingDto, userId, role) {
        try {
            const meeting = await this.getMeeting(id, userId, role);
            // Only allow updates if meeting is not completed or cancelled
            if (['COMPLETED', 'CANCELLED'].includes(meeting.status)) {
                throw new common_1.BadRequestException('Cannot update completed or cancelled meetings');
            }
            // If updating time, validate the new schedule
            if (updateMeetingDto.startTime || updateMeetingDto.duration) {
                const newStartTime = updateMeetingDto.startTime
                    ? new Date(updateMeetingDto.startTime)
                    : meeting.startTime;
                const newDuration = updateMeetingDto.duration || meeting.duration;
                // Check for conflicts with the update
                const conflicts = await this.conflictDetection.checkUpdateConflicts(id, meeting.therapistId, meeting.clientId, newStartTime, newDuration);
                if (conflicts.hasConflict) {
                    throw new common_1.BadRequestException(`Schedule update would cause conflicts: ${conflicts.conflictingMeetings.length} conflicting meetings found`);
                }
                // Validate therapist availability for new time
                if (updateMeetingDto.startTime) {
                    await this.availabilityValidator.validateTherapistAvailability(meeting.therapistId, newStartTime, newDuration);
                }
            }
            const updatedMeeting = await this.prisma.meeting.update({
                where: { id },
                data: {
                    title: updateMeetingDto.title,
                    description: updateMeetingDto.description,
                    startTime: updateMeetingDto.startTime,
                    duration: updateMeetingDto.duration,
                    meetingType: updateMeetingDto.meetingType,
                    meetingUrl: updateMeetingDto.meetingUrl,
                    ...(updateMeetingDto.status && {
                        status: updateMeetingDto.status,
                    }),
                },
                include: {
                    client: {
                        select: {
                            user: {
                                select: {
                                    firstName: true,
                                    lastName: true,
                                    email: true,
                                },
                            },
                        },
                    },
                    therapist: {
                        select: {
                            user: {
                                select: {
                                    firstName: true,
                                    lastName: true,
                                    email: true,
                                },
                            },
                        },
                    },
                },
            });
            // Publish appropriate events
            if (updateMeetingDto.status === 'completed') {
                await this.eventBus.emit(new booking_events_1.AppointmentCompletedEvent({
                    appointmentId: updatedMeeting.id,
                    clientId: updatedMeeting.clientId,
                    therapistId: updatedMeeting.therapistId,
                    completedAt: new Date(),
                    duration: updatedMeeting.duration,
                    sessionNotes: updateMeetingDto.description || '',
                    attendanceStatus: 'ATTENDED',
                }));
            }
            else if (updateMeetingDto.startTime &&
                new Date(updateMeetingDto.startTime).getTime() !==
                    meeting.startTime.getTime()) {
                await this.eventBus.emit(new booking_events_1.AppointmentRescheduledEvent({
                    appointmentId: updatedMeeting.id,
                    clientId: updatedMeeting.clientId,
                    therapistId: updatedMeeting.therapistId,
                    rescheduledBy: userId,
                    originalStartTime: meeting.startTime,
                    newStartTime: new Date(updateMeetingDto.startTime),
                    rescheduleReason: `Rescheduled by ${role}`,
                }));
            }
            return updatedMeeting;
        }
        catch (error) {
            throw new common_1.BadRequestException(error instanceof Error ? error.message : String(error));
        }
    }
    async cancelMeeting(id, userId, role) {
        try {
            const meeting = await this.getMeeting(id, userId, role);
            if (meeting.status === 'CANCELLED') {
                throw new common_1.BadRequestException('Meeting is already cancelled');
            }
            if (meeting.status === 'COMPLETED') {
                throw new common_1.BadRequestException('Cannot cancel completed meetings');
            }
            const cancelledMeeting = await this.prisma.meeting.update({
                where: { id },
                data: { status: 'CANCELLED' },
                include: {
                    client: {
                        select: {
                            user: {
                                select: {
                                    firstName: true,
                                    lastName: true,
                                    email: true,
                                },
                            },
                        },
                    },
                    therapist: {
                        select: {
                            user: {
                                select: {
                                    firstName: true,
                                    lastName: true,
                                    email: true,
                                },
                            },
                        },
                    },
                },
            });
            // Calculate cancellation notice
            const cancellationNotice = Math.floor((meeting.startTime.getTime() - Date.now()) / (1000 * 60 * 60));
            // Handle payment refund for cancelled sessions
            try {
                // Find payment record associated with this meeting using the updated API
                const payments = await this.billingService.getUserPayments(userId, {
                    limit: 100,
                });
                const meetingPayment = payments.find((p) => p.meetingId === meeting.id);
                if (meetingPayment && cancellationNotice >= 24) {
                    // 24-hour cancellation policy
                    // NOTE: Refund logic would need to be implemented in billing service
                    // For now, we'll emit an event that a refund is needed
                    this.logger.log(`Refund needed for cancelled session ${meeting.id} - ${cancellationNotice}h notice`);
                    // TODO: Implement refund processing in billing service
                }
            }
            catch (refundError) {
                // Log refund error but don't fail the cancellation
                console.error('Failed to process refund for cancelled meeting:', refundError);
            }
            // Publish cancellation event
            await this.eventBus.emit(new booking_events_1.AppointmentCancelledEvent({
                appointmentId: cancelledMeeting.id,
                clientId: cancelledMeeting.clientId,
                therapistId: cancelledMeeting.therapistId,
                cancelledBy: userId,
                cancellationReason: role === 'client'
                    ? 'Cancelled by client'
                    : 'Cancelled by therapist',
                originalStartTime: meeting.startTime,
                cancelledAt: new Date(),
                cancellationNotice: Math.max(0, cancellationNotice),
            }));
            return cancelledMeeting;
        }
        catch (error) {
            throw new common_1.BadRequestException(error instanceof Error ? error.message : String(error));
        }
    }
    // Availability Management
    async createAvailability(createAvailabilityDto, therapistId) {
        try {
            const { dayOfWeek, startTime, endTime, notes } = createAvailabilityDto;
            // Validate using our new service
            await this.availabilityValidator.validateAvailabilityCreation({
                therapistId,
                dayOfWeek,
                startTime,
                endTime,
            });
            return this.prisma.therapistAvailability.create({
                data: {
                    therapistId,
                    dayOfWeek: dayOfWeek.toString(),
                    startTime,
                    endTime,
                    notes,
                },
            });
        }
        catch (error) {
            throw new common_1.BadRequestException(error instanceof Error ? error.message : String(error));
        }
    }
    async getAvailability(therapistId) {
        try {
            return await this.prisma.therapistAvailability.findMany({
                where: { therapistId },
                orderBy: [{ dayOfWeek: 'asc' }, { startTime: 'asc' }],
            });
        }
        catch (error) {
            throw new common_1.BadRequestException(error instanceof Error ? error.message : String(error));
        }
    }
    async updateAvailability(id, updateAvailabilityDto, therapistId) {
        try {
            const availability = await this.prisma.therapistAvailability.findFirst({
                where: { id, therapistId },
            });
            if (!availability) {
                throw new common_1.NotFoundException('Availability slot not found');
            }
            // Convert dayOfWeek to string if present
            const { dayOfWeek, ...rest } = updateAvailabilityDto;
            const updateData = {
                ...rest,
                ...(dayOfWeek !== undefined && {
                    dayOfWeek: dayOfWeek.toString(),
                }),
            };
            return this.prisma.therapistAvailability.update({
                where: { id },
                data: updateData,
            });
        }
        catch (error) {
            throw new common_1.BadRequestException(error instanceof Error ? error.message : String(error));
        }
    }
    async deleteAvailability(id, therapistId) {
        try {
            const availability = await this.prisma.therapistAvailability.findFirst({
                where: { id, therapistId },
            });
            if (!availability) {
                throw new common_1.NotFoundException('Availability slot not found');
            }
            return this.prisma.therapistAvailability.delete({
                where: { id },
            });
        }
        catch (error) {
            throw new common_1.BadRequestException(error instanceof Error ? error.message : String(error));
        }
    }
    // Simplified slot generation using our new service
    async getAvailableSlots(therapistId, date) {
        try {
            return await this.slotGenerator.generateAvailableSlots(therapistId, date);
        }
        catch (error) {
            throw new common_1.BadRequestException(error instanceof Error ? error.message : String(error));
        }
    }
    // Duration management
    getDurations() {
        return [
            { id: '30', name: '30 minutes', duration: 30 },
            { id: '60', name: '60 minutes', duration: 60 },
            { id: '90', name: '90 minutes', duration: 90 },
            { id: '120', name: '120 minutes', duration: 120 },
        ];
    }
    // Enhanced validation method using our services
    async validateMeetingTime(therapistId, clientId, startTime, duration) {
        const startTimeDate = new Date(startTime);
        await this.availabilityValidator.validateMeetingCreation({
            therapistId,
            clientId,
            startTime: startTimeDate,
            duration,
        });
        await this.conflictDetection.validateNoConflicts(therapistId, clientId, startTimeDate, duration);
        return true;
    }
};
exports.BookingService = BookingService;
exports.BookingService = BookingService = BookingService_1 = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [typeof (_a = typeof prisma_client_provider_1.PrismaService !== "undefined" && prisma_client_provider_1.PrismaService) === "function" ? _a : Object, typeof (_b = typeof event_bus_service_1.EventBusService !== "undefined" && event_bus_service_1.EventBusService) === "function" ? _b : Object, typeof (_c = typeof slot_generator_service_1.SlotGeneratorService !== "undefined" && slot_generator_service_1.SlotGeneratorService) === "function" ? _c : Object, typeof (_d = typeof conflict_detection_service_1.ConflictDetectionService !== "undefined" && conflict_detection_service_1.ConflictDetectionService) === "function" ? _d : Object, typeof (_e = typeof availability_validator_service_1.AvailabilityValidatorService !== "undefined" && availability_validator_service_1.AvailabilityValidatorService) === "function" ? _e : Object, typeof (_f = typeof billing_service_1.BillingService !== "undefined" && billing_service_1.BillingService) === "function" ? _f : Object])
], BookingService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL2Jvb2tpbmcvYm9va2luZy5zZXJ2aWNlLnRzIiwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7O0FBQUEsMkNBTXdCO0FBQ3hCLGdGQUFvRTtBQVFwRSwwRUFBcUU7QUFDckUsOEVBQXlFO0FBQ3pFLHNGQUFpRjtBQUNqRiw4RkFBeUY7QUFDekYsZ0VBQTREO0FBQzVELG9FQUt5QztBQUdsQyxJQUFNLGNBQWMsc0JBQXBCLE1BQU0sY0FBYztJQUlOO0lBQ0E7SUFDQTtJQUNBO0lBQ0E7SUFDQTtJQVJGLE1BQU0sR0FBRyxJQUFJLGVBQU0sQ0FBQyxnQkFBYyxDQUFDLElBQUksQ0FBQyxDQUFDO0lBRTFELFlBQ21CLE1BQXFCLEVBQ3JCLFFBQXlCLEVBQ3pCLGFBQW1DLEVBQ25DLGlCQUEyQyxFQUMzQyxxQkFBbUQsRUFDbkQsY0FBOEI7UUFMOUIsV0FBTSxHQUFOLE1BQU0sQ0FBZTtRQUNyQixhQUFRLEdBQVIsUUFBUSxDQUFpQjtRQUN6QixrQkFBYSxHQUFiLGFBQWEsQ0FBc0I7UUFDbkMsc0JBQWlCLEdBQWpCLGlCQUFpQixDQUEwQjtRQUMzQywwQkFBcUIsR0FBckIscUJBQXFCLENBQThCO1FBQ25ELG1CQUFjLEdBQWQsY0FBYyxDQUFnQjtJQUM5QyxDQUFDO0lBRUoscUJBQXFCO0lBQ3JCLEtBQUssQ0FBQyxhQUFhLENBQUMsZ0JBQWtDLEVBQUUsUUFBZ0I7UUFDdEUsTUFBTSxFQUFFLFNBQVMsRUFBRSxXQUFXLEVBQUUsUUFBUSxFQUFFLEdBQUcsZ0JBQWdCLENBQUM7UUFDOUQsTUFBTSxhQUFhLEdBQUcsSUFBSSxJQUFJLENBQUMsU0FBUyxJQUFJLGdCQUFnQixDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQ3ZFLE1BQU0sV0FBVyxHQUFHLElBQUksSUFBSSxDQUFDLGFBQWEsQ0FBQyxPQUFPLEVBQUUsR0FBRyxRQUFRLEdBQUcsS0FBSyxDQUFDLENBQUM7UUFFekUsc0RBQXNE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QUNoRCxLQUFLLENBQUMsbUJBQW1CLENBQ3ZCLFdBQW1CLEVBQ25CLFFBQWdCLEVBQ2hCLFNBQXdCLEVBQ3hCLFFBQWdCO1FBRWhCLE1BQU0sYUFBYSxHQUFHLElBQUksSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBRTFDLE1BQU0sSUFBSSxDQUFDLHFCQUFxQixDQUFDLHVCQUF1QixDQUFDO1lBQ3ZELFdBQVc7WUFDWCxRQUFRO1lBQ1IsU0FBUyxFQUFFLGFBQWE7WUFDeEIsUUFBUTtTQUNULENBQUMsQ0FBQztRQUVILE1BQU0sSUFBSSxDQUFDLGlCQUFpQixDQUFDLG1CQUFtQixDQUM5QyxXQUFXLEVBQ1gsUUFBUSxFQUNSLGFBQWEsRUFDYixRQUFRLENBQ1QsQ0FBQztRQUVGLE9BQU8sSUFBSSxDQUFDO0lBQ2QsQ0FBQztDQUNGLENBQUE7QUEvcEJZLHdDQUFjO3lCQUFkLGNBQWM7SUFEMUIsSUFBQSxtQkFBVSxHQUFFO3lEQUtnQixzQ0FBYSxvQkFBYixzQ0FBYSxvREFDWCxtQ0FBZSxvQkFBZixtQ0FBZSxvREFDViw2Q0FBb0Isb0JBQXBCLDZDQUFvQixvREFDaEIscURBQXdCLG9CQUF4QixxREFBd0Isb0RBQ3BCLDZEQUE0QixvQkFBNUIsNkRBQTRCLG9EQUNuQyxnQ0FBYyxvQkFBZCxnQ0FBYztHQVR0QyxjQUFjLENBK3BCMUIiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL2Jvb2tpbmcvYm9va2luZy5zZXJ2aWNlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIEluamVjdGFibGUsXG4gIEJhZFJlcXVlc3RFeGNlcHRpb24sXG4gIE5vdEZvdW5kRXhjZXB0aW9uLFxuICBGb3JiaWRkZW5FeGNlcHRpb24sXG4gIExvZ2dlcixcbn0gZnJvbSAnQG5lc3Rqcy9jb21tb24nO1xuaW1wb3J0IHsgUHJpc21hU2VydmljZSB9IGZyb20gJy4uL3Byb3ZpZGVycy9wcmlzbWEtY2xpZW50LnByb3ZpZGVyJztcbmltcG9ydCB7IE1lZXRpbmdTdGF0dXMgfSBmcm9tICdAcHJpc21hL2NsaWVudCc7XG5pbXBvcnQgdHlwZSB7XG4gIE1lZXRpbmdDcmVhdGVEdG8sXG4gIE1lZXRpbmdVcGRhdGVEdG8sXG4gIFRoZXJhcGlzdEF2YWlsYWJpbGl0eUNyZWF0ZUR0byxcbiAgVGhlcmFwaXN0QXZhaWxhYmlsaXR5VXBkYXRlRHRvLFxufSBmcm9tICcuL3R5cGVzJztcbmltcG9ydCB7IEV2ZW50QnVzU2VydmljZSB9IGZyb20gJy4uL2NvbW1vbi9ldmVudHMvZXZlbnQtYnVzLnNlcnZpY2UnO1xuaW1wb3J0IHsgU2xvdEdlbmVyYXRvclNlcnZpY2UgfSBmcm9tICcuL3NlcnZpY2VzL3Nsb3QtZ2VuZXJhdG9yLnNlcnZpY2UnO1xuaW1wb3J0IHsgQ29uZmxpY3REZXRlY3Rpb25TZXJ2aWNlIH0gZnJvbSAnLi9zZXJ2aWNlcy9jb25mbGljdC1kZXRlY3Rpb24uc2VydmljZSc7XG5pbXBvcnQgeyBBdmFpbGFiaWxpdHlWYWxpZGF0b3JTZXJ2aWNlIH0gZnJvbSAnLi9zZXJ2aWNlcy9hdmFpbGFiaWxpdHktdmFsaWRhdG9yLnNlcnZpY2UnO1xuaW1wb3J0IHsgQmlsbGluZ1NlcnZpY2UgfSBmcm9tICcuLi9iaWxsaW5nL2JpbGxpbmcuc2VydmljZSc7XG5pbXBvcnQge1xuICBBcHBvaW50bWVudEJvb2tlZEV2ZW50LFxuICBBcHBvaW50bWVudENhbmNlbGxlZEV2ZW50LFxuICBBcHBvaW50bWVudENvbXBsZXRlZEV2ZW50LFxuICBBcHBvaW50bWVudFJlc2NoZWR1bGVkRXZlbnQsXG59IGZyb20gJy4uL2NvbW1vbi9ldmVudHMvYm9va2luZy1ldmVudHMnO1xuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgQm9va2luZ1NlcnZpY2Uge1xuICBwcml2YXRlIHJlYWRvbmx5IGxvZ2dlciA9IG5ldyBMb2dnZXIoQm9va2luZ1NlcnZpY2UubmFtZSk7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSByZWFkb25seSBwcmlzbWE6IFByaXNtYVNlcnZpY2UsXG4gICAgcHJpdmF0ZSByZWFkb25seSBldmVudEJ1czogRXZlbnRCdXNTZXJ2aWNlLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgc2xvdEdlbmVyYXRvcjogU2xvdEdlbmVyYXRvclNlcnZpY2UsXG4gICAgcHJpdmF0ZSByZWFkb25seSBjb25mbGljdERldGVjdGlvbjogQ29uZmxpY3REZXRlY3Rpb25TZXJ2aWNlLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgYXZhaWxhYmlsaXR5VmFsaWRhdG9yOiBBdmFpbGFiaWxpdHlWYWxpZGF0b3JTZXJ2aWNlLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgYmlsbGluZ1NlcnZpY2U6IEJpbGxpbmdTZXJ2aWNlLFxuICApIHt9XG5cbiAgLy8gTWVldGluZyBNYW5hZ2VtZW50XG4gIGFzeW5jIGNyZWF0ZU1lZXRpbmcoY3JlYXRlTWVldGluZ0R0bzogTWVldGluZ0NyZWF0ZUR0bywgY2xpZW50SWQ6IHN0cmluZykge1xuICAgIGNvbnN0IHsgc3RhcnRUaW1lLCB0aGVyYXBpc3RJZCwgZHVyYXRpb24gfSA9IGNyZWF0ZU1lZXRpbmdEdG87XG4gICAgY29uc3Qgc3RhcnRUaW1lRGF0ZSA9IG5ldyBEYXRlKHN0YXJ0VGltZSB8fCBjcmVhdGVNZWV0aW5nRHRvLmRhdGVUaW1lKTtcbiAgICBjb25zdCBlbmRUaW1lRGF0ZSA9IG5ldyBEYXRlKHN0YXJ0VGltZURhdGUuZ2V0VGltZSgpICsgZHVyYXRpb24gKiA2MDAwMCk7XG5cbiAgICAvLyBVc2UgZGF0YWJhc2UgdHJhbnNhY3Rpb24gdG8gcHJldmVudCByYWNlIGNvbmRpdGlvbnNcbiAgICByZXR1cm4gdGhpcy5wcmlzbWEuJHRyYW5zYWN0aW9uKFxuICAgICAgYXN5bmMgKHR4KSA9PiB7XG4gICAgICAgIC8vIEZpcnN0LCBhY3F1aXJlIGxvY2tzIG9uIGJvdGggdGhlcmFwaXN0IGFuZCBjbGllbnQgc2NoZWR1bGVzXG4gICAgICAgIC8vIFRoaXMgcHJldmVudHMgY29uY3VycmVudCBib29raW5ncyBmcm9tIGludGVyZmVyaW5nXG4gICAgICAgIGNvbnN0IFt0aGVyYXBpc3RMb2NrLCBjbGllbnRMb2NrXSA9IGF3YWl0IFByb21pc2UuYWxsKFtcbiAgICAgICAgICB0eC51c2VyLmZpbmRVbmlxdWUoe1xuICAgICAgICAgICAgd2hlcmU6IHsgaWQ6IHRoZXJhcGlzdElkIH0sXG4gICAgICAgICAgICBzZWxlY3Q6IHsgaWQ6IHRydWUgfSxcbiAgICAgICAgICB9KSxcbiAgICAgICAgICB0eC51c2VyLmZpbmRVbmlxdWUoe1xuICAgICAgICAgICAgd2hlcmU6IHsgaWQ6IGNsaWVudElkIH0sXG4gICAgICAgICAgICBzZWxlY3Q6IHsgaWQ6IHRydWUgfSxcbiAgICAgICAgICB9KSxcbiAgICAgICAgXSk7XG5cbiAgICAgICAgaWYgKCF0aGVyYXBpc3RMb2NrIHx8ICFjbGllbnRMb2NrKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFeGNlcHRpb24oJ1RoZXJhcGlzdCBvciBjbGllbnQgbm90IGZvdW5kJyk7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBDaGVjayBmb3IgY29uZmxpY3RzIHdpdGhpbiB0cmFuc2FjdGlvbiAoYXRvbWljIG9wZXJhdGlvbilcbiAgICAgICAgY29uc3QgY29uZmxpY3RpbmdNZWV0aW5ncyA9IGF3YWl0IHR4Lm1lZXRpbmcuZmluZE1hbnkoe1xuICAgICAgICAgIHdoZXJlOiB7XG4gICAgICAgICAgICBPUjogW1xuICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgdGhlcmFwaXN0SWQsXG4gICAgICAgICAgICAgICAgc3RhcnRUaW1lOiB7IGx0OiBlbmRUaW1lRGF0ZSB9LFxuICAgICAgICAgICAgICAgIGVuZFRpbWU6IHsgZ3Q6IHN0YXJ0VGltZURhdGUgfSxcbiAgICAgICAgICAgICAgICBzdGF0dXM6IHsgaW46IFsnU0NIRURVTEVEJywgJ0NPTkZJUk1FRCcsICdJTl9QUk9HUkVTUyddIH0sXG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICBjbGllbnRJZCxcbiAgICAgICAgICAgICAgICBzdGFydFRpbWU6IHsgbHQ6IGVuZFRpbWVEYXRlIH0sXG4gICAgICAgICAgICAgICAgZW5kVGltZTogeyBndDogc3RhcnRUaW1lRGF0ZSB9LFxuICAgICAgICAgICAgICAgIHN0YXR1czogeyBpbjogWydTQ0hFRFVMRUQnLCAnQ09ORklSTUVEJywgJ0lOX1BST0dSRVNTJ10gfSxcbiAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIF0sXG4gICAgICAgICAgfSxcbiAgICAgICAgfSk7XG5cbiAgICAgICAgaWYgKGNvbmZsaWN0aW5nTWVldGluZ3MubGVuZ3RoID4gMCkge1xuICAgICAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0RXhjZXB0aW9uKFxuICAgICAgICAgICAgYFNjaGVkdWxlIGNvbmZsaWN0IGRldGVjdGVkOiAke2NvbmZsaWN0aW5nTWVldGluZ3MubGVuZ3RofSBjb25mbGljdGluZyBtZWV0aW5ncyBmb3VuZGAsXG4gICAgICAgICAgKTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIFZhbGlkYXRlIHRoZXJhcGlzdCBhdmFpbGFiaWxpdHkgd2l0aGluIHRyYW5zYWN0aW9uXG4gICAgICAgIC8vIEdldCB0aGVyYXBpc3QncyB0aW1lem9uZSBwcmVmZXJlbmNlXG4gICAgICAgIGNvbnN0IHRoZXJhcGlzdCA9IGF3YWl0IHR4LnRoZXJhcGlzdC5maW5kVW5pcXVlKHtcbiAgICAgICAgICB3aGVyZTogeyB1c2VySWQ6IHRoZXJhcGlzdElkIH0sXG4gICAgICAgICAgc2VsZWN0OiB7IHRpbWV6b25lOiB0cnVlIH0sXG4gICAgICAgIH0pO1xuXG4gICAgICAgIGNvbnN0IHRoZXJhcGlzdFRpbWV6b25lID0gdGhlcmFwaXN0Py50aW1lem9uZSB8fCAnVVRDJztcblxuICAgICAgICAvLyBDb252ZXJ0IHRvIHRoZXJhcGlzdCdzIHRpbWV6b25lIGZvciBhdmFpbGFiaWxpdHkgY2hlY2tcbiAgICAgICAgY29uc3QgdGhlcmFwaXN0TG9jYWxUaW1lID0gbmV3IERhdGUoXG4gICAgICAgICAgc3RhcnRUaW1lRGF0ZS50b0xvY2FsZVN0cmluZygnZW4tVVMnLCB7XG4gICAgICAgICAgICB0aW1lWm9uZTogdGhlcmFwaXN0VGltZXpvbmUsXG4gICAgICAgICAgfSksXG4gICAgICAgICk7XG4gICAgICAgIGNvbnN0IHRoZXJhcGlzdExvY2FsRW5kVGltZSA9IG5ldyBEYXRlKFxuICAgICAgICAgIGVuZFRpbWVEYXRlLnRvTG9jYWxlU3RyaW5nKCdlbi1VUycsIHsgdGltZVpvbmU6IHRoZXJhcGlzdFRpbWV6b25lIH0pLFxuICAgICAgICApO1xuXG4gICAgICAgIGNvbnN0IGRheU9mV2VlayA9IHRoZXJhcGlzdExvY2FsVGltZVxuICAgICAgICAgIC50b0xvY2FsZURhdGVTdHJpbmcoJ2VuLVVTJywgeyB3ZWVrZGF5OiAnbG9uZycgfSlcbiAgICAgICAgICAudG9VcHBlckNhc2UoKTtcbiAgICAgICAgY29uc3QgdGltZU9ubHkgPSB0aGVyYXBpc3RMb2NhbFRpbWUudG9UaW1lU3RyaW5nKCkuc2xpY2UoMCwgNSk7IC8vIEhIOk1NIGZvcm1hdFxuICAgICAgICBjb25zdCBlbmRUaW1lT25seSA9IHRoZXJhcGlzdExvY2FsRW5kVGltZS50b1RpbWVTdHJpbmcoKS5zbGljZSgwLCA1KTtcblxuICAgICAgICBjb25zdCBhdmFpbGFiaWxpdHkgPSBhd2FpdCB0eC50aGVyYXBpc3RBdmFpbGFiaWxpdHkuZmluZEZpcnN0KHtcbiAgICAgICAgICB3aGVyZToge1xuICAgICAgICAgICAgdGhlcmFwaXN0SWQsXG4gICAgICAgICAgICBkYXlPZldlZWssXG4gICAgICAgICAgICBzdGFydFRpbWU6IHsgbHRlOiB0aW1lT25seSB9LFxuICAgICAgICAgICAgZW5kVGltZTogeyBndGU6IGVuZFRpbWVPbmx5IH0sXG4gICAgICAgICAgICBpc0F2YWlsYWJsZTogdHJ1ZSxcbiAgICAgICAgICB9LFxuICAgICAgICB9KTtcblxuICAgICAgICBpZiAoIWF2YWlsYWJpbGl0eSkge1xuICAgICAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0RXhjZXB0aW9uKFxuICAgICAgICAgICAgYFRoZXJhcGlzdCBpcyBub3QgYXZhaWxhYmxlIGF0IHRoZSByZXF1ZXN0ZWQgdGltZSAoJHt0aW1lT25seX0tJHtlbmRUaW1lT25seX0gJHtkYXlPZldlZWt9IGluICR7dGhlcmFwaXN0VGltZXpvbmV9KWAsXG4gICAgICAgICAgKTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIENyZWF0ZSB0aGUgbWVldGluZyB3aXRoaW4gdGhlIHRyYW5zYWN0aW9uXG4gICAgICAgIGNvbnN0IG1lZXRpbmcgPSBhd2FpdCB0eC5tZWV0aW5nLmNyZWF0ZSh7XG4gICAgICAgICAgZGF0YToge1xuICAgICAgICAgICAgLi4uY3JlYXRlTWVldGluZ0R0byxcbiAgICAgICAgICAgIHN0YXJ0VGltZTogc3RhcnRUaW1lRGF0ZSxcbiAgICAgICAgICAgIGVuZFRpbWU6IGVuZFRpbWVEYXRlLFxuICAgICAgICAgICAgc3RhdHVzOiAnU0NIRURVTEVEJyxcbiAgICAgICAgICAgIGNsaWVudElkLFxuICAgICAgICAgIH0sXG4gICAgICAgICAgaW5jbHVkZToge1xuICAgICAgICAgICAgY2xpZW50OiB7XG4gICAgICAgICAgICAgIHNlbGVjdDoge1xuICAgICAgICAgICAgICAgIHVzZXI6IHtcbiAgICAgICAgICAgICAgICAgIHNlbGVjdDoge1xuICAgICAgICAgICAgICAgICAgICBmaXJzdE5hbWU6IHRydWUsXG4gICAgICAgICAgICAgICAgICAgIGxhc3ROYW1lOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgICBlbWFpbDogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB0aGVyYXBpc3Q6IHtcbiAgICAgICAgICAgICAgc2VsZWN0OiB7XG4gICAgICAgICAgICAgICAgdXNlcjoge1xuICAgICAgICAgICAgICAgICAgc2VsZWN0OiB7XG4gICAgICAgICAgICAgICAgICAgIGZpcnN0TmFtZTogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgICAgbGFzdE5hbWU6IHRydWUsXG4gICAgICAgICAgICAgICAgICAgIGVtYWlsOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9LFxuICAgICAgICB9KTtcblxuICAgICAgICAvLyBOT1RFOiBQYXltZW50IHByb2Nlc3Npbmcgbm93IGhhbmRsZWQgc2VwYXJhdGVseSB3aGVuIGNsaWVudCBwYXlzIGZvciBzZXNzaW9uXG4gICAgICAgIC8vIFRoZSBtZWV0aW5nIGlzIGNyZWF0ZWQgZmlyc3QsIHRoZW4gcGF5bWVudCBpcyBwcm9jZXNzZWQgdmlhIGJpbGxpbmcgY29udHJvbGxlclxuICAgICAgICAvLyBUaGlzIGFsbG93cyBmb3IgYmV0dGVyIHBheW1lbnQgZmxvdyBhbmQgZXJyb3IgaGFuZGxpbmdcblxuICAgICAgICAvLyBQdWJsaXNoIGFwcG9pbnRtZW50IGJvb2tlZCBldmVudFxuICAgICAgICBhd2FpdCB0aGlzLmV2ZW50QnVzLmVtaXQoXG4gICAgICAgICAgbmV3IEFwcG9pbnRtZW50Qm9va2VkRXZlbnQoe1xuICAgICAgICAgICAgYXBwb2ludG1lbnRJZDogbWVldGluZy5pZCxcbiAgICAgICAgICAgIGNsaWVudElkOiBtZWV0aW5nLmNsaWVudElkLFxuICAgICAgICAgICAgdGhlcmFwaXN0SWQ6IG1lZXRpbmcudGhlcmFwaXN0SWQsXG4gICAgICAgICAgICBzdGFydFRpbWU6IG1lZXRpbmcuc3RhcnRUaW1lLFxuICAgICAgICAgICAgbWVldGluZ1R5cGU6IG1lZXRpbmcubWVldGluZ1R5cGUgYXNcbiAgICAgICAgICAgICAgfCAndmlkZW8nXG4gICAgICAgICAgICAgIHwgJ2F1ZGlvJ1xuICAgICAgICAgICAgICB8ICdpbl9wZXJzb24nXG4gICAgICAgICAgICAgIHwgJ2NoYXQnLFxuICAgICAgICAgICAgZHVyYXRpb246IG1lZXRpbmcuZHVyYXRpb24sXG4gICAgICAgICAgICB0aXRsZTogbWVldGluZy50aXRsZSB8fCAnVGhlcmFweSBTZXNzaW9uJyxcbiAgICAgICAgICAgIGRlc2NyaXB0aW9uOiBtZWV0aW5nLmRlc2NyaXB0aW9uIHx8IHVuZGVmaW5lZCxcbiAgICAgICAgICAgIGlzSW5pdGlhbENvbnN1bHRhdGlvbjogZmFsc2UsXG4gICAgICAgICAgfSksXG4gICAgICAgICk7XG5cbiAgICAgICAgLy8gVHJhbnNmb3JtIHRoZSByZXNwb25zZSB0byBtYXRjaCBmcm9udGVuZCBleHBlY3RhdGlvbnNcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAuLi5tZWV0aW5nLFxuICAgICAgICAgIGRhdGVUaW1lOiBtZWV0aW5nLnN0YXJ0VGltZSwgLy8gTWFwIHN0YXJ0VGltZSB0byBkYXRlVGltZSBmb3IgZnJvbnRlbmQgY29tcGF0aWJpbGl0eVxuICAgICAgICAgIHRoZXJhcGlzdE5hbWU6IG1lZXRpbmcudGhlcmFwaXN0Py51c2VyXG4gICAgICAgICAgICA/IGAke21lZXRpbmcudGhlcmFwaXN0LnVzZXIuZmlyc3ROYW1lfSAke21lZXRpbmcudGhlcmFwaXN0LnVzZXIubGFzdE5hbWV9YFxuICAgICAgICAgICAgOiAnVW5rbm93biBUaGVyYXBpc3QnLFxuICAgICAgICB9O1xuICAgICAgfSxcbiAgICAgIHtcbiAgICAgICAgaXNvbGF0aW9uTGV2ZWw6ICdTZXJpYWxpemFibGUnLCAvLyBIaWdoZXN0IGlzb2xhdGlvbiBsZXZlbCB0byBwcmV2ZW50IHJhY2UgY29uZGl0aW9uc1xuICAgICAgICB0aW1lb3V0OiAxMDAwMCwgLy8gMTAgc2Vjb25kIHRpbWVvdXRcbiAgICAgICAgbWF4V2FpdDogNTAwMCwgLy8gTWF4IHdhaXQgdGltZSBmb3IgdHJhbnNhY3Rpb24gbG9ja1xuICAgICAgfSxcbiAgICApO1xuICB9XG5cbiAgYXN5bmMgZ2V0TWVldGluZ3MoXG4gICAgdXNlcklkOiBzdHJpbmcsXG4gICAgcm9sZTogc3RyaW5nLFxuICAgIHF1ZXJ5T3B0aW9ucz86IHtcbiAgICAgIHN0YXR1cz86IHN0cmluZztcbiAgICAgIGxpbWl0PzogbnVtYmVyO1xuICAgICAgb2Zmc2V0PzogbnVtYmVyO1xuICAgIH0sXG4gICkge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCB3aGVyZTogYW55ID1cbiAgICAgICAgcm9sZSA9PT0gJ3RoZXJhcGlzdCcgPyB7IHRoZXJhcGlzdElkOiB1c2VySWQgfSA6IHsgY2xpZW50SWQ6IHVzZXJJZCB9O1xuXG4gICAgICAvLyBIYW5kbGUgc3RhdHVzIGZpbHRlcmluZ1xuICAgICAgaWYgKHF1ZXJ5T3B0aW9ucz8uc3RhdHVzKSB7XG4gICAgICAgIGNvbnN0IHN0YXR1c1ZhbHVlcyA9IHF1ZXJ5T3B0aW9ucy5zdGF0dXNcbiAgICAgICAgICAuc3BsaXQoJywnKVxuICAgICAgICAgIC5tYXAoKHMpID0+IHMudHJpbSgpLnRvVXBwZXJDYXNlKCkpO1xuICAgICAgICB3aGVyZS5zdGF0dXMgPSB7IGluOiBzdGF0dXNWYWx1ZXMgfTtcbiAgICAgIH1cblxuICAgICAgY29uc3QgbWVldGluZ3MgPSBhd2FpdCB0aGlzLnByaXNtYS5tZWV0aW5nLmZpbmRNYW55KHtcbiAgICAgICAgd2hlcmUsXG4gICAgICAgIGluY2x1ZGU6IHtcbiAgICAgICAgICBjbGllbnQ6IHtcbiAgICAgICAgICAgIHNlbGVjdDoge1xuICAgICAgICAgICAgICB1c2VyOiB7XG4gICAgICAgICAgICAgICAgc2VsZWN0OiB7XG4gICAgICAgICAgICAgICAgICBmaXJzdE5hbWU6IHRydWUsXG4gICAgICAgICAgICAgICAgICBsYXN0TmFtZTogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgIGVtYWlsOiB0cnVlLFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0sXG4gICAgICAgICAgdGhlcmFwaXN0OiB7XG4gICAgICAgICAgICBzZWxlY3Q6IHtcbiAgICAgICAgICAgICAgdXNlcjoge1xuICAgICAgICAgICAgICAgIHNlbGVjdDoge1xuICAgICAgICAgICAgICAgICAgZmlyc3ROYW1lOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgbGFzdE5hbWU6IHRydWUsXG4gICAgICAgICAgICAgICAgICBlbWFpbDogdHJ1ZSxcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgICBvcmRlckJ5OiB7IHN0YXJ0VGltZTogJ2Rlc2MnIH0sXG4gICAgICAgIHRha2U6IHF1ZXJ5T3B0aW9ucz8ubGltaXQsXG4gICAgICAgIHNraXA6IHF1ZXJ5T3B0aW9ucz8ub2Zmc2V0LFxuICAgICAgfSk7XG5cbiAgICAgIC8vIFRyYW5zZm9ybSB0aGUgcmVzcG9uc2UgdG8gbWF0Y2ggZnJvbnRlbmQgZXhwZWN0YXRpb25zXG4gICAgICByZXR1cm4gbWVldGluZ3MubWFwKChtZWV0aW5nKSA9PiAoe1xuICAgICAgICAuLi5tZWV0aW5nLFxuICAgICAgICBkYXRlVGltZTogbWVldGluZy5zdGFydFRpbWUsIC8vIE1hcCBzdGFydFRpbWUgdG8gZGF0ZVRpbWUgZm9yIGZyb250ZW5kIGNvbXBhdGliaWxpdHlcbiAgICAgICAgdGhlcmFwaXN0TmFtZTogbWVldGluZy50aGVyYXBpc3Q/LnVzZXJcbiAgICAgICAgICA/IGAke21lZXRpbmcudGhlcmFwaXN0LnVzZXIuZmlyc3ROYW1lfSAke21lZXRpbmcudGhlcmFwaXN0LnVzZXIubGFzdE5hbWV9YFxuICAgICAgICAgIDogJ1Vua25vd24gVGhlcmFwaXN0JyxcbiAgICAgIH0pKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFeGNlcHRpb24oXG4gICAgICAgIGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogU3RyaW5nKGVycm9yKSxcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgZ2V0TWVldGluZyhpZDogc3RyaW5nLCB1c2VySWQ6IHN0cmluZywgcm9sZTogc3RyaW5nKSB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IG1lZXRpbmcgPSBhd2FpdCB0aGlzLnByaXNtYS5tZWV0aW5nLmZpbmRVbmlxdWUoe1xuICAgICAgICB3aGVyZTogeyBpZCB9LFxuICAgICAgICBpbmNsdWRlOiB7XG4gICAgICAgICAgY2xpZW50OiB7XG4gICAgICAgICAgICBzZWxlY3Q6IHtcbiAgICAgICAgICAgICAgdXNlcjoge1xuICAgICAgICAgICAgICAgIHNlbGVjdDoge1xuICAgICAgICAgICAgICAgICAgZmlyc3ROYW1lOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgbGFzdE5hbWU6IHRydWUsXG4gICAgICAgICAgICAgICAgICBlbWFpbDogdHJ1ZSxcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9LFxuICAgICAgICAgIHRoZXJhcGlzdDoge1xuICAgICAgICAgICAgc2VsZWN0OiB7XG4gICAgICAgICAgICAgIHVzZXI6IHtcbiAgICAgICAgICAgICAgICBzZWxlY3Q6IHtcbiAgICAgICAgICAgICAgICAgIGZpcnN0TmFtZTogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgIGxhc3ROYW1lOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgZW1haWw6IHRydWUsXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgIH0pO1xuXG4gICAgICBpZiAoIW1lZXRpbmcpIHtcbiAgICAgICAgdGhyb3cgbmV3IE5vdEZvdW5kRXhjZXB0aW9uKCdNZWV0aW5nIG5vdCBmb3VuZCcpO1xuICAgICAgfVxuXG4gICAgICAvLyBWZXJpZnkgdXNlciBoYXMgYWNjZXNzIHRvIHRoaXMgbWVldGluZ1xuICAgICAgaWYgKHJvbGUgPT09ICd0aGVyYXBpc3QnICYmIG1lZXRpbmcudGhlcmFwaXN0SWQgIT09IHVzZXJJZCkge1xuICAgICAgICB0aHJvdyBuZXcgRm9yYmlkZGVuRXhjZXB0aW9uKCdBY2Nlc3MgZGVuaWVkJyk7XG4gICAgICB9XG4gICAgICBpZiAocm9sZSA9PT0gJ2NsaWVudCcgJiYgbWVldGluZy5jbGllbnRJZCAhPT0gdXNlcklkKSB7XG4gICAgICAgIHRocm93IG5ldyBGb3JiaWRkZW5FeGNlcHRpb24oJ0FjY2VzcyBkZW5pZWQnKTtcbiAgICAgIH1cblxuICAgICAgLy8gVHJhbnNmb3JtIHRoZSByZXNwb25zZSB0byBtYXRjaCBmcm9udGVuZCBleHBlY3RhdGlvbnNcbiAgICAgIHJldHVybiB7XG4gICAgICAgIC4uLm1lZXRpbmcsXG4gICAgICAgIGRhdGVUaW1lOiBtZWV0aW5nLnN0YXJ0VGltZSwgLy8gTWFwIHN0YXJ0VGltZSB0byBkYXRlVGltZSBmb3IgZnJvbnRlbmQgY29tcGF0aWJpbGl0eVxuICAgICAgICB0aGVyYXBpc3ROYW1lOiBtZWV0aW5nLnRoZXJhcGlzdD8udXNlclxuICAgICAgICAgID8gYCR7bWVldGluZy50aGVyYXBpc3QudXNlci5maXJzdE5hbWV9ICR7bWVldGluZy50aGVyYXBpc3QudXNlci5sYXN0TmFtZX1gXG4gICAgICAgICAgOiAnVW5rbm93biBUaGVyYXBpc3QnLFxuICAgICAgfTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFeGNlcHRpb24oXG4gICAgICAgIGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogU3RyaW5nKGVycm9yKSxcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgdXBkYXRlTWVldGluZyhcbiAgICBpZDogc3RyaW5nLFxuICAgIHVwZGF0ZU1lZXRpbmdEdG86IE1lZXRpbmdVcGRhdGVEdG8sXG4gICAgdXNlcklkOiBzdHJpbmcsXG4gICAgcm9sZTogc3RyaW5nLFxuICApIHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgbWVldGluZyA9IGF3YWl0IHRoaXMuZ2V0TWVldGluZyhpZCwgdXNlcklkLCByb2xlKTtcblxuICAgICAgLy8gT25seSBhbGxvdyB1cGRhdGVzIGlmIG1lZXRpbmcgaXMgbm90IGNvbXBsZXRlZCBvciBjYW5jZWxsZWRcbiAgICAgIGlmIChbJ0NPTVBMRVRFRCcsICdDQU5DRUxMRUQnXS5pbmNsdWRlcyhtZWV0aW5nLnN0YXR1cykpIHtcbiAgICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFeGNlcHRpb24oXG4gICAgICAgICAgJ0Nhbm5vdCB1cGRhdGUgY29tcGxldGVkIG9yIGNhbmNlbGxlZCBtZWV0aW5ncycsXG4gICAgICAgICk7XG4gICAgICB9XG5cbiAgICAgIC8vIElmIHVwZGF0aW5nIHRpbWUsIHZhbGlkYXRlIHRoZSBuZXcgc2NoZWR1bGVcbiAgICAgIGlmICh1cGRhdGVNZWV0aW5nRHRvLnN0YXJ0VGltZSB8fCB1cGRhdGVNZWV0aW5nRHRvLmR1cmF0aW9uKSB7XG4gICAgICAgIGNvbnN0IG5ld1N0YXJ0VGltZSA9IHVwZGF0ZU1lZXRpbmdEdG8uc3RhcnRUaW1lXG4gICAgICAgICAgPyBuZXcgRGF0ZSh1cGRhdGVNZWV0aW5nRHRvLnN0YXJ0VGltZSlcbiAgICAgICAgICA6IG1lZXRpbmcuc3RhcnRUaW1lO1xuICAgICAgICBjb25zdCBuZXdEdXJhdGlvbiA9IHVwZGF0ZU1lZXRpbmdEdG8uZHVyYXRpb24gfHwgbWVldGluZy5kdXJhdGlvbjtcblxuICAgICAgICAvLyBDaGVjayBmb3IgY29uZmxpY3RzIHdpdGggdGhlIHVwZGF0ZVxuICAgICAgICBjb25zdCBjb25mbGljdHMgPSBhd2FpdCB0aGlzLmNvbmZsaWN0RGV0ZWN0aW9uLmNoZWNrVXBkYXRlQ29uZmxpY3RzKFxuICAgICAgICAgIGlkLFxuICAgICAgICAgIG1lZXRpbmcudGhlcmFwaXN0SWQsXG4gICAgICAgICAgbWVldGluZy5jbGllbnRJZCxcbiAgICAgICAgICBuZXdTdGFydFRpbWUsXG4gICAgICAgICAgbmV3RHVyYXRpb24sXG4gICAgICAgICk7XG5cbiAgICAgICAgaWYgKGNvbmZsaWN0cy5oYXNDb25mbGljdCkge1xuICAgICAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0RXhjZXB0aW9uKFxuICAgICAgICAgICAgYFNjaGVkdWxlIHVwZGF0ZSB3b3VsZCBjYXVzZSBjb25mbGljdHM6ICR7Y29uZmxpY3RzLmNvbmZsaWN0aW5nTWVldGluZ3MubGVuZ3RofSBjb25mbGljdGluZyBtZWV0aW5ncyBmb3VuZGAsXG4gICAgICAgICAgKTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIFZhbGlkYXRlIHRoZXJhcGlzdCBhdmFpbGFiaWxpdHkgZm9yIG5ldyB0aW1lXG4gICAgICAgIGlmICh1cGRhdGVNZWV0aW5nRHRvLnN0YXJ0VGltZSkge1xuICAgICAgICAgIGF3YWl0IHRoaXMuYXZhaWxhYmlsaXR5VmFsaWRhdG9yLnZhbGlkYXRlVGhlcmFwaXN0QXZhaWxhYmlsaXR5KFxuICAgICAgICAgICAgbWVldGluZy50aGVyYXBpc3RJZCxcbiAgICAgICAgICAgIG5ld1N0YXJ0VGltZSxcbiAgICAgICAgICAgIG5ld0R1cmF0aW9uLFxuICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgY29uc3QgdXBkYXRlZE1lZXRpbmcgPSBhd2FpdCB0aGlzLnByaXNtYS5tZWV0aW5nLnVwZGF0ZSh7XG4gICAgICAgIHdoZXJlOiB7IGlkIH0sXG4gICAgICAgIGRhdGE6IHtcbiAgICAgICAgICB0aXRsZTogdXBkYXRlTWVldGluZ0R0by50aXRsZSxcbiAgICAgICAgICBkZXNjcmlwdGlvbjogdXBkYXRlTWVldGluZ0R0by5kZXNjcmlwdGlvbixcbiAgICAgICAgICBzdGFydFRpbWU6IHVwZGF0ZU1lZXRpbmdEdG8uc3RhcnRUaW1lLFxuICAgICAgICAgIGR1cmF0aW9uOiB1cGRhdGVNZWV0aW5nRHRvLmR1cmF0aW9uLFxuICAgICAgICAgIG1lZXRpbmdUeXBlOiB1cGRhdGVNZWV0aW5nRHRvLm1lZXRpbmdUeXBlLFxuICAgICAgICAgIG1lZXRpbmdVcmw6IHVwZGF0ZU1lZXRpbmdEdG8ubWVldGluZ1VybCxcbiAgICAgICAgICAuLi4odXBkYXRlTWVldGluZ0R0by5zdGF0dXMgJiYge1xuICAgICAgICAgICAgc3RhdHVzOiB1cGRhdGVNZWV0aW5nRHRvLnN0YXR1cyBhcyBNZWV0aW5nU3RhdHVzLFxuICAgICAgICAgIH0pLFxuICAgICAgICB9LFxuICAgICAgICBpbmNsdWRlOiB7XG4gICAgICAgICAgY2xpZW50OiB7XG4gICAgICAgICAgICBzZWxlY3Q6IHtcbiAgICAgICAgICAgICAgdXNlcjoge1xuICAgICAgICAgICAgICAgIHNlbGVjdDoge1xuICAgICAgICAgICAgICAgICAgZmlyc3ROYW1lOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgbGFzdE5hbWU6IHRydWUsXG4gICAgICAgICAgICAgICAgICBlbWFpbDogdHJ1ZSxcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9LFxuICAgICAgICAgIHRoZXJhcGlzdDoge1xuICAgICAgICAgICAgc2VsZWN0OiB7XG4gICAgICAgICAgICAgIHVzZXI6IHtcbiAgICAgICAgICAgICAgICBzZWxlY3Q6IHtcbiAgICAgICAgICAgICAgICAgIGZpcnN0TmFtZTogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgIGxhc3ROYW1lOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgZW1haWw6IHRydWUsXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgIH0pO1xuXG4gICAgICAvLyBQdWJsaXNoIGFwcHJvcHJpYXRlIGV2ZW50c1xuICAgICAgaWYgKHVwZGF0ZU1lZXRpbmdEdG8uc3RhdHVzID09PSAnY29tcGxldGVkJykge1xuICAgICAgICBhd2FpdCB0aGlzLmV2ZW50QnVzLmVtaXQoXG4gICAgICAgICAgbmV3IEFwcG9pbnRtZW50Q29tcGxldGVkRXZlbnQoe1xuICAgICAgICAgICAgYXBwb2ludG1lbnRJZDogdXBkYXRlZE1lZXRpbmcuaWQsXG4gICAgICAgICAgICBjbGllbnRJZDogdXBkYXRlZE1lZXRpbmcuY2xpZW50SWQsXG4gICAgICAgICAgICB0aGVyYXBpc3RJZDogdXBkYXRlZE1lZXRpbmcudGhlcmFwaXN0SWQsXG4gICAgICAgICAgICBjb21wbGV0ZWRBdDogbmV3IERhdGUoKSxcbiAgICAgICAgICAgIGR1cmF0aW9uOiB1cGRhdGVkTWVldGluZy5kdXJhdGlvbixcbiAgICAgICAgICAgIHNlc3Npb25Ob3RlczogdXBkYXRlTWVldGluZ0R0by5kZXNjcmlwdGlvbiB8fCAnJyxcbiAgICAgICAgICAgIGF0dGVuZGFuY2VTdGF0dXM6ICdBVFRFTkRFRCcsXG4gICAgICAgICAgfSksXG4gICAgICAgICk7XG4gICAgICB9IGVsc2UgaWYgKFxuICAgICAgICB1cGRhdGVNZWV0aW5nRHRvLnN0YXJ0VGltZSAmJlxuICAgICAgICBuZXcgRGF0ZSh1cGRhdGVNZWV0aW5nRHRvLnN0YXJ0VGltZSkuZ2V0VGltZSgpICE9PVxuICAgICAgICAgIG1lZXRpbmcuc3RhcnRUaW1lLmdldFRpbWUoKVxuICAgICAgKSB7XG4gICAgICAgIGF3YWl0IHRoaXMuZXZlbnRCdXMuZW1pdChcbiAgICAgICAgICBuZXcgQXBwb2ludG1lbnRSZXNjaGVkdWxlZEV2ZW50KHtcbiAgICAgICAgICAgIGFwcG9pbnRtZW50SWQ6IHVwZGF0ZWRNZWV0aW5nLmlkLFxuICAgICAgICAgICAgY2xpZW50SWQ6IHVwZGF0ZWRNZWV0aW5nLmNsaWVudElkLFxuICAgICAgICAgICAgdGhlcmFwaXN0SWQ6IHVwZGF0ZWRNZWV0aW5nLnRoZXJhcGlzdElkLFxuICAgICAgICAgICAgcmVzY2hlZHVsZWRCeTogdXNlcklkLFxuICAgICAgICAgICAgb3JpZ2luYWxTdGFydFRpbWU6IG1lZXRpbmcuc3RhcnRUaW1lLFxuICAgICAgICAgICAgbmV3U3RhcnRUaW1lOiBuZXcgRGF0ZSh1cGRhdGVNZWV0aW5nRHRvLnN0YXJ0VGltZSksXG4gICAgICAgICAgICByZXNjaGVkdWxlUmVhc29uOiBgUmVzY2hlZHVsZWQgYnkgJHtyb2xlfWAsXG4gICAgICAgICAgfSksXG4gICAgICAgICk7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiB1cGRhdGVkTWVldGluZztcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFeGNlcHRpb24oXG4gICAgICAgIGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogU3RyaW5nKGVycm9yKSxcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgY2FuY2VsTWVldGluZyhpZDogc3RyaW5nLCB1c2VySWQ6IHN0cmluZywgcm9sZTogc3RyaW5nKSB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IG1lZXRpbmcgPSBhd2FpdCB0aGlzLmdldE1lZXRpbmcoaWQsIHVzZXJJZCwgcm9sZSk7XG5cbiAgICAgIGlmIChtZWV0aW5nLnN0YXR1cyA9PT0gJ0NBTkNFTExFRCcpIHtcbiAgICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFeGNlcHRpb24oJ01lZXRpbmcgaXMgYWxyZWFkeSBjYW5jZWxsZWQnKTtcbiAgICAgIH1cblxuICAgICAgaWYgKG1lZXRpbmcuc3RhdHVzID09PSAnQ09NUExFVEVEJykge1xuICAgICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdEV4Y2VwdGlvbignQ2Fubm90IGNhbmNlbCBjb21wbGV0ZWQgbWVldGluZ3MnKTtcbiAgICAgIH1cblxuICAgICAgY29uc3QgY2FuY2VsbGVkTWVldGluZyA9IGF3YWl0IHRoaXMucHJpc21hLm1lZXRpbmcudXBkYXRlKHtcbiAgICAgICAgd2hlcmU6IHsgaWQgfSxcbiAgICAgICAgZGF0YTogeyBzdGF0dXM6ICdDQU5DRUxMRUQnIH0sXG4gICAgICAgIGluY2x1ZGU6IHtcbiAgICAgICAgICBjbGllbnQ6IHtcbiAgICAgICAgICAgIHNlbGVjdDoge1xuICAgICAgICAgICAgICB1c2VyOiB7XG4gICAgICAgICAgICAgICAgc2VsZWN0OiB7XG4gICAgICAgICAgICAgICAgICBmaXJzdE5hbWU6IHRydWUsXG4gICAgICAgICAgICAgICAgICBsYXN0TmFtZTogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgIGVtYWlsOiB0cnVlLFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0sXG4gICAgICAgICAgdGhlcmFwaXN0OiB7XG4gICAgICAgICAgICBzZWxlY3Q6IHtcbiAgICAgICAgICAgICAgdXNlcjoge1xuICAgICAgICAgICAgICAgIHNlbGVjdDoge1xuICAgICAgICAgICAgICAgICAgZmlyc3ROYW1lOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgbGFzdE5hbWU6IHRydWUsXG4gICAgICAgICAgICAgICAgICBlbWFpbDogdHJ1ZSxcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgfSk7XG5cbiAgICAgIC8vIENhbGN1bGF0ZSBjYW5jZWxsYXRpb24gbm90aWNlXG4gICAgICBjb25zdCBjYW5jZWxsYXRpb25Ob3RpY2UgPSBNYXRoLmZsb29yKFxuICAgICAgICAobWVldGluZy5zdGFydFRpbWUuZ2V0VGltZSgpIC0gRGF0ZS5ub3coKSkgLyAoMTAwMCAqIDYwICogNjApLFxuICAgICAgKTtcblxuICAgICAgLy8gSGFuZGxlIHBheW1lbnQgcmVmdW5kIGZvciBjYW5jZWxsZWQgc2Vzc2lvbnNcbiAgICAgIHRyeSB7XG4gICAgICAgIC8vIEZpbmQgcGF5bWVudCByZWNvcmQgYXNzb2NpYXRlZCB3aXRoIHRoaXMgbWVldGluZyB1c2luZyB0aGUgdXBkYXRlZCBBUElcbiAgICAgICAgY29uc3QgcGF5bWVudHMgPSBhd2FpdCB0aGlzLmJpbGxpbmdTZXJ2aWNlLmdldFVzZXJQYXltZW50cyh1c2VySWQsIHtcbiAgICAgICAgICBsaW1pdDogMTAwLFxuICAgICAgICB9KTtcbiAgICAgICAgY29uc3QgbWVldGluZ1BheW1lbnQgPSBwYXltZW50cy5maW5kKChwKSA9PiBwLm1lZXRpbmdJZCA9PT0gbWVldGluZy5pZCk7XG5cbiAgICAgICAgaWYgKG1lZXRpbmdQYXltZW50ICYmIGNhbmNlbGxhdGlvbk5vdGljZSA+PSAyNCkge1xuICAgICAgICAgIC8vIDI0LWhvdXIgY2FuY2VsbGF0aW9uIHBvbGljeVxuICAgICAgICAgIC8vIE5PVEU6IFJlZnVuZCBsb2dpYyB3b3VsZCBuZWVkIHRvIGJlIGltcGxlbWVudGVkIGluIGJpbGxpbmcgc2VydmljZVxuICAgICAgICAgIC8vIEZvciBub3csIHdlJ2xsIGVtaXQgYW4gZXZlbnQgdGhhdCBhIHJlZnVuZCBpcyBuZWVkZWRcbiAgICAgICAgICB0aGlzLmxvZ2dlci5sb2coXG4gICAgICAgICAgICBgUmVmdW5kIG5lZWRlZCBmb3IgY2FuY2VsbGVkIHNlc3Npb24gJHttZWV0aW5nLmlkfSAtICR7Y2FuY2VsbGF0aW9uTm90aWNlfWggbm90aWNlYCxcbiAgICAgICAgICApO1xuICAgICAgICAgIC8vIFRPRE86IEltcGxlbWVudCByZWZ1bmQgcHJvY2Vzc2luZyBpbiBiaWxsaW5nIHNlcnZpY2VcbiAgICAgICAgfVxuICAgICAgfSBjYXRjaCAocmVmdW5kRXJyb3IpIHtcbiAgICAgICAgLy8gTG9nIHJlZnVuZCBlcnJvciBidXQgZG9uJ3QgZmFpbCB0aGUgY2FuY2VsbGF0aW9uXG4gICAgICAgIGNvbnNvbGUuZXJyb3IoXG4gICAgICAgICAgJ0ZhaWxlZCB0byBwcm9jZXNzIHJlZnVuZCBmb3IgY2FuY2VsbGVkIG1lZXRpbmc6JyxcbiAgICAgICAgICByZWZ1bmRFcnJvcixcbiAgICAgICAgKTtcbiAgICAgIH1cblxuICAgICAgLy8gUHVibGlzaCBjYW5jZWxsYXRpb24gZXZlbnRcbiAgICAgIGF3YWl0IHRoaXMuZXZlbnRCdXMuZW1pdChcbiAgICAgICAgbmV3IEFwcG9pbnRtZW50Q2FuY2VsbGVkRXZlbnQoe1xuICAgICAgICAgIGFwcG9pbnRtZW50SWQ6IGNhbmNlbGxlZE1lZXRpbmcuaWQsXG4gICAgICAgICAgY2xpZW50SWQ6IGNhbmNlbGxlZE1lZXRpbmcuY2xpZW50SWQsXG4gICAgICAgICAgdGhlcmFwaXN0SWQ6IGNhbmNlbGxlZE1lZXRpbmcudGhlcmFwaXN0SWQsXG4gICAgICAgICAgY2FuY2VsbGVkQnk6IHVzZXJJZCxcbiAgICAgICAgICBjYW5jZWxsYXRpb25SZWFzb246XG4gICAgICAgICAgICByb2xlID09PSAnY2xpZW50J1xuICAgICAgICAgICAgICA/ICdDYW5jZWxsZWQgYnkgY2xpZW50J1xuICAgICAgICAgICAgICA6ICdDYW5jZWxsZWQgYnkgdGhlcmFwaXN0JyxcbiAgICAgICAgICBvcmlnaW5hbFN0YXJ0VGltZTogbWVldGluZy5zdGFydFRpbWUsXG4gICAgICAgICAgY2FuY2VsbGVkQXQ6IG5ldyBEYXRlKCksXG4gICAgICAgICAgY2FuY2VsbGF0aW9uTm90aWNlOiBNYXRoLm1heCgwLCBjYW5jZWxsYXRpb25Ob3RpY2UpLFxuICAgICAgICB9KSxcbiAgICAgICk7XG5cbiAgICAgIHJldHVybiBjYW5jZWxsZWRNZWV0aW5nO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdEV4Y2VwdGlvbihcbiAgICAgICAgZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiBTdHJpbmcoZXJyb3IpLFxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICAvLyBBdmFpbGFiaWxpdHkgTWFuYWdlbWVudFxuICBhc3luYyBjcmVhdGVBdmFpbGFiaWxpdHkoXG4gICAgY3JlYXRlQXZhaWxhYmlsaXR5RHRvOiBUaGVyYXBpc3RBdmFpbGFiaWxpdHlDcmVhdGVEdG8sXG4gICAgdGhlcmFwaXN0SWQ6IHN0cmluZyxcbiAgKSB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHsgZGF5T2ZXZWVrLCBzdGFydFRpbWUsIGVuZFRpbWUsIG5vdGVzIH0gPSBjcmVhdGVBdmFpbGFiaWxpdHlEdG87XG5cbiAgICAgIC8vIFZhbGlkYXRlIHVzaW5nIG91ciBuZXcgc2VydmljZVxuICAgICAgYXdhaXQgdGhpcy5hdmFpbGFiaWxpdHlWYWxpZGF0b3IudmFsaWRhdGVBdmFpbGFiaWxpdHlDcmVhdGlvbih7XG4gICAgICAgIHRoZXJhcGlzdElkLFxuICAgICAgICBkYXlPZldlZWssXG4gICAgICAgIHN0YXJ0VGltZSxcbiAgICAgICAgZW5kVGltZSxcbiAgICAgIH0pO1xuXG4gICAgICByZXR1cm4gdGhpcy5wcmlzbWEudGhlcmFwaXN0QXZhaWxhYmlsaXR5LmNyZWF0ZSh7XG4gICAgICAgIGRhdGE6IHtcbiAgICAgICAgICB0aGVyYXBpc3RJZCxcbiAgICAgICAgICBkYXlPZldlZWs6IGRheU9mV2Vlay50b1N0cmluZygpLFxuICAgICAgICAgIHN0YXJ0VGltZSxcbiAgICAgICAgICBlbmRUaW1lLFxuICAgICAgICAgIG5vdGVzLFxuICAgICAgICB9LFxuICAgICAgfSk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0RXhjZXB0aW9uKFxuICAgICAgICBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6IFN0cmluZyhlcnJvciksXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGdldEF2YWlsYWJpbGl0eSh0aGVyYXBpc3RJZDogc3RyaW5nKSB7XG4gICAgdHJ5IHtcbiAgICAgIHJldHVybiBhd2FpdCB0aGlzLnByaXNtYS50aGVyYXBpc3RBdmFpbGFiaWxpdHkuZmluZE1hbnkoe1xuICAgICAgICB3aGVyZTogeyB0aGVyYXBpc3RJZCB9LFxuICAgICAgICBvcmRlckJ5OiBbeyBkYXlPZldlZWs6ICdhc2MnIH0sIHsgc3RhcnRUaW1lOiAnYXNjJyB9XSxcbiAgICAgIH0pO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdEV4Y2VwdGlvbihcbiAgICAgICAgZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiBTdHJpbmcoZXJyb3IpLFxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICBhc3luYyB1cGRhdGVBdmFpbGFiaWxpdHkoXG4gICAgaWQ6IHN0cmluZyxcbiAgICB1cGRhdGVBdmFpbGFiaWxpdHlEdG86IFRoZXJhcGlzdEF2YWlsYWJpbGl0eVVwZGF0ZUR0byxcbiAgICB0aGVyYXBpc3RJZDogc3RyaW5nLFxuICApIHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgYXZhaWxhYmlsaXR5ID0gYXdhaXQgdGhpcy5wcmlzbWEudGhlcmFwaXN0QXZhaWxhYmlsaXR5LmZpbmRGaXJzdCh7XG4gICAgICAgIHdoZXJlOiB7IGlkLCB0aGVyYXBpc3RJZCB9LFxuICAgICAgfSk7XG5cbiAgICAgIGlmICghYXZhaWxhYmlsaXR5KSB7XG4gICAgICAgIHRocm93IG5ldyBOb3RGb3VuZEV4Y2VwdGlvbignQXZhaWxhYmlsaXR5IHNsb3Qgbm90IGZvdW5kJyk7XG4gICAgICB9XG5cbiAgICAgIC8vIENvbnZlcnQgZGF5T2ZXZWVrIHRvIHN0cmluZyBpZiBwcmVzZW50XG4gICAgICBjb25zdCB7IGRheU9mV2VlaywgLi4ucmVzdCB9ID0gdXBkYXRlQXZhaWxhYmlsaXR5RHRvO1xuICAgICAgY29uc3QgdXBkYXRlRGF0YSA9IHtcbiAgICAgICAgLi4ucmVzdCxcbiAgICAgICAgLi4uKGRheU9mV2VlayAhPT0gdW5kZWZpbmVkICYmIHtcbiAgICAgICAgICBkYXlPZldlZWs6IGRheU9mV2Vlay50b1N0cmluZygpLFxuICAgICAgICB9KSxcbiAgICAgIH07XG5cbiAgICAgIHJldHVybiB0aGlzLnByaXNtYS50aGVyYXBpc3RBdmFpbGFiaWxpdHkudXBkYXRlKHtcbiAgICAgICAgd2hlcmU6IHsgaWQgfSxcbiAgICAgICAgZGF0YTogdXBkYXRlRGF0YSxcbiAgICAgIH0pO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdEV4Y2VwdGlvbihcbiAgICAgICAgZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiBTdHJpbmcoZXJyb3IpLFxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBkZWxldGVBdmFpbGFiaWxpdHkoaWQ6IHN0cmluZywgdGhlcmFwaXN0SWQ6IHN0cmluZykge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBhdmFpbGFiaWxpdHkgPSBhd2FpdCB0aGlzLnByaXNtYS50aGVyYXBpc3RBdmFpbGFiaWxpdHkuZmluZEZpcnN0KHtcbiAgICAgICAgd2hlcmU6IHsgaWQsIHRoZXJhcGlzdElkIH0sXG4gICAgICB9KTtcblxuICAgICAgaWYgKCFhdmFpbGFiaWxpdHkpIHtcbiAgICAgICAgdGhyb3cgbmV3IE5vdEZvdW5kRXhjZXB0aW9uKCdBdmFpbGFiaWxpdHkgc2xvdCBub3QgZm91bmQnKTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHRoaXMucHJpc21hLnRoZXJhcGlzdEF2YWlsYWJpbGl0eS5kZWxldGUoe1xuICAgICAgICB3aGVyZTogeyBpZCB9LFxuICAgICAgfSk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0RXhjZXB0aW9uKFxuICAgICAgICBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6IFN0cmluZyhlcnJvciksXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIC8vIFNpbXBsaWZpZWQgc2xvdCBnZW5lcmF0aW9uIHVzaW5nIG91ciBuZXcgc2VydmljZVxuICBhc3luYyBnZXRBdmFpbGFibGVTbG90cyh0aGVyYXBpc3RJZDogc3RyaW5nLCBkYXRlOiBzdHJpbmcpIHtcbiAgICB0cnkge1xuICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuc2xvdEdlbmVyYXRvci5nZW5lcmF0ZUF2YWlsYWJsZVNsb3RzKHRoZXJhcGlzdElkLCBkYXRlKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFeGNlcHRpb24oXG4gICAgICAgIGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogU3RyaW5nKGVycm9yKSxcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgLy8gRHVyYXRpb24gbWFuYWdlbWVudFxuICBnZXREdXJhdGlvbnMoKSB7XG4gICAgcmV0dXJuIFtcbiAgICAgIHsgaWQ6ICczMCcsIG5hbWU6ICczMCBtaW51dGVzJywgZHVyYXRpb246IDMwIH0sXG4gICAgICB7IGlkOiAnNjAnLCBuYW1lOiAnNjAgbWludXRlcycsIGR1cmF0aW9uOiA2MCB9LFxuICAgICAgeyBpZDogJzkwJywgbmFtZTogJzkwIG1pbnV0ZXMnLCBkdXJhdGlvbjogOTAgfSxcbiAgICAgIHsgaWQ6ICcxMjAnLCBuYW1lOiAnMTIwIG1pbnV0ZXMnLCBkdXJhdGlvbjogMTIwIH0sXG4gICAgXTtcbiAgfVxuXG4gIC8vIEVuaGFuY2VkIHZhbGlkYXRpb24gbWV0aG9kIHVzaW5nIG91ciBzZXJ2aWNlc1xuICBhc3luYyB2YWxpZGF0ZU1lZXRpbmdUaW1lKFxuICAgIHRoZXJhcGlzdElkOiBzdHJpbmcsXG4gICAgY2xpZW50SWQ6IHN0cmluZyxcbiAgICBzdGFydFRpbWU6IHN0cmluZyB8IERhdGUsXG4gICAgZHVyYXRpb246IG51bWJlcixcbiAgKSB7XG4gICAgY29uc3Qgc3RhcnRUaW1lRGF0ZSA9IG5ldyBEYXRlKHN0YXJ0VGltZSk7XG5cbiAgICBhd2FpdCB0aGlzLmF2YWlsYWJpbGl0eVZhbGlkYXRvci52YWxpZGF0ZU1lZXRpbmdDcmVhdGlvbih7XG4gICAgICB0aGVyYXBpc3RJZCxcbiAgICAgIGNsaWVudElkLFxuICAgICAgc3RhcnRUaW1lOiBzdGFydFRpbWVEYXRlLFxuICAgICAgZHVyYXRpb24sXG4gICAgfSk7XG5cbiAgICBhd2FpdCB0aGlzLmNvbmZsaWN0RGV0ZWN0aW9uLnZhbGlkYXRlTm9Db25mbGljdHMoXG4gICAgICB0aGVyYXBpc3RJZCxcbiAgICAgIGNsaWVudElkLFxuICAgICAgc3RhcnRUaW1lRGF0ZSxcbiAgICAgIGR1cmF0aW9uLFxuICAgICk7XG5cbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxufVxuIl0sInZlcnNpb24iOjN9