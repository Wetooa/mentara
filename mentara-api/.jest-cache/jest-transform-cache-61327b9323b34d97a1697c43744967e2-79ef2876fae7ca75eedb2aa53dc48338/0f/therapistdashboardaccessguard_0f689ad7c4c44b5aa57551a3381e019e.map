{"file":"/home/wetooa/Documents/code/projects/mentara/mentara-api/src/auth/guards/therapist-dashboard-access.guard.ts","mappings":"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","names":[],"sources":["/home/wetooa/Documents/code/projects/mentara/mentara-api/src/auth/guards/therapist-dashboard-access.guard.ts"],"sourcesContent":["import {\n  Injectable,\n  CanActivate,\n  ExecutionContext,\n  ForbiddenException,\n  NotFoundException,\n  UnauthorizedException,\n} from '@nestjs/common';\nimport { PrismaService } from 'src/providers/prisma-client.provider';\n\n/**\n * Specialized guard for therapist dashboard access that validates:\n * 1. User is authenticated\n * 2. User has role 'therapist'\n * 3. User has corresponding Therapist record in database\n * 4. User account is active\n * 5. Therapist status is appropriate for dashboard access\n */\n@Injectable()\nexport class TherapistDashboardAccessGuard implements CanActivate {\n  constructor(private prisma: PrismaService) {}\n\n  async canActivate(context: ExecutionContext): Promise<boolean> {\n    const request = context.switchToHttp().getRequest();\n    const user = request.user;\n    const userRole = request.userRole || user?.role;\n    const userId = request.userId || user?.userId || user?.id;\n\n    console.log(`üîê [TherapistDashboardGuard] Validating access for userId: ${userId}, role: ${userRole}`);\n\n    // 1. Check if user is authenticated\n    if (!userId) {\n      console.error(`‚ùå [TherapistDashboardGuard] No userId found in request`);\n      throw new UnauthorizedException('Authentication required');\n    }\n\n    // 2. Verify user exists and get fresh data\n    const userRecord = await this.prisma.user.findUnique({\n      where: { id: userId },\n      select: {\n        id: true,\n        email: true,\n        firstName: true,\n        lastName: true,\n        role: true,\n        isActive: true,\n        createdAt: true,\n      },\n    });\n\n    if (!userRecord) {\n      console.error(`‚ùå [TherapistDashboardGuard] User not found: ${userId}`);\n      throw new NotFoundException(`User not found: ${userId}`);\n    }\n\n    console.log(`üë§ [TherapistDashboardGuard] User found: ${userRecord.email}, role: ${userRecord.role}, active: ${userRecord.isActive}`);\n\n    // 3. Check if user has therapist role\n    if (userRecord.role !== 'therapist') {\n      console.error(`‚ùå [TherapistDashboardGuard] User ${userRecord.email} has role '${userRecord.role}', expected 'therapist'`);\n      throw new ForbiddenException(\n        `Access denied. User role '${userRecord.role}' is not authorized for therapist dashboard. Required role: 'therapist'`\n      );\n    }\n\n    // 4. Check if user account is active\n    if (!userRecord.isActive) {\n      console.error(`‚ùå [TherapistDashboardGuard] User ${userRecord.email} account is not active`);\n      throw new ForbiddenException('Access denied. Account is not active.');\n    }\n\n    // 5. Verify Therapist record exists\n    const therapistRecord = await this.prisma.therapist.findUnique({\n      where: { userId: userRecord.id },\n      select: {\n        userId: true,\n        status: true,\n        createdAt: true,\n        providerType: true,\n        yearsOfExperience: true,\n      },\n    });\n\n    if (!therapistRecord) {\n      console.error(`‚ùå [TherapistDashboardGuard] Therapist record not found for user: ${userRecord.email} (${userId})`);\n      console.error(`‚ùå [TherapistDashboardGuard] User has role 'therapist' but missing Therapist table record - data inconsistency!`);\n      \n      // This is a critical data consistency issue that should be escalated\n      throw new ForbiddenException(\n        `Access denied. Therapist profile not found for user ${userRecord.email}. ` +\n        `This indicates a data consistency issue. Please contact support.`\n      );\n    }\n\n    console.log(`üë©‚Äç‚öïÔ∏è [TherapistDashboardGuard] Therapist record found: status=${therapistRecord.status}, provider=${therapistRecord.providerType}`);\n\n    // 6. Check therapist status (warn but don't block for non-APPROVED status)\n    if (therapistRecord.status !== 'APPROVED') {\n      console.warn(`‚ö†Ô∏è [TherapistDashboardGuard] Therapist ${userRecord.email} has status: ${therapistRecord.status} (not APPROVED)`);\n      \n      // For PENDING/REJECTED status, we might want to show a different dashboard or message\n      // but we'll allow access and let the dashboard service handle the specific display logic\n      if (therapistRecord.status === 'REJECTED') {\n        console.warn(`‚ö†Ô∏è [TherapistDashboardGuard] Allowing access but therapist application was rejected`);\n      }\n    }\n\n    // 7. All validations passed\n    console.log(`‚úÖ [TherapistDashboardGuard] Access granted for therapist: ${userRecord.email}`);\n    \n    // Store validated therapist info in request for downstream use\n    request.validatedTherapist = {\n      userId: userRecord.id,\n      email: userRecord.email,\n      name: `${userRecord.firstName} ${userRecord.lastName}`,\n      status: therapistRecord.status,\n      providerType: therapistRecord.providerType,\n    };\n\n    return true;\n  }\n}"],"version":3}