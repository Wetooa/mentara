{"file":"/home/wetooa/Documents/code/projects/mentara/mentara-api/src/therapist/controllers/therapist-worksheet.controller.ts","mappings":"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","names":[],"sources":["/home/wetooa/Documents/code/projects/mentara/mentara-api/src/therapist/controllers/therapist-worksheet.controller.ts"],"sourcesContent":["import {\n  Controller,\n  Get,\n  Post,\n  Put,\n  Body,\n  Param,\n  Query,\n  HttpCode,\n  HttpStatus,\n  UseGuards,\n  BadRequestException,\n  NotFoundException,\n  ForbiddenException,\n} from '@nestjs/common';\nimport { JwtAuthGuard } from '../../auth/guards/jwt-auth.guard';\nimport { RoleGuard } from '../../auth/guards/role.guard';\nimport { CurrentUserId } from '../../auth/decorators/current-user-id.decorator';\nimport { Roles } from '../../auth/decorators/roles.decorator';\nimport { WorksheetsService } from '../../worksheets/worksheets.service';\nimport { NotificationsService } from '../../notifications/notifications.service';\nimport { PrismaService } from '../../providers/prisma-client.provider';\n// import {\n//   WorksheetCreateInputDtoSchema,\n//   WorksheetUpdateInputDtoSchema,\n// } from '../validation';\nimport type {\n  WorksheetCreateInputDto,\n  WorksheetUpdateInputDto,\n} from '../types';\nimport { ApiTags, ApiOperation, ApiResponse, ApiBearerAuth } from '@nestjs/swagger';\n\n@ApiTags('therapist-worksheets')\n@ApiBearerAuth('JWT-auth')\n@Controller('therapist')\n@UseGuards(JwtAuthGuard, RoleGuard)\n@Roles('therapist')\nexport class TherapistWorksheetController {\n  constructor(\n    private readonly worksheetsService: WorksheetsService,\n    private readonly notificationsService: NotificationsService,\n    private readonly prisma: PrismaService,\n  ) {}\n\n  @Get('worksheets')\n  @HttpCode(HttpStatus.OK)\n  @ApiOperation({\n    summary: 'Get therapist worksheets',\n    description: 'Retrieve all worksheets created by the therapist',\n  })\n  async getTherapistWorksheets(\n    @CurrentUserId() therapistId: string,\n    @Query('status') status?: string,\n    @Query('clientId') clientId?: string,\n  ) {\n    return this.worksheetsService.findAll(clientId, therapistId, status);\n  }\n\n  @Get('worksheets/:id')\n  @HttpCode(HttpStatus.OK)\n  @ApiOperation({\n    summary: 'Get worksheet by ID',\n    description: 'Retrieve a specific worksheet by ID',\n  })\n  async getTherapistWorksheetById(\n    @CurrentUserId() therapistId: string,\n    @Param('id') worksheetId: string,\n  ) {\n    return this.worksheetsService.findById(worksheetId);\n  }\n\n  @Post('worksheets')\n  @HttpCode(HttpStatus.CREATED)\n  @ApiOperation({\n    summary: 'Create worksheet (legacy)',\n    description: 'Create a new worksheet with clientId in body',\n  })\n  async createTherapistWorksheet(\n    @CurrentUserId() therapistId: string,\n    @Body() createWorksheetDto: WorksheetCreateInputDto & { clientId: string },\n  ) {\n    // Transform to canonical WorksheetCreateInputDto format\n    const canonicalDto: WorksheetCreateInputDto = {\n      ...createWorksheetDto,\n      category: createWorksheetDto.category || 'therapy-assignment', // Default category\n      clientIds: [createWorksheetDto.clientId], // Transform single clientId to array\n    };\n    \n    return this.worksheetsService.create(\n      canonicalDto,\n      createWorksheetDto.clientId,\n      therapistId,\n    );\n  }\n\n  @Put('worksheets/:id')\n  @HttpCode(HttpStatus.OK)\n  @ApiOperation({\n    summary: 'Update worksheet',\n    description: 'Update an existing worksheet',\n  })\n  async updateTherapistWorksheet(\n    @CurrentUserId() therapistId: string,\n    @Param('id') worksheetId: string,\n    @Body() updateWorksheetDto: WorksheetUpdateInputDto,\n  ) {\n    return this.worksheetsService.update(worksheetId, updateWorksheetDto);\n  }\n\n  // NEW MODULE 2 ENDPOINT\n  @Post('clients/:clientId/worksheets')\n  @HttpCode(HttpStatus.CREATED)\n  @ApiOperation({\n    summary: 'Assign worksheet to client',\n    description: 'Create and assign a new worksheet to a specific client',\n  })\n  @ApiResponse({\n    status: 201,\n    description: 'Worksheet created and assigned successfully',\n  })\n  @ApiResponse({\n    status: 400,\n    description: 'Invalid request data',\n  })\n  @ApiResponse({\n    status: 403,\n    description: 'Not authorized to assign worksheets to this client',\n  })\n  @ApiResponse({\n    status: 404,\n    description: 'Client not found or no active relationship',\n  })\n  async assignWorksheetToClient(\n    @CurrentUserId() therapistId: string,\n    @Param('clientId') clientId: string,\n    @Body() createWorksheetDto: WorksheetCreateInputDto,\n  ) {\n    // Validate that therapist has an active relationship with the client\n    const relationship = await this.prisma.clientTherapist.findUnique({\n      where: {\n        clientId_therapistId: {\n          clientId,\n          therapistId,\n        },\n      },\n      include: {\n        client: {\n          include: { user: true },\n        },\n        therapist: {\n          include: { user: true },\n        },\n      },\n    });\n\n    if (!relationship) {\n      throw new NotFoundException(\n        'No relationship found between therapist and client',\n      );\n    }\n\n    // Relationship exists, so we can assign worksheets\n    // (All relationships are considered active now)\n\n    // Validate worksheet data\n    if (!createWorksheetDto.title || createWorksheetDto.title.trim() === '') {\n      throw new BadRequestException('Worksheet title is required');\n    }\n\n    if (!createWorksheetDto.instructions || createWorksheetDto.instructions.trim() === '') {\n      throw new BadRequestException('Worksheet instructions are required');\n    }\n\n    // Transform to canonical WorksheetCreateInputDto format\n    const canonicalDto: WorksheetCreateInputDto = {\n      ...createWorksheetDto,\n      category: createWorksheetDto.category || 'therapy-assignment', // Default category\n      clientIds: [clientId], // Set clientIds array for assignment\n    };\n\n    // Create the worksheet\n    const worksheet = await this.worksheetsService.create(\n      canonicalDto,\n      clientId,\n      therapistId,\n    );\n\n    // Send notification to client about new worksheet assignment\n    try {\n      await this.notificationsService.createWorksheetAssignedNotification(\n        clientId,\n        worksheet.id,\n        createWorksheetDto.title,\n        `${relationship.therapist.user.firstName} ${relationship.therapist.user.lastName}`,\n      );\n    } catch (error) {\n      // Log notification error but don't fail the worksheet creation\n      console.error('Failed to create worksheet notification:', error);\n    }\n\n    return {\n      success: true,\n      message: 'Worksheet assigned successfully',\n      data: {\n        worksheet,\n        assignedTo: {\n          id: relationship.client.userId,\n          name: `${relationship.client.user.firstName} ${relationship.client.user.lastName}`,\n        },\n        assignedBy: {\n          id: therapistId,\n          name: `${relationship.therapist.user.firstName} ${relationship.therapist.user.lastName}`,\n        },\n      },\n    };\n  }\n}\n"],"version":3}