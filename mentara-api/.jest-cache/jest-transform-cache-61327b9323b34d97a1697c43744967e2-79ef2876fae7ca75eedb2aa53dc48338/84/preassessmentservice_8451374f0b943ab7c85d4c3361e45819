c72f524543d3065f454a66b48bc9676a
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var PreAssessmentService_1;
Object.defineProperty(exports, "__esModule", { value: true });
exports.PreAssessmentService = void 0;
const common_1 = require("@nestjs/common");
const prisma_client_provider_1 = require("../providers/prisma-client.provider");
const pre_assessment_utils_1 = require("./pre-assessment.utils");
const ai_service_client_1 = require("./services/ai-service.client");
let PreAssessmentService = PreAssessmentService_1 = class PreAssessmentService {
    prisma;
    aiServiceClient;
    logger = new common_1.Logger(PreAssessmentService_1.name);
    constructor(prisma, aiServiceClient) {
        this.prisma = prisma;
        this.aiServiceClient = aiServiceClient;
    }
    async getAiEstimate(flatAnswers) {
        try {
            this.logger.debug(`Requesting AI prediction for ${flatAnswers.length} values`);
            const result = await this.aiServiceClient.predict(flatAnswers);
            if (!result.success) {
                this.logger.warn(`AI prediction failed: ${result.error}`);
                return null;
            }
            this.logger.log(`AI prediction completed successfully in ${result.responseTime}ms`);
            return result.predictions || null;
        }
        catch (error) {
            this.logger.error('AI model prediction error:', error instanceof Error ? error.message : error);
            return null;
        }
    }
    flattenAnswers(answers) {
        // Input validation
        if (!Array.isArray(answers)) {
            throw new common_1.BadRequestException('Answers must be a 2D array');
        }
        // Flatten the 2D answers array
        const flattened = answers.flat();
        // Validate flattened array
        if (!Array.isArray(flattened) || flattened.length === 0) {
            throw new common_1.BadRequestException('Flattened answers array cannot be empty');
        }
        // Validate all values are numbers
        if (!flattened.every((value) => typeof value === 'number' && Number.isFinite(value))) {
            throw new common_1.BadRequestException('All answer values must be finite numbers');
        }
        // Validate expected length for AI model
        if (flattened.length !== 201) {
            this.logger.warn(`Expected 201 values for AI prediction, got ${flattened.length}`);
        }
        this.logger.debug(`Flattened ${answers.length} questionnaire arrays into ${flattened.length} values`);
        return flattened;
    }
    validateAnswersStructure(answers) {
        if (!Array.isArray(answers)) {
            throw new common_1.BadRequestException('Answers must be an array of arrays');
        }
        if (answers.length === 0) {
            throw new common_1.BadRequestException('Answers array cannot be empty');
        }
        // Validate each questionnaire's answers
        for (let i = 0; i < answers.length; i++) {
            const questionnaire = answers[i];
            if (!Array.isArray(questionnaire)) {
                throw new common_1.BadRequestException(`Questionnaire ${i} answers must be an array`);
            }
            if (questionnaire.length === 0) {
                throw new common_1.BadRequestException(`Questionnaire ${i} cannot have empty answers`);
            }
            // Validate answer values are in reasonable range (0-10 for most scales)
            for (let j = 0; j < questionnaire.length; j++) {
                const value = questionnaire[j];
                if (typeof value !== 'number' || !Number.isFinite(value)) {
                    throw new common_1.BadRequestException(`Invalid answer value at questionnaire ${i}, question ${j}: ${value}`);
                }
                if (value < 0 || value > 10) {
                    throw new common_1.BadRequestException(`Answer value out of range (0-10) at questionnaire ${i}, question ${j}: ${value}`);
                }
            }
        }
    }
    validateQuestionnaires(questionnaires) {
        if (!Array.isArray(questionnaires)) {
            throw new common_1.BadRequestException('Questionnaires must be an array');
        }
        if (questionnaires.length === 0) {
            throw new common_1.BadRequestException('At least one questionnaire is required');
        }
        // Define valid questionnaire types
        const validQuestionnaires = [
            'Stress',
            'Anxiety',
            'Depression',
            'Insomnia',
            'Panic Disorder',
            'Bipolar Disorder',
            'OCD',
            'PTSD',
            'Social Anxiety',
            'Phobia',
            'Burnout',
            'Binge Eating',
            'ADHD',
            'Alcohol Use',
        ];
        for (const questionnaire of questionnaires) {
            if (typeof questionnaire !== 'string' ||
                questionnaire.trim().length === 0) {
                throw new common_1.BadRequestException('All questionnaire names must be non-empty strings');
            }
            if (!validQuestionnaires.includes(questionnaire)) {
                this.logger.warn(`Unknown questionnaire type: ${questionnaire}`);
            }
        }
    }
    async createPreAssessment(userId, data) {
        try {
            this.logger.log(`Creating pre-assessment for user ${userId}`);
            // Validate user exists and is active
            const user = await this.prisma.user.findUnique({
                where: { id: userId, isActive: true },
                select: { id: true, isActive: true },
            });
            if (!user) {
                throw new common_1.NotFoundException('User not found or inactive');
            }
            // Validate client exists
            const client = await this.prisma.client.findUnique({
                where: { userId: userId },
                select: { userId: true },
            });
            if (!client) {
                throw new common_1.NotFoundException('Client profile not found');
            }
            // Check for existing pre-assessment
            const existingAssessment = await this.prisma.preAssessment.findUnique({
                where: { clientId: userId },
            });
            if (existingAssessment) {
                throw new common_1.BadRequestException('Pre-assessment already exists for this user');
            }
            // Comprehensive input validation
            this.validateQuestionnaires(data.questionnaires);
            this.validateAnswersStructure(data.answers);
            // Validate questionnaires and answers alignment
            if (data.questionnaires.length !==
                data.answers.length) {
                throw new common_1.BadRequestException('Number of questionnaires must match number of answer arrays');
            }
            let scores = data.scores;
            let severityLevels = data.severityLevels;
            // Calculate scores if not provided
            if (!data.scores || !data.severityLevels) {
                this.logger.debug('Calculating scores and severity levels');
                const calculatedScores = (0, pre_assessment_utils_1.calculateAllScores)(data.questionnaires, data.answers);
                scores = Object.fromEntries(Object.entries(calculatedScores).map(([key, value]) => [
                    key,
                    value.score,
                ]));
                severityLevels = (0, pre_assessment_utils_1.generateSeverityLevels)(calculatedScores);
            }
            // Safely flatten answers and attempt AI prediction
            let aiEstimate = {};
            try {
                const flatAnswers = this.flattenAnswers(data.answers);
                if (flatAnswers.length === 201) {
                    this.logger.debug('Attempting AI prediction with validated input');
                    const aiResult = await this.getAiEstimate(flatAnswers);
                    if (aiResult) {
                        aiEstimate = aiResult;
                        this.logger.log('AI prediction successful');
                    }
                    else {
                        this.logger.warn('AI prediction failed, continuing without AI estimate');
                    }
                }
                else {
                    this.logger.warn(`Cannot perform AI prediction: expected 201 values, got ${flatAnswers.length}`);
                }
            }
            catch (aiError) {
                this.logger.error('AI prediction error, continuing without AI estimate:', aiError);
                // Continue without AI estimate - don't fail the entire assessment
            }
            // Create pre-assessment with validated data
            const preAssessment = await this.prisma.preAssessment.create({
                data: {
                    clientId: userId,
                    questionnaires: data.questionnaires,
                    answers: data.answers,
                    answerMatrix: data.answerMatrix,
                    scores,
                    severityLevels,
                    aiEstimate,
                },
            });
            this.logger.log(`Pre-assessment created successfully for user ${userId}`);
            return preAssessment;
        }
        catch (error) {
            if (error instanceof common_1.NotFoundException ||
                error instanceof common_1.BadRequestException) {
                throw error;
            }
            this.logger.error('Error creating pre-assessment:', error instanceof Error ? error.message : error);
            throw new common_1.InternalServerErrorException('Failed to create pre-assessment');
        }
    }
    handleError(error, message) {
        if (error instanceof common_1.NotFoundException) {
            throw error;
        }
        if (error instanceof Error) {
            console.error(message, error.message);
            throw new common_1.InternalServerErrorException(error.message);
        }
        console.error(message, error);
        throw new common_1.InternalServerErrorException(message);
    }
    async getPreAssessmentByUserId(userId) {
        try {
            const preAssessment = await this.prisma.preAssessment.findUnique({
                where: { clientId: userId },
            });
            if (!preAssessment) {
                throw new common_1.NotFoundException('Pre-assessment not found');
            }
            return preAssessment;
        }
        catch (error) {
            this.handleError(error, 'Error retrieving pre-assessment');
        }
    }
    async getPreAssessmentByClientId(clientId) {
        try {
            const preAssessment = await this.prisma.preAssessment.findUnique({
                where: { clientId: clientId },
                include: { client: { include: { user: true } } },
            });
            if (!preAssessment) {
                throw new common_1.NotFoundException('Pre-assessment not found');
            }
            return preAssessment;
        }
        catch (error) {
            this.handleError(error, 'Error retrieving pre-assessment');
        }
    }
    isValidScores(scores) {
        if (typeof scores !== 'object' || scores === null)
            return false;
        return Object.entries(scores).every(([key, value]) => typeof key === 'string' && typeof value === 'number');
    }
    isValidSeverityLevels(levels) {
        if (typeof levels !== 'object' || levels === null)
            return false;
        return Object.entries(levels).every(([key, value]) => typeof key === 'string' && typeof value === 'string');
    }
    async updatePreAssessment(userId, data) {
        try {
            const client = await this.prisma.client.findUnique({
                where: { userId: userId },
            });
            if (!client) {
                throw new common_1.NotFoundException('Client not found');
            }
            let scores;
            let severityLevels;
            if (data.scores && this.isValidScores(data.scores)) {
                scores = data.scores;
            }
            else {
                scores = {};
            }
            if (data.severityLevels &&
                this.isValidSeverityLevels(data.severityLevels)) {
                severityLevels = data.severityLevels;
            }
            else {
                severityLevels = {};
            }
            if (data.questionnaires &&
                data.answers &&
                (!data.scores || !data.severityLevels)) {
                const calculatedScores = (0, pre_assessment_utils_1.calculateAllScores)(data.questionnaires, data.answers);
                scores = Object.fromEntries(Object.entries(calculatedScores).map(([key, value]) => [
                    key,
                    value.score,
                ]));
                severityLevels = (0, pre_assessment_utils_1.generateSeverityLevels)(calculatedScores);
            }
            const preAssessment = await this.prisma.preAssessment.update({
                where: { clientId: userId },
                data: {
                    questionnaires: data.questionnaires,
                    answers: data.answers,
                    answerMatrix: data.answerMatrix,
                    scores,
                    severityLevels,
                },
            });
            if (!preAssessment) {
                throw new common_1.NotFoundException('Pre-assessment not found');
            }
            return preAssessment;
        }
        catch (error) {
            this.handleError(error, 'Error updating pre-assessment');
        }
    }
    async deletePreAssessment(userId) {
        try {
            await this.prisma.preAssessment.delete({
                where: { clientId: userId },
            });
            return null;
        }
        catch (error) {
            this.handleError(error, 'Error deleting pre-assessment');
        }
    }
};
exports.PreAssessmentService = PreAssessmentService;
exports.PreAssessmentService = PreAssessmentService = PreAssessmentService_1 = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [prisma_client_provider_1.PrismaService,
        ai_service_client_1.AiServiceClient])
], PreAssessmentService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL3ByZS1hc3Nlc3NtZW50L3ByZS1hc3Nlc3NtZW50LnNlcnZpY2UudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7OztBQUFBLDJDQU13QjtBQUN4QixnRkFBb0U7QUFDcEUsaUVBR2dDO0FBR2hDLG9FQUErRDtBQUd4RCxJQUFNLG9CQUFvQiw0QkFBMUIsTUFBTSxvQkFBb0I7SUFJWjtJQUNBO0lBSkYsTUFBTSxHQUFHLElBQUksZUFBTSxDQUFDLHNCQUFvQixDQUFDLElBQUksQ0FBQyxDQUFDO0lBRWhFLFlBQ21CLE1BQXFCLEVBQ3JCLGVBQWdDO1FBRGhDLFdBQU0sR0FBTixNQUFNLENBQWU7UUFDckIsb0JBQWUsR0FBZixlQUFlLENBQWlCO0lBQ2hELENBQUM7SUFFSSxLQUFLLENBQUMsYUFBYSxDQUN6QixXQUFxQjtRQUVyQixJQUFJLENBQUM7WUFDSCxJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FDZixnQ0FBZ0MsV0FBVyxDQUFDLE1BQU0sU0FBUyxDQUM1RCxDQUFDO1lBRUYsTUFBTSxNQUFNLEdBQUcsTUFBTSxJQUFJLENBQUMsZUFBZSxDQUFDLE9BQU8sQ0FBQyxXQUFXLENBQUMsQ0FBQztZQUUvRCxJQUFJLENBQUMsTUFBTSxDQUFDLE9BQU8sRUFBRSxDQUFDO2dCQUNwQixJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyx5QkFBeUIsTUFBTSxDQUFDLEtBQUssRUFBRSxDQUFDLENBQUM7Z0JBQzFELE9BQU8sSUFBSSxDQUFDO1lBQ2QsQ0FBQztZQUVELElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUNiLDJDQUEyQyxNQUFNLENBQUMsWUFBWSxJQUFJLENBQ25FLENBQUM7WUFDRixPQUFPLE1BQU0sQ0FBQyxXQUFXLElBQUksSUFBSSxDQUFDO1FBQ3BDLENBQUM7UUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1lBQ2YsSUFBSSxDQUFDLE1BQU0sQ0FBQyxL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SUFBSSxDQUFDLE9BQXFCO29CQUNuQyxZQUFZLEVBQUUsSUFBSSxDQUFDLFlBQTBCO29CQUM3QyxNQUFNO29CQUNOLGNBQWM7aUJBQ2Y7YUFDRixDQUFDLENBQUM7WUFFSCxJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7Z0JBQ25CLE1BQU0sSUFBSSwwQkFBaUIsQ0FBQywwQkFBMEIsQ0FBQyxDQUFDO1lBQzFELENBQUM7WUFFRCxPQUFPLGFBQWEsQ0FBQztRQUN2QixDQUFDO1FBQUMsT0FBTyxLQUFjLEVBQUUsQ0FBQztZQUN4QixJQUFJLENBQUMsV0FBVyxDQUFDLEtBQUssRUFBRSwrQkFBK0IsQ0FBQyxDQUFDO1FBQzNELENBQUM7SUFDSCxDQUFDO0lBRUQsS0FBSyxDQUFDLG1CQUFtQixDQUFDLE1BQWM7UUFDdEMsSUFBSSxDQUFDO1lBQ0gsTUFBTSxJQUFJLENBQUMsTUFBTSxDQUFDLGFBQWEsQ0FBQyxNQUFNLENBQUM7Z0JBQ3JDLEtBQUssRUFBRSxFQUFFLFFBQVEsRUFBRSxNQUFNLEVBQUU7YUFDNUIsQ0FBQyxDQUFDO1lBQ0gsT0FBTyxJQUFJLENBQUM7UUFDZCxDQUFDO1FBQUMsT0FBTyxLQUFjLEVBQUUsQ0FBQztZQUN4QixJQUFJLENBQUMsV0FBVyxDQUFDLEtBQUssRUFBRSwrQkFBK0IsQ0FBQyxDQUFDO1FBQzNELENBQUM7SUFDSCxDQUFDO0NBQ0YsQ0FBQTtBQS9hWSxvREFBb0I7K0JBQXBCLG9CQUFvQjtJQURoQyxJQUFBLG1CQUFVLEdBQUU7cUNBS2dCLHNDQUFhO1FBQ0osbUNBQWU7R0FMeEMsb0JBQW9CLENBK2FoQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvaG9tZS93ZXRvb2EvRG9jdW1lbnRzL2NvZGUvcHJvamVjdHMvbWVudGFyYS9tZW50YXJhLWFwaS9zcmMvcHJlLWFzc2Vzc21lbnQvcHJlLWFzc2Vzc21lbnQuc2VydmljZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBJbmplY3RhYmxlLFxuICBOb3RGb3VuZEV4Y2VwdGlvbixcbiAgSW50ZXJuYWxTZXJ2ZXJFcnJvckV4Y2VwdGlvbixcbiAgQmFkUmVxdWVzdEV4Y2VwdGlvbixcbiAgTG9nZ2VyLFxufSBmcm9tICdAbmVzdGpzL2NvbW1vbic7XG5pbXBvcnQgeyBQcmlzbWFTZXJ2aWNlIH0gZnJvbSAnLi4vcHJvdmlkZXJzL3ByaXNtYS1jbGllbnQucHJvdmlkZXInO1xuaW1wb3J0IHtcbiAgY2FsY3VsYXRlQWxsU2NvcmVzLFxuICBnZW5lcmF0ZVNldmVyaXR5TGV2ZWxzLFxufSBmcm9tICcuL3ByZS1hc3Nlc3NtZW50LnV0aWxzJztcbmltcG9ydCB7IFByZUFzc2Vzc21lbnQgfSBmcm9tICdAcHJpc21hL2NsaWVudCc7XG5pbXBvcnQgeyBDcmVhdGVQcmVBc3Nlc3NtZW50RHRvIH0gZnJvbSAnLi4vLi4vc2NoZW1hL3ByZS1hc3Nlc3NtZW50JztcbmltcG9ydCB7IEFpU2VydmljZUNsaWVudCB9IGZyb20gJy4vc2VydmljZXMvYWktc2VydmljZS5jbGllbnQnO1xuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgUHJlQXNzZXNzbWVudFNlcnZpY2Uge1xuICBwcml2YXRlIHJlYWRvbmx5IGxvZ2dlciA9IG5ldyBMb2dnZXIoUHJlQXNzZXNzbWVudFNlcnZpY2UubmFtZSk7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSByZWFkb25seSBwcmlzbWE6IFByaXNtYVNlcnZpY2UsXG4gICAgcHJpdmF0ZSByZWFkb25seSBhaVNlcnZpY2VDbGllbnQ6IEFpU2VydmljZUNsaWVudCxcbiAgKSB7fVxuXG4gIHByaXZhdGUgYXN5bmMgZ2V0QWlFc3RpbWF0ZShcbiAgICBmbGF0QW5zd2VyczogbnVtYmVyW10sXG4gICk6IFByb21pc2U8UmVjb3JkPHN0cmluZywgYm9vbGVhbj4gfCBudWxsPiB7XG4gICAgdHJ5IHtcbiAgICAgIHRoaXMubG9nZ2VyLmRlYnVnKFxuICAgICAgICBgUmVxdWVzdGluZyBBSSBwcmVkaWN0aW9uIGZvciAke2ZsYXRBbnN3ZXJzLmxlbmd0aH0gdmFsdWVzYCxcbiAgICAgICk7XG5cbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHRoaXMuYWlTZXJ2aWNlQ2xpZW50LnByZWRpY3QoZmxhdEFuc3dlcnMpO1xuXG4gICAgICBpZiAoIXJlc3VsdC5zdWNjZXNzKSB7XG4gICAgICAgIHRoaXMubG9nZ2VyLndhcm4oYEFJIHByZWRpY3Rpb24gZmFpbGVkOiAke3Jlc3VsdC5lcnJvcn1gKTtcbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICB9XG5cbiAgICAgIHRoaXMubG9nZ2VyLmxvZyhcbiAgICAgICAgYEFJIHByZWRpY3Rpb24gY29tcGxldGVkIHN1Y2Nlc3NmdWxseSBpbiAke3Jlc3VsdC5yZXNwb25zZVRpbWV9bXNgLFxuICAgICAgKTtcbiAgICAgIHJldHVybiByZXN1bHQucHJlZGljdGlvbnMgfHwgbnVsbDtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoXG4gICAgICAgICdBSSBtb2RlbCBwcmVkaWN0aW9uIGVycm9yOicsXG4gICAgICAgIGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogZXJyb3IsXG4gICAgICApO1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBmbGF0dGVuQW5zd2VycyhhbnN3ZXJzOiBudW1iZXJbXVtdKTogbnVtYmVyW10ge1xuICAgIC8vIElucHV0IHZhbGlkYXRpb25cbiAgICBpZiAoIUFycmF5LmlzQXJyYXkoYW5zd2VycykpIHtcbiAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0RXhjZXB0aW9uKCdBbnN3ZXJzIG11c3QgYmUgYSAyRCBhcnJheScpO1xuICAgIH1cblxuICAgIC8vIEZsYXR0ZW4gdGhlIDJEIGFuc3dlcnMgYXJyYXlcbiAgICBjb25zdCBmbGF0dGVuZWQgPSBhbnN3ZXJzLmZsYXQoKTtcblxuICAgIC8vIFZhbGlkYXRlIGZsYXR0ZW5lZCBhcnJheVxuICAgIGlmICghQXJyYXkuaXNBcnJheShmbGF0dGVuZWQpIHx8IGZsYXR0ZW5lZC5sZW5ndGggPT09IDApIHtcbiAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0RXhjZXB0aW9uKCdGbGF0dGVuZWQgYW5zd2VycyBhcnJheSBjYW5ub3QgYmUgZW1wdHknKTtcbiAgICB9XG5cbiAgICAvLyBWYWxpZGF0ZSBhbGwgdmFsdWVzIGFyZSBudW1iZXJzXG4gICAgaWYgKFxuICAgICAgIWZsYXR0ZW5lZC5ldmVyeShcbiAgICAgICAgKHZhbHVlKSA9PiB0eXBlb2YgdmFsdWUgPT09ICdudW1iZXInICYmIE51bWJlci5pc0Zpbml0ZSh2YWx1ZSksXG4gICAgICApXG4gICAgKSB7XG4gICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdEV4Y2VwdGlvbignQWxsIGFuc3dlciB2YWx1ZXMgbXVzdCBiZSBmaW5pdGUgbnVtYmVycycpO1xuICAgIH1cblxuICAgIC8vIFZhbGlkYXRlIGV4cGVjdGVkIGxlbmd0aCBmb3IgQUkgbW9kZWxcbiAgICBpZiAoZmxhdHRlbmVkLmxlbmd0aCAhPT0gMjAxKSB7XG4gICAgICB0aGlzLmxvZ2dlci53YXJuKFxuICAgICAgICBgRXhwZWN0ZWQgMjAxIHZhbHVlcyBmb3IgQUkgcHJlZGljdGlvbiwgZ290ICR7ZmxhdHRlbmVkLmxlbmd0aH1gLFxuICAgICAgKTtcbiAgICB9XG5cbiAgICB0aGlzLmxvZ2dlci5kZWJ1ZyhcbiAgICAgIGBGbGF0dGVuZWQgJHthbnN3ZXJzLmxlbmd0aH0gcXVlc3Rpb25uYWlyZSBhcnJheXMgaW50byAke2ZsYXR0ZW5lZC5sZW5ndGh9IHZhbHVlc2AsXG4gICAgKTtcbiAgICByZXR1cm4gZmxhdHRlbmVkO1xuICB9XG5cbiAgcHJpdmF0ZSB2YWxpZGF0ZUFuc3dlcnNTdHJ1Y3R1cmUoYW5zd2VyczogbnVtYmVyW11bXSk6IHZvaWQge1xuICAgIGlmICghQXJyYXkuaXNBcnJheShhbnN3ZXJzKSkge1xuICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFeGNlcHRpb24oJ0Fuc3dlcnMgbXVzdCBiZSBhbiBhcnJheSBvZiBhcnJheXMnKTtcbiAgICB9XG5cbiAgICBpZiAoYW5zd2Vycy5sZW5ndGggPT09IDApIHtcbiAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0RXhjZXB0aW9uKCdBbnN3ZXJzIGFycmF5IGNhbm5vdCBiZSBlbXB0eScpO1xuICAgIH1cblxuICAgIC8vIFZhbGlkYXRlIGVhY2ggcXVlc3Rpb25uYWlyZSdzIGFuc3dlcnNcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGFuc3dlcnMubGVuZ3RoOyBpKyspIHtcbiAgICAgIGNvbnN0IHF1ZXN0aW9ubmFpcmUgPSBhbnN3ZXJzW2ldO1xuXG4gICAgICBpZiAoIUFycmF5LmlzQXJyYXkocXVlc3Rpb25uYWlyZSkpIHtcbiAgICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFeGNlcHRpb24oXG4gICAgICAgICAgYFF1ZXN0aW9ubmFpcmUgJHtpfSBhbnN3ZXJzIG11c3QgYmUgYW4gYXJyYXlgLFxuICAgICAgICApO1xuICAgICAgfVxuXG4gICAgICBpZiAocXVlc3Rpb25uYWlyZS5sZW5ndGggPT09IDApIHtcbiAgICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFeGNlcHRpb24oXG4gICAgICAgICAgYFF1ZXN0aW9ubmFpcmUgJHtpfSBjYW5ub3QgaGF2ZSBlbXB0eSBhbnN3ZXJzYCxcbiAgICAgICAgKTtcbiAgICAgIH1cblxuICAgICAgLy8gVmFsaWRhdGUgYW5zd2VyIHZhbHVlcyBhcmUgaW4gcmVhc29uYWJsZSByYW5nZSAoMC0xMCBmb3IgbW9zdCBzY2FsZXMpXG4gICAgICBmb3IgKGxldCBqID0gMDsgaiA8IHF1ZXN0aW9ubmFpcmUubGVuZ3RoOyBqKyspIHtcbiAgICAgICAgY29uc3QgdmFsdWUgPSBxdWVzdGlvbm5haXJlW2pdO1xuXG4gICAgICAgIGlmICh0eXBlb2YgdmFsdWUgIT09ICdudW1iZXInIHx8ICFOdW1iZXIuaXNGaW5pdGUodmFsdWUpKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFeGNlcHRpb24oXG4gICAgICAgICAgICBgSW52YWxpZCBhbnN3ZXIgdmFsdWUgYXQgcXVlc3Rpb25uYWlyZSAke2l9LCBxdWVzdGlvbiAke2p9OiAke3ZhbHVlfWAsXG4gICAgICAgICAgKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICh2YWx1ZSA8IDAgfHwgdmFsdWUgPiAxMCkge1xuICAgICAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0RXhjZXB0aW9uKFxuICAgICAgICAgICAgYEFuc3dlciB2YWx1ZSBvdXQgb2YgcmFuZ2UgKDAtMTApIGF0IHF1ZXN0aW9ubmFpcmUgJHtpfSwgcXVlc3Rpb24gJHtqfTogJHt2YWx1ZX1gLFxuICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHZhbGlkYXRlUXVlc3Rpb25uYWlyZXMocXVlc3Rpb25uYWlyZXM6IHN0cmluZ1tdKTogdm9pZCB7XG4gICAgaWYgKCFBcnJheS5pc0FycmF5KHF1ZXN0aW9ubmFpcmVzKSkge1xuICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFeGNlcHRpb24oJ1F1ZXN0aW9ubmFpcmVzIG11c3QgYmUgYW4gYXJyYXknKTtcbiAgICB9XG5cbiAgICBpZiAocXVlc3Rpb25uYWlyZXMubGVuZ3RoID09PSAwKSB7XG4gICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdEV4Y2VwdGlvbignQXQgbGVhc3Qgb25lIHF1ZXN0aW9ubmFpcmUgaXMgcmVxdWlyZWQnKTtcbiAgICB9XG5cbiAgICAvLyBEZWZpbmUgdmFsaWQgcXVlc3Rpb25uYWlyZSB0eXBlc1xuICAgIGNvbnN0IHZhbGlkUXVlc3Rpb25uYWlyZXMgPSBbXG4gICAgICAnU3RyZXNzJyxcbiAgICAgICdBbnhpZXR5JyxcbiAgICAgICdEZXByZXNzaW9uJyxcbiAgICAgICdJbnNvbW5pYScsXG4gICAgICAnUGFuaWMgRGlzb3JkZXInLFxuICAgICAgJ0JpcG9sYXIgRGlzb3JkZXInLFxuICAgICAgJ09DRCcsXG4gICAgICAnUFRTRCcsXG4gICAgICAnU29jaWFsIEFueGlldHknLFxuICAgICAgJ1Bob2JpYScsXG4gICAgICAnQnVybm91dCcsXG4gICAgICAnQmluZ2UgRWF0aW5nJyxcbiAgICAgICdBREhEJyxcbiAgICAgICdBbGNvaG9sIFVzZScsXG4gICAgXTtcblxuICAgIGZvciAoY29uc3QgcXVlc3Rpb25uYWlyZSBvZiBxdWVzdGlvbm5haXJlcykge1xuICAgICAgaWYgKFxuICAgICAgICB0eXBlb2YgcXVlc3Rpb25uYWlyZSAhPT0gJ3N0cmluZycgfHxcbiAgICAgICAgcXVlc3Rpb25uYWlyZS50cmltKCkubGVuZ3RoID09PSAwXG4gICAgICApIHtcbiAgICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFeGNlcHRpb24oXG4gICAgICAgICAgJ0FsbCBxdWVzdGlvbm5haXJlIG5hbWVzIG11c3QgYmUgbm9uLWVtcHR5IHN0cmluZ3MnLFxuICAgICAgICApO1xuICAgICAgfVxuXG4gICAgICBpZiAoIXZhbGlkUXVlc3Rpb25uYWlyZXMuaW5jbHVkZXMocXVlc3Rpb25uYWlyZSkpIHtcbiAgICAgICAgdGhpcy5sb2dnZXIud2FybihgVW5rbm93biBxdWVzdGlvbm5haXJlIHR5cGU6ICR7cXVlc3Rpb25uYWlyZX1gKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBhc3luYyBjcmVhdGVQcmVBc3Nlc3NtZW50KFxuICAgIHVzZXJJZDogc3RyaW5nLFxuICAgIGRhdGE6IENyZWF0ZVByZUFzc2Vzc21lbnREdG8sXG4gICk6IFByb21pc2U8UHJlQXNzZXNzbWVudD4ge1xuICAgIHRyeSB7XG4gICAgICB0aGlzLmxvZ2dlci5sb2coYENyZWF0aW5nIHByZS1hc3Nlc3NtZW50IGZvciB1c2VyICR7dXNlcklkfWApO1xuXG4gICAgICAvLyBWYWxpZGF0ZSB1c2VyIGV4aXN0cyBhbmQgaXMgYWN0aXZlXG4gICAgICBjb25zdCB1c2VyID0gYXdhaXQgdGhpcy5wcmlzbWEudXNlci5maW5kVW5pcXVlKHtcbiAgICAgICAgd2hlcmU6IHsgaWQ6IHVzZXJJZCwgaXNBY3RpdmU6IHRydWUgfSxcbiAgICAgICAgc2VsZWN0OiB7IGlkOiB0cnVlLCBpc0FjdGl2ZTogdHJ1ZSB9LFxuICAgICAgfSk7XG4gICAgICBpZiAoIXVzZXIpIHtcbiAgICAgICAgdGhyb3cgbmV3IE5vdEZvdW5kRXhjZXB0aW9uKCdVc2VyIG5vdCBmb3VuZCBvciBpbmFjdGl2ZScpO1xuICAgICAgfVxuXG4gICAgICAvLyBWYWxpZGF0ZSBjbGllbnQgZXhpc3RzXG4gICAgICBjb25zdCBjbGllbnQgPSBhd2FpdCB0aGlzLnByaXNtYS5jbGllbnQuZmluZFVuaXF1ZSh7XG4gICAgICAgIHdoZXJlOiB7IHVzZXJJZDogdXNlcklkIH0sXG4gICAgICAgIHNlbGVjdDogeyB1c2VySWQ6IHRydWUgfSxcbiAgICAgIH0pO1xuICAgICAgaWYgKCFjbGllbnQpIHtcbiAgICAgICAgdGhyb3cgbmV3IE5vdEZvdW5kRXhjZXB0aW9uKCdDbGllbnQgcHJvZmlsZSBub3QgZm91bmQnKTtcbiAgICAgIH1cblxuICAgICAgLy8gQ2hlY2sgZm9yIGV4aXN0aW5nIHByZS1hc3Nlc3NtZW50XG4gICAgICBjb25zdCBleGlzdGluZ0Fzc2Vzc21lbnQgPSBhd2FpdCB0aGlzLnByaXNtYS5wcmVBc3Nlc3NtZW50LmZpbmRVbmlxdWUoe1xuICAgICAgICB3aGVyZTogeyBjbGllbnRJZDogdXNlcklkIH0sXG4gICAgICB9KTtcbiAgICAgIGlmIChleGlzdGluZ0Fzc2Vzc21lbnQpIHtcbiAgICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFeGNlcHRpb24oXG4gICAgICAgICAgJ1ByZS1hc3Nlc3NtZW50IGFscmVhZHkgZXhpc3RzIGZvciB0aGlzIHVzZXInLFxuICAgICAgICApO1xuICAgICAgfVxuXG4gICAgICAvLyBDb21wcmVoZW5zaXZlIGlucHV0IHZhbGlkYXRpb25cbiAgICAgIHRoaXMudmFsaWRhdGVRdWVzdGlvbm5haXJlcyhkYXRhLnF1ZXN0aW9ubmFpcmVzIGFzIHN0cmluZ1tdKTtcbiAgICAgIHRoaXMudmFsaWRhdGVBbnN3ZXJzU3RydWN0dXJlKGRhdGEuYW5zd2VycyBhcyBudW1iZXJbXVtdKTtcblxuICAgICAgLy8gVmFsaWRhdGUgcXVlc3Rpb25uYWlyZXMgYW5kIGFuc3dlcnMgYWxpZ25tZW50XG4gICAgICBpZiAoXG4gICAgICAgIChkYXRhLnF1ZXN0aW9ubmFpcmVzIGFzIHN0cmluZ1tdKS5sZW5ndGggIT09XG4gICAgICAgIChkYXRhLmFuc3dlcnMgYXMgbnVtYmVyW11bXSkubGVuZ3RoXG4gICAgICApIHtcbiAgICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFeGNlcHRpb24oXG4gICAgICAgICAgJ051bWJlciBvZiBxdWVzdGlvbm5haXJlcyBtdXN0IG1hdGNoIG51bWJlciBvZiBhbnN3ZXIgYXJyYXlzJyxcbiAgICAgICAgKTtcbiAgICAgIH1cblxuICAgICAgbGV0IHNjb3JlczogUmVjb3JkPHN0cmluZywgbnVtYmVyPiA9IGRhdGEuc2NvcmVzIGFzIFJlY29yZDxcbiAgICAgICAgc3RyaW5nLFxuICAgICAgICBudW1iZXJcbiAgICAgID47XG4gICAgICBsZXQgc2V2ZXJpdHlMZXZlbHM6IFJlY29yZDxzdHJpbmcsIHN0cmluZz4gPVxuICAgICAgICBkYXRhLnNldmVyaXR5TGV2ZWxzIGFzIFJlY29yZDxzdHJpbmcsIHN0cmluZz47XG5cbiAgICAgIC8vIENhbGN1bGF0ZSBzY29yZXMgaWYgbm90IHByb3ZpZGVkXG4gICAgICBpZiAoIWRhdGEuc2NvcmVzIHx8ICFkYXRhLnNldmVyaXR5TGV2ZWxzKSB7XG4gICAgICAgIHRoaXMubG9nZ2VyLmRlYnVnKCdDYWxjdWxhdGluZyBzY29yZXMgYW5kIHNldmVyaXR5IGxldmVscycpO1xuICAgICAgICBjb25zdCBjYWxjdWxhdGVkU2NvcmVzID0gY2FsY3VsYXRlQWxsU2NvcmVzKFxuICAgICAgICAgIGRhdGEucXVlc3Rpb25uYWlyZXMgYXMgc3RyaW5nW10sXG4gICAgICAgICAgZGF0YS5hbnN3ZXJzIGFzIG51bWJlcltdW10sXG4gICAgICAgICk7XG4gICAgICAgIHNjb3JlcyA9IE9iamVjdC5mcm9tRW50cmllcyhcbiAgICAgICAgICBPYmplY3QuZW50cmllcyhjYWxjdWxhdGVkU2NvcmVzKS5tYXAoKFtrZXksIHZhbHVlXSkgPT4gW1xuICAgICAgICAgICAga2V5LFxuICAgICAgICAgICAgdmFsdWUuc2NvcmUsXG4gICAgICAgICAgXSksXG4gICAgICAgICk7XG4gICAgICAgIHNldmVyaXR5TGV2ZWxzID0gZ2VuZXJhdGVTZXZlcml0eUxldmVscyhjYWxjdWxhdGVkU2NvcmVzKTtcbiAgICAgIH1cblxuICAgICAgLy8gU2FmZWx5IGZsYXR0ZW4gYW5zd2VycyBhbmQgYXR0ZW1wdCBBSSBwcmVkaWN0aW9uXG4gICAgICBsZXQgYWlFc3RpbWF0ZTogUmVjb3JkPHN0cmluZywgYm9vbGVhbj4gPSB7fTtcbiAgICAgIHRyeSB7XG4gICAgICAgIGNvbnN0IGZsYXRBbnN3ZXJzID0gdGhpcy5mbGF0dGVuQW5zd2VycyhkYXRhLmFuc3dlcnMgYXMgbnVtYmVyW11bXSk7XG5cbiAgICAgICAgaWYgKGZsYXRBbnN3ZXJzLmxlbmd0aCA9PT0gMjAxKSB7XG4gICAgICAgICAgdGhpcy5sb2dnZXIuZGVidWcoJ0F0dGVtcHRpbmcgQUkgcHJlZGljdGlvbiB3aXRoIHZhbGlkYXRlZCBpbnB1dCcpO1xuICAgICAgICAgIGNvbnN0IGFpUmVzdWx0ID0gYXdhaXQgdGhpcy5nZXRBaUVzdGltYXRlKGZsYXRBbnN3ZXJzKTtcbiAgICAgICAgICBpZiAoYWlSZXN1bHQpIHtcbiAgICAgICAgICAgIGFpRXN0aW1hdGUgPSBhaVJlc3VsdDtcbiAgICAgICAgICAgIHRoaXMubG9nZ2VyLmxvZygnQUkgcHJlZGljdGlvbiBzdWNjZXNzZnVsJyk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMubG9nZ2VyLndhcm4oXG4gICAgICAgICAgICAgICdBSSBwcmVkaWN0aW9uIGZhaWxlZCwgY29udGludWluZyB3aXRob3V0IEFJIGVzdGltYXRlJyxcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHRoaXMubG9nZ2VyLndhcm4oXG4gICAgICAgICAgICBgQ2Fubm90IHBlcmZvcm0gQUkgcHJlZGljdGlvbjogZXhwZWN0ZWQgMjAxIHZhbHVlcywgZ290ICR7ZmxhdEFuc3dlcnMubGVuZ3RofWAsXG4gICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgICAgfSBjYXRjaCAoYWlFcnJvcikge1xuICAgICAgICB0aGlzLmxvZ2dlci5lcnJvcihcbiAgICAgICAgICAnQUkgcHJlZGljdGlvbiBlcnJvciwgY29udGludWluZyB3aXRob3V0IEFJIGVzdGltYXRlOicsXG4gICAgICAgICAgYWlFcnJvcixcbiAgICAgICAgKTtcbiAgICAgICAgLy8gQ29udGludWUgd2l0aG91dCBBSSBlc3RpbWF0ZSAtIGRvbid0IGZhaWwgdGhlIGVudGlyZSBhc3Nlc3NtZW50XG4gICAgICB9XG5cbiAgICAgIC8vIENyZWF0ZSBwcmUtYXNzZXNzbWVudCB3aXRoIHZhbGlkYXRlZCBkYXRhXG4gICAgICBjb25zdCBwcmVBc3Nlc3NtZW50ID0gYXdhaXQgdGhpcy5wcmlzbWEucHJlQXNzZXNzbWVudC5jcmVhdGUoe1xuICAgICAgICBkYXRhOiB7XG4gICAgICAgICAgY2xpZW50SWQ6IHVzZXJJZCxcbiAgICAgICAgICBxdWVzdGlvbm5haXJlczogZGF0YS5xdWVzdGlvbm5haXJlcyBhcyBzdHJpbmdbXSxcbiAgICAgICAgICBhbnN3ZXJzOiBkYXRhLmFuc3dlcnMgYXMgbnVtYmVyW11bXSxcbiAgICAgICAgICBhbnN3ZXJNYXRyaXg6IGRhdGEuYW5zd2VyTWF0cml4IGFzIG51bWJlcltdW10sXG4gICAgICAgICAgc2NvcmVzLFxuICAgICAgICAgIHNldmVyaXR5TGV2ZWxzLFxuICAgICAgICAgIGFpRXN0aW1hdGUsXG4gICAgICAgIH0sXG4gICAgICB9KTtcblxuICAgICAgdGhpcy5sb2dnZXIubG9nKGBQcmUtYXNzZXNzbWVudCBjcmVhdGVkIHN1Y2Nlc3NmdWxseSBmb3IgdXNlciAke3VzZXJJZH1gKTtcbiAgICAgIHJldHVybiBwcmVBc3Nlc3NtZW50O1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBpZiAoXG4gICAgICAgIGVycm9yIGluc3RhbmNlb2YgTm90Rm91bmRFeGNlcHRpb24gfHxcbiAgICAgICAgZXJyb3IgaW5zdGFuY2VvZiBCYWRSZXF1ZXN0RXhjZXB0aW9uXG4gICAgICApIHtcbiAgICAgICAgdGhyb3cgZXJyb3I7XG4gICAgICB9XG5cbiAgICAgIHRoaXMubG9nZ2VyLmVycm9yKFxuICAgICAgICAnRXJyb3IgY3JlYXRpbmcgcHJlLWFzc2Vzc21lbnQ6JyxcbiAgICAgICAgZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiBlcnJvcixcbiAgICAgICk7XG4gICAgICB0aHJvdyBuZXcgSW50ZXJuYWxTZXJ2ZXJFcnJvckV4Y2VwdGlvbignRmFpbGVkIHRvIGNyZWF0ZSBwcmUtYXNzZXNzbWVudCcpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgaGFuZGxlRXJyb3IoZXJyb3I6IHVua25vd24sIG1lc3NhZ2U6IHN0cmluZyk6IG5ldmVyIHtcbiAgICBpZiAoZXJyb3IgaW5zdGFuY2VvZiBOb3RGb3VuZEV4Y2VwdGlvbikge1xuICAgICAgdGhyb3cgZXJyb3I7XG4gICAgfVxuICAgIGlmIChlcnJvciBpbnN0YW5jZW9mIEVycm9yKSB7XG4gICAgICBjb25zb2xlLmVycm9yKG1lc3NhZ2UsIGVycm9yLm1lc3NhZ2UpO1xuICAgICAgdGhyb3cgbmV3IEludGVybmFsU2VydmVyRXJyb3JFeGNlcHRpb24oZXJyb3IubWVzc2FnZSk7XG4gICAgfVxuICAgIGNvbnNvbGUuZXJyb3IobWVzc2FnZSwgZXJyb3IpO1xuICAgIHRocm93IG5ldyBJbnRlcm5hbFNlcnZlckVycm9yRXhjZXB0aW9uKG1lc3NhZ2UpO1xuICB9XG5cbiAgYXN5bmMgZ2V0UHJlQXNzZXNzbWVudEJ5VXNlcklkKHVzZXJJZDogc3RyaW5nKTogUHJvbWlzZTxQcmVBc3Nlc3NtZW50PiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHByZUFzc2Vzc21lbnQgPSBhd2FpdCB0aGlzLnByaXNtYS5wcmVBc3Nlc3NtZW50LmZpbmRVbmlxdWUoe1xuICAgICAgICB3aGVyZTogeyBjbGllbnRJZDogdXNlcklkIH0sXG4gICAgICB9KTtcblxuICAgICAgaWYgKCFwcmVBc3Nlc3NtZW50KSB7XG4gICAgICAgIHRocm93IG5ldyBOb3RGb3VuZEV4Y2VwdGlvbignUHJlLWFzc2Vzc21lbnQgbm90IGZvdW5kJyk7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiBwcmVBc3Nlc3NtZW50O1xuICAgIH0gY2F0Y2ggKGVycm9yOiB1bmtub3duKSB7XG4gICAgICB0aGlzLmhhbmRsZUVycm9yKGVycm9yLCAnRXJyb3IgcmV0cmlldmluZyBwcmUtYXNzZXNzbWVudCcpO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGdldFByZUFzc2Vzc21lbnRCeUNsaWVudElkKGNsaWVudElkOiBzdHJpbmcpOiBQcm9taXNlPFByZUFzc2Vzc21lbnQ+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgcHJlQXNzZXNzbWVudCA9IGF3YWl0IHRoaXMucHJpc21hLnByZUFzc2Vzc21lbnQuZmluZFVuaXF1ZSh7XG4gICAgICAgIHdoZXJlOiB7IGNsaWVudElkOiBjbGllbnRJZCB9LFxuICAgICAgICBpbmNsdWRlOiB7IGNsaWVudDogeyBpbmNsdWRlOiB7IHVzZXI6IHRydWUgfSB9IH0sXG4gICAgICB9KTtcblxuICAgICAgaWYgKCFwcmVBc3Nlc3NtZW50KSB7XG4gICAgICAgIHRocm93IG5ldyBOb3RGb3VuZEV4Y2VwdGlvbignUHJlLWFzc2Vzc21lbnQgbm90IGZvdW5kJyk7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiBwcmVBc3Nlc3NtZW50O1xuICAgIH0gY2F0Y2ggKGVycm9yOiB1bmtub3duKSB7XG4gICAgICB0aGlzLmhhbmRsZUVycm9yKGVycm9yLCAnRXJyb3IgcmV0cmlldmluZyBwcmUtYXNzZXNzbWVudCcpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgaXNWYWxpZFNjb3JlcyhzY29yZXM6IHVua25vd24pOiBzY29yZXMgaXMgUmVjb3JkPHN0cmluZywgbnVtYmVyPiB7XG4gICAgaWYgKHR5cGVvZiBzY29yZXMgIT09ICdvYmplY3QnIHx8IHNjb3JlcyA9PT0gbnVsbCkgcmV0dXJuIGZhbHNlO1xuICAgIHJldHVybiBPYmplY3QuZW50cmllcyhzY29yZXMpLmV2ZXJ5KFxuICAgICAgKFtrZXksIHZhbHVlXSkgPT4gdHlwZW9mIGtleSA9PT0gJ3N0cmluZycgJiYgdHlwZW9mIHZhbHVlID09PSAnbnVtYmVyJyxcbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBpc1ZhbGlkU2V2ZXJpdHlMZXZlbHMoXG4gICAgbGV2ZWxzOiB1bmtub3duLFxuICApOiBsZXZlbHMgaXMgUmVjb3JkPHN0cmluZywgc3RyaW5nPiB7XG4gICAgaWYgKHR5cGVvZiBsZXZlbHMgIT09ICdvYmplY3QnIHx8IGxldmVscyA9PT0gbnVsbCkgcmV0dXJuIGZhbHNlO1xuICAgIHJldHVybiBPYmplY3QuZW50cmllcyhsZXZlbHMpLmV2ZXJ5KFxuICAgICAgKFtrZXksIHZhbHVlXSkgPT4gdHlwZW9mIGtleSA9PT0gJ3N0cmluZycgJiYgdHlwZW9mIHZhbHVlID09PSAnc3RyaW5nJyxcbiAgICApO1xuICB9XG5cbiAgYXN5bmMgdXBkYXRlUHJlQXNzZXNzbWVudChcbiAgICB1c2VySWQ6IHN0cmluZyxcbiAgICBkYXRhOiBQYXJ0aWFsPENyZWF0ZVByZUFzc2Vzc21lbnREdG8+LFxuICApOiBQcm9taXNlPFByZUFzc2Vzc21lbnQ+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgY2xpZW50ID0gYXdhaXQgdGhpcy5wcmlzbWEuY2xpZW50LmZpbmRVbmlxdWUoe1xuICAgICAgICB3aGVyZTogeyB1c2VySWQ6IHVzZXJJZCB9LFxuICAgICAgfSk7XG4gICAgICBpZiAoIWNsaWVudCkge1xuICAgICAgICB0aHJvdyBuZXcgTm90Rm91bmRFeGNlcHRpb24oJ0NsaWVudCBub3QgZm91bmQnKTtcbiAgICAgIH1cblxuICAgICAgbGV0IHNjb3JlczogUmVjb3JkPHN0cmluZywgbnVtYmVyPjtcbiAgICAgIGxldCBzZXZlcml0eUxldmVsczogUmVjb3JkPHN0cmluZywgc3RyaW5nPjtcblxuICAgICAgaWYgKGRhdGEuc2NvcmVzICYmIHRoaXMuaXNWYWxpZFNjb3JlcyhkYXRhLnNjb3JlcykpIHtcbiAgICAgICAgc2NvcmVzID0gZGF0YS5zY29yZXM7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBzY29yZXMgPSB7fTtcbiAgICAgIH1cblxuICAgICAgaWYgKFxuICAgICAgICBkYXRhLnNldmVyaXR5TGV2ZWxzICYmXG4gICAgICAgIHRoaXMuaXNWYWxpZFNldmVyaXR5TGV2ZWxzKGRhdGEuc2V2ZXJpdHlMZXZlbHMpXG4gICAgICApIHtcbiAgICAgICAgc2V2ZXJpdHlMZXZlbHMgPSBkYXRhLnNldmVyaXR5TGV2ZWxzO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgc2V2ZXJpdHlMZXZlbHMgPSB7fTtcbiAgICAgIH1cblxuICAgICAgaWYgKFxuICAgICAgICBkYXRhLnF1ZXN0aW9ubmFpcmVzICYmXG4gICAgICAgIGRhdGEuYW5zd2VycyAmJlxuICAgICAgICAoIWRhdGEuc2NvcmVzIHx8ICFkYXRhLnNldmVyaXR5TGV2ZWxzKVxuICAgICAgKSB7XG4gICAgICAgIGNvbnN0IGNhbGN1bGF0ZWRTY29yZXMgPSBjYWxjdWxhdGVBbGxTY29yZXMoXG4gICAgICAgICAgZGF0YS5xdWVzdGlvbm5haXJlcyxcbiAgICAgICAgICBkYXRhLmFuc3dlcnMsXG4gICAgICAgICk7XG4gICAgICAgIHNjb3JlcyA9IE9iamVjdC5mcm9tRW50cmllcyhcbiAgICAgICAgICBPYmplY3QuZW50cmllcyhjYWxjdWxhdGVkU2NvcmVzKS5tYXAoKFtrZXksIHZhbHVlXSkgPT4gW1xuICAgICAgICAgICAga2V5LFxuICAgICAgICAgICAgdmFsdWUuc2NvcmUsXG4gICAgICAgICAgXSksXG4gICAgICAgICk7XG4gICAgICAgIHNldmVyaXR5TGV2ZWxzID0gZ2VuZXJhdGVTZXZlcml0eUxldmVscyhjYWxjdWxhdGVkU2NvcmVzKTtcbiAgICAgIH1cblxuICAgICAgY29uc3QgcHJlQXNzZXNzbWVudCA9IGF3YWl0IHRoaXMucHJpc21hLnByZUFzc2Vzc21lbnQudXBkYXRlKHtcbiAgICAgICAgd2hlcmU6IHsgY2xpZW50SWQ6IHVzZXJJZCB9LFxuICAgICAgICBkYXRhOiB7XG4gICAgICAgICAgcXVlc3Rpb25uYWlyZXM6IGRhdGEucXVlc3Rpb25uYWlyZXMgYXMgc3RyaW5nW10sXG4gICAgICAgICAgYW5zd2VyczogZGF0YS5hbnN3ZXJzIGFzIG51bWJlcltdW10sXG4gICAgICAgICAgYW5zd2VyTWF0cml4OiBkYXRhLmFuc3dlck1hdHJpeCBhcyBudW1iZXJbXVtdLFxuICAgICAgICAgIHNjb3JlcyxcbiAgICAgICAgICBzZXZlcml0eUxldmVscyxcbiAgICAgICAgfSxcbiAgICAgIH0pO1xuXG4gICAgICBpZiAoIXByZUFzc2Vzc21lbnQpIHtcbiAgICAgICAgdGhyb3cgbmV3IE5vdEZvdW5kRXhjZXB0aW9uKCdQcmUtYXNzZXNzbWVudCBub3QgZm91bmQnKTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHByZUFzc2Vzc21lbnQ7XG4gICAgfSBjYXRjaCAoZXJyb3I6IHVua25vd24pIHtcbiAgICAgIHRoaXMuaGFuZGxlRXJyb3IoZXJyb3IsICdFcnJvciB1cGRhdGluZyBwcmUtYXNzZXNzbWVudCcpO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGRlbGV0ZVByZUFzc2Vzc21lbnQodXNlcklkOiBzdHJpbmcpOiBQcm9taXNlPG51bGw+IHtcbiAgICB0cnkge1xuICAgICAgYXdhaXQgdGhpcy5wcmlzbWEucHJlQXNzZXNzbWVudC5kZWxldGUoe1xuICAgICAgICB3aGVyZTogeyBjbGllbnRJZDogdXNlcklkIH0sXG4gICAgICB9KTtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH0gY2F0Y2ggKGVycm9yOiB1bmtub3duKSB7XG4gICAgICB0aGlzLmhhbmRsZUVycm9yKGVycm9yLCAnRXJyb3IgZGVsZXRpbmcgcHJlLWFzc2Vzc21lbnQnKTtcbiAgICB9XG4gIH1cbn1cbiJdLCJ2ZXJzaW9uIjozfQ==