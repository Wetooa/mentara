56bedd57926ce3c5a4432d55c16037dc
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var _a, _b;
Object.defineProperty(exports, "__esModule", { value: true });
exports.UsersService = void 0;
const common_1 = require("@nestjs/common");
const prisma_client_provider_1 = require("src/providers/prisma-client.provider");
const event_bus_service_1 = require("../common/events/event-bus.service");
const user_events_1 = require("../common/events/user-events");
let UsersService = class UsersService {
    prisma;
    eventBus;
    constructor(prisma, eventBus) {
        this.prisma = prisma;
        this.eventBus = eventBus;
    }
    async findById(id) {
        return await this.prisma.user.findUnique({
            where: {
                id,
                isActive: true, // Only return active users by default
            },
        });
    }
    async findByIdIncludeInactive(id) {
        // For administrative purposes - can see inactive users
        return await this.prisma.user.findUnique({
            where: { id },
        });
    }
    async findAll() {
        try {
            return await this.prisma.user.findMany({
                where: { isActive: true },
            });
        }
        catch (error) {
            throw new common_1.InternalServerErrorException(error instanceof Error ? error.message : String(error));
        }
    }
    async findOne(id) {
        try {
            return await this.prisma.user.findUnique({
                where: {
                    id,
                    isActive: true, // Only return active users
                },
                include: { therapist: true },
            });
        }
        catch (error) {
            throw new common_1.InternalServerErrorException(error instanceof Error ? error.message : String(error));
        }
    }
    async findOneIncludeInactive(id) {
        // For administrative purposes
        try {
            return await this.prisma.user.findUnique({
                where: { id },
                include: {
                    therapist: true,
                    client: true,
                    admin: true,
                    moderator: true,
                },
            });
        }
        catch (error) {
            throw new common_1.InternalServerErrorException(error instanceof Error ? error.message : String(error));
        }
    }
    async findByRole(role) {
        return await this.prisma.user.findMany({
            where: {
                role,
                isActive: true, // Only return active users
            },
        });
    }
    async findAllIncludeInactive() {
        // For administrative purposes - include inactive users
        try {
            return await this.prisma.user.findMany({
                orderBy: { createdAt: 'desc' },
            });
        }
        catch (error) {
            throw new common_1.InternalServerErrorException(error instanceof Error ? error.message : String(error));
        }
    }
    async update(id, data) {
        try {
            // Get previous values for audit trail
            const previousUser = await this.findById(id);
            if (!previousUser) {
                throw new common_1.InternalServerErrorException('User not found');
            }
            const updatedUser = await this.prisma.user.update({
                where: { id },
                data,
            });
            // Publish profile updated event
            await this.eventBus.emit(new user_events_1.UserProfileUpdatedEvent({
                userId: id,
                updatedFields: Object.keys(data),
                previousValues: this.extractUserFields(previousUser),
                newValues: this.extractUserFields(updatedUser),
            }));
            return updatedUser;
        }
        catch (error) {
            throw new common_1.InternalServerErrorException(`Failed to update user: ${error instanceof Error ? error.message : String(error)}`);
        }
    }
    async remove(id) {
        try {
            // Implement soft delete for HIPAA compliance
            const deactivatedUser = await this.prisma.user.update({
                where: { id },
                data: {
                    isActive: false,
                    suspendedAt: new Date(),
                    suspensionReason: 'Account deactivated by user',
                    // Keep all data intact for compliance
                },
            });
            // Publish user deactivation event
            await this.eventBus.emit(new user_events_1.UserDeactivatedEvent({
                userId: id,
                reason: 'Account deactivated by user',
                deactivatedBy: id, // Self-deactivation
                isTemporary: false,
            }));
            return deactivatedUser;
        }
        catch (error) {
            throw new common_1.InternalServerErrorException(`Failed to deactivate user: ${error instanceof Error ? error.message : String(error)}`);
        }
    }
    async deactivate(id, reason, deactivatedBy) {
        try {
            // Administrative deactivation with audit trail
            const deactivatedUser = await this.prisma.user.update({
                where: { id },
                data: {
                    isActive: false,
                    suspendedAt: new Date(),
                    suspendedBy: deactivatedBy,
                    suspensionReason: reason || 'Account deactivated by administrator',
                },
            });
            // Publish user deactivation event
            await this.eventBus.emit(new user_events_1.UserDeactivatedEvent({
                userId: id,
                reason: reason || 'Account deactivated by administrator',
                deactivatedBy: deactivatedBy || 'system',
                isTemporary: true, // Administrative deactivations are typically temporary
            }));
            return deactivatedUser;
        }
        catch (error) {
            throw new common_1.InternalServerErrorException(`Failed to deactivate user: ${error instanceof Error ? error.message : String(error)}`);
        }
    }
    async reactivate(id, reactivatedBy) {
        try {
            // Get user info for calculating inactive duration
            const user = await this.findByIdIncludeInactive(id);
            if (!user) {
                throw new common_1.InternalServerErrorException('User not found');
            }
            const inactiveDuration = user.suspendedAt
                ? Math.floor((Date.now() - user.suspendedAt.getTime()) / (1000 * 60 * 60 * 24))
                : 0;
            const reactivatedUser = await this.prisma.user.update({
                where: { id },
                data: {
                    isActive: true,
                    suspendedAt: null,
                    suspendedBy: null,
                    suspensionReason: null,
                },
            });
            // Publish user reactivation event
            await this.eventBus.emit(new user_events_1.UserReactivatedEvent({
                userId: id,
                reactivatedBy: reactivatedBy || 'system',
                inactiveDuration,
            }));
            return reactivatedUser;
        }
        catch (error) {
            throw new common_1.InternalServerErrorException(`Failed to reactivate user: ${error instanceof Error ? error.message : String(error)}`);
        }
    }
    async permanentDelete(id) {
        // Only for extreme cases with proper authorization
        // This should only be called by super admins after proper data retention period
        return await this.prisma.user.delete({
            where: { id },
        });
    }
    async getUserRole(id) {
        const user = await this.prisma.user.findUnique({
            where: { id },
            select: { role: true },
        });
        return user?.role || null;
    }
    // Add a user creation method that publishes events
    async create(data) {
        try {
            const newUser = await this.prisma.user.create({
                data,
            });
            // Publish user registration event
            await this.eventBus.emit(new user_events_1.UserRegisteredEvent({
                userId: newUser.id,
                email: newUser.email,
                firstName: newUser.firstName,
                lastName: newUser.lastName,
                role: newUser.role,
                registrationMethod: 'email', // Default, can be enhanced later
            }));
            return newUser;
        }
        catch (error) {
            throw new common_1.InternalServerErrorException(`Failed to create user: ${error instanceof Error ? error.message : String(error)}`);
        }
    }
    // Helper method to extract relevant user fields for events
    extractUserFields(user) {
        return {
            id: user.id,
            email: user.email,
            firstName: user.firstName,
            lastName: user.lastName,
            middleName: user.middleName,
            role: user.role,
            isActive: user.isActive,
            avatarUrl: user.avatarUrl,
            birthDate: user.birthDate,
            address: user.address,
            // Remove unsupported properties - these don't exist in User model
            createdAt: user.createdAt,
            updatedAt: user.updatedAt,
        };
    }
};
exports.UsersService = UsersService;
exports.UsersService = UsersService = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [typeof (_a = typeof prisma_client_provider_1.PrismaService !== "undefined" && prisma_client_provider_1.PrismaService) === "function" ? _a : Object, typeof (_b = typeof event_bus_service_1.EventBusService !== "undefined" && event_bus_service_1.EventBusService) === "function" ? _b : Object])
], UsersService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL3VzZXJzL3VzZXJzLnNlcnZpY2UudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7OztBQUFBLDJDQUEwRTtBQUMxRSxpRkFBcUU7QUFHckUsMEVBQXFFO0FBQ3JFLDhEQUtzQztBQUcvQixJQUFNLFlBQVksR0FBbEIsTUFBTSxZQUFZO0lBRWI7SUFDQTtJQUZWLFlBQ1UsTUFBcUIsRUFDckIsUUFBeUI7UUFEekIsV0FBTSxHQUFOLE1BQU0sQ0FBZTtRQUNyQixhQUFRLEdBQVIsUUFBUSxDQUFpQjtJQUNoQyxDQUFDO0lBRUosS0FBSyxDQUFDLFFBQVEsQ0FBQyxFQUFVO1FBQ3ZCLE9BQU8sTUFBTSxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUM7WUFDdkMsS0FBSyxFQUFFO2dCQUNMLEVBQUU7Z0JBQ0YsUUFBUSxFQUFFLElBQUksRUFBRSxzQ0FBc0M7YUFDdkQ7U0FDRixDQUFDLENBQUM7SUFDTCxDQUFDO0lBRUQsS0FBSyxDQUFDLHVCQUF1QixDQUFDLEVBQVU7UUFDdEMsdURBQXVEO1FBQ3ZELE9BQU8sTUFBTSxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUM7WUFDdkMsS0FBSyxFQUFFLEVBQUUsRUFBRSxFQUFFO1NBQ2QsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVELEtBQUssQ0FBQyxPQUFPO1FBQ1gsSUFBSSxDQUFDO1lBQ0gsT0FBTyxNQUFNLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQztnQkFDckMsS0FBSyxFQUFFLEVBQUUsUUFBUSxFQUFFLElBQUksRUFBRTthQUMxQixDQUFDLENBQUM7UUFDTCxDQUFDO1FBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztZQUNmLE1BQU0sSUFBSSxxQ0FBNEIsQ0FDcEMsS0FBSyxZQUFZLEtBQUssQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxD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QWtTeEIiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL3VzZXJzL3VzZXJzLnNlcnZpY2UudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSwgSW50ZXJuYWxTZXJ2ZXJFcnJvckV4Y2VwdGlvbiB9IGZyb20gJ0BuZXN0anMvY29tbW9uJztcbmltcG9ydCB7IFByaXNtYVNlcnZpY2UgfSBmcm9tICdzcmMvcHJvdmlkZXJzL3ByaXNtYS1jbGllbnQucHJvdmlkZXInO1xuaW1wb3J0IHsgVXNlciwgUHJpc21hIH0gZnJvbSAnQHByaXNtYS9jbGllbnQnO1xuaW1wb3J0IHsgVXNlclJvbGUgfSBmcm9tICdzcmMvdXRpbHMvcm9sZS11dGlscyc7XG5pbXBvcnQgeyBFdmVudEJ1c1NlcnZpY2UgfSBmcm9tICcuLi9jb21tb24vZXZlbnRzL2V2ZW50LWJ1cy5zZXJ2aWNlJztcbmltcG9ydCB7XG4gIFVzZXJSZWdpc3RlcmVkRXZlbnQsXG4gIFVzZXJQcm9maWxlVXBkYXRlZEV2ZW50LFxuICBVc2VyRGVhY3RpdmF0ZWRFdmVudCxcbiAgVXNlclJlYWN0aXZhdGVkRXZlbnQsXG59IGZyb20gJy4uL2NvbW1vbi9ldmVudHMvdXNlci1ldmVudHMnO1xuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgVXNlcnNTZXJ2aWNlIHtcbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBwcmlzbWE6IFByaXNtYVNlcnZpY2UsXG4gICAgcHJpdmF0ZSBldmVudEJ1czogRXZlbnRCdXNTZXJ2aWNlLFxuICApIHt9XG5cbiAgYXN5bmMgZmluZEJ5SWQoaWQ6IHN0cmluZyk6IFByb21pc2U8VXNlciB8IG51bGw+IHtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5wcmlzbWEudXNlci5maW5kVW5pcXVlKHtcbiAgICAgIHdoZXJlOiB7XG4gICAgICAgIGlkLFxuICAgICAgICBpc0FjdGl2ZTogdHJ1ZSwgLy8gT25seSByZXR1cm4gYWN0aXZlIHVzZXJzIGJ5IGRlZmF1bHRcbiAgICAgIH0sXG4gICAgfSk7XG4gIH1cblxuICBhc3luYyBmaW5kQnlJZEluY2x1ZGVJbmFjdGl2ZShpZDogc3RyaW5nKTogUHJvbWlzZTxVc2VyIHwgbnVsbD4ge1xuICAgIC8vIEZvciBhZG1pbmlzdHJhdGl2ZSBwdXJwb3NlcyAtIGNhbiBzZWUgaW5hY3RpdmUgdXNlcnNcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5wcmlzbWEudXNlci5maW5kVW5pcXVlKHtcbiAgICAgIHdoZXJlOiB7IGlkIH0sXG4gICAgfSk7XG4gIH1cblxuICBhc3luYyBmaW5kQWxsKCk6IFByb21pc2U8VXNlcltdPiB7XG4gICAgdHJ5IHtcbiAgICAgIHJldHVybiBhd2FpdCB0aGlzLnByaXNtYS51c2VyLmZpbmRNYW55KHtcbiAgICAgICAgd2hlcmU6IHsgaXNBY3RpdmU6IHRydWUgfSxcbiAgICAgIH0pO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aHJvdyBuZXcgSW50ZXJuYWxTZXJ2ZXJFcnJvckV4Y2VwdGlvbihcbiAgICAgICAgZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiBTdHJpbmcoZXJyb3IpLFxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBmaW5kT25lKGlkOiBzdHJpbmcpOiBQcm9taXNlPFVzZXIgfCBudWxsPiB7XG4gICAgdHJ5IHtcbiAgICAgIHJldHVybiBhd2FpdCB0aGlzLnByaXNtYS51c2VyLmZpbmRVbmlxdWUoe1xuICAgICAgICB3aGVyZToge1xuICAgICAgICAgIGlkLFxuICAgICAgICAgIGlzQWN0aXZlOiB0cnVlLCAvLyBPbmx5IHJldHVybiBhY3RpdmUgdXNlcnNcbiAgICAgICAgfSxcbiAgICAgICAgaW5jbHVkZTogeyB0aGVyYXBpc3Q6IHRydWUgfSxcbiAgICAgIH0pO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aHJvdyBuZXcgSW50ZXJuYWxTZXJ2ZXJFcnJvckV4Y2VwdGlvbihcbiAgICAgICAgZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiBTdHJpbmcoZXJyb3IpLFxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBmaW5kT25lSW5jbHVkZUluYWN0aXZlKGlkOiBzdHJpbmcpOiBQcm9taXNlPFVzZXIgfCBudWxsPiB7XG4gICAgLy8gRm9yIGFkbWluaXN0cmF0aXZlIHB1cnBvc2VzXG4gICAgdHJ5IHtcbiAgICAgIHJldHVybiBhd2FpdCB0aGlzLnByaXNtYS51c2VyLmZpbmRVbmlxdWUoe1xuICAgICAgICB3aGVyZTogeyBpZCB9LFxuICAgICAgICBpbmNsdWRlOiB7XG4gICAgICAgICAgdGhlcmFwaXN0OiB0cnVlLFxuICAgICAgICAgIGNsaWVudDogdHJ1ZSxcbiAgICAgICAgICBhZG1pbjogdHJ1ZSxcbiAgICAgICAgICBtb2RlcmF0b3I6IHRydWUsXG4gICAgICAgIH0sXG4gICAgICB9KTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhyb3cgbmV3IEludGVybmFsU2VydmVyRXJyb3JFeGNlcHRpb24oXG4gICAgICAgIGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogU3RyaW5nKGVycm9yKSxcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgZmluZEJ5Um9sZShyb2xlOiBzdHJpbmcpOiBQcm9taXNlPFVzZXJbXT4ge1xuICAgIHJldHVybiBhd2FpdCB0aGlzLnByaXNtYS51c2VyLmZpbmRNYW55KHtcbiAgICAgIHdoZXJlOiB7XG4gICAgICAgIHJvbGUsXG4gICAgICAgIGlzQWN0aXZlOiB0cnVlLCAvLyBPbmx5IHJldHVybiBhY3RpdmUgdXNlcnNcbiAgICAgIH0sXG4gICAgfSk7XG4gIH1cblxuICBhc3luYyBmaW5kQWxsSW5jbHVkZUluYWN0aXZlKCk6IFByb21pc2U8VXNlcltdPiB7XG4gICAgLy8gRm9yIGFkbWluaXN0cmF0aXZlIHB1cnBvc2VzIC0gaW5jbHVkZSBpbmFjdGl2ZSB1c2Vyc1xuICAgIHRyeSB7XG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy5wcmlzbWEudXNlci5maW5kTWFueSh7XG4gICAgICAgIG9yZGVyQnk6IHsgY3JlYXRlZEF0OiAnZGVzYycgfSxcbiAgICAgIH0pO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aHJvdyBuZXcgSW50ZXJuYWxTZXJ2ZXJFcnJvckV4Y2VwdGlvbihcbiAgICAgICAgZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiBTdHJpbmcoZXJyb3IpLFxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICBhc3luYyB1cGRhdGUoaWQ6IHN0cmluZywgZGF0YTogUHJpc21hLlVzZXJVcGRhdGVJbnB1dCk6IFByb21pc2U8VXNlcj4ge1xuICAgIHRyeSB7XG4gICAgICAvLyBHZXQgcHJldmlvdXMgdmFsdWVzIGZvciBhdWRpdCB0cmFpbFxuICAgICAgY29uc3QgcHJldmlvdXNVc2VyID0gYXdhaXQgdGhpcy5maW5kQnlJZChpZCk7XG4gICAgICBpZiAoIXByZXZpb3VzVXNlcikge1xuICAgICAgICB0aHJvdyBuZXcgSW50ZXJuYWxTZXJ2ZXJFcnJvckV4Y2VwdGlvbignVXNlciBub3QgZm91bmQnKTtcbiAgICAgIH1cblxuICAgICAgY29uc3QgdXBkYXRlZFVzZXIgPSBhd2FpdCB0aGlzLnByaXNtYS51c2VyLnVwZGF0ZSh7XG4gICAgICAgIHdoZXJlOiB7IGlkIH0sXG4gICAgICAgIGRhdGEsXG4gICAgICB9KTtcblxuICAgICAgLy8gUHVibGlzaCBwcm9maWxlIHVwZGF0ZWQgZXZlbnRcbiAgICAgIGF3YWl0IHRoaXMuZXZlbnRCdXMuZW1pdChcbiAgICAgICAgbmV3IFVzZXJQcm9maWxlVXBkYXRlZEV2ZW50KHtcbiAgICAgICAgICB1c2VySWQ6IGlkLFxuICAgICAgICAgIHVwZGF0ZWRGaWVsZHM6IE9iamVjdC5rZXlzKGRhdGEpLFxuICAgICAgICAgIHByZXZpb3VzVmFsdWVzOiB0aGlzLmV4dHJhY3RVc2VyRmllbGRzKHByZXZpb3VzVXNlciksXG4gICAgICAgICAgbmV3VmFsdWVzOiB0aGlzLmV4dHJhY3RVc2VyRmllbGRzKHVwZGF0ZWRVc2VyKSxcbiAgICAgICAgfSksXG4gICAgICApO1xuXG4gICAgICByZXR1cm4gdXBkYXRlZFVzZXI7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRocm93IG5ldyBJbnRlcm5hbFNlcnZlckVycm9yRXhjZXB0aW9uKFxuICAgICAgICBgRmFpbGVkIHRvIHVwZGF0ZSB1c2VyOiAke2Vycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogU3RyaW5nKGVycm9yKX1gLFxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICBhc3luYyByZW1vdmUoaWQ6IHN0cmluZyk6IFByb21pc2U8VXNlcj4ge1xuICAgIHRyeSB7XG4gICAgICAvLyBJbXBsZW1lbnQgc29mdCBkZWxldGUgZm9yIEhJUEFBIGNvbXBsaWFuY2VcbiAgICAgIGNvbnN0IGRlYWN0aXZhdGVkVXNlciA9IGF3YWl0IHRoaXMucHJpc21hLnVzZXIudXBkYXRlKHtcbiAgICAgICAgd2hlcmU6IHsgaWQgfSxcbiAgICAgICAgZGF0YToge1xuICAgICAgICAgIGlzQWN0aXZlOiBmYWxzZSxcbiAgICAgICAgICBzdXNwZW5kZWRBdDogbmV3IERhdGUoKSxcbiAgICAgICAgICBzdXNwZW5zaW9uUmVhc29uOiAnQWNjb3VudCBkZWFjdGl2YXRlZCBieSB1c2VyJyxcbiAgICAgICAgICAvLyBLZWVwIGFsbCBkYXRhIGludGFjdCBmb3IgY29tcGxpYW5jZVxuICAgICAgICB9LFxuICAgICAgfSk7XG5cbiAgICAgIC8vIFB1Ymxpc2ggdXNlciBkZWFjdGl2YXRpb24gZXZlbnRcbiAgICAgIGF3YWl0IHRoaXMuZXZlbnRCdXMuZW1pdChcbiAgICAgICAgbmV3IFVzZXJEZWFjdGl2YXRlZEV2ZW50KHtcbiAgICAgICAgICB1c2VySWQ6IGlkLFxuICAgICAgICAgIHJlYXNvbjogJ0FjY291bnQgZGVhY3RpdmF0ZWQgYnkgdXNlcicsXG4gICAgICAgICAgZGVhY3RpdmF0ZWRCeTogaWQsIC8vIFNlbGYtZGVhY3RpdmF0aW9uXG4gICAgICAgICAgaXNUZW1wb3Jhcnk6IGZhbHNlLFxuICAgICAgICB9KSxcbiAgICAgICk7XG5cbiAgICAgIHJldHVybiBkZWFjdGl2YXRlZFVzZXI7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRocm93IG5ldyBJbnRlcm5hbFNlcnZlckVycm9yRXhjZXB0aW9uKFxuICAgICAgICBgRmFpbGVkIHRvIGRlYWN0aXZhdGUgdXNlcjogJHtlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6IFN0cmluZyhlcnJvcil9YCxcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgZGVhY3RpdmF0ZShcbiAgICBpZDogc3RyaW5nLFxuICAgIHJlYXNvbj86IHN0cmluZyxcbiAgICBkZWFjdGl2YXRlZEJ5Pzogc3RyaW5nLFxuICApOiBQcm9taXNlPFVzZXI+IHtcbiAgICB0cnkge1xuICAgICAgLy8gQWRtaW5pc3RyYXRpdmUgZGVhY3RpdmF0aW9uIHdpdGggYXVkaXQgdHJhaWxcbiAgICAgIGNvbnN0IGRlYWN0aXZhdGVkVXNlciA9IGF3YWl0IHRoaXMucHJpc21hLnVzZXIudXBkYXRlKHtcbiAgICAgICAgd2hlcmU6IHsgaWQgfSxcbiAgICAgICAgZGF0YToge1xuICAgICAgICAgIGlzQWN0aXZlOiBmYWxzZSxcbiAgICAgICAgICBzdXNwZW5kZWRBdDogbmV3IERhdGUoKSxcbiAgICAgICAgICBzdXNwZW5kZWRCeTogZGVhY3RpdmF0ZWRCeSxcbiAgICAgICAgICBzdXNwZW5zaW9uUmVhc29uOiByZWFzb24gfHwgJ0FjY291bnQgZGVhY3RpdmF0ZWQgYnkgYWRtaW5pc3RyYXRvcicsXG4gICAgICAgIH0sXG4gICAgICB9KTtcblxuICAgICAgLy8gUHVibGlzaCB1c2VyIGRlYWN0aXZhdGlvbiBldmVudFxuICAgICAgYXdhaXQgdGhpcy5ldmVudEJ1cy5lbWl0KFxuICAgICAgICBuZXcgVXNlckRlYWN0aXZhdGVkRXZlbnQoe1xuICAgICAgICAgIHVzZXJJZDogaWQsXG4gICAgICAgICAgcmVhc29uOiByZWFzb24gfHwgJ0FjY291bnQgZGVhY3RpdmF0ZWQgYnkgYWRtaW5pc3RyYXRvcicsXG4gICAgICAgICAgZGVhY3RpdmF0ZWRCeTogZGVhY3RpdmF0ZWRCeSB8fCAnc3lzdGVtJyxcbiAgICAgICAgICBpc1RlbXBvcmFyeTogdHJ1ZSwgLy8gQWRtaW5pc3RyYXRpdmUgZGVhY3RpdmF0aW9ucyBhcmUgdHlwaWNhbGx5IHRlbXBvcmFyeVxuICAgICAgICB9KSxcbiAgICAgICk7XG5cbiAgICAgIHJldHVybiBkZWFjdGl2YXRlZFVzZXI7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRocm93IG5ldyBJbnRlcm5hbFNlcnZlckVycm9yRXhjZXB0aW9uKFxuICAgICAgICBgRmFpbGVkIHRvIGRlYWN0aXZhdGUgdXNlcjogJHtlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6IFN0cmluZyhlcnJvcil9YCxcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgcmVhY3RpdmF0ZShpZDogc3RyaW5nLCByZWFjdGl2YXRlZEJ5Pzogc3RyaW5nKTogUHJvbWlzZTxVc2VyPiB7XG4gICAgdHJ5IHtcbiAgICAgIC8vIEdldCB1c2VyIGluZm8gZm9yIGNhbGN1bGF0aW5nIGluYWN0aXZlIGR1cmF0aW9uXG4gICAgICBjb25zdCB1c2VyID0gYXdhaXQgdGhpcy5maW5kQnlJZEluY2x1ZGVJbmFjdGl2ZShpZCk7XG4gICAgICBpZiAoIXVzZXIpIHtcbiAgICAgICAgdGhyb3cgbmV3IEludGVybmFsU2VydmVyRXJyb3JFeGNlcHRpb24oJ1VzZXIgbm90IGZvdW5kJyk7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IGluYWN0aXZlRHVyYXRpb24gPSB1c2VyLnN1c3BlbmRlZEF0XG4gICAgICAgID8gTWF0aC5mbG9vcihcbiAgICAgICAgICAgIChEYXRlLm5vdygpIC0gdXNlci5zdXNwZW5kZWRBdC5nZXRUaW1lKCkpIC8gKDEwMDAgKiA2MCAqIDYwICogMjQpLFxuICAgICAgICAgIClcbiAgICAgICAgOiAwO1xuXG4gICAgICBjb25zdCByZWFjdGl2YXRlZFVzZXIgPSBhd2FpdCB0aGlzLnByaXNtYS51c2VyLnVwZGF0ZSh7XG4gICAgICAgIHdoZXJlOiB7IGlkIH0sXG4gICAgICAgIGRhdGE6IHtcbiAgICAgICAgICBpc0FjdGl2ZTogdHJ1ZSxcbiAgICAgICAgICBzdXNwZW5kZWRBdDogbnVsbCxcbiAgICAgICAgICBzdXNwZW5kZWRCeTogbnVsbCxcbiAgICAgICAgICBzdXNwZW5zaW9uUmVhc29uOiBudWxsLFxuICAgICAgICB9LFxuICAgICAgfSk7XG5cbiAgICAgIC8vIFB1Ymxpc2ggdXNlciByZWFjdGl2YXRpb24gZXZlbnRcbiAgICAgIGF3YWl0IHRoaXMuZXZlbnRCdXMuZW1pdChcbiAgICAgICAgbmV3IFVzZXJSZWFjdGl2YXRlZEV2ZW50KHtcbiAgICAgICAgICB1c2VySWQ6IGlkLFxuICAgICAgICAgIHJlYWN0aXZhdGVkQnk6IHJlYWN0aXZhdGVkQnkgfHwgJ3N5c3RlbScsXG4gICAgICAgICAgaW5hY3RpdmVEdXJhdGlvbixcbiAgICAgICAgfSksXG4gICAgICApO1xuXG4gICAgICByZXR1cm4gcmVhY3RpdmF0ZWRVc2VyO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aHJvdyBuZXcgSW50ZXJuYWxTZXJ2ZXJFcnJvckV4Y2VwdGlvbihcbiAgICAgICAgYEZhaWxlZCB0byByZWFjdGl2YXRlIHVzZXI6ICR7ZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiBTdHJpbmcoZXJyb3IpfWAsXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIHBlcm1hbmVudERlbGV0ZShpZDogc3RyaW5nKTogUHJvbWlzZTxVc2VyPiB7XG4gICAgLy8gT25seSBmb3IgZXh0cmVtZSBjYXNlcyB3aXRoIHByb3BlciBhdXRob3JpemF0aW9uXG4gICAgLy8gVGhpcyBzaG91bGQgb25seSBiZSBjYWxsZWQgYnkgc3VwZXIgYWRtaW5zIGFmdGVyIHByb3BlciBkYXRhIHJldGVudGlvbiBwZXJpb2RcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5wcmlzbWEudXNlci5kZWxldGUoe1xuICAgICAgd2hlcmU6IHsgaWQgfSxcbiAgICB9KTtcbiAgfVxuXG4gIGFzeW5jIGdldFVzZXJSb2xlKGlkOiBzdHJpbmcpOiBQcm9taXNlPFVzZXJSb2xlIHwgbnVsbD4ge1xuICAgIGNvbnN0IHVzZXIgPSBhd2FpdCB0aGlzLnByaXNtYS51c2VyLmZpbmRVbmlxdWUoe1xuICAgICAgd2hlcmU6IHsgaWQgfSxcbiAgICAgIHNlbGVjdDogeyByb2xlOiB0cnVlIH0sXG4gICAgfSk7XG4gICAgcmV0dXJuICh1c2VyPy5yb2xlIGFzIFVzZXJSb2xlKSB8fCBudWxsO1xuICB9XG5cbiAgLy8gQWRkIGEgdXNlciBjcmVhdGlvbiBtZXRob2QgdGhhdCBwdWJsaXNoZXMgZXZlbnRzXG4gIGFzeW5jIGNyZWF0ZShkYXRhOiBQcmlzbWEuVXNlckNyZWF0ZUlucHV0KTogUHJvbWlzZTxVc2VyPiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IG5ld1VzZXIgPSBhd2FpdCB0aGlzLnByaXNtYS51c2VyLmNyZWF0ZSh7XG4gICAgICAgIGRhdGEsXG4gICAgICB9KTtcblxuICAgICAgLy8gUHVibGlzaCB1c2VyIHJlZ2lzdHJhdGlvbiBldmVudFxuICAgICAgYXdhaXQgdGhpcy5ldmVudEJ1cy5lbWl0KFxuICAgICAgICBuZXcgVXNlclJlZ2lzdGVyZWRFdmVudCh7XG4gICAgICAgICAgdXNlcklkOiBuZXdVc2VyLmlkLFxuICAgICAgICAgIGVtYWlsOiBuZXdVc2VyLmVtYWlsLFxuICAgICAgICAgIGZpcnN0TmFtZTogbmV3VXNlci5maXJzdE5hbWUsXG4gICAgICAgICAgbGFzdE5hbWU6IG5ld1VzZXIubGFzdE5hbWUsXG4gICAgICAgICAgcm9sZTogbmV3VXNlci5yb2xlIGFzICdjbGllbnQnIHwgJ3RoZXJhcGlzdCcgfCAnbW9kZXJhdG9yJyB8ICdhZG1pbicsXG4gICAgICAgICAgcmVnaXN0cmF0aW9uTWV0aG9kOiAnZW1haWwnLCAvLyBEZWZhdWx0LCBjYW4gYmUgZW5oYW5jZWQgbGF0ZXJcbiAgICAgICAgfSksXG4gICAgICApO1xuXG4gICAgICByZXR1cm4gbmV3VXNlcjtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhyb3cgbmV3IEludGVybmFsU2VydmVyRXJyb3JFeGNlcHRpb24oXG4gICAgICAgIGBGYWlsZWQgdG8gY3JlYXRlIHVzZXI6ICR7ZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiBTdHJpbmcoZXJyb3IpfWAsXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIC8vIEhlbHBlciBtZXRob2QgdG8gZXh0cmFjdCByZWxldmFudCB1c2VyIGZpZWxkcyBmb3IgZXZlbnRzXG4gIHByaXZhdGUgZXh0cmFjdFVzZXJGaWVsZHModXNlcjogVXNlcik6IFJlY29yZDxzdHJpbmcsIGFueT4ge1xuICAgIHJldHVybiB7XG4gICAgICBpZDogdXNlci5pZCxcbiAgICAgIGVtYWlsOiB1c2VyLmVtYWlsLFxuICAgICAgZmlyc3ROYW1lOiB1c2VyLmZpcnN0TmFtZSxcbiAgICAgIGxhc3ROYW1lOiB1c2VyLmxhc3ROYW1lLFxuICAgICAgbWlkZGxlTmFtZTogdXNlci5taWRkbGVOYW1lLFxuICAgICAgcm9sZTogdXNlci5yb2xlLFxuICAgICAgaXNBY3RpdmU6IHVzZXIuaXNBY3RpdmUsXG4gICAgICBhdmF0YXJVcmw6IHVzZXIuYXZhdGFyVXJsLFxuICAgICAgYmlydGhEYXRlOiB1c2VyLmJpcnRoRGF0ZSxcbiAgICAgIGFkZHJlc3M6IHVzZXIuYWRkcmVzcyxcbiAgICAgIC8vIFJlbW92ZSB1bnN1cHBvcnRlZCBwcm9wZXJ0aWVzIC0gdGhlc2UgZG9uJ3QgZXhpc3QgaW4gVXNlciBtb2RlbFxuICAgICAgY3JlYXRlZEF0OiB1c2VyLmNyZWF0ZWRBdCxcbiAgICAgIHVwZGF0ZWRBdDogdXNlci51cGRhdGVkQXQsXG4gICAgfTtcbiAgfVxufVxuIl0sInZlcnNpb24iOjN9