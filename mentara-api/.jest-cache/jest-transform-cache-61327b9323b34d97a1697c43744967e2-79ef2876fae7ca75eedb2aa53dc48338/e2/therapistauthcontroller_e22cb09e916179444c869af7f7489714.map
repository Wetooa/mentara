{"file":"/home/wetooa/Documents/code/projects/mentara/mentara-api/src/auth/controllers/therapist-auth.controller.ts","mappings":"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","names":[],"sources":["/home/wetooa/Documents/code/projects/mentara/mentara-api/src/auth/controllers/therapist-auth.controller.ts"],"sourcesContent":["import {\n  Body,\n  Controller,\n  Get,\n  Post,\n  UseInterceptors,\n  UploadedFiles,\n  BadRequestException,\n  NotFoundException,\n  InternalServerErrorException,\n  UseGuards,\n  HttpCode,\n  HttpStatus,\n  Req,\n} from '@nestjs/common';\nimport { FilesInterceptor } from '@nestjs/platform-express';\nimport { Throttle } from '@nestjs/throttler';\nimport { JwtAuthGuard } from '../guards/jwt-auth.guard';\nimport { CurrentUserId } from '../decorators/current-user-id.decorator';\nimport { Public } from '../decorators/public.decorator';\nimport { ZodValidationPipe } from '../../common/pipes/zod-validation.pipe';\n// Import types from local auth types\nimport type { RegisterTherapistDto, LoginDto } from '../types';\n\n// Import validation schemas from local validation\nimport { LoginDtoSchema } from '../validation';\n\n// Import constants from local auth constants\nimport { ALLOWED_DOCUMENT_MIME_TYPES } from '../types';\nimport { TherapistAuthService } from '../services/therapist-auth.service';\nimport { SupabaseStorageService } from '../../common/services/supabase-storage.service';\nimport { Request } from 'express';\n\n@Controller('auth/therapist')\nexport class TherapistAuthController {\n  constructor(\n    private readonly therapistAuthService: TherapistAuthService,\n    private readonly supabaseStorageService: SupabaseStorageService,\n  ) {}\n\n  @Public()\n  @Throttle({ default: { limit: 3, ttl: 600000 } }) // 3 therapist registrations per 10 minutes\n  @Post('register')\n  @HttpCode(HttpStatus.CREATED)\n  @UseInterceptors(\n    FilesInterceptor('files', 10, {\n      limits: { fileSize: 10 * 1024 * 1024 }, // 10MB limit per file\n      fileFilter: (req, file, callback) => {\n        if (ALLOWED_DOCUMENT_MIME_TYPES.includes(file.mimetype as any)) {\n          callback(null, true);\n        } else {\n          callback(new BadRequestException('Invalid file type'), false);\n        }\n      },\n    }),\n  )\n  async register(\n    @Body('applicationDataJson') applicationDataJson: string,\n    @Body('fileTypes') fileTypes: string,\n    @UploadedFiles() files: Express.Multer.File[],\n  ): Promise<{\n    user: {\n      id: string;\n      email: string;\n      firstName: string;\n      lastName: string;\n      role: string;\n      emailVerified: boolean;\n    };\n    accessToken: string;\n    refreshToken: string;\n    expiresIn: number;\n    message: string;\n    therapistId?: string;\n    uploadedFiles?: Array<{ id: string; fileName: string; url: string }>;\n  }> {\n    try {\n      // Parse and validate application data from form\n      let registerData: RegisterTherapistDto;\n      try {\n        if (!applicationDataJson) {\n          throw new BadRequestException(\n            'Application data is missing. Please ensure the form is submitted correctly.',\n          );\n        }\n\n        if (typeof applicationDataJson !== 'string') {\n          console.error(\n            'Expected string but received:',\n            typeof applicationDataJson,\n            applicationDataJson,\n          );\n          throw new BadRequestException(\n            'Application data must be a JSON string.',\n          );\n        }\n\n        registerData = JSON.parse(applicationDataJson);\n      } catch (error) {\n        console.error('JSON parsing error:', error);\n        console.error('Raw applicationDataJson:', applicationDataJson);\n        throw new BadRequestException(\n          'Invalid application data format. Please check that all form fields are filled correctly.',\n        );\n      }\n\n      // Validate required documents are present\n      const requiredDocs = ['prcLicense', 'nbiClearance', 'resumeCV'];\n      const hasFiles = files && files.length > 0;\n\n      if (!hasFiles) {\n        throw new BadRequestException(\n          'Required documents must be uploaded: PRC License, NBI Clearance, Resume/CV',\n        );\n      }\n\n      // Parse file type mappings\n      let fileTypeMap: Record<string, string> = {};\n      if (fileTypes) {\n        try {\n          fileTypeMap = JSON.parse(fileTypes);\n          console.log('DEBUG: fileTypes received:', fileTypes);\n          console.log('DEBUG: parsed fileTypeMap:', fileTypeMap);\n        } catch {\n          console.warn('Invalid fileTypes JSON, proceeding without mapping');\n        }\n      }\n\n      // Validate that all required document types are present\n      const uploadedDocTypes = Object.values(fileTypeMap);\n      console.log(\n        'DEBUG: uploadedDocTypes from fileTypeMap:',\n        uploadedDocTypes,\n      );\n      console.log('DEBUG: requiredDocs expected:', requiredDocs);\n      console.log('DEBUG: files received count:', files?.length || 0);\n      console.log(\n        'DEBUG: files details:',\n        files?.map((f) => ({ name: f.originalname, mimetype: f.mimetype })),\n      );\n\n      const missingDocs = requiredDocs.filter(\n        (doc) => !uploadedDocTypes.includes(doc),\n      );\n      console.log('DEBUG: missingDocs calculated:', missingDocs);\n\n      if (missingDocs.length > 0) {\n        const missingNames = missingDocs\n          .map((doc) => {\n            const docNames = {\n              prcLicense: 'PRC License',\n              nbiClearance: 'NBI Clearance',\n              resumeCV: 'Resume/CV',\n            };\n            return docNames[doc as keyof typeof docNames];\n          })\n          .join(', ');\n\n        throw new BadRequestException(\n          `Missing required documents: ${missingNames}`,\n        );\n      }\n\n      // Create unified therapist registration with documents\n      console.log(\n        'DEBUG: About to call registerTherapistWithDocuments with data:',\n        {\n          email: registerData.email,\n          firstName: registerData.firstName,\n          lastName: registerData.lastName,\n          filesCount: files?.length || 0,\n          fileTypeMapKeys: Object.keys(fileTypeMap),\n        },\n      );\n\n      const result =\n        await this.therapistAuthService.registerTherapistWithDocuments(\n          registerData,\n          files || [],\n          fileTypeMap,\n        );\n\n      console.log(\n        'DEBUG: registerTherapistWithDocuments completed successfully',\n      );\n\n      return {\n        user: {\n          id: result.user.id,\n          email: result.user.email,\n          firstName: result.user.firstName,\n          lastName: result.user.lastName,\n          role: result.user.role,\n          emailVerified: result.user.emailVerified,\n        },\n        accessToken: result.token,\n        refreshToken: result.token, // Same token for compatibility\n        expiresIn: 0, // Non-expiring\n        message: result.message,\n        therapistId: result.therapist?.userId,\n        uploadedFiles: result.uploadedFiles,\n      };\n    } catch (error) {\n      console.error('Error registering therapist with documents:', error);\n\n      if (error instanceof BadRequestException) {\n        throw error;\n      }\n\n      if (error instanceof NotFoundException) {\n        throw error;\n      }\n\n      // Enhanced error handling with specific error types\n      const errorMessage =\n        error instanceof Error ? error.message : String(error);\n\n      // Enhanced error handling for user registration scenarios\n      if (errorMessage.includes('already have a therapist account')) {\n        throw new BadRequestException(\n          'You already have a therapist account with this email. Please sign in to your existing account instead.',\n        );\n      }\n\n      if (errorMessage.includes('email already exists')) {\n        throw new BadRequestException(\n          'An account with this email address already exists. Please use a different email or try logging in.',\n        );\n      }\n\n      if (errorMessage.includes('privileges. Please contact support')) {\n        throw new BadRequestException(errorMessage);\n      }\n\n      if (errorMessage.includes('file upload')) {\n        throw new BadRequestException(\n          'One or more files failed to upload. Please check file formats and sizes.',\n        );\n      }\n\n      if (errorMessage.includes('validation')) {\n        throw new BadRequestException(\n          'Registration data validation failed. Please check all required fields.',\n        );\n      }\n\n      throw new InternalServerErrorException(\n        'Failed to register therapist with documents. Please try again or contact support.',\n      );\n    }\n  }\n\n  // REMOVED: Duplicate login route - use universal /auth/login instead\n  // This was redundant with AuthController.login() which handles all roles\n\n  @UseGuards(JwtAuthGuard)\n  @Get('profile')\n  async getProfile(@CurrentUserId() userId: string) {\n    return this.therapistAuthService.getTherapistProfile(userId);\n  }\n}\n"],"version":3}