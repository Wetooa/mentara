376ffb18d52014220b724e229a62d7f1
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.CurrentUserRole = void 0;
const common_1 = require("@nestjs/common");
const prisma_client_provider_1 = require("src/providers/prisma-client.provider");
require("../../types");
exports.CurrentUserRole = (0, common_1.createParamDecorator)(async (_, context) => {
    const request = context.switchToHttp().getRequest();
    const clerkId = request.userId;
    if (!clerkId) {
        return null;
    }
    // First, check if role was extracted from JWT token by JwtAuthGuard
    if (request.userRole) {
        return request.userRole;
    }
    // Fallback to database lookup for backwards compatibility
    try {
        const prisma = new prisma_client_provider_1.PrismaService();
        const user = await prisma.user.findUnique({
            where: { id: clerkId },
            select: { role: true },
        });
        await prisma.$disconnect();
        return user?.role ?? null;
    }
    catch (error) {
        console.error('Error getting user role from database:', error instanceof Error ? error.message : error);
        return null;
    }
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL2F1dGgvZGVjb3JhdG9ycy9jdXJyZW50LXVzZXItcm9sZS5kZWNvcmF0b3IudHMiLCJtYXBwaW5ncyI6Ijs7O0FBQUEsMkNBQTZFO0FBRTdFLGlGQUFxRTtBQUNyRSx1QkFBcUI7QUFFUixRQUFBLGVBQWUsR0FBRyxJQUFBLDZCQUFvQixFQUNqRCxLQUFLLEVBQUUsQ0FBQyxFQUFFLE9BQXlCLEVBQUUsRUFBRTtJQUNyQyxNQUFNLE9BQU8sR0FBRyxPQUFPLENBQUMsWUFBWSxFQUFFLENBQUMsVUFBVSxFQUFXLENBQUM7SUFDN0QsTUFBTSxPQUFPLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBQztJQUUvQixJQUFJLENBQUMsT0FBTyxFQUFFLENBQUM7UUFDYixPQUFPLElBQUksQ0FBQztJQUNkLENBQUM7SUFFRCxvRUFBb0U7SUFDcEUsSUFBSSxPQUFPLENBQUMsUUFBUSxFQUFFLENBQUM7UUFDckIsT0FBTyxPQUFPLENBQUMsUUFBUSxDQUFDO0lBQzFCLENBQUM7SUFFRCwwREFBMEQ7SUFDMUQsSUFBSSxDQUFDO1FBQ0gsTUFBTSxNQUFNLEdBQUcsSUFBSSxzQ0FBYSxFQUFFLENBQUM7UUFDbkMsTUFBTSxJQUFJLEdBQUcsTUFBTSxNQUFNLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQztZQUN4QyxLQUFLLEVBQUUsRUFBRSxFQUFFLEVBQUUsT0FBTyxFQUFFO1lBQ3RCLE1BQU0sRUFBRSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUU7U0FDdkIsQ0FBQyxDQUFDO1FBRUgsTUFBTSxNQUFNLENBQUMsV0FBVyxFQUFFLENBQUM7UUFDM0IsT0FBTyxJQUFJLEVBQUUsSUFBSSxJQUFJLElBQUksQ0FBQztJQUM1QixDQUFDO0lBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztRQUNmLE9BQU8sQ0FBQyxLQUFLLENBQ1gsd0NBQXdDLEVBQ3hDLEtBQUssWUFBWSxLQUFLLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FDL0MsQ0FBQztRQUNGLE9BQU8sSUFBSSxDQUFDO0lBQ2QsQ0FBQztBQUNILENBQUMsQ0FDRixDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9ob21lL3dldG9vYS9Eb2N1bWVudHMvY29kZS9wcm9qZWN0cy9tZW50YXJhL21lbnRhcmEtYXBpL3NyYy9hdXRoL2RlY29yYXRvcnMvY3VycmVudC11c2VyLXJvbGUuZGVjb3JhdG9yLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGNyZWF0ZVBhcmFtRGVjb3JhdG9yLCB0eXBlIEV4ZWN1dGlvbkNvbnRleHQgfSBmcm9tICdAbmVzdGpzL2NvbW1vbic7XG5pbXBvcnQgeyB0eXBlIFJlcXVlc3QgfSBmcm9tICdleHByZXNzJztcbmltcG9ydCB7IFByaXNtYVNlcnZpY2UgfSBmcm9tICdzcmMvcHJvdmlkZXJzL3ByaXNtYS1jbGllbnQucHJvdmlkZXInO1xuaW1wb3J0ICcuLi8uLi90eXBlcyc7XG5cbmV4cG9ydCBjb25zdCBDdXJyZW50VXNlclJvbGUgPSBjcmVhdGVQYXJhbURlY29yYXRvcihcbiAgYXN5bmMgKF8sIGNvbnRleHQ6IEV4ZWN1dGlvbkNvbnRleHQpID0+IHtcbiAgICBjb25zdCByZXF1ZXN0ID0gY29udGV4dC5zd2l0Y2hUb0h0dHAoKS5nZXRSZXF1ZXN0PFJlcXVlc3Q+KCk7XG4gICAgY29uc3QgY2xlcmtJZCA9IHJlcXVlc3QudXNlcklkO1xuXG4gICAgaWYgKCFjbGVya0lkKSB7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICAvLyBGaXJzdCwgY2hlY2sgaWYgcm9sZSB3YXMgZXh0cmFjdGVkIGZyb20gSldUIHRva2VuIGJ5IEp3dEF1dGhHdWFyZFxuICAgIGlmIChyZXF1ZXN0LnVzZXJSb2xlKSB7XG4gICAgICByZXR1cm4gcmVxdWVzdC51c2VyUm9sZTtcbiAgICB9XG5cbiAgICAvLyBGYWxsYmFjayB0byBkYXRhYmFzZSBsb29rdXAgZm9yIGJhY2t3YXJkcyBjb21wYXRpYmlsaXR5XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHByaXNtYSA9IG5ldyBQcmlzbWFTZXJ2aWNlKCk7XG4gICAgICBjb25zdCB1c2VyID0gYXdhaXQgcHJpc21hLnVzZXIuZmluZFVuaXF1ZSh7XG4gICAgICAgIHdoZXJlOiB7IGlkOiBjbGVya0lkIH0sXG4gICAgICAgIHNlbGVjdDogeyByb2xlOiB0cnVlIH0sXG4gICAgICB9KTtcblxuICAgICAgYXdhaXQgcHJpc21hLiRkaXNjb25uZWN0KCk7XG4gICAgICByZXR1cm4gdXNlcj8ucm9sZSA/PyBudWxsO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBjb25zb2xlLmVycm9yKFxuICAgICAgICAnRXJyb3IgZ2V0dGluZyB1c2VyIHJvbGUgZnJvbSBkYXRhYmFzZTonLFxuICAgICAgICBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6IGVycm9yLFxuICAgICAgKTtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cbiAgfSxcbik7XG4iXSwidmVyc2lvbiI6M30=