f481394d7b522df30b3a5c13430a861c
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
exports.TherapistManagementService = void 0;
const common_1 = require("@nestjs/common");
const prisma_client_provider_1 = require("../providers/prisma-client.provider");
const library_1 = require("@prisma/client/runtime/library");
let TherapistManagementService = class TherapistManagementService {
    prisma;
    constructor(prisma) {
        this.prisma = prisma;
    }
    calculateYearsOfExperience(startDate) {
        const now = new Date();
        let years = now.getFullYear() - startDate.getFullYear();
        if (now.getMonth() < startDate.getMonth() ||
            (now.getMonth() === startDate.getMonth() &&
                now.getDate() < startDate.getDate())) {
            years--;
        }
        return years;
    }
    async getTherapistProfile(userId) {
        try {
            const therapist = await this.prisma.therapist.findUniqueOrThrow({
                where: { userId },
                include: {
                    user: true,
                    therapistAvailabilities: true,
                    worksheets: true,
                    meetings: true,
                    assignedClients: true,
                },
            });
            return {
                ...therapist,
                // Map database fields to frontend-expected fields
                specialties: therapist.areasOfExpertise || [],
                treatmentSuccessRates: therapist.treatmentSuccessRates || {},
                hourlyRate: therapist.hourlyRate,
            };
        }
        catch (error) {
            console.error('Error retrieving therapist profile:', error instanceof Error ? error.message : error);
            throw new common_1.InternalServerErrorException('Failed to retrieve therapist profile');
        }
    }
    async updateTherapistProfile(userId, data) {
        try {
            // Update therapist profile data
            const therapistData = {};
            if (data.mobile !== undefined)
                therapistData.mobile = data.mobile;
            if (data.province !== undefined)
                therapistData.province = data.province;
            if (data.providerType !== undefined)
                therapistData.providerType = data.providerType;
            if (data.professionalLicenseType !== undefined)
                therapistData.professionalLicenseType = data.professionalLicenseType;
            if (data.isPRCLicensed !== undefined)
                therapistData.isPRCLicensed = data.isPRCLicensed;
            if (data.prcLicenseNumber !== undefined)
                therapistData.prcLicenseNumber = data.prcLicenseNumber;
            if (data.expirationDateOfLicense !== undefined)
                therapistData.expirationDateOfLicense = data.expirationDateOfLicense;
            if (data.practiceStartDate !== undefined)
                therapistData.practiceStartDate = data.practiceStartDate;
            if (data.areasOfExpertise !== undefined)
                therapistData.areasOfExpertise = data.areasOfExpertise;
            if (data.assessmentTools !== undefined)
                therapistData.assessmentTools = data.assessmentTools;
            if (data.therapeuticApproachesUsedList !== undefined)
                therapistData.therapeuticApproachesUsedList =
                    data.therapeuticApproachesUsedList;
            if (data.languagesOffered !== undefined)
                therapistData.languagesOffered = data.languagesOffered;
            if (data.providedOnlineTherapyBefore !== undefined)
                therapistData.providedOnlineTherapyBefore =
                    data.providedOnlineTherapyBefore;
            if (data.comfortableUsingVideoConferencing !== undefined)
                therapistData.comfortableUsingVideoConferencing =
                    data.comfortableUsingVideoConferencing;
            if (data.preferredSessionLength !== undefined)
                therapistData.preferredSessionLength = data.preferredSessionLength;
            if (data.privateConfidentialSpace !== undefined)
                therapistData.privateConfidentialSpace = data.privateConfidentialSpace;
            if (data.compliesWithDataPrivacyAct !== undefined)
                therapistData.compliesWithDataPrivacyAct =
                    data.compliesWithDataPrivacyAct;
            if (data.professionalLiabilityInsurance !== undefined)
                therapistData.professionalLiabilityInsurance =
                    data.professionalLiabilityInsurance;
            if (data.complaintsOrDisciplinaryActions !== undefined)
                therapistData.complaintsOrDisciplinaryActions =
                    data.complaintsOrDisciplinaryActions;
            if (data.willingToAbideByPlatformGuidelines !== undefined)
                therapistData.willingToAbideByPlatformGuidelines =
                    data.willingToAbideByPlatformGuidelines;
            if (data.expertise !== undefined)
                therapistData.expertise = data.expertise;
            if (data.approaches !== undefined)
                therapistData.approaches = data.approaches;
            if (data.languages !== undefined)
                therapistData.languages = data.languages;
            if (data.illnessSpecializations !== undefined)
                therapistData.illnessSpecializations = data.illnessSpecializations;
            if (data.acceptTypes !== undefined)
                therapistData.acceptTypes = data.acceptTypes;
            if (data.treatmentSuccessRates !== undefined)
                therapistData.treatmentSuccessRates = data.treatmentSuccessRates;
            if (data.sessionLength !== undefined)
                therapistData.sessionLength = data.sessionLength;
            if (data.hourlyRate !== undefined)
                therapistData.hourlyRate = new library_1.Decimal(data.hourlyRate);
            const updatedTherapist = await this.prisma.therapist.update({
                where: { userId },
                data: therapistData,
                include: {
                    user: true,
                },
            });
            return {
                ...updatedTherapist,
                // Map database fields to frontend-expected fields
                specialties: updatedTherapist.areasOfExpertise || [],
                treatmentSuccessRates: updatedTherapist.treatmentSuccessRates || {},
                hourlyRate: updatedTherapist.hourlyRate,
            };
        }
        catch (error) {
            console.error('Error updating therapist profile:', error instanceof Error ? error.message : error);
            throw new common_1.InternalServerErrorException('Failed to update therapist profile');
        }
    }
    async getAssignedPatients(therapistId) {
        try {
            const therapist = await this.prisma.therapist.findUniqueOrThrow({
                where: { userId: therapistId },
            });
            // Find all clients assigned to this therapist
            const assignedClients = await this.prisma.clientTherapist.findMany({
                where: { therapistId: therapist.userId },
                include: { client: { include: { user: true } } },
            });
            return assignedClients.map((ct) => ({
                ...ct.client,
                user: ct.client.user,
            }));
        }
        catch (error) {
            console.error('Error retrieving assigned patients:', error instanceof Error ? error.message : error);
            throw new common_1.InternalServerErrorException('Failed to retrieve assigned patients');
        }
    }
    async getAllClients(therapistId) {
        try {
            // Find all clients assigned to this therapist
            const assignedClients = await this.prisma.clientTherapist.findMany({
                where: { therapistId: therapistId },
                include: { client: { include: { user: true } } },
            });
            return assignedClients.map((ct) => ({
                ...ct.client,
            }));
        }
        catch (error) {
            console.error('Error retrieving all clients:', error instanceof Error ? error.message : error);
            throw new common_1.InternalServerErrorException('Failed to retrieve all clients');
        }
    }
    async getClientById(therapistId, clientId) {
        try {
            // Find the specific client assigned to this therapist
            const assignedClient = await this.prisma.clientTherapist.findFirst({
                where: { therapistId: therapistId, clientId: clientId },
                include: { client: { include: { user: true } } },
            });
            if (!assignedClient) {
                throw new common_1.NotFoundException('Client not found');
            }
            return assignedClient.client;
        }
        catch (error) {
            console.error('Error retrieving client by ID:', error instanceof Error ? error.message : error);
            throw new common_1.InternalServerErrorException('Failed to retrieve client by ID');
        }
    }
    async getProfile(therapistId) {
        try {
            const therapist = await this.prisma.therapist.findUniqueOrThrow({
                where: { userId: therapistId },
                include: {
                    user: true,
                },
            });
            return {
                ...therapist,
                // Map database fields to frontend-expected fields
                specialties: therapist.areasOfExpertise || [],
                treatmentSuccessRates: therapist.treatmentSuccessRates || {},
                hourlyRate: therapist.hourlyRate,
            };
        }
        catch (error) {
            console.error('Error retrieving therapist profile:', error instanceof Error ? error.message : error);
            throw new common_1.InternalServerErrorException('Failed to retrieve therapist profile');
        }
    }
    async updateProfile(therapistId, data) {
        try {
            const updatedTherapist = await this.prisma.therapist.update({
                where: { userId: therapistId },
                data,
                include: {
                    user: true,
                },
            });
            return {
                ...updatedTherapist,
                // Map database fields to frontend-expected fields
                specialties: updatedTherapist.areasOfExpertise || [],
                treatmentSuccessRates: updatedTherapist.treatmentSuccessRates || {},
                hourlyRate: updatedTherapist.hourlyRate,
            };
        }
        catch (error) {
            console.error('Error updating therapist profile:', error instanceof Error ? error.message : error);
            throw new common_1.InternalServerErrorException('Failed to update therapist profile');
        }
    }
    async getMatchedClients(therapistId) {
        try {
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            // Get all matched clients (no status needed - all relationships are active)
            const allMatches = await this.prisma.clientTherapist.findMany({
                where: {
                    therapistId: therapistId
                },
                include: {
                    client: {
                        include: {
                            user: true,
                            preAssessment: {
                                select: {
                                    id: true,
                                    createdAt: true,
                                    answers: true
                                }
                            }
                        }
                    }
                },
                orderBy: { assignedAt: 'desc' }
            });
            // Separate recent matches (last 30 days) from older ones
            const recentMatches = allMatches.filter(match => new Date(match.assignedAt) >= thirtyDaysAgo);
            const olderMatches = allMatches.filter(match => new Date(match.assignedAt) < thirtyDaysAgo);
            // Format the response with additional metadata
            const formatClientMatch = (relationship) => {
                const latestAssessment = relationship.client.preAssessment;
                return {
                    relationshipId: relationship.id,
                    client: {
                        id: relationship.client.userId,
                        firstName: relationship.client.user.firstName,
                        lastName: relationship.client.user.lastName,
                        email: relationship.client.user.email,
                        profilePicture: relationship.client.user.profilePicture,
                        joinedAt: relationship.client.user.createdAt,
                    },
                    matchInfo: {
                        assignedAt: relationship.assignedAt,
                        daysSinceMatch: Math.floor((Date.now() - new Date(relationship.assignedAt).getTime()) / (1000 * 60 * 60 * 24)),
                    },
                    assessmentInfo: latestAssessment ? {
                        hasAssessment: true,
                        completedAt: latestAssessment.createdAt,
                        assessmentType: 'Pre-Assessment',
                        daysSinceAssessment: Math.floor((Date.now() - new Date(latestAssessment.createdAt).getTime()) / (1000 * 60 * 60 * 24)),
                    } : {
                        hasAssessment: false,
                        completedAt: null,
                        assessmentType: null,
                        daysSinceAssessment: null,
                    }
                };
            };
            return {
                recentMatches: recentMatches.map(formatClientMatch),
                allMatches: allMatches.map(formatClientMatch),
                summary: {
                    totalRecentMatches: recentMatches.length,
                    totalAllMatches: allMatches.length,
                    totalMatches: allMatches.length,
                }
            };
        }
        catch (error) {
            console.error('Error retrieving matched clients:', error instanceof Error ? error.message : error);
            throw new common_1.InternalServerErrorException('Failed to retrieve matched clients');
        }
    }
};
exports.TherapistManagementService = TherapistManagementService;
exports.TherapistManagementService = TherapistManagementService = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [typeof (_a = typeof prisma_client_provider_1.PrismaService !== "undefined" && prisma_client_provider_1.PrismaService) === "function" ? _a : Object])
], TherapistManagementService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL3RoZXJhcGlzdC90aGVyYXBpc3QtbWFuYWdlbWVudC5zZXJ2aWNlLnRzIiwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7QUFBQSwyQ0FJd0I7QUFDeEIsZ0ZBQW9FO0FBRXBFLDREQUF5RDtBQThCbEQsSUFBTSwwQkFBMEIsR0FBaEMsTUFBTSwwQkFBMEI7SUFDUjtJQUE3QixZQUE2QixNQUFxQjtRQUFyQixXQUFNLEdBQU4sTUFBTSxDQUFlO0lBQUcsQ0FBQztJQUU5QywwQkFBMEIsQ0FBQyxTQUFlO1FBQ2hELE1BQU0sR0FBRyxHQUFHLElBQUksSUFBSSxFQUFFLENBQUM7UUFDdkIsSUFBSSxLQUFLLEdBQUcsR0FBRyxDQUFDLFdBQVcsRUFBRSxHQUFHLFNBQVMsQ0FBQyxXQUFXLEVBQUUsQ0FBQztRQUN4RCxJQUNFLEdBQUcsQ0FBQyxRQUFRLEVBQUUsR0FBRyxTQUFTLENBQUMsUUFBUSxFQUFFO1lBQ3JDLENBQUMsR0FBRyxDQUFDLFFBQVEsRUFBRSxLQUFLLFNBQVMsQ0FBQyxRQUFRLEVBQUU7Z0JBQ3RDLEdBQUcsQ0FBQyxPQUFPLEVBQUUsR0FBRyxTQUFTLENBQUMsT0FBTyxFQUFFLENBQUMsRUFDdEMsQ0FBQztZQUNELEtBQUssRUFBRSxDQUFDO1FBQ1YsQ0FBQztRQUNELE9BQU8sS0FBSyxDQUFDO0lBQ2YsQ0FBQztJQUVELEtBQUssQ0FBQyxtQkFBbUIsQ0FBQyxNQUFjO1FBQ3RDLElBQUksQ0FBQztZQUNILE1BQU0sU0FBUyxHQUFHLE1BQU0sSUFBSSxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUMsaUJBQWlCLENBQUM7Z0JBQzlELEtBQUssRUFBRSxFQUFFLE1BQU0sRUFBRTtnQkFDakIsT0FBTyxFQUFFO29CQUNQLElBQUksRUFBRSxJQUFJO29CQUNWLHVCQUF1QixFQUFFLElBQUk7b0JBQzdCLFVBQVUsRUFBRSxJQUFJO29CQUNoQixRQUFRLEVBQUUsSUFBSTtv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LENBQUMsS0FBSyxDQUNYLG1DQUFtQyxFQUNuQyxLQUFLLFlBQVksS0FBSyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQy9DLENBQUM7WUFDRixNQUFNLElBQUkscUNBQTRCLENBQ3BDLG9DQUFvQyxDQUNyQyxDQUFDO1FBQ0osQ0FBQztJQUNILENBQUM7Q0FDRixDQUFBO0FBbldZLGdFQUEwQjtxQ0FBMUIsMEJBQTBCO0lBRHRDLElBQUEsbUJBQVUsR0FBRTt5REFFMEIsc0NBQWEsb0JBQWIsc0NBQWE7R0FEdkMsMEJBQTBCLENBbVd0QyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvaG9tZS93ZXRvb2EvRG9jdW1lbnRzL2NvZGUvcHJvamVjdHMvbWVudGFyYS9tZW50YXJhLWFwaS9zcmMvdGhlcmFwaXN0L3RoZXJhcGlzdC1tYW5hZ2VtZW50LnNlcnZpY2UudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgSW5qZWN0YWJsZSxcbiAgTm90Rm91bmRFeGNlcHRpb24sXG4gIEludGVybmFsU2VydmVyRXJyb3JFeGNlcHRpb24sXG59IGZyb20gJ0BuZXN0anMvY29tbW9uJztcbmltcG9ydCB7IFByaXNtYVNlcnZpY2UgfSBmcm9tICcuLi9wcm92aWRlcnMvcHJpc21hLWNsaWVudC5wcm92aWRlcic7XG5pbXBvcnQgeyBQcmlzbWEgfSBmcm9tICdAcHJpc21hL2NsaWVudCc7XG5pbXBvcnQgeyBEZWNpbWFsIH0gZnJvbSAnQHByaXNtYS9jbGllbnQvcnVudGltZS9saWJyYXJ5Jztcbi8vIFJlbW92ZWQgaW1wb3J0IC0gdXNpbmcgbG9jYWwgdHlwZXMgaW5zdGVhZFxuaW50ZXJmYWNlIFRoZXJhcGlzdFJlc3BvbnNlIHtcbiAgaWQ6IHN0cmluZztcbiAgZmlyc3ROYW1lOiBzdHJpbmc7XG4gIGxhc3ROYW1lOiBzdHJpbmc7XG4gIHNwZWNpYWx0aWVzOiBzdHJpbmdbXTtcbiAgaXNBY3RpdmU6IGJvb2xlYW47XG59XG5cbmludGVyZmFjZSBDbGllbnRSZXNwb25zZSB7XG4gIGlkOiBzdHJpbmc7XG4gIGZpcnN0TmFtZTogc3RyaW5nO1xuICBsYXN0TmFtZTogc3RyaW5nO1xufVxuXG5pbnRlcmZhY2UgVGhlcmFwaXN0VXBkYXRlRHRvIHtcbiAgc3BlY2lhbHRpZXM/OiBzdHJpbmdbXTtcbiAgaXNBY3RpdmU/OiBib29sZWFuO1xuICBtb2JpbGU/OiBzdHJpbmc7XG4gIHByb3ZpbmNlPzogc3RyaW5nO1xuICBob3VybHlSYXRlPzogYW55O1xuICBhcmVhc09mRXhwZXJ0aXNlPzogc3RyaW5nW107XG4gIGxhbmd1YWdlc09mZmVyZWQ/OiBzdHJpbmdbXTtcbiAgcHJlZmVycmVkU2Vzc2lvbkxlbmd0aD86IG51bWJlcltdO1xuICAvLyBBbGxvdyBhbnkgb3RoZXIgcHJvcGVydGllc1xuICBba2V5OiBzdHJpbmddOiBhbnk7XG59XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBUaGVyYXBpc3RNYW5hZ2VtZW50U2VydmljZSB7XG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgcmVhZG9ubHkgcHJpc21hOiBQcmlzbWFTZXJ2aWNlKSB7fVxuXG4gIHByaXZhdGUgY2FsY3VsYXRlWWVhcnNPZkV4cGVyaWVuY2Uoc3RhcnREYXRlOiBEYXRlKTogbnVtYmVyIHtcbiAgICBjb25zdCBub3cgPSBuZXcgRGF0ZSgpO1xuICAgIGxldCB5ZWFycyA9IG5vdy5nZXRGdWxsWWVhcigpIC0gc3RhcnREYXRlLmdldEZ1bGxZZWFyKCk7XG4gICAgaWYgKFxuICAgICAgbm93LmdldE1vbnRoKCkgPCBzdGFydERhdGUuZ2V0TW9udGgoKSB8fFxuICAgICAgKG5vdy5nZXRNb250aCgpID09PSBzdGFydERhdGUuZ2V0TW9udGgoKSAmJlxuICAgICAgICBub3cuZ2V0RGF0ZSgpIDwgc3RhcnREYXRlLmdldERhdGUoKSlcbiAgICApIHtcbiAgICAgIHllYXJzLS07XG4gICAgfVxuICAgIHJldHVybiB5ZWFycztcbiAgfVxuXG4gIGFzeW5jIGdldFRoZXJhcGlzdFByb2ZpbGUodXNlcklkOiBzdHJpbmcpOiBQcm9taXNlPGFueT4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCB0aGVyYXBpc3QgPSBhd2FpdCB0aGlzLnByaXNtYS50aGVyYXBpc3QuZmluZFVuaXF1ZU9yVGhyb3coe1xuICAgICAgICB3aGVyZTogeyB1c2VySWQgfSxcbiAgICAgICAgaW5jbHVkZToge1xuICAgICAgICAgIHVzZXI6IHRydWUsXG4gICAgICAgICAgdGhlcmFwaXN0QXZhaWxhYmlsaXRpZXM6IHRydWUsXG4gICAgICAgICAgd29ya3NoZWV0czogdHJ1ZSxcbiAgICAgICAgICBtZWV0aW5nczogdHJ1ZSxcbiAgICAgICAgICBhc3NpZ25lZENsaWVudHM6IHRydWUsXG4gICAgICAgIH0sXG4gICAgICB9KTtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIC4uLnRoZXJhcGlzdCxcbiAgICAgICAgLy8gTWFwIGRhdGFiYXNlIGZpZWxkcyB0byBmcm9udGVuZC1leHBlY3RlZCBmaWVsZHNcbiAgICAgICAgc3BlY2lhbHRpZXM6IHRoZXJhcGlzdC5hcmVhc09mRXhwZXJ0aXNlIHx8IFtdLFxuICAgICAgICB0cmVhdG1lbnRTdWNjZXNzUmF0ZXM6XG4gICAgICAgICAgKHRoZXJhcGlzdC50cmVhdG1lbnRTdWNjZXNzUmF0ZXMgYXMgUmVjb3JkPHN0cmluZywgYW55PikgfHwge30sXG4gICAgICAgIGhvdXJseVJhdGU6IHRoZXJhcGlzdC5ob3VybHlSYXRlLFxuICAgICAgfTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc29sZS5lcnJvcihcbiAgICAgICAgJ0Vycm9yIHJldHJpZXZpbmcgdGhlcmFwaXN0IHByb2ZpbGU6JyxcbiAgICAgICAgZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiBlcnJvcixcbiAgICAgICk7XG4gICAgICB0aHJvdyBuZXcgSW50ZXJuYWxTZXJ2ZXJFcnJvckV4Y2VwdGlvbihcbiAgICAgICAgJ0ZhaWxlZCB0byByZXRyaWV2ZSB0aGVyYXBpc3QgcHJvZmlsZScsXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIHVwZGF0ZVRoZXJhcGlzdFByb2ZpbGUoXG4gICAgdXNlcklkOiBzdHJpbmcsXG4gICAgZGF0YTogVGhlcmFwaXN0VXBkYXRlRHRvLFxuICApOiBQcm9taXNlPGFueT4ge1xuICAgIHRyeSB7XG4gICAgICAvLyBVcGRhdGUgdGhlcmFwaXN0IHByb2ZpbGUgZGF0YVxuICAgICAgY29uc3QgdGhlcmFwaXN0RGF0YTogYW55ID0ge307XG4gICAgICBpZiAoZGF0YS5tb2JpbGUgIT09IHVuZGVmaW5lZCkgdGhlcmFwaXN0RGF0YS5tb2JpbGUgPSBkYXRhLm1vYmlsZTtcbiAgICAgIGlmIChkYXRhLnByb3ZpbmNlICE9PSB1bmRlZmluZWQpIHRoZXJhcGlzdERhdGEucHJvdmluY2UgPSBkYXRhLnByb3ZpbmNlO1xuICAgICAgaWYgKGRhdGEucHJvdmlkZXJUeXBlICE9PSB1bmRlZmluZWQpXG4gICAgICAgIHRoZXJhcGlzdERhdGEucHJvdmlkZXJUeXBlID0gZGF0YS5wcm92aWRlclR5cGU7XG4gICAgICBpZiAoZGF0YS5wcm9mZXNzaW9uYWxMaWNlbnNlVHlwZSAhPT0gdW5kZWZpbmVkKVxuICAgICAgICB0aGVyYXBpc3REYXRhLnByb2Zlc3Npb25hbExpY2Vuc2VUeXBlID0gZGF0YS5wcm9mZXNzaW9uYWxMaWNlbnNlVHlwZTtcbiAgICAgIGlmIChkYXRhLmlzUFJDTGljZW5zZWQgIT09IHVuZGVmaW5lZClcbiAgICAgICAgdGhlcmFwaXN0RGF0YS5pc1BSQ0xpY2Vuc2VkID0gZGF0YS5pc1BSQ0xpY2Vuc2VkO1xuICAgICAgaWYgKGRhdGEucHJjTGljZW5zZU51bWJlciAhPT0gdW5kZWZpbmVkKVxuICAgICAgICB0aGVyYXBpc3REYXRhLnByY0xpY2Vuc2VOdW1iZXIgPSBkYXRhLnByY0xpY2Vuc2VOdW1iZXI7XG4gICAgICBpZiAoZGF0YS5leHBpcmF0aW9uRGF0ZU9mTGljZW5zZSAhPT0gdW5kZWZpbmVkKVxuICAgICAgICB0aGVyYXBpc3REYXRhLmV4cGlyYXRpb25EYXRlT2ZMaWNlbnNlID0gZGF0YS5leHBpcmF0aW9uRGF0ZU9mTGljZW5zZTtcbiAgICAgIGlmIChkYXRhLnByYWN0aWNlU3RhcnREYXRlICE9PSB1bmRlZmluZWQpXG4gICAgICAgIHRoZXJhcGlzdERhdGEucHJhY3RpY2VTdGFydERhdGUgPSBkYXRhLnByYWN0aWNlU3RhcnREYXRlO1xuICAgICAgaWYgKGRhdGEuYXJlYXNPZkV4cGVydGlzZSAhPT0gdW5kZWZpbmVkKVxuICAgICAgICB0aGVyYXBpc3REYXRhLmFyZWFzT2ZFeHBlcnRpc2UgPSBkYXRhLmFyZWFzT2ZFeHBlcnRpc2U7XG4gICAgICBpZiAoZGF0YS5hc3Nlc3NtZW50VG9vbHMgIT09IHVuZGVmaW5lZClcbiAgICAgICAgdGhlcmFwaXN0RGF0YS5hc3Nlc3NtZW50VG9vbHMgPSBkYXRhLmFzc2Vzc21lbnRUb29scztcbiAgICAgIGlmIChkYXRhLnRoZXJhcGV1dGljQXBwcm9hY2hlc1VzZWRMaXN0ICE9PSB1bmRlZmluZWQpXG4gICAgICAgIHRoZXJhcGlzdERhdGEudGhlcmFwZXV0aWNBcHByb2FjaGVzVXNlZExpc3QgPVxuICAgICAgICAgIGRhdGEudGhlcmFwZXV0aWNBcHByb2FjaGVzVXNlZExpc3Q7XG4gICAgICBpZiAoZGF0YS5sYW5ndWFnZXNPZmZlcmVkICE9PSB1bmRlZmluZWQpXG4gICAgICAgIHRoZXJhcGlzdERhdGEubGFuZ3VhZ2VzT2ZmZXJlZCA9IGRhdGEubGFuZ3VhZ2VzT2ZmZXJlZDtcbiAgICAgIGlmIChkYXRhLnByb3ZpZGVkT25saW5lVGhlcmFweUJlZm9yZSAhPT0gdW5kZWZpbmVkKVxuICAgICAgICB0aGVyYXBpc3REYXRhLnByb3ZpZGVkT25saW5lVGhlcmFweUJlZm9yZSA9XG4gICAgICAgICAgZGF0YS5wcm92aWRlZE9ubGluZVRoZXJhcHlCZWZvcmU7XG4gICAgICBpZiAoZGF0YS5jb21mb3J0YWJsZVVzaW5nVmlkZW9Db25mZXJlbmNpbmcgIT09IHVuZGVmaW5lZClcbiAgICAgICAgdGhlcmFwaXN0RGF0YS5jb21mb3J0YWJsZVVzaW5nVmlkZW9Db25mZXJlbmNpbmcgPVxuICAgICAgICAgIGRhdGEuY29tZm9ydGFibGVVc2luZ1ZpZGVvQ29uZmVyZW5jaW5nO1xuICAgICAgaWYgKGRhdGEucHJlZmVycmVkU2Vzc2lvbkxlbmd0aCAhPT0gdW5kZWZpbmVkKVxuICAgICAgICB0aGVyYXBpc3REYXRhLnByZWZlcnJlZFNlc3Npb25MZW5ndGggPSBkYXRhLnByZWZlcnJlZFNlc3Npb25MZW5ndGg7XG4gICAgICBpZiAoZGF0YS5wcml2YXRlQ29uZmlkZW50aWFsU3BhY2UgIT09IHVuZGVmaW5lZClcbiAgICAgICAgdGhlcmFwaXN0RGF0YS5wcml2YXRlQ29uZmlkZW50aWFsU3BhY2UgPSBkYXRhLnByaXZhdGVDb25maWRlbnRpYWxTcGFjZTtcbiAgICAgIGlmIChkYXRhLmNvbXBsaWVzV2l0aERhdGFQcml2YWN5QWN0ICE9PSB1bmRlZmluZWQpXG4gICAgICAgIHRoZXJhcGlzdERhdGEuY29tcGxpZXNXaXRoRGF0YVByaXZhY3lBY3QgPVxuICAgICAgICAgIGRhdGEuY29tcGxpZXNXaXRoRGF0YVByaXZhY3lBY3Q7XG4gICAgICBpZiAoZGF0YS5wcm9mZXNzaW9uYWxMaWFiaWxpdHlJbnN1cmFuY2UgIT09IHVuZGVmaW5lZClcbiAgICAgICAgdGhlcmFwaXN0RGF0YS5wcm9mZXNzaW9uYWxMaWFiaWxpdHlJbnN1cmFuY2UgPVxuICAgICAgICAgIGRhdGEucHJvZmVzc2lvbmFsTGlhYmlsaXR5SW5zdXJhbmNlO1xuICAgICAgaWYgKGRhdGEuY29tcGxhaW50c09yRGlzY2lwbGluYXJ5QWN0aW9ucyAhPT0gdW5kZWZpbmVkKVxuICAgICAgICB0aGVyYXBpc3REYXRhLmNvbXBsYWludHNPckRpc2NpcGxpbmFyeUFjdGlvbnMgPVxuICAgICAgICAgIGRhdGEuY29tcGxhaW50c09yRGlzY2lwbGluYXJ5QWN0aW9ucztcbiAgICAgIGlmIChkYXRhLndpbGxpbmdUb0FiaWRlQnlQbGF0Zm9ybUd1aWRlbGluZXMgIT09IHVuZGVmaW5lZClcbiAgICAgICAgdGhlcmFwaXN0RGF0YS53aWxsaW5nVG9BYmlkZUJ5UGxhdGZvcm1HdWlkZWxpbmVzID1cbiAgICAgICAgICBkYXRhLndpbGxpbmdUb0FiaWRlQnlQbGF0Zm9ybUd1aWRlbGluZXM7XG4gICAgICBpZiAoZGF0YS5leHBlcnRpc2UgIT09IHVuZGVmaW5lZClcbiAgICAgICAgdGhlcmFwaXN0RGF0YS5leHBlcnRpc2UgPSBkYXRhLmV4cGVydGlzZTtcbiAgICAgIGlmIChkYXRhLmFwcHJvYWNoZXMgIT09IHVuZGVmaW5lZClcbiAgICAgICAgdGhlcmFwaXN0RGF0YS5hcHByb2FjaGVzID0gZGF0YS5hcHByb2FjaGVzO1xuICAgICAgaWYgKGRhdGEubGFuZ3VhZ2VzICE9PSB1bmRlZmluZWQpXG4gICAgICAgIHRoZXJhcGlzdERhdGEubGFuZ3VhZ2VzID0gZGF0YS5sYW5ndWFnZXM7XG4gICAgICBpZiAoZGF0YS5pbGxuZXNzU3BlY2lhbGl6YXRpb25zICE9PSB1bmRlZmluZWQpXG4gICAgICAgIHRoZXJhcGlzdERhdGEuaWxsbmVzc1NwZWNpYWxpemF0aW9ucyA9IGRhdGEuaWxsbmVzc1NwZWNpYWxpemF0aW9ucztcbiAgICAgIGlmIChkYXRhLmFjY2VwdFR5cGVzICE9PSB1bmRlZmluZWQpXG4gICAgICAgIHRoZXJhcGlzdERhdGEuYWNjZXB0VHlwZXMgPSBkYXRhLmFjY2VwdFR5cGVzO1xuICAgICAgaWYgKGRhdGEudHJlYXRtZW50U3VjY2Vzc1JhdGVzICE9PSB1bmRlZmluZWQpXG4gICAgICAgIHRoZXJhcGlzdERhdGEudHJlYXRtZW50U3VjY2Vzc1JhdGVzID0gZGF0YS50cmVhdG1lbnRTdWNjZXNzUmF0ZXM7XG4gICAgICBpZiAoZGF0YS5zZXNzaW9uTGVuZ3RoICE9PSB1bmRlZmluZWQpXG4gICAgICAgIHRoZXJhcGlzdERhdGEuc2Vzc2lvbkxlbmd0aCA9IGRhdGEuc2Vzc2lvbkxlbmd0aDtcbiAgICAgIGlmIChkYXRhLmhvdXJseVJhdGUgIT09IHVuZGVmaW5lZClcbiAgICAgICAgdGhlcmFwaXN0RGF0YS5ob3VybHlSYXRlID0gbmV3IERlY2ltYWwoZGF0YS5ob3VybHlSYXRlKTtcblxuICAgICAgY29uc3QgdXBkYXRlZFRoZXJhcGlzdCA9IGF3YWl0IHRoaXMucHJpc21hLnRoZXJhcGlzdC51cGRhdGUoe1xuICAgICAgICB3aGVyZTogeyB1c2VySWQgfSxcbiAgICAgICAgZGF0YTogdGhlcmFwaXN0RGF0YSxcbiAgICAgICAgaW5jbHVkZToge1xuICAgICAgICAgIHVzZXI6IHRydWUsXG4gICAgICAgIH0sXG4gICAgICB9KTtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIC4uLnVwZGF0ZWRUaGVyYXBpc3QsXG4gICAgICAgIC8vIE1hcCBkYXRhYmFzZSBmaWVsZHMgdG8gZnJvbnRlbmQtZXhwZWN0ZWQgZmllbGRzXG4gICAgICAgIHNwZWNpYWx0aWVzOiB1cGRhdGVkVGhlcmFwaXN0LmFyZWFzT2ZFeHBlcnRpc2UgfHwgW10sXG4gICAgICAgIHRyZWF0bWVudFN1Y2Nlc3NSYXRlczpcbiAgICAgICAgICAodXBkYXRlZFRoZXJhcGlzdC50cmVhdG1lbnRTdWNjZXNzUmF0ZXMgYXMgUmVjb3JkPHN0cmluZywgYW55PikgfHwge30sXG4gICAgICAgIGhvdXJseVJhdGU6IHVwZGF0ZWRUaGVyYXBpc3QuaG91cmx5UmF0ZSxcbiAgICAgIH07XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoXG4gICAgICAgICdFcnJvciB1cGRhdGluZyB0aGVyYXBpc3QgcHJvZmlsZTonLFxuICAgICAgICBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6IGVycm9yLFxuICAgICAgKTtcbiAgICAgIHRocm93IG5ldyBJbnRlcm5hbFNlcnZlckVycm9yRXhjZXB0aW9uKFxuICAgICAgICAnRmFpbGVkIHRvIHVwZGF0ZSB0aGVyYXBpc3QgcHJvZmlsZScsXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGdldEFzc2lnbmVkUGF0aWVudHModGhlcmFwaXN0SWQ6IHN0cmluZyk6IFByb21pc2U8YW55W10+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgdGhlcmFwaXN0ID0gYXdhaXQgdGhpcy5wcmlzbWEudGhlcmFwaXN0LmZpbmRVbmlxdWVPclRocm93KHtcbiAgICAgICAgd2hlcmU6IHsgdXNlcklkOiB0aGVyYXBpc3RJZCB9LFxuICAgICAgfSk7XG5cbiAgICAgIC8vIEZpbmQgYWxsIGNsaWVudHMgYXNzaWduZWQgdG8gdGhpcyB0aGVyYXBpc3RcbiAgICAgIGNvbnN0IGFzc2lnbmVkQ2xpZW50cyA9IGF3YWl0IHRoaXMucHJpc21hLmNsaWVudFRoZXJhcGlzdC5maW5kTWFueSh7XG4gICAgICAgIHdoZXJlOiB7IHRoZXJhcGlzdElkOiB0aGVyYXBpc3QudXNlcklkIH0sXG4gICAgICAgIGluY2x1ZGU6IHsgY2xpZW50OiB7IGluY2x1ZGU6IHsgdXNlcjogdHJ1ZSB9IH0gfSxcbiAgICAgIH0pO1xuXG4gICAgICByZXR1cm4gYXNzaWduZWRDbGllbnRzLm1hcCgoY3QpID0+ICh7XG4gICAgICAgIC4uLmN0LmNsaWVudCxcbiAgICAgICAgdXNlcjogY3QuY2xpZW50LnVzZXIsXG4gICAgICB9KSk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoXG4gICAgICAgICdFcnJvciByZXRyaWV2aW5nIGFzc2lnbmVkIHBhdGllbnRzOicsXG4gICAgICAgIGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogZXJyb3IsXG4gICAgICApO1xuXG4gICAgICB0aHJvdyBuZXcgSW50ZXJuYWxTZXJ2ZXJFcnJvckV4Y2VwdGlvbihcbiAgICAgICAgJ0ZhaWxlZCB0byByZXRyaWV2ZSBhc3NpZ25lZCBwYXRpZW50cycsXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGdldEFsbENsaWVudHModGhlcmFwaXN0SWQ6IHN0cmluZyk6IFByb21pc2U8YW55W10+IHtcbiAgICB0cnkge1xuICAgICAgLy8gRmluZCBhbGwgY2xpZW50cyBhc3NpZ25lZCB0byB0aGlzIHRoZXJhcGlzdFxuICAgICAgY29uc3QgYXNzaWduZWRDbGllbnRzID0gYXdhaXQgdGhpcy5wcmlzbWEuY2xpZW50VGhlcmFwaXN0LmZpbmRNYW55KHtcbiAgICAgICAgd2hlcmU6IHsgdGhlcmFwaXN0SWQ6IHRoZXJhcGlzdElkIH0sXG4gICAgICAgIGluY2x1ZGU6IHsgY2xpZW50OiB7IGluY2x1ZGU6IHsgdXNlcjogdHJ1ZSB9IH0gfSxcbiAgICAgIH0pO1xuXG4gICAgICByZXR1cm4gYXNzaWduZWRDbGllbnRzLm1hcCgoY3QpID0+ICh7XG4gICAgICAgIC4uLmN0LmNsaWVudCxcbiAgICAgIH0pKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc29sZS5lcnJvcihcbiAgICAgICAgJ0Vycm9yIHJldHJpZXZpbmcgYWxsIGNsaWVudHM6JyxcbiAgICAgICAgZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiBlcnJvcixcbiAgICAgICk7XG4gICAgICB0aHJvdyBuZXcgSW50ZXJuYWxTZXJ2ZXJFcnJvckV4Y2VwdGlvbignRmFpbGVkIHRvIHJldHJpZXZlIGFsbCBjbGllbnRzJyk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgZ2V0Q2xpZW50QnlJZCh0aGVyYXBpc3RJZDogc3RyaW5nLCBjbGllbnRJZDogc3RyaW5nKTogUHJvbWlzZTxhbnk+IHtcbiAgICB0cnkge1xuICAgICAgLy8gRmluZCB0aGUgc3BlY2lmaWMgY2xpZW50IGFzc2lnbmVkIHRvIHRoaXMgdGhlcmFwaXN0XG4gICAgICBjb25zdCBhc3NpZ25lZENsaWVudCA9IGF3YWl0IHRoaXMucHJpc21hLmNsaWVudFRoZXJhcGlzdC5maW5kRmlyc3Qoe1xuICAgICAgICB3aGVyZTogeyB0aGVyYXBpc3RJZDogdGhlcmFwaXN0SWQsIGNsaWVudElkOiBjbGllbnRJZCB9LFxuICAgICAgICBpbmNsdWRlOiB7IGNsaWVudDogeyBpbmNsdWRlOiB7IHVzZXI6IHRydWUgfSB9IH0sXG4gICAgICB9KTtcbiAgICAgIGlmICghYXNzaWduZWRDbGllbnQpIHtcbiAgICAgICAgdGhyb3cgbmV3IE5vdEZvdW5kRXhjZXB0aW9uKCdDbGllbnQgbm90IGZvdW5kJyk7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiBhc3NpZ25lZENsaWVudC5jbGllbnQ7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoXG4gICAgICAgICdFcnJvciByZXRyaWV2aW5nIGNsaWVudCBieSBJRDonLFxuICAgICAgICBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6IGVycm9yLFxuICAgICAgKTtcbiAgICAgIHRocm93IG5ldyBJbnRlcm5hbFNlcnZlckVycm9yRXhjZXB0aW9uKCdGYWlsZWQgdG8gcmV0cmlldmUgY2xpZW50IGJ5IElEJyk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgZ2V0UHJvZmlsZSh0aGVyYXBpc3RJZDogc3RyaW5nKTogUHJvbWlzZTxhbnk+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgdGhlcmFwaXN0ID0gYXdhaXQgdGhpcy5wcmlzbWEudGhlcmFwaXN0LmZpbmRVbmlxdWVPclRocm93KHtcbiAgICAgICAgd2hlcmU6IHsgdXNlcklkOiB0aGVyYXBpc3RJZCB9LFxuICAgICAgICBpbmNsdWRlOiB7XG4gICAgICAgICAgdXNlcjogdHJ1ZSxcbiAgICAgICAgfSxcbiAgICAgIH0pO1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgLi4udGhlcmFwaXN0LFxuICAgICAgICAvLyBNYXAgZGF0YWJhc2UgZmllbGRzIHRvIGZyb250ZW5kLWV4cGVjdGVkIGZpZWxkc1xuICAgICAgICBzcGVjaWFsdGllczogdGhlcmFwaXN0LmFyZWFzT2ZFeHBlcnRpc2UgfHwgW10sXG4gICAgICAgIHRyZWF0bWVudFN1Y2Nlc3NSYXRlczpcbiAgICAgICAgICAodGhlcmFwaXN0LnRyZWF0bWVudFN1Y2Nlc3NSYXRlcyBhcyBSZWNvcmQ8c3RyaW5nLCBhbnk+KSB8fCB7fSxcbiAgICAgICAgaG91cmx5UmF0ZTogdGhlcmFwaXN0LmhvdXJseVJhdGUsXG4gICAgICB9O1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBjb25zb2xlLmVycm9yKFxuICAgICAgICAnRXJyb3IgcmV0cmlldmluZyB0aGVyYXBpc3QgcHJvZmlsZTonLFxuICAgICAgICBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6IGVycm9yLFxuICAgICAgKTtcbiAgICAgIHRocm93IG5ldyBJbnRlcm5hbFNlcnZlckVycm9yRXhjZXB0aW9uKFxuICAgICAgICAnRmFpbGVkIHRvIHJldHJpZXZlIHRoZXJhcGlzdCBwcm9maWxlJyxcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgdXBkYXRlUHJvZmlsZShcbiAgICB0aGVyYXBpc3RJZDogc3RyaW5nLFxuICAgIGRhdGE6IFByaXNtYS5UaGVyYXBpc3RVcGRhdGVJbnB1dCxcbiAgKTogUHJvbWlzZTxhbnk+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgdXBkYXRlZFRoZXJhcGlzdCA9IGF3YWl0IHRoaXMucHJpc21hLnRoZXJhcGlzdC51cGRhdGUoe1xuICAgICAgICB3aGVyZTogeyB1c2VySWQ6IHRoZXJhcGlzdElkIH0sXG4gICAgICAgIGRhdGEsXG4gICAgICAgIGluY2x1ZGU6IHtcbiAgICAgICAgICB1c2VyOiB0cnVlLFxuICAgICAgICB9LFxuICAgICAgfSk7XG4gICAgICByZXR1cm4ge1xuICAgICAgICAuLi51cGRhdGVkVGhlcmFwaXN0LFxuICAgICAgICAvLyBNYXAgZGF0YWJhc2UgZmllbGRzIHRvIGZyb250ZW5kLWV4cGVjdGVkIGZpZWxkc1xuICAgICAgICBzcGVjaWFsdGllczogdXBkYXRlZFRoZXJhcGlzdC5hcmVhc09mRXhwZXJ0aXNlIHx8IFtdLFxuICAgICAgICB0cmVhdG1lbnRTdWNjZXNzUmF0ZXM6XG4gICAgICAgICAgKHVwZGF0ZWRUaGVyYXBpc3QudHJlYXRtZW50U3VjY2Vzc1JhdGVzIGFzIFJlY29yZDxzdHJpbmcsIGFueT4pIHx8IHt9LFxuICAgICAgICBob3VybHlSYXRlOiB1cGRhdGVkVGhlcmFwaXN0LmhvdXJseVJhdGUsXG4gICAgICB9O1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBjb25zb2xlLmVycm9yKFxuICAgICAgICAnRXJyb3IgdXBkYXRpbmcgdGhlcmFwaXN0IHByb2ZpbGU6JyxcbiAgICAgICAgZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiBlcnJvcixcbiAgICAgICk7XG4gICAgICB0aHJvdyBuZXcgSW50ZXJuYWxTZXJ2ZXJFcnJvckV4Y2VwdGlvbihcbiAgICAgICAgJ0ZhaWxlZCB0byB1cGRhdGUgdGhlcmFwaXN0IHByb2ZpbGUnLFxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBnZXRNYXRjaGVkQ2xpZW50cyh0aGVyYXBpc3RJZDogc3RyaW5nKTogUHJvbWlzZTxhbnk+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgdGhpcnR5RGF5c0FnbyA9IG5ldyBEYXRlKCk7XG4gICAgICB0aGlydHlEYXlzQWdvLnNldERhdGUodGhpcnR5RGF5c0Fnby5nZXREYXRlKCkgLSAzMCk7XG5cbiAgICAgIC8vIEdldCBhbGwgbWF0Y2hlZCBjbGllbnRzIChubyBzdGF0dXMgbmVlZGVkIC0gYWxsIHJlbGF0aW9uc2hpcHMgYXJlIGFjdGl2ZSlcbiAgICAgIGNvbnN0IGFsbE1hdGNoZXMgPSBhd2FpdCB0aGlzLnByaXNtYS5jbGllbnRUaGVyYXBpc3QuZmluZE1hbnkoe1xuICAgICAgICB3aGVyZTogeyBcbiAgICAgICAgICB0aGVyYXBpc3RJZDogdGhlcmFwaXN0SWRcbiAgICAgICAgfSxcbiAgICAgICAgaW5jbHVkZTogeyBcbiAgICAgICAgICBjbGllbnQ6IHsgXG4gICAgICAgICAgICBpbmNsdWRlOiB7IFxuICAgICAgICAgICAgICB1c2VyOiB0cnVlLFxuICAgICAgICAgICAgICBwcmVBc3Nlc3NtZW50OiB7XG4gICAgICAgICAgICAgICAgc2VsZWN0OiB7XG4gICAgICAgICAgICAgICAgICBpZDogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgIGNyZWF0ZWRBdDogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgIGFuc3dlcnM6IHRydWVcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gXG4gICAgICAgICAgfSBcbiAgICAgICAgfSxcbiAgICAgICAgb3JkZXJCeTogeyBhc3NpZ25lZEF0OiAnZGVzYycgfVxuICAgICAgfSk7XG5cbiAgICAgIC8vIFNlcGFyYXRlIHJlY2VudCBtYXRjaGVzIChsYXN0IDMwIGRheXMpIGZyb20gb2xkZXIgb25lc1xuICAgICAgY29uc3QgcmVjZW50TWF0Y2hlcyA9IGFsbE1hdGNoZXMuZmlsdGVyKG1hdGNoID0+IFxuICAgICAgICBuZXcgRGF0ZShtYXRjaC5hc3NpZ25lZEF0KSA+PSB0aGlydHlEYXlzQWdvXG4gICAgICApO1xuXG4gICAgICBjb25zdCBvbGRlck1hdGNoZXMgPSBhbGxNYXRjaGVzLmZpbHRlcihtYXRjaCA9PiBcbiAgICAgICAgbmV3IERhdGUobWF0Y2guYXNzaWduZWRBdCkgPCB0aGlydHlEYXlzQWdvXG4gICAgICApO1xuXG4gICAgICAvLyBGb3JtYXQgdGhlIHJlc3BvbnNlIHdpdGggYWRkaXRpb25hbCBtZXRhZGF0YVxuICAgICAgY29uc3QgZm9ybWF0Q2xpZW50TWF0Y2ggPSAocmVsYXRpb25zaGlwOiBhbnkpID0+IHtcbiAgICAgICAgY29uc3QgbGF0ZXN0QXNzZXNzbWVudCA9IHJlbGF0aW9uc2hpcC5jbGllbnQucHJlQXNzZXNzbWVudDtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICByZWxhdGlvbnNoaXBJZDogcmVsYXRpb25zaGlwLmlkLFxuICAgICAgICAgIGNsaWVudDoge1xuICAgICAgICAgICAgaWQ6IHJlbGF0aW9uc2hpcC5jbGllbnQudXNlcklkLFxuICAgICAgICAgICAgZmlyc3ROYW1lOiByZWxhdGlvbnNoaXAuY2xpZW50LnVzZXIuZmlyc3ROYW1lLFxuICAgICAgICAgICAgbGFzdE5hbWU6IHJlbGF0aW9uc2hpcC5jbGllbnQudXNlci5sYXN0TmFtZSxcbiAgICAgICAgICAgIGVtYWlsOiByZWxhdGlvbnNoaXAuY2xpZW50LnVzZXIuZW1haWwsXG4gICAgICAgICAgICBwcm9maWxlUGljdHVyZTogcmVsYXRpb25zaGlwLmNsaWVudC51c2VyLnByb2ZpbGVQaWN0dXJlLFxuICAgICAgICAgICAgam9pbmVkQXQ6IHJlbGF0aW9uc2hpcC5jbGllbnQudXNlci5jcmVhdGVkQXQsXG4gICAgICAgICAgfSxcbiAgICAgICAgICBtYXRjaEluZm86IHtcbiAgICAgICAgICAgIGFzc2lnbmVkQXQ6IHJlbGF0aW9uc2hpcC5hc3NpZ25lZEF0LFxuICAgICAgICAgICAgZGF5c1NpbmNlTWF0Y2g6IE1hdGguZmxvb3IoKERhdGUubm93KCkgLSBuZXcgRGF0ZShyZWxhdGlvbnNoaXAuYXNzaWduZWRBdCkuZ2V0VGltZSgpKSAvICgxMDAwICogNjAgKiA2MCAqIDI0KSksXG4gICAgICAgICAgfSxcbiAgICAgICAgICBhc3Nlc3NtZW50SW5mbzogbGF0ZXN0QXNzZXNzbWVudCA/IHtcbiAgICAgICAgICAgIGhhc0Fzc2Vzc21lbnQ6IHRydWUsXG4gICAgICAgICAgICBjb21wbGV0ZWRBdDogbGF0ZXN0QXNzZXNzbWVudC5jcmVhdGVkQXQsXG4gICAgICAgICAgICBhc3Nlc3NtZW50VHlwZTogJ1ByZS1Bc3Nlc3NtZW50JyxcbiAgICAgICAgICAgIGRheXNTaW5jZUFzc2Vzc21lbnQ6IE1hdGguZmxvb3IoKERhdGUubm93KCkgLSBuZXcgRGF0ZShsYXRlc3RBc3Nlc3NtZW50LmNyZWF0ZWRBdCkuZ2V0VGltZSgpKSAvICgxMDAwICogNjAgKiA2MCAqIDI0KSksXG4gICAgICAgICAgfSA6IHtcbiAgICAgICAgICAgIGhhc0Fzc2Vzc21lbnQ6IGZhbHNlLFxuICAgICAgICAgICAgY29tcGxldGVkQXQ6IG51bGwsXG4gICAgICAgICAgICBhc3Nlc3NtZW50VHlwZTogbnVsbCxcbiAgICAgICAgICAgIGRheXNTaW5jZUFzc2Vzc21lbnQ6IG51bGwsXG4gICAgICAgICAgfVxuICAgICAgICB9O1xuICAgICAgfTtcblxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgcmVjZW50TWF0Y2hlczogcmVjZW50TWF0Y2hlcy5tYXAoZm9ybWF0Q2xpZW50TWF0Y2gpLFxuICAgICAgICBhbGxNYXRjaGVzOiBhbGxNYXRjaGVzLm1hcChmb3JtYXRDbGllbnRNYXRjaCksXG4gICAgICAgIHN1bW1hcnk6IHtcbiAgICAgICAgICB0b3RhbFJlY2VudE1hdGNoZXM6IHJlY2VudE1hdGNoZXMubGVuZ3RoLFxuICAgICAgICAgIHRvdGFsQWxsTWF0Y2hlczogYWxsTWF0Y2hlcy5sZW5ndGgsXG4gICAgICAgICAgdG90YWxNYXRjaGVzOiBhbGxNYXRjaGVzLmxlbmd0aCxcbiAgICAgICAgfVxuICAgICAgfTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc29sZS5lcnJvcihcbiAgICAgICAgJ0Vycm9yIHJldHJpZXZpbmcgbWF0Y2hlZCBjbGllbnRzOicsXG4gICAgICAgIGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogZXJyb3IsXG4gICAgICApO1xuICAgICAgdGhyb3cgbmV3IEludGVybmFsU2VydmVyRXJyb3JFeGNlcHRpb24oXG4gICAgICAgICdGYWlsZWQgdG8gcmV0cmlldmUgbWF0Y2hlZCBjbGllbnRzJyxcbiAgICAgICk7XG4gICAgfVxuICB9XG59XG4iXSwidmVyc2lvbiI6M30=