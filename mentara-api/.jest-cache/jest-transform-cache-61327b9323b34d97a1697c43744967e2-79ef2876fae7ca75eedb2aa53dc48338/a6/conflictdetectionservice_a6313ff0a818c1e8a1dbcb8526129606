192a67ef1277121633b777ab941cc689
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
exports.ConflictDetectionService = void 0;
const common_1 = require("@nestjs/common");
const prisma_client_provider_1 = require("../../providers/prisma-client.provider");
let ConflictDetectionService = class ConflictDetectionService {
    prisma;
    constructor(prisma) {
        this.prisma = prisma;
    }
    /**
     * Check for scheduling conflicts for both therapist and client
     */
    async checkSchedulingConflicts(therapistId, clientId, startTime, duration) {
        const endTime = new Date(startTime.getTime() + duration * 60 * 1000);
        const timeRange = { startTime, endTime };
        const [therapistConflicts, clientConflicts] = await Promise.all([
            this.checkTherapistConflicts(therapistId, timeRange),
            this.checkClientConflicts(clientId, timeRange),
        ]);
        const hasConflict = therapistConflicts.length > 0 || clientConflicts.length > 0;
        let conflictType = 'none';
        if (therapistConflicts.length > 0 && clientConflicts.length > 0) {
            conflictType = 'both';
        }
        else if (therapistConflicts.length > 0) {
            conflictType = 'therapist';
        }
        else if (clientConflicts.length > 0) {
            conflictType = 'client';
        }
        return {
            hasConflict,
            conflictingMeetings: [...therapistConflicts, ...clientConflicts],
            conflictType,
        };
    }
    /**
     * Check for conflicts in therapist's schedule
     */
    async checkTherapistConflicts(therapistId, timeRange) {
        return this.findConflictingMeetings({
            therapistId,
            timeRange,
            statuses: ['SCHEDULED', 'CONFIRMED', 'IN_PROGRESS'],
        });
    }
    /**
     * Check for conflicts in client's schedule
     */
    async checkClientConflicts(clientId, timeRange) {
        return this.findConflictingMeetings({
            clientId,
            timeRange,
            statuses: ['SCHEDULED', 'CONFIRMED', 'IN_PROGRESS'],
        });
    }
    /**
     * Check if updating a meeting would cause conflicts
     */
    async checkUpdateConflicts(meetingId, therapistId, clientId, newStartTime, newDuration) {
        const endTime = new Date(newStartTime.getTime() + newDuration * 60 * 1000);
        const timeRange = { startTime: newStartTime, endTime };
        // Find conflicts excluding the current meeting
        const conflicts = await this.findConflictingMeetings({
            therapistId,
            clientId,
            timeRange,
            statuses: ['SCHEDULED', 'CONFIRMED', 'IN_PROGRESS'],
            excludeMeetingId: meetingId,
        });
        const therapistConflicts = conflicts.filter((m) => m.therapistId === therapistId);
        const clientConflicts = conflicts.filter((m) => m.clientId === clientId);
        const hasConflict = conflicts.length > 0;
        let conflictType = 'none';
        if (therapistConflicts.length > 0 && clientConflicts.length > 0) {
            conflictType = 'both';
        }
        else if (therapistConflicts.length > 0) {
            conflictType = 'therapist';
        }
        else if (clientConflicts.length > 0) {
            conflictType = 'client';
        }
        return {
            hasConflict,
            conflictingMeetings: conflicts,
            conflictType,
        };
    }
    /**
     * Check for conflicts when bulk scheduling multiple meetings
     */
    async checkBulkConflicts(meetings) {
        const conflicts = [];
        for (let i = 0; i < meetings.length; i++) {
            const meeting = meetings[i];
            // Check against existing meetings
            const existingConflicts = await this.checkSchedulingConflicts(meeting.therapistId, meeting.clientId, meeting.startTime, meeting.duration);
            // Check against other meetings in the bulk operation
            const internalConflicts = this.checkInternalConflicts(meeting, meetings, i);
            if (existingConflicts.hasConflict || internalConflicts.length > 0) {
                conflicts.push({
                    meetingIndex: i,
                    conflicts: {
                        hasConflict: true,
                        conflictingMeetings: [
                            ...existingConflicts.conflictingMeetings,
                            ...internalConflicts,
                        ],
                        conflictType: existingConflicts.conflictType,
                    },
                });
            }
        }
        return conflicts;
    }
    async findConflictingMeetings({ therapistId, clientId, timeRange, statuses, excludeMeetingId, }) {
        const whereConditions = [];
        // Build more efficient query conditions using the new endTime field
        const overlapCondition = {
            startTime: { lt: timeRange.endTime },
            OR: [
                { endTime: { gt: timeRange.startTime } }, // Meeting ends after our start
                {
                    // Fallback for meetings without endTime (legacy data)
                    AND: [
                        { endTime: null },
                        {
                            // Calculate endTime on the fly for legacy meetings
                            startTime: { gte: timeRange.startTime },
                        },
                    ],
                },
            ],
            status: { in: statuses },
        };
        // Add therapist condition
        if (therapistId) {
            whereConditions.push({
                therapistId,
                ...overlapCondition,
            });
        }
        // Add client condition
        if (clientId) {
            whereConditions.push({
                clientId,
                ...overlapCondition,
            });
        }
        if (whereConditions.length === 0) {
            return [];
        }
        const meetings = await this.prisma.meeting.findMany({
            where: {
                OR: whereConditions,
                ...(excludeMeetingId && { id: { not: excludeMeetingId } }),
            },
            include: {
                client: {
                    select: {
                        user: {
                            select: { firstName: true, lastName: true },
                        },
                    },
                },
                therapist: {
                    select: {
                        user: {
                            select: { firstName: true, lastName: true },
                        },
                    },
                },
            },
        });
        // Additional filtering for meetings without endTime (legacy data)
        return meetings.filter((meeting) => {
            const meetingEndTime = meeting.endTime ||
                new Date(meeting.startTime.getTime() + meeting.duration * 60 * 1000);
            return this.hasTimeOverlap(timeRange.startTime, timeRange.endTime, meeting.startTime, meetingEndTime);
        });
    }
    checkInternalConflicts(currentMeeting, allMeetings, currentIndex) {
        const conflicts = [];
        const currentEndTime = new Date(currentMeeting.startTime.getTime() + currentMeeting.duration * 60 * 1000);
        for (let i = 0; i < allMeetings.length; i++) {
            if (i === currentIndex)
                continue;
            const otherMeeting = allMeetings[i];
            const otherEndTime = new Date(otherMeeting.startTime.getTime() + otherMeeting.duration * 60 * 1000);
            // Check if meetings involve the same people
            const sameTherapist = currentMeeting.therapistId === otherMeeting.therapistId;
            const sameClient = currentMeeting.clientId === otherMeeting.clientId;
            if ((sameTherapist || sameClient) &&
                this.hasTimeOverlap(currentMeeting.startTime, currentEndTime, otherMeeting.startTime, otherEndTime)) {
                conflicts.push({
                    ...otherMeeting,
                    conflictType: sameTherapist && sameClient
                        ? 'both'
                        : sameTherapist
                            ? 'therapist'
                            : 'client',
                    isInternalConflict: true,
                    conflictIndex: i,
                });
            }
        }
        return conflicts;
    }
    /**
     * Check if two time ranges overlap
     */
    hasTimeOverlap(start1, end1, start2, end2) {
        return start1 < end2 && end1 > start2;
    }
    /**
     * Validate that a proposed meeting time doesn't conflict
     * Throws BadRequestException if conflicts are found
     */
    async validateNoConflicts(therapistId, clientId, startTime, duration) {
        const conflicts = await this.checkSchedulingConflicts(therapistId, clientId, startTime, duration);
        if (conflicts.hasConflict) {
            const conflictMessages = conflicts.conflictingMeetings.map((meeting) => {
                const meetingStart = meeting.startTime.toLocaleString();
                const meetingEnd = new Date(meeting.startTime.getTime() + meeting.duration * 60000).toLocaleString();
                return `Meeting from ${meetingStart} to ${meetingEnd}`;
            });
            throw new common_1.BadRequestException(`Time slot conflicts with existing meetings: ${conflictMessages.join(', ')}`);
        }
    }
};
exports.ConflictDetectionService = ConflictDetectionService;
exports.ConflictDetectionService = ConflictDetectionService = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [typeof (_a = typeof prisma_client_provider_1.PrismaService !== "undefined" && prisma_client_provider_1.PrismaService) === "function" ? _a : Object])
], ConflictDetectionService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL2Jvb2tpbmcvc2VydmljZXMvY29uZmxpY3QtZGV0ZWN0aW9uLnNlcnZpY2UudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7OztBQUFBLDJDQUFpRTtBQUNqRSxtRkFBdUU7QUFjaEUsSUFBTSx3QkFBd0IsR0FBOUIsTUFBTSx3QkFBd0I7SUFDTjtJQUE3QixZQUE2QixNQUFxQjtRQUFyQixXQUFNLEdBQU4sTUFBTSxDQUFlO0lBQUcsQ0FBQztJQUV0RDs7T0FFRztJQUNILEtBQUssQ0FBQyx3QkFBd0IsQ0FDNUIsV0FBbUIsRUFDbkIsUUFBZ0IsRUFDaEIsU0FBZSxFQUNmLFFBQWdCO1FBRWhCLE1BQU0sT0FBTyxHQUFHLElBQUksSUFBSSxDQUFDLFNBQVMsQ0FBQyxPQUFPLEVBQUUsR0FBRyxRQUFRLEdBQUcsRUFBRSxHQUFHLElBQUksQ0FBQyxDQUFDO1FBQ3JFLE1BQU0sU0FBUyxHQUFHLEVBQUUsU0FBUyxFQUFFLE9BQU8sRUFBRSxDQUFDO1FBRXpDLE1BQU0sQ0FBQyxrQkFBa0IsRUFBRSxlQUFlLENBQUMsR0FBRyxNQUFNLE9BQU8sQ0FBQyxHQUFHLENBQUM7WUFDOUQsSUFBSSxDQUFDLHVCQUF1QixDQUFDLFdBQVcsRUFBRSxTQUFTLENBQUM7WUFDcEQsSUFBSSxDQUFDLG9CQUFvQixDQUFDLFFBQVEsRUFBRSxTQUFTLENBQUM7U0FDL0MsQ0FBQyxDQUFDO1FBRUgsTUFBTSxXQUFXLEdBQ2Ysa0JBQWtCLENBQUMsTUFBTSxHQUFHLENBQUMsSUFBSSxlQUFlLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQztRQUM5RCxJQUFJLFlBQVksR0FBNkMsTUFBTSxDQUFDO1FBRXBFLElBQUksa0JBQWtCLENBQUMsTUFBTSxHQUFHLENBQUMsSUFBSSxlQUFlLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRSxDQUFDO1lBQ2hFLFlBQVksR0FBRyxNQUFNLENBQUM7UUFDeEIsQ0FBQzth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SUFBSSxDQUFDLHdCQUF3QixDQUNuRCxXQUFXLEVBQ1gsUUFBUSxFQUNSLFNBQVMsRUFDVCxRQUFRLENBQ1QsQ0FBQztRQUVGLElBQUksU0FBUyxDQUFDLFdBQVcsRUFBRSxDQUFDO1lBQzFCLE1BQU0sZ0JBQWdCLEdBQUcsU0FBUyxDQUFDLG1CQUFtQixDQUFDLEdBQUcsQ0FBQyxDQUFDLE9BQU8sRUFBRSxFQUFFO2dCQUNyRSxNQUFNLFlBQVksR0FBRyxPQUFPLENBQUMsU0FBUyxDQUFDLGNBQWMsRUFBRSxDQUFDO2dCQUN4RCxNQUFNLFVBQVUsR0FBRyxJQUFJLElBQUksQ0FDekIsT0FBTyxDQUFDLFNBQVMsQ0FBQyxPQUFPLEVBQUUsR0FBRyxPQUFPLENBQUMsUUFBUSxHQUFHLEtBQUssQ0FDdkQsQ0FBQyxjQUFjLEVBQUUsQ0FBQztnQkFDbkIsT0FBTyxnQkFBZ0IsWUFBWSxPQUFPLFVBQVUsRUFBRSxDQUFDO1lBQ3pELENBQUMsQ0FBQyxDQUFDO1lBRUgsTUFBTSxJQUFJLDRCQUFtQixDQUMzQiwrQ0FBK0MsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQzdFLENBQUM7UUFDSixDQUFDO0lBQ0gsQ0FBQztDQUNGLENBQUE7QUE3VlksNERBQXdCO21DQUF4Qix3QkFBd0I7SUFEcEMsSUFBQSxtQkFBVSxHQUFFO3lEQUUwQixzQ0FBYSxvQkFBYixzQ0FBYTtHQUR2Qyx3QkFBd0IsQ0E2VnBDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9ob21lL3dldG9vYS9Eb2N1bWVudHMvY29kZS9wcm9qZWN0cy9tZW50YXJhL21lbnRhcmEtYXBpL3NyYy9ib29raW5nL3NlcnZpY2VzL2NvbmZsaWN0LWRldGVjdGlvbi5zZXJ2aWNlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUsIEJhZFJlcXVlc3RFeGNlcHRpb24gfSBmcm9tICdAbmVzdGpzL2NvbW1vbic7XG5pbXBvcnQgeyBQcmlzbWFTZXJ2aWNlIH0gZnJvbSAnLi4vLi4vcHJvdmlkZXJzL3ByaXNtYS1jbGllbnQucHJvdmlkZXInO1xuXG5leHBvcnQgaW50ZXJmYWNlIFRpbWVSYW5nZSB7XG4gIHN0YXJ0VGltZTogRGF0ZTtcbiAgZW5kVGltZTogRGF0ZTtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBDb25mbGljdFJlc3VsdCB7XG4gIGhhc0NvbmZsaWN0OiBib29sZWFuO1xuICBjb25mbGljdGluZ01lZXRpbmdzOiBhbnlbXTtcbiAgY29uZmxpY3RUeXBlOiAndGhlcmFwaXN0JyB8ICdjbGllbnQnIHwgJ2JvdGgnIHwgJ25vbmUnO1xufVxuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgQ29uZmxpY3REZXRlY3Rpb25TZXJ2aWNlIHtcbiAgY29uc3RydWN0b3IocHJpdmF0ZSByZWFkb25seSBwcmlzbWE6IFByaXNtYVNlcnZpY2UpIHt9XG5cbiAgLyoqXG4gICAqIENoZWNrIGZvciBzY2hlZHVsaW5nIGNvbmZsaWN0cyBmb3IgYm90aCB0aGVyYXBpc3QgYW5kIGNsaWVudFxuICAgKi9cbiAgYXN5bmMgY2hlY2tTY2hlZHVsaW5nQ29uZmxpY3RzKFxuICAgIHRoZXJhcGlzdElkOiBzdHJpbmcsXG4gICAgY2xpZW50SWQ6IHN0cmluZyxcbiAgICBzdGFydFRpbWU6IERhdGUsXG4gICAgZHVyYXRpb246IG51bWJlcixcbiAgKTogUHJvbWlzZTxDb25mbGljdFJlc3VsdD4ge1xuICAgIGNvbnN0IGVuZFRpbWUgPSBuZXcgRGF0ZShzdGFydFRpbWUuZ2V0VGltZSgpICsgZHVyYXRpb24gKiA2MCAqIDEwMDApO1xuICAgIGNvbnN0IHRpbWVSYW5nZSA9IHsgc3RhcnRUaW1lLCBlbmRUaW1lIH07XG5cbiAgICBjb25zdCBbdGhlcmFwaXN0Q29uZmxpY3RzLCBjbGllbnRDb25mbGljdHNdID0gYXdhaXQgUHJvbWlzZS5hbGwoW1xuICAgICAgdGhpcy5jaGVja1RoZXJhcGlzdENvbmZsaWN0cyh0aGVyYXBpc3RJZCwgdGltZVJhbmdlKSxcbiAgICAgIHRoaXMuY2hlY2tDbGllbnRDb25mbGljdHMoY2xpZW50SWQsIHRpbWVSYW5nZSksXG4gICAgXSk7XG5cbiAgICBjb25zdCBoYXNDb25mbGljdCA9XG4gICAgICB0aGVyYXBpc3RDb25mbGljdHMubGVuZ3RoID4gMCB8fCBjbGllbnRDb25mbGljdHMubGVuZ3RoID4gMDtcbiAgICBsZXQgY29uZmxpY3RUeXBlOiAndGhlcmFwaXN0JyB8ICdjbGllbnQnIHwgJ2JvdGgnIHwgJ25vbmUnID0gJ25vbmUnO1xuXG4gICAgaWYgKHRoZXJhcGlzdENvbmZsaWN0cy5sZW5ndGggPiAwICYmIGNsaWVudENvbmZsaWN0cy5sZW5ndGggPiAwKSB7XG4gICAgICBjb25mbGljdFR5cGUgPSAnYm90aCc7XG4gICAgfSBlbHNlIGlmICh0aGVyYXBpc3RDb25mbGljdHMubGVuZ3RoID4gMCkge1xuICAgICAgY29uZmxpY3RUeXBlID0gJ3RoZXJhcGlzdCc7XG4gICAgfSBlbHNlIGlmIChjbGllbnRDb25mbGljdHMubGVuZ3RoID4gMCkge1xuICAgICAgY29uZmxpY3RUeXBlID0gJ2NsaWVudCc7XG4gICAgfVxuXG4gICAgcmV0dXJuIHtcbiAgICAgIGhhc0NvbmZsaWN0LFxuICAgICAgY29uZmxpY3RpbmdNZWV0aW5nczogWy4uLnRoZXJhcGlzdENvbmZsaWN0cywgLi4uY2xpZW50Q29uZmxpY3RzXSxcbiAgICAgIGNvbmZsaWN0VHlwZSxcbiAgICB9O1xuICB9XG5cbiAgLyoqXG4gICAqIENoZWNrIGZvciBjb25mbGljdHMgaW4gdGhlcmFwaXN0J3Mgc2NoZWR1bGVcbiAgICovXG4gIGFzeW5jIGNoZWNrVGhlcmFwaXN0Q29uZmxpY3RzKFxuICAgIHRoZXJhcGlzdElkOiBzdHJpbmcsXG4gICAgdGltZVJhbmdlOiBUaW1lUmFuZ2UsXG4gICk6IFByb21pc2U8YW55W10+IHtcbiAgICByZXR1cm4gdGhpcy5maW5kQ29uZmxpY3RpbmdNZWV0aW5ncyh7XG4gICAgICB0aGVyYXBpc3RJZCxcbiAgICAgIHRpbWVSYW5nZSxcbiAgICAgIHN0YXR1c2VzOiBbJ1NDSEVEVUxFRCcsICdDT05GSVJNRUQnLCAnSU5fUFJPR1JFU1MnXSxcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDaGVjayBmb3IgY29uZmxpY3RzIGluIGNsaWVudCdzIHNjaGVkdWxlXG4gICAqL1xuICBhc3luYyBjaGVja0NsaWVudENvbmZsaWN0cyhcbiAgICBjbGllbnRJZDogc3RyaW5nLFxuICAgIHRpbWVSYW5nZTogVGltZVJhbmdlLFxuICApOiBQcm9taXNlPGFueVtdPiB7XG4gICAgcmV0dXJuIHRoaXMuZmluZENvbmZsaWN0aW5nTWVldGluZ3Moe1xuICAgICAgY2xpZW50SWQsXG4gICAgICB0aW1lUmFuZ2UsXG4gICAgICBzdGF0dXNlczogWydTQ0hFRFVMRUQnLCAnQ09ORklSTUVEJywgJ0lOX1BST0dSRVNTJ10sXG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogQ2hlY2sgaWYgdXBkYXRpbmcgYSBtZWV0aW5nIHdvdWxkIGNhdXNlIGNvbmZsaWN0c1xuICAgKi9cbiAgYXN5bmMgY2hlY2tVcGRhdGVDb25mbGljdHMoXG4gICAgbWVldGluZ0lkOiBzdHJpbmcsXG4gICAgdGhlcmFwaXN0SWQ6IHN0cmluZyxcbiAgICBjbGllbnRJZDogc3RyaW5nLFxuICAgIG5ld1N0YXJ0VGltZTogRGF0ZSxcbiAgICBuZXdEdXJhdGlvbjogbnVtYmVyLFxuICApOiBQcm9taXNlPENvbmZsaWN0UmVzdWx0PiB7XG4gICAgY29uc3QgZW5kVGltZSA9IG5ldyBEYXRlKG5ld1N0YXJ0VGltZS5nZXRUaW1lKCkgKyBuZXdEdXJhdGlvbiAqIDYwICogMTAwMCk7XG4gICAgY29uc3QgdGltZVJhbmdlID0geyBzdGFydFRpbWU6IG5ld1N0YXJ0VGltZSwgZW5kVGltZSB9O1xuXG4gICAgLy8gRmluZCBjb25mbGljdHMgZXhjbHVkaW5nIHRoZSBjdXJyZW50IG1lZXRpbmdcbiAgICBjb25zdCBjb25mbGljdHMgPSBhd2FpdCB0aGlzLmZpbmRDb25mbGljdGluZ01lZXRpbmdzKHtcbiAgICAgIHRoZXJhcGlzdElkLFxuICAgICAgY2xpZW50SWQsXG4gICAgICB0aW1lUmFuZ2UsXG4gICAgICBzdGF0dXNlczogWydTQ0hFRFVMRUQnLCAnQ09ORklSTUVEJywgJ0lOX1BST0dSRVNTJ10sXG4gICAgICBleGNsdWRlTWVldGluZ0lkOiBtZWV0aW5nSWQsXG4gICAgfSk7XG5cbiAgICBjb25zdCB0aGVyYXBpc3RDb25mbGljdHMgPSBjb25mbGljdHMuZmlsdGVyKFxuICAgICAgKG0pID0+IG0udGhlcmFwaXN0SWQgPT09IHRoZXJhcGlzdElkLFxuICAgICk7XG4gICAgY29uc3QgY2xpZW50Q29uZmxpY3RzID0gY29uZmxpY3RzLmZpbHRlcigobSkgPT4gbS5jbGllbnRJZCA9PT0gY2xpZW50SWQpO1xuXG4gICAgY29uc3QgaGFzQ29uZmxpY3QgPSBjb25mbGljdHMubGVuZ3RoID4gMDtcbiAgICBsZXQgY29uZmxpY3RUeXBlOiAndGhlcmFwaXN0JyB8ICdjbGllbnQnIHwgJ2JvdGgnIHwgJ25vbmUnID0gJ25vbmUnO1xuXG4gICAgaWYgKHRoZXJhcGlzdENvbmZsaWN0cy5sZW5ndGggPiAwICYmIGNsaWVudENvbmZsaWN0cy5sZW5ndGggPiAwKSB7XG4gICAgICBjb25mbGljdFR5cGUgPSAnYm90aCc7XG4gICAgfSBlbHNlIGlmICh0aGVyYXBpc3RDb25mbGljdHMubGVuZ3RoID4gMCkge1xuICAgICAgY29uZmxpY3RUeXBlID0gJ3RoZXJhcGlzdCc7XG4gICAgfSBlbHNlIGlmIChjbGllbnRDb25mbGljdHMubGVuZ3RoID4gMCkge1xuICAgICAgY29uZmxpY3RUeXBlID0gJ2NsaWVudCc7XG4gICAgfVxuXG4gICAgcmV0dXJuIHtcbiAgICAgIGhhc0NvbmZsaWN0LFxuICAgICAgY29uZmxpY3RpbmdNZWV0aW5nczogY29uZmxpY3RzLFxuICAgICAgY29uZmxpY3RUeXBlLFxuICAgIH07XG4gIH1cblxuICAvKipcbiAgICogQ2hlY2sgZm9yIGNvbmZsaWN0cyB3aGVuIGJ1bGsgc2NoZWR1bGluZyBtdWx0aXBsZSBtZWV0aW5nc1xuICAgKi9cbiAgYXN5bmMgY2hlY2tCdWxrQ29uZmxpY3RzKFxuICAgIG1lZXRpbmdzOiBBcnJheTx7XG4gICAgICB0aGVyYXBpc3RJZDogc3RyaW5nO1xuICAgICAgY2xpZW50SWQ6IHN0cmluZztcbiAgICAgIHN0YXJ0VGltZTogRGF0ZTtcbiAgICAgIGR1cmF0aW9uOiBudW1iZXI7XG4gICAgfT4sXG4gICk6IFByb21pc2U8eyBtZWV0aW5nSW5kZXg6IG51bWJlcjsgY29uZmxpY3RzOiBDb25mbGljdFJlc3VsdCB9W10+IHtcbiAgICBjb25zdCBjb25mbGljdHM6IHsgbWVldGluZ0luZGV4OiBudW1iZXI7IGNvbmZsaWN0czogQ29uZmxpY3RSZXN1bHQgfVtdID0gW107XG5cbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IG1lZXRpbmdzLmxlbmd0aDsgaSsrKSB7XG4gICAgICBjb25zdCBtZWV0aW5nID0gbWVldGluZ3NbaV07XG5cbiAgICAgIC8vIENoZWNrIGFnYWluc3QgZXhpc3RpbmcgbWVldGluZ3NcbiAgICAgIGNvbnN0IGV4aXN0aW5nQ29uZmxpY3RzID0gYXdhaXQgdGhpcy5jaGVja1NjaGVkdWxpbmdDb25mbGljdHMoXG4gICAgICAgIG1lZXRpbmcudGhlcmFwaXN0SWQsXG4gICAgICAgIG1lZXRpbmcuY2xpZW50SWQsXG4gICAgICAgIG1lZXRpbmcuc3RhcnRUaW1lLFxuICAgICAgICBtZWV0aW5nLmR1cmF0aW9uLFxuICAgICAgKTtcblxuICAgICAgLy8gQ2hlY2sgYWdhaW5zdCBvdGhlciBtZWV0aW5ncyBpbiB0aGUgYnVsayBvcGVyYXRpb25cbiAgICAgIGNvbnN0IGludGVybmFsQ29uZmxpY3RzID0gdGhpcy5jaGVja0ludGVybmFsQ29uZmxpY3RzKFxuICAgICAgICBtZWV0aW5nLFxuICAgICAgICBtZWV0aW5ncyxcbiAgICAgICAgaSxcbiAgICAgICk7XG5cbiAgICAgIGlmIChleGlzdGluZ0NvbmZsaWN0cy5oYXNDb25mbGljdCB8fCBpbnRlcm5hbENvbmZsaWN0cy5sZW5ndGggPiAwKSB7XG4gICAgICAgIGNvbmZsaWN0cy5wdXNoKHtcbiAgICAgICAgICBtZWV0aW5nSW5kZXg6IGksXG4gICAgICAgICAgY29uZmxpY3RzOiB7XG4gICAgICAgICAgICBoYXNDb25mbGljdDogdHJ1ZSxcbiAgICAgICAgICAgIGNvbmZsaWN0aW5nTWVldGluZ3M6IFtcbiAgICAgICAgICAgICAgLi4uZXhpc3RpbmdDb25mbGljdHMuY29uZmxpY3RpbmdNZWV0aW5ncyxcbiAgICAgICAgICAgICAgLi4uaW50ZXJuYWxDb25mbGljdHMsXG4gICAgICAgICAgICBdLFxuICAgICAgICAgICAgY29uZmxpY3RUeXBlOiBleGlzdGluZ0NvbmZsaWN0cy5jb25mbGljdFR5cGUsXG4gICAgICAgICAgfSxcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIGNvbmZsaWN0cztcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgZmluZENvbmZsaWN0aW5nTWVldGluZ3Moe1xuICAgIHRoZXJhcGlzdElkLFxuICAgIGNsaWVudElkLFxuICAgIHRpbWVSYW5nZSxcbiAgICBzdGF0dXNlcyxcbiAgICBleGNsdWRlTWVldGluZ0lkLFxuICB9OiB7XG4gICAgdGhlcmFwaXN0SWQ/OiBzdHJpbmc7XG4gICAgY2xpZW50SWQ/OiBzdHJpbmc7XG4gICAgdGltZVJhbmdlOiBUaW1lUmFuZ2U7XG4gICAgc3RhdHVzZXM6IHN0cmluZ1tdO1xuICAgIGV4Y2x1ZGVNZWV0aW5nSWQ/OiBzdHJpbmc7XG4gIH0pOiBQcm9taXNlPGFueVtdPiB7XG4gICAgY29uc3Qgd2hlcmVDb25kaXRpb25zOiBhbnlbXSA9IFtdO1xuXG4gICAgLy8gQnVpbGQgbW9yZSBlZmZpY2llbnQgcXVlcnkgY29uZGl0aW9ucyB1c2luZyB0aGUgbmV3IGVuZFRpbWUgZmllbGRcbiAgICBjb25zdCBvdmVybGFwQ29uZGl0aW9uID0ge1xuICAgICAgc3RhcnRUaW1lOiB7IGx0OiB0aW1lUmFuZ2UuZW5kVGltZSB9LFxuICAgICAgT1I6IFtcbiAgICAgICAgeyBlbmRUaW1lOiB7IGd0OiB0aW1lUmFuZ2Uuc3RhcnRUaW1lIH0gfSwgLy8gTWVldGluZyBlbmRzIGFmdGVyIG91ciBzdGFydFxuICAgICAgICB7XG4gICAgICAgICAgLy8gRmFsbGJhY2sgZm9yIG1lZXRpbmdzIHdpdGhvdXQgZW5kVGltZSAobGVnYWN5IGRhdGEpXG4gICAgICAgICAgQU5EOiBbXG4gICAgICAgICAgICB7IGVuZFRpbWU6IG51bGwgfSxcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgLy8gQ2FsY3VsYXRlIGVuZFRpbWUgb24gdGhlIGZseSBmb3IgbGVnYWN5IG1lZXRpbmdzXG4gICAgICAgICAgICAgIHN0YXJ0VGltZTogeyBndGU6IHRpbWVSYW5nZS5zdGFydFRpbWUgfSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgXSxcbiAgICAgICAgfSxcbiAgICAgIF0sXG4gICAgICBzdGF0dXM6IHsgaW46IHN0YXR1c2VzIH0sXG4gICAgfTtcblxuICAgIC8vIEFkZCB0aGVyYXBpc3QgY29uZGl0aW9uXG4gICAgaWYgKHRoZXJhcGlzdElkKSB7XG4gICAgICB3aGVyZUNvbmRpdGlvbnMucHVzaCh7XG4gICAgICAgIHRoZXJhcGlzdElkLFxuICAgICAgICAuLi5vdmVybGFwQ29uZGl0aW9uLFxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgLy8gQWRkIGNsaWVudCBjb25kaXRpb25cbiAgICBpZiAoY2xpZW50SWQpIHtcbiAgICAgIHdoZXJlQ29uZGl0aW9ucy5wdXNoKHtcbiAgICAgICAgY2xpZW50SWQsXG4gICAgICAgIC4uLm92ZXJsYXBDb25kaXRpb24sXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICBpZiAod2hlcmVDb25kaXRpb25zLmxlbmd0aCA9PT0gMCkge1xuICAgICAgcmV0dXJuIFtdO1xuICAgIH1cblxuICAgIGNvbnN0IG1lZXRpbmdzID0gYXdhaXQgdGhpcy5wcmlzbWEubWVldGluZy5maW5kTWFueSh7XG4gICAgICB3aGVyZToge1xuICAgICAgICBPUjogd2hlcmVDb25kaXRpb25zLFxuICAgICAgICAuLi4oZXhjbHVkZU1lZXRpbmdJZCAmJiB7IGlkOiB7IG5vdDogZXhjbHVkZU1lZXRpbmdJZCB9IH0pLFxuICAgICAgfSxcbiAgICAgIGluY2x1ZGU6IHtcbiAgICAgICAgY2xpZW50OiB7XG4gICAgICAgICAgc2VsZWN0OiB7XG4gICAgICAgICAgICB1c2VyOiB7XG4gICAgICAgICAgICAgIHNlbGVjdDogeyBmaXJzdE5hbWU6IHRydWUsIGxhc3ROYW1lOiB0cnVlIH0sXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICAgIHRoZXJhcGlzdDoge1xuICAgICAgICAgIHNlbGVjdDoge1xuICAgICAgICAgICAgdXNlcjoge1xuICAgICAgICAgICAgICBzZWxlY3Q6IHsgZmlyc3ROYW1lOiB0cnVlLCBsYXN0TmFtZTogdHJ1ZSB9LFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgfSxcbiAgICB9KTtcblxuICAgIC8vIEFkZGl0aW9uYWwgZmlsdGVyaW5nIGZvciBtZWV0aW5ncyB3aXRob3V0IGVuZFRpbWUgKGxlZ2FjeSBkYXRhKVxuICAgIHJldHVybiBtZWV0aW5ncy5maWx0ZXIoKG1lZXRpbmcpID0+IHtcbiAgICAgIGNvbnN0IG1lZXRpbmdFbmRUaW1lID1cbiAgICAgICAgbWVldGluZy5lbmRUaW1lIHx8XG4gICAgICAgIG5ldyBEYXRlKG1lZXRpbmcuc3RhcnRUaW1lLmdldFRpbWUoKSArIG1lZXRpbmcuZHVyYXRpb24gKiA2MCAqIDEwMDApO1xuICAgICAgcmV0dXJuIHRoaXMuaGFzVGltZU92ZXJsYXAoXG4gICAgICAgIHRpbWVSYW5nZS5zdGFydFRpbWUsXG4gICAgICAgIHRpbWVSYW5nZS5lbmRUaW1lLFxuICAgICAgICBtZWV0aW5nLnN0YXJ0VGltZSxcbiAgICAgICAgbWVldGluZ0VuZFRpbWUsXG4gICAgICApO1xuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBjaGVja0ludGVybmFsQ29uZmxpY3RzKFxuICAgIGN1cnJlbnRNZWV0aW5nOiB7XG4gICAgICB0aGVyYXBpc3RJZDogc3RyaW5nO1xuICAgICAgY2xpZW50SWQ6IHN0cmluZztcbiAgICAgIHN0YXJ0VGltZTogRGF0ZTtcbiAgICAgIGR1cmF0aW9uOiBudW1iZXI7XG4gICAgfSxcbiAgICBhbGxNZWV0aW5nczogQXJyYXk8e1xuICAgICAgdGhlcmFwaXN0SWQ6IHN0cmluZztcbiAgICAgIGNsaWVudElkOiBzdHJpbmc7XG4gICAgICBzdGFydFRpbWU6IERhdGU7XG4gICAgICBkdXJhdGlvbjogbnVtYmVyO1xuICAgIH0+LFxuICAgIGN1cnJlbnRJbmRleDogbnVtYmVyLFxuICApOiBhbnlbXSB7XG4gICAgY29uc3QgY29uZmxpY3RzOiBhbnlbXSA9IFtdO1xuICAgIGNvbnN0IGN1cnJlbnRFbmRUaW1lID0gbmV3IERhdGUoXG4gICAgICBjdXJyZW50TWVldGluZy5zdGFydFRpbWUuZ2V0VGltZSgpICsgY3VycmVudE1lZXRpbmcuZHVyYXRpb24gKiA2MCAqIDEwMDAsXG4gICAgKTtcblxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYWxsTWVldGluZ3MubGVuZ3RoOyBpKyspIHtcbiAgICAgIGlmIChpID09PSBjdXJyZW50SW5kZXgpIGNvbnRpbnVlO1xuXG4gICAgICBjb25zdCBvdGhlck1lZXRpbmcgPSBhbGxNZWV0aW5nc1tpXTtcbiAgICAgIGNvbnN0IG90aGVyRW5kVGltZSA9IG5ldyBEYXRlKFxuICAgICAgICBvdGhlck1lZXRpbmcuc3RhcnRUaW1lLmdldFRpbWUoKSArIG90aGVyTWVldGluZy5kdXJhdGlvbiAqIDYwICogMTAwMCxcbiAgICAgICk7XG5cbiAgICAgIC8vIENoZWNrIGlmIG1lZXRpbmdzIGludm9sdmUgdGhlIHNhbWUgcGVvcGxlXG4gICAgICBjb25zdCBzYW1lVGhlcmFwaXN0ID1cbiAgICAgICAgY3VycmVudE1lZXRpbmcudGhlcmFwaXN0SWQgPT09IG90aGVyTWVldGluZy50aGVyYXBpc3RJZDtcbiAgICAgIGNvbnN0IHNhbWVDbGllbnQgPSBjdXJyZW50TWVldGluZy5jbGllbnRJZCA9PT0gb3RoZXJNZWV0aW5nLmNsaWVudElkO1xuXG4gICAgICBpZiAoXG4gICAgICAgIChzYW1lVGhlcmFwaXN0IHx8IHNhbWVDbGllbnQpICYmXG4gICAgICAgIHRoaXMuaGFzVGltZU92ZXJsYXAoXG4gICAgICAgICAgY3VycmVudE1lZXRpbmcuc3RhcnRUaW1lLFxuICAgICAgICAgIGN1cnJlbnRFbmRUaW1lLFxuICAgICAgICAgIG90aGVyTWVldGluZy5zdGFydFRpbWUsXG4gICAgICAgICAgb3RoZXJFbmRUaW1lLFxuICAgICAgICApXG4gICAgICApIHtcbiAgICAgICAgY29uZmxpY3RzLnB1c2goe1xuICAgICAgICAgIC4uLm90aGVyTWVldGluZyxcbiAgICAgICAgICBjb25mbGljdFR5cGU6XG4gICAgICAgICAgICBzYW1lVGhlcmFwaXN0ICYmIHNhbWVDbGllbnRcbiAgICAgICAgICAgICAgPyAnYm90aCdcbiAgICAgICAgICAgICAgOiBzYW1lVGhlcmFwaXN0XG4gICAgICAgICAgICAgICAgPyAndGhlcmFwaXN0J1xuICAgICAgICAgICAgICAgIDogJ2NsaWVudCcsXG4gICAgICAgICAgaXNJbnRlcm5hbENvbmZsaWN0OiB0cnVlLFxuICAgICAgICAgIGNvbmZsaWN0SW5kZXg6IGksXG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBjb25mbGljdHM7XG4gIH1cblxuICAvKipcbiAgICogQ2hlY2sgaWYgdHdvIHRpbWUgcmFuZ2VzIG92ZXJsYXBcbiAgICovXG4gIGhhc1RpbWVPdmVybGFwKHN0YXJ0MTogRGF0ZSwgZW5kMTogRGF0ZSwgc3RhcnQyOiBEYXRlLCBlbmQyOiBEYXRlKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHN0YXJ0MSA8IGVuZDIgJiYgZW5kMSA+IHN0YXJ0MjtcbiAgfVxuXG4gIC8qKlxuICAgKiBWYWxpZGF0ZSB0aGF0IGEgcHJvcG9zZWQgbWVldGluZyB0aW1lIGRvZXNuJ3QgY29uZmxpY3RcbiAgICogVGhyb3dzIEJhZFJlcXVlc3RFeGNlcHRpb24gaWYgY29uZmxpY3RzIGFyZSBmb3VuZFxuICAgKi9cbiAgYXN5bmMgdmFsaWRhdGVOb0NvbmZsaWN0cyhcbiAgICB0aGVyYXBpc3RJZDogc3RyaW5nLFxuICAgIGNsaWVudElkOiBzdHJpbmcsXG4gICAgc3RhcnRUaW1lOiBEYXRlLFxuICAgIGR1cmF0aW9uOiBudW1iZXIsXG4gICk6IFByb21pc2U8dm9pZD4ge1xuICAgIGNvbnN0IGNvbmZsaWN0cyA9IGF3YWl0IHRoaXMuY2hlY2tTY2hlZHVsaW5nQ29uZmxpY3RzKFxuICAgICAgdGhlcmFwaXN0SWQsXG4gICAgICBjbGllbnRJZCxcbiAgICAgIHN0YXJ0VGltZSxcbiAgICAgIGR1cmF0aW9uLFxuICAgICk7XG5cbiAgICBpZiAoY29uZmxpY3RzLmhhc0NvbmZsaWN0KSB7XG4gICAgICBjb25zdCBjb25mbGljdE1lc3NhZ2VzID0gY29uZmxpY3RzLmNvbmZsaWN0aW5nTWVldGluZ3MubWFwKChtZWV0aW5nKSA9PiB7XG4gICAgICAgIGNvbnN0IG1lZXRpbmdTdGFydCA9IG1lZXRpbmcuc3RhcnRUaW1lLnRvTG9jYWxlU3RyaW5nKCk7XG4gICAgICAgIGNvbnN0IG1lZXRpbmdFbmQgPSBuZXcgRGF0ZShcbiAgICAgICAgICBtZWV0aW5nLnN0YXJ0VGltZS5nZXRUaW1lKCkgKyBtZWV0aW5nLmR1cmF0aW9uICogNjAwMDAsXG4gICAgICAgICkudG9Mb2NhbGVTdHJpbmcoKTtcbiAgICAgICAgcmV0dXJuIGBNZWV0aW5nIGZyb20gJHttZWV0aW5nU3RhcnR9IHRvICR7bWVldGluZ0VuZH1gO1xuICAgICAgfSk7XG5cbiAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0RXhjZXB0aW9uKFxuICAgICAgICBgVGltZSBzbG90IGNvbmZsaWN0cyB3aXRoIGV4aXN0aW5nIG1lZXRpbmdzOiAke2NvbmZsaWN0TWVzc2FnZXMuam9pbignLCAnKX1gLFxuICAgICAgKTtcbiAgICB9XG4gIH1cbn1cbiJdLCJ2ZXJzaW9uIjozfQ==