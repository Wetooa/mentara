c585dd037e57b8f65aaaaf25fc3c7ef5
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var _a, _b, _c, _d;
Object.defineProperty(exports, "__esModule", { value: true });
exports.TherapistRecommendationService = void 0;
const common_1 = require("@nestjs/common");
const prisma_client_provider_1 = require("../providers/prisma-client.provider");
const advanced_matching_service_1 = require("./services/advanced-matching.service");
const compatibility_analysis_service_1 = require("./services/compatibility-analysis.service");
const matching_analytics_service_1 = require("./services/matching-analytics.service");
let TherapistRecommendationService = class TherapistRecommendationService {
    prisma;
    advancedMatching;
    compatibilityAnalysis;
    matchingAnalytics;
    constructor(prisma, advancedMatching, compatibilityAnalysis, matchingAnalytics) {
        this.prisma = prisma;
        this.advancedMatching = advancedMatching;
        this.compatibilityAnalysis = compatibilityAnalysis;
        this.matchingAnalytics = matchingAnalytics;
    }
    calculateYearsOfExperience(startDate) {
        const now = new Date();
        let years = now.getFullYear() - startDate.getFullYear();
        if (now.getMonth() < startDate.getMonth() ||
            (now.getMonth() === startDate.getMonth() &&
                now.getDate() < startDate.getDate())) {
            years--;
        }
        return years;
    }
    async getRecommendedTherapists(request) {
        try {
            // Get user's comprehensive data including preferences
            const user = await this.prisma.client.findUnique({
                where: { userId: request.userId },
                include: {
                    preAssessment: true,
                    clientPreferences: true,
                    user: true,
                },
            });
            if (!user)
                throw new common_1.NotFoundException('User not found');
            if (!user.preAssessment)
                throw new common_1.NotFoundException('No pre-assessment found for user');
            // Extract user conditions and severity levels
            const userConditions = this.extractUserConditions(user.preAssessment);
            const severityLevels = user.preAssessment.severityLevels;
            // Fetch therapists with comprehensive data
            const therapists = await this.prisma.therapist.findMany({
                where: {
                    status: 'approved',
                    ...(request.province && { province: request.province }),
                    ...(request.maxHourlyRate && {
                        hourlyRate: { lte: request.maxHourlyRate },
                    }),
                },
                orderBy: { createdAt: 'desc' },
                take: Math.min(request.limit ?? 10, 50), // Increase limit for better filtering
                include: {
                    user: true,
                    reviews: {
                        where: { status: 'APPROVED' },
                        select: {
                            rating: true,
                            status: true,
                        },
                    },
                },
            });
            // Use advanced matching algorithm
            const therapistScores = [];
            for (const therapist of therapists) {
                try {
                    const score = await this.advancedMatching.calculateAdvancedMatch(user, // Safe because we verified preAssessment exists above
                    therapist);
                    therapistScores.push(score);
                }
                catch (error) {
                    // Fallback to basic scoring if advanced matching fails
                    console.warn(`Advanced matching failed for therapist ${therapist.userId}:`, error);
                    const basicScore = this.calculateMatchScore(therapist, userConditions);
                    therapistScores.push({
                        therapist,
                        totalScore: basicScore,
                        breakdown: {
                            conditionScore: basicScore * 0.6,
                            approachScore: 0,
                            experienceScore: basicScore * 0.4,
                            reviewScore: 0,
                            logisticsScore: 0,
                        },
                        matchExplanation: {
                            primaryMatches: this.getPrimaryConditions(userConditions),
                            secondaryMatches: this.getSecondaryConditions(userConditions),
                            approachMatches: [],
                            experienceYears: this.calculateYearsOfExperience(therapist.practiceStartDate),
                            averageRating: 0,
                            totalReviews: 0,
                            successRates: {},
                        },
                    });
                }
            }
            // Sort by total score descending
            const sortedTherapistScores = therapistScores.sort((a, b) => b.totalScore - a.totalScore);
            // Take only the requested number of results
            const finalResults = sortedTherapistScores.slice(0, request.limit ?? 10);
            // Track recommendation analytics
            await this.matchingAnalytics.trackRecommendation(request.userId, finalResults, 'advanced_v1.0');
            // Transform to expected format
            const therapistsWithScores = finalResults.map((score) => ({
                ...score.therapist,
                matchScore: score.totalScore,
                scoreBreakdown: score.breakdown,
                matchExplanation: score.matchExplanation,
            }));
            // Determine primary and secondary conditions
            const primaryConditions = this.getPrimaryConditions(userConditions);
            const secondaryConditions = this.getSecondaryConditions(userConditions);
            return {
                totalCount: therapistsWithScores.length,
                userConditions: Object.keys(userConditions),
                therapists: therapistsWithScores,
                matchCriteria: {
                    primaryConditions,
                    secondaryConditions,
                    severityLevels,
                },
                page: 1,
                pageSize: request.limit ?? 10,
            };
        }
        catch (error) {
            throw new common_1.InternalServerErrorException(error instanceof Error
                ? error.message
                : 'Failed to get therapist recommendations');
        }
    }
    /**
     * Get detailed compatibility analysis between a client and therapist
     */
    async getCompatibilityAnalysis(clientId, therapistId) {
        const client = await this.prisma.client.findUnique({
            where: { userId: clientId },
            include: {
                preAssessment: true,
                clientPreferences: true,
                user: true,
            },
        });
        const therapist = await this.prisma.therapist.findUnique({
            where: { userId: therapistId },
            include: {
                user: true,
                reviews: {
                    where: { status: 'APPROVED' },
                },
            },
        });
        if (!client || !therapist) {
            throw new common_1.NotFoundException('Client or therapist not found');
        }
        if (!client.preAssessment) {
            throw new common_1.NotFoundException('No pre-assessment found for client');
        }
        const compatibility = await this.compatibilityAnalysis.analyzeCompatibility(client, // Safe because we verified preAssessment exists above
        therapist);
        // Track compatibility analysis
        await this.matchingAnalytics.trackCompatibilityAnalysis(clientId, therapistId, compatibility, '1.0');
        return compatibility;
    }
    extractUserConditions(preAssessment) {
        const conditions = {};
        const severityLevels = preAssessment.severityLevels;
        const questionnaires = preAssessment.questionnaires;
        questionnaires.forEach((q) => {
            if (severityLevels[q]) {
                conditions[q] = severityLevels[q];
            }
        });
        return conditions;
    }
    calculateMatchScore(therapist, userConditions) {
        let score = 0;
        const expertise = therapist.expertise || [];
        Object.keys(userConditions).forEach((condition) => {
            if (expertise.includes(condition))
                score += 20;
        });
        score += Math.min(this.calculateYearsOfExperience(therapist.practiceStartDate) * 2, 20);
        // Add base score for experience
        score += therapist.yearsOfExperience ? therapist.yearsOfExperience * 2 : 0;
        return score;
    }
    getPrimaryConditions(userConditions) {
        return Object.entries(userConditions)
            .filter(([, severity]) => this.getSeverityWeight(severity) >= 4)
            .map(([condition]) => condition);
    }
    getSecondaryConditions(userConditions) {
        return Object.entries(userConditions)
            .filter(([, severity]) => {
            const weight = this.getSeverityWeight(severity);
            return weight >= 2 && weight < 4;
        })
            .map(([condition]) => condition);
    }
    getSeverityWeight(severity) {
        const severityWeights = {
            Minimal: 1,
            Mild: 2,
            Moderate: 3,
            'Moderately Severe': 4,
            Severe: 5,
            'Very Severe': 5,
            Extreme: 5,
            Low: 1,
            High: 4,
            Substantial: 4,
            Subclinical: 1,
            Clinical: 4,
            None: 0,
            Subthreshold: 2,
            Positive: 4,
            Negative: 0,
        };
        return severityWeights[severity] || 1;
    }
};
exports.TherapistRecommendationService = TherapistRecommendationService;
exports.TherapistRecommendationService = TherapistRecommendationService = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [typeof (_a = typeof prisma_client_provider_1.PrismaService !== "undefined" && prisma_client_provider_1.PrismaService) === "function" ? _a : Object, typeof (_b = typeof advanced_matching_service_1.AdvancedMatchingService !== "undefined" && advanced_matching_service_1.AdvancedMatchingService) === "function" ? _b : Object, typeof (_c = typeof compatibility_analysis_service_1.CompatibilityAnalysisService !== "undefined" && compatibility_analysis_service_1.CompatibilityAnalysisService) === "function" ? _c : Object, typeof (_d = typeof matching_analytics_service_1.MatchingAnalyticsService !== "undefined" && matching_analytics_service_1.MatchingAnalyticsService) === "function" ? _d : Object])
], TherapistRecommendationService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL3RoZXJhcGlzdC90aGVyYXBpc3QtcmVjb21tZW5kYXRpb24uc2VydmljZS50cyIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7O0FBQUEsMkNBSXdCO0FBQ3hCLGdGQUFvRTtBQU1wRSxvRkFHOEM7QUFDOUMsOEZBQXlGO0FBQ3pGLHNGQUFpRjtBQUcxRSxJQUFNLDhCQUE4QixHQUFwQyxNQUFNLDhCQUE4QjtJQUV0QjtJQUNBO0lBQ0E7SUFDQTtJQUpuQixZQUNtQixNQUFxQixFQUNyQixnQkFBeUMsRUFDekMscUJBQW1ELEVBQ25ELGlCQUEyQztRQUgzQyxXQUFNLEdBQU4sTUFBTSxDQUFlO1FBQ3JCLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBeUI7UUFDekMsMEJBQXFCLEdBQXJCLHFCQUFxQixDQUE4QjtRQUNuRCxzQkFBaUIsR0FBakIsaUJBQWlCLENBQTBCO0lBQzNELENBQUM7SUFFSSwwQkFBMEIsQ0FBQyxTQUFlO1FBQ2hELE1BQU0sR0FBRyxHQUFHLElBQUksSUFBSSxFQUFFLENBQUM7UUFDdkIsSUFBSSxLQUFLLEdBQUcsR0FBRyxDQUFDLFdBQVcsRUFBRSxHQUFHLFNBQVMsQ0FBQyxXQUFXLEVBQUUsQ0FBQztRQUN4RCxJQUNFLEdBQUcsQ0FBQyxRQUFRLEVBQUUsR0FBRyxTQUFTLENBQUMsUUFBUSxFQUFFO1lBQ3JDLENBQUMsR0FBRyxDQUFDLFFBQVEsRUFBRSxLQUFLLFNBQVMsQ0FBQyxRQUFRLEVBQUU7Z0JBQ3RDLEdBQUcsQ0FBQyxPQUFPLEVBQUUsR0FBRyxTQUFTLENBQUMsT0FBTyxFQUFFLENBQUMsRUFDdEMsQ0FBQztZQUNELEtBQUssRUFBRSxDQUFDO1FBQ1YsQ0FBQztRQUNELE9BQU8sS0FBSyxDQUFDO0lBQ2YsQ0FBQztJQUVELEtBQUssQ0FBQyx3QkFBd0IsQ0FDNUIsT0FBdUM7UUFFdkMsSUFBSSxDQUFDO1lBQ0gsc0RBQXNEO1lBQ3RELE1BQU0s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Q2hELE9BQU8sTUFBTSxJQUFJLENBQUMsSUFBSSxNQUFNLEdBQUcsQ0FBQyxDQUFDO1FBQ25DLENBQUMsQ0FBQzthQUNELEdBQUcsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDLEVBQUUsRUFBRSxDQUFDLFNBQVMsQ0FBQyxDQUFDO0lBQ3JDLENBQUM7SUFFTyxpQkFBaUIsQ0FBQyxRQUFnQjtRQUN4QyxNQUFNLGVBQWUsR0FBMkI7WUFDOUMsT0FBTyxFQUFFLENBQUM7WUFDVixJQUFJLEVBQUUsQ0FBQztZQUNQLFFBQVEsRUFBRSxDQUFDO1lBQ1gsbUJBQW1CLEVBQUUsQ0FBQztZQUN0QixNQUFNLEVBQUUsQ0FBQztZQUNULGFBQWEsRUFBRSxDQUFDO1lBQ2hCLE9BQU8sRUFBRSxDQUFDO1lBQ1YsR0FBRyxFQUFFLENBQUM7WUFDTixJQUFJLEVBQUUsQ0FBQztZQUNQLFdBQVcsRUFBRSxDQUFDO1lBQ2QsV0FBVyxFQUFFLENBQUM7WUFDZCxRQUFRLEVBQUUsQ0FBQztZQUNYLElBQUksRUFBRSxDQUFDO1lBQ1AsWUFBWSxFQUFFLENBQUM7WUFDZixRQUFRLEVBQUUsQ0FBQztZQUNYLFFBQVEsRUFBRSxDQUFDO1NBQ1osQ0FBQztRQUNGLE9BQU8sZUFBZSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUN4QyxDQUFDO0NBQ0YsQ0FBQTtBQTNSWSx3RUFBOEI7eUNBQTlCLDhCQUE4QjtJQUQxQyxJQUFBLG1CQUFVLEdBQUU7eURBR2dCLHNDQUFhLG9CQUFiLHNDQUFhLG9EQUNILG1EQUF1QixvQkFBdkIsbURBQXVCLG9EQUNsQiw2REFBNEIsb0JBQTVCLDZEQUE0QixvREFDaEMscURBQXdCLG9CQUF4QixxREFBd0I7R0FMbkQsOEJBQThCLENBMlIxQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvaG9tZS93ZXRvb2EvRG9jdW1lbnRzL2NvZGUvcHJvamVjdHMvbWVudGFyYS9tZW50YXJhLWFwaS9zcmMvdGhlcmFwaXN0L3RoZXJhcGlzdC1yZWNvbW1lbmRhdGlvbi5zZXJ2aWNlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIEluamVjdGFibGUsXG4gIE5vdEZvdW5kRXhjZXB0aW9uLFxuICBJbnRlcm5hbFNlcnZlckVycm9yRXhjZXB0aW9uLFxufSBmcm9tICdAbmVzdGpzL2NvbW1vbic7XG5pbXBvcnQgeyBQcmlzbWFTZXJ2aWNlIH0gZnJvbSAnLi4vcHJvdmlkZXJzL3ByaXNtYS1jbGllbnQucHJvdmlkZXInO1xuaW1wb3J0IHsgUHJlQXNzZXNzbWVudCB9IGZyb20gJ0BwcmlzbWEvY2xpZW50JztcbmltcG9ydCB7XG4gIFRoZXJhcGlzdFJlY29tbWVuZGF0aW9uUmVxdWVzdCxcbiAgVGhlcmFwaXN0UmVjb21tZW5kYXRpb25SZXNwb25zZSxcbn0gZnJvbSAnbWVudGFyYS1jb21tb25zJztcbmltcG9ydCB7XG4gIEFkdmFuY2VkTWF0Y2hpbmdTZXJ2aWNlLFxuICBUaGVyYXBpc3RTY29yZSxcbn0gZnJvbSAnLi9zZXJ2aWNlcy9hZHZhbmNlZC1tYXRjaGluZy5zZXJ2aWNlJztcbmltcG9ydCB7IENvbXBhdGliaWxpdHlBbmFseXNpc1NlcnZpY2UgfSBmcm9tICcuL3NlcnZpY2VzL2NvbXBhdGliaWxpdHktYW5hbHlzaXMuc2VydmljZSc7XG5pbXBvcnQgeyBNYXRjaGluZ0FuYWx5dGljc1NlcnZpY2UgfSBmcm9tICcuL3NlcnZpY2VzL21hdGNoaW5nLWFuYWx5dGljcy5zZXJ2aWNlJztcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIFRoZXJhcGlzdFJlY29tbWVuZGF0aW9uU2VydmljZSB7XG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgcmVhZG9ubHkgcHJpc21hOiBQcmlzbWFTZXJ2aWNlLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgYWR2YW5jZWRNYXRjaGluZzogQWR2YW5jZWRNYXRjaGluZ1NlcnZpY2UsXG4gICAgcHJpdmF0ZSByZWFkb25seSBjb21wYXRpYmlsaXR5QW5hbHlzaXM6IENvbXBhdGliaWxpdHlBbmFseXNpc1NlcnZpY2UsXG4gICAgcHJpdmF0ZSByZWFkb25seSBtYXRjaGluZ0FuYWx5dGljczogTWF0Y2hpbmdBbmFseXRpY3NTZXJ2aWNlLFxuICApIHt9XG5cbiAgcHJpdmF0ZSBjYWxjdWxhdGVZZWFyc09mRXhwZXJpZW5jZShzdGFydERhdGU6IERhdGUpOiBudW1iZXIge1xuICAgIGNvbnN0IG5vdyA9IG5ldyBEYXRlKCk7XG4gICAgbGV0IHllYXJzID0gbm93LmdldEZ1bGxZZWFyKCkgLSBzdGFydERhdGUuZ2V0RnVsbFllYXIoKTtcbiAgICBpZiAoXG4gICAgICBub3cuZ2V0TW9udGgoKSA8IHN0YXJ0RGF0ZS5nZXRNb250aCgpIHx8XG4gICAgICAobm93LmdldE1vbnRoKCkgPT09IHN0YXJ0RGF0ZS5nZXRNb250aCgpICYmXG4gICAgICAgIG5vdy5nZXREYXRlKCkgPCBzdGFydERhdGUuZ2V0RGF0ZSgpKVxuICAgICkge1xuICAgICAgeWVhcnMtLTtcbiAgICB9XG4gICAgcmV0dXJuIHllYXJzO1xuICB9XG5cbiAgYXN5bmMgZ2V0UmVjb21tZW5kZWRUaGVyYXBpc3RzKFxuICAgIHJlcXVlc3Q6IFRoZXJhcGlzdFJlY29tbWVuZGF0aW9uUmVxdWVzdCxcbiAgKTogUHJvbWlzZTxhbnk+IHtcbiAgICB0cnkge1xuICAgICAgLy8gR2V0IHVzZXIncyBjb21wcmVoZW5zaXZlIGRhdGEgaW5jbHVkaW5nIHByZWZlcmVuY2VzXG4gICAgICBjb25zdCB1c2VyID0gYXdhaXQgdGhpcy5wcmlzbWEuY2xpZW50LmZpbmRVbmlxdWUoe1xuICAgICAgICB3aGVyZTogeyB1c2VySWQ6IHJlcXVlc3QudXNlcklkIH0sXG4gICAgICAgIGluY2x1ZGU6IHtcbiAgICAgICAgICBwcmVBc3Nlc3NtZW50OiB0cnVlLFxuICAgICAgICAgIGNsaWVudFByZWZlcmVuY2VzOiB0cnVlLFxuICAgICAgICAgIHVzZXI6IHRydWUsXG4gICAgICAgIH0sXG4gICAgICB9KTtcbiAgICAgIGlmICghdXNlcikgdGhyb3cgbmV3IE5vdEZvdW5kRXhjZXB0aW9uKCdVc2VyIG5vdCBmb3VuZCcpO1xuICAgICAgaWYgKCF1c2VyLnByZUFzc2Vzc21lbnQpXG4gICAgICAgIHRocm93IG5ldyBOb3RGb3VuZEV4Y2VwdGlvbignTm8gcHJlLWFzc2Vzc21lbnQgZm91bmQgZm9yIHVzZXInKTtcblxuICAgICAgLy8gRXh0cmFjdCB1c2VyIGNvbmRpdGlvbnMgYW5kIHNldmVyaXR5IGxldmVsc1xuICAgICAgY29uc3QgdXNlckNvbmRpdGlvbnMgPSB0aGlzLmV4dHJhY3RVc2VyQ29uZGl0aW9ucyh1c2VyLnByZUFzc2Vzc21lbnQpO1xuICAgICAgY29uc3Qgc2V2ZXJpdHlMZXZlbHMgPSB1c2VyLnByZUFzc2Vzc21lbnQuc2V2ZXJpdHlMZXZlbHMgYXMgUmVjb3JkPFxuICAgICAgICBzdHJpbmcsXG4gICAgICAgIHN0cmluZ1xuICAgICAgPjtcblxuICAgICAgLy8gRmV0Y2ggdGhlcmFwaXN0cyB3aXRoIGNvbXByZWhlbnNpdmUgZGF0YVxuICAgICAgY29uc3QgdGhlcmFwaXN0cyA9IGF3YWl0IHRoaXMucHJpc21hLnRoZXJhcGlzdC5maW5kTWFueSh7XG4gICAgICAgIHdoZXJlOiB7XG4gICAgICAgICAgc3RhdHVzOiAnYXBwcm92ZWQnLFxuICAgICAgICAgIC4uLihyZXF1ZXN0LnByb3ZpbmNlICYmIHsgcHJvdmluY2U6IHJlcXVlc3QucHJvdmluY2UgfSksXG4gICAgICAgICAgLi4uKHJlcXVlc3QubWF4SG91cmx5UmF0ZSAmJiB7XG4gICAgICAgICAgICBob3VybHlSYXRlOiB7IGx0ZTogcmVxdWVzdC5tYXhIb3VybHlSYXRlIH0sXG4gICAgICAgICAgfSksXG4gICAgICAgIH0sXG4gICAgICAgIG9yZGVyQnk6IHsgY3JlYXRlZEF0OiAnZGVzYycgfSxcbiAgICAgICAgdGFrZTogTWF0aC5taW4ocmVxdWVzdC5saW1pdCA/PyAxMCwgNTApLCAvLyBJbmNyZWFzZSBsaW1pdCBmb3IgYmV0dGVyIGZpbHRlcmluZ1xuICAgICAgICBpbmNsdWRlOiB7XG4gICAgICAgICAgdXNlcjogdHJ1ZSxcbiAgICAgICAgICByZXZpZXdzOiB7XG4gICAgICAgICAgICB3aGVyZTogeyBzdGF0dXM6ICdBUFBST1ZFRCcgfSxcbiAgICAgICAgICAgIHNlbGVjdDoge1xuICAgICAgICAgICAgICByYXRpbmc6IHRydWUsXG4gICAgICAgICAgICAgIHN0YXR1czogdHJ1ZSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgIH0pO1xuXG4gICAgICAvLyBVc2UgYWR2YW5jZWQgbWF0Y2hpbmcgYWxnb3JpdGhtXG4gICAgICBjb25zdCB0aGVyYXBpc3RTY29yZXM6IFRoZXJhcGlzdFNjb3JlW10gPSBbXTtcblxuICAgICAgZm9yIChjb25zdCB0aGVyYXBpc3Qgb2YgdGhlcmFwaXN0cykge1xuICAgICAgICB0cnkge1xuICAgICAgICAgIGNvbnN0IHNjb3JlID0gYXdhaXQgdGhpcy5hZHZhbmNlZE1hdGNoaW5nLmNhbGN1bGF0ZUFkdmFuY2VkTWF0Y2goXG4gICAgICAgICAgICB1c2VyIGFzIGFueSwgLy8gU2FmZSBiZWNhdXNlIHdlIHZlcmlmaWVkIHByZUFzc2Vzc21lbnQgZXhpc3RzIGFib3ZlXG4gICAgICAgICAgICB0aGVyYXBpc3QsXG4gICAgICAgICAgKTtcbiAgICAgICAgICB0aGVyYXBpc3RTY29yZXMucHVzaChzY29yZSk7XG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgLy8gRmFsbGJhY2sgdG8gYmFzaWMgc2NvcmluZyBpZiBhZHZhbmNlZCBtYXRjaGluZyBmYWlsc1xuICAgICAgICAgIGNvbnNvbGUud2FybihcbiAgICAgICAgICAgIGBBZHZhbmNlZCBtYXRjaGluZyBmYWlsZWQgZm9yIHRoZXJhcGlzdCAke3RoZXJhcGlzdC51c2VySWR9OmAsXG4gICAgICAgICAgICBlcnJvcixcbiAgICAgICAgICApO1xuICAgICAgICAgIGNvbnN0IGJhc2ljU2NvcmUgPSB0aGlzLmNhbGN1bGF0ZU1hdGNoU2NvcmUoXG4gICAgICAgICAgICB0aGVyYXBpc3QsXG4gICAgICAgICAgICB1c2VyQ29uZGl0aW9ucyxcbiAgICAgICAgICApO1xuICAgICAgICAgIHRoZXJhcGlzdFNjb3Jlcy5wdXNoKHtcbiAgICAgICAgICAgIHRoZXJhcGlzdCxcbiAgICAgICAgICAgIHRvdGFsU2NvcmU6IGJhc2ljU2NvcmUsXG4gICAgICAgICAgICBicmVha2Rvd246IHtcbiAgICAgICAgICAgICAgY29uZGl0aW9uU2NvcmU6IGJhc2ljU2NvcmUgKiAwLjYsXG4gICAgICAgICAgICAgIGFwcHJvYWNoU2NvcmU6IDAsXG4gICAgICAgICAgICAgIGV4cGVyaWVuY2VTY29yZTogYmFzaWNTY29yZSAqIDAuNCxcbiAgICAgICAgICAgICAgcmV2aWV3U2NvcmU6IDAsXG4gICAgICAgICAgICAgIGxvZ2lzdGljc1Njb3JlOiAwLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIG1hdGNoRXhwbGFuYXRpb246IHtcbiAgICAgICAgICAgICAgcHJpbWFyeU1hdGNoZXM6IHRoaXMuZ2V0UHJpbWFyeUNvbmRpdGlvbnModXNlckNvbmRpdGlvbnMpLFxuICAgICAgICAgICAgICBzZWNvbmRhcnlNYXRjaGVzOiB0aGlzLmdldFNlY29uZGFyeUNvbmRpdGlvbnModXNlckNvbmRpdGlvbnMpLFxuICAgICAgICAgICAgICBhcHByb2FjaE1hdGNoZXM6IFtdLFxuICAgICAgICAgICAgICBleHBlcmllbmNlWWVhcnM6IHRoaXMuY2FsY3VsYXRlWWVhcnNPZkV4cGVyaWVuY2UoXG4gICAgICAgICAgICAgICAgdGhlcmFwaXN0LnByYWN0aWNlU3RhcnREYXRlLFxuICAgICAgICAgICAgICApLFxuICAgICAgICAgICAgICBhdmVyYWdlUmF0aW5nOiAwLFxuICAgICAgICAgICAgICB0b3RhbFJldmlld3M6IDAsXG4gICAgICAgICAgICAgIHN1Y2Nlc3NSYXRlczoge30sXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIC8vIFNvcnQgYnkgdG90YWwgc2NvcmUgZGVzY2VuZGluZ1xuICAgICAgY29uc3Qgc29ydGVkVGhlcmFwaXN0U2NvcmVzID0gdGhlcmFwaXN0U2NvcmVzLnNvcnQoXG4gICAgICAgIChhLCBiKSA9PiBiLnRvdGFsU2NvcmUgLSBhLnRvdGFsU2NvcmUsXG4gICAgICApO1xuXG4gICAgICAvLyBUYWtlIG9ubHkgdGhlIHJlcXVlc3RlZCBudW1iZXIgb2YgcmVzdWx0c1xuICAgICAgY29uc3QgZmluYWxSZXN1bHRzID0gc29ydGVkVGhlcmFwaXN0U2NvcmVzLnNsaWNlKDAsIHJlcXVlc3QubGltaXQgPz8gMTApO1xuXG4gICAgICAvLyBUcmFjayByZWNvbW1lbmRhdGlvbiBhbmFseXRpY3NcbiAgICAgIGF3YWl0IHRoaXMubWF0Y2hpbmdBbmFseXRpY3MudHJhY2tSZWNvbW1lbmRhdGlvbihcbiAgICAgICAgcmVxdWVzdC51c2VySWQsXG4gICAgICAgIGZpbmFsUmVzdWx0cyxcbiAgICAgICAgJ2FkdmFuY2VkX3YxLjAnLFxuICAgICAgKTtcblxuICAgICAgLy8gVHJhbnNmb3JtIHRvIGV4cGVjdGVkIGZvcm1hdFxuICAgICAgY29uc3QgdGhlcmFwaXN0c1dpdGhTY29yZXMgPSBmaW5hbFJlc3VsdHMubWFwKChzY29yZSkgPT4gKHtcbiAgICAgICAgLi4uc2NvcmUudGhlcmFwaXN0LFxuICAgICAgICBtYXRjaFNjb3JlOiBzY29yZS50b3RhbFNjb3JlLFxuICAgICAgICBzY29yZUJyZWFrZG93bjogc2NvcmUuYnJlYWtkb3duLFxuICAgICAgICBtYXRjaEV4cGxhbmF0aW9uOiBzY29yZS5tYXRjaEV4cGxhbmF0aW9uLFxuICAgICAgfSkpO1xuXG4gICAgICAvLyBEZXRlcm1pbmUgcHJpbWFyeSBhbmQgc2Vjb25kYXJ5IGNvbmRpdGlvbnNcbiAgICAgIGNvbnN0IHByaW1hcnlDb25kaXRpb25zID0gdGhpcy5nZXRQcmltYXJ5Q29uZGl0aW9ucyh1c2VyQ29uZGl0aW9ucyk7XG4gICAgICBjb25zdCBzZWNvbmRhcnlDb25kaXRpb25zID0gdGhpcy5nZXRTZWNvbmRhcnlDb25kaXRpb25zKHVzZXJDb25kaXRpb25zKTtcblxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgdG90YWxDb3VudDogdGhlcmFwaXN0c1dpdGhTY29yZXMubGVuZ3RoLFxuICAgICAgICB1c2VyQ29uZGl0aW9uczogT2JqZWN0LmtleXModXNlckNvbmRpdGlvbnMpLFxuICAgICAgICB0aGVyYXBpc3RzOiB0aGVyYXBpc3RzV2l0aFNjb3JlcyxcbiAgICAgICAgbWF0Y2hDcml0ZXJpYToge1xuICAgICAgICAgIHByaW1hcnlDb25kaXRpb25zLFxuICAgICAgICAgIHNlY29uZGFyeUNvbmRpdGlvbnMsXG4gICAgICAgICAgc2V2ZXJpdHlMZXZlbHMsXG4gICAgICAgIH0sXG4gICAgICAgIHBhZ2U6IDEsXG4gICAgICAgIHBhZ2VTaXplOiByZXF1ZXN0LmxpbWl0ID8/IDEwLFxuICAgICAgfTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhyb3cgbmV3IEludGVybmFsU2VydmVyRXJyb3JFeGNlcHRpb24oXG4gICAgICAgIGVycm9yIGluc3RhbmNlb2YgRXJyb3JcbiAgICAgICAgICA/IGVycm9yLm1lc3NhZ2VcbiAgICAgICAgICA6ICdGYWlsZWQgdG8gZ2V0IHRoZXJhcGlzdCByZWNvbW1lbmRhdGlvbnMnLFxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogR2V0IGRldGFpbGVkIGNvbXBhdGliaWxpdHkgYW5hbHlzaXMgYmV0d2VlbiBhIGNsaWVudCBhbmQgdGhlcmFwaXN0XG4gICAqL1xuICBhc3luYyBnZXRDb21wYXRpYmlsaXR5QW5hbHlzaXMoY2xpZW50SWQ6IHN0cmluZywgdGhlcmFwaXN0SWQ6IHN0cmluZykge1xuICAgIGNvbnN0IGNsaWVudCA9IGF3YWl0IHRoaXMucHJpc21hLmNsaWVudC5maW5kVW5pcXVlKHtcbiAgICAgIHdoZXJlOiB7IHVzZXJJZDogY2xpZW50SWQgfSxcbiAgICAgIGluY2x1ZGU6IHtcbiAgICAgICAgcHJlQXNzZXNzbWVudDogdHJ1ZSxcbiAgICAgICAgY2xpZW50UHJlZmVyZW5jZXM6IHRydWUsXG4gICAgICAgIHVzZXI6IHRydWUsXG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgY29uc3QgdGhlcmFwaXN0ID0gYXdhaXQgdGhpcy5wcmlzbWEudGhlcmFwaXN0LmZpbmRVbmlxdWUoe1xuICAgICAgd2hlcmU6IHsgdXNlcklkOiB0aGVyYXBpc3RJZCB9LFxuICAgICAgaW5jbHVkZToge1xuICAgICAgICB1c2VyOiB0cnVlLFxuICAgICAgICByZXZpZXdzOiB7XG4gICAgICAgICAgd2hlcmU6IHsgc3RhdHVzOiAnQVBQUk9WRUQnIH0sXG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgaWYgKCFjbGllbnQgfHwgIXRoZXJhcGlzdCkge1xuICAgICAgdGhyb3cgbmV3IE5vdEZvdW5kRXhjZXB0aW9uKCdDbGllbnQgb3IgdGhlcmFwaXN0IG5vdCBmb3VuZCcpO1xuICAgIH1cblxuICAgIGlmICghY2xpZW50LnByZUFzc2Vzc21lbnQpIHtcbiAgICAgIHRocm93IG5ldyBOb3RGb3VuZEV4Y2VwdGlvbignTm8gcHJlLWFzc2Vzc21lbnQgZm91bmQgZm9yIGNsaWVudCcpO1xuICAgIH1cblxuICAgIGNvbnN0IGNvbXBhdGliaWxpdHkgPSBhd2FpdCB0aGlzLmNvbXBhdGliaWxpdHlBbmFseXNpcy5hbmFseXplQ29tcGF0aWJpbGl0eShcbiAgICAgIGNsaWVudCBhcyBhbnksIC8vIFNhZmUgYmVjYXVzZSB3ZSB2ZXJpZmllZCBwcmVBc3Nlc3NtZW50IGV4aXN0cyBhYm92ZVxuICAgICAgdGhlcmFwaXN0LFxuICAgICk7XG5cbiAgICAvLyBUcmFjayBjb21wYXRpYmlsaXR5IGFuYWx5c2lzXG4gICAgYXdhaXQgdGhpcy5tYXRjaGluZ0FuYWx5dGljcy50cmFja0NvbXBhdGliaWxpdHlBbmFseXNpcyhcbiAgICAgIGNsaWVudElkLFxuICAgICAgdGhlcmFwaXN0SWQsXG4gICAgICBjb21wYXRpYmlsaXR5LFxuICAgICAgJzEuMCcsXG4gICAgKTtcblxuICAgIHJldHVybiBjb21wYXRpYmlsaXR5O1xuICB9XG5cbiAgcHJpdmF0ZSBleHRyYWN0VXNlckNvbmRpdGlvbnMoXG4gICAgcHJlQXNzZXNzbWVudDogUHJlQXNzZXNzbWVudCxcbiAgKTogUmVjb3JkPHN0cmluZywgc3RyaW5nPiB7XG4gICAgY29uc3QgY29uZGl0aW9uczogUmVjb3JkPHN0cmluZywgc3RyaW5nPiA9IHt9O1xuICAgIGNvbnN0IHNldmVyaXR5TGV2ZWxzID0gcHJlQXNzZXNzbWVudC5zZXZlcml0eUxldmVscyBhcyBSZWNvcmQ8XG4gICAgICBzdHJpbmcsXG4gICAgICBzdHJpbmdcbiAgICA+O1xuICAgIGNvbnN0IHF1ZXN0aW9ubmFpcmVzID0gcHJlQXNzZXNzbWVudC5xdWVzdGlvbm5haXJlcyBhcyBzdHJpbmdbXTtcbiAgICBxdWVzdGlvbm5haXJlcy5mb3JFYWNoKChxKSA9PiB7XG4gICAgICBpZiAoc2V2ZXJpdHlMZXZlbHNbcV0pIHtcbiAgICAgICAgY29uZGl0aW9uc1txXSA9IHNldmVyaXR5TGV2ZWxzW3FdO1xuICAgICAgfVxuICAgIH0pO1xuICAgIHJldHVybiBjb25kaXRpb25zO1xuICB9XG5cbiAgcHJpdmF0ZSBjYWxjdWxhdGVNYXRjaFNjb3JlKFxuICAgIHRoZXJhcGlzdDogYW55LFxuICAgIHVzZXJDb25kaXRpb25zOiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+LFxuICApOiBudW1iZXIge1xuICAgIGxldCBzY29yZSA9IDA7XG4gICAgY29uc3QgZXhwZXJ0aXNlID0gKHRoZXJhcGlzdC5leHBlcnRpc2UgYXMgc3RyaW5nW10pIHx8IFtdO1xuICAgIE9iamVjdC5rZXlzKHVzZXJDb25kaXRpb25zKS5mb3JFYWNoKChjb25kaXRpb24pID0+IHtcbiAgICAgIGlmIChleHBlcnRpc2UuaW5jbHVkZXMoY29uZGl0aW9uKSkgc2NvcmUgKz0gMjA7XG4gICAgfSk7XG4gICAgc2NvcmUgKz0gTWF0aC5taW4oXG4gICAgICB0aGlzLmNhbGN1bGF0ZVllYXJzT2ZFeHBlcmllbmNlKHRoZXJhcGlzdC5wcmFjdGljZVN0YXJ0RGF0ZSkgKiAyLFxuICAgICAgMjAsXG4gICAgKTtcbiAgICAvLyBBZGQgYmFzZSBzY29yZSBmb3IgZXhwZXJpZW5jZVxuICAgIHNjb3JlICs9IHRoZXJhcGlzdC55ZWFyc09mRXhwZXJpZW5jZSA/IHRoZXJhcGlzdC55ZWFyc09mRXhwZXJpZW5jZSAqIDIgOiAwO1xuICAgIHJldHVybiBzY29yZTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0UHJpbWFyeUNvbmRpdGlvbnMoXG4gICAgdXNlckNvbmRpdGlvbnM6IFJlY29yZDxzdHJpbmcsIHN0cmluZz4sXG4gICk6IHN0cmluZ1tdIHtcbiAgICByZXR1cm4gT2JqZWN0LmVudHJpZXModXNlckNvbmRpdGlvbnMpXG4gICAgICAuZmlsdGVyKChbLCBzZXZlcml0eV0pID0+IHRoaXMuZ2V0U2V2ZXJpdHlXZWlnaHQoc2V2ZXJpdHkpID49IDQpXG4gICAgICAubWFwKChbY29uZGl0aW9uXSkgPT4gY29uZGl0aW9uKTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0U2Vjb25kYXJ5Q29uZGl0aW9ucyhcbiAgICB1c2VyQ29uZGl0aW9uczogUmVjb3JkPHN0cmluZywgc3RyaW5nPixcbiAgKTogc3RyaW5nW10ge1xuICAgIHJldHVybiBPYmplY3QuZW50cmllcyh1c2VyQ29uZGl0aW9ucylcbiAgICAgIC5maWx0ZXIoKFssIHNldmVyaXR5XSkgPT4ge1xuICAgICAgICBjb25zdCB3ZWlnaHQgPSB0aGlzLmdldFNldmVyaXR5V2VpZ2h0KHNldmVyaXR5KTtcbiAgICAgICAgcmV0dXJuIHdlaWdodCA+PSAyICYmIHdlaWdodCA8IDQ7XG4gICAgICB9KVxuICAgICAgLm1hcCgoW2NvbmRpdGlvbl0pID0+IGNvbmRpdGlvbik7XG4gIH1cblxuICBwcml2YXRlIGdldFNldmVyaXR5V2VpZ2h0KHNldmVyaXR5OiBzdHJpbmcpOiBudW1iZXIge1xuICAgIGNvbnN0IHNldmVyaXR5V2VpZ2h0czogUmVjb3JkPHN0cmluZywgbnVtYmVyPiA9IHtcbiAgICAgIE1pbmltYWw6IDEsXG4gICAgICBNaWxkOiAyLFxuICAgICAgTW9kZXJhdGU6IDMsXG4gICAgICAnTW9kZXJhdGVseSBTZXZlcmUnOiA0LFxuICAgICAgU2V2ZXJlOiA1LFxuICAgICAgJ1ZlcnkgU2V2ZXJlJzogNSxcbiAgICAgIEV4dHJlbWU6IDUsXG4gICAgICBMb3c6IDEsXG4gICAgICBIaWdoOiA0LFxuICAgICAgU3Vic3RhbnRpYWw6IDQsXG4gICAgICBTdWJjbGluaWNhbDogMSxcbiAgICAgIENsaW5pY2FsOiA0LFxuICAgICAgTm9uZTogMCxcbiAgICAgIFN1YnRocmVzaG9sZDogMixcbiAgICAgIFBvc2l0aXZlOiA0LFxuICAgICAgTmVnYXRpdmU6IDAsXG4gICAgfTtcbiAgICByZXR1cm4gc2V2ZXJpdHlXZWlnaHRzW3NldmVyaXR5XSB8fCAxO1xuICB9XG59XG4iXSwidmVyc2lvbiI6M30=