82abb9a2635cbae257455b2e2c754b34
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
exports.CommunityAssignmentService = void 0;
const common_1 = require("@nestjs/common");
const prisma_client_provider_1 = require("src/providers/prisma-client.provider");
const community_configs_1 = require("../config/community-configs");
let CommunityAssignmentService = class CommunityAssignmentService {
    prisma;
    constructor(prisma) {
        this.prisma = prisma;
    }
    /**
     * Maps questionnaire types to community slugs based on mental health conditions
     */
    QUESTIONNAIRE_TO_COMMUNITY_MAP = {
        // Depression-related assessments
        'phq-9': 'depression-support',
        'mood-disorder': 'depression-support',
        // Anxiety-related assessments
        'gad-7-anxiety': 'anxiety-warriors',
        'social-phobia': 'social-anxiety-support',
        'panic-disorder': 'anxiety-warriors',
        phobia: 'phobia-support',
        // Stress-related assessments
        'perceived-stress-scale': 'stress-support',
        burnout: 'burnout-recovery',
        // Sleep-related assessments
        insomnia: 'insomnia-support',
        // Trauma-related assessments
        ptsd: 'ptsd-support',
        // OCD-related assessments
        'obsessional-compulsive': 'ocd-support',
        // ADHD-related assessments
        adhd: 'adhd-support',
        // Eating disorder assessments
        'binge-eating': 'eating-disorder-recovery',
        // Substance use assessments
        alcohol: 'substance-recovery-support',
        'drug-abuse': 'substance-recovery-support',
    };
    /**
     * Severity thresholds for community assignment
     * Only assign to communities if severity is moderate or higher
     */
    SEVERITY_THRESHOLD = {
        minimal: false,
        mild: false,
        moderate: true,
        severe: true,
        'very-severe': true,
    };
    /**
     * Auto-assign communities to a user based on their pre-assessment results
     */
    async assignCommunitiesToUser(userId) {
        console.log(`ðŸ”„ Auto-assigning communities for user: ${userId}`);
        // Get user's pre-assessment data
        const userAssessment = await this.prisma.preAssessment.findFirst({
            where: { clientId: userId },
            select: {
                answers: true,
            },
        });
        if (!userAssessment) {
            console.log(`âš ï¸  No pre-assessment found for user: ${userId}`);
            return [];
        }
        // Extract scores and severity levels from answers JSON
        const assessmentData = userAssessment.answers;
        if (!assessmentData || typeof assessmentData !== 'object') {
            console.log(`âš ï¸  Invalid assessment data for user: ${userId}`);
            return [];
        }
        const scores = assessmentData.scores;
        const severityLevels = assessmentData.severityLevels;
        if (!scores || !severityLevels) {
            console.log(`âš ï¸  Missing scores or severity levels for user: ${userId}`);
            return [];
        }
        const assignedCommunities = [];
        // Iterate through questionnaire results and assign communities
        for (const [questionnaire] of Object.entries(scores)) {
            const severity = severityLevels[questionnaire];
            const communitySlug = this.QUESTIONNAIRE_TO_COMMUNITY_MAP[questionnaire];
            // Skip if no community mapping or severity is too low
            if (!communitySlug || !this.SEVERITY_THRESHOLD[severity?.toLowerCase()]) {
                continue;
            }
            // Find the community
            const community = await this.prisma.community.findUnique({
                where: { slug: communitySlug },
            });
            if (!community) {
                console.log(`âš ï¸  Community not found for slug: ${communitySlug}`);
                continue;
            }
            // Check if user is already a member
            const existingMembership = await this.prisma.membership.findUnique({
                where: {
                    userId_communityId: {
                        userId: userId,
                        communityId: community.id,
                    },
                },
            });
            if (existingMembership) {
                console.log(`â­ï¸  User already member of: ${community.name}`);
                continue;
            }
            // Create membership
            try {
                await this.prisma.membership.create({
                    data: {
                        userId: userId,
                        communityId: community.id,
                        joinedAt: new Date(),
                    },
                });
                assignedCommunities.push(community.name);
                console.log(`âœ… Assigned user to community: ${community.name} (${severity} ${questionnaire})`);
            }
            catch (error) {
                console.error(`âŒ Failed to assign community ${community.name}:`, error);
            }
        }
        // Always assign to general support communities
        await this.assignGeneralSupportCommunities(userId);
        console.log(`ðŸŽ¯ Auto-assignment complete. Assigned ${assignedCommunities.length} communities.`);
        return assignedCommunities;
    }
    /**
     * Assign user to general support communities regardless of assessment results
     */
    async assignGeneralSupportCommunities(userId) {
        const generalCommunities = ['Support Circle', 'Mindfulness & Meditation'];
        for (const communityName of generalCommunities) {
            const community = await this.prisma.community.findFirst({
                where: { name: communityName },
            });
            if (!community)
                continue;
            // Check if user is already a member
            const existingMembership = await this.prisma.membership.findUnique({
                where: {
                    userId_communityId: {
                        userId: userId,
                        communityId: community.id,
                    },
                },
            });
            if (existingMembership)
                continue;
            try {
                await this.prisma.membership.create({
                    data: {
                        userId: userId,
                        communityId: community.id,
                        joinedAt: new Date(),
                    },
                });
                console.log(`âœ… Assigned user to general community: ${community.name}`);
            }
            catch (error) {
                console.error(`âŒ Failed to assign general community ${community.name}:`, error);
            }
        }
    }
    /**
     * Get communities a user should be assigned to based on their assessment (preview mode)
     */
    async getRecommendedCommunities(userId) {
        const userAssessment = await this.prisma.preAssessment.findFirst({
            where: { clientId: userId },
            select: {
                answers: true,
            },
        });
        if (!userAssessment) {
            return [];
        }
        // Extract scores and severity levels from answers JSON
        const assessmentData = userAssessment.answers;
        if (!assessmentData || typeof assessmentData !== 'object') {
            return [];
        }
        const scores = assessmentData.scores;
        const severityLevels = assessmentData.severityLevels;
        if (!scores || !severityLevels) {
            return [];
        }
        const recommendedCommunities = [];
        for (const [questionnaire] of Object.entries(scores)) {
            const severity = severityLevels[questionnaire];
            const communitySlug = this.QUESTIONNAIRE_TO_COMMUNITY_MAP[questionnaire];
            if (communitySlug && this.SEVERITY_THRESHOLD[severity?.toLowerCase()]) {
                const community = community_configs_1.ILLNESS_COMMUNITIES.find((c) => c.slug === communitySlug);
                if (community) {
                    recommendedCommunities.push(community.name);
                }
            }
        }
        return recommendedCommunities;
    }
    /**
     * Bulk assign communities to multiple users (useful for existing users)
     */
    async bulkAssignCommunities(userIds) {
        const results = {};
        for (const userId of userIds) {
            try {
                results[userId] = await this.assignCommunitiesToUser(userId);
            }
            catch (error) {
                console.error(`Error assigning communities to user ${userId}:`, error);
                results[userId] = [];
            }
        }
        return results;
    }
};
exports.CommunityAssignmentService = CommunityAssignmentService;
exports.CommunityAssignmentService = CommunityAssignmentService = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [typeof (_a = typeof prisma_client_provider_1.PrismaService !== "undefined" && prisma_client_provider_1.PrismaService) === "function" ? _a : Object])
], CommunityAssignmentService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL2NvbW11bml0aWVzL2NvbW11bml0eS1hc3NpZ25tZW50LnNlcnZpY2UudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7OztBQUFBLDJDQUE0QztBQUM1QyxpRkFBcUU7QUFDckUsbUVBQWtFO0FBVzNELElBQU0sMEJBQTBCLEdBQWhDLE1BQU0sMEJBQTBCO0lBQ1I7SUFBN0IsWUFBNkIsTUFBcUI7UUFBckIsV0FBTSxHQUFOLE1BQU0sQ0FBZTtJQUFHLENBQUM7SUFFdEQ7O09BRUc7SUFDYyw4QkFBOEIsR0FBRztRQUNoRCxpQ0FBaUM7UUFDakMsT0FBTyxFQUFFLG9CQUFvQjtRQUM3QixlQUFlLEVBQUUsb0JBQW9CO1FBRXJDLDhCQUE4QjtRQUM5QixlQUFlLEVBQUUsa0JBQWtCO1FBQ25DLGVBQWUsRUFBRSx3QkFBd0I7UUFDekMsZ0JBQWdCLEVBQUUsa0JBQWtCO1FBQ3BDLE1BQU0sRUFBRSxnQkFBZ0I7UUFFeEIsNkJBQTZCO1FBQzdCLHdCQUF3QixFQUFFLGdCQUFnQjtRQUMxQyxPQUFPLEVBQUUsa0JBQWtCO1FBRTNCLDRCQUE0QjtRQUM1QixRQUFRLEVBQUUsa0JBQWtCO1FBRTVCLDZCQUE2QjtRQUM3QixJQUFJLEVBQUUsY0FBYztRQUVwQiwwQkFBMEI7UUFDMUIsd0JBQXdCLEVBQUUsYUFBYTtRQUV2QywyQkFBMkI7UUFDM0IsSUFBSSxFQUFFLGNBQWM7UUFFcEIsOEJBQThCO1FBQzlCLGNBQWMsRUFBRSwwQkFBMEI7UUFFMUMsNEJBQTRCO1FBQzVCLE9BQU8sRUFBRSw0QkFBNEI7UUFDckMsWUFBWSxFQUFFLDRCQUE0QjtLQUMzQyxDQUFDO0lBRUY7OztPQUdHO0lBQ2Msa0JBQWtCLEdBQUc7UUFDcEMsT0FBTyxFQUFFLEtBQUs7UUFDZCxJQUFJLEVBQUUsS0FBSztRQUNYLFFBQVEsRUFBRSxJQUFJO1FBQ2QsTUFBTSxFQUFFLElBQUk7UUFDWixhQUFhLEVBQUUs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LE9BQU8sQ0FBQyxNQUFNLENBQUMsR0FBRyxNQUFNLElBQUksQ0FBQyx1QkFBdUIsQ0FBQyxNQUFNLENBQUMsQ0FBQztZQUMvRCxDQUFDO1lBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztnQkFDZixPQUFPLENBQUMsS0FBSyxDQUFDLHVDQUF1QyxNQUFNLEdBQUcsRUFBRSxLQUFLLENBQUMsQ0FBQztnQkFDdkUsT0FBTyxDQUFDLE1BQU0sQ0FBQyxHQUFHLEVBQUUsQ0FBQztZQUN2QixDQUFDO1FBQ0gsQ0FBQztRQUVELE9BQU8sT0FBTyxDQUFDO0lBQ2pCLENBQUM7Q0FDRixDQUFBO0FBdFFZLGdFQUEwQjtxQ0FBMUIsMEJBQTBCO0lBRHRDLElBQUEsbUJBQVUsR0FBRTt5REFFMEIsc0NBQWEsb0JBQWIsc0NBQWE7R0FEdkMsMEJBQTBCLENBc1F0QyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvaG9tZS93ZXRvb2EvRG9jdW1lbnRzL2NvZGUvcHJvamVjdHMvbWVudGFyYS9tZW50YXJhLWFwaS9zcmMvY29tbXVuaXRpZXMvY29tbXVuaXR5LWFzc2lnbm1lbnQuc2VydmljZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQG5lc3Rqcy9jb21tb24nO1xuaW1wb3J0IHsgUHJpc21hU2VydmljZSB9IGZyb20gJ3NyYy9wcm92aWRlcnMvcHJpc21hLWNsaWVudC5wcm92aWRlcic7XG5pbXBvcnQgeyBJTExORVNTX0NPTU1VTklUSUVTIH0gZnJvbSAnLi4vY29uZmlnL2NvbW11bml0eS1jb25maWdzJztcblxuaW50ZXJmYWNlIFByZUFzc2Vzc21lbnRTY29yZXMge1xuICBba2V5OiBzdHJpbmddOiBudW1iZXI7XG59XG5cbmludGVyZmFjZSBTZXZlcml0eUxldmVscyB7XG4gIFtrZXk6IHN0cmluZ106IHN0cmluZztcbn1cblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIENvbW11bml0eUFzc2lnbm1lbnRTZXJ2aWNlIHtcbiAgY29uc3RydWN0b3IocHJpdmF0ZSByZWFkb25seSBwcmlzbWE6IFByaXNtYVNlcnZpY2UpIHt9XG5cbiAgLyoqXG4gICAqIE1hcHMgcXVlc3Rpb25uYWlyZSB0eXBlcyB0byBjb21tdW5pdHkgc2x1Z3MgYmFzZWQgb24gbWVudGFsIGhlYWx0aCBjb25kaXRpb25zXG4gICAqL1xuICBwcml2YXRlIHJlYWRvbmx5IFFVRVNUSU9OTkFJUkVfVE9fQ09NTVVOSVRZX01BUCA9IHtcbiAgICAvLyBEZXByZXNzaW9uLXJlbGF0ZWQgYXNzZXNzbWVudHNcbiAgICAncGhxLTknOiAnZGVwcmVzc2lvbi1zdXBwb3J0JyxcbiAgICAnbW9vZC1kaXNvcmRlcic6ICdkZXByZXNzaW9uLXN1cHBvcnQnLFxuXG4gICAgLy8gQW54aWV0eS1yZWxhdGVkIGFzc2Vzc21lbnRzXG4gICAgJ2dhZC03LWFueGlldHknOiAnYW54aWV0eS13YXJyaW9ycycsXG4gICAgJ3NvY2lhbC1waG9iaWEnOiAnc29jaWFsLWFueGlldHktc3VwcG9ydCcsXG4gICAgJ3BhbmljLWRpc29yZGVyJzogJ2FueGlldHktd2FycmlvcnMnLFxuICAgIHBob2JpYTogJ3Bob2JpYS1zdXBwb3J0JyxcblxuICAgIC8vIFN0cmVzcy1yZWxhdGVkIGFzc2Vzc21lbnRzXG4gICAgJ3BlcmNlaXZlZC1zdHJlc3Mtc2NhbGUnOiAnc3RyZXNzLXN1cHBvcnQnLFxuICAgIGJ1cm5vdXQ6ICdidXJub3V0LXJlY292ZXJ5JyxcblxuICAgIC8vIFNsZWVwLXJlbGF0ZWQgYXNzZXNzbWVudHNcbiAgICBpbnNvbW5pYTogJ2luc29tbmlhLXN1cHBvcnQnLFxuXG4gICAgLy8gVHJhdW1hLXJlbGF0ZWQgYXNzZXNzbWVudHNcbiAgICBwdHNkOiAncHRzZC1zdXBwb3J0JyxcblxuICAgIC8vIE9DRC1yZWxhdGVkIGFzc2Vzc21lbnRzXG4gICAgJ29ic2Vzc2lvbmFsLWNvbXB1bHNpdmUnOiAnb2NkLXN1cHBvcnQnLFxuXG4gICAgLy8gQURIRC1yZWxhdGVkIGFzc2Vzc21lbnRzXG4gICAgYWRoZDogJ2FkaGQtc3VwcG9ydCcsXG5cbiAgICAvLyBFYXRpbmcgZGlzb3JkZXIgYXNzZXNzbWVudHNcbiAgICAnYmluZ2UtZWF0aW5nJzogJ2VhdGluZy1kaXNvcmRlci1yZWNvdmVyeScsXG5cbiAgICAvLyBTdWJzdGFuY2UgdXNlIGFzc2Vzc21lbnRzXG4gICAgYWxjb2hvbDogJ3N1YnN0YW5jZS1yZWNvdmVyeS1zdXBwb3J0JyxcbiAgICAnZHJ1Zy1hYnVzZSc6ICdzdWJzdGFuY2UtcmVjb3Zlcnktc3VwcG9ydCcsXG4gIH07XG5cbiAgLyoqXG4gICAqIFNldmVyaXR5IHRocmVzaG9sZHMgZm9yIGNvbW11bml0eSBhc3NpZ25tZW50XG4gICAqIE9ubHkgYXNzaWduIHRvIGNvbW11bml0aWVzIGlmIHNldmVyaXR5IGlzIG1vZGVyYXRlIG9yIGhpZ2hlclxuICAgKi9cbiAgcHJpdmF0ZSByZWFkb25seSBTRVZFUklUWV9USFJFU0hPTEQgPSB7XG4gICAgbWluaW1hbDogZmFsc2UsXG4gICAgbWlsZDogZmFsc2UsXG4gICAgbW9kZXJhdGU6IHRydWUsXG4gICAgc2V2ZXJlOiB0cnVlLFxuICAgICd2ZXJ5LXNldmVyZSc6IHRydWUsXG4gIH07XG5cbiAgLyoqXG4gICAqIEF1dG8tYXNzaWduIGNvbW11bml0aWVzIHRvIGEgdXNlciBiYXNlZCBvbiB0aGVpciBwcmUtYXNzZXNzbWVudCByZXN1bHRzXG4gICAqL1xuICBhc3luYyBhc3NpZ25Db21tdW5pdGllc1RvVXNlcih1c2VySWQ6IHN0cmluZyk6IFByb21pc2U8c3RyaW5nW10+IHtcbiAgICBjb25zb2xlLmxvZyhg8J+UhCBBdXRvLWFzc2lnbmluZyBjb21tdW5pdGllcyBmb3IgdXNlcjogJHt1c2VySWR9YCk7XG5cbiAgICAvLyBHZXQgdXNlcidzIHByZS1hc3Nlc3NtZW50IGRhdGFcbiAgICBjb25zdCB1c2VyQXNzZXNzbWVudCA9IGF3YWl0IHRoaXMucHJpc21hLnByZUFzc2Vzc21lbnQuZmluZEZpcnN0KHtcbiAgICAgIHdoZXJlOiB7IGNsaWVudElkOiB1c2VySWQgfSxcbiAgICAgIHNlbGVjdDoge1xuICAgICAgICBhbnN3ZXJzOiB0cnVlLFxuICAgICAgfSxcbiAgICB9KTtcblxuICAgIGlmICghdXNlckFzc2Vzc21lbnQpIHtcbiAgICAgIGNvbnNvbGUubG9nKGDimqDvuI8gIE5vIHByZS1hc3Nlc3NtZW50IGZvdW5kIGZvciB1c2VyOiAke3VzZXJJZH1gKTtcbiAgICAgIHJldHVybiBbXTtcbiAgICB9XG5cbiAgICAvLyBFeHRyYWN0IHNjb3JlcyBhbmQgc2V2ZXJpdHkgbGV2ZWxzIGZyb20gYW5zd2VycyBKU09OXG4gICAgY29uc3QgYXNzZXNzbWVudERhdGEgPSB1c2VyQXNzZXNzbWVudC5hbnN3ZXJzIGFzIGFueTtcbiAgICBpZiAoIWFzc2Vzc21lbnREYXRhIHx8IHR5cGVvZiBhc3Nlc3NtZW50RGF0YSAhPT0gJ29iamVjdCcpIHtcbiAgICAgIGNvbnNvbGUubG9nKGDimqDvuI8gIEludmFsaWQgYXNzZXNzbWVudCBkYXRhIGZvciB1c2VyOiAke3VzZXJJZH1gKTtcbiAgICAgIHJldHVybiBbXTtcbiAgICB9XG5cbiAgICBjb25zdCBzY29yZXMgPSBhc3Nlc3NtZW50RGF0YS5zY29yZXMgYXMgUHJlQXNzZXNzbWVudFNjb3JlcztcbiAgICBjb25zdCBzZXZlcml0eUxldmVscyA9IGFzc2Vzc21lbnREYXRhLnNldmVyaXR5TGV2ZWxzIGFzIFNldmVyaXR5TGV2ZWxzO1xuXG4gICAgaWYgKCFzY29yZXMgfHwgIXNldmVyaXR5TGV2ZWxzKSB7XG4gICAgICBjb25zb2xlLmxvZyhg4pqg77iPICBNaXNzaW5nIHNjb3JlcyBvciBzZXZlcml0eSBsZXZlbHMgZm9yIHVzZXI6ICR7dXNlcklkfWApO1xuICAgICAgcmV0dXJuIFtdO1xuICAgIH1cbiAgICBjb25zdCBhc3NpZ25lZENvbW11bml0aWVzOiBzdHJpbmdbXSA9IFtdO1xuXG4gICAgLy8gSXRlcmF0ZSB0aHJvdWdoIHF1ZXN0aW9ubmFpcmUgcmVzdWx0cyBhbmQgYXNzaWduIGNvbW11bml0aWVzXG4gICAgZm9yIChjb25zdCBbcXVlc3Rpb25uYWlyZV0gb2YgT2JqZWN0LmVudHJpZXMoc2NvcmVzKSkge1xuICAgICAgY29uc3Qgc2V2ZXJpdHkgPSBzZXZlcml0eUxldmVsc1txdWVzdGlvbm5haXJlXTtcbiAgICAgIGNvbnN0IGNvbW11bml0eVNsdWcgPSB0aGlzLlFVRVNUSU9OTkFJUkVfVE9fQ09NTVVOSVRZX01BUFtxdWVzdGlvbm5haXJlXTtcblxuICAgICAgLy8gU2tpcCBpZiBubyBjb21tdW5pdHkgbWFwcGluZyBvciBzZXZlcml0eSBpcyB0b28gbG93XG4gICAgICBpZiAoIWNvbW11bml0eVNsdWcgfHwgIXRoaXMuU0VWRVJJVFlfVEhSRVNIT0xEW3NldmVyaXR5Py50b0xvd2VyQ2FzZSgpXSkge1xuICAgICAgICBjb250aW51ZTtcbiAgICAgIH1cblxuICAgICAgLy8gRmluZCB0aGUgY29tbXVuaXR5XG4gICAgICBjb25zdCBjb21tdW5pdHkgPSBhd2FpdCB0aGlzLnByaXNtYS5jb21tdW5pdHkuZmluZFVuaXF1ZSh7XG4gICAgICAgIHdoZXJlOiB7IHNsdWc6IGNvbW11bml0eVNsdWcgfSxcbiAgICAgIH0pO1xuXG4gICAgICBpZiAoIWNvbW11bml0eSkge1xuICAgICAgICBjb25zb2xlLmxvZyhg4pqg77iPICBDb21tdW5pdHkgbm90IGZvdW5kIGZvciBzbHVnOiAke2NvbW11bml0eVNsdWd9YCk7XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfVxuXG4gICAgICAvLyBDaGVjayBpZiB1c2VyIGlzIGFscmVhZHkgYSBtZW1iZXJcbiAgICAgIGNvbnN0IGV4aXN0aW5nTWVtYmVyc2hpcCA9IGF3YWl0IHRoaXMucHJpc21hLm1lbWJlcnNoaXAuZmluZFVuaXF1ZSh7XG4gICAgICAgIHdoZXJlOiB7XG4gICAgICAgICAgdXNlcklkX2NvbW11bml0eUlkOiB7XG4gICAgICAgICAgICB1c2VySWQ6IHVzZXJJZCxcbiAgICAgICAgICAgIGNvbW11bml0eUlkOiBjb21tdW5pdHkuaWQsXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgIH0pO1xuXG4gICAgICBpZiAoZXhpc3RpbmdNZW1iZXJzaGlwKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKGDij63vuI8gIFVzZXIgYWxyZWFkeSBtZW1iZXIgb2Y6ICR7Y29tbXVuaXR5Lm5hbWV9YCk7XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfVxuXG4gICAgICAvLyBDcmVhdGUgbWVtYmVyc2hpcFxuICAgICAgdHJ5IHtcbiAgICAgICAgYXdhaXQgdGhpcy5wcmlzbWEubWVtYmVyc2hpcC5jcmVhdGUoe1xuICAgICAgICAgIGRhdGE6IHtcbiAgICAgICAgICAgIHVzZXJJZDogdXNlcklkLFxuICAgICAgICAgICAgY29tbXVuaXR5SWQ6IGNvbW11bml0eS5pZCxcbiAgICAgICAgICAgIGpvaW5lZEF0OiBuZXcgRGF0ZSgpLFxuICAgICAgICAgIH0sXG4gICAgICAgIH0pO1xuXG4gICAgICAgIGFzc2lnbmVkQ29tbXVuaXRpZXMucHVzaChjb21tdW5pdHkubmFtZSk7XG4gICAgICAgIGNvbnNvbGUubG9nKFxuICAgICAgICAgIGDinIUgQXNzaWduZWQgdXNlciB0byBjb21tdW5pdHk6ICR7Y29tbXVuaXR5Lm5hbWV9ICgke3NldmVyaXR5fSAke3F1ZXN0aW9ubmFpcmV9KWAsXG4gICAgICAgICk7XG4gICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICBjb25zb2xlLmVycm9yKFxuICAgICAgICAgIGDinYwgRmFpbGVkIHRvIGFzc2lnbiBjb21tdW5pdHkgJHtjb21tdW5pdHkubmFtZX06YCxcbiAgICAgICAgICBlcnJvcixcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBBbHdheXMgYXNzaWduIHRvIGdlbmVyYWwgc3VwcG9ydCBjb21tdW5pdGllc1xuICAgIGF3YWl0IHRoaXMuYXNzaWduR2VuZXJhbFN1cHBvcnRDb21tdW5pdGllcyh1c2VySWQpO1xuXG4gICAgY29uc29sZS5sb2coXG4gICAgICBg8J+OryBBdXRvLWFzc2lnbm1lbnQgY29tcGxldGUuIEFzc2lnbmVkICR7YXNzaWduZWRDb21tdW5pdGllcy5sZW5ndGh9IGNvbW11bml0aWVzLmAsXG4gICAgKTtcbiAgICByZXR1cm4gYXNzaWduZWRDb21tdW5pdGllcztcbiAgfVxuXG4gIC8qKlxuICAgKiBBc3NpZ24gdXNlciB0byBnZW5lcmFsIHN1cHBvcnQgY29tbXVuaXRpZXMgcmVnYXJkbGVzcyBvZiBhc3Nlc3NtZW50IHJlc3VsdHNcbiAgICovXG4gIHByaXZhdGUgYXN5bmMgYXNzaWduR2VuZXJhbFN1cHBvcnRDb21tdW5pdGllcyh1c2VySWQ6IHN0cmluZyk6IFByb21pc2U8dm9pZD4ge1xuICAgIGNvbnN0IGdlbmVyYWxDb21tdW5pdGllcyA9IFsnU3VwcG9ydCBDaXJjbGUnLCAnTWluZGZ1bG5lc3MgJiBNZWRpdGF0aW9uJ107XG5cbiAgICBmb3IgKGNvbnN0IGNvbW11bml0eU5hbWUgb2YgZ2VuZXJhbENvbW11bml0aWVzKSB7XG4gICAgICBjb25zdCBjb21tdW5pdHkgPSBhd2FpdCB0aGlzLnByaXNtYS5jb21tdW5pdHkuZmluZEZpcnN0KHtcbiAgICAgICAgd2hlcmU6IHsgbmFtZTogY29tbXVuaXR5TmFtZSB9LFxuICAgICAgfSk7XG5cbiAgICAgIGlmICghY29tbXVuaXR5KSBjb250aW51ZTtcblxuICAgICAgLy8gQ2hlY2sgaWYgdXNlciBpcyBhbHJlYWR5IGEgbWVtYmVyXG4gICAgICBjb25zdCBleGlzdGluZ01lbWJlcnNoaXAgPSBhd2FpdCB0aGlzLnByaXNtYS5tZW1iZXJzaGlwLmZpbmRVbmlxdWUoe1xuICAgICAgICB3aGVyZToge1xuICAgICAgICAgIHVzZXJJZF9jb21tdW5pdHlJZDoge1xuICAgICAgICAgICAgdXNlcklkOiB1c2VySWQsXG4gICAgICAgICAgICBjb21tdW5pdHlJZDogY29tbXVuaXR5LmlkLFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICB9KTtcblxuICAgICAgaWYgKGV4aXN0aW5nTWVtYmVyc2hpcCkgY29udGludWU7XG5cbiAgICAgIHRyeSB7XG4gICAgICAgIGF3YWl0IHRoaXMucHJpc21hLm1lbWJlcnNoaXAuY3JlYXRlKHtcbiAgICAgICAgICBkYXRhOiB7XG4gICAgICAgICAgICB1c2VySWQ6IHVzZXJJZCxcbiAgICAgICAgICAgIGNvbW11bml0eUlkOiBjb21tdW5pdHkuaWQsXG4gICAgICAgICAgICBqb2luZWRBdDogbmV3IERhdGUoKSxcbiAgICAgICAgICB9LFxuICAgICAgICB9KTtcbiAgICAgICAgY29uc29sZS5sb2coYOKchSBBc3NpZ25lZCB1c2VyIHRvIGdlbmVyYWwgY29tbXVuaXR5OiAke2NvbW11bml0eS5uYW1lfWApO1xuICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgY29uc29sZS5lcnJvcihcbiAgICAgICAgICBg4p2MIEZhaWxlZCB0byBhc3NpZ24gZ2VuZXJhbCBjb21tdW5pdHkgJHtjb21tdW5pdHkubmFtZX06YCxcbiAgICAgICAgICBlcnJvcixcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogR2V0IGNvbW11bml0aWVzIGEgdXNlciBzaG91bGQgYmUgYXNzaWduZWQgdG8gYmFzZWQgb24gdGhlaXIgYXNzZXNzbWVudCAocHJldmlldyBtb2RlKVxuICAgKi9cbiAgYXN5bmMgZ2V0UmVjb21tZW5kZWRDb21tdW5pdGllcyh1c2VySWQ6IHN0cmluZyk6IFByb21pc2U8c3RyaW5nW10+IHtcbiAgICBjb25zdCB1c2VyQXNzZXNzbWVudCA9IGF3YWl0IHRoaXMucHJpc21hLnByZUFzc2Vzc21lbnQuZmluZEZpcnN0KHtcbiAgICAgIHdoZXJlOiB7IGNsaWVudElkOiB1c2VySWQgfSxcbiAgICAgIHNlbGVjdDoge1xuICAgICAgICBhbnN3ZXJzOiB0cnVlLFxuICAgICAgfSxcbiAgICB9KTtcblxuICAgIGlmICghdXNlckFzc2Vzc21lbnQpIHtcbiAgICAgIHJldHVybiBbXTtcbiAgICB9XG5cbiAgICAvLyBFeHRyYWN0IHNjb3JlcyBhbmQgc2V2ZXJpdHkgbGV2ZWxzIGZyb20gYW5zd2VycyBKU09OXG4gICAgY29uc3QgYXNzZXNzbWVudERhdGEgPSB1c2VyQXNzZXNzbWVudC5hbnN3ZXJzIGFzIGFueTtcbiAgICBpZiAoIWFzc2Vzc21lbnREYXRhIHx8IHR5cGVvZiBhc3Nlc3NtZW50RGF0YSAhPT0gJ29iamVjdCcpIHtcbiAgICAgIHJldHVybiBbXTtcbiAgICB9XG5cbiAgICBjb25zdCBzY29yZXMgPSBhc3Nlc3NtZW50RGF0YS5zY29yZXMgYXMgUHJlQXNzZXNzbWVudFNjb3JlcztcbiAgICBjb25zdCBzZXZlcml0eUxldmVscyA9IGFzc2Vzc21lbnREYXRhLnNldmVyaXR5TGV2ZWxzIGFzIFNldmVyaXR5TGV2ZWxzO1xuXG4gICAgaWYgKCFzY29yZXMgfHwgIXNldmVyaXR5TGV2ZWxzKSB7XG4gICAgICByZXR1cm4gW107XG4gICAgfVxuICAgIGNvbnN0IHJlY29tbWVuZGVkQ29tbXVuaXRpZXM6IHN0cmluZ1tdID0gW107XG5cbiAgICBmb3IgKGNvbnN0IFtxdWVzdGlvbm5haXJlXSBvZiBPYmplY3QuZW50cmllcyhzY29yZXMpKSB7XG4gICAgICBjb25zdCBzZXZlcml0eSA9IHNldmVyaXR5TGV2ZWxzW3F1ZXN0aW9ubmFpcmVdO1xuICAgICAgY29uc3QgY29tbXVuaXR5U2x1ZyA9IHRoaXMuUVVFU1RJT05OQUlSRV9UT19DT01NVU5JVFlfTUFQW3F1ZXN0aW9ubmFpcmVdO1xuXG4gICAgICBpZiAoY29tbXVuaXR5U2x1ZyAmJiB0aGlzLlNFVkVSSVRZX1RIUkVTSE9MRFtzZXZlcml0eT8udG9Mb3dlckNhc2UoKV0pIHtcbiAgICAgICAgY29uc3QgY29tbXVuaXR5ID0gSUxMTkVTU19DT01NVU5JVElFUy5maW5kKFxuICAgICAgICAgIChjKSA9PiBjLnNsdWcgPT09IGNvbW11bml0eVNsdWcsXG4gICAgICAgICk7XG4gICAgICAgIGlmIChjb21tdW5pdHkpIHtcbiAgICAgICAgICByZWNvbW1lbmRlZENvbW11bml0aWVzLnB1c2goY29tbXVuaXR5Lm5hbWUpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIHJlY29tbWVuZGVkQ29tbXVuaXRpZXM7XG4gIH1cblxuICAvKipcbiAgICogQnVsayBhc3NpZ24gY29tbXVuaXRpZXMgdG8gbXVsdGlwbGUgdXNlcnMgKHVzZWZ1bCBmb3IgZXhpc3RpbmcgdXNlcnMpXG4gICAqL1xuICBhc3luYyBidWxrQXNzaWduQ29tbXVuaXRpZXMoXG4gICAgdXNlcklkczogc3RyaW5nW10sXG4gICk6IFByb21pc2U8eyBbdXNlcklkOiBzdHJpbmddOiBzdHJpbmdbXSB9PiB7XG4gICAgY29uc3QgcmVzdWx0czogeyBbdXNlcklkOiBzdHJpbmddOiBzdHJpbmdbXSB9ID0ge307XG5cbiAgICBmb3IgKGNvbnN0IHVzZXJJZCBvZiB1c2VySWRzKSB7XG4gICAgICB0cnkge1xuICAgICAgICByZXN1bHRzW3VzZXJJZF0gPSBhd2FpdCB0aGlzLmFzc2lnbkNvbW11bml0aWVzVG9Vc2VyKHVzZXJJZCk7XG4gICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICBjb25zb2xlLmVycm9yKGBFcnJvciBhc3NpZ25pbmcgY29tbXVuaXRpZXMgdG8gdXNlciAke3VzZXJJZH06YCwgZXJyb3IpO1xuICAgICAgICByZXN1bHRzW3VzZXJJZF0gPSBbXTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gcmVzdWx0cztcbiAgfVxufVxuIl0sInZlcnNpb24iOjN9