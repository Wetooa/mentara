{"file":"/home/wetooa/Documents/code/projects/mentara/mentara-api/src/analytics/analytics.controller.ts","mappings":"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","names":[],"sources":["/home/wetooa/Documents/code/projects/mentara/mentara-api/src/analytics/analytics.controller.ts"],"sourcesContent":["import {\n  Controller,\n  Get,\n  Query,\n  UseGuards,\n  ForbiddenException,\n} from '@nestjs/common';\nimport { AnalyticsService } from './analytics.service';\nimport { JwtAuthGuard } from '../auth/guards/jwt-auth.guard';\nimport { CurrentUserId } from '../auth/decorators/current-user-id.decorator';\nimport { CurrentUserRole } from '../auth/decorators/current-user-role.decorator';\nimport { ZodValidationPipe } from '../common/pipes/zod-validation.pipe';\nimport {\n  PlatformAnalyticsQueryDtoSchema,\n  TherapistAnalyticsQueryDtoSchema,\n  ClientAnalyticsQueryDtoSchema,\n} from './validation/analytics.schemas';\nimport type {\n  PlatformAnalyticsQueryDto,\n  TherapistAnalyticsQueryDto,\n  ClientAnalyticsQueryDto,\n} from './types';\n\n@Controller('analytics')\n@UseGuards(JwtAuthGuard)\nexport class AnalyticsController {\n  constructor(private readonly analyticsService: AnalyticsService) {}\n\n  @Get('platform')\n  getPlatformAnalytics(\n    @CurrentUserRole() role: string,\n    @Query(new ZodValidationPipe(PlatformAnalyticsQueryDtoSchema))\n    query: PlatformAnalyticsQueryDto,\n  ) {\n    if (role !== 'admin') {\n      throw new ForbiddenException('Access denied: Admin role required');\n    }\n\n    const start = query.dateFrom ? new Date(query.dateFrom) : undefined;\n    const end = query.dateTo ? new Date(query.dateTo) : undefined;\n\n    return this.analyticsService.getPlatformAnalytics(start, end);\n  }\n\n  @Get('therapist')\n  getTherapistAnalytics(\n    @CurrentUserId() userId: string,\n    @CurrentUserRole() role: string,\n    @Query(new ZodValidationPipe(TherapistAnalyticsQueryDtoSchema))\n    query: TherapistAnalyticsQueryDto,\n  ) {\n    // Allow therapists to view their own analytics or admins to view any\n    const targetTherapistId = query.therapistId || userId;\n\n    if (role === 'therapist' && targetTherapistId !== userId) {\n      throw new ForbiddenException(\n        'Access denied: Can only view your own analytics',\n      );\n    }\n\n    if (role !== 'therapist' && role !== 'admin') {\n      throw new ForbiddenException(\n        'Access denied: Therapist or Admin role required',\n      );\n    }\n\n    const start = query.dateFrom ? new Date(query.dateFrom) : undefined;\n    const end = query.dateTo ? new Date(query.dateTo) : undefined;\n\n    return this.analyticsService.getTherapistAnalytics(\n      targetTherapistId,\n      start,\n      end,\n    );\n  }\n\n  @Get('client')\n  getClientAnalytics(\n    @CurrentUserId() userId: string,\n    @CurrentUserRole() role: string,\n    @Query(new ZodValidationPipe(ClientAnalyticsQueryDtoSchema))\n    query: ClientAnalyticsQueryDto,\n  ) {\n    // Allow clients to view their own analytics or admins/therapists to view assigned clients\n    const targetClientId = query.clientId || userId;\n\n    if (role === 'user' && targetClientId !== userId) {\n      throw new ForbiddenException(\n        'Access denied: Can only view your own analytics',\n      );\n    }\n\n    if (role !== 'user' && role !== 'therapist' && role !== 'admin') {\n      throw new ForbiddenException('Access denied: Invalid role');\n    }\n\n    const start = query.dateFrom ? new Date(query.dateFrom) : undefined;\n    const end = query.dateTo ? new Date(query.dateTo) : undefined;\n\n    return this.analyticsService.getClientAnalytics(targetClientId, start, end);\n  }\n}\n"],"version":3}