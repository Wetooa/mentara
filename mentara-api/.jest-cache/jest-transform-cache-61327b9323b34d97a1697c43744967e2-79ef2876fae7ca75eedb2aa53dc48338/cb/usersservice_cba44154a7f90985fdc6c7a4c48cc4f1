c3900c0d26d350f1d610bc5b548d9106
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.UsersService = void 0;
const common_1 = require("@nestjs/common");
const prisma_client_provider_1 = require("src/providers/prisma-client.provider");
const event_bus_service_1 = require("../common/events/event-bus.service");
const user_events_1 = require("../common/events/user-events");
let UsersService = class UsersService {
    prisma;
    eventBus;
    constructor(prisma, eventBus) {
        this.prisma = prisma;
        this.eventBus = eventBus;
    }
    async findById(id) {
        return await this.prisma.user.findUnique({
            where: {
                id,
                isActive: true, // Only return active users by default
            },
        });
    }
    async findByIdIncludeInactive(id) {
        // For administrative purposes - can see inactive users
        return await this.prisma.user.findUnique({
            where: { id },
        });
    }
    async findAll() {
        try {
            return await this.prisma.user.findMany({
                where: { isActive: true },
            });
        }
        catch (error) {
            throw new common_1.InternalServerErrorException(error instanceof Error ? error.message : String(error));
        }
    }
    async findOne(id) {
        try {
            return await this.prisma.user.findUnique({
                where: {
                    id,
                    isActive: true, // Only return active users
                },
                include: { therapist: true },
            });
        }
        catch (error) {
            throw new common_1.InternalServerErrorException(error instanceof Error ? error.message : String(error));
        }
    }
    async findOneIncludeInactive(id) {
        // For administrative purposes
        try {
            return await this.prisma.user.findUnique({
                where: { id },
                include: {
                    therapist: true,
                    client: true,
                    admin: true,
                    moderator: true,
                },
            });
        }
        catch (error) {
            throw new common_1.InternalServerErrorException(error instanceof Error ? error.message : String(error));
        }
    }
    async findByRole(role) {
        return await this.prisma.user.findMany({
            where: {
                role,
                isActive: true, // Only return active users
            },
        });
    }
    async findAllIncludeInactive() {
        // For administrative purposes - include inactive users
        try {
            return await this.prisma.user.findMany({
                orderBy: { createdAt: 'desc' },
            });
        }
        catch (error) {
            throw new common_1.InternalServerErrorException(error instanceof Error ? error.message : String(error));
        }
    }
    async update(id, data) {
        try {
            // Get previous values for audit trail
            const previousUser = await this.findById(id);
            if (!previousUser) {
                throw new common_1.InternalServerErrorException('User not found');
            }
            const updatedUser = await this.prisma.user.update({
                where: { id },
                data,
            });
            // Publish profile updated event
            await this.eventBus.emit(new user_events_1.UserProfileUpdatedEvent({
                userId: id,
                updatedFields: Object.keys(data),
                previousValues: this.extractUserFields(previousUser),
                newValues: this.extractUserFields(updatedUser),
            }));
            return updatedUser;
        }
        catch (error) {
            throw new common_1.InternalServerErrorException(`Failed to update user: ${error instanceof Error ? error.message : String(error)}`);
        }
    }
    async remove(id) {
        try {
            // Implement soft delete for HIPAA compliance
            const deactivatedUser = await this.prisma.user.update({
                where: { id },
                data: {
                    isActive: false,
                    suspendedAt: new Date(),
                    suspensionReason: 'Account deactivated by user',
                    // Keep all data intact for compliance
                },
            });
            // Publish user deactivation event
            await this.eventBus.emit(new user_events_1.UserDeactivatedEvent({
                userId: id,
                reason: 'Account deactivated by user',
                deactivatedBy: id, // Self-deactivation
                isTemporary: false,
            }));
            return deactivatedUser;
        }
        catch (error) {
            throw new common_1.InternalServerErrorException(`Failed to deactivate user: ${error instanceof Error ? error.message : String(error)}`);
        }
    }
    async deactivate(id, reason, deactivatedBy) {
        try {
            // Administrative deactivation with audit trail
            const deactivatedUser = await this.prisma.user.update({
                where: { id },
                data: {
                    isActive: false,
                    suspendedAt: new Date(),
                    suspendedBy: deactivatedBy,
                    suspensionReason: reason || 'Account deactivated by administrator',
                },
            });
            // Publish user deactivation event
            await this.eventBus.emit(new user_events_1.UserDeactivatedEvent({
                userId: id,
                reason: reason || 'Account deactivated by administrator',
                deactivatedBy: deactivatedBy || 'system',
                isTemporary: true, // Administrative deactivations are typically temporary
            }));
            return deactivatedUser;
        }
        catch (error) {
            throw new common_1.InternalServerErrorException(`Failed to deactivate user: ${error instanceof Error ? error.message : String(error)}`);
        }
    }
    async reactivate(id, reactivatedBy) {
        try {
            // Get user info for calculating inactive duration
            const user = await this.findByIdIncludeInactive(id);
            if (!user) {
                throw new common_1.InternalServerErrorException('User not found');
            }
            const inactiveDuration = user.suspendedAt
                ? Math.floor((Date.now() - user.suspendedAt.getTime()) / (1000 * 60 * 60 * 24))
                : 0;
            const reactivatedUser = await this.prisma.user.update({
                where: { id },
                data: {
                    isActive: true,
                    suspendedAt: null,
                    suspendedBy: null,
                    suspensionReason: null,
                },
            });
            // Publish user reactivation event
            await this.eventBus.emit(new user_events_1.UserReactivatedEvent({
                userId: id,
                reactivatedBy: reactivatedBy || 'system',
                inactiveDuration,
            }));
            return reactivatedUser;
        }
        catch (error) {
            throw new common_1.InternalServerErrorException(`Failed to reactivate user: ${error instanceof Error ? error.message : String(error)}`);
        }
    }
    async permanentDelete(id) {
        // Only for extreme cases with proper authorization
        // This should only be called by super admins after proper data retention period
        return await this.prisma.user.delete({
            where: { id },
        });
    }
    async getUserRole(id) {
        const user = await this.prisma.user.findUnique({
            where: { id },
            select: { role: true },
        });
        return user?.role || null;
    }
    // Add a user creation method that publishes events
    async create(data) {
        try {
            const newUser = await this.prisma.user.create({
                data,
            });
            // Publish user registration event
            await this.eventBus.emit(new user_events_1.UserRegisteredEvent({
                userId: newUser.id,
                email: newUser.email,
                firstName: newUser.firstName,
                lastName: newUser.lastName,
                role: newUser.role,
                registrationMethod: 'email', // Default, can be enhanced later
            }));
            return newUser;
        }
        catch (error) {
            throw new common_1.InternalServerErrorException(`Failed to create user: ${error instanceof Error ? error.message : String(error)}`);
        }
    }
    // Helper method to extract relevant user fields for events
    extractUserFields(user) {
        return {
            id: user.id,
            email: user.email,
            firstName: user.firstName,
            lastName: user.lastName,
            middleName: user.middleName,
            role: user.role,
            isActive: user.isActive,
            avatarUrl: user.avatarUrl,
            birthDate: user.birthDate,
            address: user.address,
            // Remove unsupported properties - these don't exist in User model
            createdAt: user.createdAt,
            updatedAt: user.updatedAt,
        };
    }
};
exports.UsersService = UsersService;
exports.UsersService = UsersService = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [prisma_client_provider_1.PrismaService,
        event_bus_service_1.EventBusService])
], UsersService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL3VzZXJzL3VzZXJzLnNlcnZpY2UudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7O0FBQUEsMkNBQTBFO0FBQzFFLGlGQUFxRTtBQUdyRSwwRUFBcUU7QUFDckUsOERBS3NDO0FBRy9CLElBQU0sWUFBWSxHQUFsQixNQUFNLFlBQVk7SUFFYjtJQUNBO0lBRlYsWUFDVSxNQUFxQixFQUNyQixRQUF5QjtRQUR6QixXQUFNLEdBQU4sTUFBTSxDQUFlO1FBQ3JCLGFBQVEsR0FBUixRQUFRLENBQWlCO0lBQ2hDLENBQUM7SUFFSixLQUFLLENBQUMsUUFBUSxDQUFDLEVBQVU7UUFDdkIsT0FBTyxNQUFNLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQztZQUN2QyxLQUFLLEVBQUU7Z0JBQ0wsRUFBRTtnQkFDRixRQUFRLEVBQUUsSUFBSSxFQUFFLHNDQUFzQzthQUN2RDtTQUNGLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFRCxLQUFLLENBQUMsdUJBQXVCLENBQUMsRUFBVTtRQUN0Qyx1REFBdUQ7UUFDdkQsT0FBTyxNQUFNLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQztZQUN2QyxLQUFLLEVBQUUsRUFBRSxFQUFFLEVBQUU7U0FDZCxDQUFDLENBQUM7SUFDTCxDQUFDO0lBRUQsS0FBSyxDQUFDLE9BQU87UUFDWCxJQUFJLENBQUM7WUFDSCxPQUFPLE1BQU0sSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDO2dCQUNyQyxLQUFLLEVBQUUsRUFBRSxRQUFRLEVBQUUsSUFBSSxFQUFFO2FBQzFCLENBQUMsQ0FBQztRQUNMLENBQUM7UUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1lBQ2YsTUFBTSxJQUFJLHFDQUE0QixDQUNwQyxLQUFLLFlBQVksS0FBSyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENB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IjpbIi9ob21lL3dldG9vYS9Eb2N1bWVudHMvY29kZS9wcm9qZWN0cy9tZW50YXJhL21lbnRhcmEtYXBpL3NyYy91c2Vycy91c2Vycy5zZXJ2aWNlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUsIEludGVybmFsU2VydmVyRXJyb3JFeGNlcHRpb24gfSBmcm9tICdAbmVzdGpzL2NvbW1vbic7XG5pbXBvcnQgeyBQcmlzbWFTZXJ2aWNlIH0gZnJvbSAnc3JjL3Byb3ZpZGVycy9wcmlzbWEtY2xpZW50LnByb3ZpZGVyJztcbmltcG9ydCB7IFVzZXIsIFByaXNtYSB9IGZyb20gJ0BwcmlzbWEvY2xpZW50JztcbmltcG9ydCB7IFVzZXJSb2xlIH0gZnJvbSAnc3JjL3V0aWxzL3JvbGUtdXRpbHMnO1xuaW1wb3J0IHsgRXZlbnRCdXNTZXJ2aWNlIH0gZnJvbSAnLi4vY29tbW9uL2V2ZW50cy9ldmVudC1idXMuc2VydmljZSc7XG5pbXBvcnQge1xuICBVc2VyUmVnaXN0ZXJlZEV2ZW50LFxuICBVc2VyUHJvZmlsZVVwZGF0ZWRFdmVudCxcbiAgVXNlckRlYWN0aXZhdGVkRXZlbnQsXG4gIFVzZXJSZWFjdGl2YXRlZEV2ZW50LFxufSBmcm9tICcuLi9jb21tb24vZXZlbnRzL3VzZXItZXZlbnRzJztcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIFVzZXJzU2VydmljZSB7XG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgcHJpc21hOiBQcmlzbWFTZXJ2aWNlLFxuICAgIHByaXZhdGUgZXZlbnRCdXM6IEV2ZW50QnVzU2VydmljZSxcbiAgKSB7fVxuXG4gIGFzeW5jIGZpbmRCeUlkKGlkOiBzdHJpbmcpOiBQcm9taXNlPFVzZXIgfCBudWxsPiB7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMucHJpc21hLnVzZXIuZmluZFVuaXF1ZSh7XG4gICAgICB3aGVyZToge1xuICAgICAgICBpZCxcbiAgICAgICAgaXNBY3RpdmU6IHRydWUsIC8vIE9ubHkgcmV0dXJuIGFjdGl2ZSB1c2VycyBieSBkZWZhdWx0XG4gICAgICB9LFxuICAgIH0pO1xuICB9XG5cbiAgYXN5bmMgZmluZEJ5SWRJbmNsdWRlSW5hY3RpdmUoaWQ6IHN0cmluZyk6IFByb21pc2U8VXNlciB8IG51bGw+IHtcbiAgICAvLyBGb3IgYWRtaW5pc3RyYXRpdmUgcHVycG9zZXMgLSBjYW4gc2VlIGluYWN0aXZlIHVzZXJzXG4gICAgcmV0dXJuIGF3YWl0IHRoaXMucHJpc21hLnVzZXIuZmluZFVuaXF1ZSh7XG4gICAgICB3aGVyZTogeyBpZCB9LFxuICAgIH0pO1xuICB9XG5cbiAgYXN5bmMgZmluZEFsbCgpOiBQcm9taXNlPFVzZXJbXT4ge1xuICAgIHRyeSB7XG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy5wcmlzbWEudXNlci5maW5kTWFueSh7XG4gICAgICAgIHdoZXJlOiB7IGlzQWN0aXZlOiB0cnVlIH0sXG4gICAgICB9KTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhyb3cgbmV3IEludGVybmFsU2VydmVyRXJyb3JFeGNlcHRpb24oXG4gICAgICAgIGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogU3RyaW5nKGVycm9yKSxcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgZmluZE9uZShpZDogc3RyaW5nKTogUHJvbWlzZTxVc2VyIHwgbnVsbD4ge1xuICAgIHRyeSB7XG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy5wcmlzbWEudXNlci5maW5kVW5pcXVlKHtcbiAgICAgICAgd2hlcmU6IHtcbiAgICAgICAgICBpZCxcbiAgICAgICAgICBpc0FjdGl2ZTogdHJ1ZSwgLy8gT25seSByZXR1cm4gYWN0aXZlIHVzZXJzXG4gICAgICAgIH0sXG4gICAgICAgIGluY2x1ZGU6IHsgdGhlcmFwaXN0OiB0cnVlIH0sXG4gICAgICB9KTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhyb3cgbmV3IEludGVybmFsU2VydmVyRXJyb3JFeGNlcHRpb24oXG4gICAgICAgIGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogU3RyaW5nKGVycm9yKSxcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgZmluZE9uZUluY2x1ZGVJbmFjdGl2ZShpZDogc3RyaW5nKTogUHJvbWlzZTxVc2VyIHwgbnVsbD4ge1xuICAgIC8vIEZvciBhZG1pbmlzdHJhdGl2ZSBwdXJwb3Nlc1xuICAgIHRyeSB7XG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy5wcmlzbWEudXNlci5maW5kVW5pcXVlKHtcbiAgICAgICAgd2hlcmU6IHsgaWQgfSxcbiAgICAgICAgaW5jbHVkZToge1xuICAgICAgICAgIHRoZXJhcGlzdDogdHJ1ZSxcbiAgICAgICAgICBjbGllbnQ6IHRydWUsXG4gICAgICAgICAgYWRtaW46IHRydWUsXG4gICAgICAgICAgbW9kZXJhdG9yOiB0cnVlLFxuICAgICAgICB9LFxuICAgICAgfSk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRocm93IG5ldyBJbnRlcm5hbFNlcnZlckVycm9yRXhjZXB0aW9uKFxuICAgICAgICBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6IFN0cmluZyhlcnJvciksXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGZpbmRCeVJvbGUocm9sZTogc3RyaW5nKTogUHJvbWlzZTxVc2VyW10+IHtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5wcmlzbWEudXNlci5maW5kTWFueSh7XG4gICAgICB3aGVyZToge1xuICAgICAgICByb2xlLFxuICAgICAgICBpc0FjdGl2ZTogdHJ1ZSwgLy8gT25seSByZXR1cm4gYWN0aXZlIHVzZXJzXG4gICAgICB9LFxuICAgIH0pO1xuICB9XG5cbiAgYXN5bmMgZmluZEFsbEluY2x1ZGVJbmFjdGl2ZSgpOiBQcm9taXNlPFVzZXJbXT4ge1xuICAgIC8vIEZvciBhZG1pbmlzdHJhdGl2ZSBwdXJwb3NlcyAtIGluY2x1ZGUgaW5hY3RpdmUgdXNlcnNcbiAgICB0cnkge1xuICAgICAgcmV0dXJuIGF3YWl0IHRoaXMucHJpc21hLnVzZXIuZmluZE1hbnkoe1xuICAgICAgICBvcmRlckJ5OiB7IGNyZWF0ZWRBdDogJ2Rlc2MnIH0sXG4gICAgICB9KTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhyb3cgbmV3IEludGVybmFsU2VydmVyRXJyb3JFeGNlcHRpb24oXG4gICAgICAgIGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogU3RyaW5nKGVycm9yKSxcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgdXBkYXRlKGlkOiBzdHJpbmcsIGRhdGE6IFByaXNtYS5Vc2VyVXBkYXRlSW5wdXQpOiBQcm9taXNlPFVzZXI+IHtcbiAgICB0cnkge1xuICAgICAgLy8gR2V0IHByZXZpb3VzIHZhbHVlcyBmb3IgYXVkaXQgdHJhaWxcbiAgICAgIGNvbnN0IHByZXZpb3VzVXNlciA9IGF3YWl0IHRoaXMuZmluZEJ5SWQoaWQpO1xuICAgICAgaWYgKCFwcmV2aW91c1VzZXIpIHtcbiAgICAgICAgdGhyb3cgbmV3IEludGVybmFsU2VydmVyRXJyb3JFeGNlcHRpb24oJ1VzZXIgbm90IGZvdW5kJyk7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHVwZGF0ZWRVc2VyID0gYXdhaXQgdGhpcy5wcmlzbWEudXNlci51cGRhdGUoe1xuICAgICAgICB3aGVyZTogeyBpZCB9LFxuICAgICAgICBkYXRhLFxuICAgICAgfSk7XG5cbiAgICAgIC8vIFB1Ymxpc2ggcHJvZmlsZSB1cGRhdGVkIGV2ZW50XG4gICAgICBhd2FpdCB0aGlzLmV2ZW50QnVzLmVtaXQoXG4gICAgICAgIG5ldyBVc2VyUHJvZmlsZVVwZGF0ZWRFdmVudCh7XG4gICAgICAgICAgdXNlcklkOiBpZCxcbiAgICAgICAgICB1cGRhdGVkRmllbGRzOiBPYmplY3Qua2V5cyhkYXRhKSxcbiAgICAgICAgICBwcmV2aW91c1ZhbHVlczogdGhpcy5leHRyYWN0VXNlckZpZWxkcyhwcmV2aW91c1VzZXIpLFxuICAgICAgICAgIG5ld1ZhbHVlczogdGhpcy5leHRyYWN0VXNlckZpZWxkcyh1cGRhdGVkVXNlciksXG4gICAgICAgIH0pLFxuICAgICAgKTtcblxuICAgICAgcmV0dXJuIHVwZGF0ZWRVc2VyO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aHJvdyBuZXcgSW50ZXJuYWxTZXJ2ZXJFcnJvckV4Y2VwdGlvbihcbiAgICAgICAgYEZhaWxlZCB0byB1cGRhdGUgdXNlcjogJHtlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6IFN0cmluZyhlcnJvcil9YCxcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgcmVtb3ZlKGlkOiBzdHJpbmcpOiBQcm9taXNlPFVzZXI+IHtcbiAgICB0cnkge1xuICAgICAgLy8gSW1wbGVtZW50IHNvZnQgZGVsZXRlIGZvciBISVBBQSBjb21wbGlhbmNlXG4gICAgICBjb25zdCBkZWFjdGl2YXRlZFVzZXIgPSBhd2FpdCB0aGlzLnByaXNtYS51c2VyLnVwZGF0ZSh7XG4gICAgICAgIHdoZXJlOiB7IGlkIH0sXG4gICAgICAgIGRhdGE6IHtcbiAgICAgICAgICBpc0FjdGl2ZTogZmFsc2UsXG4gICAgICAgICAgc3VzcGVuZGVkQXQ6IG5ldyBEYXRlKCksXG4gICAgICAgICAgc3VzcGVuc2lvblJlYXNvbjogJ0FjY291bnQgZGVhY3RpdmF0ZWQgYnkgdXNlcicsXG4gICAgICAgICAgLy8gS2VlcCBhbGwgZGF0YSBpbnRhY3QgZm9yIGNvbXBsaWFuY2VcbiAgICAgICAgfSxcbiAgICAgIH0pO1xuXG4gICAgICAvLyBQdWJsaXNoIHVzZXIgZGVhY3RpdmF0aW9uIGV2ZW50XG4gICAgICBhd2FpdCB0aGlzLmV2ZW50QnVzLmVtaXQoXG4gICAgICAgIG5ldyBVc2VyRGVhY3RpdmF0ZWRFdmVudCh7XG4gICAgICAgICAgdXNlcklkOiBpZCxcbiAgICAgICAgICByZWFzb246ICdBY2NvdW50IGRlYWN0aXZhdGVkIGJ5IHVzZXInLFxuICAgICAgICAgIGRlYWN0aXZhdGVkQnk6IGlkLCAvLyBTZWxmLWRlYWN0aXZhdGlvblxuICAgICAgICAgIGlzVGVtcG9yYXJ5OiBmYWxzZSxcbiAgICAgICAgfSksXG4gICAgICApO1xuXG4gICAgICByZXR1cm4gZGVhY3RpdmF0ZWRVc2VyO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aHJvdyBuZXcgSW50ZXJuYWxTZXJ2ZXJFcnJvckV4Y2VwdGlvbihcbiAgICAgICAgYEZhaWxlZCB0byBkZWFjdGl2YXRlIHVzZXI6ICR7ZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiBTdHJpbmcoZXJyb3IpfWAsXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGRlYWN0aXZhdGUoXG4gICAgaWQ6IHN0cmluZyxcbiAgICByZWFzb24/OiBzdHJpbmcsXG4gICAgZGVhY3RpdmF0ZWRCeT86IHN0cmluZyxcbiAgKTogUHJvbWlzZTxVc2VyPiB7XG4gICAgdHJ5IHtcbiAgICAgIC8vIEFkbWluaXN0cmF0aXZlIGRlYWN0aXZhdGlvbiB3aXRoIGF1ZGl0IHRyYWlsXG4gICAgICBjb25zdCBkZWFjdGl2YXRlZFVzZXIgPSBhd2FpdCB0aGlzLnByaXNtYS51c2VyLnVwZGF0ZSh7XG4gICAgICAgIHdoZXJlOiB7IGlkIH0sXG4gICAgICAgIGRhdGE6IHtcbiAgICAgICAgICBpc0FjdGl2ZTogZmFsc2UsXG4gICAgICAgICAgc3VzcGVuZGVkQXQ6IG5ldyBEYXRlKCksXG4gICAgICAgICAgc3VzcGVuZGVkQnk6IGRlYWN0aXZhdGVkQnksXG4gICAgICAgICAgc3VzcGVuc2lvblJlYXNvbjogcmVhc29uIHx8ICdBY2NvdW50IGRlYWN0aXZhdGVkIGJ5IGFkbWluaXN0cmF0b3InLFxuICAgICAgICB9LFxuICAgICAgfSk7XG5cbiAgICAgIC8vIFB1Ymxpc2ggdXNlciBkZWFjdGl2YXRpb24gZXZlbnRcbiAgICAgIGF3YWl0IHRoaXMuZXZlbnRCdXMuZW1pdChcbiAgICAgICAgbmV3IFVzZXJEZWFjdGl2YXRlZEV2ZW50KHtcbiAgICAgICAgICB1c2VySWQ6IGlkLFxuICAgICAgICAgIHJlYXNvbjogcmVhc29uIHx8ICdBY2NvdW50IGRlYWN0aXZhdGVkIGJ5IGFkbWluaXN0cmF0b3InLFxuICAgICAgICAgIGRlYWN0aXZhdGVkQnk6IGRlYWN0aXZhdGVkQnkgfHwgJ3N5c3RlbScsXG4gICAgICAgICAgaXNUZW1wb3Jhcnk6IHRydWUsIC8vIEFkbWluaXN0cmF0aXZlIGRlYWN0aXZhdGlvbnMgYXJlIHR5cGljYWxseSB0ZW1wb3JhcnlcbiAgICAgICAgfSksXG4gICAgICApO1xuXG4gICAgICByZXR1cm4gZGVhY3RpdmF0ZWRVc2VyO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aHJvdyBuZXcgSW50ZXJuYWxTZXJ2ZXJFcnJvckV4Y2VwdGlvbihcbiAgICAgICAgYEZhaWxlZCB0byBkZWFjdGl2YXRlIHVzZXI6ICR7ZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiBTdHJpbmcoZXJyb3IpfWAsXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIHJlYWN0aXZhdGUoaWQ6IHN0cmluZywgcmVhY3RpdmF0ZWRCeT86IHN0cmluZyk6IFByb21pc2U8VXNlcj4ge1xuICAgIHRyeSB7XG4gICAgICAvLyBHZXQgdXNlciBpbmZvIGZvciBjYWxjdWxhdGluZyBpbmFjdGl2ZSBkdXJhdGlvblxuICAgICAgY29uc3QgdXNlciA9IGF3YWl0IHRoaXMuZmluZEJ5SWRJbmNsdWRlSW5hY3RpdmUoaWQpO1xuICAgICAgaWYgKCF1c2VyKSB7XG4gICAgICAgIHRocm93IG5ldyBJbnRlcm5hbFNlcnZlckVycm9yRXhjZXB0aW9uKCdVc2VyIG5vdCBmb3VuZCcpO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBpbmFjdGl2ZUR1cmF0aW9uID0gdXNlci5zdXNwZW5kZWRBdFxuICAgICAgICA/IE1hdGguZmxvb3IoXG4gICAgICAgICAgICAoRGF0ZS5ub3coKSAtIHVzZXIuc3VzcGVuZGVkQXQuZ2V0VGltZSgpKSAvICgxMDAwICogNjAgKiA2MCAqIDI0KSxcbiAgICAgICAgICApXG4gICAgICAgIDogMDtcblxuICAgICAgY29uc3QgcmVhY3RpdmF0ZWRVc2VyID0gYXdhaXQgdGhpcy5wcmlzbWEudXNlci51cGRhdGUoe1xuICAgICAgICB3aGVyZTogeyBpZCB9LFxuICAgICAgICBkYXRhOiB7XG4gICAgICAgICAgaXNBY3RpdmU6IHRydWUsXG4gICAgICAgICAgc3VzcGVuZGVkQXQ6IG51bGwsXG4gICAgICAgICAgc3VzcGVuZGVkQnk6IG51bGwsXG4gICAgICAgICAgc3VzcGVuc2lvblJlYXNvbjogbnVsbCxcbiAgICAgICAgfSxcbiAgICAgIH0pO1xuXG4gICAgICAvLyBQdWJsaXNoIHVzZXIgcmVhY3RpdmF0aW9uIGV2ZW50XG4gICAgICBhd2FpdCB0aGlzLmV2ZW50QnVzLmVtaXQoXG4gICAgICAgIG5ldyBVc2VyUmVhY3RpdmF0ZWRFdmVudCh7XG4gICAgICAgICAgdXNlcklkOiBpZCxcbiAgICAgICAgICByZWFjdGl2YXRlZEJ5OiByZWFjdGl2YXRlZEJ5IHx8ICdzeXN0ZW0nLFxuICAgICAgICAgIGluYWN0aXZlRHVyYXRpb24sXG4gICAgICAgIH0pLFxuICAgICAgKTtcblxuICAgICAgcmV0dXJuIHJlYWN0aXZhdGVkVXNlcjtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhyb3cgbmV3IEludGVybmFsU2VydmVyRXJyb3JFeGNlcHRpb24oXG4gICAgICAgIGBGYWlsZWQgdG8gcmVhY3RpdmF0ZSB1c2VyOiAke2Vycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogU3RyaW5nKGVycm9yKX1gLFxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBwZXJtYW5lbnREZWxldGUoaWQ6IHN0cmluZyk6IFByb21pc2U8VXNlcj4ge1xuICAgIC8vIE9ubHkgZm9yIGV4dHJlbWUgY2FzZXMgd2l0aCBwcm9wZXIgYXV0aG9yaXphdGlvblxuICAgIC8vIFRoaXMgc2hvdWxkIG9ubHkgYmUgY2FsbGVkIGJ5IHN1cGVyIGFkbWlucyBhZnRlciBwcm9wZXIgZGF0YSByZXRlbnRpb24gcGVyaW9kXG4gICAgcmV0dXJuIGF3YWl0IHRoaXMucHJpc21hLnVzZXIuZGVsZXRlKHtcbiAgICAgIHdoZXJlOiB7IGlkIH0sXG4gICAgfSk7XG4gIH1cblxuICBhc3luYyBnZXRVc2VyUm9sZShpZDogc3RyaW5nKTogUHJvbWlzZTxVc2VyUm9sZSB8IG51bGw+IHtcbiAgICBjb25zdCB1c2VyID0gYXdhaXQgdGhpcy5wcmlzbWEudXNlci5maW5kVW5pcXVlKHtcbiAgICAgIHdoZXJlOiB7IGlkIH0sXG4gICAgICBzZWxlY3Q6IHsgcm9sZTogdHJ1ZSB9LFxuICAgIH0pO1xuICAgIHJldHVybiAodXNlcj8ucm9sZSBhcyBVc2VyUm9sZSkgfHwgbnVsbDtcbiAgfVxuXG4gIC8vIEFkZCBhIHVzZXIgY3JlYXRpb24gbWV0aG9kIHRoYXQgcHVibGlzaGVzIGV2ZW50c1xuICBhc3luYyBjcmVhdGUoZGF0YTogUHJpc21hLlVzZXJDcmVhdGVJbnB1dCk6IFByb21pc2U8VXNlcj4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBuZXdVc2VyID0gYXdhaXQgdGhpcy5wcmlzbWEudXNlci5jcmVhdGUoe1xuICAgICAgICBkYXRhLFxuICAgICAgfSk7XG5cbiAgICAgIC8vIFB1Ymxpc2ggdXNlciByZWdpc3RyYXRpb24gZXZlbnRcbiAgICAgIGF3YWl0IHRoaXMuZXZlbnRCdXMuZW1pdChcbiAgICAgICAgbmV3IFVzZXJSZWdpc3RlcmVkRXZlbnQoe1xuICAgICAgICAgIHVzZXJJZDogbmV3VXNlci5pZCxcbiAgICAgICAgICBlbWFpbDogbmV3VXNlci5lbWFpbCxcbiAgICAgICAgICBmaXJzdE5hbWU6IG5ld1VzZXIuZmlyc3ROYW1lLFxuICAgICAgICAgIGxhc3ROYW1lOiBuZXdVc2VyLmxhc3ROYW1lLFxuICAgICAgICAgIHJvbGU6IG5ld1VzZXIucm9sZSBhcyAnY2xpZW50JyB8ICd0aGVyYXBpc3QnIHwgJ21vZGVyYXRvcicgfCAnYWRtaW4nLFxuICAgICAgICAgIHJlZ2lzdHJhdGlvbk1ldGhvZDogJ2VtYWlsJywgLy8gRGVmYXVsdCwgY2FuIGJlIGVuaGFuY2VkIGxhdGVyXG4gICAgICAgIH0pLFxuICAgICAgKTtcblxuICAgICAgcmV0dXJuIG5ld1VzZXI7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRocm93IG5ldyBJbnRlcm5hbFNlcnZlckVycm9yRXhjZXB0aW9uKFxuICAgICAgICBgRmFpbGVkIHRvIGNyZWF0ZSB1c2VyOiAke2Vycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogU3RyaW5nKGVycm9yKX1gLFxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICAvLyBIZWxwZXIgbWV0aG9kIHRvIGV4dHJhY3QgcmVsZXZhbnQgdXNlciBmaWVsZHMgZm9yIGV2ZW50c1xuICBwcml2YXRlIGV4dHJhY3RVc2VyRmllbGRzKHVzZXI6IFVzZXIpOiBSZWNvcmQ8c3RyaW5nLCBhbnk+IHtcbiAgICByZXR1cm4ge1xuICAgICAgaWQ6IHVzZXIuaWQsXG4gICAgICBlbWFpbDogdXNlci5lbWFpbCxcbiAgICAgIGZpcnN0TmFtZTogdXNlci5maXJzdE5hbWUsXG4gICAgICBsYXN0TmFtZTogdXNlci5sYXN0TmFtZSxcbiAgICAgIG1pZGRsZU5hbWU6IHVzZXIubWlkZGxlTmFtZSxcbiAgICAgIHJvbGU6IHVzZXIucm9sZSxcbiAgICAgIGlzQWN0aXZlOiB1c2VyLmlzQWN0aXZlLFxuICAgICAgYXZhdGFyVXJsOiB1c2VyLmF2YXRhclVybCxcbiAgICAgIGJpcnRoRGF0ZTogdXNlci5iaXJ0aERhdGUsXG4gICAgICBhZGRyZXNzOiB1c2VyLmFkZHJlc3MsXG4gICAgICAvLyBSZW1vdmUgdW5zdXBwb3J0ZWQgcHJvcGVydGllcyAtIHRoZXNlIGRvbid0IGV4aXN0IGluIFVzZXIgbW9kZWxcbiAgICAgIGNyZWF0ZWRBdDogdXNlci5jcmVhdGVkQXQsXG4gICAgICB1cGRhdGVkQXQ6IHVzZXIudXBkYXRlZEF0LFxuICAgIH07XG4gIH1cbn1cbiJdLCJ2ZXJzaW9uIjozfQ==