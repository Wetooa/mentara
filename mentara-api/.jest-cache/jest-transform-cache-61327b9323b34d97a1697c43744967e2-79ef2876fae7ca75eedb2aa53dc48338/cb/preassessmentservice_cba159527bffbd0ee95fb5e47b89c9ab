55d8509730e75ee4c349540306ac84f9
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var PreAssessmentService_1;
var _a, _b;
Object.defineProperty(exports, "__esModule", { value: true });
exports.PreAssessmentService = void 0;
const common_1 = require("@nestjs/common");
const prisma_client_provider_1 = require("../providers/prisma-client.provider");
const pre_assessment_utils_1 = require("./pre-assessment.utils");
const ai_service_client_1 = require("./services/ai-service.client");
let PreAssessmentService = PreAssessmentService_1 = class PreAssessmentService {
    prisma;
    aiServiceClient;
    logger = new common_1.Logger(PreAssessmentService_1.name);
    constructor(prisma, aiServiceClient) {
        this.prisma = prisma;
        this.aiServiceClient = aiServiceClient;
    }
    async getAiEstimate(flatAnswers) {
        try {
            this.logger.debug(`Requesting AI prediction for ${flatAnswers.length} values`);
            const result = await this.aiServiceClient.predict(flatAnswers);
            if (!result.success) {
                this.logger.warn(`AI prediction failed: ${result.error}`);
                return null;
            }
            this.logger.log(`AI prediction completed successfully in ${result.responseTime}ms`);
            return result.predictions || null;
        }
        catch (error) {
            this.logger.error('AI model prediction error:', error instanceof Error ? error.message : error);
            return null;
        }
    }
    flattenAnswers(answers) {
        // Input validation
        if (!Array.isArray(answers)) {
            throw new common_1.BadRequestException('Answers must be a 2D array');
        }
        // Flatten the 2D answers array
        const flattened = answers.flat();
        // Validate flattened array
        if (!Array.isArray(flattened) || flattened.length === 0) {
            throw new common_1.BadRequestException('Flattened answers array cannot be empty');
        }
        // Validate all values are numbers
        if (!flattened.every((value) => typeof value === 'number' && Number.isFinite(value))) {
            throw new common_1.BadRequestException('All answer values must be finite numbers');
        }
        // Validate expected length for AI model
        if (flattened.length !== 201) {
            this.logger.warn(`Expected 201 values for AI prediction, got ${flattened.length}`);
        }
        this.logger.debug(`Flattened ${answers.length} questionnaire arrays into ${flattened.length} values`);
        return flattened;
    }
    validateAnswersStructure(answers) {
        if (!Array.isArray(answers)) {
            throw new common_1.BadRequestException('Answers must be an array of arrays');
        }
        if (answers.length === 0) {
            throw new common_1.BadRequestException('Answers array cannot be empty');
        }
        // Validate each questionnaire's answers
        for (let i = 0; i < answers.length; i++) {
            const questionnaire = answers[i];
            if (!Array.isArray(questionnaire)) {
                throw new common_1.BadRequestException(`Questionnaire ${i} answers must be an array`);
            }
            if (questionnaire.length === 0) {
                throw new common_1.BadRequestException(`Questionnaire ${i} cannot have empty answers`);
            }
            // Validate answer values are in reasonable range (0-10 for most scales)
            for (let j = 0; j < questionnaire.length; j++) {
                const value = questionnaire[j];
                if (typeof value !== 'number' || !Number.isFinite(value)) {
                    throw new common_1.BadRequestException(`Invalid answer value at questionnaire ${i}, question ${j}: ${value}`);
                }
                if (value < 0 || value > 10) {
                    throw new common_1.BadRequestException(`Answer value out of range (0-10) at questionnaire ${i}, question ${j}: ${value}`);
                }
            }
        }
    }
    validateQuestionnaires(questionnaires) {
        if (!Array.isArray(questionnaires)) {
            throw new common_1.BadRequestException('Questionnaires must be an array');
        }
        if (questionnaires.length === 0) {
            throw new common_1.BadRequestException('At least one questionnaire is required');
        }
        // Define valid questionnaire types
        const validQuestionnaires = [
            'Stress',
            'Anxiety',
            'Depression',
            'Insomnia',
            'Panic Disorder',
            'Bipolar Disorder',
            'OCD',
            'PTSD',
            'Social Anxiety',
            'Phobia',
            'Burnout',
            'Binge Eating',
            'ADHD',
            'Alcohol Use',
        ];
        for (const questionnaire of questionnaires) {
            if (typeof questionnaire !== 'string' ||
                questionnaire.trim().length === 0) {
                throw new common_1.BadRequestException('All questionnaire names must be non-empty strings');
            }
            if (!validQuestionnaires.includes(questionnaire)) {
                this.logger.warn(`Unknown questionnaire type: ${questionnaire}`);
            }
        }
    }
    async createPreAssessment(userId, data) {
        try {
            this.logger.log(`Creating pre-assessment for user ${userId}`);
            // Validate user exists and is active
            const user = await this.prisma.user.findUnique({
                where: { id: userId, isActive: true },
                select: { id: true, isActive: true },
            });
            if (!user) {
                throw new common_1.NotFoundException('User not found or inactive');
            }
            // Validate client exists
            const client = await this.prisma.client.findUnique({
                where: { userId: userId },
                select: { userId: true },
            });
            if (!client) {
                throw new common_1.NotFoundException('Client profile not found');
            }
            // Check for existing pre-assessment
            const existingAssessment = await this.prisma.preAssessment.findUnique({
                where: { clientId: userId },
            });
            if (existingAssessment) {
                throw new common_1.BadRequestException('Pre-assessment already exists for this user');
            }
            // Comprehensive input validation
            this.validateQuestionnaires(data.questionnaires);
            this.validateAnswersStructure(data.answers);
            // Validate questionnaires and answers alignment
            if (data.questionnaires.length !== data.answers.length) {
                throw new common_1.BadRequestException('Number of questionnaires must match number of answer arrays');
            }
            let scores = data.scores;
            let severityLevels = data.severityLevels;
            // Calculate scores if not provided
            if (!data.scores || !data.severityLevels) {
                this.logger.debug('Calculating scores and severity levels');
                const calculatedScores = (0, pre_assessment_utils_1.calculateAllScores)(data.questionnaires, data.answers);
                scores = Object.fromEntries(Object.entries(calculatedScores).map(([key, value]) => [
                    key,
                    value.score,
                ]));
                severityLevels = (0, pre_assessment_utils_1.generateSeverityLevels)(calculatedScores);
            }
            // Safely flatten answers and attempt AI prediction
            let aiEstimate = {};
            try {
                const flatAnswers = this.flattenAnswers(data.answers);
                if (flatAnswers.length === 201) {
                    this.logger.debug('Attempting AI prediction with validated input');
                    const aiResult = await this.getAiEstimate(flatAnswers);
                    if (aiResult) {
                        aiEstimate = aiResult;
                        this.logger.log('AI prediction successful');
                    }
                    else {
                        this.logger.warn('AI prediction failed, continuing without AI estimate');
                    }
                }
                else {
                    this.logger.warn(`Cannot perform AI prediction: expected 201 values, got ${flatAnswers.length}`);
                }
            }
            catch (aiError) {
                this.logger.error('AI prediction error, continuing without AI estimate:', aiError);
                // Continue without AI estimate - don't fail the entire assessment
            }
            // Create pre-assessment with validated data
            const preAssessment = await this.prisma.preAssessment.create({
                data: {
                    clientId: userId,
                    questionnaires: data.questionnaires,
                    answers: data.answers,
                    answerMatrix: data.answerMatrix,
                    scores,
                    severityLevels,
                    aiEstimate,
                },
            });
            this.logger.log(`Pre-assessment created successfully for user ${userId}`);
            return preAssessment;
        }
        catch (error) {
            if (error instanceof common_1.NotFoundException ||
                error instanceof common_1.BadRequestException) {
                throw error;
            }
            this.logger.error('Error creating pre-assessment:', error instanceof Error ? error.message : error);
            throw new common_1.InternalServerErrorException('Failed to create pre-assessment');
        }
    }
    handleError(error, message) {
        if (error instanceof common_1.NotFoundException) {
            throw error;
        }
        if (error instanceof Error) {
            console.error(message, error.message);
            throw new common_1.InternalServerErrorException(error.message);
        }
        console.error(message, error);
        throw new common_1.InternalServerErrorException(message);
    }
    async getPreAssessmentByUserId(userId) {
        try {
            const preAssessment = await this.prisma.preAssessment.findUnique({
                where: { clientId: userId },
            });
            if (!preAssessment) {
                throw new common_1.NotFoundException('Pre-assessment not found');
            }
            return preAssessment;
        }
        catch (error) {
            this.handleError(error, 'Error retrieving pre-assessment');
        }
    }
    async getPreAssessmentByClientId(clientId) {
        try {
            const preAssessment = await this.prisma.preAssessment.findUnique({
                where: { clientId: clientId },
                include: { client: { include: { user: true } } },
            });
            if (!preAssessment) {
                throw new common_1.NotFoundException('Pre-assessment not found');
            }
            return preAssessment;
        }
        catch (error) {
            this.handleError(error, 'Error retrieving pre-assessment');
        }
    }
    isValidScores(scores) {
        if (typeof scores !== 'object' || scores === null)
            return false;
        return Object.entries(scores).every(([key, value]) => typeof key === 'string' && typeof value === 'number');
    }
    isValidSeverityLevels(levels) {
        if (typeof levels !== 'object' || levels === null)
            return false;
        return Object.entries(levels).every(([key, value]) => typeof key === 'string' && typeof value === 'string');
    }
    async updatePreAssessment(userId, data) {
        try {
            const client = await this.prisma.client.findUnique({
                where: { userId: userId },
            });
            if (!client) {
                throw new common_1.NotFoundException('Client not found');
            }
            let scores;
            let severityLevels;
            if (data.scores && this.isValidScores(data.scores)) {
                scores = data.scores;
            }
            else {
                scores = {};
            }
            if (data.severityLevels &&
                this.isValidSeverityLevels(data.severityLevels)) {
                severityLevels = data.severityLevels;
            }
            else {
                severityLevels = {};
            }
            if (data.questionnaires &&
                data.answers &&
                (!data.scores || !data.severityLevels)) {
                const calculatedScores = (0, pre_assessment_utils_1.calculateAllScores)(data.questionnaires, data.answers);
                scores = Object.fromEntries(Object.entries(calculatedScores).map(([key, value]) => [
                    key,
                    value.score,
                ]));
                severityLevels = (0, pre_assessment_utils_1.generateSeverityLevels)(calculatedScores);
            }
            const preAssessment = await this.prisma.preAssessment.update({
                where: { clientId: userId },
                data: {
                    questionnaires: data.questionnaires,
                    answers: data.answers,
                    answerMatrix: data.answerMatrix,
                    scores,
                    severityLevels,
                },
            });
            if (!preAssessment) {
                throw new common_1.NotFoundException('Pre-assessment not found');
            }
            return preAssessment;
        }
        catch (error) {
            this.handleError(error, 'Error updating pre-assessment');
        }
    }
    async deletePreAssessment(userId) {
        try {
            await this.prisma.preAssessment.delete({
                where: { clientId: userId },
            });
            return null;
        }
        catch (error) {
            this.handleError(error, 'Error deleting pre-assessment');
        }
    }
};
exports.PreAssessmentService = PreAssessmentService;
exports.PreAssessmentService = PreAssessmentService = PreAssessmentService_1 = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [typeof (_a = typeof prisma_client_provider_1.PrismaService !== "undefined" && prisma_client_provider_1.PrismaService) === "function" ? _a : Object, typeof (_b = typeof ai_service_client_1.AiServiceClient !== "undefined" && ai_service_client_1.AiServiceClient) === "function" ? _b : Object])
], PreAssessmentService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL3ByZS1hc3Nlc3NtZW50L3ByZS1hc3Nlc3NtZW50LnNlcnZpY2UudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7QUFBQSwyQ0FNd0I7QUFDeEIsZ0ZBQW9FO0FBQ3BFLGlFQUdnQztBQUdoQyxvRUFBK0Q7QUFHeEQsSUFBTSxvQkFBb0IsNEJBQTFCLE1BQU0sb0JBQW9CO0lBSVo7SUFDQTtJQUpGLE1BQU0sR0FBRyxJQUFJLGVBQU0sQ0FBQyxzQkFBb0IsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUVoRSxZQUNtQixNQUFxQixFQUNyQixlQUFnQztRQURoQyxXQUFNLEdBQU4sTUFBTSxDQUFlO1FBQ3JCLG9CQUFlLEdBQWYsZUFBZSxDQUFpQjtJQUNoRCxDQUFDO0lBRUksS0FBSyxDQUFDLGFBQWEsQ0FDekIsV0FBcUI7UUFFckIsSUFBSSxDQUFDO1lBQ0gsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQ2YsZ0NBQWdDLFdBQVcsQ0FBQyxNQUFNLFNBQVMsQ0FDNUQsQ0FBQztZQUVGLE1BQU0sTUFBTSxHQUFHLE1BQU0sSUFBSSxDQUFDLGVBQWUsQ0FBQyxPQUFPLENBQUMsV0FBVyxDQUFDLENBQUM7WUFFL0QsSUFBSSxDQUFDLE1BQU0sQ0FBQyxPQUFPLEVBQUUsQ0FBQztnQkFDcEIsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMseUJBQXlCLE1BQU0sQ0FBQyxLQUFLLEVBQUUsQ0FBQyxDQUFDO2dCQUMxRCxPQUFPLElBQUksQ0FBQztZQUNkLENBQUM7WUFFRCxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FDYiwyQ0FBMkMsTUFBTSxDQUFDLFlBQVksSUFBSSxDQUNuRSxDQUFDO1lBQ0YsT0FBTyxNQUFNLENBQUMsV0FBVyxJQUFJLElBQUksQ0FBQztRQUNwQyxDQUFDO1FBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztZQUNmLElBQUksQ0FBQyxNQUFNLENBQUMs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QUFxQjtvQkFDbkMsWUFBWSxFQUFFLElBQUksQ0FBQyxZQUEwQjtvQkFDN0MsTUFBTTtvQkFDTixjQUFjO2lCQUNmO2FBQ0YsQ0FBQyxDQUFDO1lBRUgsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO2dCQUNuQixNQUFNLElBQUksMEJBQWlCLENBQUMsMEJBQTBCLENBQUMsQ0FBQztZQUMxRCxDQUFDO1lBRUQsT0FBTyxhQUFhLENBQUM7UUFDdkIsQ0FBQztRQUFDLE9BQU8sS0FBYyxFQUFFLENBQUM7WUFDeEIsSUFBSSxDQUFDLFdBQVcsQ0FBQyxLQUFLLEVBQUUsK0JBQStCLENBQUMsQ0FBQztRQUMzRCxDQUFDO0lBQ0gsQ0FBQztJQUVELEtBQUssQ0FBQyxtQkFBbUIsQ0FBQyxNQUFjO1FBQ3RDLElBQUksQ0FBQztZQUNILE1BQU0sSUFBSSxDQUFDLE1BQU0sQ0FBQyxhQUFhLENBQUMsTUFBTSxDQUFDO2dCQUNyQyxLQUFLLEVBQUUsRUFBRSxRQUFRLEVBQUUsTUFBTSxFQUFFO2FBQzVCLENBQUMsQ0FBQztZQUNILE9BQU8sSUFBSSxDQUFDO1FBQ2QsQ0FBQztRQUFDLE9BQU8sS0FBYyxFQUFFLENBQUM7WUFDeEIsSUFBSSxDQUFDLFdBQVcsQ0FBQyxLQUFLLEVBQUUsK0JBQStCLENBQUMsQ0FBQztRQUMzRCxDQUFDO0lBQ0gsQ0FBQztDQUNGLENBQUE7QUE1YVksb0RBQW9COytCQUFwQixvQkFBb0I7SUFEaEMsSUFBQSxtQkFBVSxHQUFFO3lEQUtnQixzQ0FBYSxvQkFBYixzQ0FBYSxvREFDSixtQ0FBZSxvQkFBZixtQ0FBZTtHQUx4QyxvQkFBb0IsQ0E0YWhDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9ob21lL3dldG9vYS9Eb2N1bWVudHMvY29kZS9wcm9qZWN0cy9tZW50YXJhL21lbnRhcmEtYXBpL3NyYy9wcmUtYXNzZXNzbWVudC9wcmUtYXNzZXNzbWVudC5zZXJ2aWNlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIEluamVjdGFibGUsXG4gIE5vdEZvdW5kRXhjZXB0aW9uLFxuICBJbnRlcm5hbFNlcnZlckVycm9yRXhjZXB0aW9uLFxuICBCYWRSZXF1ZXN0RXhjZXB0aW9uLFxuICBMb2dnZXIsXG59IGZyb20gJ0BuZXN0anMvY29tbW9uJztcbmltcG9ydCB7IFByaXNtYVNlcnZpY2UgfSBmcm9tICcuLi9wcm92aWRlcnMvcHJpc21hLWNsaWVudC5wcm92aWRlcic7XG5pbXBvcnQge1xuICBjYWxjdWxhdGVBbGxTY29yZXMsXG4gIGdlbmVyYXRlU2V2ZXJpdHlMZXZlbHMsXG59IGZyb20gJy4vcHJlLWFzc2Vzc21lbnQudXRpbHMnO1xuaW1wb3J0IHsgUHJlQXNzZXNzbWVudCB9IGZyb20gJ0BwcmlzbWEvY2xpZW50JztcbmltcG9ydCB7IENyZWF0ZVByZUFzc2Vzc21lbnREdG8gfSBmcm9tICcuLi8uLi9zY2hlbWEvcHJlLWFzc2Vzc21lbnQnO1xuaW1wb3J0IHsgQWlTZXJ2aWNlQ2xpZW50IH0gZnJvbSAnLi9zZXJ2aWNlcy9haS1zZXJ2aWNlLmNsaWVudCc7XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBQcmVBc3Nlc3NtZW50U2VydmljZSB7XG4gIHByaXZhdGUgcmVhZG9ubHkgbG9nZ2VyID0gbmV3IExvZ2dlcihQcmVBc3Nlc3NtZW50U2VydmljZS5uYW1lKTtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHJlYWRvbmx5IHByaXNtYTogUHJpc21hU2VydmljZSxcbiAgICBwcml2YXRlIHJlYWRvbmx5IGFpU2VydmljZUNsaWVudDogQWlTZXJ2aWNlQ2xpZW50LFxuICApIHt9XG5cbiAgcHJpdmF0ZSBhc3luYyBnZXRBaUVzdGltYXRlKFxuICAgIGZsYXRBbnN3ZXJzOiBudW1iZXJbXSxcbiAgKTogUHJvbWlzZTxSZWNvcmQ8c3RyaW5nLCBib29sZWFuPiB8IG51bGw+IHtcbiAgICB0cnkge1xuICAgICAgdGhpcy5sb2dnZXIuZGVidWcoXG4gICAgICAgIGBSZXF1ZXN0aW5nIEFJIHByZWRpY3Rpb24gZm9yICR7ZmxhdEFuc3dlcnMubGVuZ3RofSB2YWx1ZXNgLFxuICAgICAgKTtcblxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgdGhpcy5haVNlcnZpY2VDbGllbnQucHJlZGljdChmbGF0QW5zd2Vycyk7XG5cbiAgICAgIGlmICghcmVzdWx0LnN1Y2Nlc3MpIHtcbiAgICAgICAgdGhpcy5sb2dnZXIud2FybihgQUkgcHJlZGljdGlvbiBmYWlsZWQ6ICR7cmVzdWx0LmVycm9yfWApO1xuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgIH1cblxuICAgICAgdGhpcy5sb2dnZXIubG9nKFxuICAgICAgICBgQUkgcHJlZGljdGlvbiBjb21wbGV0ZWQgc3VjY2Vzc2Z1bGx5IGluICR7cmVzdWx0LnJlc3BvbnNlVGltZX1tc2AsXG4gICAgICApO1xuICAgICAgcmV0dXJuIHJlc3VsdC5wcmVkaWN0aW9ucyB8fCBudWxsO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aGlzLmxvZ2dlci5lcnJvcihcbiAgICAgICAgJ0FJIG1vZGVsIHByZWRpY3Rpb24gZXJyb3I6JyxcbiAgICAgICAgZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiBlcnJvcixcbiAgICAgICk7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGZsYXR0ZW5BbnN3ZXJzKGFuc3dlcnM6IG51bWJlcltdW10pOiBudW1iZXJbXSB7XG4gICAgLy8gSW5wdXQgdmFsaWRhdGlvblxuICAgIGlmICghQXJyYXkuaXNBcnJheShhbnN3ZXJzKSkge1xuICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFeGNlcHRpb24oJ0Fuc3dlcnMgbXVzdCBiZSBhIDJEIGFycmF5Jyk7XG4gICAgfVxuXG4gICAgLy8gRmxhdHRlbiB0aGUgMkQgYW5zd2VycyBhcnJheVxuICAgIGNvbnN0IGZsYXR0ZW5lZCA9IGFuc3dlcnMuZmxhdCgpO1xuXG4gICAgLy8gVmFsaWRhdGUgZmxhdHRlbmVkIGFycmF5XG4gICAgaWYgKCFBcnJheS5pc0FycmF5KGZsYXR0ZW5lZCkgfHwgZmxhdHRlbmVkLmxlbmd0aCA9PT0gMCkge1xuICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFeGNlcHRpb24oJ0ZsYXR0ZW5lZCBhbnN3ZXJzIGFycmF5IGNhbm5vdCBiZSBlbXB0eScpO1xuICAgIH1cblxuICAgIC8vIFZhbGlkYXRlIGFsbCB2YWx1ZXMgYXJlIG51bWJlcnNcbiAgICBpZiAoXG4gICAgICAhZmxhdHRlbmVkLmV2ZXJ5KFxuICAgICAgICAodmFsdWUpID0+IHR5cGVvZiB2YWx1ZSA9PT0gJ251bWJlcicgJiYgTnVtYmVyLmlzRmluaXRlKHZhbHVlKSxcbiAgICAgIClcbiAgICApIHtcbiAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0RXhjZXB0aW9uKCdBbGwgYW5zd2VyIHZhbHVlcyBtdXN0IGJlIGZpbml0ZSBudW1iZXJzJyk7XG4gICAgfVxuXG4gICAgLy8gVmFsaWRhdGUgZXhwZWN0ZWQgbGVuZ3RoIGZvciBBSSBtb2RlbFxuICAgIGlmIChmbGF0dGVuZWQubGVuZ3RoICE9PSAyMDEpIHtcbiAgICAgIHRoaXMubG9nZ2VyLndhcm4oXG4gICAgICAgIGBFeHBlY3RlZCAyMDEgdmFsdWVzIGZvciBBSSBwcmVkaWN0aW9uLCBnb3QgJHtmbGF0dGVuZWQubGVuZ3RofWAsXG4gICAgICApO1xuICAgIH1cblxuICAgIHRoaXMubG9nZ2VyLmRlYnVnKFxuICAgICAgYEZsYXR0ZW5lZCAke2Fuc3dlcnMubGVuZ3RofSBxdWVzdGlvbm5haXJlIGFycmF5cyBpbnRvICR7ZmxhdHRlbmVkLmxlbmd0aH0gdmFsdWVzYCxcbiAgICApO1xuICAgIHJldHVybiBmbGF0dGVuZWQ7XG4gIH1cblxuICBwcml2YXRlIHZhbGlkYXRlQW5zd2Vyc1N0cnVjdHVyZShhbnN3ZXJzOiBudW1iZXJbXVtdKTogdm9pZCB7XG4gICAgaWYgKCFBcnJheS5pc0FycmF5KGFuc3dlcnMpKSB7XG4gICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdEV4Y2VwdGlvbignQW5zd2VycyBtdXN0IGJlIGFuIGFycmF5IG9mIGFycmF5cycpO1xuICAgIH1cblxuICAgIGlmIChhbnN3ZXJzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFeGNlcHRpb24oJ0Fuc3dlcnMgYXJyYXkgY2Fubm90IGJlIGVtcHR5Jyk7XG4gICAgfVxuXG4gICAgLy8gVmFsaWRhdGUgZWFjaCBxdWVzdGlvbm5haXJlJ3MgYW5zd2Vyc1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYW5zd2Vycy5sZW5ndGg7IGkrKykge1xuICAgICAgY29uc3QgcXVlc3Rpb25uYWlyZSA9IGFuc3dlcnNbaV07XG5cbiAgICAgIGlmICghQXJyYXkuaXNBcnJheShxdWVzdGlvbm5haXJlKSkge1xuICAgICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdEV4Y2VwdGlvbihcbiAgICAgICAgICBgUXVlc3Rpb25uYWlyZSAke2l9IGFuc3dlcnMgbXVzdCBiZSBhbiBhcnJheWAsXG4gICAgICAgICk7XG4gICAgICB9XG5cbiAgICAgIGlmIChxdWVzdGlvbm5haXJlLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdEV4Y2VwdGlvbihcbiAgICAgICAgICBgUXVlc3Rpb25uYWlyZSAke2l9IGNhbm5vdCBoYXZlIGVtcHR5IGFuc3dlcnNgLFxuICAgICAgICApO1xuICAgICAgfVxuXG4gICAgICAvLyBWYWxpZGF0ZSBhbnN3ZXIgdmFsdWVzIGFyZSBpbiByZWFzb25hYmxlIHJhbmdlICgwLTEwIGZvciBtb3N0IHNjYWxlcylcbiAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgcXVlc3Rpb25uYWlyZS5sZW5ndGg7IGorKykge1xuICAgICAgICBjb25zdCB2YWx1ZSA9IHF1ZXN0aW9ubmFpcmVbal07XG5cbiAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZSAhPT0gJ251bWJlcicgfHwgIU51bWJlci5pc0Zpbml0ZSh2YWx1ZSkpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdEV4Y2VwdGlvbihcbiAgICAgICAgICAgIGBJbnZhbGlkIGFuc3dlciB2YWx1ZSBhdCBxdWVzdGlvbm5haXJlICR7aX0sIHF1ZXN0aW9uICR7an06ICR7dmFsdWV9YCxcbiAgICAgICAgICApO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHZhbHVlIDwgMCB8fCB2YWx1ZSA+IDEwKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFeGNlcHRpb24oXG4gICAgICAgICAgICBgQW5zd2VyIHZhbHVlIG91dCBvZiByYW5nZSAoMC0xMCkgYXQgcXVlc3Rpb25uYWlyZSAke2l9LCBxdWVzdGlvbiAke2p9OiAke3ZhbHVlfWAsXG4gICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgdmFsaWRhdGVRdWVzdGlvbm5haXJlcyhxdWVzdGlvbm5haXJlczogc3RyaW5nW10pOiB2b2lkIHtcbiAgICBpZiAoIUFycmF5LmlzQXJyYXkocXVlc3Rpb25uYWlyZXMpKSB7XG4gICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdEV4Y2VwdGlvbignUXVlc3Rpb25uYWlyZXMgbXVzdCBiZSBhbiBhcnJheScpO1xuICAgIH1cblxuICAgIGlmIChxdWVzdGlvbm5haXJlcy5sZW5ndGggPT09IDApIHtcbiAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0RXhjZXB0aW9uKCdBdCBsZWFzdCBvbmUgcXVlc3Rpb25uYWlyZSBpcyByZXF1aXJlZCcpO1xuICAgIH1cblxuICAgIC8vIERlZmluZSB2YWxpZCBxdWVzdGlvbm5haXJlIHR5cGVzXG4gICAgY29uc3QgdmFsaWRRdWVzdGlvbm5haXJlcyA9IFtcbiAgICAgICdTdHJlc3MnLFxuICAgICAgJ0FueGlldHknLFxuICAgICAgJ0RlcHJlc3Npb24nLFxuICAgICAgJ0luc29tbmlhJyxcbiAgICAgICdQYW5pYyBEaXNvcmRlcicsXG4gICAgICAnQmlwb2xhciBEaXNvcmRlcicsXG4gICAgICAnT0NEJyxcbiAgICAgICdQVFNEJyxcbiAgICAgICdTb2NpYWwgQW54aWV0eScsXG4gICAgICAnUGhvYmlhJyxcbiAgICAgICdCdXJub3V0JyxcbiAgICAgICdCaW5nZSBFYXRpbmcnLFxuICAgICAgJ0FESEQnLFxuICAgICAgJ0FsY29ob2wgVXNlJyxcbiAgICBdO1xuXG4gICAgZm9yIChjb25zdCBxdWVzdGlvbm5haXJlIG9mIHF1ZXN0aW9ubmFpcmVzKSB7XG4gICAgICBpZiAoXG4gICAgICAgIHR5cGVvZiBxdWVzdGlvbm5haXJlICE9PSAnc3RyaW5nJyB8fFxuICAgICAgICBxdWVzdGlvbm5haXJlLnRyaW0oKS5sZW5ndGggPT09IDBcbiAgICAgICkge1xuICAgICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdEV4Y2VwdGlvbihcbiAgICAgICAgICAnQWxsIHF1ZXN0aW9ubmFpcmUgbmFtZXMgbXVzdCBiZSBub24tZW1wdHkgc3RyaW5ncycsXG4gICAgICAgICk7XG4gICAgICB9XG5cbiAgICAgIGlmICghdmFsaWRRdWVzdGlvbm5haXJlcy5pbmNsdWRlcyhxdWVzdGlvbm5haXJlKSkge1xuICAgICAgICB0aGlzLmxvZ2dlci53YXJuKGBVbmtub3duIHF1ZXN0aW9ubmFpcmUgdHlwZTogJHtxdWVzdGlvbm5haXJlfWApO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGNyZWF0ZVByZUFzc2Vzc21lbnQoXG4gICAgdXNlcklkOiBzdHJpbmcsXG4gICAgZGF0YTogQ3JlYXRlUHJlQXNzZXNzbWVudER0byxcbiAgKTogUHJvbWlzZTxQcmVBc3Nlc3NtZW50PiB7XG4gICAgdHJ5IHtcbiAgICAgIHRoaXMubG9nZ2VyLmxvZyhgQ3JlYXRpbmcgcHJlLWFzc2Vzc21lbnQgZm9yIHVzZXIgJHt1c2VySWR9YCk7XG5cbiAgICAgIC8vIFZhbGlkYXRlIHVzZXIgZXhpc3RzIGFuZCBpcyBhY3RpdmVcbiAgICAgIGNvbnN0IHVzZXIgPSBhd2FpdCB0aGlzLnByaXNtYS51c2VyLmZpbmRVbmlxdWUoe1xuICAgICAgICB3aGVyZTogeyBpZDogdXNlcklkLCBpc0FjdGl2ZTogdHJ1ZSB9LFxuICAgICAgICBzZWxlY3Q6IHsgaWQ6IHRydWUsIGlzQWN0aXZlOiB0cnVlIH0sXG4gICAgICB9KTtcbiAgICAgIGlmICghdXNlcikge1xuICAgICAgICB0aHJvdyBuZXcgTm90Rm91bmRFeGNlcHRpb24oJ1VzZXIgbm90IGZvdW5kIG9yIGluYWN0aXZlJyk7XG4gICAgICB9XG5cbiAgICAgIC8vIFZhbGlkYXRlIGNsaWVudCBleGlzdHNcbiAgICAgIGNvbnN0IGNsaWVudCA9IGF3YWl0IHRoaXMucHJpc21hLmNsaWVudC5maW5kVW5pcXVlKHtcbiAgICAgICAgd2hlcmU6IHsgdXNlcklkOiB1c2VySWQgfSxcbiAgICAgICAgc2VsZWN0OiB7IHVzZXJJZDogdHJ1ZSB9LFxuICAgICAgfSk7XG4gICAgICBpZiAoIWNsaWVudCkge1xuICAgICAgICB0aHJvdyBuZXcgTm90Rm91bmRFeGNlcHRpb24oJ0NsaWVudCBwcm9maWxlIG5vdCBmb3VuZCcpO1xuICAgICAgfVxuXG4gICAgICAvLyBDaGVjayBmb3IgZXhpc3RpbmcgcHJlLWFzc2Vzc21lbnRcbiAgICAgIGNvbnN0IGV4aXN0aW5nQXNzZXNzbWVudCA9IGF3YWl0IHRoaXMucHJpc21hLnByZUFzc2Vzc21lbnQuZmluZFVuaXF1ZSh7XG4gICAgICAgIHdoZXJlOiB7IGNsaWVudElkOiB1c2VySWQgfSxcbiAgICAgIH0pO1xuICAgICAgaWYgKGV4aXN0aW5nQXNzZXNzbWVudCkge1xuICAgICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdEV4Y2VwdGlvbihcbiAgICAgICAgICAnUHJlLWFzc2Vzc21lbnQgYWxyZWFkeSBleGlzdHMgZm9yIHRoaXMgdXNlcicsXG4gICAgICAgICk7XG4gICAgICB9XG5cbiAgICAgIC8vIENvbXByZWhlbnNpdmUgaW5wdXQgdmFsaWRhdGlvblxuICAgICAgdGhpcy52YWxpZGF0ZVF1ZXN0aW9ubmFpcmVzKGRhdGEucXVlc3Rpb25uYWlyZXMpO1xuICAgICAgdGhpcy52YWxpZGF0ZUFuc3dlcnNTdHJ1Y3R1cmUoZGF0YS5hbnN3ZXJzKTtcblxuICAgICAgLy8gVmFsaWRhdGUgcXVlc3Rpb25uYWlyZXMgYW5kIGFuc3dlcnMgYWxpZ25tZW50XG4gICAgICBpZiAoZGF0YS5xdWVzdGlvbm5haXJlcy5sZW5ndGggIT09IGRhdGEuYW5zd2Vycy5sZW5ndGgpIHtcbiAgICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFeGNlcHRpb24oXG4gICAgICAgICAgJ051bWJlciBvZiBxdWVzdGlvbm5haXJlcyBtdXN0IG1hdGNoIG51bWJlciBvZiBhbnN3ZXIgYXJyYXlzJyxcbiAgICAgICAgKTtcbiAgICAgIH1cblxuICAgICAgbGV0IHNjb3JlczogUmVjb3JkPHN0cmluZywgbnVtYmVyPiA9IGRhdGEuc2NvcmVzIGFzIFJlY29yZDxcbiAgICAgICAgc3RyaW5nLFxuICAgICAgICBudW1iZXJcbiAgICAgID47XG4gICAgICBsZXQgc2V2ZXJpdHlMZXZlbHM6IFJlY29yZDxzdHJpbmcsIHN0cmluZz4gPVxuICAgICAgICBkYXRhLnNldmVyaXR5TGV2ZWxzIGFzIFJlY29yZDxzdHJpbmcsIHN0cmluZz47XG5cbiAgICAgIC8vIENhbGN1bGF0ZSBzY29yZXMgaWYgbm90IHByb3ZpZGVkXG4gICAgICBpZiAoIWRhdGEuc2NvcmVzIHx8ICFkYXRhLnNldmVyaXR5TGV2ZWxzKSB7XG4gICAgICAgIHRoaXMubG9nZ2VyLmRlYnVnKCdDYWxjdWxhdGluZyBzY29yZXMgYW5kIHNldmVyaXR5IGxldmVscycpO1xuICAgICAgICBjb25zdCBjYWxjdWxhdGVkU2NvcmVzID0gY2FsY3VsYXRlQWxsU2NvcmVzKFxuICAgICAgICAgIGRhdGEucXVlc3Rpb25uYWlyZXMsXG4gICAgICAgICAgZGF0YS5hbnN3ZXJzLFxuICAgICAgICApO1xuICAgICAgICBzY29yZXMgPSBPYmplY3QuZnJvbUVudHJpZXMoXG4gICAgICAgICAgT2JqZWN0LmVudHJpZXMoY2FsY3VsYXRlZFNjb3JlcykubWFwKChba2V5LCB2YWx1ZV0pID0+IFtcbiAgICAgICAgICAgIGtleSxcbiAgICAgICAgICAgIHZhbHVlLnNjb3JlLFxuICAgICAgICAgIF0pLFxuICAgICAgICApO1xuICAgICAgICBzZXZlcml0eUxldmVscyA9IGdlbmVyYXRlU2V2ZXJpdHlMZXZlbHMoY2FsY3VsYXRlZFNjb3Jlcyk7XG4gICAgICB9XG5cbiAgICAgIC8vIFNhZmVseSBmbGF0dGVuIGFuc3dlcnMgYW5kIGF0dGVtcHQgQUkgcHJlZGljdGlvblxuICAgICAgbGV0IGFpRXN0aW1hdGU6IFJlY29yZDxzdHJpbmcsIGJvb2xlYW4+ID0ge307XG4gICAgICB0cnkge1xuICAgICAgICBjb25zdCBmbGF0QW5zd2VycyA9IHRoaXMuZmxhdHRlbkFuc3dlcnMoZGF0YS5hbnN3ZXJzKTtcblxuICAgICAgICBpZiAoZmxhdEFuc3dlcnMubGVuZ3RoID09PSAyMDEpIHtcbiAgICAgICAgICB0aGlzLmxvZ2dlci5kZWJ1ZygnQXR0ZW1wdGluZyBBSSBwcmVkaWN0aW9uIHdpdGggdmFsaWRhdGVkIGlucHV0Jyk7XG4gICAgICAgICAgY29uc3QgYWlSZXN1bHQgPSBhd2FpdCB0aGlzLmdldEFpRXN0aW1hdGUoZmxhdEFuc3dlcnMpO1xuICAgICAgICAgIGlmIChhaVJlc3VsdCkge1xuICAgICAgICAgICAgYWlFc3RpbWF0ZSA9IGFpUmVzdWx0O1xuICAgICAgICAgICAgdGhpcy5sb2dnZXIubG9nKCdBSSBwcmVkaWN0aW9uIHN1Y2Nlc3NmdWwnKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5sb2dnZXIud2FybihcbiAgICAgICAgICAgICAgJ0FJIHByZWRpY3Rpb24gZmFpbGVkLCBjb250aW51aW5nIHdpdGhvdXQgQUkgZXN0aW1hdGUnLFxuICAgICAgICAgICAgKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdGhpcy5sb2dnZXIud2FybihcbiAgICAgICAgICAgIGBDYW5ub3QgcGVyZm9ybSBBSSBwcmVkaWN0aW9uOiBleHBlY3RlZCAyMDEgdmFsdWVzLCBnb3QgJHtmbGF0QW5zd2Vycy5sZW5ndGh9YCxcbiAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICB9IGNhdGNoIChhaUVycm9yKSB7XG4gICAgICAgIHRoaXMubG9nZ2VyLmVycm9yKFxuICAgICAgICAgICdBSSBwcmVkaWN0aW9uIGVycm9yLCBjb250aW51aW5nIHdpdGhvdXQgQUkgZXN0aW1hdGU6JyxcbiAgICAgICAgICBhaUVycm9yLFxuICAgICAgICApO1xuICAgICAgICAvLyBDb250aW51ZSB3aXRob3V0IEFJIGVzdGltYXRlIC0gZG9uJ3QgZmFpbCB0aGUgZW50aXJlIGFzc2Vzc21lbnRcbiAgICAgIH1cblxuICAgICAgLy8gQ3JlYXRlIHByZS1hc3Nlc3NtZW50IHdpdGggdmFsaWRhdGVkIGRhdGFcbiAgICAgIGNvbnN0IHByZUFzc2Vzc21lbnQgPSBhd2FpdCB0aGlzLnByaXNtYS5wcmVBc3Nlc3NtZW50LmNyZWF0ZSh7XG4gICAgICAgIGRhdGE6IHtcbiAgICAgICAgICBjbGllbnRJZDogdXNlcklkLFxuICAgICAgICAgIHF1ZXN0aW9ubmFpcmVzOiBkYXRhLnF1ZXN0aW9ubmFpcmVzLFxuICAgICAgICAgIGFuc3dlcnM6IGRhdGEuYW5zd2VycyxcbiAgICAgICAgICBhbnN3ZXJNYXRyaXg6IGRhdGEuYW5zd2VyTWF0cml4IGFzIG51bWJlcltdW10sXG4gICAgICAgICAgc2NvcmVzLFxuICAgICAgICAgIHNldmVyaXR5TGV2ZWxzLFxuICAgICAgICAgIGFpRXN0aW1hdGUsXG4gICAgICAgIH0sXG4gICAgICB9KTtcblxuICAgICAgdGhpcy5sb2dnZXIubG9nKGBQcmUtYXNzZXNzbWVudCBjcmVhdGVkIHN1Y2Nlc3NmdWxseSBmb3IgdXNlciAke3VzZXJJZH1gKTtcbiAgICAgIHJldHVybiBwcmVBc3Nlc3NtZW50O1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBpZiAoXG4gICAgICAgIGVycm9yIGluc3RhbmNlb2YgTm90Rm91bmRFeGNlcHRpb24gfHxcbiAgICAgICAgZXJyb3IgaW5zdGFuY2VvZiBCYWRSZXF1ZXN0RXhjZXB0aW9uXG4gICAgICApIHtcbiAgICAgICAgdGhyb3cgZXJyb3I7XG4gICAgICB9XG5cbiAgICAgIHRoaXMubG9nZ2VyLmVycm9yKFxuICAgICAgICAnRXJyb3IgY3JlYXRpbmcgcHJlLWFzc2Vzc21lbnQ6JyxcbiAgICAgICAgZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiBlcnJvcixcbiAgICAgICk7XG4gICAgICB0aHJvdyBuZXcgSW50ZXJuYWxTZXJ2ZXJFcnJvckV4Y2VwdGlvbignRmFpbGVkIHRvIGNyZWF0ZSBwcmUtYXNzZXNzbWVudCcpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgaGFuZGxlRXJyb3IoZXJyb3I6IHVua25vd24sIG1lc3NhZ2U6IHN0cmluZyk6IG5ldmVyIHtcbiAgICBpZiAoZXJyb3IgaW5zdGFuY2VvZiBOb3RGb3VuZEV4Y2VwdGlvbikge1xuICAgICAgdGhyb3cgZXJyb3I7XG4gICAgfVxuICAgIGlmIChlcnJvciBpbnN0YW5jZW9mIEVycm9yKSB7XG4gICAgICBjb25zb2xlLmVycm9yKG1lc3NhZ2UsIGVycm9yLm1lc3NhZ2UpO1xuICAgICAgdGhyb3cgbmV3IEludGVybmFsU2VydmVyRXJyb3JFeGNlcHRpb24oZXJyb3IubWVzc2FnZSk7XG4gICAgfVxuICAgIGNvbnNvbGUuZXJyb3IobWVzc2FnZSwgZXJyb3IpO1xuICAgIHRocm93IG5ldyBJbnRlcm5hbFNlcnZlckVycm9yRXhjZXB0aW9uKG1lc3NhZ2UpO1xuICB9XG5cbiAgYXN5bmMgZ2V0UHJlQXNzZXNzbWVudEJ5VXNlcklkKHVzZXJJZDogc3RyaW5nKTogUHJvbWlzZTxQcmVBc3Nlc3NtZW50PiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHByZUFzc2Vzc21lbnQgPSBhd2FpdCB0aGlzLnByaXNtYS5wcmVBc3Nlc3NtZW50LmZpbmRVbmlxdWUoe1xuICAgICAgICB3aGVyZTogeyBjbGllbnRJZDogdXNlcklkIH0sXG4gICAgICB9KTtcblxuICAgICAgaWYgKCFwcmVBc3Nlc3NtZW50KSB7XG4gICAgICAgIHRocm93IG5ldyBOb3RGb3VuZEV4Y2VwdGlvbignUHJlLWFzc2Vzc21lbnQgbm90IGZvdW5kJyk7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiBwcmVBc3Nlc3NtZW50O1xuICAgIH0gY2F0Y2ggKGVycm9yOiB1bmtub3duKSB7XG4gICAgICB0aGlzLmhhbmRsZUVycm9yKGVycm9yLCAnRXJyb3IgcmV0cmlldmluZyBwcmUtYXNzZXNzbWVudCcpO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGdldFByZUFzc2Vzc21lbnRCeUNsaWVudElkKGNsaWVudElkOiBzdHJpbmcpOiBQcm9taXNlPFByZUFzc2Vzc21lbnQ+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgcHJlQXNzZXNzbWVudCA9IGF3YWl0IHRoaXMucHJpc21hLnByZUFzc2Vzc21lbnQuZmluZFVuaXF1ZSh7XG4gICAgICAgIHdoZXJlOiB7IGNsaWVudElkOiBjbGllbnRJZCB9LFxuICAgICAgICBpbmNsdWRlOiB7IGNsaWVudDogeyBpbmNsdWRlOiB7IHVzZXI6IHRydWUgfSB9IH0sXG4gICAgICB9KTtcblxuICAgICAgaWYgKCFwcmVBc3Nlc3NtZW50KSB7XG4gICAgICAgIHRocm93IG5ldyBOb3RGb3VuZEV4Y2VwdGlvbignUHJlLWFzc2Vzc21lbnQgbm90IGZvdW5kJyk7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiBwcmVBc3Nlc3NtZW50O1xuICAgIH0gY2F0Y2ggKGVycm9yOiB1bmtub3duKSB7XG4gICAgICB0aGlzLmhhbmRsZUVycm9yKGVycm9yLCAnRXJyb3IgcmV0cmlldmluZyBwcmUtYXNzZXNzbWVudCcpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgaXNWYWxpZFNjb3JlcyhzY29yZXM6IHVua25vd24pOiBzY29yZXMgaXMgUmVjb3JkPHN0cmluZywgbnVtYmVyPiB7XG4gICAgaWYgKHR5cGVvZiBzY29yZXMgIT09ICdvYmplY3QnIHx8IHNjb3JlcyA9PT0gbnVsbCkgcmV0dXJuIGZhbHNlO1xuICAgIHJldHVybiBPYmplY3QuZW50cmllcyhzY29yZXMpLmV2ZXJ5KFxuICAgICAgKFtrZXksIHZhbHVlXSkgPT4gdHlwZW9mIGtleSA9PT0gJ3N0cmluZycgJiYgdHlwZW9mIHZhbHVlID09PSAnbnVtYmVyJyxcbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBpc1ZhbGlkU2V2ZXJpdHlMZXZlbHMoXG4gICAgbGV2ZWxzOiB1bmtub3duLFxuICApOiBsZXZlbHMgaXMgUmVjb3JkPHN0cmluZywgc3RyaW5nPiB7XG4gICAgaWYgKHR5cGVvZiBsZXZlbHMgIT09ICdvYmplY3QnIHx8IGxldmVscyA9PT0gbnVsbCkgcmV0dXJuIGZhbHNlO1xuICAgIHJldHVybiBPYmplY3QuZW50cmllcyhsZXZlbHMpLmV2ZXJ5KFxuICAgICAgKFtrZXksIHZhbHVlXSkgPT4gdHlwZW9mIGtleSA9PT0gJ3N0cmluZycgJiYgdHlwZW9mIHZhbHVlID09PSAnc3RyaW5nJyxcbiAgICApO1xuICB9XG5cbiAgYXN5bmMgdXBkYXRlUHJlQXNzZXNzbWVudChcbiAgICB1c2VySWQ6IHN0cmluZyxcbiAgICBkYXRhOiBQYXJ0aWFsPENyZWF0ZVByZUFzc2Vzc21lbnREdG8+LFxuICApOiBQcm9taXNlPFByZUFzc2Vzc21lbnQ+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgY2xpZW50ID0gYXdhaXQgdGhpcy5wcmlzbWEuY2xpZW50LmZpbmRVbmlxdWUoe1xuICAgICAgICB3aGVyZTogeyB1c2VySWQ6IHVzZXJJZCB9LFxuICAgICAgfSk7XG4gICAgICBpZiAoIWNsaWVudCkge1xuICAgICAgICB0aHJvdyBuZXcgTm90Rm91bmRFeGNlcHRpb24oJ0NsaWVudCBub3QgZm91bmQnKTtcbiAgICAgIH1cblxuICAgICAgbGV0IHNjb3JlczogUmVjb3JkPHN0cmluZywgbnVtYmVyPjtcbiAgICAgIGxldCBzZXZlcml0eUxldmVsczogUmVjb3JkPHN0cmluZywgc3RyaW5nPjtcblxuICAgICAgaWYgKGRhdGEuc2NvcmVzICYmIHRoaXMuaXNWYWxpZFNjb3JlcyhkYXRhLnNjb3JlcykpIHtcbiAgICAgICAgc2NvcmVzID0gZGF0YS5zY29yZXM7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBzY29yZXMgPSB7fTtcbiAgICAgIH1cblxuICAgICAgaWYgKFxuICAgICAgICBkYXRhLnNldmVyaXR5TGV2ZWxzICYmXG4gICAgICAgIHRoaXMuaXNWYWxpZFNldmVyaXR5TGV2ZWxzKGRhdGEuc2V2ZXJpdHlMZXZlbHMpXG4gICAgICApIHtcbiAgICAgICAgc2V2ZXJpdHlMZXZlbHMgPSBkYXRhLnNldmVyaXR5TGV2ZWxzO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgc2V2ZXJpdHlMZXZlbHMgPSB7fTtcbiAgICAgIH1cblxuICAgICAgaWYgKFxuICAgICAgICBkYXRhLnF1ZXN0aW9ubmFpcmVzICYmXG4gICAgICAgIGRhdGEuYW5zd2VycyAmJlxuICAgICAgICAoIWRhdGEuc2NvcmVzIHx8ICFkYXRhLnNldmVyaXR5TGV2ZWxzKVxuICAgICAgKSB7XG4gICAgICAgIGNvbnN0IGNhbGN1bGF0ZWRTY29yZXMgPSBjYWxjdWxhdGVBbGxTY29yZXMoXG4gICAgICAgICAgZGF0YS5xdWVzdGlvbm5haXJlcyxcbiAgICAgICAgICBkYXRhLmFuc3dlcnMsXG4gICAgICAgICk7XG4gICAgICAgIHNjb3JlcyA9IE9iamVjdC5mcm9tRW50cmllcyhcbiAgICAgICAgICBPYmplY3QuZW50cmllcyhjYWxjdWxhdGVkU2NvcmVzKS5tYXAoKFtrZXksIHZhbHVlXSkgPT4gW1xuICAgICAgICAgICAga2V5LFxuICAgICAgICAgICAgdmFsdWUuc2NvcmUsXG4gICAgICAgICAgXSksXG4gICAgICAgICk7XG4gICAgICAgIHNldmVyaXR5TGV2ZWxzID0gZ2VuZXJhdGVTZXZlcml0eUxldmVscyhjYWxjdWxhdGVkU2NvcmVzKTtcbiAgICAgIH1cblxuICAgICAgY29uc3QgcHJlQXNzZXNzbWVudCA9IGF3YWl0IHRoaXMucHJpc21hLnByZUFzc2Vzc21lbnQudXBkYXRlKHtcbiAgICAgICAgd2hlcmU6IHsgY2xpZW50SWQ6IHVzZXJJZCB9LFxuICAgICAgICBkYXRhOiB7XG4gICAgICAgICAgcXVlc3Rpb25uYWlyZXM6IGRhdGEucXVlc3Rpb25uYWlyZXMgYXMgc3RyaW5nW10sXG4gICAgICAgICAgYW5zd2VyczogZGF0YS5hbnN3ZXJzIGFzIG51bWJlcltdW10sXG4gICAgICAgICAgYW5zd2VyTWF0cml4OiBkYXRhLmFuc3dlck1hdHJpeCBhcyBudW1iZXJbXVtdLFxuICAgICAgICAgIHNjb3JlcyxcbiAgICAgICAgICBzZXZlcml0eUxldmVscyxcbiAgICAgICAgfSxcbiAgICAgIH0pO1xuXG4gICAgICBpZiAoIXByZUFzc2Vzc21lbnQpIHtcbiAgICAgICAgdGhyb3cgbmV3IE5vdEZvdW5kRXhjZXB0aW9uKCdQcmUtYXNzZXNzbWVudCBub3QgZm91bmQnKTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHByZUFzc2Vzc21lbnQ7XG4gICAgfSBjYXRjaCAoZXJyb3I6IHVua25vd24pIHtcbiAgICAgIHRoaXMuaGFuZGxlRXJyb3IoZXJyb3IsICdFcnJvciB1cGRhdGluZyBwcmUtYXNzZXNzbWVudCcpO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGRlbGV0ZVByZUFzc2Vzc21lbnQodXNlcklkOiBzdHJpbmcpOiBQcm9taXNlPG51bGw+IHtcbiAgICB0cnkge1xuICAgICAgYXdhaXQgdGhpcy5wcmlzbWEucHJlQXNzZXNzbWVudC5kZWxldGUoe1xuICAgICAgICB3aGVyZTogeyBjbGllbnRJZDogdXNlcklkIH0sXG4gICAgICB9KTtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH0gY2F0Y2ggKGVycm9yOiB1bmtub3duKSB7XG4gICAgICB0aGlzLmhhbmRsZUVycm9yKGVycm9yLCAnRXJyb3IgZGVsZXRpbmcgcHJlLWFzc2Vzc21lbnQnKTtcbiAgICB9XG4gIH1cbn1cbiJdLCJ2ZXJzaW9uIjozfQ==