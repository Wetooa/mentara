{"file":"/home/wetooa/Documents/code/projects/mentara/mentara-api/src/test-utils/database-test.setup.ts","mappings":";;;AAAA,6CAAsD;AACtD,gFAAoE;AACpE,2DAGoC;AAEpC,MAAa,iBAAiB;IACpB,MAAM,CAAC,SAAS,CAA6B;IAC7C,MAAM,CAAC,aAAa,CAAgB;IAE5C,MAAM,CAAC,KAAK,CAAC,cAAc;QACzB,IAAI,CAAC,IAAI,CAAC,SAAS,EAAE,CAAC;YACpB,IAAI,CAAC,SAAS,GAAG,MAAM,IAAI,gCAAmB,CAAC,aAAa,CAAC;iBAC1D,YAAY,CAAC,cAAc,CAAC;iBAC5B,YAAY,CAAC,WAAW,CAAC;iBACzB,YAAY,CAAC,eAAe,CAAC;iBAC7B,gBAAgB,CAAC,IAAI,CAAC;iBACtB,KAAK,EAAE,CAAC;QACb,CAAC;QACD,OAAO,IAAI,CAAC,SAAS,CAAC;IACxB,CAAC;IAED,MAAM,CAAC,KAAK,CAAC,iBAAiB;QAC5B,MAAM,SAAS,GAAG,MAAM,IAAI,CAAC,cAAc,EAAE,CAAC;QAE9C,6CAA6C;QAC7C,OAAO,CAAC,GAAG,CAAC,YAAY,GAAG,SAAS,CAAC,gBAAgB,EAAE,CAAC;QAExD,MAAM,MAAM,GAAkB,MAAM,cAAI,CAAC,mBAAmB,CAAC;YAC3D,SAAS,EAAE,CAAC,sCAAa,CAAC;SAC3B,CAAC,CAAC,OAAO,EAAE,CAAC;QAEb,IAAI,CAAC,aAAa,GAAG,MAAM,CAAC,GAAG,CAAgB,sCAAa,CAAC,CAAC;QAE9D,iBAAiB;QACjB,iEAAiE;QACjE,MAAM,EAAE,QAAQ,EAAE,GAAG,OAAO,CAAC,eAAe,CAAC,CAAC;QAC9C,QAAQ,CAAC,2BAA2B,EAAE;YACpC,GAAG,EAAE,EAAE,GAAG,OAAO,CAAC,GAAG,EAAE,YAAY,EAAE,SAAS,CAAC,gBAAgB,EAAE,EAAE;SACpE,CAAC,CAAC;QAEH,OAAO,IAAI,CAAC,aAAa,CAAC;IAC5B,CAAC;IAED,MAAM,CAAC,KAAK,CAAC,eAAe;QAC1B,IAAI,IAAI,CAAC,aAAa,EAAE,CAAC;YACvB,2EAA2E;YAC3E,MAAM,UAAU,GAAG;gBACjB,WAAW;gBACX,OAAO;gBACP,cAAc;gBACd,SAAS;gBACT,MAAM;gBACN,YAAY;gBACZ,SAAS;gBACT,uBAAuB;gBACvB,iBAAiB;gBACjB,WAAW;gBACX,QAAQ;gBACR,eAAe;gBACf,MAAM;gBACN,WAAW;gBACX,WAAW;gBACX,MAAM;aACP,CAAC;YAEF,KAAK,MAAM,SAAS,IAAI,UAAU,EAAE,CAAC;gBACnC,IAAI,CAAC;oBACH,MAAM,IAAI,CAAC,aAAa,CAAC,iBAAiB,CACxC,mBAAmB,SAAS,6BAA6B,CAC1D,CAAC;gBACJ,CAAC;gBAAC,MAAM,CAAC;oBACP,gCAAgC;gBAClC,CAAC;YACH,CAAC;QACH,CAAC;IACH,CAAC;IAED,MAAM,CAAC,KAAK,CAAC,aAAa;QACxB,IAAI,IAAI,CAAC,SAAS,EAAE,CAAC;YACnB,MAAM,IAAI,CAAC,SAAS,CAAC,IAAI,EAAE,CAAC;QAC9B,CAAC;IACH,CAAC;IAED,MAAM,CAAC,gBAAgB;QACrB,OAAO,IAAI,CAAC,aAAa,CAAC;IAC5B,CAAC;CACF;AAjFD,8CAiFC","names":[],"sources":["/home/wetooa/Documents/code/projects/mentara/mentara-api/src/test-utils/database-test.setup.ts"],"sourcesContent":["import { Test, TestingModule } from '@nestjs/testing';\nimport { PrismaService } from '../providers/prisma-client.provider';\nimport {\n  PostgreSqlContainer,\n  StartedPostgreSqlContainer,\n} from '@testcontainers/postgresql';\n\nexport class DatabaseTestSetup {\n  private static container: StartedPostgreSqlContainer;\n  private static prismaService: PrismaService;\n\n  static async startContainer(): Promise<StartedPostgreSqlContainer> {\n    if (!this.container) {\n      this.container = await new PostgreSqlContainer('postgres:15')\n        .withDatabase('mentara_test')\n        .withUsername('test_user')\n        .withPassword('test_password')\n        .withExposedPorts(5432)\n        .start();\n    }\n    return this.container;\n  }\n\n  static async setupTestDatabase(): Promise<PrismaService> {\n    const container = await this.startContainer();\n\n    // Set environment variable for test database\n    process.env.DATABASE_URL = container.getConnectionUri();\n\n    const module: TestingModule = await Test.createTestingModule({\n      providers: [PrismaService],\n    }).compile();\n\n    this.prismaService = module.get<PrismaService>(PrismaService);\n\n    // Run migrations\n    // eslint-disable-next-line @typescript-eslint/no-require-imports\n    const { execSync } = require('child_process');\n    execSync('npx prisma migrate deploy', {\n      env: { ...process.env, DATABASE_URL: container.getConnectionUri() },\n    });\n\n    return this.prismaService;\n  }\n\n  static async cleanupDatabase(): Promise<void> {\n    if (this.prismaService) {\n      // Clean all tables in the correct order to respect foreign key constraints\n      const tableNames = [\n        'PostHeart',\n        'Reply',\n        'CommentHeart',\n        'Comment',\n        'Post',\n        'Membership',\n        'Meeting',\n        'TherapistAvailability',\n        'ClientTherapist',\n        'Therapist',\n        'Client',\n        'PreAssessment',\n        'User',\n        'Community',\n        'RoomGroup',\n        'Room',\n      ];\n\n      for (const tableName of tableNames) {\n        try {\n          await this.prismaService.$executeRawUnsafe(\n            `TRUNCATE TABLE \"${tableName}\" RESTART IDENTITY CASCADE;`,\n          );\n        } catch {\n          // Ignore if table doesn't exist\n        }\n      }\n    }\n  }\n\n  static async stopContainer(): Promise<void> {\n    if (this.container) {\n      await this.container.stop();\n    }\n  }\n\n  static getPrismaService(): PrismaService {\n    return this.prismaService;\n  }\n}\n"],"version":3}