0a81c34d233c218f2a319a99d45abc77
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
exports.AvailabilityValidatorService = void 0;
const common_1 = require("@nestjs/common");
const prisma_client_provider_1 = require("../../providers/prisma-client.provider");
let AvailabilityValidatorService = class AvailabilityValidatorService {
    prisma;
    defaultConfig = {
        allowedDurations: [30, 60, 90, 120],
        timeFormat: 'HH:MM',
        timezone: 'UTC',
        businessHours: {
            start: '08:00',
            end: '20:00',
        },
        advanceBooking: {
            minHours: 2,
            maxDays: 90,
        },
        weekendBooking: true,
    };
    constructor(prisma) {
        this.prisma = prisma;
    }
    /**
     * Validate time format (HH:MM or HH:mm)
     */
    validateTimeFormat(timeString, format = 'HH:MM') {
        const regex = format === 'HH:MM'
            ? /^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$/
            : /^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$/;
        if (!regex.test(timeString)) {
            throw new common_1.BadRequestException(`Invalid time format. Expected ${format} format (e.g., 09:30)`);
        }
        return true;
    }
    /**
     * Validate meeting duration
     */
    validateDuration(duration, allowedDurations) {
        const allowed = allowedDurations || this.defaultConfig.allowedDurations;
        if (!allowed.includes(duration)) {
            throw new common_1.BadRequestException(`Invalid duration. Allowed durations are: ${allowed.join(', ')} minutes`);
        }
        return true;
    }
    /**
     * Validate booking date and time constraints
     */
    validateBookingDateTime(startTime, duration, config = {}) {
        const finalConfig = { ...this.defaultConfig, ...config };
        this.validateAdvanceBooking(startTime, finalConfig);
        this.validateBusinessHours(startTime, duration, finalConfig);
        this.validateWeekendBooking(startTime, finalConfig);
        this.validateDuration(duration, finalConfig.allowedDurations);
        return true;
    }
    /**
     * Validate advance booking constraints
     */
    validateAdvanceBooking(startTime, config) {
        const now = new Date();
        const timeDiff = startTime.getTime() - now.getTime();
        const hoursDiff = timeDiff / (1000 * 60 * 60);
        const daysDiff = timeDiff / (1000 * 60 * 60 * 24);
        if (hoursDiff < config.advanceBooking.minHours) {
            throw new common_1.BadRequestException(`Bookings must be made at least ${config.advanceBooking.minHours} hours in advance`);
        }
        if (daysDiff > config.advanceBooking.maxDays) {
            throw new common_1.BadRequestException(`Bookings can only be made up to ${config.advanceBooking.maxDays} days in advance`);
        }
    }
    /**
     * Validate business hours constraints
     */
    validateBusinessHours(startTime, duration, config) {
        const endTime = new Date(startTime.getTime() + duration * 60 * 1000);
        const startTimeStr = this.formatTime(startTime);
        const endTimeStr = this.formatTime(endTime);
        if (startTimeStr < config.businessHours.start ||
            endTimeStr > config.businessHours.end) {
            throw new common_1.BadRequestException(`Meeting must be within business hours (${config.businessHours.start} - ${config.businessHours.end})`);
        }
    }
    /**
     * Validate weekend booking if not allowed
     */
    validateWeekendBooking(startTime, config) {
        if (!config.weekendBooking) {
            const dayOfWeek = startTime.getDay();
            if (dayOfWeek === 0 || dayOfWeek === 6) {
                // Sunday = 0, Saturday = 6
                throw new common_1.BadRequestException('Weekend bookings are not allowed');
            }
        }
    }
    /**
     * Check if therapist is available at the specified time
     */
    /**
     * Validate therapist availability with transaction support and timezone handling
     */
    async validateTherapistAvailabilityWithTransaction(therapistId, startTime, duration, prismaClient, // Accept transaction client or regular prisma
    therapistTimezone) {
        // Get therapist timezone if not provided
        if (!therapistTimezone) {
            const therapist = await prismaClient.therapist.findUnique({
                where: { userId: therapistId },
                select: { timezone: true },
            });
            therapistTimezone = therapist?.timezone || 'UTC';
        }
        // Convert to therapist's timezone for day/time extraction (best practice: keep UTC, convert only for extraction)
        // Use Intl.DateTimeFormat for proper timezone conversion without string parsing issues
        const therapistFormatter = new Intl.DateTimeFormat('en-US', {
            timeZone: therapistTimezone,
            weekday: 'long',
            hour: '2-digit',
            minute: '2-digit',
            hour12: false,
        });
        const endTime = new Date(startTime.getTime() + duration * 60 * 1000);
        const endFormatter = new Intl.DateTimeFormat('en-US', {
            timeZone: therapistTimezone,
            hour: '2-digit',
            minute: '2-digit',
            hour12: false,
        });
        // Extract day and time components in therapist's timezone
        const startParts = therapistFormatter.formatToParts(startTime);
        const endParts = endFormatter.formatToParts(endTime);
        // Get day name from parts (already formatted as "Monday", "Tuesday", etc.)
        const dayOfWeek = startParts
            .find(part => part.type === 'weekday')?.value.toUpperCase() || 'UNKNOWN';
        // Get time strings in HH:MM format from parts
        const startHour = startParts.find(part => part.type === 'hour')?.value || '00';
        const startMinute = startParts.find(part => part.type === 'minute')?.value || '00';
        const endHour = endParts.find(part => part.type === 'hour')?.value || '00';
        const endMinute = endParts.find(part => part.type === 'minute')?.value || '00';
        const startTimeStr = `${startHour}:${startMinute}`;
        const endTimeStr = `${endHour}:${endMinute}`;
        const availability = await prismaClient.therapistAvailability.findFirst({
            where: {
                therapistId,
                dayOfWeek,
                startTime: { lte: startTimeStr },
                endTime: { gte: endTimeStr },
                isAvailable: true,
            },
        });
        if (!availability) {
            throw new common_1.BadRequestException(`Therapist is not available at the requested time (${startTimeStr}-${endTimeStr} ${dayOfWeek} in ${therapistTimezone})`);
        }
        return true;
    }
    /**
     * Check if therapist is available at the specified time
     */
    async validateTherapistAvailability(therapistId, startTime, duration) {
        // Convert numeric day to day name string to match database schema
        const dayOfWeek = startTime
            .toLocaleDateString('en-US', { weekday: 'long' })
            .toUpperCase();
        const startTimeStr = this.formatTime(startTime);
        const endTime = new Date(startTime.getTime() + duration * 60 * 1000);
        const endTimeStr = this.formatTime(endTime);
        const availability = await this.prisma.therapistAvailability.findFirst({
            where: {
                therapistId,
                dayOfWeek,
                startTime: { lte: startTimeStr },
                endTime: { gte: endTimeStr },
                isAvailable: true,
            },
        });
        if (!availability) {
            throw new common_1.BadRequestException('Therapist is not available at the requested time');
        }
        return true;
    }
    /**
     * Validate client-therapist relationship exists
     */
    async validateClientTherapistRelationship(clientId, therapistId) {
        const relationship = await this.prisma.clientTherapist.findFirst({
            where: {
                clientId,
                therapistId,
            },
        });
        if (!relationship) {
            throw new common_1.BadRequestException('You can only book sessions with your assigned therapists');
        }
        return true;
    }
    /**
     * Validate therapist exists and is active
     */
    async validateTherapistExists(therapistId) {
        const therapist = await this.prisma.therapist.findFirst({
            where: {
                userId: therapistId,
                status: 'APPROVED',
            },
            include: {
                user: {
                    select: {
                        isActive: true,
                    },
                },
            },
        });
        if (!therapist || !therapist.user.isActive) {
            throw new common_1.BadRequestException('Therapist not found or inactive');
        }
        return true;
    }
    /**
     * Validate availability slot overlap
     */
    validateAvailabilityOverlap(startTime1, endTime1, startTime2, endTime2) {
        if (startTime1 >= endTime1) {
            throw new common_1.BadRequestException('Start time must be before end time');
        }
        if (startTime2 >= endTime2) {
            throw new common_1.BadRequestException('Start time must be before end time');
        }
        const hasOverlap = startTime1 < endTime2 && endTime1 > startTime2;
        if (hasOverlap) {
            throw new common_1.BadRequestException('Availability slot overlaps with existing availability');
        }
        return true;
    }
    /**
     * Validate timezone (if timezone support is needed)
     */
    validateTimezone(timezone) {
        try {
            // Check if timezone is valid
            Intl.DateTimeFormat(undefined, { timeZone: timezone });
            return true;
        }
        catch {
            throw new common_1.BadRequestException(`Invalid timezone: ${timezone}`);
        }
    }
    /**
     * Comprehensive validation for meeting creation
     */
    async validateMeetingCreation({ therapistId, clientId, startTime, duration, config = {}, }) {
        // Run all validations
        await Promise.all([
            this.validateTherapistExists(therapistId),
            this.validateClientTherapistRelationship(clientId, therapistId),
            this.validateTherapistAvailability(therapistId, startTime, duration),
        ]);
        this.validateBookingDateTime(startTime, duration, config);
        return true;
    }
    /**
     * Comprehensive validation for availability creation
     */
    async validateAvailabilityCreation({ therapistId, dayOfWeek, startTime, endTime, }) {
        // Validate therapist exists
        await this.validateTherapistExists(therapistId);
        // Validate time formats
        this.validateTimeFormat(startTime);
        this.validateTimeFormat(endTime);
        // Validate time range
        if (startTime >= endTime) {
            throw new common_1.BadRequestException('Start time must be before end time');
        }
        // Validate day of week
        if (dayOfWeek < 0 || dayOfWeek > 6) {
            throw new common_1.BadRequestException('Day of week must be between 0 (Sunday) and 6 (Saturday)');
        }
        // Convert numeric day to day name string to match database schema
        const dayOfWeekString = new Date(2024, 0, dayOfWeek) // Use dummy date with desired day
            .toLocaleDateString('en-US', { weekday: 'long' })
            .toUpperCase();
        // Check for overlapping availability
        const overlapping = await this.prisma.therapistAvailability.findFirst({
            where: {
                therapistId,
                dayOfWeek: dayOfWeekString,
                OR: [
                    {
                        startTime: { lt: endTime },
                        endTime: { gt: startTime },
                    },
                ],
            },
        });
        if (overlapping) {
            throw new common_1.BadRequestException('Availability slot overlaps with existing availability');
        }
        return true;
    }
    /**
     * Format Date to HH:MM string
     */
    formatTime(date) {
        return date.toTimeString().slice(0, 5);
    }
    /**
     * Parse time string to minutes since midnight
     */
    parseTimeToMinutes(timeString) {
        const [hours, minutes] = timeString.split(':').map(Number);
        return hours * 60 + minutes;
    }
    /**
     * Convert minutes since midnight to HH:MM string
     */
    minutesToTimeString(minutes) {
        const hours = Math.floor(minutes / 60);
        const mins = minutes % 60;
        return `${hours.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}`;
    }
};
exports.AvailabilityValidatorService = AvailabilityValidatorService;
exports.AvailabilityValidatorService = AvailabilityValidatorService = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [typeof (_a = typeof prisma_client_provider_1.PrismaService !== "undefined" && prisma_client_provider_1.PrismaService) === "function" ? _a : Object])
], AvailabilityValidatorService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL2Jvb2tpbmcvc2VydmljZXMvYXZhaWxhYmlsaXR5LXZhbGlkYXRvci5zZXJ2aWNlLnRzIiwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7QUFBQSwyQ0FBaUU7QUFDakUsbUZBQXVFO0FBa0JoRSxJQUFNLDRCQUE0QixHQUFsQyxNQUFNLDRCQUE0QjtJQWdCVjtJQWZaLGFBQWEsR0FBcUI7UUFDakQsZ0JBQWdCLEVBQUUsQ0FBQyxFQUFFLEVBQUUsRUFBRSxFQUFFLEVBQUUsRUFBRSxHQUFHLENBQUM7UUFDbkMsVUFBVSxFQUFFLE9BQU87UUFDbkIsUUFBUSxFQUFFLEtBQUs7UUFDZixhQUFhLEVBQUU7WUFDYixLQUFLLEVBQUUsT0FBTztZQUNkLEdBQUcsRUFBRSxPQUFPO1NBQ2I7UUFDRCxjQUFjLEVBQUU7WUFDZCxRQUFRLEVBQUUsQ0FBQztZQUNYLE9BQU8sRUFBRSxFQUFFO1NBQ1o7UUFDRCxjQUFjLEVBQUUsSUFBSTtLQUNyQixDQUFDO0lBRUYsWUFBNkIsTUFBcUI7UUFBckIsV0FBTSxHQUFOLE1BQU0sQ0FBZTtJQUFHLENBQUM7SUFFdEQ7O09BRUc7SUFDSCxrQkFBa0IsQ0FDaEIsVUFBa0IsRUFDbEIsU0FBNEIsT0FBTztRQUVuQyxNQUFNLEtBQUssR0FDVCxNQUFNLEtBQUssT0FBTztZQUNoQixDQUFDLENBQUMsbUNBQW1DO1lBQ3JDLENBQUMsQ0FBQyxtQ0FBbUMsQ0FBQztRQUUxQyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsRUFBRSxDQUFDO1lBQzVCLE1BQU0sSUFBSSw0QkFBbUIsQ0FDM0IsaUNBQWlDLE1BQU0sdUJBQXVCLENBQy9ELENBQUM7UUFDSixDQUFDO1FBQ0QsT0FBTyxJQUFJLENBQUM7SUFDZCxDQUFDO0lBRUQ7O09BRUc7SUFDSCxnQkFBZ0IsQ0FBQyxRQUFnQixFQUFFLGdCQUEyQjtRQUM1RCxNQUFNLE9BQU8sR0FB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RSxDQUFDLFFBQVEsQ0FBQyxDQUFDLEVBQUUsR0FBRyxDQUFDLElBQUksSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDLFFBQVEsQ0FBQyxDQUFDLEVBQUUsR0FBRyxDQUFDLEVBQUUsQ0FBQztJQUNwRixDQUFDO0NBQ0YsQ0FBQTtBQS9iWSxvRUFBNEI7dUNBQTVCLDRCQUE0QjtJQUR4QyxJQUFBLG1CQUFVLEdBQUU7eURBaUIwQixzQ0FBYSxvQkFBYixzQ0FBYTtHQWhCdkMsNEJBQTRCLENBK2J4QyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvaG9tZS93ZXRvb2EvRG9jdW1lbnRzL2NvZGUvcHJvamVjdHMvbWVudGFyYS9tZW50YXJhLWFwaS9zcmMvYm9va2luZy9zZXJ2aWNlcy9hdmFpbGFiaWxpdHktdmFsaWRhdG9yLnNlcnZpY2UudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSwgQmFkUmVxdWVzdEV4Y2VwdGlvbiB9IGZyb20gJ0BuZXN0anMvY29tbW9uJztcbmltcG9ydCB7IFByaXNtYVNlcnZpY2UgfSBmcm9tICcuLi8uLi9wcm92aWRlcnMvcHJpc21hLWNsaWVudC5wcm92aWRlcic7XG5cbmV4cG9ydCBpbnRlcmZhY2UgVmFsaWRhdGlvbkNvbmZpZyB7XG4gIGFsbG93ZWREdXJhdGlvbnM6IG51bWJlcltdOyAvLyBtaW51dGVzXG4gIHRpbWVGb3JtYXQ6ICdISDpNTScgfCAnSEg6bW0nO1xuICB0aW1lem9uZTogc3RyaW5nO1xuICBidXNpbmVzc0hvdXJzOiB7XG4gICAgc3RhcnQ6IHN0cmluZzsgLy8gSEg6TU1cbiAgICBlbmQ6IHN0cmluZzsgLy8gSEg6TU1cbiAgfTtcbiAgYWR2YW5jZUJvb2tpbmc6IHtcbiAgICBtaW5Ib3VyczogbnVtYmVyO1xuICAgIG1heERheXM6IG51bWJlcjtcbiAgfTtcbiAgd2Vla2VuZEJvb2tpbmc6IGJvb2xlYW47XG59XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBBdmFpbGFiaWxpdHlWYWxpZGF0b3JTZXJ2aWNlIHtcbiAgcHJpdmF0ZSByZWFkb25seSBkZWZhdWx0Q29uZmlnOiBWYWxpZGF0aW9uQ29uZmlnID0ge1xuICAgIGFsbG93ZWREdXJhdGlvbnM6IFszMCwgNjAsIDkwLCAxMjBdLFxuICAgIHRpbWVGb3JtYXQ6ICdISDpNTScsXG4gICAgdGltZXpvbmU6ICdVVEMnLFxuICAgIGJ1c2luZXNzSG91cnM6IHtcbiAgICAgIHN0YXJ0OiAnMDg6MDAnLFxuICAgICAgZW5kOiAnMjA6MDAnLFxuICAgIH0sXG4gICAgYWR2YW5jZUJvb2tpbmc6IHtcbiAgICAgIG1pbkhvdXJzOiAyLFxuICAgICAgbWF4RGF5czogOTAsXG4gICAgfSxcbiAgICB3ZWVrZW5kQm9va2luZzogdHJ1ZSxcbiAgfTtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIHJlYWRvbmx5IHByaXNtYTogUHJpc21hU2VydmljZSkge31cblxuICAvKipcbiAgICogVmFsaWRhdGUgdGltZSBmb3JtYXQgKEhIOk1NIG9yIEhIOm1tKVxuICAgKi9cbiAgdmFsaWRhdGVUaW1lRm9ybWF0KFxuICAgIHRpbWVTdHJpbmc6IHN0cmluZyxcbiAgICBmb3JtYXQ6ICdISDpNTScgfCAnSEg6bW0nID0gJ0hIOk1NJyxcbiAgKTogYm9vbGVhbiB7XG4gICAgY29uc3QgcmVnZXggPVxuICAgICAgZm9ybWF0ID09PSAnSEg6TU0nXG4gICAgICAgID8gL14oWzAtMV0/WzAtOV18MlswLTNdKTpbMC01XVswLTldJC9cbiAgICAgICAgOiAvXihbMC0xXT9bMC05XXwyWzAtM10pOlswLTVdWzAtOV0kLztcblxuICAgIGlmICghcmVnZXgudGVzdCh0aW1lU3RyaW5nKSkge1xuICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFeGNlcHRpb24oXG4gICAgICAgIGBJbnZhbGlkIHRpbWUgZm9ybWF0LiBFeHBlY3RlZCAke2Zvcm1hdH0gZm9ybWF0IChlLmcuLCAwOTozMClgLFxuICAgICAgKTtcbiAgICB9XG4gICAgcmV0dXJuIHRydWU7XG4gIH1cblxuICAvKipcbiAgICogVmFsaWRhdGUgbWVldGluZyBkdXJhdGlvblxuICAgKi9cbiAgdmFsaWRhdGVEdXJhdGlvbihkdXJhdGlvbjogbnVtYmVyLCBhbGxvd2VkRHVyYXRpb25zPzogbnVtYmVyW10pOiBib29sZWFuIHtcbiAgICBjb25zdCBhbGxvd2VkID0gYWxsb3dlZER1cmF0aW9ucyB8fCB0aGlzLmRlZmF1bHRDb25maWcuYWxsb3dlZER1cmF0aW9ucztcblxuICAgIGlmICghYWxsb3dlZC5pbmNsdWRlcyhkdXJhdGlvbikpIHtcbiAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0RXhjZXB0aW9uKFxuICAgICAgICBgSW52YWxpZCBkdXJhdGlvbi4gQWxsb3dlZCBkdXJhdGlvbnMgYXJlOiAke2FsbG93ZWQuam9pbignLCAnKX0gbWludXRlc2AsXG4gICAgICApO1xuICAgIH1cbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBWYWxpZGF0ZSBib29raW5nIGRhdGUgYW5kIHRpbWUgY29uc3RyYWludHNcbiAgICovXG4gIHZhbGlkYXRlQm9va2luZ0RhdGVUaW1lKFxuICAgIHN0YXJ0VGltZTogRGF0ZSxcbiAgICBkdXJhdGlvbjogbnVtYmVyLFxuICAgIGNvbmZpZzogUGFydGlhbDxWYWxpZGF0aW9uQ29uZmlnPiA9IHt9LFxuICApOiBib29sZWFuIHtcbiAgICBjb25zdCBmaW5hbENvbmZpZyA9IHsgLi4udGhpcy5kZWZhdWx0Q29uZmlnLCAuLi5jb25maWcgfTtcblxuICAgIHRoaXMudmFsaWRhdGVBZHZhbmNlQm9va2luZyhzdGFydFRpbWUsIGZpbmFsQ29uZmlnKTtcbiAgICB0aGlzLnZhbGlkYXRlQnVzaW5lc3NIb3VycyhzdGFydFRpbWUsIGR1cmF0aW9uLCBmaW5hbENvbmZpZyk7XG4gICAgdGhpcy52YWxpZGF0ZVdlZWtlbmRCb29raW5nKHN0YXJ0VGltZSwgZmluYWxDb25maWcpO1xuICAgIHRoaXMudmFsaWRhdGVEdXJhdGlvbihkdXJhdGlvbiwgZmluYWxDb25maWcuYWxsb3dlZER1cmF0aW9ucyk7XG5cbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBWYWxpZGF0ZSBhZHZhbmNlIGJvb2tpbmcgY29uc3RyYWludHNcbiAgICovXG4gIHByaXZhdGUgdmFsaWRhdGVBZHZhbmNlQm9va2luZyhcbiAgICBzdGFydFRpbWU6IERhdGUsXG4gICAgY29uZmlnOiBWYWxpZGF0aW9uQ29uZmlnLFxuICApOiB2b2lkIHtcbiAgICBjb25zdCBub3cgPSBuZXcgRGF0ZSgpO1xuICAgIGNvbnN0IHRpbWVEaWZmID0gc3RhcnRUaW1lLmdldFRpbWUoKSAtIG5vdy5nZXRUaW1lKCk7XG4gICAgY29uc3QgaG91cnNEaWZmID0gdGltZURpZmYgLyAoMTAwMCAqIDYwICogNjApO1xuICAgIGNvbnN0IGRheXNEaWZmID0gdGltZURpZmYgLyAoMTAwMCAqIDYwICogNjAgKiAyNCk7XG5cbiAgICBpZiAoaG91cnNEaWZmIDwgY29uZmlnLmFkdmFuY2VCb29raW5nLm1pbkhvdXJzKSB7XG4gICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdEV4Y2VwdGlvbihcbiAgICAgICAgYEJvb2tpbmdzIG11c3QgYmUgbWFkZSBhdCBsZWFzdCAke2NvbmZpZy5hZHZhbmNlQm9va2luZy5taW5Ib3Vyc30gaG91cnMgaW4gYWR2YW5jZWAsXG4gICAgICApO1xuICAgIH1cblxuICAgIGlmIChkYXlzRGlmZiA+IGNvbmZpZy5hZHZhbmNlQm9va2luZy5tYXhEYXlzKSB7XG4gICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdEV4Y2VwdGlvbihcbiAgICAgICAgYEJvb2tpbmdzIGNhbiBvbmx5IGJlIG1hZGUgdXAgdG8gJHtjb25maWcuYWR2YW5jZUJvb2tpbmcubWF4RGF5c30gZGF5cyBpbiBhZHZhbmNlYCxcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFZhbGlkYXRlIGJ1c2luZXNzIGhvdXJzIGNvbnN0cmFpbnRzXG4gICAqL1xuICBwcml2YXRlIHZhbGlkYXRlQnVzaW5lc3NIb3VycyhcbiAgICBzdGFydFRpbWU6IERhdGUsXG4gICAgZHVyYXRpb246IG51bWJlcixcbiAgICBjb25maWc6IFZhbGlkYXRpb25Db25maWcsXG4gICk6IHZvaWQge1xuICAgIGNvbnN0IGVuZFRpbWUgPSBuZXcgRGF0ZShzdGFydFRpbWUuZ2V0VGltZSgpICsgZHVyYXRpb24gKiA2MCAqIDEwMDApO1xuXG4gICAgY29uc3Qgc3RhcnRUaW1lU3RyID0gdGhpcy5mb3JtYXRUaW1lKHN0YXJ0VGltZSk7XG4gICAgY29uc3QgZW5kVGltZVN0ciA9IHRoaXMuZm9ybWF0VGltZShlbmRUaW1lKTtcblxuICAgIGlmIChcbiAgICAgIHN0YXJ0VGltZVN0ciA8IGNvbmZpZy5idXNpbmVzc0hvdXJzLnN0YXJ0IHx8XG4gICAgICBlbmRUaW1lU3RyID4gY29uZmlnLmJ1c2luZXNzSG91cnMuZW5kXG4gICAgKSB7XG4gICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdEV4Y2VwdGlvbihcbiAgICAgICAgYE1lZXRpbmcgbXVzdCBiZSB3aXRoaW4gYnVzaW5lc3MgaG91cnMgKCR7Y29uZmlnLmJ1c2luZXNzSG91cnMuc3RhcnR9IC0gJHtjb25maWcuYnVzaW5lc3NIb3Vycy5lbmR9KWAsXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBWYWxpZGF0ZSB3ZWVrZW5kIGJvb2tpbmcgaWYgbm90IGFsbG93ZWRcbiAgICovXG4gIHByaXZhdGUgdmFsaWRhdGVXZWVrZW5kQm9va2luZyhcbiAgICBzdGFydFRpbWU6IERhdGUsXG4gICAgY29uZmlnOiBWYWxpZGF0aW9uQ29uZmlnLFxuICApOiB2b2lkIHtcbiAgICBpZiAoIWNvbmZpZy53ZWVrZW5kQm9va2luZykge1xuICAgICAgY29uc3QgZGF5T2ZXZWVrID0gc3RhcnRUaW1lLmdldERheSgpO1xuICAgICAgaWYgKGRheU9mV2VlayA9PT0gMCB8fCBkYXlPZldlZWsgPT09IDYpIHtcbiAgICAgICAgLy8gU3VuZGF5ID0gMCwgU2F0dXJkYXkgPSA2XG4gICAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0RXhjZXB0aW9uKCdXZWVrZW5kIGJvb2tpbmdzIGFyZSBub3QgYWxsb3dlZCcpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBDaGVjayBpZiB0aGVyYXBpc3QgaXMgYXZhaWxhYmxlIGF0IHRoZSBzcGVjaWZpZWQgdGltZVxuICAgKi9cblxuICAvKipcbiAgICogVmFsaWRhdGUgdGhlcmFwaXN0IGF2YWlsYWJpbGl0eSB3aXRoIHRyYW5zYWN0aW9uIHN1cHBvcnQgYW5kIHRpbWV6b25lIGhhbmRsaW5nXG4gICAqL1xuICBhc3luYyB2YWxpZGF0ZVRoZXJhcGlzdEF2YWlsYWJpbGl0eVdpdGhUcmFuc2FjdGlvbihcbiAgICB0aGVyYXBpc3RJZDogc3RyaW5nLFxuICAgIHN0YXJ0VGltZTogRGF0ZSxcbiAgICBkdXJhdGlvbjogbnVtYmVyLFxuICAgIHByaXNtYUNsaWVudDogYW55LCAvLyBBY2NlcHQgdHJhbnNhY3Rpb24gY2xpZW50IG9yIHJlZ3VsYXIgcHJpc21hXG4gICAgdGhlcmFwaXN0VGltZXpvbmU/OiBzdHJpbmcsXG4gICk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgIC8vIEdldCB0aGVyYXBpc3QgdGltZXpvbmUgaWYgbm90IHByb3ZpZGVkXG4gICAgaWYgKCF0aGVyYXBpc3RUaW1lem9uZSkge1xuICAgICAgY29uc3QgdGhlcmFwaXN0ID0gYXdhaXQgcHJpc21hQ2xpZW50LnRoZXJhcGlzdC5maW5kVW5pcXVlKHtcbiAgICAgICAgd2hlcmU6IHsgdXNlcklkOiB0aGVyYXBpc3RJZCB9LFxuICAgICAgICBzZWxlY3Q6IHsgdGltZXpvbmU6IHRydWUgfSxcbiAgICAgIH0pO1xuICAgICAgdGhlcmFwaXN0VGltZXpvbmUgPSB0aGVyYXBpc3Q/LnRpbWV6b25lIHx8ICdVVEMnO1xuICAgIH1cblxuICAgIC8vIENvbnZlcnQgdG8gdGhlcmFwaXN0J3MgdGltZXpvbmUgZm9yIGRheS90aW1lIGV4dHJhY3Rpb24gKGJlc3QgcHJhY3RpY2U6IGtlZXAgVVRDLCBjb252ZXJ0IG9ubHkgZm9yIGV4dHJhY3Rpb24pXG4gICAgLy8gVXNlIEludGwuRGF0ZVRpbWVGb3JtYXQgZm9yIHByb3BlciB0aW1lem9uZSBjb252ZXJzaW9uIHdpdGhvdXQgc3RyaW5nIHBhcnNpbmcgaXNzdWVzXG4gICAgY29uc3QgdGhlcmFwaXN0Rm9ybWF0dGVyID0gbmV3IEludGwuRGF0ZVRpbWVGb3JtYXQoJ2VuLVVTJywge1xuICAgICAgdGltZVpvbmU6IHRoZXJhcGlzdFRpbWV6b25lLFxuICAgICAgd2Vla2RheTogJ2xvbmcnLFxuICAgICAgaG91cjogJzItZGlnaXQnLFxuICAgICAgbWludXRlOiAnMi1kaWdpdCcsXG4gICAgICBob3VyMTI6IGZhbHNlLFxuICAgIH0pO1xuXG4gICAgY29uc3QgZW5kVGltZSA9IG5ldyBEYXRlKHN0YXJ0VGltZS5nZXRUaW1lKCkgKyBkdXJhdGlvbiAqIDYwICogMTAwMCk7XG4gICAgY29uc3QgZW5kRm9ybWF0dGVyID0gbmV3IEludGwuRGF0ZVRpbWVGb3JtYXQoJ2VuLVVTJywge1xuICAgICAgdGltZVpvbmU6IHRoZXJhcGlzdFRpbWV6b25lLCBcbiAgICAgIGhvdXI6ICcyLWRpZ2l0JyxcbiAgICAgIG1pbnV0ZTogJzItZGlnaXQnLFxuICAgICAgaG91cjEyOiBmYWxzZSxcbiAgICB9KTtcblxuICAgIC8vIEV4dHJhY3QgZGF5IGFuZCB0aW1lIGNvbXBvbmVudHMgaW4gdGhlcmFwaXN0J3MgdGltZXpvbmVcbiAgICBjb25zdCBzdGFydFBhcnRzID0gdGhlcmFwaXN0Rm9ybWF0dGVyLmZvcm1hdFRvUGFydHMoc3RhcnRUaW1lKTtcbiAgICBjb25zdCBlbmRQYXJ0cyA9IGVuZEZvcm1hdHRlci5mb3JtYXRUb1BhcnRzKGVuZFRpbWUpO1xuICAgIFxuICAgIC8vIEdldCBkYXkgbmFtZSBmcm9tIHBhcnRzIChhbHJlYWR5IGZvcm1hdHRlZCBhcyBcIk1vbmRheVwiLCBcIlR1ZXNkYXlcIiwgZXRjLilcbiAgICBjb25zdCBkYXlPZldlZWsgPSBzdGFydFBhcnRzXG4gICAgICAuZmluZChwYXJ0ID0+IHBhcnQudHlwZSA9PT0gJ3dlZWtkYXknKT8udmFsdWUudG9VcHBlckNhc2UoKSB8fCAnVU5LTk9XTic7XG4gICAgXG4gICAgLy8gR2V0IHRpbWUgc3RyaW5ncyBpbiBISDpNTSBmb3JtYXQgZnJvbSBwYXJ0c1xuICAgIGNvbnN0IHN0YXJ0SG91ciA9IHN0YXJ0UGFydHMuZmluZChwYXJ0ID0+IHBhcnQudHlwZSA9PT0gJ2hvdXInKT8udmFsdWUgfHwgJzAwJztcbiAgICBjb25zdCBzdGFydE1pbnV0ZSA9IHN0YXJ0UGFydHMuZmluZChwYXJ0ID0+IHBhcnQudHlwZSA9PT0gJ21pbnV0ZScpPy52YWx1ZSB8fCAnMDAnO1xuICAgIGNvbnN0IGVuZEhvdXIgPSBlbmRQYXJ0cy5maW5kKHBhcnQgPT4gcGFydC50eXBlID09PSAnaG91cicpPy52YWx1ZSB8fCAnMDAnO1xuICAgIGNvbnN0IGVuZE1pbnV0ZSA9IGVuZFBhcnRzLmZpbmQocGFydCA9PiBwYXJ0LnR5cGUgPT09ICdtaW51dGUnKT8udmFsdWUgfHwgJzAwJztcbiAgICBcbiAgICBjb25zdCBzdGFydFRpbWVTdHIgPSBgJHtzdGFydEhvdXJ9OiR7c3RhcnRNaW51dGV9YDtcbiAgICBjb25zdCBlbmRUaW1lU3RyID0gYCR7ZW5kSG91cn06JHtlbmRNaW51dGV9YDtcblxuICAgIGNvbnN0IGF2YWlsYWJpbGl0eSA9IGF3YWl0IHByaXNtYUNsaWVudC50aGVyYXBpc3RBdmFpbGFiaWxpdHkuZmluZEZpcnN0KHtcbiAgICAgIHdoZXJlOiB7XG4gICAgICAgIHRoZXJhcGlzdElkLFxuICAgICAgICBkYXlPZldlZWssXG4gICAgICAgIHN0YXJ0VGltZTogeyBsdGU6IHN0YXJ0VGltZVN0ciB9LFxuICAgICAgICBlbmRUaW1lOiB7IGd0ZTogZW5kVGltZVN0ciB9LFxuICAgICAgICBpc0F2YWlsYWJsZTogdHJ1ZSxcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICBpZiAoIWF2YWlsYWJpbGl0eSkge1xuICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFeGNlcHRpb24oXG4gICAgICAgIGBUaGVyYXBpc3QgaXMgbm90IGF2YWlsYWJsZSBhdCB0aGUgcmVxdWVzdGVkIHRpbWUgKCR7c3RhcnRUaW1lU3RyfS0ke2VuZFRpbWVTdHJ9ICR7ZGF5T2ZXZWVrfSBpbiAke3RoZXJhcGlzdFRpbWV6b25lfSlgLFxuICAgICAgKTtcbiAgICB9XG5cbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDaGVjayBpZiB0aGVyYXBpc3QgaXMgYXZhaWxhYmxlIGF0IHRoZSBzcGVjaWZpZWQgdGltZVxuICAgKi9cbiAgYXN5bmMgdmFsaWRhdGVUaGVyYXBpc3RBdmFpbGFiaWxpdHkoXG4gICAgdGhlcmFwaXN0SWQ6IHN0cmluZyxcbiAgICBzdGFydFRpbWU6IERhdGUsXG4gICAgZHVyYXRpb246IG51bWJlcixcbiAgKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgLy8gQ29udmVydCBudW1lcmljIGRheSB0byBkYXkgbmFtZSBzdHJpbmcgdG8gbWF0Y2ggZGF0YWJhc2Ugc2NoZW1hXG4gICAgY29uc3QgZGF5T2ZXZWVrID0gc3RhcnRUaW1lXG4gICAgICAudG9Mb2NhbGVEYXRlU3RyaW5nKCdlbi1VUycsIHsgd2Vla2RheTogJ2xvbmcnIH0pXG4gICAgICAudG9VcHBlckNhc2UoKTtcbiAgICBjb25zdCBzdGFydFRpbWVTdHIgPSB0aGlzLmZvcm1hdFRpbWUoc3RhcnRUaW1lKTtcbiAgICBjb25zdCBlbmRUaW1lID0gbmV3IERhdGUoc3RhcnRUaW1lLmdldFRpbWUoKSArIGR1cmF0aW9uICogNjAgKiAxMDAwKTtcbiAgICBjb25zdCBlbmRUaW1lU3RyID0gdGhpcy5mb3JtYXRUaW1lKGVuZFRpbWUpO1xuXG4gICAgY29uc3QgYXZhaWxhYmlsaXR5ID0gYXdhaXQgdGhpcy5wcmlzbWEudGhlcmFwaXN0QXZhaWxhYmlsaXR5LmZpbmRGaXJzdCh7XG4gICAgICB3aGVyZToge1xuICAgICAgICB0aGVyYXBpc3RJZCxcbiAgICAgICAgZGF5T2ZXZWVrLFxuICAgICAgICBzdGFydFRpbWU6IHsgbHRlOiBzdGFydFRpbWVTdHIgfSxcbiAgICAgICAgZW5kVGltZTogeyBndGU6IGVuZFRpbWVTdHIgfSxcbiAgICAgICAgaXNBdmFpbGFibGU6IHRydWUsXG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgaWYgKCFhdmFpbGFiaWxpdHkpIHtcbiAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0RXhjZXB0aW9uKFxuICAgICAgICAnVGhlcmFwaXN0IGlzIG5vdCBhdmFpbGFibGUgYXQgdGhlIHJlcXVlc3RlZCB0aW1lJyxcbiAgICAgICk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRydWU7XG4gIH1cblxuICAvKipcbiAgICogVmFsaWRhdGUgY2xpZW50LXRoZXJhcGlzdCByZWxhdGlvbnNoaXAgZXhpc3RzXG4gICAqL1xuICBhc3luYyB2YWxpZGF0ZUNsaWVudFRoZXJhcGlzdFJlbGF0aW9uc2hpcChcbiAgICBjbGllbnRJZDogc3RyaW5nLFxuICAgIHRoZXJhcGlzdElkOiBzdHJpbmcsXG4gICk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgIGNvbnN0IHJlbGF0aW9uc2hpcCA9IGF3YWl0IHRoaXMucHJpc21hLmNsaWVudFRoZXJhcGlzdC5maW5kRmlyc3Qoe1xuICAgICAgd2hlcmU6IHtcbiAgICAgICAgY2xpZW50SWQsXG4gICAgICAgIHRoZXJhcGlzdElkLFxuICAgICAgfSxcbiAgICB9KTtcblxuICAgIGlmICghcmVsYXRpb25zaGlwKSB7XG4gICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdEV4Y2VwdGlvbihcbiAgICAgICAgJ1lvdSBjYW4gb25seSBib29rIHNlc3Npb25zIHdpdGggeW91ciBhc3NpZ25lZCB0aGVyYXBpc3RzJyxcbiAgICAgICk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRydWU7XG4gIH1cblxuICAvKipcbiAgICogVmFsaWRhdGUgdGhlcmFwaXN0IGV4aXN0cyBhbmQgaXMgYWN0aXZlXG4gICAqL1xuICBhc3luYyB2YWxpZGF0ZVRoZXJhcGlzdEV4aXN0cyh0aGVyYXBpc3RJZDogc3RyaW5nKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgY29uc3QgdGhlcmFwaXN0ID0gYXdhaXQgdGhpcy5wcmlzbWEudGhlcmFwaXN0LmZpbmRGaXJzdCh7XG4gICAgICB3aGVyZToge1xuICAgICAgICB1c2VySWQ6IHRoZXJhcGlzdElkLFxuICAgICAgICBzdGF0dXM6ICdBUFBST1ZFRCcsXG4gICAgICB9LFxuICAgICAgaW5jbHVkZToge1xuICAgICAgICB1c2VyOiB7XG4gICAgICAgICAgc2VsZWN0OiB7XG4gICAgICAgICAgICBpc0FjdGl2ZTogdHJ1ZSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgfSxcbiAgICB9KTtcblxuICAgIGlmICghdGhlcmFwaXN0IHx8ICF0aGVyYXBpc3QudXNlci5pc0FjdGl2ZSkge1xuICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFeGNlcHRpb24oJ1RoZXJhcGlzdCBub3QgZm91bmQgb3IgaW5hY3RpdmUnKTtcbiAgICB9XG5cbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBWYWxpZGF0ZSBhdmFpbGFiaWxpdHkgc2xvdCBvdmVybGFwXG4gICAqL1xuICB2YWxpZGF0ZUF2YWlsYWJpbGl0eU92ZXJsYXAoXG4gICAgc3RhcnRUaW1lMTogc3RyaW5nLFxuICAgIGVuZFRpbWUxOiBzdHJpbmcsXG4gICAgc3RhcnRUaW1lMjogc3RyaW5nLFxuICAgIGVuZFRpbWUyOiBzdHJpbmcsXG4gICk6IGJvb2xlYW4ge1xuICAgIGlmIChzdGFydFRpbWUxID49IGVuZFRpbWUxKSB7XG4gICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdEV4Y2VwdGlvbignU3RhcnQgdGltZSBtdXN0IGJlIGJlZm9yZSBlbmQgdGltZScpO1xuICAgIH1cblxuICAgIGlmIChzdGFydFRpbWUyID49IGVuZFRpbWUyKSB7XG4gICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdEV4Y2VwdGlvbignU3RhcnQgdGltZSBtdXN0IGJlIGJlZm9yZSBlbmQgdGltZScpO1xuICAgIH1cblxuICAgIGNvbnN0IGhhc092ZXJsYXAgPSBzdGFydFRpbWUxIDwgZW5kVGltZTIgJiYgZW5kVGltZTEgPiBzdGFydFRpbWUyO1xuXG4gICAgaWYgKGhhc092ZXJsYXApIHtcbiAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0RXhjZXB0aW9uKFxuICAgICAgICAnQXZhaWxhYmlsaXR5IHNsb3Qgb3ZlcmxhcHMgd2l0aCBleGlzdGluZyBhdmFpbGFiaWxpdHknLFxuICAgICAgKTtcbiAgICB9XG5cbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBWYWxpZGF0ZSB0aW1lem9uZSAoaWYgdGltZXpvbmUgc3VwcG9ydCBpcyBuZWVkZWQpXG4gICAqL1xuICB2YWxpZGF0ZVRpbWV6b25lKHRpbWV6b25lOiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICB0cnkge1xuICAgICAgLy8gQ2hlY2sgaWYgdGltZXpvbmUgaXMgdmFsaWRcbiAgICAgIEludGwuRGF0ZVRpbWVGb3JtYXQodW5kZWZpbmVkLCB7IHRpbWVab25lOiB0aW1lem9uZSB9KTtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH0gY2F0Y2gge1xuICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFeGNlcHRpb24oYEludmFsaWQgdGltZXpvbmU6ICR7dGltZXpvbmV9YCk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIENvbXByZWhlbnNpdmUgdmFsaWRhdGlvbiBmb3IgbWVldGluZyBjcmVhdGlvblxuICAgKi9cbiAgYXN5bmMgdmFsaWRhdGVNZWV0aW5nQ3JlYXRpb24oe1xuICAgIHRoZXJhcGlzdElkLFxuICAgIGNsaWVudElkLFxuICAgIHN0YXJ0VGltZSxcbiAgICBkdXJhdGlvbixcbiAgICBjb25maWcgPSB7fSxcbiAgfToge1xuICAgIHRoZXJhcGlzdElkOiBzdHJpbmc7XG4gICAgY2xpZW50SWQ6IHN0cmluZztcbiAgICBzdGFydFRpbWU6IERhdGU7XG4gICAgZHVyYXRpb246IG51bWJlcjtcbiAgICBjb25maWc/OiBQYXJ0aWFsPFZhbGlkYXRpb25Db25maWc+O1xuICB9KTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgLy8gUnVuIGFsbCB2YWxpZGF0aW9uc1xuICAgIGF3YWl0IFByb21pc2UuYWxsKFtcbiAgICAgIHRoaXMudmFsaWRhdGVUaGVyYXBpc3RFeGlzdHModGhlcmFwaXN0SWQpLFxuICAgICAgdGhpcy52YWxpZGF0ZUNsaWVudFRoZXJhcGlzdFJlbGF0aW9uc2hpcChjbGllbnRJZCwgdGhlcmFwaXN0SWQpLFxuICAgICAgdGhpcy52YWxpZGF0ZVRoZXJhcGlzdEF2YWlsYWJpbGl0eSh0aGVyYXBpc3RJZCwgc3RhcnRUaW1lLCBkdXJhdGlvbiksXG4gICAgXSk7XG5cbiAgICB0aGlzLnZhbGlkYXRlQm9va2luZ0RhdGVUaW1lKHN0YXJ0VGltZSwgZHVyYXRpb24sIGNvbmZpZyk7XG5cbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDb21wcmVoZW5zaXZlIHZhbGlkYXRpb24gZm9yIGF2YWlsYWJpbGl0eSBjcmVhdGlvblxuICAgKi9cbiAgYXN5bmMgdmFsaWRhdGVBdmFpbGFiaWxpdHlDcmVhdGlvbih7XG4gICAgdGhlcmFwaXN0SWQsXG4gICAgZGF5T2ZXZWVrLFxuICAgIHN0YXJ0VGltZSxcbiAgICBlbmRUaW1lLFxuICB9OiB7XG4gICAgdGhlcmFwaXN0SWQ6IHN0cmluZztcbiAgICBkYXlPZldlZWs6IG51bWJlcjtcbiAgICBzdGFydFRpbWU6IHN0cmluZztcbiAgICBlbmRUaW1lOiBzdHJpbmc7XG4gIH0pOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICAvLyBWYWxpZGF0ZSB0aGVyYXBpc3QgZXhpc3RzXG4gICAgYXdhaXQgdGhpcy52YWxpZGF0ZVRoZXJhcGlzdEV4aXN0cyh0aGVyYXBpc3RJZCk7XG5cbiAgICAvLyBWYWxpZGF0ZSB0aW1lIGZvcm1hdHNcbiAgICB0aGlzLnZhbGlkYXRlVGltZUZvcm1hdChzdGFydFRpbWUpO1xuICAgIHRoaXMudmFsaWRhdGVUaW1lRm9ybWF0KGVuZFRpbWUpO1xuXG4gICAgLy8gVmFsaWRhdGUgdGltZSByYW5nZVxuICAgIGlmIChzdGFydFRpbWUgPj0gZW5kVGltZSkge1xuICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFeGNlcHRpb24oJ1N0YXJ0IHRpbWUgbXVzdCBiZSBiZWZvcmUgZW5kIHRpbWUnKTtcbiAgICB9XG5cbiAgICAvLyBWYWxpZGF0ZSBkYXkgb2Ygd2Vla1xuICAgIGlmIChkYXlPZldlZWsgPCAwIHx8IGRheU9mV2VlayA+IDYpIHtcbiAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0RXhjZXB0aW9uKFxuICAgICAgICAnRGF5IG9mIHdlZWsgbXVzdCBiZSBiZXR3ZWVuIDAgKFN1bmRheSkgYW5kIDYgKFNhdHVyZGF5KScsXG4gICAgICApO1xuICAgIH1cblxuICAgIC8vIENvbnZlcnQgbnVtZXJpYyBkYXkgdG8gZGF5IG5hbWUgc3RyaW5nIHRvIG1hdGNoIGRhdGFiYXNlIHNjaGVtYVxuICAgIGNvbnN0IGRheU9mV2Vla1N0cmluZyA9IG5ldyBEYXRlKDIwMjQsIDAsIGRheU9mV2VlaykgLy8gVXNlIGR1bW15IGRhdGUgd2l0aCBkZXNpcmVkIGRheVxuICAgICAgLnRvTG9jYWxlRGF0ZVN0cmluZygnZW4tVVMnLCB7IHdlZWtkYXk6ICdsb25nJyB9KVxuICAgICAgLnRvVXBwZXJDYXNlKCk7XG5cbiAgICAvLyBDaGVjayBmb3Igb3ZlcmxhcHBpbmcgYXZhaWxhYmlsaXR5XG4gICAgY29uc3Qgb3ZlcmxhcHBpbmcgPSBhd2FpdCB0aGlzLnByaXNtYS50aGVyYXBpc3RBdmFpbGFiaWxpdHkuZmluZEZpcnN0KHtcbiAgICAgIHdoZXJlOiB7XG4gICAgICAgIHRoZXJhcGlzdElkLFxuICAgICAgICBkYXlPZldlZWs6IGRheU9mV2Vla1N0cmluZyxcbiAgICAgICAgT1I6IFtcbiAgICAgICAgICB7XG4gICAgICAgICAgICBzdGFydFRpbWU6IHsgbHQ6IGVuZFRpbWUgfSxcbiAgICAgICAgICAgIGVuZFRpbWU6IHsgZ3Q6IHN0YXJ0VGltZSB9LFxuICAgICAgICAgIH0sXG4gICAgICAgIF0sXG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgaWYgKG92ZXJsYXBwaW5nKSB7XG4gICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdEV4Y2VwdGlvbihcbiAgICAgICAgJ0F2YWlsYWJpbGl0eSBzbG90IG92ZXJsYXBzIHdpdGggZXhpc3RpbmcgYXZhaWxhYmlsaXR5JyxcbiAgICAgICk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRydWU7XG4gIH1cblxuICAvKipcbiAgICogRm9ybWF0IERhdGUgdG8gSEg6TU0gc3RyaW5nXG4gICAqL1xuICBwcml2YXRlIGZvcm1hdFRpbWUoZGF0ZTogRGF0ZSk6IHN0cmluZyB7XG4gICAgcmV0dXJuIGRhdGUudG9UaW1lU3RyaW5nKCkuc2xpY2UoMCwgNSk7XG4gIH1cblxuICAvKipcbiAgICogUGFyc2UgdGltZSBzdHJpbmcgdG8gbWludXRlcyBzaW5jZSBtaWRuaWdodFxuICAgKi9cbiAgcHJpdmF0ZSBwYXJzZVRpbWVUb01pbnV0ZXModGltZVN0cmluZzogc3RyaW5nKTogbnVtYmVyIHtcbiAgICBjb25zdCBbaG91cnMsIG1pbnV0ZXNdID0gdGltZVN0cmluZy5zcGxpdCgnOicpLm1hcChOdW1iZXIpO1xuICAgIHJldHVybiBob3VycyAqIDYwICsgbWludXRlcztcbiAgfVxuXG4gIC8qKlxuICAgKiBDb252ZXJ0IG1pbnV0ZXMgc2luY2UgbWlkbmlnaHQgdG8gSEg6TU0gc3RyaW5nXG4gICAqL1xuICBwcml2YXRlIG1pbnV0ZXNUb1RpbWVTdHJpbmcobWludXRlczogbnVtYmVyKTogc3RyaW5nIHtcbiAgICBjb25zdCBob3VycyA9IE1hdGguZmxvb3IobWludXRlcyAvIDYwKTtcbiAgICBjb25zdCBtaW5zID0gbWludXRlcyAlIDYwO1xuICAgIHJldHVybiBgJHtob3Vycy50b1N0cmluZygpLnBhZFN0YXJ0KDIsICcwJyl9OiR7bWlucy50b1N0cmluZygpLnBhZFN0YXJ0KDIsICcwJyl9YDtcbiAgfVxufVxuIl0sInZlcnNpb24iOjN9