ea54337435aab6371e8902e17d994fef
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.TherapistRecommendationService = void 0;
const common_1 = require("@nestjs/common");
const prisma_client_provider_1 = require("../providers/prisma-client.provider");
const advanced_matching_service_1 = require("./services/advanced-matching.service");
const compatibility_analysis_service_1 = require("./services/compatibility-analysis.service");
const matching_analytics_service_1 = require("./services/matching-analytics.service");
let TherapistRecommendationService = class TherapistRecommendationService {
    prisma;
    advancedMatching;
    compatibilityAnalysis;
    matchingAnalytics;
    constructor(prisma, advancedMatching, compatibilityAnalysis, matchingAnalytics) {
        this.prisma = prisma;
        this.advancedMatching = advancedMatching;
        this.compatibilityAnalysis = compatibilityAnalysis;
        this.matchingAnalytics = matchingAnalytics;
    }
    calculateYearsOfExperience(startDate) {
        const now = new Date();
        let years = now.getFullYear() - startDate.getFullYear();
        if (now.getMonth() < startDate.getMonth() ||
            (now.getMonth() === startDate.getMonth() &&
                now.getDate() < startDate.getDate())) {
            years--;
        }
        return years;
    }
    async getRecommendedTherapists(request) {
        try {
            // Get user's comprehensive data including preferences
            const user = await this.prisma.client.findUnique({
                where: { userId: request.userId },
                include: {
                    preAssessment: true,
                    clientPreferences: true,
                    user: true,
                },
            });
            if (!user)
                throw new common_1.NotFoundException('User not found');
            if (!user.preAssessment)
                throw new common_1.NotFoundException('No pre-assessment found for user');
            // Extract user conditions and severity levels
            const userConditions = this.extractUserConditions(user.preAssessment);
            const severityLevels = user.preAssessment.severityLevels;
            // Fetch therapists with comprehensive data
            const therapists = await this.prisma.therapist.findMany({
                where: {
                    status: 'approved',
                    ...(request.province && { province: request.province }),
                    ...(request.maxHourlyRate && {
                        hourlyRate: { lte: request.maxHourlyRate },
                    }),
                },
                orderBy: { createdAt: 'desc' },
                take: Math.min(request.limit ?? 10, 50), // Increase limit for better filtering
                include: {
                    user: true,
                    reviews: {
                        where: { status: 'APPROVED' },
                        select: {
                            rating: true,
                            status: true,
                        },
                    },
                },
            });
            // Use advanced matching algorithm
            const therapistScores = [];
            for (const therapist of therapists) {
                try {
                    const score = await this.advancedMatching.calculateAdvancedMatch(user, // Safe because we verified preAssessment exists above
                    therapist);
                    therapistScores.push(score);
                }
                catch (error) {
                    // Fallback to basic scoring if advanced matching fails
                    console.warn(`Advanced matching failed for therapist ${therapist.userId}:`, error);
                    const basicScore = this.calculateMatchScore(therapist, userConditions);
                    therapistScores.push({
                        therapist,
                        totalScore: basicScore,
                        breakdown: {
                            conditionScore: basicScore * 0.6,
                            approachScore: 0,
                            experienceScore: basicScore * 0.4,
                            reviewScore: 0,
                            logisticsScore: 0,
                        },
                        matchExplanation: {
                            primaryMatches: this.getPrimaryConditions(userConditions),
                            secondaryMatches: this.getSecondaryConditions(userConditions),
                            approachMatches: [],
                            experienceYears: this.calculateYearsOfExperience(therapist.practiceStartDate),
                            averageRating: 0,
                            totalReviews: 0,
                            successRates: {},
                        },
                    });
                }
            }
            // Sort by total score descending
            const sortedTherapistScores = therapistScores.sort((a, b) => b.totalScore - a.totalScore);
            // Take only the requested number of results
            const finalResults = sortedTherapistScores.slice(0, request.limit ?? 10);
            // Track recommendation analytics
            await this.matchingAnalytics.trackRecommendation(request.userId, finalResults, 'advanced_v1.0');
            // Transform to expected format
            const therapistsWithScores = finalResults.map((score) => ({
                ...score.therapist,
                matchScore: score.totalScore,
                scoreBreakdown: score.breakdown,
                matchExplanation: score.matchExplanation,
            }));
            // Determine primary and secondary conditions
            const primaryConditions = this.getPrimaryConditions(userConditions);
            const secondaryConditions = this.getSecondaryConditions(userConditions);
            return {
                totalCount: therapistsWithScores.length,
                userConditions: Object.keys(userConditions),
                therapists: therapistsWithScores,
                matchCriteria: {
                    primaryConditions,
                    secondaryConditions,
                    severityLevels,
                },
                page: 1,
                pageSize: request.limit ?? 10,
            };
        }
        catch (error) {
            throw new common_1.InternalServerErrorException(error instanceof Error
                ? error.message
                : 'Failed to get therapist recommendations');
        }
    }
    /**
     * Get detailed compatibility analysis between a client and therapist
     */
    async getCompatibilityAnalysis(clientId, therapistId) {
        const client = await this.prisma.client.findUnique({
            where: { userId: clientId },
            include: {
                preAssessment: true,
                clientPreferences: true,
                user: true,
            },
        });
        const therapist = await this.prisma.therapist.findUnique({
            where: { userId: therapistId },
            include: {
                user: true,
                reviews: {
                    where: { status: 'APPROVED' },
                },
            },
        });
        if (!client || !therapist) {
            throw new common_1.NotFoundException('Client or therapist not found');
        }
        if (!client.preAssessment) {
            throw new common_1.NotFoundException('No pre-assessment found for client');
        }
        const compatibility = await this.compatibilityAnalysis.analyzeCompatibility(client, // Safe because we verified preAssessment exists above
        therapist);
        // Track compatibility analysis
        await this.matchingAnalytics.trackCompatibilityAnalysis(clientId, therapistId, compatibility, '1.0');
        return compatibility;
    }
    extractUserConditions(preAssessment) {
        const conditions = {};
        const severityLevels = preAssessment.severityLevels;
        const questionnaires = preAssessment.questionnaires;
        questionnaires.forEach((q) => {
            if (severityLevels[q]) {
                conditions[q] = severityLevels[q];
            }
        });
        return conditions;
    }
    calculateMatchScore(therapist, userConditions) {
        let score = 0;
        const expertise = therapist.expertise || [];
        Object.keys(userConditions).forEach((condition) => {
            if (expertise.includes(condition))
                score += 20;
        });
        score += Math.min(this.calculateYearsOfExperience(therapist.practiceStartDate) * 2, 20);
        // Add base score for experience
        score += therapist.yearsOfExperience ? therapist.yearsOfExperience * 2 : 0;
        return score;
    }
    getPrimaryConditions(userConditions) {
        return Object.entries(userConditions)
            .filter(([, severity]) => this.getSeverityWeight(severity) >= 4)
            .map(([condition]) => condition);
    }
    getSecondaryConditions(userConditions) {
        return Object.entries(userConditions)
            .filter(([, severity]) => {
            const weight = this.getSeverityWeight(severity);
            return weight >= 2 && weight < 4;
        })
            .map(([condition]) => condition);
    }
    getSeverityWeight(severity) {
        const severityWeights = {
            Minimal: 1,
            Mild: 2,
            Moderate: 3,
            'Moderately Severe': 4,
            Severe: 5,
            'Very Severe': 5,
            Extreme: 5,
            Low: 1,
            High: 4,
            Substantial: 4,
            Subclinical: 1,
            Clinical: 4,
            None: 0,
            Subthreshold: 2,
            Positive: 4,
            Negative: 0,
        };
        return severityWeights[severity] || 1;
    }
};
exports.TherapistRecommendationService = TherapistRecommendationService;
exports.TherapistRecommendationService = TherapistRecommendationService = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [prisma_client_provider_1.PrismaService,
        advanced_matching_service_1.AdvancedMatchingService,
        compatibility_analysis_service_1.CompatibilityAnalysisService,
        matching_analytics_service_1.MatchingAnalyticsService])
], TherapistRecommendationService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL3RoZXJhcGlzdC90aGVyYXBpc3QtcmVjb21tZW5kYXRpb24uc2VydmljZS50cyIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7QUFBQSwyQ0FJd0I7QUFDeEIsZ0ZBQW9FO0FBTXBFLG9GQUc4QztBQUM5Qyw4RkFBeUY7QUFDekYsc0ZBQWlGO0FBRzFFLElBQU0sOEJBQThCLEdBQXBDLE1BQU0sOEJBQThCO0lBRXRCO0lBQ0E7SUFDQTtJQUNBO0lBSm5CLFlBQ21CLE1BQXFCLEVBQ3JCLGdCQUF5QyxFQUN6QyxxQkFBbUQsRUFDbkQsaUJBQTJDO1FBSDNDLFdBQU0sR0FBTixNQUFNLENBQWU7UUFDckIscUJBQWdCLEdBQWhCLGdCQUFnQixDQUF5QjtRQUN6QywwQkFBcUIsR0FBckIscUJBQXFCLENBQThCO1FBQ25ELHNCQUFpQixHQUFqQixpQkFBaUIsQ0FBMEI7SUFDM0QsQ0FBQztJQUVJLDBCQUEwQixDQUFDLFNBQWU7UUFDaEQsTUFBTSxHQUFHLEdBQUcsSUFBSSxJQUFJLEVBQUUsQ0FBQztRQUN2QixJQUFJLEtBQUssR0FBRyxHQUFHLENBQUMsV0FBVyxFQUFFLEdBQUcsU0FBUyxDQUFDLFdBQVcsRUFBRSxDQUFDO1FBQ3hELElBQ0UsR0FBRyxDQUFDLFFBQVEsRUFBRSxHQUFHLFNBQVMsQ0FBQyxRQUFRLEVBQUU7WUFDckMsQ0FBQyxHQUFHLENBQUMsUUFBUSxFQUFFLEtBQUssU0FBUyxDQUFDLFFBQVEsRUFBRTtnQkFDdEMsR0FBRyxDQUFDLE9BQU8sRUFBRSxHQUFHLFNBQVMsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxFQUN0QyxDQUFDO1lBQ0QsS0FBSyxFQUFFLENBQUM7UUFDVixDQUFDO1FBQ0QsT0FBTyxLQUFLLENBQUM7SUFDZixDQUFDO0lBRUQsS0FBSyxDQUFDLHdCQUF3QixDQUM1QixPQUF1QztRQUV2QyxJQUFJLENBQUM7WUFDSCxzREFBc0Q7WUFDdEQsTUFBTSxJ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aEQsT0FBTyxNQUFNLElBQUksQ0FBQyxJQUFJLE1BQU0sR0FBRyxDQUFDLENBQUM7UUFDbkMsQ0FBQyxDQUFDO2FBQ0QsR0FBRyxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsRUFBRSxFQUFFLENBQUMsU0FBUyxDQUFDLENBQUM7SUFDckMsQ0FBQztJQUVPLGlCQUFpQixDQUFDLFFBQWdCO1FBQ3hDLE1BQU0sZUFBZSxHQUEyQjtZQUM5QyxPQUFPLEVBQUUsQ0FBQztZQUNWLElBQUksRUFBRSxDQUFDO1lBQ1AsUUFBUSxFQUFFLENBQUM7WUFDWCxtQkFBbUIsRUFBRSxDQUFDO1lBQ3RCLE1BQU0sRUFBRSxDQUFDO1lBQ1QsYUFBYSxFQUFFLENBQUM7WUFDaEIsT0FBTyxFQUFFLENBQUM7WUFDVixHQUFHLEVBQUUsQ0FBQztZQUNOLElBQUksRUFBRSxDQUFDO1lBQ1AsV0FBVyxFQUFFLENBQUM7WUFDZCxXQUFXLEVBQUUsQ0FBQztZQUNkLFFBQVEsRUFBRSxDQUFDO1lBQ1gsSUFBSSxFQUFFLENBQUM7WUFDUCxZQUFZLEVBQUUsQ0FBQztZQUNmLFFBQVEsRUFBRSxDQUFDO1lBQ1gsUUFBUSxFQUFFLENBQUM7U0FDWixDQUFDO1FBQ0YsT0FBTyxlQUFlLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ3hDLENBQUM7Q0FDRixDQUFBO0FBM1JZLHdFQUE4Qjt5Q0FBOUIsOEJBQThCO0lBRDFDLElBQUEsbUJBQVUsR0FBRTtxQ0FHZ0Isc0NBQWE7UUFDSCxtREFBdUI7UUFDbEIsNkRBQTRCO1FBQ2hDLHFEQUF3QjtHQUxuRCw4QkFBOEIsQ0EyUjFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9ob21lL3dldG9vYS9Eb2N1bWVudHMvY29kZS9wcm9qZWN0cy9tZW50YXJhL21lbnRhcmEtYXBpL3NyYy90aGVyYXBpc3QvdGhlcmFwaXN0LXJlY29tbWVuZGF0aW9uLnNlcnZpY2UudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgSW5qZWN0YWJsZSxcbiAgTm90Rm91bmRFeGNlcHRpb24sXG4gIEludGVybmFsU2VydmVyRXJyb3JFeGNlcHRpb24sXG59IGZyb20gJ0BuZXN0anMvY29tbW9uJztcbmltcG9ydCB7IFByaXNtYVNlcnZpY2UgfSBmcm9tICcuLi9wcm92aWRlcnMvcHJpc21hLWNsaWVudC5wcm92aWRlcic7XG5pbXBvcnQgeyBQcmVBc3Nlc3NtZW50IH0gZnJvbSAnQHByaXNtYS9jbGllbnQnO1xuaW1wb3J0IHtcbiAgVGhlcmFwaXN0UmVjb21tZW5kYXRpb25SZXF1ZXN0LFxuICBUaGVyYXBpc3RSZWNvbW1lbmRhdGlvblJlc3BvbnNlLFxufSBmcm9tICcuL2R0by90aGVyYXBpc3QtYXBwbGljYXRpb24uZHRvJztcbmltcG9ydCB7XG4gIEFkdmFuY2VkTWF0Y2hpbmdTZXJ2aWNlLFxuICBUaGVyYXBpc3RTY29yZSxcbn0gZnJvbSAnLi9zZXJ2aWNlcy9hZHZhbmNlZC1tYXRjaGluZy5zZXJ2aWNlJztcbmltcG9ydCB7IENvbXBhdGliaWxpdHlBbmFseXNpc1NlcnZpY2UgfSBmcm9tICcuL3NlcnZpY2VzL2NvbXBhdGliaWxpdHktYW5hbHlzaXMuc2VydmljZSc7XG5pbXBvcnQgeyBNYXRjaGluZ0FuYWx5dGljc1NlcnZpY2UgfSBmcm9tICcuL3NlcnZpY2VzL21hdGNoaW5nLWFuYWx5dGljcy5zZXJ2aWNlJztcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIFRoZXJhcGlzdFJlY29tbWVuZGF0aW9uU2VydmljZSB7XG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgcmVhZG9ubHkgcHJpc21hOiBQcmlzbWFTZXJ2aWNlLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgYWR2YW5jZWRNYXRjaGluZzogQWR2YW5jZWRNYXRjaGluZ1NlcnZpY2UsXG4gICAgcHJpdmF0ZSByZWFkb25seSBjb21wYXRpYmlsaXR5QW5hbHlzaXM6IENvbXBhdGliaWxpdHlBbmFseXNpc1NlcnZpY2UsXG4gICAgcHJpdmF0ZSByZWFkb25seSBtYXRjaGluZ0FuYWx5dGljczogTWF0Y2hpbmdBbmFseXRpY3NTZXJ2aWNlLFxuICApIHt9XG5cbiAgcHJpdmF0ZSBjYWxjdWxhdGVZZWFyc09mRXhwZXJpZW5jZShzdGFydERhdGU6IERhdGUpOiBudW1iZXIge1xuICAgIGNvbnN0IG5vdyA9IG5ldyBEYXRlKCk7XG4gICAgbGV0IHllYXJzID0gbm93LmdldEZ1bGxZZWFyKCkgLSBzdGFydERhdGUuZ2V0RnVsbFllYXIoKTtcbiAgICBpZiAoXG4gICAgICBub3cuZ2V0TW9udGgoKSA8IHN0YXJ0RGF0ZS5nZXRNb250aCgpIHx8XG4gICAgICAobm93LmdldE1vbnRoKCkgPT09IHN0YXJ0RGF0ZS5nZXRNb250aCgpICYmXG4gICAgICAgIG5vdy5nZXREYXRlKCkgPCBzdGFydERhdGUuZ2V0RGF0ZSgpKVxuICAgICkge1xuICAgICAgeWVhcnMtLTtcbiAgICB9XG4gICAgcmV0dXJuIHllYXJzO1xuICB9XG5cbiAgYXN5bmMgZ2V0UmVjb21tZW5kZWRUaGVyYXBpc3RzKFxuICAgIHJlcXVlc3Q6IFRoZXJhcGlzdFJlY29tbWVuZGF0aW9uUmVxdWVzdCxcbiAgKTogUHJvbWlzZTxUaGVyYXBpc3RSZWNvbW1lbmRhdGlvblJlc3BvbnNlPiB7XG4gICAgdHJ5IHtcbiAgICAgIC8vIEdldCB1c2VyJ3MgY29tcHJlaGVuc2l2ZSBkYXRhIGluY2x1ZGluZyBwcmVmZXJlbmNlc1xuICAgICAgY29uc3QgdXNlciA9IGF3YWl0IHRoaXMucHJpc21hLmNsaWVudC5maW5kVW5pcXVlKHtcbiAgICAgICAgd2hlcmU6IHsgdXNlcklkOiByZXF1ZXN0LnVzZXJJZCB9LFxuICAgICAgICBpbmNsdWRlOiB7XG4gICAgICAgICAgcHJlQXNzZXNzbWVudDogdHJ1ZSxcbiAgICAgICAgICBjbGllbnRQcmVmZXJlbmNlczogdHJ1ZSxcbiAgICAgICAgICB1c2VyOiB0cnVlLFxuICAgICAgICB9LFxuICAgICAgfSk7XG4gICAgICBpZiAoIXVzZXIpIHRocm93IG5ldyBOb3RGb3VuZEV4Y2VwdGlvbignVXNlciBub3QgZm91bmQnKTtcbiAgICAgIGlmICghdXNlci5wcmVBc3Nlc3NtZW50KVxuICAgICAgICB0aHJvdyBuZXcgTm90Rm91bmRFeGNlcHRpb24oJ05vIHByZS1hc3Nlc3NtZW50IGZvdW5kIGZvciB1c2VyJyk7XG5cbiAgICAgIC8vIEV4dHJhY3QgdXNlciBjb25kaXRpb25zIGFuZCBzZXZlcml0eSBsZXZlbHNcbiAgICAgIGNvbnN0IHVzZXJDb25kaXRpb25zID0gdGhpcy5leHRyYWN0VXNlckNvbmRpdGlvbnModXNlci5wcmVBc3Nlc3NtZW50KTtcbiAgICAgIGNvbnN0IHNldmVyaXR5TGV2ZWxzID0gdXNlci5wcmVBc3Nlc3NtZW50LnNldmVyaXR5TGV2ZWxzIGFzIFJlY29yZDxcbiAgICAgICAgc3RyaW5nLFxuICAgICAgICBzdHJpbmdcbiAgICAgID47XG5cbiAgICAgIC8vIEZldGNoIHRoZXJhcGlzdHMgd2l0aCBjb21wcmVoZW5zaXZlIGRhdGFcbiAgICAgIGNvbnN0IHRoZXJhcGlzdHMgPSBhd2FpdCB0aGlzLnByaXNtYS50aGVyYXBpc3QuZmluZE1hbnkoe1xuICAgICAgICB3aGVyZToge1xuICAgICAgICAgIHN0YXR1czogJ2FwcHJvdmVkJyxcbiAgICAgICAgICAuLi4ocmVxdWVzdC5wcm92aW5jZSAmJiB7IHByb3ZpbmNlOiByZXF1ZXN0LnByb3ZpbmNlIH0pLFxuICAgICAgICAgIC4uLihyZXF1ZXN0Lm1heEhvdXJseVJhdGUgJiYge1xuICAgICAgICAgICAgaG91cmx5UmF0ZTogeyBsdGU6IHJlcXVlc3QubWF4SG91cmx5UmF0ZSB9LFxuICAgICAgICAgIH0pLFxuICAgICAgICB9LFxuICAgICAgICBvcmRlckJ5OiB7IGNyZWF0ZWRBdDogJ2Rlc2MnIH0sXG4gICAgICAgIHRha2U6IE1hdGgubWluKHJlcXVlc3QubGltaXQgPz8gMTAsIDUwKSwgLy8gSW5jcmVhc2UgbGltaXQgZm9yIGJldHRlciBmaWx0ZXJpbmdcbiAgICAgICAgaW5jbHVkZToge1xuICAgICAgICAgIHVzZXI6IHRydWUsXG4gICAgICAgICAgcmV2aWV3czoge1xuICAgICAgICAgICAgd2hlcmU6IHsgc3RhdHVzOiAnQVBQUk9WRUQnIH0sXG4gICAgICAgICAgICBzZWxlY3Q6IHtcbiAgICAgICAgICAgICAgcmF0aW5nOiB0cnVlLFxuICAgICAgICAgICAgICBzdGF0dXM6IHRydWUsXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICB9KTtcblxuICAgICAgLy8gVXNlIGFkdmFuY2VkIG1hdGNoaW5nIGFsZ29yaXRobVxuICAgICAgY29uc3QgdGhlcmFwaXN0U2NvcmVzOiBUaGVyYXBpc3RTY29yZVtdID0gW107XG5cbiAgICAgIGZvciAoY29uc3QgdGhlcmFwaXN0IG9mIHRoZXJhcGlzdHMpIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICBjb25zdCBzY29yZSA9IGF3YWl0IHRoaXMuYWR2YW5jZWRNYXRjaGluZy5jYWxjdWxhdGVBZHZhbmNlZE1hdGNoKFxuICAgICAgICAgICAgdXNlciBhcyBhbnksIC8vIFNhZmUgYmVjYXVzZSB3ZSB2ZXJpZmllZCBwcmVBc3Nlc3NtZW50IGV4aXN0cyBhYm92ZVxuICAgICAgICAgICAgdGhlcmFwaXN0LFxuICAgICAgICAgICk7XG4gICAgICAgICAgdGhlcmFwaXN0U2NvcmVzLnB1c2goc2NvcmUpO1xuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgIC8vIEZhbGxiYWNrIHRvIGJhc2ljIHNjb3JpbmcgaWYgYWR2YW5jZWQgbWF0Y2hpbmcgZmFpbHNcbiAgICAgICAgICBjb25zb2xlLndhcm4oXG4gICAgICAgICAgICBgQWR2YW5jZWQgbWF0Y2hpbmcgZmFpbGVkIGZvciB0aGVyYXBpc3QgJHt0aGVyYXBpc3QudXNlcklkfTpgLFxuICAgICAgICAgICAgZXJyb3IsXG4gICAgICAgICAgKTtcbiAgICAgICAgICBjb25zdCBiYXNpY1Njb3JlID0gdGhpcy5jYWxjdWxhdGVNYXRjaFNjb3JlKFxuICAgICAgICAgICAgdGhlcmFwaXN0LFxuICAgICAgICAgICAgdXNlckNvbmRpdGlvbnMsXG4gICAgICAgICAgKTtcbiAgICAgICAgICB0aGVyYXBpc3RTY29yZXMucHVzaCh7XG4gICAgICAgICAgICB0aGVyYXBpc3QsXG4gICAgICAgICAgICB0b3RhbFNjb3JlOiBiYXNpY1Njb3JlLFxuICAgICAgICAgICAgYnJlYWtkb3duOiB7XG4gICAgICAgICAgICAgIGNvbmRpdGlvblNjb3JlOiBiYXNpY1Njb3JlICogMC42LFxuICAgICAgICAgICAgICBhcHByb2FjaFNjb3JlOiAwLFxuICAgICAgICAgICAgICBleHBlcmllbmNlU2NvcmU6IGJhc2ljU2NvcmUgKiAwLjQsXG4gICAgICAgICAgICAgIHJldmlld1Njb3JlOiAwLFxuICAgICAgICAgICAgICBsb2dpc3RpY3NTY29yZTogMCxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBtYXRjaEV4cGxhbmF0aW9uOiB7XG4gICAgICAgICAgICAgIHByaW1hcnlNYXRjaGVzOiB0aGlzLmdldFByaW1hcnlDb25kaXRpb25zKHVzZXJDb25kaXRpb25zKSxcbiAgICAgICAgICAgICAgc2Vjb25kYXJ5TWF0Y2hlczogdGhpcy5nZXRTZWNvbmRhcnlDb25kaXRpb25zKHVzZXJDb25kaXRpb25zKSxcbiAgICAgICAgICAgICAgYXBwcm9hY2hNYXRjaGVzOiBbXSxcbiAgICAgICAgICAgICAgZXhwZXJpZW5jZVllYXJzOiB0aGlzLmNhbGN1bGF0ZVllYXJzT2ZFeHBlcmllbmNlKFxuICAgICAgICAgICAgICAgIHRoZXJhcGlzdC5wcmFjdGljZVN0YXJ0RGF0ZSxcbiAgICAgICAgICAgICAgKSxcbiAgICAgICAgICAgICAgYXZlcmFnZVJhdGluZzogMCxcbiAgICAgICAgICAgICAgdG90YWxSZXZpZXdzOiAwLFxuICAgICAgICAgICAgICBzdWNjZXNzUmF0ZXM6IHt9LFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICAvLyBTb3J0IGJ5IHRvdGFsIHNjb3JlIGRlc2NlbmRpbmdcbiAgICAgIGNvbnN0IHNvcnRlZFRoZXJhcGlzdFNjb3JlcyA9IHRoZXJhcGlzdFNjb3Jlcy5zb3J0KFxuICAgICAgICAoYSwgYikgPT4gYi50b3RhbFNjb3JlIC0gYS50b3RhbFNjb3JlLFxuICAgICAgKTtcblxuICAgICAgLy8gVGFrZSBvbmx5IHRoZSByZXF1ZXN0ZWQgbnVtYmVyIG9mIHJlc3VsdHNcbiAgICAgIGNvbnN0IGZpbmFsUmVzdWx0cyA9IHNvcnRlZFRoZXJhcGlzdFNjb3Jlcy5zbGljZSgwLCByZXF1ZXN0LmxpbWl0ID8/IDEwKTtcblxuICAgICAgLy8gVHJhY2sgcmVjb21tZW5kYXRpb24gYW5hbHl0aWNzXG4gICAgICBhd2FpdCB0aGlzLm1hdGNoaW5nQW5hbHl0aWNzLnRyYWNrUmVjb21tZW5kYXRpb24oXG4gICAgICAgIHJlcXVlc3QudXNlcklkLFxuICAgICAgICBmaW5hbFJlc3VsdHMsXG4gICAgICAgICdhZHZhbmNlZF92MS4wJyxcbiAgICAgICk7XG5cbiAgICAgIC8vIFRyYW5zZm9ybSB0byBleHBlY3RlZCBmb3JtYXRcbiAgICAgIGNvbnN0IHRoZXJhcGlzdHNXaXRoU2NvcmVzID0gZmluYWxSZXN1bHRzLm1hcCgoc2NvcmUpID0+ICh7XG4gICAgICAgIC4uLnNjb3JlLnRoZXJhcGlzdCxcbiAgICAgICAgbWF0Y2hTY29yZTogc2NvcmUudG90YWxTY29yZSxcbiAgICAgICAgc2NvcmVCcmVha2Rvd246IHNjb3JlLmJyZWFrZG93bixcbiAgICAgICAgbWF0Y2hFeHBsYW5hdGlvbjogc2NvcmUubWF0Y2hFeHBsYW5hdGlvbixcbiAgICAgIH0pKTtcblxuICAgICAgLy8gRGV0ZXJtaW5lIHByaW1hcnkgYW5kIHNlY29uZGFyeSBjb25kaXRpb25zXG4gICAgICBjb25zdCBwcmltYXJ5Q29uZGl0aW9ucyA9IHRoaXMuZ2V0UHJpbWFyeUNvbmRpdGlvbnModXNlckNvbmRpdGlvbnMpO1xuICAgICAgY29uc3Qgc2Vjb25kYXJ5Q29uZGl0aW9ucyA9IHRoaXMuZ2V0U2Vjb25kYXJ5Q29uZGl0aW9ucyh1c2VyQ29uZGl0aW9ucyk7XG5cbiAgICAgIHJldHVybiB7XG4gICAgICAgIHRvdGFsQ291bnQ6IHRoZXJhcGlzdHNXaXRoU2NvcmVzLmxlbmd0aCxcbiAgICAgICAgdXNlckNvbmRpdGlvbnM6IE9iamVjdC5rZXlzKHVzZXJDb25kaXRpb25zKSxcbiAgICAgICAgdGhlcmFwaXN0czogdGhlcmFwaXN0c1dpdGhTY29yZXMsXG4gICAgICAgIG1hdGNoQ3JpdGVyaWE6IHtcbiAgICAgICAgICBwcmltYXJ5Q29uZGl0aW9ucyxcbiAgICAgICAgICBzZWNvbmRhcnlDb25kaXRpb25zLFxuICAgICAgICAgIHNldmVyaXR5TGV2ZWxzLFxuICAgICAgICB9LFxuICAgICAgICBwYWdlOiAxLFxuICAgICAgICBwYWdlU2l6ZTogcmVxdWVzdC5saW1pdCA/PyAxMCxcbiAgICAgIH07XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRocm93IG5ldyBJbnRlcm5hbFNlcnZlckVycm9yRXhjZXB0aW9uKFxuICAgICAgICBlcnJvciBpbnN0YW5jZW9mIEVycm9yXG4gICAgICAgICAgPyBlcnJvci5tZXNzYWdlXG4gICAgICAgICAgOiAnRmFpbGVkIHRvIGdldCB0aGVyYXBpc3QgcmVjb21tZW5kYXRpb25zJyxcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEdldCBkZXRhaWxlZCBjb21wYXRpYmlsaXR5IGFuYWx5c2lzIGJldHdlZW4gYSBjbGllbnQgYW5kIHRoZXJhcGlzdFxuICAgKi9cbiAgYXN5bmMgZ2V0Q29tcGF0aWJpbGl0eUFuYWx5c2lzKGNsaWVudElkOiBzdHJpbmcsIHRoZXJhcGlzdElkOiBzdHJpbmcpIHtcbiAgICBjb25zdCBjbGllbnQgPSBhd2FpdCB0aGlzLnByaXNtYS5jbGllbnQuZmluZFVuaXF1ZSh7XG4gICAgICB3aGVyZTogeyB1c2VySWQ6IGNsaWVudElkIH0sXG4gICAgICBpbmNsdWRlOiB7XG4gICAgICAgIHByZUFzc2Vzc21lbnQ6IHRydWUsXG4gICAgICAgIGNsaWVudFByZWZlcmVuY2VzOiB0cnVlLFxuICAgICAgICB1c2VyOiB0cnVlLFxuICAgICAgfSxcbiAgICB9KTtcblxuICAgIGNvbnN0IHRoZXJhcGlzdCA9IGF3YWl0IHRoaXMucHJpc21hLnRoZXJhcGlzdC5maW5kVW5pcXVlKHtcbiAgICAgIHdoZXJlOiB7IHVzZXJJZDogdGhlcmFwaXN0SWQgfSxcbiAgICAgIGluY2x1ZGU6IHtcbiAgICAgICAgdXNlcjogdHJ1ZSxcbiAgICAgICAgcmV2aWV3czoge1xuICAgICAgICAgIHdoZXJlOiB7IHN0YXR1czogJ0FQUFJPVkVEJyB9LFxuICAgICAgICB9LFxuICAgICAgfSxcbiAgICB9KTtcblxuICAgIGlmICghY2xpZW50IHx8ICF0aGVyYXBpc3QpIHtcbiAgICAgIHRocm93IG5ldyBOb3RGb3VuZEV4Y2VwdGlvbignQ2xpZW50IG9yIHRoZXJhcGlzdCBub3QgZm91bmQnKTtcbiAgICB9XG5cbiAgICBpZiAoIWNsaWVudC5wcmVBc3Nlc3NtZW50KSB7XG4gICAgICB0aHJvdyBuZXcgTm90Rm91bmRFeGNlcHRpb24oJ05vIHByZS1hc3Nlc3NtZW50IGZvdW5kIGZvciBjbGllbnQnKTtcbiAgICB9XG5cbiAgICBjb25zdCBjb21wYXRpYmlsaXR5ID0gYXdhaXQgdGhpcy5jb21wYXRpYmlsaXR5QW5hbHlzaXMuYW5hbHl6ZUNvbXBhdGliaWxpdHkoXG4gICAgICBjbGllbnQgYXMgYW55LCAvLyBTYWZlIGJlY2F1c2Ugd2UgdmVyaWZpZWQgcHJlQXNzZXNzbWVudCBleGlzdHMgYWJvdmVcbiAgICAgIHRoZXJhcGlzdCxcbiAgICApO1xuXG4gICAgLy8gVHJhY2sgY29tcGF0aWJpbGl0eSBhbmFseXNpc1xuICAgIGF3YWl0IHRoaXMubWF0Y2hpbmdBbmFseXRpY3MudHJhY2tDb21wYXRpYmlsaXR5QW5hbHlzaXMoXG4gICAgICBjbGllbnRJZCxcbiAgICAgIHRoZXJhcGlzdElkLFxuICAgICAgY29tcGF0aWJpbGl0eSxcbiAgICAgICcxLjAnLFxuICAgICk7XG5cbiAgICByZXR1cm4gY29tcGF0aWJpbGl0eTtcbiAgfVxuXG4gIHByaXZhdGUgZXh0cmFjdFVzZXJDb25kaXRpb25zKFxuICAgIHByZUFzc2Vzc21lbnQ6IFByZUFzc2Vzc21lbnQsXG4gICk6IFJlY29yZDxzdHJpbmcsIHN0cmluZz4ge1xuICAgIGNvbnN0IGNvbmRpdGlvbnM6IFJlY29yZDxzdHJpbmcsIHN0cmluZz4gPSB7fTtcbiAgICBjb25zdCBzZXZlcml0eUxldmVscyA9IHByZUFzc2Vzc21lbnQuc2V2ZXJpdHlMZXZlbHMgYXMgUmVjb3JkPFxuICAgICAgc3RyaW5nLFxuICAgICAgc3RyaW5nXG4gICAgPjtcbiAgICBjb25zdCBxdWVzdGlvbm5haXJlcyA9IHByZUFzc2Vzc21lbnQucXVlc3Rpb25uYWlyZXMgYXMgc3RyaW5nW107XG4gICAgcXVlc3Rpb25uYWlyZXMuZm9yRWFjaCgocSkgPT4ge1xuICAgICAgaWYgKHNldmVyaXR5TGV2ZWxzW3FdKSB7XG4gICAgICAgIGNvbmRpdGlvbnNbcV0gPSBzZXZlcml0eUxldmVsc1txXTtcbiAgICAgIH1cbiAgICB9KTtcbiAgICByZXR1cm4gY29uZGl0aW9ucztcbiAgfVxuXG4gIHByaXZhdGUgY2FsY3VsYXRlTWF0Y2hTY29yZShcbiAgICB0aGVyYXBpc3Q6IGFueSxcbiAgICB1c2VyQ29uZGl0aW9uczogUmVjb3JkPHN0cmluZywgc3RyaW5nPixcbiAgKTogbnVtYmVyIHtcbiAgICBsZXQgc2NvcmUgPSAwO1xuICAgIGNvbnN0IGV4cGVydGlzZSA9ICh0aGVyYXBpc3QuZXhwZXJ0aXNlIGFzIHN0cmluZ1tdKSB8fCBbXTtcbiAgICBPYmplY3Qua2V5cyh1c2VyQ29uZGl0aW9ucykuZm9yRWFjaCgoY29uZGl0aW9uKSA9PiB7XG4gICAgICBpZiAoZXhwZXJ0aXNlLmluY2x1ZGVzKGNvbmRpdGlvbikpIHNjb3JlICs9IDIwO1xuICAgIH0pO1xuICAgIHNjb3JlICs9IE1hdGgubWluKFxuICAgICAgdGhpcy5jYWxjdWxhdGVZZWFyc09mRXhwZXJpZW5jZSh0aGVyYXBpc3QucHJhY3RpY2VTdGFydERhdGUpICogMixcbiAgICAgIDIwLFxuICAgICk7XG4gICAgLy8gQWRkIGJhc2Ugc2NvcmUgZm9yIGV4cGVyaWVuY2VcbiAgICBzY29yZSArPSB0aGVyYXBpc3QueWVhcnNPZkV4cGVyaWVuY2UgPyB0aGVyYXBpc3QueWVhcnNPZkV4cGVyaWVuY2UgKiAyIDogMDtcbiAgICByZXR1cm4gc2NvcmU7XG4gIH1cblxuICBwcml2YXRlIGdldFByaW1hcnlDb25kaXRpb25zKFxuICAgIHVzZXJDb25kaXRpb25zOiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+LFxuICApOiBzdHJpbmdbXSB7XG4gICAgcmV0dXJuIE9iamVjdC5lbnRyaWVzKHVzZXJDb25kaXRpb25zKVxuICAgICAgLmZpbHRlcigoWywgc2V2ZXJpdHldKSA9PiB0aGlzLmdldFNldmVyaXR5V2VpZ2h0KHNldmVyaXR5KSA+PSA0KVxuICAgICAgLm1hcCgoW2NvbmRpdGlvbl0pID0+IGNvbmRpdGlvbik7XG4gIH1cblxuICBwcml2YXRlIGdldFNlY29uZGFyeUNvbmRpdGlvbnMoXG4gICAgdXNlckNvbmRpdGlvbnM6IFJlY29yZDxzdHJpbmcsIHN0cmluZz4sXG4gICk6IHN0cmluZ1tdIHtcbiAgICByZXR1cm4gT2JqZWN0LmVudHJpZXModXNlckNvbmRpdGlvbnMpXG4gICAgICAuZmlsdGVyKChbLCBzZXZlcml0eV0pID0+IHtcbiAgICAgICAgY29uc3Qgd2VpZ2h0ID0gdGhpcy5nZXRTZXZlcml0eVdlaWdodChzZXZlcml0eSk7XG4gICAgICAgIHJldHVybiB3ZWlnaHQgPj0gMiAmJiB3ZWlnaHQgPCA0O1xuICAgICAgfSlcbiAgICAgIC5tYXAoKFtjb25kaXRpb25dKSA9PiBjb25kaXRpb24pO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRTZXZlcml0eVdlaWdodChzZXZlcml0eTogc3RyaW5nKTogbnVtYmVyIHtcbiAgICBjb25zdCBzZXZlcml0eVdlaWdodHM6IFJlY29yZDxzdHJpbmcsIG51bWJlcj4gPSB7XG4gICAgICBNaW5pbWFsOiAxLFxuICAgICAgTWlsZDogMixcbiAgICAgIE1vZGVyYXRlOiAzLFxuICAgICAgJ01vZGVyYXRlbHkgU2V2ZXJlJzogNCxcbiAgICAgIFNldmVyZTogNSxcbiAgICAgICdWZXJ5IFNldmVyZSc6IDUsXG4gICAgICBFeHRyZW1lOiA1LFxuICAgICAgTG93OiAxLFxuICAgICAgSGlnaDogNCxcbiAgICAgIFN1YnN0YW50aWFsOiA0LFxuICAgICAgU3ViY2xpbmljYWw6IDEsXG4gICAgICBDbGluaWNhbDogNCxcbiAgICAgIE5vbmU6IDAsXG4gICAgICBTdWJ0aHJlc2hvbGQ6IDIsXG4gICAgICBQb3NpdGl2ZTogNCxcbiAgICAgIE5lZ2F0aXZlOiAwLFxuICAgIH07XG4gICAgcmV0dXJuIHNldmVyaXR5V2VpZ2h0c1tzZXZlcml0eV0gfHwgMTtcbiAgfVxufVxuIl0sInZlcnNpb24iOjN9