ef5bf92e1378f3c02b70ad7b135007d9
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var ClientService_1;
var _a, _b;
Object.defineProperty(exports, "__esModule", { value: true });
exports.ClientService = void 0;
const common_1 = require("@nestjs/common");
const prisma_client_provider_1 = require("../providers/prisma-client.provider");
const messaging_service_1 = require("../messaging/messaging.service");
const library_1 = require("@prisma/client/runtime/library");
let ClientService = ClientService_1 = class ClientService {
    prisma;
    messagingService;
    logger = new common_1.Logger(ClientService_1.name);
    constructor(prisma, messagingService) {
        this.prisma = prisma;
        this.messagingService = messagingService;
    }
    async getProfile(userId) {
        try {
            const client = await this.prisma.client.findUnique({
                where: { userId },
                include: { user: true },
            });
            if (!client) {
                this.logger.warn(`Client profile not found for userId: ${userId}`);
                throw new common_1.NotFoundException('Client profile not found');
            }
            return this.transformPrismaUserToDTO(client.user);
        }
        catch (error) {
            if (error instanceof common_1.NotFoundException) {
                throw error;
            }
            if (error instanceof library_1.PrismaClientKnownRequestError) {
                this.logger.error(`Database error in getProfile: ${error.code} - ${error.message}`);
                throw new common_1.InternalServerErrorException('Failed to retrieve client profile');
            }
            this.logger.error(`Unexpected error in getProfile: ${error instanceof Error ? error.message : String(error)}`);
            throw new common_1.InternalServerErrorException('An unexpected error occurred');
        }
    }
    async updateProfile(userId, data) {
        try {
            const updatedClient = await this.prisma.client.update({
                where: { userId },
                data: {
                    user: {
                        update: data,
                    },
                },
                include: { user: true },
            });
            return this.transformPrismaUserToDTO(updatedClient.user);
        }
        catch (error) {
            if (error instanceof library_1.PrismaClientKnownRequestError) {
                switch (error.code) {
                    case 'P2025':
                        this.logger.warn(`Client not found for update, userId: ${userId}`);
                        throw new common_1.NotFoundException('Client not found');
                    case 'P2002':
                        this.logger.warn(`Unique constraint violation in updateProfile: ${error.message}`);
                        throw new common_1.BadRequestException('A profile with this data already exists');
                    default:
                        this.logger.error(`Database error in updateProfile: ${error.code} - ${error.message}`);
                        throw new common_1.InternalServerErrorException('Failed to update client profile');
                }
            }
            this.logger.error(`Unexpected error in updateProfile: ${error instanceof Error ? error.message : String(error)}`);
            throw new common_1.InternalServerErrorException('An unexpected error occurred while updating profile');
        }
    }
    async needsTherapistRecommendations(userId) {
        try {
            const client = await this.prisma.client.findUnique({
                where: { userId },
                select: { hasSeenTherapistRecommendations: true },
            });
            return !client?.hasSeenTherapistRecommendations;
        }
        catch (error) {
            this.logger.error(`Error checking therapist recommendations for userId ${userId}: ${error instanceof Error ? error.message : String(error)}`);
            throw new common_1.InternalServerErrorException('Failed to check therapist recommendation status');
        }
    }
    async markTherapistRecommendationsSeen(userId) {
        try {
            await this.prisma.client.update({
                where: { userId },
                data: { hasSeenTherapistRecommendations: true },
            });
        }
        catch (error) {
            if (error instanceof library_1.PrismaClientKnownRequestError &&
                error.code === 'P2025') {
                this.logger.warn(`Client not found when marking recommendations seen, userId: ${userId}`);
                throw new common_1.NotFoundException('Client not found');
            }
            this.logger.error(`Error marking therapist recommendations seen for userId ${userId}: ${error instanceof Error ? error.message : String(error)}`);
            throw new common_1.InternalServerErrorException('Failed to update therapist recommendation status');
        }
    }
    async getAssignedTherapist(userId) {
        const assignment = await this.prisma.clientTherapist.findFirst({
            where: {
                clientId: userId,
                status: 'active',
            },
            include: {
                therapist: {
                    include: { user: true },
                },
            },
            orderBy: { assignedAt: 'desc' },
        });
        if (!assignment?.therapist) {
            return null;
        }
        // Transform the Prisma result to match TherapistRecommendation type
        const therapist = assignment.therapist;
        return {
            id: therapist.userId,
            firstName: therapist.user.firstName,
            lastName: therapist.user.lastName,
            title: 'Therapist',
            specialties: therapist.areasOfExpertise,
            hourlyRate: Number(therapist.hourlyRate),
            experience: therapist.yearsOfExperience || 0,
            province: therapist.province,
            isActive: therapist.status === 'APPROVED',
            bio: therapist.user.bio || undefined,
            profileImage: undefined,
        };
    }
    async getAssignedTherapists(userId) {
        const assignments = await this.prisma.clientTherapist.findMany({
            where: {
                clientId: userId,
                status: 'active',
            },
            include: {
                therapist: {
                    include: { user: true },
                },
            },
            orderBy: { assignedAt: 'desc' },
        });
        if (!assignments || assignments.length === 0) {
            return [];
        }
        // Transform the Prisma results to match TherapistRecommendation type
        return assignments.map(assignment => {
            const therapist = assignment.therapist;
            return {
                id: therapist.userId,
                firstName: therapist.user.firstName,
                lastName: therapist.user.lastName,
                title: 'Therapist',
                specialties: therapist.areasOfExpertise,
                hourlyRate: Number(therapist.hourlyRate),
                experience: therapist.yearsOfExperience || 0,
                province: therapist.province,
                isActive: therapist.status === 'APPROVED',
                bio: therapist.user.bio || undefined,
                profileImage: undefined,
            };
        });
    }
    async assignTherapist(userId, therapistId) {
        // Check if client exists
        const client = await this.prisma.client.findUnique({
            where: { userId },
        });
        if (!client) {
            throw new common_1.NotFoundException('Client not found');
        }
        // Check if therapist exists
        const therapist = await this.prisma.therapist.findUnique({
            where: { userId: therapistId },
            include: { user: true },
        });
        if (!therapist) {
            throw new common_1.NotFoundException('Therapist not found');
        }
        // Check if this assignment already exists
        const existingAssignment = await this.prisma.clientTherapist.findUnique({
            where: {
                clientId_therapistId: {
                    clientId: userId,
                    therapistId: therapistId,
                },
            },
        });
        // If assignment already exists, update status to active
        if (existingAssignment) {
            await this.prisma.clientTherapist.update({
                where: { id: existingAssignment.id },
                data: { status: 'active' },
            });
        }
        else {
            // Create new assignment
            await this.prisma.clientTherapist.create({
                data: {
                    clientId: userId,
                    therapistId: therapistId,
                    status: 'active',
                },
            });
        }
        // Automatically create conversation between client and therapist
        try {
            await this.messagingService.createConversation(userId, {
                participantIds: [therapistId],
                type: 'direct',
                title: `Therapy Session with ${therapist.user.firstName} ${therapist.user.lastName}`,
            });
            this.logger.log(`Auto-created conversation between client ${userId} and therapist ${therapistId}`);
        }
        catch (error) {
            // Log error but don't fail the assignment if conversation creation fails
            this.logger.warn(`Failed to auto-create conversation between client ${userId} and therapist ${therapistId}: ${error instanceof Error ? error.message : String(error)}`);
        }
        // Transform the Prisma result to match TherapistRecommendation type
        return {
            id: therapist.userId,
            firstName: therapist.user.firstName,
            lastName: therapist.user.lastName,
            title: 'Therapist',
            specialties: therapist.areasOfExpertise,
            hourlyRate: Number(therapist.hourlyRate),
            experience: therapist.yearsOfExperience || 0,
            province: therapist.province,
            isActive: therapist.status === 'APPROVED',
            bio: therapist.user.bio || undefined,
            profileImage: undefined,
        };
    }
    async removeTherapist(userId) {
        // Check if client exists
        const client = await this.prisma.client.findUnique({
            where: { userId },
        });
        if (!client) {
            throw new common_1.NotFoundException('Client not found');
        }
        // Set all existing assignments to inactive instead of deleting
        await this.prisma.clientTherapist.updateMany({
            where: {
                clientId: userId,
                status: 'active',
            },
            data: {
                status: 'inactive',
            },
        });
    }
    transformPrismaUserToDTO(user) {
        return {
            id: user.id,
            email: user.email,
            role: user.role,
            createdAt: user.createdAt.toISOString(),
            updatedAt: user.updatedAt.toISOString(),
            firstName: user.firstName,
            lastName: user.lastName,
        };
    }
};
exports.ClientService = ClientService;
exports.ClientService = ClientService = ClientService_1 = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [typeof (_a = typeof prisma_client_provider_1.PrismaService !== "undefined" && prisma_client_provider_1.PrismaService) === "function" ? _a : Object, typeof (_b = typeof messaging_service_1.MessagingService !== "undefined" && messaging_service_1.MessagingService) === "function" ? _b : Object])
], ClientService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL2NsaWVudC9jbGllbnQuc2VydmljZS50cyIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7OztBQUFBLDJDQU13QjtBQUN4QixnRkFBb0U7QUFDcEUsc0VBQWtFO0FBQ2xFLDREQUErRTtBQWN4RSxJQUFNLGFBQWEscUJBQW5CLE1BQU0sYUFBYTtJQUlMO0lBQ0E7SUFKRixNQUFNLEdBQUcsSUFBSSxlQUFNLENBQUMsZUFBYSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBRXpELFlBQ21CLE1BQXFCLEVBQ3JCLGdCQUFrQztRQURsQyxXQUFNLEdBQU4sTUFBTSxDQUFlO1FBQ3JCLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBa0I7SUFDbEQsQ0FBQztJQUVKLEtBQUssQ0FBQyxVQUFVLENBQUMsTUFBYztRQUM3QixJQUFJLENBQUM7WUFDSCxNQUFNLE1BQU0sR0FBRyxNQUFNLElBQUksQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQztnQkFDakQsS0FBSyxFQUFFLEVBQUUsTUFBTSxFQUFFO2dCQUNqQixPQUFPLEVBQUUsRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFO2FBQ3hCLENBQUMsQ0FBQztZQUVILElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQztnQkFDWixJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyx3Q0FBd0MsTUFBTSxFQUFFLENBQUMsQ0FBQztnQkFDbkUsTUFBTSxJQUFJLDBCQUFpQixDQUFDLDBCQUEwQixDQUFDLENBQUM7WUFDMUQsQ0FBQztZQUVELE9BQU8sSUFBSSxDQUFDLHdCQUF3QixDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUNwRCxDQUFDO1FBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztZQUNmLElBQUksS0FBSyxZQUFZLDBCQUFpQixFQUFFLENBQUM7Z0JBQ3ZDLE1BQU0sS0FBSyxDQUFDO1lBQ2QsQ0FBQztZQUVELElBQUksS0FBSyxZ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LENBQUE7QUEzVFksc0NBQWE7d0JBQWIsYUFBYTtJQUR6QixJQUFBLG1CQUFVLEdBQUU7eURBS2dCLHNDQUFhLG9CQUFiLHNDQUFhLG9EQUNILG9DQUFnQixvQkFBaEIsb0NBQWdCO0dBTDFDLGFBQWEsQ0EyVHpCIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9ob21lL3dldG9vYS9Eb2N1bWVudHMvY29kZS9wcm9qZWN0cy9tZW50YXJhL21lbnRhcmEtYXBpL3NyYy9jbGllbnQvY2xpZW50LnNlcnZpY2UudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgSW5qZWN0YWJsZSxcbiAgTm90Rm91bmRFeGNlcHRpb24sXG4gIEJhZFJlcXVlc3RFeGNlcHRpb24sXG4gIEludGVybmFsU2VydmVyRXJyb3JFeGNlcHRpb24sXG4gIExvZ2dlcixcbn0gZnJvbSAnQG5lc3Rqcy9jb21tb24nO1xuaW1wb3J0IHsgUHJpc21hU2VydmljZSB9IGZyb20gJy4uL3Byb3ZpZGVycy9wcmlzbWEtY2xpZW50LnByb3ZpZGVyJztcbmltcG9ydCB7IE1lc3NhZ2luZ1NlcnZpY2UgfSBmcm9tICcuLi9tZXNzYWdpbmcvbWVzc2FnaW5nLnNlcnZpY2UnO1xuaW1wb3J0IHsgUHJpc21hQ2xpZW50S25vd25SZXF1ZXN0RXJyb3IgfSBmcm9tICdAcHJpc21hL2NsaWVudC9ydW50aW1lL2xpYnJhcnknO1xuLy8gQ2xpZW50IHByb2ZpbGUgRFRPIGludGVyZmFjZVxuaW50ZXJmYWNlIENsaWVudFByb2ZpbGVEdG8ge1xuICBpZDogc3RyaW5nO1xuICBlbWFpbDogc3RyaW5nO1xuICBmaXJzdE5hbWU6IHN0cmluZztcbiAgbGFzdE5hbWU6IHN0cmluZztcbiAgcm9sZTogc3RyaW5nO1xuICBjcmVhdGVkQXQ6IHN0cmluZztcbiAgdXBkYXRlZEF0OiBzdHJpbmc7XG59XG5pbXBvcnQgdHlwZSB7IFVwZGF0ZUNsaWVudER0bywgVGhlcmFwaXN0UmVjb21tZW5kYXRpb24gfSBmcm9tICcuL3R5cGVzJztcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIENsaWVudFNlcnZpY2Uge1xuICBwcml2YXRlIHJlYWRvbmx5IGxvZ2dlciA9IG5ldyBMb2dnZXIoQ2xpZW50U2VydmljZS5uYW1lKTtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHJlYWRvbmx5IHByaXNtYTogUHJpc21hU2VydmljZSxcbiAgICBwcml2YXRlIHJlYWRvbmx5IG1lc3NhZ2luZ1NlcnZpY2U6IE1lc3NhZ2luZ1NlcnZpY2UsXG4gICkge31cblxuICBhc3luYyBnZXRQcm9maWxlKHVzZXJJZDogc3RyaW5nKTogUHJvbWlzZTxDbGllbnRQcm9maWxlRHRvPiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGNsaWVudCA9IGF3YWl0IHRoaXMucHJpc21hLmNsaWVudC5maW5kVW5pcXVlKHtcbiAgICAgICAgd2hlcmU6IHsgdXNlcklkIH0sXG4gICAgICAgIGluY2x1ZGU6IHsgdXNlcjogdHJ1ZSB9LFxuICAgICAgfSk7XG5cbiAgICAgIGlmICghY2xpZW50KSB7XG4gICAgICAgIHRoaXMubG9nZ2VyLndhcm4oYENsaWVudCBwcm9maWxlIG5vdCBmb3VuZCBmb3IgdXNlcklkOiAke3VzZXJJZH1gKTtcbiAgICAgICAgdGhyb3cgbmV3IE5vdEZvdW5kRXhjZXB0aW9uKCdDbGllbnQgcHJvZmlsZSBub3QgZm91bmQnKTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHRoaXMudHJhbnNmb3JtUHJpc21hVXNlclRvRFRPKGNsaWVudC51c2VyKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgaWYgKGVycm9yIGluc3RhbmNlb2YgTm90Rm91bmRFeGNlcHRpb24pIHtcbiAgICAgICAgdGhyb3cgZXJyb3I7XG4gICAgICB9XG5cbiAgICAgIGlmIChlcnJvciBpbnN0YW5jZW9mIFByaXNtYUNsaWVudEtub3duUmVxdWVzdEVycm9yKSB7XG4gICAgICAgIHRoaXMubG9nZ2VyLmVycm9yKFxuICAgICAgICAgIGBEYXRhYmFzZSBlcnJvciBpbiBnZXRQcm9maWxlOiAke2Vycm9yLmNvZGV9IC0gJHtlcnJvci5tZXNzYWdlfWAsXG4gICAgICAgICk7XG4gICAgICAgIHRocm93IG5ldyBJbnRlcm5hbFNlcnZlckVycm9yRXhjZXB0aW9uKFxuICAgICAgICAgICdGYWlsZWQgdG8gcmV0cmlldmUgY2xpZW50IHByb2ZpbGUnLFxuICAgICAgICApO1xuICAgICAgfVxuXG4gICAgICB0aGlzLmxvZ2dlci5lcnJvcihcbiAgICAgICAgYFVuZXhwZWN0ZWQgZXJyb3IgaW4gZ2V0UHJvZmlsZTogJHtlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6IFN0cmluZyhlcnJvcil9YCxcbiAgICAgICk7XG4gICAgICB0aHJvdyBuZXcgSW50ZXJuYWxTZXJ2ZXJFcnJvckV4Y2VwdGlvbignQW4gdW5leHBlY3RlZCBlcnJvciBvY2N1cnJlZCcpO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIHVwZGF0ZVByb2ZpbGUodXNlcklkOiBzdHJpbmcsIGRhdGE6IFVwZGF0ZUNsaWVudER0byk6IFByb21pc2U8Q2xpZW50UHJvZmlsZUR0bz4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCB1cGRhdGVkQ2xpZW50ID0gYXdhaXQgdGhpcy5wcmlzbWEuY2xpZW50LnVwZGF0ZSh7XG4gICAgICAgIHdoZXJlOiB7IHVzZXJJZCB9LFxuICAgICAgICBkYXRhOiB7XG4gICAgICAgICAgdXNlcjoge1xuICAgICAgICAgICAgdXBkYXRlOiBkYXRhLFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICAgIGluY2x1ZGU6IHsgdXNlcjogdHJ1ZSB9LFxuICAgICAgfSk7XG5cbiAgICAgIHJldHVybiB0aGlzLnRyYW5zZm9ybVByaXNtYVVzZXJUb0RUTyh1cGRhdGVkQ2xpZW50LnVzZXIpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBpZiAoZXJyb3IgaW5zdGFuY2VvZiBQcmlzbWFDbGllbnRLbm93blJlcXVlc3RFcnJvcikge1xuICAgICAgICBzd2l0Y2ggKGVycm9yLmNvZGUpIHtcbiAgICAgICAgICBjYXNlICdQMjAyNSc6XG4gICAgICAgICAgICB0aGlzLmxvZ2dlci53YXJuKGBDbGllbnQgbm90IGZvdW5kIGZvciB1cGRhdGUsIHVzZXJJZDogJHt1c2VySWR9YCk7XG4gICAgICAgICAgICB0aHJvdyBuZXcgTm90Rm91bmRFeGNlcHRpb24oJ0NsaWVudCBub3QgZm91bmQnKTtcbiAgICAgICAgICBjYXNlICdQMjAwMic6XG4gICAgICAgICAgICB0aGlzLmxvZ2dlci53YXJuKFxuICAgICAgICAgICAgICBgVW5pcXVlIGNvbnN0cmFpbnQgdmlvbGF0aW9uIGluIHVwZGF0ZVByb2ZpbGU6ICR7ZXJyb3IubWVzc2FnZX1gLFxuICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0RXhjZXB0aW9uKFxuICAgICAgICAgICAgICAnQSBwcm9maWxlIHdpdGggdGhpcyBkYXRhIGFscmVhZHkgZXhpc3RzJyxcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICAgIHRoaXMubG9nZ2VyLmVycm9yKFxuICAgICAgICAgICAgICBgRGF0YWJhc2UgZXJyb3IgaW4gdXBkYXRlUHJvZmlsZTogJHtlcnJvci5jb2RlfSAtICR7ZXJyb3IubWVzc2FnZX1gLFxuICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIHRocm93IG5ldyBJbnRlcm5hbFNlcnZlckVycm9yRXhjZXB0aW9uKFxuICAgICAgICAgICAgICAnRmFpbGVkIHRvIHVwZGF0ZSBjbGllbnQgcHJvZmlsZScsXG4gICAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIHRoaXMubG9nZ2VyLmVycm9yKFxuICAgICAgICBgVW5leHBlY3RlZCBlcnJvciBpbiB1cGRhdGVQcm9maWxlOiAke2Vycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogU3RyaW5nKGVycm9yKX1gLFxuICAgICAgKTtcbiAgICAgIHRocm93IG5ldyBJbnRlcm5hbFNlcnZlckVycm9yRXhjZXB0aW9uKFxuICAgICAgICAnQW4gdW5leHBlY3RlZCBlcnJvciBvY2N1cnJlZCB3aGlsZSB1cGRhdGluZyBwcm9maWxlJyxcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgbmVlZHNUaGVyYXBpc3RSZWNvbW1lbmRhdGlvbnModXNlcklkOiBzdHJpbmcpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgY2xpZW50ID0gYXdhaXQgdGhpcy5wcmlzbWEuY2xpZW50LmZpbmRVbmlxdWUoe1xuICAgICAgICB3aGVyZTogeyB1c2VySWQgfSxcbiAgICAgICAgc2VsZWN0OiB7IGhhc1NlZW5UaGVyYXBpc3RSZWNvbW1lbmRhdGlvbnM6IHRydWUgfSxcbiAgICAgIH0pO1xuICAgICAgcmV0dXJuICFjbGllbnQ/Lmhhc1NlZW5UaGVyYXBpc3RSZWNvbW1lbmRhdGlvbnM7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRoaXMubG9nZ2VyLmVycm9yKFxuICAgICAgICBgRXJyb3IgY2hlY2tpbmcgdGhlcmFwaXN0IHJlY29tbWVuZGF0aW9ucyBmb3IgdXNlcklkICR7dXNlcklkfTogJHtlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6IFN0cmluZyhlcnJvcil9YCxcbiAgICAgICk7XG4gICAgICB0aHJvdyBuZXcgSW50ZXJuYWxTZXJ2ZXJFcnJvckV4Y2VwdGlvbihcbiAgICAgICAgJ0ZhaWxlZCB0byBjaGVjayB0aGVyYXBpc3QgcmVjb21tZW5kYXRpb24gc3RhdHVzJyxcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgbWFya1RoZXJhcGlzdFJlY29tbWVuZGF0aW9uc1NlZW4odXNlcklkOiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICB0cnkge1xuICAgICAgYXdhaXQgdGhpcy5wcmlzbWEuY2xpZW50LnVwZGF0ZSh7XG4gICAgICAgIHdoZXJlOiB7IHVzZXJJZCB9LFxuICAgICAgICBkYXRhOiB7IGhhc1NlZW5UaGVyYXBpc3RSZWNvbW1lbmRhdGlvbnM6IHRydWUgfSxcbiAgICAgIH0pO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBpZiAoXG4gICAgICAgIGVycm9yIGluc3RhbmNlb2YgUHJpc21hQ2xpZW50S25vd25SZXF1ZXN0RXJyb3IgJiZcbiAgICAgICAgZXJyb3IuY29kZSA9PT0gJ1AyMDI1J1xuICAgICAgKSB7XG4gICAgICAgIHRoaXMubG9nZ2VyLndhcm4oXG4gICAgICAgICAgYENsaWVudCBub3QgZm91bmQgd2hlbiBtYXJraW5nIHJlY29tbWVuZGF0aW9ucyBzZWVuLCB1c2VySWQ6ICR7dXNlcklkfWAsXG4gICAgICAgICk7XG4gICAgICAgIHRocm93IG5ldyBOb3RGb3VuZEV4Y2VwdGlvbignQ2xpZW50IG5vdCBmb3VuZCcpO1xuICAgICAgfVxuXG4gICAgICB0aGlzLmxvZ2dlci5lcnJvcihcbiAgICAgICAgYEVycm9yIG1hcmtpbmcgdGhlcmFwaXN0IHJlY29tbWVuZGF0aW9ucyBzZWVuIGZvciB1c2VySWQgJHt1c2VySWR9OiAke2Vycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogU3RyaW5nKGVycm9yKX1gLFxuICAgICAgKTtcbiAgICAgIHRocm93IG5ldyBJbnRlcm5hbFNlcnZlckVycm9yRXhjZXB0aW9uKFxuICAgICAgICAnRmFpbGVkIHRvIHVwZGF0ZSB0aGVyYXBpc3QgcmVjb21tZW5kYXRpb24gc3RhdHVzJyxcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgZ2V0QXNzaWduZWRUaGVyYXBpc3QoXG4gICAgdXNlcklkOiBzdHJpbmcsXG4gICk6IFByb21pc2U8VGhlcmFwaXN0UmVjb21tZW5kYXRpb24gfCBudWxsPiB7XG4gICAgY29uc3QgYXNzaWdubWVudCA9IGF3YWl0IHRoaXMucHJpc21hLmNsaWVudFRoZXJhcGlzdC5maW5kRmlyc3Qoe1xuICAgICAgd2hlcmU6IHtcbiAgICAgICAgY2xpZW50SWQ6IHVzZXJJZCxcbiAgICAgICAgc3RhdHVzOiAnYWN0aXZlJyxcbiAgICAgIH0sXG4gICAgICBpbmNsdWRlOiB7XG4gICAgICAgIHRoZXJhcGlzdDoge1xuICAgICAgICAgIGluY2x1ZGU6IHsgdXNlcjogdHJ1ZSB9LFxuICAgICAgICB9LFxuICAgICAgfSxcbiAgICAgIG9yZGVyQnk6IHsgYXNzaWduZWRBdDogJ2Rlc2MnIH0sXG4gICAgfSk7XG5cbiAgICBpZiAoIWFzc2lnbm1lbnQ/LnRoZXJhcGlzdCkge1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuXG4gICAgLy8gVHJhbnNmb3JtIHRoZSBQcmlzbWEgcmVzdWx0IHRvIG1hdGNoIFRoZXJhcGlzdFJlY29tbWVuZGF0aW9uIHR5cGVcbiAgICBjb25zdCB0aGVyYXBpc3QgPSBhc3NpZ25tZW50LnRoZXJhcGlzdDtcbiAgICByZXR1cm4ge1xuICAgICAgaWQ6IHRoZXJhcGlzdC51c2VySWQsXG4gICAgICBmaXJzdE5hbWU6IHRoZXJhcGlzdC51c2VyLmZpcnN0TmFtZSxcbiAgICAgIGxhc3ROYW1lOiB0aGVyYXBpc3QudXNlci5sYXN0TmFtZSxcbiAgICAgIHRpdGxlOiAnVGhlcmFwaXN0JyxcbiAgICAgIHNwZWNpYWx0aWVzOiB0aGVyYXBpc3QuYXJlYXNPZkV4cGVydGlzZSxcbiAgICAgIGhvdXJseVJhdGU6IE51bWJlcih0aGVyYXBpc3QuaG91cmx5UmF0ZSksXG4gICAgICBleHBlcmllbmNlOiB0aGVyYXBpc3QueWVhcnNPZkV4cGVyaWVuY2UgfHwgMCxcbiAgICAgIHByb3ZpbmNlOiB0aGVyYXBpc3QucHJvdmluY2UsXG4gICAgICBpc0FjdGl2ZTogdGhlcmFwaXN0LnN0YXR1cyA9PT0gJ0FQUFJPVkVEJyxcbiAgICAgIGJpbzogdGhlcmFwaXN0LnVzZXIuYmlvIHx8IHVuZGVmaW5lZCxcbiAgICAgIHByb2ZpbGVJbWFnZTogdW5kZWZpbmVkLFxuICAgIH07XG4gIH1cblxuICBhc3luYyBnZXRBc3NpZ25lZFRoZXJhcGlzdHMoXG4gICAgdXNlcklkOiBzdHJpbmcsXG4gICk6IFByb21pc2U8VGhlcmFwaXN0UmVjb21tZW5kYXRpb25bXT4ge1xuICAgIGNvbnN0IGFzc2lnbm1lbnRzID0gYXdhaXQgdGhpcy5wcmlzbWEuY2xpZW50VGhlcmFwaXN0LmZpbmRNYW55KHtcbiAgICAgIHdoZXJlOiB7XG4gICAgICAgIGNsaWVudElkOiB1c2VySWQsXG4gICAgICAgIHN0YXR1czogJ2FjdGl2ZScsXG4gICAgICB9LFxuICAgICAgaW5jbHVkZToge1xuICAgICAgICB0aGVyYXBpc3Q6IHtcbiAgICAgICAgICBpbmNsdWRlOiB7IHVzZXI6IHRydWUgfSxcbiAgICAgICAgfSxcbiAgICAgIH0sXG4gICAgICBvcmRlckJ5OiB7IGFzc2lnbmVkQXQ6ICdkZXNjJyB9LFxuICAgIH0pO1xuXG4gICAgaWYgKCFhc3NpZ25tZW50cyB8fCBhc3NpZ25tZW50cy5sZW5ndGggPT09IDApIHtcbiAgICAgIHJldHVybiBbXTtcbiAgICB9XG5cbiAgICAvLyBUcmFuc2Zvcm0gdGhlIFByaXNtYSByZXN1bHRzIHRvIG1hdGNoIFRoZXJhcGlzdFJlY29tbWVuZGF0aW9uIHR5cGVcbiAgICByZXR1cm4gYXNzaWdubWVudHMubWFwKGFzc2lnbm1lbnQgPT4ge1xuICAgICAgY29uc3QgdGhlcmFwaXN0ID0gYXNzaWdubWVudC50aGVyYXBpc3Q7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBpZDogdGhlcmFwaXN0LnVzZXJJZCxcbiAgICAgICAgZmlyc3ROYW1lOiB0aGVyYXBpc3QudXNlci5maXJzdE5hbWUsXG4gICAgICAgIGxhc3ROYW1lOiB0aGVyYXBpc3QudXNlci5sYXN0TmFtZSxcbiAgICAgICAgdGl0bGU6ICdUaGVyYXBpc3QnLFxuICAgICAgICBzcGVjaWFsdGllczogdGhlcmFwaXN0LmFyZWFzT2ZFeHBlcnRpc2UsXG4gICAgICAgIGhvdXJseVJhdGU6IE51bWJlcih0aGVyYXBpc3QuaG91cmx5UmF0ZSksXG4gICAgICAgIGV4cGVyaWVuY2U6IHRoZXJhcGlzdC55ZWFyc09mRXhwZXJpZW5jZSB8fCAwLFxuICAgICAgICBwcm92aW5jZTogdGhlcmFwaXN0LnByb3ZpbmNlLFxuICAgICAgICBpc0FjdGl2ZTogdGhlcmFwaXN0LnN0YXR1cyA9PT0gJ0FQUFJPVkVEJyxcbiAgICAgICAgYmlvOiB0aGVyYXBpc3QudXNlci5iaW8gfHwgdW5kZWZpbmVkLFxuICAgICAgICBwcm9maWxlSW1hZ2U6IHVuZGVmaW5lZCxcbiAgICAgIH07XG4gICAgfSk7XG4gIH1cblxuICBhc3luYyBhc3NpZ25UaGVyYXBpc3QoXG4gICAgdXNlcklkOiBzdHJpbmcsXG4gICAgdGhlcmFwaXN0SWQ6IHN0cmluZyxcbiAgKTogUHJvbWlzZTxUaGVyYXBpc3RSZWNvbW1lbmRhdGlvbj4ge1xuICAgIC8vIENoZWNrIGlmIGNsaWVudCBleGlzdHNcbiAgICBjb25zdCBjbGllbnQgPSBhd2FpdCB0aGlzLnByaXNtYS5jbGllbnQuZmluZFVuaXF1ZSh7XG4gICAgICB3aGVyZTogeyB1c2VySWQgfSxcbiAgICB9KTtcbiAgICBpZiAoIWNsaWVudCkge1xuICAgICAgdGhyb3cgbmV3IE5vdEZvdW5kRXhjZXB0aW9uKCdDbGllbnQgbm90IGZvdW5kJyk7XG4gICAgfVxuXG4gICAgLy8gQ2hlY2sgaWYgdGhlcmFwaXN0IGV4aXN0c1xuICAgIGNvbnN0IHRoZXJhcGlzdCA9IGF3YWl0IHRoaXMucHJpc21hLnRoZXJhcGlzdC5maW5kVW5pcXVlKHtcbiAgICAgIHdoZXJlOiB7IHVzZXJJZDogdGhlcmFwaXN0SWQgfSxcbiAgICAgIGluY2x1ZGU6IHsgdXNlcjogdHJ1ZSB9LFxuICAgIH0pO1xuICAgIGlmICghdGhlcmFwaXN0KSB7XG4gICAgICB0aHJvdyBuZXcgTm90Rm91bmRFeGNlcHRpb24oJ1RoZXJhcGlzdCBub3QgZm91bmQnKTtcbiAgICB9XG5cbiAgICAvLyBDaGVjayBpZiB0aGlzIGFzc2lnbm1lbnQgYWxyZWFkeSBleGlzdHNcbiAgICBjb25zdCBleGlzdGluZ0Fzc2lnbm1lbnQgPSBhd2FpdCB0aGlzLnByaXNtYS5jbGllbnRUaGVyYXBpc3QuZmluZFVuaXF1ZSh7XG4gICAgICB3aGVyZToge1xuICAgICAgICBjbGllbnRJZF90aGVyYXBpc3RJZDoge1xuICAgICAgICAgIGNsaWVudElkOiB1c2VySWQsXG4gICAgICAgICAgdGhlcmFwaXN0SWQ6IHRoZXJhcGlzdElkLFxuICAgICAgICB9LFxuICAgICAgfSxcbiAgICB9KTtcblxuICAgIC8vIElmIGFzc2lnbm1lbnQgYWxyZWFkeSBleGlzdHMsIHVwZGF0ZSBzdGF0dXMgdG8gYWN0aXZlXG4gICAgaWYgKGV4aXN0aW5nQXNzaWdubWVudCkge1xuICAgICAgYXdhaXQgdGhpcy5wcmlzbWEuY2xpZW50VGhlcmFwaXN0LnVwZGF0ZSh7XG4gICAgICAgIHdoZXJlOiB7IGlkOiBleGlzdGluZ0Fzc2lnbm1lbnQuaWQgfSxcbiAgICAgICAgZGF0YTogeyBzdGF0dXM6ICdhY3RpdmUnIH0sXG4gICAgICB9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgLy8gQ3JlYXRlIG5ldyBhc3NpZ25tZW50XG4gICAgICBhd2FpdCB0aGlzLnByaXNtYS5jbGllbnRUaGVyYXBpc3QuY3JlYXRlKHtcbiAgICAgICAgZGF0YToge1xuICAgICAgICAgIGNsaWVudElkOiB1c2VySWQsXG4gICAgICAgICAgdGhlcmFwaXN0SWQ6IHRoZXJhcGlzdElkLFxuICAgICAgICAgIHN0YXR1czogJ2FjdGl2ZScsXG4gICAgICAgIH0sXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICAvLyBBdXRvbWF0aWNhbGx5IGNyZWF0ZSBjb252ZXJzYXRpb24gYmV0d2VlbiBjbGllbnQgYW5kIHRoZXJhcGlzdFxuICAgIHRyeSB7XG4gICAgICBhd2FpdCB0aGlzLm1lc3NhZ2luZ1NlcnZpY2UuY3JlYXRlQ29udmVyc2F0aW9uKHVzZXJJZCwge1xuICAgICAgICBwYXJ0aWNpcGFudElkczogW3RoZXJhcGlzdElkXSxcbiAgICAgICAgdHlwZTogJ2RpcmVjdCcsXG4gICAgICAgIHRpdGxlOiBgVGhlcmFweSBTZXNzaW9uIHdpdGggJHt0aGVyYXBpc3QudXNlci5maXJzdE5hbWV9ICR7dGhlcmFwaXN0LnVzZXIubGFzdE5hbWV9YCxcbiAgICAgIH0pO1xuICAgICAgdGhpcy5sb2dnZXIubG9nKGBBdXRvLWNyZWF0ZWQgY29udmVyc2F0aW9uIGJldHdlZW4gY2xpZW50ICR7dXNlcklkfSBhbmQgdGhlcmFwaXN0ICR7dGhlcmFwaXN0SWR9YCk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIC8vIExvZyBlcnJvciBidXQgZG9uJ3QgZmFpbCB0aGUgYXNzaWdubWVudCBpZiBjb252ZXJzYXRpb24gY3JlYXRpb24gZmFpbHNcbiAgICAgIHRoaXMubG9nZ2VyLndhcm4oYEZhaWxlZCB0byBhdXRvLWNyZWF0ZSBjb252ZXJzYXRpb24gYmV0d2VlbiBjbGllbnQgJHt1c2VySWR9IGFuZCB0aGVyYXBpc3QgJHt0aGVyYXBpc3RJZH06ICR7ZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiBTdHJpbmcoZXJyb3IpfWApO1xuICAgIH1cblxuICAgIC8vIFRyYW5zZm9ybSB0aGUgUHJpc21hIHJlc3VsdCB0byBtYXRjaCBUaGVyYXBpc3RSZWNvbW1lbmRhdGlvbiB0eXBlXG4gICAgcmV0dXJuIHtcbiAgICAgIGlkOiB0aGVyYXBpc3QudXNlcklkLFxuICAgICAgZmlyc3ROYW1lOiB0aGVyYXBpc3QudXNlci5maXJzdE5hbWUsXG4gICAgICBsYXN0TmFtZTogdGhlcmFwaXN0LnVzZXIubGFzdE5hbWUsXG4gICAgICB0aXRsZTogJ1RoZXJhcGlzdCcsXG4gICAgICBzcGVjaWFsdGllczogdGhlcmFwaXN0LmFyZWFzT2ZFeHBlcnRpc2UsXG4gICAgICBob3VybHlSYXRlOiBOdW1iZXIodGhlcmFwaXN0LmhvdXJseVJhdGUpLFxuICAgICAgZXhwZXJpZW5jZTogdGhlcmFwaXN0LnllYXJzT2ZFeHBlcmllbmNlIHx8IDAsXG4gICAgICBwcm92aW5jZTogdGhlcmFwaXN0LnByb3ZpbmNlLFxuICAgICAgaXNBY3RpdmU6IHRoZXJhcGlzdC5zdGF0dXMgPT09ICdBUFBST1ZFRCcsXG4gICAgICBiaW86IHRoZXJhcGlzdC51c2VyLmJpbyB8fCB1bmRlZmluZWQsXG4gICAgICBwcm9maWxlSW1hZ2U6IHVuZGVmaW5lZCxcbiAgICB9O1xuICB9XG5cbiAgYXN5bmMgcmVtb3ZlVGhlcmFwaXN0KHVzZXJJZDogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgLy8gQ2hlY2sgaWYgY2xpZW50IGV4aXN0c1xuICAgIGNvbnN0IGNsaWVudCA9IGF3YWl0IHRoaXMucHJpc21hLmNsaWVudC5maW5kVW5pcXVlKHtcbiAgICAgIHdoZXJlOiB7IHVzZXJJZCB9LFxuICAgIH0pO1xuICAgIGlmICghY2xpZW50KSB7XG4gICAgICB0aHJvdyBuZXcgTm90Rm91bmRFeGNlcHRpb24oJ0NsaWVudCBub3QgZm91bmQnKTtcbiAgICB9XG5cbiAgICAvLyBTZXQgYWxsIGV4aXN0aW5nIGFzc2lnbm1lbnRzIHRvIGluYWN0aXZlIGluc3RlYWQgb2YgZGVsZXRpbmdcbiAgICBhd2FpdCB0aGlzLnByaXNtYS5jbGllbnRUaGVyYXBpc3QudXBkYXRlTWFueSh7XG4gICAgICB3aGVyZToge1xuICAgICAgICBjbGllbnRJZDogdXNlcklkLFxuICAgICAgICBzdGF0dXM6ICdhY3RpdmUnLFxuICAgICAgfSxcbiAgICAgIGRhdGE6IHtcbiAgICAgICAgc3RhdHVzOiAnaW5hY3RpdmUnLFxuICAgICAgfSxcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgdHJhbnNmb3JtUHJpc21hVXNlclRvRFRPKHVzZXI6IGFueSk6IENsaWVudFByb2ZpbGVEdG8ge1xuICAgIHJldHVybiB7XG4gICAgICBpZDogdXNlci5pZCxcbiAgICAgIGVtYWlsOiB1c2VyLmVtYWlsLFxuICAgICAgcm9sZTogdXNlci5yb2xlIGFzICdjbGllbnQnIHwgJ3RoZXJhcGlzdCcgfCAnYWRtaW4nIHwgJ21vZGVyYXRvcicsXG4gICAgICBjcmVhdGVkQXQ6IHVzZXIuY3JlYXRlZEF0LnRvSVNPU3RyaW5nKCksXG4gICAgICB1cGRhdGVkQXQ6IHVzZXIudXBkYXRlZEF0LnRvSVNPU3RyaW5nKCksXG4gICAgICBmaXJzdE5hbWU6IHVzZXIuZmlyc3ROYW1lLFxuICAgICAgbGFzdE5hbWU6IHVzZXIubGFzdE5hbWUsXG4gICAgfTtcbiAgfVxufVxuIl0sInZlcnNpb24iOjN9