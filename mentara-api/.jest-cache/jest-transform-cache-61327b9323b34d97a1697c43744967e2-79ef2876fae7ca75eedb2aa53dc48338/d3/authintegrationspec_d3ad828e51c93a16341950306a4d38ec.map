{"file":"/home/wetooa/Documents/code/projects/mentara/mentara-api/src/test-utils/integration-tests/auth.integration.spec.ts","mappings":"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","names":[],"sources":["/home/wetooa/Documents/code/projects/mentara/mentara-api/src/test-utils/integration-tests/auth.integration.spec.ts"],"sourcesContent":["import { Test, TestingModule } from '@nestjs/testing';\nimport { INestApplication } from '@nestjs/common';\nimport * as request from 'supertest';\nimport { PrismaService } from '../../providers/prisma-client.provider';\nimport { AuthModule } from '../../auth/auth.module';\nimport { DatabaseTestSetup } from '../database-test.setup';\n\ndescribe('Auth Integration Tests', () => {\n  let app: INestApplication;\n  let prisma: PrismaService;\n  let moduleRef: TestingModule;\n\n  beforeAll(async () => {\n    // Setup test database\n    prisma = await DatabaseTestSetup.setupTestDatabase();\n\n    moduleRef = await Test.createTestingModule({\n      imports: [AuthModule],\n      providers: [\n        {\n          provide: PrismaService,\n          useValue: prisma,\n        },\n      ],\n    }).compile();\n\n    app = moduleRef.createNestApplication();\n    await app.init();\n  });\n\n  afterEach(async () => {\n    // Clean database after each test\n    await DatabaseTestSetup.cleanupDatabase();\n  });\n\n  afterAll(async () => {\n    await DatabaseTestSetup.stopContainer();\n    await app.close();\n    await moduleRef.close();\n  });\n\n  describe('POST /auth/register/client', () => {\n    it('should create a new client successfully', async () => {\n      const clientData = {\n        user: {\n          firstName: 'John',\n          lastName: 'Doe',\n          email: 'john.doe@example.com',\n          mobile: '+1234567890',\n          address: '123 Main St',\n          birthDate: '1990-01-01',\n        },\n        hasSeenTherapistRecommendations: false,\n      };\n\n      const response = await request(app.getHttpServer())\n        .post('/auth/register/client')\n        .send(clientData)\n        .expect(201);\n\n      expect(response.body).toMatchObject({\n        success: true,\n        data: expect.objectContaining({\n          id: expect.any(String),\n          user: expect.objectContaining({\n            firstName: 'John',\n            lastName: 'Doe',\n            email: 'john.doe@example.com',\n          }),\n        }),\n      });\n\n      // Verify in database\n      const user = await prisma.user.findUnique({\n        where: { email: 'john.doe@example.com' },\n        include: { client: true },\n      });\n\n      expect(user).toBeTruthy();\n      expect(user?.client).toBeTruthy();\n      expect(user?.role).toBe('client');\n    });\n\n    it('should reject duplicate email registration', async () => {\n      // First registration\n      await prisma.user.create({\n        data: {\n          id: 'existing-user',\n          email: 'existing@example.com',\n          firstName: 'Existing',\n          lastName: 'User',\n          role: 'client',\n        },\n      });\n\n      const clientData = {\n        user: {\n          firstName: 'New',\n          lastName: 'User',\n          email: 'existing@example.com',\n          mobile: '+1234567890',\n        },\n        hasSeenTherapistRecommendations: false,\n      };\n\n      await request(app.getHttpServer())\n        .post('/auth/register/client')\n        .send(clientData)\n        .expect(409);\n    });\n\n    it('should validate required fields', async () => {\n      const invalidData = {\n        user: {\n          firstName: 'John',\n          // Missing required fields\n        },\n        hasSeenTherapistRecommendations: false,\n      };\n\n      await request(app.getHttpServer())\n        .post('/auth/register/client')\n        .send(invalidData)\n        .expect(400);\n    });\n  });\n\n  describe('POST /auth/register/therapist', () => {\n    it('should create a new therapist application', async () => {\n      const therapistData = {\n        userId: 'therapist-123',\n        email: 'therapist@example.com',\n        firstName: 'Jane',\n        lastName: 'Smith',\n        mobile: '+1234567890',\n        province: 'Ontario',\n        providerType: 'Clinical Psychologist',\n        professionalLicenseType: 'Licensed',\n        isPRCLicensed: 'yes',\n        prcLicenseNumber: 'PRC123456',\n        isLicenseActive: 'yes',\n        practiceStartDate: '2020-01-01',\n        yearsOfExperience: 5,\n        areasOfExpertise: ['Anxiety', 'Depression'],\n        assessmentTools: ['PHQ-9', 'GAD-7'],\n        therapeuticApproachesUsedList: ['CBT', 'DBT'],\n        languagesOffered: ['English', 'French'],\n        providedOnlineTherapyBefore: 'yes',\n        comfortableUsingVideoConferencing: 'yes',\n        weeklyAvailability: '20',\n        preferredSessionLength: '60',\n        accepts: ['Individual', 'Couples'],\n        hourlyRate: 150,\n        bio: 'Experienced therapist.',\n      };\n\n      const response = await request(app.getHttpServer())\n        .post('/auth/register/therapist')\n        .send(therapistData)\n        .expect(201);\n\n      expect(response.body).toMatchObject({\n        success: true,\n        data: expect.objectContaining({\n          id: expect.any(String),\n          applicationStatus: 'PENDING',\n          email: 'therapist@example.com',\n        }),\n      });\n\n      // Verify in database\n      const therapist = await prisma.therapist.findUnique({\n        where: { userId: response.body.data.id },\n      });\n\n      expect(therapist).toBeTruthy();\n      expect(therapist?.status).toBe('PENDING');\n    });\n\n    it('should validate professional license requirements', async () => {\n      const invalidTherapistData = {\n        userId: 'therapist-123',\n        email: 'therapist@example.com',\n        firstName: 'Jane',\n        lastName: 'Smith',\n        // Missing professional license info\n      };\n\n      await request(app.getHttpServer())\n        .post('/auth/register/therapist')\n        .send(invalidTherapistData)\n        .expect(400);\n    });\n  });\n\n  describe('Database Transactions', () => {\n    it('should rollback on client registration failure', async () => {\n      // Mock a scenario where user creation succeeds but client creation fails\n      const clientData = {\n        user: {\n          firstName: 'Test',\n          lastName: 'User',\n          email: 'test@example.com',\n          mobile: '+1234567890',\n        },\n        hasSeenTherapistRecommendations: false,\n      };\n\n      // Attempt registration with invalid data that would cause a rollback\n      try {\n        await request(app.getHttpServer())\n          .post('/auth/register/client')\n          .send(clientData);\n      } catch {\n        // Expected to fail\n      }\n\n      // Verify no orphaned user record exists\n      const user = await prisma.user.findUnique({\n        where: { email: 'test@example.com' },\n      });\n\n      // Should be null if transaction was properly rolled back\n      expect(user).toBeNull();\n    });\n  });\n\n  describe('Data Integrity', () => {\n    it('should maintain referential integrity', async () => {\n      // Create a user and client\n      const user = await prisma.user.create({\n        data: {\n          id: 'test-user-123',\n          email: 'integrity@example.com',\n          firstName: 'Test',\n          lastName: 'User',\n          role: 'client',\n        },\n      });\n\n      const client = await prisma.client.create({\n        data: {\n          userId: user.id,\n          hasSeenTherapistRecommendations: false,\n        },\n      });\n\n      // Verify relationships\n      const userWithClient = await prisma.user.findUnique({\n        where: { id: user.id },\n        include: { client: true },\n      });\n\n      expect(userWithClient?.client?.userId).toBe(client.userId);\n      expect(userWithClient?.client?.userId).toBe(user.id);\n    });\n\n    it('should enforce unique constraints', async () => {\n      // Create first user\n      await prisma.user.create({\n        data: {\n          id: 'user-1',\n          email: 'unique@example.com',\n          firstName: 'First',\n          lastName: 'User',\n          role: 'client',\n        },\n      });\n\n      // Try to create second user with same email - should fail\n      await expect(\n        prisma.user.create({\n          data: {\n            id: 'user-2',\n            email: 'unique@example.com',\n            firstName: 'Second',\n            lastName: 'User',\n            role: 'client',\n          },\n        }),\n      ).rejects.toThrow();\n    });\n  });\n\n  describe('Complex Queries', () => {\n    beforeEach(async () => {\n      // Setup test data\n      await prisma.user.createMany({\n        data: [\n          {\n            id: 'client-1',\n            email: 'client1@example.com',\n            firstName: 'Client',\n            lastName: 'One',\n            role: 'client',\n          },\n          {\n            id: 'therapist-1',\n            firstName: 'Therapist',\n            lastName: 'One',\n            email: 'therapist1@example.com',\n            role: 'therapist',\n          },\n        ],\n      });\n\n      await prisma.client.create({\n        data: {\n          userId: 'client-1',\n          hasSeenTherapistRecommendations: false,\n        },\n      });\n\n      await prisma.therapist.create({\n        data: {\n          userId: 'therapist-1',\n          mobile: '+1234567890',\n          province: 'Ontario',\n          providerType: 'Clinical Psychologist',\n          professionalLicenseType: 'Licensed',\n          isPRCLicensed: 'yes',\n          prcLicenseNumber: 'PRC123456',\n          practiceStartDate: new Date('2020-01-01'),\n          yearsOfExperience: 5,\n          areasOfExpertise: ['Anxiety'],\n          assessmentTools: ['PHQ-9'],\n          therapeuticApproachesUsedList: ['CBT'],\n          languagesOffered: ['English'],\n          providedOnlineTherapyBefore: true,\n          comfortableUsingVideoConferencing: true,\n          preferredSessionLength: [60],\n          acceptTypes: ['Individual'],\n          status: 'approved',\n          hourlyRate: 150,\n          expirationDateOfLicense: new Date('2025-01-01'),\n          compliesWithDataPrivacyAct: true,\n          willingToAbideByPlatformGuidelines: true,\n          treatmentSuccessRates: {},\n          sessionLength: '60 minutes',\n        },\n      });\n    });\n\n    it('should perform complex joins correctly', async () => {\n      const result = await prisma.user.findMany({\n        where: { role: 'therapist' },\n        include: {\n          therapist: {\n            select: {\n              status: true,\n              hourlyRate: true,\n              areasOfExpertise: true,\n            },\n          },\n        },\n      });\n\n      expect(result).toHaveLength(1);\n      expect(result[0].therapist?.status).toBe('APPROVED');\n      expect(Number(result[0].therapist?.hourlyRate)).toBeCloseTo(150);\n    });\n\n    it('should handle aggregation queries', async () => {\n      const stats = await prisma.user.groupBy({\n        by: ['role'],\n        _count: { id: true },\n      });\n\n      expect(stats).toEqual(\n        expect.arrayContaining([\n          expect.objectContaining({\n            role: 'client',\n            _count: { id: 1 },\n          }),\n          expect.objectContaining({\n            role: 'therapist',\n            _count: { id: 1 },\n          }),\n        ]),\n      );\n    });\n  });\n});\n"],"version":3}