2dced61a742f35ea7a74f1425bc3926f
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
exports.SlotGeneratorService = void 0;
const common_1 = require("@nestjs/common");
const prisma_client_provider_1 = require("../../providers/prisma-client.provider");
let SlotGeneratorService = class SlotGeneratorService {
    prisma;
    defaultConfig = {
        slotInterval: 30,
        maxAdvanceBooking: 90,
        minAdvanceBooking: 0.5,
    };
    // Asia/Manila timezone offset (UTC+8)
    MANILA_TIMEZONE_OFFSET = 8 * 60 * 60 * 1000;
    constructor(prisma) {
        this.prisma = prisma;
    }
    /**
     * Convert UTC date to Asia/Manila timezone
     */
    convertToManilaTime(utcDate) {
        return new Date(utcDate.getTime() + this.MANILA_TIMEZONE_OFFSET);
    }
    /**
     * Convert Asia/Manila date to UTC timezone
     */
    convertFromManilaTime(manilaDate) {
        return new Date(manilaDate.getTime() - this.MANILA_TIMEZONE_OFFSET);
    }
    /**
     * Get current time in Asia/Manila timezone
     */
    getCurrentManilaTime() {
        return this.convertToManilaTime(new Date());
    }
    getDurations() {
        return [
            { id: '30', name: '30 minutes', duration: 30 },
            { id: '60', name: '60 minutes', duration: 60 },
            { id: '90', name: '90 minutes', duration: 90 },
            { id: '120', name: '120 minutes', duration: 120 },
        ];
    }
    /**
     * Generate available time slots for a therapist on a specific date
     */
    async generateAvailableSlots(therapistId, date, config = {}) {
        const finalConfig = { ...this.defaultConfig, ...config };
        const targetDate = new Date(date);
        const dayOfWeek = targetDate.getDay();
        // Validate date is within booking window
        this.validateBookingDate(targetDate, finalConfig);
        // Get therapist availability for this day
        const availability = await this.getTherapistAvailability(therapistId, dayOfWeek);
        if (availability.length === 0) {
            return [];
        }
        // Get existing bookings for this date
        const existingBookings = await this.getExistingBookings(therapistId, targetDate);
        // Generate slots for each availability window
        const allSlots = [];
        for (const avail of availability) {
            const slots = this.generateSlotsForAvailabilityWindow(targetDate, avail, existingBookings, finalConfig);
            allSlots.push(...slots);
        }
        return allSlots.sort((a, b) => new Date(a.startTime).getTime() - new Date(b.startTime).getTime());
    }
    validateBookingDate(date, config) {
        const nowInManila = this.getCurrentManilaTime();
        // Calculate min and max dates using Manila time
        const maxDate = new Date(nowInManila.getTime() + config.maxAdvanceBooking * 24 * 60 * 60 * 1000);
        const minDate = new Date(nowInManila.getTime() + config.minAdvanceBooking * 60 * 60 * 1000);
        // Convert the target date to Manila time for comparison
        const targetDateInManila = this.convertToManilaTime(date);
        if (targetDateInManila < minDate) {
            throw new common_1.BadRequestException(`Bookings must be made at least ${config.minAdvanceBooking} hours in advance (Asia/Manila timezone)`);
        }
        if (targetDateInManila > maxDate) {
            throw new common_1.BadRequestException(`Bookings can only be made up to ${config.maxAdvanceBooking} days in advance (Asia/Manila timezone)`);
        }
    }
    async getTherapistAvailability(therapistId, dayOfWeek) {
        return this.prisma.therapistAvailability.findMany({
            where: {
                therapistId,
                dayOfWeek: dayOfWeek.toString(),
                isAvailable: true,
            },
            orderBy: { startTime: 'asc' },
        });
    }
    async getExistingBookings(therapistId, date) {
        const startOfDay = new Date(date);
        startOfDay.setHours(0, 0, 0, 0);
        const endOfDay = new Date(date);
        endOfDay.setHours(23, 59, 59, 999);
        return this.prisma.meeting.findMany({
            where: {
                therapistId,
                startTime: { gte: startOfDay, lte: endOfDay },
                status: { in: ['SCHEDULED', 'CONFIRMED'] },
            },
            orderBy: { startTime: 'asc' },
        });
    }
    generateSlotsForAvailabilityWindow(date, availability, existingBookings, config) {
        const slots = [];
        const durations = this.getDurations();
        const startTime = this.createDateTime(date, availability.startTime);
        const endTime = this.createDateTime(date, availability.endTime);
        let currentTime = new Date(startTime);
        while (currentTime < endTime) {
            const slotEnd = new Date(currentTime.getTime() + config.slotInterval * 60000);
            if (slotEnd <= endTime) {
                // Check if this slot conflicts with existing bookings
                if (!this.hasConflictWithBookings(currentTime, slotEnd, existingBookings)) {
                    // Find which durations fit in this slot
                    const availableDurations = this.getAvailableDurations(currentTime, endTime, existingBookings, durations);
                    if (availableDurations.length > 0) {
                        slots.push({
                            startTime: currentTime.toISOString(),
                            availableDurations,
                        });
                    }
                }
            }
            currentTime = new Date(currentTime.getTime() + config.slotInterval * 60000);
        }
        return slots;
    }
    createDateTime(date, timeString) {
        const [hours, minutes] = timeString.split(':').map(Number);
        const dateTime = new Date(date);
        dateTime.setHours(hours, minutes, 0, 0);
        return dateTime;
    }
    hasConflictWithBookings(slotStart, slotEnd, bookings) {
        return bookings.some((booking) => {
            const bookingEnd = new Date(booking.startTime.getTime() + booking.duration * 60000);
            return this.hasTimeOverlap(slotStart, slotEnd, booking.startTime, bookingEnd);
        });
    }
    getAvailableDurations(slotStart, availabilityEnd, existingBookings, durations) {
        return durations.filter((duration) => {
            const durationEnd = new Date(slotStart.getTime() + duration.duration * 60000);
            // Check if duration fits within availability window
            if (durationEnd > availabilityEnd) {
                return false;
            }
            // Check if duration conflicts with existing bookings
            return !this.hasConflictWithBookings(slotStart, durationEnd, existingBookings);
        });
    }
    hasTimeOverlap(start1, end1, start2, end2) {
        return start1 < end2 && end1 > start2;
    }
    /**
     * Check if a specific time slot is available
     */
    async isSlotAvailable(therapistId, startTime, duration) {
        const endTime = new Date(startTime.getTime() + duration * 60000);
        const dayOfWeek = startTime.getDay();
        // Check therapist availability
        const availability = await this.prisma.therapistAvailability.findFirst({
            where: {
                therapistId,
                dayOfWeek: dayOfWeek.toString(),
                isAvailable: true,
            },
        });
        if (!availability) {
            return false;
        }
        // Check if time fits within availability window
        const availStart = this.createDateTime(startTime, availability.startTime);
        const availEnd = this.createDateTime(startTime, availability.endTime);
        if (startTime < availStart || endTime > availEnd) {
            return false;
        }
        // Check for conflicts with existing bookings
        const existingBookings = await this.getExistingBookings(therapistId, startTime);
        return !this.hasConflictWithBookings(startTime, endTime, existingBookings);
    }
};
exports.SlotGeneratorService = SlotGeneratorService;
exports.SlotGeneratorService = SlotGeneratorService = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [typeof (_a = typeof prisma_client_provider_1.PrismaService !== "undefined" && prisma_client_provider_1.PrismaService) === "function" ? _a : Object])
], SlotGeneratorService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL2Jvb2tpbmcvc2VydmljZXMvc2xvdC1nZW5lcmF0b3Iuc2VydmljZS50cyIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7O0FBQUEsMkNBQWlFO0FBQ2pFLG1GQUF1RTtBQWtCaEUsSUFBTSxvQkFBb0IsR0FBMUIsTUFBTSxvQkFBb0I7SUFVRjtJQVRaLGFBQWEsR0FBeUI7UUFDckQsWUFBWSxFQUFFLEVBQUU7UUFDaEIsaUJBQWlCLEVBQUUsRUFBRTtRQUNyQixpQkFBaUIsRUFBRSxHQUFHO0tBQ3ZCLENBQUM7SUFFRixzQ0FBc0M7SUFDckIsc0JBQXNCLEdBQUcsQ0FBQyxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsSUFBSSxDQUFDO0lBRTdELFlBQTZCLE1BQXFCO1FBQXJCLFdBQU0sR0FBTixNQUFNLENBQWU7SUFBRyxDQUFDO0lBRXREOztPQUVHO0lBQ0ssbUJBQW1CLENBQUMsT0FBYTtRQUN2QyxPQUFPLElBQUksSUFBSSxDQUFDLE9BQU8sQ0FBQyxPQUFPLEVBQUUsR0FBRyxJQUFJLENBQUMsc0JBQXNCLENBQUMsQ0FBQztJQUNuRSxDQUFDO0lBRUQ7O09BRUc7SUFDSyxxQkFBcUIsQ0FBQyxVQUFnQjtRQUM1QyxPQUFPLElBQUksSUFBSSxDQUFDLFVBQVUsQ0FBQyxPQUFPLEVBQUUsR0FBRyxJQUFJLENBQUMsc0JBQXNCLENBQUMsQ0FBQztJQUN0RSxDQUFDO0lBRUQ7O09BRUc7SUFDSyxvQkFBb0I7UUFDMUIsT0FBTyxJQUFJLENBQUMsbUJBQW1CLENBQUMsSUFBSSxJQUFJLEVBQUUsQ0FBQyxDQUFDO0lBQzlDLENBQUM7SUFFTyxZQUFZO1FBQ2xCLE9BQU87WUFDTCxFQUFFLEVBQUUsRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLFlBQVksRUFBRSxRQUFRLEVBQUUsRUFBRSxFQUFFO1lBQzlDLEVBQUUsRUFBRSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsWUFBWSxF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RSxJQUFJLFNBQVMsR0FBRyxVQUFVLElBQUksT0FBTyxHQUFHLFFBQVEsRUFBRSxDQUFDO1lBQ2pELE9BQU8sS0FBSyxDQUFDO1FBQ2YsQ0FBQztRQUVELDZDQUE2QztRQUM3QyxNQUFNLGdCQUFnQixHQUFHLE1BQU0sSUFBSSxDQUFDLG1CQUFtQixDQUNyRCxXQUFXLEVBQ1gsU0FBUyxDQUNWLENBQUM7UUFFRixPQUFPLENBQUMsSUFBSSxDQUFDLHVCQUF1QixDQUFDLFNBQVMsRUFBRSxPQUFPLEVBQUUsZ0JBQWdCLENBQUMsQ0FBQztJQUM3RSxDQUFDO0NBQ0YsQ0FBQTtBQXZTWSxvREFBb0I7K0JBQXBCLG9CQUFvQjtJQURoQyxJQUFBLG1CQUFVLEdBQUU7eURBVzBCLHNDQUFhLG9CQUFiLHNDQUFhO0dBVnZDLG9CQUFvQixDQXVTaEMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL2Jvb2tpbmcvc2VydmljZXMvc2xvdC1nZW5lcmF0b3Iuc2VydmljZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlLCBCYWRSZXF1ZXN0RXhjZXB0aW9uIH0gZnJvbSAnQG5lc3Rqcy9jb21tb24nO1xuaW1wb3J0IHsgUHJpc21hU2VydmljZSB9IGZyb20gJy4uLy4uL3Byb3ZpZGVycy9wcmlzbWEtY2xpZW50LnByb3ZpZGVyJztcblxuZXhwb3J0IGludGVyZmFjZSBUaW1lU2xvdCB7XG4gIHN0YXJ0VGltZTogc3RyaW5nO1xuICBhdmFpbGFibGVEdXJhdGlvbnM6IHtcbiAgICBpZDogc3RyaW5nO1xuICAgIG5hbWU6IHN0cmluZztcbiAgICBkdXJhdGlvbjogbnVtYmVyO1xuICB9W107XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgU2xvdEdlbmVyYXRpb25Db25maWcge1xuICBzbG90SW50ZXJ2YWw6IG51bWJlcjsgLy8gbWludXRlc1xuICBtYXhBZHZhbmNlQm9va2luZzogbnVtYmVyOyAvLyBkYXlzXG4gIG1pbkFkdmFuY2VCb29raW5nOiBudW1iZXI7IC8vIGhvdXJzXG59XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBTbG90R2VuZXJhdG9yU2VydmljZSB7XG4gIHByaXZhdGUgcmVhZG9ubHkgZGVmYXVsdENvbmZpZzogU2xvdEdlbmVyYXRpb25Db25maWcgPSB7XG4gICAgc2xvdEludGVydmFsOiAzMCxcbiAgICBtYXhBZHZhbmNlQm9va2luZzogOTAsXG4gICAgbWluQWR2YW5jZUJvb2tpbmc6IDAuNSxcbiAgfTtcblxuICAvLyBBc2lhL01hbmlsYSB0aW1lem9uZSBvZmZzZXQgKFVUQys4KVxuICBwcml2YXRlIHJlYWRvbmx5IE1BTklMQV9USU1FWk9ORV9PRkZTRVQgPSA4ICogNjAgKiA2MCAqIDEwMDA7XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSByZWFkb25seSBwcmlzbWE6IFByaXNtYVNlcnZpY2UpIHt9XG5cbiAgLyoqXG4gICAqIENvbnZlcnQgVVRDIGRhdGUgdG8gQXNpYS9NYW5pbGEgdGltZXpvbmVcbiAgICovXG4gIHByaXZhdGUgY29udmVydFRvTWFuaWxhVGltZSh1dGNEYXRlOiBEYXRlKTogRGF0ZSB7XG4gICAgcmV0dXJuIG5ldyBEYXRlKHV0Y0RhdGUuZ2V0VGltZSgpICsgdGhpcy5NQU5JTEFfVElNRVpPTkVfT0ZGU0VUKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDb252ZXJ0IEFzaWEvTWFuaWxhIGRhdGUgdG8gVVRDIHRpbWV6b25lXG4gICAqL1xuICBwcml2YXRlIGNvbnZlcnRGcm9tTWFuaWxhVGltZShtYW5pbGFEYXRlOiBEYXRlKTogRGF0ZSB7XG4gICAgcmV0dXJuIG5ldyBEYXRlKG1hbmlsYURhdGUuZ2V0VGltZSgpIC0gdGhpcy5NQU5JTEFfVElNRVpPTkVfT0ZGU0VUKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgY3VycmVudCB0aW1lIGluIEFzaWEvTWFuaWxhIHRpbWV6b25lXG4gICAqL1xuICBwcml2YXRlIGdldEN1cnJlbnRNYW5pbGFUaW1lKCk6IERhdGUge1xuICAgIHJldHVybiB0aGlzLmNvbnZlcnRUb01hbmlsYVRpbWUobmV3IERhdGUoKSk7XG4gIH1cblxuICBwcml2YXRlIGdldER1cmF0aW9ucygpIHtcbiAgICByZXR1cm4gW1xuICAgICAgeyBpZDogJzMwJywgbmFtZTogJzMwIG1pbnV0ZXMnLCBkdXJhdGlvbjogMzAgfSxcbiAgICAgIHsgaWQ6ICc2MCcsIG5hbWU6ICc2MCBtaW51dGVzJywgZHVyYXRpb246IDYwIH0sXG4gICAgICB7IGlkOiAnOTAnLCBuYW1lOiAnOTAgbWludXRlcycsIGR1cmF0aW9uOiA5MCB9LFxuICAgICAgeyBpZDogJzEyMCcsIG5hbWU6ICcxMjAgbWludXRlcycsIGR1cmF0aW9uOiAxMjAgfSxcbiAgICBdO1xuICB9XG5cbiAgLyoqXG4gICAqIEdlbmVyYXRlIGF2YWlsYWJsZSB0aW1lIHNsb3RzIGZvciBhIHRoZXJhcGlzdCBvbiBhIHNwZWNpZmljIGRhdGVcbiAgICovXG4gIGFzeW5jIGdlbmVyYXRlQXZhaWxhYmxlU2xvdHMoXG4gICAgdGhlcmFwaXN0SWQ6IHN0cmluZyxcbiAgICBkYXRlOiBzdHJpbmcsXG4gICAgY29uZmlnOiBQYXJ0aWFsPFNsb3RHZW5lcmF0aW9uQ29uZmlnPiA9IHt9LFxuICApOiBQcm9taXNlPFRpbWVTbG90W10+IHtcbiAgICBjb25zdCBmaW5hbENvbmZpZyA9IHsgLi4udGhpcy5kZWZhdWx0Q29uZmlnLCAuLi5jb25maWcgfTtcbiAgICBjb25zdCB0YXJnZXREYXRlID0gbmV3IERhdGUoZGF0ZSk7XG4gICAgY29uc3QgZGF5T2ZXZWVrID0gdGFyZ2V0RGF0ZS5nZXREYXkoKTtcblxuICAgIC8vIFZhbGlkYXRlIGRhdGUgaXMgd2l0aGluIGJvb2tpbmcgd2luZG93XG4gICAgdGhpcy52YWxpZGF0ZUJvb2tpbmdEYXRlKHRhcmdldERhdGUsIGZpbmFsQ29uZmlnKTtcblxuICAgIC8vIEdldCB0aGVyYXBpc3QgYXZhaWxhYmlsaXR5IGZvciB0aGlzIGRheVxuICAgIGNvbnN0IGF2YWlsYWJpbGl0eSA9IGF3YWl0IHRoaXMuZ2V0VGhlcmFwaXN0QXZhaWxhYmlsaXR5KFxuICAgICAgdGhlcmFwaXN0SWQsXG4gICAgICBkYXlPZldlZWssXG4gICAgKTtcbiAgICBpZiAoYXZhaWxhYmlsaXR5Lmxlbmd0aCA9PT0gMCkge1xuICAgICAgcmV0dXJuIFtdO1xuICAgIH1cblxuICAgIC8vIEdldCBleGlzdGluZyBib29raW5ncyBmb3IgdGhpcyBkYXRlXG4gICAgY29uc3QgZXhpc3RpbmdCb29raW5ncyA9IGF3YWl0IHRoaXMuZ2V0RXhpc3RpbmdCb29raW5ncyhcbiAgICAgIHRoZXJhcGlzdElkLFxuICAgICAgdGFyZ2V0RGF0ZSxcbiAgICApO1xuXG4gICAgLy8gR2VuZXJhdGUgc2xvdHMgZm9yIGVhY2ggYXZhaWxhYmlsaXR5IHdpbmRvd1xuICAgIGNvbnN0IGFsbFNsb3RzOiBUaW1lU2xvdFtdID0gW107XG4gICAgZm9yIChjb25zdCBhdmFpbCBvZiBhdmFpbGFiaWxpdHkpIHtcbiAgICAgIGNvbnN0IHNsb3RzID0gdGhpcy5nZW5lcmF0ZVNsb3RzRm9yQXZhaWxhYmlsaXR5V2luZG93KFxuICAgICAgICB0YXJnZXREYXRlLFxuICAgICAgICBhdmFpbCxcbiAgICAgICAgZXhpc3RpbmdCb29raW5ncyxcbiAgICAgICAgZmluYWxDb25maWcsXG4gICAgICApO1xuICAgICAgYWxsU2xvdHMucHVzaCguLi5zbG90cyk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGFsbFNsb3RzLnNvcnQoXG4gICAgICAoYSwgYikgPT5cbiAgICAgICAgbmV3IERhdGUoYS5zdGFydFRpbWUpLmdldFRpbWUoKSAtIG5ldyBEYXRlKGIuc3RhcnRUaW1lKS5nZXRUaW1lKCksXG4gICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgdmFsaWRhdGVCb29raW5nRGF0ZShkYXRlOiBEYXRlLCBjb25maWc6IFNsb3RHZW5lcmF0aW9uQ29uZmlnKTogdm9pZCB7XG4gICAgY29uc3Qgbm93SW5NYW5pbGEgPSB0aGlzLmdldEN1cnJlbnRNYW5pbGFUaW1lKCk7XG4gICAgXG4gICAgLy8gQ2FsY3VsYXRlIG1pbiBhbmQgbWF4IGRhdGVzIHVzaW5nIE1hbmlsYSB0aW1lXG4gICAgY29uc3QgbWF4RGF0ZSA9IG5ldyBEYXRlKFxuICAgICAgbm93SW5NYW5pbGEuZ2V0VGltZSgpICsgY29uZmlnLm1heEFkdmFuY2VCb29raW5nICogMjQgKiA2MCAqIDYwICogMTAwMCxcbiAgICApO1xuICAgIGNvbnN0IG1pbkRhdGUgPSBuZXcgRGF0ZShcbiAgICAgIG5vd0luTWFuaWxhLmdldFRpbWUoKSArIGNvbmZpZy5taW5BZHZhbmNlQm9va2luZyAqIDYwICogNjAgKiAxMDAwLFxuICAgICk7XG5cbiAgICAvLyBDb252ZXJ0IHRoZSB0YXJnZXQgZGF0ZSB0byBNYW5pbGEgdGltZSBmb3IgY29tcGFyaXNvblxuICAgIGNvbnN0IHRhcmdldERhdGVJbk1hbmlsYSA9IHRoaXMuY29udmVydFRvTWFuaWxhVGltZShkYXRlKTtcblxuICAgIGlmICh0YXJnZXREYXRlSW5NYW5pbGEgPCBtaW5EYXRlKSB7XG4gICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdEV4Y2VwdGlvbihcbiAgICAgICAgYEJvb2tpbmdzIG11c3QgYmUgbWFkZSBhdCBsZWFzdCAke2NvbmZpZy5taW5BZHZhbmNlQm9va2luZ30gaG91cnMgaW4gYWR2YW5jZSAoQXNpYS9NYW5pbGEgdGltZXpvbmUpYCxcbiAgICAgICk7XG4gICAgfVxuXG4gICAgaWYgKHRhcmdldERhdGVJbk1hbmlsYSA+IG1heERhdGUpIHtcbiAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0RXhjZXB0aW9uKFxuICAgICAgICBgQm9va2luZ3MgY2FuIG9ubHkgYmUgbWFkZSB1cCB0byAke2NvbmZpZy5tYXhBZHZhbmNlQm9va2luZ30gZGF5cyBpbiBhZHZhbmNlIChBc2lhL01hbmlsYSB0aW1lem9uZSlgLFxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGdldFRoZXJhcGlzdEF2YWlsYWJpbGl0eShcbiAgICB0aGVyYXBpc3RJZDogc3RyaW5nLFxuICAgIGRheU9mV2VlazogbnVtYmVyLFxuICApIHtcbiAgICByZXR1cm4gdGhpcy5wcmlzbWEudGhlcmFwaXN0QXZhaWxhYmlsaXR5LmZpbmRNYW55KHtcbiAgICAgIHdoZXJlOiB7XG4gICAgICAgIHRoZXJhcGlzdElkLFxuICAgICAgICBkYXlPZldlZWs6IGRheU9mV2Vlay50b1N0cmluZygpLFxuICAgICAgICBpc0F2YWlsYWJsZTogdHJ1ZSxcbiAgICAgIH0sXG4gICAgICBvcmRlckJ5OiB7IHN0YXJ0VGltZTogJ2FzYycgfSxcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgZ2V0RXhpc3RpbmdCb29raW5ncyh0aGVyYXBpc3RJZDogc3RyaW5nLCBkYXRlOiBEYXRlKSB7XG4gICAgY29uc3Qgc3RhcnRPZkRheSA9IG5ldyBEYXRlKGRhdGUpO1xuICAgIHN0YXJ0T2ZEYXkuc2V0SG91cnMoMCwgMCwgMCwgMCk7XG4gICAgY29uc3QgZW5kT2ZEYXkgPSBuZXcgRGF0ZShkYXRlKTtcbiAgICBlbmRPZkRheS5zZXRIb3VycygyMywgNTksIDU5LCA5OTkpO1xuXG4gICAgcmV0dXJuIHRoaXMucHJpc21hLm1lZXRpbmcuZmluZE1hbnkoe1xuICAgICAgd2hlcmU6IHtcbiAgICAgICAgdGhlcmFwaXN0SWQsXG4gICAgICAgIHN0YXJ0VGltZTogeyBndGU6IHN0YXJ0T2ZEYXksIGx0ZTogZW5kT2ZEYXkgfSxcbiAgICAgICAgc3RhdHVzOiB7IGluOiBbJ1NDSEVEVUxFRCcsICdDT05GSVJNRUQnXSB9LFxuICAgICAgfSxcbiAgICAgIG9yZGVyQnk6IHsgc3RhcnRUaW1lOiAnYXNjJyB9LFxuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBnZW5lcmF0ZVNsb3RzRm9yQXZhaWxhYmlsaXR5V2luZG93KFxuICAgIGRhdGU6IERhdGUsXG4gICAgYXZhaWxhYmlsaXR5OiBhbnksXG4gICAgZXhpc3RpbmdCb29raW5nczogYW55W10sXG4gICAgY29uZmlnOiBTbG90R2VuZXJhdGlvbkNvbmZpZyxcbiAgKTogVGltZVNsb3RbXSB7XG4gICAgY29uc3Qgc2xvdHM6IFRpbWVTbG90W10gPSBbXTtcbiAgICBjb25zdCBkdXJhdGlvbnMgPSB0aGlzLmdldER1cmF0aW9ucygpO1xuXG4gICAgY29uc3Qgc3RhcnRUaW1lID0gdGhpcy5jcmVhdGVEYXRlVGltZShkYXRlLCBhdmFpbGFiaWxpdHkuc3RhcnRUaW1lKTtcbiAgICBjb25zdCBlbmRUaW1lID0gdGhpcy5jcmVhdGVEYXRlVGltZShkYXRlLCBhdmFpbGFiaWxpdHkuZW5kVGltZSk7XG5cbiAgICBsZXQgY3VycmVudFRpbWUgPSBuZXcgRGF0ZShzdGFydFRpbWUpO1xuXG4gICAgd2hpbGUgKGN1cnJlbnRUaW1lIDwgZW5kVGltZSkge1xuICAgICAgY29uc3Qgc2xvdEVuZCA9IG5ldyBEYXRlKFxuICAgICAgICBjdXJyZW50VGltZS5nZXRUaW1lKCkgKyBjb25maWcuc2xvdEludGVydmFsICogNjAwMDAsXG4gICAgICApO1xuXG4gICAgICBpZiAoc2xvdEVuZCA8PSBlbmRUaW1lKSB7XG4gICAgICAgIC8vIENoZWNrIGlmIHRoaXMgc2xvdCBjb25mbGljdHMgd2l0aCBleGlzdGluZyBib29raW5nc1xuICAgICAgICBpZiAoXG4gICAgICAgICAgIXRoaXMuaGFzQ29uZmxpY3RXaXRoQm9va2luZ3MoY3VycmVudFRpbWUsIHNsb3RFbmQsIGV4aXN0aW5nQm9va2luZ3MpXG4gICAgICAgICkge1xuICAgICAgICAgIC8vIEZpbmQgd2hpY2ggZHVyYXRpb25zIGZpdCBpbiB0aGlzIHNsb3RcbiAgICAgICAgICBjb25zdCBhdmFpbGFibGVEdXJhdGlvbnMgPSB0aGlzLmdldEF2YWlsYWJsZUR1cmF0aW9ucyhcbiAgICAgICAgICAgIGN1cnJlbnRUaW1lLFxuICAgICAgICAgICAgZW5kVGltZSxcbiAgICAgICAgICAgIGV4aXN0aW5nQm9va2luZ3MsXG4gICAgICAgICAgICBkdXJhdGlvbnMsXG4gICAgICAgICAgKTtcblxuICAgICAgICAgIGlmIChhdmFpbGFibGVEdXJhdGlvbnMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgc2xvdHMucHVzaCh7XG4gICAgICAgICAgICAgIHN0YXJ0VGltZTogY3VycmVudFRpbWUudG9JU09TdHJpbmcoKSxcbiAgICAgICAgICAgICAgYXZhaWxhYmxlRHVyYXRpb25zLFxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIGN1cnJlbnRUaW1lID0gbmV3IERhdGUoXG4gICAgICAgIGN1cnJlbnRUaW1lLmdldFRpbWUoKSArIGNvbmZpZy5zbG90SW50ZXJ2YWwgKiA2MDAwMCxcbiAgICAgICk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHNsb3RzO1xuICB9XG5cbiAgcHJpdmF0ZSBjcmVhdGVEYXRlVGltZShkYXRlOiBEYXRlLCB0aW1lU3RyaW5nOiBzdHJpbmcpOiBEYXRlIHtcbiAgICBjb25zdCBbaG91cnMsIG1pbnV0ZXNdID0gdGltZVN0cmluZy5zcGxpdCgnOicpLm1hcChOdW1iZXIpO1xuICAgIGNvbnN0IGRhdGVUaW1lID0gbmV3IERhdGUoZGF0ZSk7XG4gICAgZGF0ZVRpbWUuc2V0SG91cnMoaG91cnMsIG1pbnV0ZXMsIDAsIDApO1xuICAgIHJldHVybiBkYXRlVGltZTtcbiAgfVxuXG4gIHByaXZhdGUgaGFzQ29uZmxpY3RXaXRoQm9va2luZ3MoXG4gICAgc2xvdFN0YXJ0OiBEYXRlLFxuICAgIHNsb3RFbmQ6IERhdGUsXG4gICAgYm9va2luZ3M6IGFueVtdLFxuICApOiBib29sZWFuIHtcbiAgICByZXR1cm4gYm9va2luZ3Muc29tZSgoYm9va2luZykgPT4ge1xuICAgICAgY29uc3QgYm9va2luZ0VuZCA9IG5ldyBEYXRlKFxuICAgICAgICBib29raW5nLnN0YXJ0VGltZS5nZXRUaW1lKCkgKyBib29raW5nLmR1cmF0aW9uICogNjAwMDAsXG4gICAgICApO1xuICAgICAgcmV0dXJuIHRoaXMuaGFzVGltZU92ZXJsYXAoXG4gICAgICAgIHNsb3RTdGFydCxcbiAgICAgICAgc2xvdEVuZCxcbiAgICAgICAgYm9va2luZy5zdGFydFRpbWUsXG4gICAgICAgIGJvb2tpbmdFbmQsXG4gICAgICApO1xuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRBdmFpbGFibGVEdXJhdGlvbnMoXG4gICAgc2xvdFN0YXJ0OiBEYXRlLFxuICAgIGF2YWlsYWJpbGl0eUVuZDogRGF0ZSxcbiAgICBleGlzdGluZ0Jvb2tpbmdzOiBhbnlbXSxcbiAgICBkdXJhdGlvbnM6IGFueVtdLFxuICApIHtcbiAgICByZXR1cm4gZHVyYXRpb25zLmZpbHRlcigoZHVyYXRpb24pID0+IHtcbiAgICAgIGNvbnN0IGR1cmF0aW9uRW5kID0gbmV3IERhdGUoXG4gICAgICAgIHNsb3RTdGFydC5nZXRUaW1lKCkgKyBkdXJhdGlvbi5kdXJhdGlvbiAqIDYwMDAwLFxuICAgICAgKTtcblxuICAgICAgLy8gQ2hlY2sgaWYgZHVyYXRpb24gZml0cyB3aXRoaW4gYXZhaWxhYmlsaXR5IHdpbmRvd1xuICAgICAgaWYgKGR1cmF0aW9uRW5kID4gYXZhaWxhYmlsaXR5RW5kKSB7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgIH1cblxuICAgICAgLy8gQ2hlY2sgaWYgZHVyYXRpb24gY29uZmxpY3RzIHdpdGggZXhpc3RpbmcgYm9va2luZ3NcbiAgICAgIHJldHVybiAhdGhpcy5oYXNDb25mbGljdFdpdGhCb29raW5ncyhcbiAgICAgICAgc2xvdFN0YXJ0LFxuICAgICAgICBkdXJhdGlvbkVuZCxcbiAgICAgICAgZXhpc3RpbmdCb29raW5ncyxcbiAgICAgICk7XG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIGhhc1RpbWVPdmVybGFwKFxuICAgIHN0YXJ0MTogRGF0ZSxcbiAgICBlbmQxOiBEYXRlLFxuICAgIHN0YXJ0MjogRGF0ZSxcbiAgICBlbmQyOiBEYXRlLFxuICApOiBib29sZWFuIHtcbiAgICByZXR1cm4gc3RhcnQxIDwgZW5kMiAmJiBlbmQxID4gc3RhcnQyO1xuICB9XG5cbiAgLyoqXG4gICAqIENoZWNrIGlmIGEgc3BlY2lmaWMgdGltZSBzbG90IGlzIGF2YWlsYWJsZVxuICAgKi9cbiAgYXN5bmMgaXNTbG90QXZhaWxhYmxlKFxuICAgIHRoZXJhcGlzdElkOiBzdHJpbmcsXG4gICAgc3RhcnRUaW1lOiBEYXRlLFxuICAgIGR1cmF0aW9uOiBudW1iZXIsXG4gICk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgIGNvbnN0IGVuZFRpbWUgPSBuZXcgRGF0ZShzdGFydFRpbWUuZ2V0VGltZSgpICsgZHVyYXRpb24gKiA2MDAwMCk7XG4gICAgY29uc3QgZGF5T2ZXZWVrID0gc3RhcnRUaW1lLmdldERheSgpO1xuXG4gICAgLy8gQ2hlY2sgdGhlcmFwaXN0IGF2YWlsYWJpbGl0eVxuICAgIGNvbnN0IGF2YWlsYWJpbGl0eSA9IGF3YWl0IHRoaXMucHJpc21hLnRoZXJhcGlzdEF2YWlsYWJpbGl0eS5maW5kRmlyc3Qoe1xuICAgICAgd2hlcmU6IHtcbiAgICAgICAgdGhlcmFwaXN0SWQsXG4gICAgICAgIGRheU9mV2VlazogZGF5T2ZXZWVrLnRvU3RyaW5nKCksXG4gICAgICAgIGlzQXZhaWxhYmxlOiB0cnVlLFxuICAgICAgfSxcbiAgICB9KTtcblxuICAgIGlmICghYXZhaWxhYmlsaXR5KSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgLy8gQ2hlY2sgaWYgdGltZSBmaXRzIHdpdGhpbiBhdmFpbGFiaWxpdHkgd2luZG93XG4gICAgY29uc3QgYXZhaWxTdGFydCA9IHRoaXMuY3JlYXRlRGF0ZVRpbWUoc3RhcnRUaW1lLCBhdmFpbGFiaWxpdHkuc3RhcnRUaW1lKTtcbiAgICBjb25zdCBhdmFpbEVuZCA9IHRoaXMuY3JlYXRlRGF0ZVRpbWUoc3RhcnRUaW1lLCBhdmFpbGFiaWxpdHkuZW5kVGltZSk7XG5cbiAgICBpZiAoc3RhcnRUaW1lIDwgYXZhaWxTdGFydCB8fCBlbmRUaW1lID4gYXZhaWxFbmQpIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICAvLyBDaGVjayBmb3IgY29uZmxpY3RzIHdpdGggZXhpc3RpbmcgYm9va2luZ3NcbiAgICBjb25zdCBleGlzdGluZ0Jvb2tpbmdzID0gYXdhaXQgdGhpcy5nZXRFeGlzdGluZ0Jvb2tpbmdzKFxuICAgICAgdGhlcmFwaXN0SWQsXG4gICAgICBzdGFydFRpbWUsXG4gICAgKTtcblxuICAgIHJldHVybiAhdGhpcy5oYXNDb25mbGljdFdpdGhCb29raW5ncyhzdGFydFRpbWUsIGVuZFRpbWUsIGV4aXN0aW5nQm9va2luZ3MpO1xuICB9XG59XG4iXSwidmVyc2lvbiI6M30=