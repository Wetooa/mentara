306a03baa455e07f5c46eeb0402c52b0
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var WebSocketEventService_1;
Object.defineProperty(exports, "__esModule", { value: true });
exports.WebSocketEventService = void 0;
const common_1 = require("@nestjs/common");
const event_bus_service_1 = require("../../common/events/event-bus.service");
const messaging_gateway_1 = require("../messaging.gateway");
let WebSocketEventService = WebSocketEventService_1 = class WebSocketEventService {
    eventBus;
    messagingGateway;
    logger = new common_1.Logger(WebSocketEventService_1.name);
    constructor(eventBus, messagingGateway) {
        this.eventBus = eventBus;
        this.messagingGateway = messagingGateway;
    }
    onModuleInit() {
        this.subscribeToEvents();
        this.logger.log('WebSocket event handlers initialized successfully');
    }
    subscribeToEvents() {
        // Subscribe to messaging events
        this.subscribeToMessagingEvents();
        // Subscribe to booking events
        this.subscribeToBookingEvents();
        // Subscribe to user events
        this.subscribeToUserEvents();
        // Subscribe to social events
        this.subscribeToSocialEvents();
        this.logger.log('Subscribed to all WebSocket event handlers');
    }
    subscribeToMessagingEvents() {
        // Message sent event - broadcast to conversation participants
        this.eventBus.subscribe('MessageSentEvent', async (event) => {
            const messageEvent = event;
            const { conversationId, messageId, senderId, content, messageType, sentAt, recipientIds, } = messageEvent.eventData;
            // Broadcast message to conversation participants via WebSocket
            this.messagingGateway.broadcastMessage(conversationId, {
                id: messageId,
                conversationId,
                senderId,
                content,
                messageType,
                sentAt,
                eventType: 'message_sent',
            });
            // Send delivery confirmations
            for (const recipientId of recipientIds) {
                this.messagingGateway.server
                    .to(this.getUserSocketRoom(recipientId))
                    .emit('message_delivered', {
                    messageId,
                    conversationId,
                    deliveredAt: new Date(),
                    eventType: 'message_delivered',
                });
            }
            this.logger.debug(`Broadcasted message sent event: ${messageId}`);
        });
        // Message read event - broadcast read receipt
        this.eventBus.subscribe('MessageReadEvent', async (event) => {
            const readEvent = event;
            const { messageId, conversationId, readBy } = readEvent.eventData;
            this.messagingGateway.broadcastReadReceipt(conversationId, messageId, readBy);
            this.logger.debug(`Broadcasted message read event: ${messageId} by ${readBy}`);
        });
        // Conversation created event - notify participants
        this.eventBus.subscribe('ConversationCreatedEvent', async (event) => {
            const conversationEvent = event;
            const { conversationId, createdBy, participantIds, conversationType, title, } = conversationEvent.eventData;
            // Notify all participants about new conversation
            for (const participantId of participantIds) {
                this.messagingGateway.server
                    .to(this.getUserSocketRoom(participantId))
                    .emit('conversation_created', {
                    conversationId,
                    createdBy,
                    conversationType,
                    title,
                    participantIds,
                    eventType: 'conversation_created',
                    timestamp: new Date(),
                });
            }
            this.logger.debug(`Broadcasted conversation created event: ${conversationId}`);
        });
        // Participant joined event - notify conversation
        this.eventBus.subscribe('ParticipantJoinedEvent', async (event) => {
            const joinEvent = event;
            const { conversationId, participantId, addedBy, joinedAt, role } = joinEvent.eventData;
            this.messagingGateway.server
                .to(conversationId)
                .emit('participant_joined', {
                conversationId,
                participantId,
                addedBy,
                joinedAt,
                role,
                eventType: 'participant_joined',
            });
            this.logger.debug(`Broadcasted participant joined event: ${participantId} to ${conversationId}`);
        });
        // Participant left event - notify conversation
        this.eventBus.subscribe('ParticipantLeftEvent', async (event) => {
            const leftEvent = event;
            const { conversationId, participantId, leftAt, leftReason } = leftEvent.eventData;
            this.messagingGateway.server
                .to(conversationId)
                .emit('participant_left', {
                conversationId,
                participantId,
                leftAt,
                leftReason,
                eventType: 'participant_left',
            });
            this.logger.debug(`Broadcasted participant left event: ${participantId} from ${conversationId}`);
        });
        // Typing indicator event - relay to conversation
        this.eventBus.subscribe('TypingIndicatorEvent', async (event) => {
            const typingEvent = event;
            const { conversationId, userId, isTyping, timestamp } = typingEvent.eventData;
            this.messagingGateway.server
                .to(conversationId)
                .emit('typing_indicator', {
                conversationId,
                userId,
                isTyping,
                timestamp,
                eventType: 'typing_indicator',
            });
            this.logger.debug(`Relayed typing indicator: ${userId} in ${conversationId} - ${isTyping}`);
        });
    }
    subscribeToBookingEvents() {
        // Appointment booked event - notify therapist and client
        this.eventBus.subscribe('AppointmentBookedEvent', async (event) => {
            const appointmentEvent = event;
            const { appointmentId, clientId, therapistId, startTime, meetingType, isInitialConsultation, } = appointmentEvent.eventData;
            const appointmentNotification = {
                appointmentId,
                clientId,
                therapistId,
                startTime,
                meetingType,
                isInitialConsultation,
                eventType: 'appointment_booked',
                timestamp: new Date(),
            };
            // Notify client
            this.messagingGateway.server
                .to(this.getUserSocketRoom(clientId))
                .emit('appointment_notification', {
                ...appointmentNotification,
                message: 'Your appointment has been booked and is pending confirmation.',
            });
            // Notify therapist
            this.messagingGateway.server
                .to(this.getUserSocketRoom(therapistId))
                .emit('appointment_notification', {
                ...appointmentNotification,
                message: 'You have a new appointment request that requires confirmation.',
            });
            this.logger.debug(`Broadcasted appointment booked event: ${appointmentId}`);
        });
        // Appointment cancelled event - notify both parties
        this.eventBus.subscribe('AppointmentCancelledEvent', async (event) => {
            const cancelEvent = event;
            const { appointmentId, clientId, therapistId, cancelledBy, cancellationReason, cancelledAt, } = cancelEvent.eventData;
            const cancellationNotification = {
                appointmentId,
                clientId,
                therapistId,
                cancelledBy,
                cancellationReason,
                cancelledAt,
                eventType: 'appointment_cancelled',
                timestamp: new Date(),
            };
            // Determine message based on who cancelled
            const clientMessage = cancelledBy === clientId
                ? 'You have cancelled your appointment.'
                : 'Your appointment has been cancelled by the therapist.';
            const therapistMessage = cancelledBy === therapistId
                ? 'You have cancelled the appointment.'
                : 'The client has cancelled their appointment.';
            // Notify client
            this.messagingGateway.server
                .to(this.getUserSocketRoom(clientId))
                .emit('appointment_notification', {
                ...cancellationNotification,
                message: clientMessage,
            });
            // Notify therapist
            this.messagingGateway.server
                .to(this.getUserSocketRoom(therapistId))
                .emit('appointment_notification', {
                ...cancellationNotification,
                message: therapistMessage,
            });
            this.logger.debug(`Broadcasted appointment cancelled event: ${appointmentId}`);
        });
    }
    subscribeToUserEvents() {
        // User registered event - welcome notification
        this.eventBus.subscribe('UserRegisteredEvent', async (event) => {
            const registrationEvent = event;
            const { userId, firstName, lastName, role } = registrationEvent.eventData;
            // Send welcome notification to the new user
            this.messagingGateway.server
                .to(this.getUserSocketRoom(userId))
                .emit('welcome_notification', {
                userId,
                firstName,
                lastName,
                role,
                eventType: 'user_registered',
                message: `Welcome to Mentara, ${firstName}! Your account has been successfully created.`,
                timestamp: new Date(),
            });
            this.logger.debug(`Sent welcome notification to new user: ${userId}`);
        });
        // User profile updated event - notify relevant connections
        this.eventBus.subscribe('UserProfileUpdatedEvent', async (event) => {
            const profileEvent = event;
            const { userId, updatedFields, newValues } = profileEvent.eventData;
            // Notify conversations where profile info might be displayed
            this.messagingGateway.server.emit('user_profile_updated', {
                userId,
                updatedFields,
                profileData: newValues,
                eventType: 'user_profile_updated',
                timestamp: new Date(),
            });
            this.logger.debug(`Broadcasted user profile update: ${userId}`);
        });
    }
    subscribeToSocialEvents() {
        // Post created event - notify community members
        this.eventBus.subscribe('PostCreatedEvent', async (event) => {
            const postEvent = event;
            const { postId, authorId, communityId, title, content, tags, postType, isAnonymous, } = postEvent.eventData;
            // Broadcast to community room
            if (communityId) {
                this.messagingGateway.server
                    .to(`community_${communityId}`)
                    .emit('new_post', {
                    postId,
                    authorId: isAnonymous ? null : authorId, // Hide author if anonymous
                    communityId,
                    title,
                    content,
                    tags,
                    postType,
                    isAnonymous,
                    eventType: 'post_created',
                    timestamp: new Date(),
                });
            }
            this.logger.debug(`Broadcasted post created event: ${postId}`);
        });
        // Comment added event - notify post author and participants
        this.eventBus.subscribe('CommentAddedEvent', async (event) => {
            const commentEvent = event;
            const { commentId, postId, authorId, content } = commentEvent.eventData;
            // Broadcast to post room
            this.messagingGateway.server
                .to(`post_${postId}`)
                .emit('post_interaction', {
                commentId,
                postId,
                authorId,
                content,
                interactionType: 'comment',
                eventType: 'comment_created',
                message: 'Someone commented on your post',
                timestamp: new Date(),
            });
            // Broadcast to post viewers
            this.messagingGateway.server.to(`post_${postId}`).emit('new_comment', {
                commentId,
                postId,
                authorId,
                content,
                eventType: 'comment_created',
                timestamp: new Date(),
            });
            this.logger.debug(`Broadcasted comment created event: ${commentId} on post ${postId}`);
        });
    }
    /**
     * Helper method to get user socket room name
     */
    getUserSocketRoom(userId) {
        return `user_${userId}`;
    }
    /**
     * Subscribe users to their personal notification rooms
     */
    subscribeUserToPersonalRoom(userId, socketId) {
        const userRoom = this.getUserSocketRoom(userId);
        this.messagingGateway.server.in(socketId).socketsJoin(userRoom);
        this.logger.debug(`User ${userId} subscribed to personal room: ${userRoom}`);
    }
    /**
     * Unsubscribe users from their personal notification rooms
     */
    unsubscribeUserFromPersonalRoom(userId, socketId) {
        const userRoom = this.getUserSocketRoom(userId);
        this.messagingGateway.server.in(socketId).socketsLeave(userRoom);
        this.logger.debug(`User ${userId} unsubscribed from personal room: ${userRoom}`);
    }
    /**
     * Subscribe user to community room for post notifications
     */
    subscribeUserToCommunityRoom(userId, communityId, socketId) {
        const communityRoom = `community_${communityId}`;
        this.messagingGateway.server.in(socketId).socketsJoin(communityRoom);
        this.logger.debug(`User ${userId} subscribed to community room: ${communityRoom}`);
    }
    /**
     * Subscribe user to post room for comment notifications
     */
    subscribeUserToPostRoom(userId, postId, socketId) {
        const postRoom = `post_${postId}`;
        this.messagingGateway.server.in(socketId).socketsJoin(postRoom);
        this.logger.debug(`User ${userId} subscribed to post room: ${postRoom}`);
    }
    /**
     * Get connection statistics
     */
    getConnectionStats() {
        return {
            totalConnections: this.messagingGateway.server.sockets.sockets.size,
            eventSubscriptions: this.eventBus.getEventStats().totalListeners,
        };
    }
    /**
     * Broadcast system-wide announcement
     */
    broadcastSystemAnnouncement(message, priority = 'medium') {
        this.messagingGateway.server.emit('system_announcement', {
            message,
            priority,
            eventType: 'system_announcement',
            timestamp: new Date(),
        });
        this.logger.log(`Broadcasted system announcement: ${message} (priority: ${priority})`);
    }
    /**
     * Send targeted notification to specific users
     */
    sendTargetedNotification(userIds, notification) {
        for (const userId of userIds) {
            this.messagingGateway.server
                .to(this.getUserSocketRoom(userId))
                .emit('targeted_notification', {
                ...notification,
                eventType: 'targeted_notification',
                timestamp: new Date(),
            });
        }
        this.logger.debug(`Sent targeted notification to ${userIds.length} users`);
    }
};
exports.WebSocketEventService = WebSocketEventService;
exports.WebSocketEventService = WebSocketEventService = WebSocketEventService_1 = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [event_bus_service_1.EventBusService,
        messaging_gateway_1.MessagingGateway])
], WebSocketEventService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL21lc3NhZ2luZy9zZXJ2aWNlcy93ZWJzb2NrZXQtZXZlbnQuc2VydmljZS50cyIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7O0FBQUEsMkNBQWtFO0FBQ2xFLDZFQUF3RTtBQXNCeEUsNERBQXdEO0FBR2pELElBQU0scUJBQXFCLDZCQUEzQixNQUFNLHFCQUFxQjtJQUliO0lBQ0E7SUFKRixNQUFNLEdBQUcsSUFBSSxlQUFNLENBQUMsdUJBQXFCLENBQUMsSUFBSSxDQUFDLENBQUM7SUFFakUsWUFDbUIsUUFBeUIsRUFDekIsZ0JBQWtDO1FBRGxDLGFBQVEsR0FBUixRQUFRLENBQWlCO1FBQ3pCLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBa0I7SUFDbEQsQ0FBQztJQUVKLFlBQVk7UUFDVixJQUFJLENBQUMsaUJBQWlCLEVBQUUsQ0FBQztRQUN6QixJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxtREFBbUQsQ0FBQyxDQUFDO0lBQ3ZFLENBQUM7SUFFTyxpQkFBaUI7UUFDdkIsZ0NBQWdDO1FBQ2hDLElBQUksQ0FBQywwQkFBMEIsRUFBRSxDQUFDO1FBRWxDLDhCQUE4QjtRQUM5QixJQUFJLENBQUMsd0JBQXdCLEVBQUUsQ0FBQztRQUVoQywyQkFBMkI7UUFDM0IsSUFBSSxDQUFDLHFCQUFxQixFQUFFLENBQUM7UUFFN0IsNkJBQTZCO1FBQzdCLElBQUksQ0FBQyx1QkFBdUIsRUFBRSxDQUFDO1FBRS9CLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLDRDQUE0QyxDQUFDLENBQUM7SUFDaEUsQ0FBQztJQUVPLDBCQUEwQjtRQUNoQyw4REFBOEQ7UUFDOUQsSUFBSSxDQUFDLFFBQVEsQ0FBQyxTQUFTLENBQ3JCLGtCQUFrQixFQUNsQixLQUFLLEVBQUUsS0FBdUIsRUFBRSxFQUFFO1lBQ2hDLE1BQU0sWUFBWSxHQUFHLEtBQXlCLENBQUM7WUFDL0MsTUFBTSxFQUNK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QUFFLHFCQUFxQjtZQUNoQyxTQUFTLEVBQUUsSUFBSSxJQUFJLEVBQUU7U0FDdEIsQ0FBQyxDQUFDO1FBRUgsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQ2Isb0NBQW9DLE9BQU8sZUFBZSxRQUFRLEdBQUcsQ0FDdEUsQ0FBQztJQUNKLENBQUM7SUFFRDs7T0FFRztJQUNILHdCQUF3QixDQUFDLE9BQWlCLEVBQUUsWUFBaUI7UUFDM0QsS0FBSyxNQUFNLE1BQU0sSUFBSSxPQUFPLEVBQUUsQ0FBQztZQUM3QixJQUFJLENBQUMsZ0JBQWdCLENBQUMsTUFBTTtpQkFDekIsRUFBRSxDQUFDLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxNQUFNLENBQUMsQ0FBQztpQkFDbEMsSUFBSSxDQUFDLHVCQUF1QixFQUFFO2dCQUM3QixHQUFHLFlBQVk7Z0JBQ2YsU0FBUyxFQUFFLHVCQUF1QjtnQkFDbEMsU0FBUyxFQUFFLElBQUksSUFBSSxFQUFFO2FBQ3RCLENBQUMsQ0FBQztRQUNQLENBQUM7UUFFRCxJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxpQ0FBaUMsT0FBTyxDQUFDLE1BQU0sUUFBUSxDQUFDLENBQUM7SUFDN0UsQ0FBQztDQUNGLENBQUE7QUF6aEJZLHNEQUFxQjtnQ0FBckIscUJBQXFCO0lBRGpDLElBQUEsbUJBQVUsR0FBRTtxQ0FLa0IsbUNBQWU7UUFDUCxvQ0FBZ0I7R0FMMUMscUJBQXFCLENBeWhCakMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL21lc3NhZ2luZy9zZXJ2aWNlcy93ZWJzb2NrZXQtZXZlbnQuc2VydmljZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlLCBMb2dnZXIsIE9uTW9kdWxlSW5pdCB9IGZyb20gJ0BuZXN0anMvY29tbW9uJztcbmltcG9ydCB7IEV2ZW50QnVzU2VydmljZSB9IGZyb20gJy4uLy4uL2NvbW1vbi9ldmVudHMvZXZlbnQtYnVzLnNlcnZpY2UnO1xuaW1wb3J0IHsgRG9tYWluRXZlbnQgfSBmcm9tICcuLi8uLi9jb21tb24vZXZlbnRzL2ludGVyZmFjZXMvZG9tYWluLWV2ZW50LmludGVyZmFjZSc7XG5pbXBvcnQge1xuICBNZXNzYWdlU2VudEV2ZW50LFxuICBNZXNzYWdlUmVhZEV2ZW50LFxuICBDb252ZXJzYXRpb25DcmVhdGVkRXZlbnQsXG4gIFBhcnRpY2lwYW50Sm9pbmVkRXZlbnQsXG4gIFBhcnRpY2lwYW50TGVmdEV2ZW50LFxuICBUeXBpbmdJbmRpY2F0b3JFdmVudCxcbn0gZnJvbSAnLi4vLi4vY29tbW9uL2V2ZW50cy9tZXNzYWdpbmctZXZlbnRzJztcbmltcG9ydCB7XG4gIEFwcG9pbnRtZW50Qm9va2VkRXZlbnQsXG4gIEFwcG9pbnRtZW50Q2FuY2VsbGVkRXZlbnQsXG59IGZyb20gJy4uLy4uL2NvbW1vbi9ldmVudHMvYm9va2luZy1ldmVudHMnO1xuaW1wb3J0IHtcbiAgVXNlclJlZ2lzdGVyZWRFdmVudCxcbiAgVXNlclByb2ZpbGVVcGRhdGVkRXZlbnQsXG59IGZyb20gJy4uLy4uL2NvbW1vbi9ldmVudHMvdXNlci1ldmVudHMnO1xuaW1wb3J0IHtcbiAgUG9zdENyZWF0ZWRFdmVudCxcbiAgQ29tbWVudEFkZGVkRXZlbnQsXG59IGZyb20gJy4uLy4uL2NvbW1vbi9ldmVudHMvc29jaWFsLWV2ZW50cyc7XG5pbXBvcnQgeyBNZXNzYWdpbmdHYXRld2F5IH0gZnJvbSAnLi4vbWVzc2FnaW5nLmdhdGV3YXknO1xuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgV2ViU29ja2V0RXZlbnRTZXJ2aWNlIGltcGxlbWVudHMgT25Nb2R1bGVJbml0IHtcbiAgcHJpdmF0ZSByZWFkb25seSBsb2dnZXIgPSBuZXcgTG9nZ2VyKFdlYlNvY2tldEV2ZW50U2VydmljZS5uYW1lKTtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHJlYWRvbmx5IGV2ZW50QnVzOiBFdmVudEJ1c1NlcnZpY2UsXG4gICAgcHJpdmF0ZSByZWFkb25seSBtZXNzYWdpbmdHYXRld2F5OiBNZXNzYWdpbmdHYXRld2F5LFxuICApIHt9XG5cbiAgb25Nb2R1bGVJbml0KCkge1xuICAgIHRoaXMuc3Vic2NyaWJlVG9FdmVudHMoKTtcbiAgICB0aGlzLmxvZ2dlci5sb2coJ1dlYlNvY2tldCBldmVudCBoYW5kbGVycyBpbml0aWFsaXplZCBzdWNjZXNzZnVsbHknKTtcbiAgfVxuXG4gIHByaXZhdGUgc3Vic2NyaWJlVG9FdmVudHMoKTogdm9pZCB7XG4gICAgLy8gU3Vic2NyaWJlIHRvIG1lc3NhZ2luZyBldmVudHNcbiAgICB0aGlzLnN1YnNjcmliZVRvTWVzc2FnaW5nRXZlbnRzKCk7XG5cbiAgICAvLyBTdWJzY3JpYmUgdG8gYm9va2luZyBldmVudHNcbiAgICB0aGlzLnN1YnNjcmliZVRvQm9va2luZ0V2ZW50cygpO1xuXG4gICAgLy8gU3Vic2NyaWJlIHRvIHVzZXIgZXZlbnRzXG4gICAgdGhpcy5zdWJzY3JpYmVUb1VzZXJFdmVudHMoKTtcblxuICAgIC8vIFN1YnNjcmliZSB0byBzb2NpYWwgZXZlbnRzXG4gICAgdGhpcy5zdWJzY3JpYmVUb1NvY2lhbEV2ZW50cygpO1xuXG4gICAgdGhpcy5sb2dnZXIubG9nKCdTdWJzY3JpYmVkIHRvIGFsbCBXZWJTb2NrZXQgZXZlbnQgaGFuZGxlcnMnKTtcbiAgfVxuXG4gIHByaXZhdGUgc3Vic2NyaWJlVG9NZXNzYWdpbmdFdmVudHMoKTogdm9pZCB7XG4gICAgLy8gTWVzc2FnZSBzZW50IGV2ZW50IC0gYnJvYWRjYXN0IHRvIGNvbnZlcnNhdGlvbiBwYXJ0aWNpcGFudHNcbiAgICB0aGlzLmV2ZW50QnVzLnN1YnNjcmliZShcbiAgICAgICdNZXNzYWdlU2VudEV2ZW50JyxcbiAgICAgIGFzeW5jIChldmVudDogRG9tYWluRXZlbnQ8YW55PikgPT4ge1xuICAgICAgICBjb25zdCBtZXNzYWdlRXZlbnQgPSBldmVudCBhcyBNZXNzYWdlU2VudEV2ZW50O1xuICAgICAgICBjb25zdCB7XG4gICAgICAgICAgY29udmVyc2F0aW9uSWQsXG4gICAgICAgICAgbWVzc2FnZUlkLFxuICAgICAgICAgIHNlbmRlcklkLFxuICAgICAgICAgIGNvbnRlbnQsXG4gICAgICAgICAgbWVzc2FnZVR5cGUsXG4gICAgICAgICAgc2VudEF0LFxuICAgICAgICAgIHJlY2lwaWVudElkcyxcbiAgICAgICAgfSA9IG1lc3NhZ2VFdmVudC5ldmVudERhdGE7XG5cbiAgICAgICAgLy8gQnJvYWRjYXN0IG1lc3NhZ2UgdG8gY29udmVyc2F0aW9uIHBhcnRpY2lwYW50cyB2aWEgV2ViU29ja2V0XG4gICAgICAgIHRoaXMubWVzc2FnaW5nR2F0ZXdheS5icm9hZGNhc3RNZXNzYWdlKGNvbnZlcnNhdGlvbklkLCB7XG4gICAgICAgICAgaWQ6IG1lc3NhZ2VJZCxcbiAgICAgICAgICBjb252ZXJzYXRpb25JZCxcbiAgICAgICAgICBzZW5kZXJJZCxcbiAgICAgICAgICBjb250ZW50LFxuICAgICAgICAgIG1lc3NhZ2VUeXBlLFxuICAgICAgICAgIHNlbnRBdCxcbiAgICAgICAgICBldmVudFR5cGU6ICdtZXNzYWdlX3NlbnQnLFxuICAgICAgICB9KTtcblxuICAgICAgICAvLyBTZW5kIGRlbGl2ZXJ5IGNvbmZpcm1hdGlvbnNcbiAgICAgICAgZm9yIChjb25zdCByZWNpcGllbnRJZCBvZiByZWNpcGllbnRJZHMpIHtcbiAgICAgICAgICB0aGlzLm1lc3NhZ2luZ0dhdGV3YXkuc2VydmVyXG4gICAgICAgICAgICAudG8odGhpcy5nZXRVc2VyU29ja2V0Um9vbShyZWNpcGllbnRJZCkpXG4gICAgICAgICAgICAuZW1pdCgnbWVzc2FnZV9kZWxpdmVyZWQnLCB7XG4gICAgICAgICAgICAgIG1lc3NhZ2VJZCxcbiAgICAgICAgICAgICAgY29udmVyc2F0aW9uSWQsXG4gICAgICAgICAgICAgIGRlbGl2ZXJlZEF0OiBuZXcgRGF0ZSgpLFxuICAgICAgICAgICAgICBldmVudFR5cGU6ICdtZXNzYWdlX2RlbGl2ZXJlZCcsXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMubG9nZ2VyLmRlYnVnKGBCcm9hZGNhc3RlZCBtZXNzYWdlIHNlbnQgZXZlbnQ6ICR7bWVzc2FnZUlkfWApO1xuICAgICAgfSxcbiAgICApO1xuXG4gICAgLy8gTWVzc2FnZSByZWFkIGV2ZW50IC0gYnJvYWRjYXN0IHJlYWQgcmVjZWlwdFxuICAgIHRoaXMuZXZlbnRCdXMuc3Vic2NyaWJlKFxuICAgICAgJ01lc3NhZ2VSZWFkRXZlbnQnLFxuICAgICAgYXN5bmMgKGV2ZW50OiBEb21haW5FdmVudDxhbnk+KSA9PiB7XG4gICAgICAgIGNvbnN0IHJlYWRFdmVudCA9IGV2ZW50IGFzIE1lc3NhZ2VSZWFkRXZlbnQ7XG4gICAgICAgIGNvbnN0IHsgbWVzc2FnZUlkLCBjb252ZXJzYXRpb25JZCwgcmVhZEJ5IH0gPSByZWFkRXZlbnQuZXZlbnREYXRhO1xuXG4gICAgICAgIHRoaXMubWVzc2FnaW5nR2F0ZXdheS5icm9hZGNhc3RSZWFkUmVjZWlwdChcbiAgICAgICAgICBjb252ZXJzYXRpb25JZCxcbiAgICAgICAgICBtZXNzYWdlSWQsXG4gICAgICAgICAgcmVhZEJ5LFxuICAgICAgICApO1xuXG4gICAgICAgIHRoaXMubG9nZ2VyLmRlYnVnKFxuICAgICAgICAgIGBCcm9hZGNhc3RlZCBtZXNzYWdlIHJlYWQgZXZlbnQ6ICR7bWVzc2FnZUlkfSBieSAke3JlYWRCeX1gLFxuICAgICAgICApO1xuICAgICAgfSxcbiAgICApO1xuXG4gICAgLy8gQ29udmVyc2F0aW9uIGNyZWF0ZWQgZXZlbnQgLSBub3RpZnkgcGFydGljaXBhbnRzXG4gICAgdGhpcy5ldmVudEJ1cy5zdWJzY3JpYmUoXG4gICAgICAnQ29udmVyc2F0aW9uQ3JlYXRlZEV2ZW50JyxcbiAgICAgIGFzeW5jIChldmVudDogRG9tYWluRXZlbnQ8YW55PikgPT4ge1xuICAgICAgICBjb25zdCBjb252ZXJzYXRpb25FdmVudCA9IGV2ZW50IGFzIENvbnZlcnNhdGlvbkNyZWF0ZWRFdmVudDtcbiAgICAgICAgY29uc3Qge1xuICAgICAgICAgIGNvbnZlcnNhdGlvbklkLFxuICAgICAgICAgIGNyZWF0ZWRCeSxcbiAgICAgICAgICBwYXJ0aWNpcGFudElkcyxcbiAgICAgICAgICBjb252ZXJzYXRpb25UeXBlLFxuICAgICAgICAgIHRpdGxlLFxuICAgICAgICB9ID0gY29udmVyc2F0aW9uRXZlbnQuZXZlbnREYXRhO1xuXG4gICAgICAgIC8vIE5vdGlmeSBhbGwgcGFydGljaXBhbnRzIGFib3V0IG5ldyBjb252ZXJzYXRpb25cbiAgICAgICAgZm9yIChjb25zdCBwYXJ0aWNpcGFudElkIG9mIHBhcnRpY2lwYW50SWRzKSB7XG4gICAgICAgICAgdGhpcy5tZXNzYWdpbmdHYXRld2F5LnNlcnZlclxuICAgICAgICAgICAgLnRvKHRoaXMuZ2V0VXNlclNvY2tldFJvb20ocGFydGljaXBhbnRJZCkpXG4gICAgICAgICAgICAuZW1pdCgnY29udmVyc2F0aW9uX2NyZWF0ZWQnLCB7XG4gICAgICAgICAgICAgIGNvbnZlcnNhdGlvbklkLFxuICAgICAgICAgICAgICBjcmVhdGVkQnksXG4gICAgICAgICAgICAgIGNvbnZlcnNhdGlvblR5cGUsXG4gICAgICAgICAgICAgIHRpdGxlLFxuICAgICAgICAgICAgICBwYXJ0aWNpcGFudElkcyxcbiAgICAgICAgICAgICAgZXZlbnRUeXBlOiAnY29udmVyc2F0aW9uX2NyZWF0ZWQnLFxuICAgICAgICAgICAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKCksXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMubG9nZ2VyLmRlYnVnKFxuICAgICAgICAgIGBCcm9hZGNhc3RlZCBjb252ZXJzYXRpb24gY3JlYXRlZCBldmVudDogJHtjb252ZXJzYXRpb25JZH1gLFxuICAgICAgICApO1xuICAgICAgfSxcbiAgICApO1xuXG4gICAgLy8gUGFydGljaXBhbnQgam9pbmVkIGV2ZW50IC0gbm90aWZ5IGNvbnZlcnNhdGlvblxuICAgIHRoaXMuZXZlbnRCdXMuc3Vic2NyaWJlKFxuICAgICAgJ1BhcnRpY2lwYW50Sm9pbmVkRXZlbnQnLFxuICAgICAgYXN5bmMgKGV2ZW50OiBEb21haW5FdmVudDxhbnk+KSA9PiB7XG4gICAgICAgIGNvbnN0IGpvaW5FdmVudCA9IGV2ZW50IGFzIFBhcnRpY2lwYW50Sm9pbmVkRXZlbnQ7XG4gICAgICAgIGNvbnN0IHsgY29udmVyc2F0aW9uSWQsIHBhcnRpY2lwYW50SWQsIGFkZGVkQnksIGpvaW5lZEF0LCByb2xlIH0gPVxuICAgICAgICAgIGpvaW5FdmVudC5ldmVudERhdGE7XG5cbiAgICAgICAgdGhpcy5tZXNzYWdpbmdHYXRld2F5LnNlcnZlclxuICAgICAgICAgIC50byhjb252ZXJzYXRpb25JZClcbiAgICAgICAgICAuZW1pdCgncGFydGljaXBhbnRfam9pbmVkJywge1xuICAgICAgICAgICAgY29udmVyc2F0aW9uSWQsXG4gICAgICAgICAgICBwYXJ0aWNpcGFudElkLFxuICAgICAgICAgICAgYWRkZWRCeSxcbiAgICAgICAgICAgIGpvaW5lZEF0LFxuICAgICAgICAgICAgcm9sZSxcbiAgICAgICAgICAgIGV2ZW50VHlwZTogJ3BhcnRpY2lwYW50X2pvaW5lZCcsXG4gICAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy5sb2dnZXIuZGVidWcoXG4gICAgICAgICAgYEJyb2FkY2FzdGVkIHBhcnRpY2lwYW50IGpvaW5lZCBldmVudDogJHtwYXJ0aWNpcGFudElkfSB0byAke2NvbnZlcnNhdGlvbklkfWAsXG4gICAgICAgICk7XG4gICAgICB9LFxuICAgICk7XG5cbiAgICAvLyBQYXJ0aWNpcGFudCBsZWZ0IGV2ZW50IC0gbm90aWZ5IGNvbnZlcnNhdGlvblxuICAgIHRoaXMuZXZlbnRCdXMuc3Vic2NyaWJlKFxuICAgICAgJ1BhcnRpY2lwYW50TGVmdEV2ZW50JyxcbiAgICAgIGFzeW5jIChldmVudDogRG9tYWluRXZlbnQ8YW55PikgPT4ge1xuICAgICAgICBjb25zdCBsZWZ0RXZlbnQgPSBldmVudCBhcyBQYXJ0aWNpcGFudExlZnRFdmVudDtcbiAgICAgICAgY29uc3QgeyBjb252ZXJzYXRpb25JZCwgcGFydGljaXBhbnRJZCwgbGVmdEF0LCBsZWZ0UmVhc29uIH0gPVxuICAgICAgICAgIGxlZnRFdmVudC5ldmVudERhdGE7XG5cbiAgICAgICAgdGhpcy5tZXNzYWdpbmdHYXRld2F5LnNlcnZlclxuICAgICAgICAgIC50byhjb252ZXJzYXRpb25JZClcbiAgICAgICAgICAuZW1pdCgncGFydGljaXBhbnRfbGVmdCcsIHtcbiAgICAgICAgICAgIGNvbnZlcnNhdGlvbklkLFxuICAgICAgICAgICAgcGFydGljaXBhbnRJZCxcbiAgICAgICAgICAgIGxlZnRBdCxcbiAgICAgICAgICAgIGxlZnRSZWFzb24sXG4gICAgICAgICAgICBldmVudFR5cGU6ICdwYXJ0aWNpcGFudF9sZWZ0JyxcbiAgICAgICAgICB9KTtcblxuICAgICAgICB0aGlzLmxvZ2dlci5kZWJ1ZyhcbiAgICAgICAgICBgQnJvYWRjYXN0ZWQgcGFydGljaXBhbnQgbGVmdCBldmVudDogJHtwYXJ0aWNpcGFudElkfSBmcm9tICR7Y29udmVyc2F0aW9uSWR9YCxcbiAgICAgICAgKTtcbiAgICAgIH0sXG4gICAgKTtcblxuICAgIC8vIFR5cGluZyBpbmRpY2F0b3IgZXZlbnQgLSByZWxheSB0byBjb252ZXJzYXRpb25cbiAgICB0aGlzLmV2ZW50QnVzLnN1YnNjcmliZShcbiAgICAgICdUeXBpbmdJbmRpY2F0b3JFdmVudCcsXG4gICAgICBhc3luYyAoZXZlbnQ6IERvbWFpbkV2ZW50PGFueT4pID0+IHtcbiAgICAgICAgY29uc3QgdHlwaW5nRXZlbnQgPSBldmVudCBhcyBUeXBpbmdJbmRpY2F0b3JFdmVudDtcbiAgICAgICAgY29uc3QgeyBjb252ZXJzYXRpb25JZCwgdXNlcklkLCBpc1R5cGluZywgdGltZXN0YW1wIH0gPVxuICAgICAgICAgIHR5cGluZ0V2ZW50LmV2ZW50RGF0YTtcblxuICAgICAgICB0aGlzLm1lc3NhZ2luZ0dhdGV3YXkuc2VydmVyXG4gICAgICAgICAgLnRvKGNvbnZlcnNhdGlvbklkKVxuICAgICAgICAgIC5lbWl0KCd0eXBpbmdfaW5kaWNhdG9yJywge1xuICAgICAgICAgICAgY29udmVyc2F0aW9uSWQsXG4gICAgICAgICAgICB1c2VySWQsXG4gICAgICAgICAgICBpc1R5cGluZyxcbiAgICAgICAgICAgIHRpbWVzdGFtcCxcbiAgICAgICAgICAgIGV2ZW50VHlwZTogJ3R5cGluZ19pbmRpY2F0b3InLFxuICAgICAgICAgIH0pO1xuXG4gICAgICAgIHRoaXMubG9nZ2VyLmRlYnVnKFxuICAgICAgICAgIGBSZWxheWVkIHR5cGluZyBpbmRpY2F0b3I6ICR7dXNlcklkfSBpbiAke2NvbnZlcnNhdGlvbklkfSAtICR7aXNUeXBpbmd9YCxcbiAgICAgICAgKTtcbiAgICAgIH0sXG4gICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgc3Vic2NyaWJlVG9Cb29raW5nRXZlbnRzKCk6IHZvaWQge1xuICAgIC8vIEFwcG9pbnRtZW50IGJvb2tlZCBldmVudCAtIG5vdGlmeSB0aGVyYXBpc3QgYW5kIGNsaWVudFxuICAgIHRoaXMuZXZlbnRCdXMuc3Vic2NyaWJlKFxuICAgICAgJ0FwcG9pbnRtZW50Qm9va2VkRXZlbnQnLFxuICAgICAgYXN5bmMgKGV2ZW50OiBEb21haW5FdmVudDxhbnk+KSA9PiB7XG4gICAgICAgIGNvbnN0IGFwcG9pbnRtZW50RXZlbnQgPSBldmVudCBhcyBBcHBvaW50bWVudEJvb2tlZEV2ZW50O1xuICAgICAgICBjb25zdCB7XG4gICAgICAgICAgYXBwb2ludG1lbnRJZCxcbiAgICAgICAgICBjbGllbnRJZCxcbiAgICAgICAgICB0aGVyYXBpc3RJZCxcbiAgICAgICAgICBzdGFydFRpbWUsXG4gICAgICAgICAgbWVldGluZ1R5cGUsXG4gICAgICAgICAgaXNJbml0aWFsQ29uc3VsdGF0aW9uLFxuICAgICAgICB9ID0gYXBwb2ludG1lbnRFdmVudC5ldmVudERhdGE7XG5cbiAgICAgICAgY29uc3QgYXBwb2ludG1lbnROb3RpZmljYXRpb24gPSB7XG4gICAgICAgICAgYXBwb2ludG1lbnRJZCxcbiAgICAgICAgICBjbGllbnRJZCxcbiAgICAgICAgICB0aGVyYXBpc3RJZCxcbiAgICAgICAgICBzdGFydFRpbWUsXG4gICAgICAgICAgbWVldGluZ1R5cGUsXG4gICAgICAgICAgaXNJbml0aWFsQ29uc3VsdGF0aW9uLFxuICAgICAgICAgIGV2ZW50VHlwZTogJ2FwcG9pbnRtZW50X2Jvb2tlZCcsXG4gICAgICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLFxuICAgICAgICB9O1xuXG4gICAgICAgIC8vIE5vdGlmeSBjbGllbnRcbiAgICAgICAgdGhpcy5tZXNzYWdpbmdHYXRld2F5LnNlcnZlclxuICAgICAgICAgIC50byh0aGlzLmdldFVzZXJTb2NrZXRSb29tKGNsaWVudElkKSlcbiAgICAgICAgICAuZW1pdCgnYXBwb2ludG1lbnRfbm90aWZpY2F0aW9uJywge1xuICAgICAgICAgICAgLi4uYXBwb2ludG1lbnROb3RpZmljYXRpb24sXG4gICAgICAgICAgICBtZXNzYWdlOlxuICAgICAgICAgICAgICAnWW91ciBhcHBvaW50bWVudCBoYXMgYmVlbiBib29rZWQgYW5kIGlzIHBlbmRpbmcgY29uZmlybWF0aW9uLicsXG4gICAgICAgICAgfSk7XG5cbiAgICAgICAgLy8gTm90aWZ5IHRoZXJhcGlzdFxuICAgICAgICB0aGlzLm1lc3NhZ2luZ0dhdGV3YXkuc2VydmVyXG4gICAgICAgICAgLnRvKHRoaXMuZ2V0VXNlclNvY2tldFJvb20odGhlcmFwaXN0SWQpKVxuICAgICAgICAgIC5lbWl0KCdhcHBvaW50bWVudF9ub3RpZmljYXRpb24nLCB7XG4gICAgICAgICAgICAuLi5hcHBvaW50bWVudE5vdGlmaWNhdGlvbixcbiAgICAgICAgICAgIG1lc3NhZ2U6XG4gICAgICAgICAgICAgICdZb3UgaGF2ZSBhIG5ldyBhcHBvaW50bWVudCByZXF1ZXN0IHRoYXQgcmVxdWlyZXMgY29uZmlybWF0aW9uLicsXG4gICAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy5sb2dnZXIuZGVidWcoXG4gICAgICAgICAgYEJyb2FkY2FzdGVkIGFwcG9pbnRtZW50IGJvb2tlZCBldmVudDogJHthcHBvaW50bWVudElkfWAsXG4gICAgICAgICk7XG4gICAgICB9LFxuICAgICk7XG5cbiAgICAvLyBBcHBvaW50bWVudCBjYW5jZWxsZWQgZXZlbnQgLSBub3RpZnkgYm90aCBwYXJ0aWVzXG4gICAgdGhpcy5ldmVudEJ1cy5zdWJzY3JpYmUoXG4gICAgICAnQXBwb2ludG1lbnRDYW5jZWxsZWRFdmVudCcsXG4gICAgICBhc3luYyAoZXZlbnQ6IERvbWFpbkV2ZW50PGFueT4pID0+IHtcbiAgICAgICAgY29uc3QgY2FuY2VsRXZlbnQgPSBldmVudCBhcyBBcHBvaW50bWVudENhbmNlbGxlZEV2ZW50O1xuICAgICAgICBjb25zdCB7XG4gICAgICAgICAgYXBwb2ludG1lbnRJZCxcbiAgICAgICAgICBjbGllbnRJZCxcbiAgICAgICAgICB0aGVyYXBpc3RJZCxcbiAgICAgICAgICBjYW5jZWxsZWRCeSxcbiAgICAgICAgICBjYW5jZWxsYXRpb25SZWFzb24sXG4gICAgICAgICAgY2FuY2VsbGVkQXQsXG4gICAgICAgIH0gPSBjYW5jZWxFdmVudC5ldmVudERhdGE7XG5cbiAgICAgICAgY29uc3QgY2FuY2VsbGF0aW9uTm90aWZpY2F0aW9uID0ge1xuICAgICAgICAgIGFwcG9pbnRtZW50SWQsXG4gICAgICAgICAgY2xpZW50SWQsXG4gICAgICAgICAgdGhlcmFwaXN0SWQsXG4gICAgICAgICAgY2FuY2VsbGVkQnksXG4gICAgICAgICAgY2FuY2VsbGF0aW9uUmVhc29uLFxuICAgICAgICAgIGNhbmNlbGxlZEF0LFxuICAgICAgICAgIGV2ZW50VHlwZTogJ2FwcG9pbnRtZW50X2NhbmNlbGxlZCcsXG4gICAgICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLFxuICAgICAgICB9O1xuXG4gICAgICAgIC8vIERldGVybWluZSBtZXNzYWdlIGJhc2VkIG9uIHdobyBjYW5jZWxsZWRcbiAgICAgICAgY29uc3QgY2xpZW50TWVzc2FnZSA9XG4gICAgICAgICAgY2FuY2VsbGVkQnkgPT09IGNsaWVudElkXG4gICAgICAgICAgICA/ICdZb3UgaGF2ZSBjYW5jZWxsZWQgeW91ciBhcHBvaW50bWVudC4nXG4gICAgICAgICAgICA6ICdZb3VyIGFwcG9pbnRtZW50IGhhcyBiZWVuIGNhbmNlbGxlZCBieSB0aGUgdGhlcmFwaXN0Lic7XG5cbiAgICAgICAgY29uc3QgdGhlcmFwaXN0TWVzc2FnZSA9XG4gICAgICAgICAgY2FuY2VsbGVkQnkgPT09IHRoZXJhcGlzdElkXG4gICAgICAgICAgICA/ICdZb3UgaGF2ZSBjYW5jZWxsZWQgdGhlIGFwcG9pbnRtZW50LidcbiAgICAgICAgICAgIDogJ1RoZSBjbGllbnQgaGFzIGNhbmNlbGxlZCB0aGVpciBhcHBvaW50bWVudC4nO1xuXG4gICAgICAgIC8vIE5vdGlmeSBjbGllbnRcbiAgICAgICAgdGhpcy5tZXNzYWdpbmdHYXRld2F5LnNlcnZlclxuICAgICAgICAgIC50byh0aGlzLmdldFVzZXJTb2NrZXRSb29tKGNsaWVudElkKSlcbiAgICAgICAgICAuZW1pdCgnYXBwb2ludG1lbnRfbm90aWZpY2F0aW9uJywge1xuICAgICAgICAgICAgLi4uY2FuY2VsbGF0aW9uTm90aWZpY2F0aW9uLFxuICAgICAgICAgICAgbWVzc2FnZTogY2xpZW50TWVzc2FnZSxcbiAgICAgICAgICB9KTtcblxuICAgICAgICAvLyBOb3RpZnkgdGhlcmFwaXN0XG4gICAgICAgIHRoaXMubWVzc2FnaW5nR2F0ZXdheS5zZXJ2ZXJcbiAgICAgICAgICAudG8odGhpcy5nZXRVc2VyU29ja2V0Um9vbSh0aGVyYXBpc3RJZCkpXG4gICAgICAgICAgLmVtaXQoJ2FwcG9pbnRtZW50X25vdGlmaWNhdGlvbicsIHtcbiAgICAgICAgICAgIC4uLmNhbmNlbGxhdGlvbk5vdGlmaWNhdGlvbixcbiAgICAgICAgICAgIG1lc3NhZ2U6IHRoZXJhcGlzdE1lc3NhZ2UsXG4gICAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy5sb2dnZXIuZGVidWcoXG4gICAgICAgICAgYEJyb2FkY2FzdGVkIGFwcG9pbnRtZW50IGNhbmNlbGxlZCBldmVudDogJHthcHBvaW50bWVudElkfWAsXG4gICAgICAgICk7XG4gICAgICB9LFxuICAgICk7XG4gIH1cblxuICBwcml2YXRlIHN1YnNjcmliZVRvVXNlckV2ZW50cygpOiB2b2lkIHtcbiAgICAvLyBVc2VyIHJlZ2lzdGVyZWQgZXZlbnQgLSB3ZWxjb21lIG5vdGlmaWNhdGlvblxuICAgIHRoaXMuZXZlbnRCdXMuc3Vic2NyaWJlKFxuICAgICAgJ1VzZXJSZWdpc3RlcmVkRXZlbnQnLFxuICAgICAgYXN5bmMgKGV2ZW50OiBEb21haW5FdmVudDxhbnk+KSA9PiB7XG4gICAgICAgIGNvbnN0IHJlZ2lzdHJhdGlvbkV2ZW50ID0gZXZlbnQgYXMgVXNlclJlZ2lzdGVyZWRFdmVudDtcbiAgICAgICAgY29uc3QgeyB1c2VySWQsIGZpcnN0TmFtZSwgbGFzdE5hbWUsIHJvbGUgfSA9XG4gICAgICAgICAgcmVnaXN0cmF0aW9uRXZlbnQuZXZlbnREYXRhO1xuXG4gICAgICAgIC8vIFNlbmQgd2VsY29tZSBub3RpZmljYXRpb24gdG8gdGhlIG5ldyB1c2VyXG4gICAgICAgIHRoaXMubWVzc2FnaW5nR2F0ZXdheS5zZXJ2ZXJcbiAgICAgICAgICAudG8odGhpcy5nZXRVc2VyU29ja2V0Um9vbSh1c2VySWQpKVxuICAgICAgICAgIC5lbWl0KCd3ZWxjb21lX25vdGlmaWNhdGlvbicsIHtcbiAgICAgICAgICAgIHVzZXJJZCxcbiAgICAgICAgICAgIGZpcnN0TmFtZSxcbiAgICAgICAgICAgIGxhc3ROYW1lLFxuICAgICAgICAgICAgcm9sZSxcbiAgICAgICAgICAgIGV2ZW50VHlwZTogJ3VzZXJfcmVnaXN0ZXJlZCcsXG4gICAgICAgICAgICBtZXNzYWdlOiBgV2VsY29tZSB0byBNZW50YXJhLCAke2ZpcnN0TmFtZX0hIFlvdXIgYWNjb3VudCBoYXMgYmVlbiBzdWNjZXNzZnVsbHkgY3JlYXRlZC5gLFxuICAgICAgICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLFxuICAgICAgICAgIH0pO1xuXG4gICAgICAgIHRoaXMubG9nZ2VyLmRlYnVnKGBTZW50IHdlbGNvbWUgbm90aWZpY2F0aW9uIHRvIG5ldyB1c2VyOiAke3VzZXJJZH1gKTtcbiAgICAgIH0sXG4gICAgKTtcblxuICAgIC8vIFVzZXIgcHJvZmlsZSB1cGRhdGVkIGV2ZW50IC0gbm90aWZ5IHJlbGV2YW50IGNvbm5lY3Rpb25zXG4gICAgdGhpcy5ldmVudEJ1cy5zdWJzY3JpYmUoXG4gICAgICAnVXNlclByb2ZpbGVVcGRhdGVkRXZlbnQnLFxuICAgICAgYXN5bmMgKGV2ZW50OiBEb21haW5FdmVudDxhbnk+KSA9PiB7XG4gICAgICAgIGNvbnN0IHByb2ZpbGVFdmVudCA9IGV2ZW50IGFzIFVzZXJQcm9maWxlVXBkYXRlZEV2ZW50O1xuICAgICAgICBjb25zdCB7IHVzZXJJZCwgdXBkYXRlZEZpZWxkcywgbmV3VmFsdWVzIH0gPSBwcm9maWxlRXZlbnQuZXZlbnREYXRhO1xuXG4gICAgICAgIC8vIE5vdGlmeSBjb252ZXJzYXRpb25zIHdoZXJlIHByb2ZpbGUgaW5mbyBtaWdodCBiZSBkaXNwbGF5ZWRcbiAgICAgICAgdGhpcy5tZXNzYWdpbmdHYXRld2F5LnNlcnZlci5lbWl0KCd1c2VyX3Byb2ZpbGVfdXBkYXRlZCcsIHtcbiAgICAgICAgICB1c2VySWQsXG4gICAgICAgICAgdXBkYXRlZEZpZWxkcyxcbiAgICAgICAgICBwcm9maWxlRGF0YTogbmV3VmFsdWVzLFxuICAgICAgICAgIGV2ZW50VHlwZTogJ3VzZXJfcHJvZmlsZV91cGRhdGVkJyxcbiAgICAgICAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKCksXG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRoaXMubG9nZ2VyLmRlYnVnKGBCcm9hZGNhc3RlZCB1c2VyIHByb2ZpbGUgdXBkYXRlOiAke3VzZXJJZH1gKTtcbiAgICAgIH0sXG4gICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgc3Vic2NyaWJlVG9Tb2NpYWxFdmVudHMoKTogdm9pZCB7XG4gICAgLy8gUG9zdCBjcmVhdGVkIGV2ZW50IC0gbm90aWZ5IGNvbW11bml0eSBtZW1iZXJzXG4gICAgdGhpcy5ldmVudEJ1cy5zdWJzY3JpYmUoXG4gICAgICAnUG9zdENyZWF0ZWRFdmVudCcsXG4gICAgICBhc3luYyAoZXZlbnQ6IERvbWFpbkV2ZW50PGFueT4pID0+IHtcbiAgICAgICAgY29uc3QgcG9zdEV2ZW50ID0gZXZlbnQgYXMgUG9zdENyZWF0ZWRFdmVudDtcbiAgICAgICAgY29uc3Qge1xuICAgICAgICAgIHBvc3RJZCxcbiAgICAgICAgICBhdXRob3JJZCxcbiAgICAgICAgICBjb21tdW5pdHlJZCxcbiAgICAgICAgICB0aXRsZSxcbiAgICAgICAgICBjb250ZW50LFxuICAgICAgICAgIHRhZ3MsXG4gICAgICAgICAgcG9zdFR5cGUsXG4gICAgICAgICAgaXNBbm9ueW1vdXMsXG4gICAgICAgIH0gPSBwb3N0RXZlbnQuZXZlbnREYXRhO1xuXG4gICAgICAgIC8vIEJyb2FkY2FzdCB0byBjb21tdW5pdHkgcm9vbVxuICAgICAgICBpZiAoY29tbXVuaXR5SWQpIHtcbiAgICAgICAgICB0aGlzLm1lc3NhZ2luZ0dhdGV3YXkuc2VydmVyXG4gICAgICAgICAgICAudG8oYGNvbW11bml0eV8ke2NvbW11bml0eUlkfWApXG4gICAgICAgICAgICAuZW1pdCgnbmV3X3Bvc3QnLCB7XG4gICAgICAgICAgICAgIHBvc3RJZCxcbiAgICAgICAgICAgICAgYXV0aG9ySWQ6IGlzQW5vbnltb3VzID8gbnVsbCA6IGF1dGhvcklkLCAvLyBIaWRlIGF1dGhvciBpZiBhbm9ueW1vdXNcbiAgICAgICAgICAgICAgY29tbXVuaXR5SWQsXG4gICAgICAgICAgICAgIHRpdGxlLFxuICAgICAgICAgICAgICBjb250ZW50LFxuICAgICAgICAgICAgICB0YWdzLFxuICAgICAgICAgICAgICBwb3N0VHlwZSxcbiAgICAgICAgICAgICAgaXNBbm9ueW1vdXMsXG4gICAgICAgICAgICAgIGV2ZW50VHlwZTogJ3Bvc3RfY3JlYXRlZCcsXG4gICAgICAgICAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUoKSxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5sb2dnZXIuZGVidWcoYEJyb2FkY2FzdGVkIHBvc3QgY3JlYXRlZCBldmVudDogJHtwb3N0SWR9YCk7XG4gICAgICB9LFxuICAgICk7XG5cbiAgICAvLyBDb21tZW50IGFkZGVkIGV2ZW50IC0gbm90aWZ5IHBvc3QgYXV0aG9yIGFuZCBwYXJ0aWNpcGFudHNcbiAgICB0aGlzLmV2ZW50QnVzLnN1YnNjcmliZShcbiAgICAgICdDb21tZW50QWRkZWRFdmVudCcsXG4gICAgICBhc3luYyAoZXZlbnQ6IERvbWFpbkV2ZW50PGFueT4pID0+IHtcbiAgICAgICAgY29uc3QgY29tbWVudEV2ZW50ID0gZXZlbnQgYXMgQ29tbWVudEFkZGVkRXZlbnQ7XG4gICAgICAgIGNvbnN0IHsgY29tbWVudElkLCBwb3N0SWQsIGF1dGhvcklkLCBjb250ZW50IH0gPSBjb21tZW50RXZlbnQuZXZlbnREYXRhO1xuXG4gICAgICAgIC8vIEJyb2FkY2FzdCB0byBwb3N0IHJvb21cbiAgICAgICAgdGhpcy5tZXNzYWdpbmdHYXRld2F5LnNlcnZlclxuICAgICAgICAgIC50byhgcG9zdF8ke3Bvc3RJZH1gKVxuICAgICAgICAgIC5lbWl0KCdwb3N0X2ludGVyYWN0aW9uJywge1xuICAgICAgICAgICAgY29tbWVudElkLFxuICAgICAgICAgICAgcG9zdElkLFxuICAgICAgICAgICAgYXV0aG9ySWQsXG4gICAgICAgICAgICBjb250ZW50LFxuICAgICAgICAgICAgaW50ZXJhY3Rpb25UeXBlOiAnY29tbWVudCcsXG4gICAgICAgICAgICBldmVudFR5cGU6ICdjb21tZW50X2NyZWF0ZWQnLFxuICAgICAgICAgICAgbWVzc2FnZTogJ1NvbWVvbmUgY29tbWVudGVkIG9uIHlvdXIgcG9zdCcsXG4gICAgICAgICAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKCksXG4gICAgICAgICAgfSk7XG5cbiAgICAgICAgLy8gQnJvYWRjYXN0IHRvIHBvc3Qgdmlld2Vyc1xuICAgICAgICB0aGlzLm1lc3NhZ2luZ0dhdGV3YXkuc2VydmVyLnRvKGBwb3N0XyR7cG9zdElkfWApLmVtaXQoJ25ld19jb21tZW50Jywge1xuICAgICAgICAgIGNvbW1lbnRJZCxcbiAgICAgICAgICBwb3N0SWQsXG4gICAgICAgICAgYXV0aG9ySWQsXG4gICAgICAgICAgY29udGVudCxcbiAgICAgICAgICBldmVudFR5cGU6ICdjb21tZW50X2NyZWF0ZWQnLFxuICAgICAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUoKSxcbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy5sb2dnZXIuZGVidWcoXG4gICAgICAgICAgYEJyb2FkY2FzdGVkIGNvbW1lbnQgY3JlYXRlZCBldmVudDogJHtjb21tZW50SWR9IG9uIHBvc3QgJHtwb3N0SWR9YCxcbiAgICAgICAgKTtcbiAgICAgIH0sXG4gICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBIZWxwZXIgbWV0aG9kIHRvIGdldCB1c2VyIHNvY2tldCByb29tIG5hbWVcbiAgICovXG4gIHByaXZhdGUgZ2V0VXNlclNvY2tldFJvb20odXNlcklkOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgIHJldHVybiBgdXNlcl8ke3VzZXJJZH1gO1xuICB9XG5cbiAgLyoqXG4gICAqIFN1YnNjcmliZSB1c2VycyB0byB0aGVpciBwZXJzb25hbCBub3RpZmljYXRpb24gcm9vbXNcbiAgICovXG4gIHN1YnNjcmliZVVzZXJUb1BlcnNvbmFsUm9vbSh1c2VySWQ6IHN0cmluZywgc29ja2V0SWQ6IHN0cmluZyk6IHZvaWQge1xuICAgIGNvbnN0IHVzZXJSb29tID0gdGhpcy5nZXRVc2VyU29ja2V0Um9vbSh1c2VySWQpO1xuICAgIHRoaXMubWVzc2FnaW5nR2F0ZXdheS5zZXJ2ZXIuaW4oc29ja2V0SWQpLnNvY2tldHNKb2luKHVzZXJSb29tKTtcbiAgICB0aGlzLmxvZ2dlci5kZWJ1ZyhcbiAgICAgIGBVc2VyICR7dXNlcklkfSBzdWJzY3JpYmVkIHRvIHBlcnNvbmFsIHJvb206ICR7dXNlclJvb219YCxcbiAgICApO1xuICB9XG5cbiAgLyoqXG4gICAqIFVuc3Vic2NyaWJlIHVzZXJzIGZyb20gdGhlaXIgcGVyc29uYWwgbm90aWZpY2F0aW9uIHJvb21zXG4gICAqL1xuICB1bnN1YnNjcmliZVVzZXJGcm9tUGVyc29uYWxSb29tKHVzZXJJZDogc3RyaW5nLCBzb2NrZXRJZDogc3RyaW5nKTogdm9pZCB7XG4gICAgY29uc3QgdXNlclJvb20gPSB0aGlzLmdldFVzZXJTb2NrZXRSb29tKHVzZXJJZCk7XG4gICAgdGhpcy5tZXNzYWdpbmdHYXRld2F5LnNlcnZlci5pbihzb2NrZXRJZCkuc29ja2V0c0xlYXZlKHVzZXJSb29tKTtcbiAgICB0aGlzLmxvZ2dlci5kZWJ1ZyhcbiAgICAgIGBVc2VyICR7dXNlcklkfSB1bnN1YnNjcmliZWQgZnJvbSBwZXJzb25hbCByb29tOiAke3VzZXJSb29tfWAsXG4gICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBTdWJzY3JpYmUgdXNlciB0byBjb21tdW5pdHkgcm9vbSBmb3IgcG9zdCBub3RpZmljYXRpb25zXG4gICAqL1xuICBzdWJzY3JpYmVVc2VyVG9Db21tdW5pdHlSb29tKFxuICAgIHVzZXJJZDogc3RyaW5nLFxuICAgIGNvbW11bml0eUlkOiBzdHJpbmcsXG4gICAgc29ja2V0SWQ6IHN0cmluZyxcbiAgKTogdm9pZCB7XG4gICAgY29uc3QgY29tbXVuaXR5Um9vbSA9IGBjb21tdW5pdHlfJHtjb21tdW5pdHlJZH1gO1xuICAgIHRoaXMubWVzc2FnaW5nR2F0ZXdheS5zZXJ2ZXIuaW4oc29ja2V0SWQpLnNvY2tldHNKb2luKGNvbW11bml0eVJvb20pO1xuICAgIHRoaXMubG9nZ2VyLmRlYnVnKFxuICAgICAgYFVzZXIgJHt1c2VySWR9IHN1YnNjcmliZWQgdG8gY29tbXVuaXR5IHJvb206ICR7Y29tbXVuaXR5Um9vbX1gLFxuICAgICk7XG4gIH1cblxuICAvKipcbiAgICogU3Vic2NyaWJlIHVzZXIgdG8gcG9zdCByb29tIGZvciBjb21tZW50IG5vdGlmaWNhdGlvbnNcbiAgICovXG4gIHN1YnNjcmliZVVzZXJUb1Bvc3RSb29tKFxuICAgIHVzZXJJZDogc3RyaW5nLFxuICAgIHBvc3RJZDogc3RyaW5nLFxuICAgIHNvY2tldElkOiBzdHJpbmcsXG4gICk6IHZvaWQge1xuICAgIGNvbnN0IHBvc3RSb29tID0gYHBvc3RfJHtwb3N0SWR9YDtcbiAgICB0aGlzLm1lc3NhZ2luZ0dhdGV3YXkuc2VydmVyLmluKHNvY2tldElkKS5zb2NrZXRzSm9pbihwb3N0Um9vbSk7XG4gICAgdGhpcy5sb2dnZXIuZGVidWcoYFVzZXIgJHt1c2VySWR9IHN1YnNjcmliZWQgdG8gcG9zdCByb29tOiAke3Bvc3RSb29tfWApO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCBjb25uZWN0aW9uIHN0YXRpc3RpY3NcbiAgICovXG4gIGdldENvbm5lY3Rpb25TdGF0cygpOiB7XG4gICAgdG90YWxDb25uZWN0aW9uczogbnVtYmVyO1xuICAgIGV2ZW50U3Vic2NyaXB0aW9uczogbnVtYmVyO1xuICB9IHtcbiAgICByZXR1cm4ge1xuICAgICAgdG90YWxDb25uZWN0aW9uczogdGhpcy5tZXNzYWdpbmdHYXRld2F5LnNlcnZlci5zb2NrZXRzLnNvY2tldHMuc2l6ZSxcbiAgICAgIGV2ZW50U3Vic2NyaXB0aW9uczogdGhpcy5ldmVudEJ1cy5nZXRFdmVudFN0YXRzKCkudG90YWxMaXN0ZW5lcnMsXG4gICAgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiBCcm9hZGNhc3Qgc3lzdGVtLXdpZGUgYW5ub3VuY2VtZW50XG4gICAqL1xuICBicm9hZGNhc3RTeXN0ZW1Bbm5vdW5jZW1lbnQoXG4gICAgbWVzc2FnZTogc3RyaW5nLFxuICAgIHByaW9yaXR5OiAnbG93JyB8ICdtZWRpdW0nIHwgJ2hpZ2gnID0gJ21lZGl1bScsXG4gICk6IHZvaWQge1xuICAgIHRoaXMubWVzc2FnaW5nR2F0ZXdheS5zZXJ2ZXIuZW1pdCgnc3lzdGVtX2Fubm91bmNlbWVudCcsIHtcbiAgICAgIG1lc3NhZ2UsXG4gICAgICBwcmlvcml0eSxcbiAgICAgIGV2ZW50VHlwZTogJ3N5c3RlbV9hbm5vdW5jZW1lbnQnLFxuICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLFxuICAgIH0pO1xuXG4gICAgdGhpcy5sb2dnZXIubG9nKFxuICAgICAgYEJyb2FkY2FzdGVkIHN5c3RlbSBhbm5vdW5jZW1lbnQ6ICR7bWVzc2FnZX0gKHByaW9yaXR5OiAke3ByaW9yaXR5fSlgLFxuICAgICk7XG4gIH1cblxuICAvKipcbiAgICogU2VuZCB0YXJnZXRlZCBub3RpZmljYXRpb24gdG8gc3BlY2lmaWMgdXNlcnNcbiAgICovXG4gIHNlbmRUYXJnZXRlZE5vdGlmaWNhdGlvbih1c2VySWRzOiBzdHJpbmdbXSwgbm90aWZpY2F0aW9uOiBhbnkpOiB2b2lkIHtcbiAgICBmb3IgKGNvbnN0IHVzZXJJZCBvZiB1c2VySWRzKSB7XG4gICAgICB0aGlzLm1lc3NhZ2luZ0dhdGV3YXkuc2VydmVyXG4gICAgICAgIC50byh0aGlzLmdldFVzZXJTb2NrZXRSb29tKHVzZXJJZCkpXG4gICAgICAgIC5lbWl0KCd0YXJnZXRlZF9ub3RpZmljYXRpb24nLCB7XG4gICAgICAgICAgLi4ubm90aWZpY2F0aW9uLFxuICAgICAgICAgIGV2ZW50VHlwZTogJ3RhcmdldGVkX25vdGlmaWNhdGlvbicsXG4gICAgICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLFxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICB0aGlzLmxvZ2dlci5kZWJ1ZyhgU2VudCB0YXJnZXRlZCBub3RpZmljYXRpb24gdG8gJHt1c2VySWRzLmxlbmd0aH0gdXNlcnNgKTtcbiAgfVxufVxuIl0sInZlcnNpb24iOjN9