36f4b6f04c0b5701f0e6aa6d61e57d61
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
exports.SearchService = void 0;
const common_1 = require("@nestjs/common");
const prisma_client_provider_1 = require("../providers/prisma-client.provider");
let SearchService = class SearchService {
    prisma;
    constructor(prisma) {
        this.prisma = prisma;
    }
    async searchTherapists(query, filters) {
        try {
            const where = {
                status: 'approved',
                OR: [
                    {
                        user: {
                            firstName: { contains: query, mode: 'insensitive' },
                        },
                    },
                    {
                        user: {
                            lastName: { contains: query, mode: 'insensitive' },
                        },
                    },
                    {
                        bio: { contains: query, mode: 'insensitive' },
                    },
                    {
                        expertise: { hasSome: [query] },
                    },
                ],
            };
            if (filters) {
                if (filters.province) {
                    where.province = filters.province;
                }
                if (filters.expertise && filters.expertise.length > 0) {
                    where.expertise = { hasSome: filters.expertise };
                }
                if (filters.maxHourlyRate) {
                    where.hourlyRate = { lte: filters.maxHourlyRate };
                }
                if (filters.minExperience) {
                    where.yearsOfExperience = { gte: filters.minExperience };
                }
            }
            return this.prisma.therapist.findMany({
                where,
                include: {
                    user: {
                        select: {
                            id: true,
                            firstName: true,
                            lastName: true,
                            avatarUrl: true,
                        },
                    },
                },
                orderBy: { createdAt: 'desc' },
                take: 20,
            });
        }
        catch (error) {
            throw new common_1.InternalServerErrorException(`Failed to search therapists: ${error instanceof Error ? error.message : String(error)}`);
        }
    }
    async searchPosts(query, communityId) {
        try {
            const where = {
                OR: [
                    { title: { contains: query, mode: 'insensitive' } },
                    { content: { contains: query, mode: 'insensitive' } },
                    { tags: { hasSome: [query] } },
                ],
            };
            if (communityId) {
                where.communityId = communityId;
            }
            return this.prisma.post.findMany({
                where,
                include: {
                    user: {
                        select: {
                            id: true,
                            firstName: true,
                            lastName: true,
                            avatarUrl: true,
                        },
                    },
                    room: {
                        include: {
                            roomGroup: {
                                include: {
                                    community: {
                                        select: {
                                            id: true,
                                            name: true,
                                            slug: true,
                                        },
                                    },
                                },
                            },
                        },
                    },
                    _count: {
                        select: {
                            hearts: true,
                            comments: true,
                        },
                    },
                },
                orderBy: { createdAt: 'desc' },
                take: 20,
            });
        }
        catch (error) {
            throw new common_1.InternalServerErrorException(`Failed to search posts: ${error instanceof Error ? error.message : String(error)}`);
        }
    }
    async searchCommunities(query) {
        try {
            return this.prisma.community.findMany({
                where: {
                    OR: [
                        { name: { contains: query, mode: 'insensitive' } },
                        { description: { contains: query, mode: 'insensitive' } },
                    ],
                },
                include: {
                    _count: {
                        select: {
                            memberships: true,
                        },
                    },
                },
                orderBy: { createdAt: 'desc' },
                take: 20,
            });
        }
        catch (error) {
            throw new common_1.InternalServerErrorException(`Failed to search communities: ${error instanceof Error ? error.message : String(error)}`);
        }
    }
    async searchUsers(query, role) {
        try {
            const where = {
                OR: [
                    { firstName: { contains: query, mode: 'insensitive' } },
                    { lastName: { contains: query, mode: 'insensitive' } },
                    { email: { contains: query, mode: 'insensitive' } },
                ],
            };
            if (role) {
                where.role = role;
            }
            return this.prisma.user.findMany({
                where,
                select: {
                    id: true,
                    firstName: true,
                    lastName: true,
                    email: true,
                    avatarUrl: true,
                    role: true,
                    createdAt: true,
                },
                orderBy: { createdAt: 'desc' },
                take: 20,
            });
        }
        catch (error) {
            throw new common_1.InternalServerErrorException(`Failed to search users: ${error instanceof Error ? error.message : String(error)}`);
        }
    }
    async globalSearch(query, types) {
        try {
            const results = {};
            // Handle both single type and array of types
            const typesArray = Array.isArray(types)
                ? types
                : types
                    ? [types]
                    : ['therapists', 'posts', 'communities', 'users'];
            if (typesArray.includes('therapists')) {
                results.therapists = await this.searchTherapists(query);
            }
            if (typesArray.includes('posts')) {
                results.posts = await this.searchPosts(query);
            }
            if (typesArray.includes('communities')) {
                results.communities = await this.searchCommunities(query);
            }
            if (typesArray.includes('users')) {
                results.users = await this.searchUsers(query);
            }
            return results;
        }
        catch (error) {
            throw new common_1.InternalServerErrorException(`Failed to perform global search: ${error instanceof Error ? error.message : String(error)}`);
        }
    }
};
exports.SearchService = SearchService;
exports.SearchService = SearchService = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [typeof (_a = typeof prisma_client_provider_1.PrismaService !== "undefined" && prisma_client_provider_1.PrismaService) === "function" ? _a : Object])
], SearchService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL3NlYXJjaC9zZWFyY2guc2VydmljZS50cyIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7O0FBQUEsMkNBQTBFO0FBQzFFLGdGQUFvRTtBQUc3RCxJQUFNLGFBQWEsR0FBbkIsTUFBTSxhQUFhO0lBQ0s7SUFBN0IsWUFBNkIsTUFBcUI7UUFBckIsV0FBTSxHQUFOLE1BQU0sQ0FBZTtJQUFHLENBQUM7SUFFdEQsS0FBSyxDQUFDLGdCQUFnQixDQUNwQixLQUFhLEVBQ2IsT0FjQztRQUVELElBQUksQ0FBQztZQUNILE1BQU0sS0FBSyxHQUFRO2dCQUNqQixNQUFNLEVBQUUsVUFBVTtnQkFDbEIsRUFBRSxFQUFFO29CQUNGO3dCQUNFLElBQUksRUFBRTs0QkFDSixTQUFTLEVBQUUsRUFBRSxRQUFRLEVBQUUsS0FBSyxFQUFFLElBQUksRUFBRSxhQUFhLEVBQUU7eUJBQ3BEO3FCQUNGO29CQUNEO3dCQUNFLElBQUksRUFBRTs0QkFDSixRQUFRLEVBQUUsRUFBRSxRQUFRLEVBQUUsS0FBSyxFQUFFLElBQUksRUFBRSxhQUFhLEVBQUU7eUJBQ25EO3FCQUNGO29CQUNEO3dCQUNFLEdBQUcsRUFBRSxFQUFFLFFBQVEsRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLGFBQWEsRUFBRTtxQkFDOUM7b0JBQ0Q7d0JBQ0UsU0FBUyxFQUFFLEVBQUUsT0FBTyxFQUFFLENBQUMsS0FBSyxDQUFDLEVBQUU7cUJBQ2hDO2lCQUNGO2FBQ0YsQ0FBQztZQUVGLElBQUksT0FBTyxFQUFFLENBQUM7Z0JBQ1osSUFBSSxPQUFPLENBQUMsUUFBUSxFQUFFLENBQUM7b0JBQ3JCLEtBQUssQ0FBQyxRQUFRLEdBQUcsT0FBTyxDQUFDLFFBQVEsQ0FBQztnQkFDcEMsQ0FBQztnQkFDRCxJQUFJLE9BQU8sQ0FBQyxTQUFTLElBQUksT0FBTyxDQUFDLFNBQVMsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFLENBQUM7b0JB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alBZLHNDQUFhO3dCQUFiLGFBQWE7SUFEekIsSUFBQSxtQkFBVSxHQUFFO3lEQUUwQixzQ0FBYSxvQkFBYixzQ0FBYTtHQUR2QyxhQUFhLENBaVB6QiIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvaG9tZS93ZXRvb2EvRG9jdW1lbnRzL2NvZGUvcHJvamVjdHMvbWVudGFyYS9tZW50YXJhLWFwaS9zcmMvc2VhcmNoL3NlYXJjaC5zZXJ2aWNlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUsIEludGVybmFsU2VydmVyRXJyb3JFeGNlcHRpb24gfSBmcm9tICdAbmVzdGpzL2NvbW1vbic7XG5pbXBvcnQgeyBQcmlzbWFTZXJ2aWNlIH0gZnJvbSAnLi4vcHJvdmlkZXJzL3ByaXNtYS1jbGllbnQucHJvdmlkZXInO1xuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgU2VhcmNoU2VydmljZSB7XG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgcmVhZG9ubHkgcHJpc21hOiBQcmlzbWFTZXJ2aWNlKSB7fVxuXG4gIGFzeW5jIHNlYXJjaFRoZXJhcGlzdHMoXG4gICAgcXVlcnk6IHN0cmluZyxcbiAgICBmaWx0ZXJzPzoge1xuICAgICAgcHJvdmluY2U/OiBzdHJpbmc7XG4gICAgICBsb2NhdGlvbj86IHN0cmluZztcbiAgICAgIGV4cGVydGlzZT86IHN0cmluZ1tdO1xuICAgICAgc3BlY2lhbHRpZXM/OiBzdHJpbmdbXTtcbiAgICAgIG1heEhvdXJseVJhdGU/OiBudW1iZXI7XG4gICAgICBtaW5FeHBlcmllbmNlPzogbnVtYmVyO1xuICAgICAgZXhwZXJpZW5jZVllYXJzPzogbnVtYmVyO1xuICAgICAgcmF0aW5nPzogbnVtYmVyO1xuICAgICAgZ2VuZGVyPzogc3RyaW5nO1xuICAgICAgbGFuZ3VhZ2VzPzogc3RyaW5nW107XG4gICAgICBhdmFpbGFiaWxpdHk/OiBhbnk7XG4gICAgICB2ZXJpZmllZE9ubHk/OiBib29sZWFuO1xuICAgICAgcHJpY2VSYW5nZT86IHsgbWluPzogbnVtYmVyOyBtYXg/OiBudW1iZXIgfTtcbiAgICB9LFxuICApIHtcbiAgICB0cnkge1xuICAgICAgY29uc3Qgd2hlcmU6IGFueSA9IHtcbiAgICAgICAgc3RhdHVzOiAnYXBwcm92ZWQnLFxuICAgICAgICBPUjogW1xuICAgICAgICAgIHtcbiAgICAgICAgICAgIHVzZXI6IHtcbiAgICAgICAgICAgICAgZmlyc3ROYW1lOiB7IGNvbnRhaW5zOiBxdWVyeSwgbW9kZTogJ2luc2Vuc2l0aXZlJyB9LFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9LFxuICAgICAgICAgIHtcbiAgICAgICAgICAgIHVzZXI6IHtcbiAgICAgICAgICAgICAgbGFzdE5hbWU6IHsgY29udGFpbnM6IHF1ZXJ5LCBtb2RlOiAnaW5zZW5zaXRpdmUnIH0sXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0sXG4gICAgICAgICAge1xuICAgICAgICAgICAgYmlvOiB7IGNvbnRhaW5zOiBxdWVyeSwgbW9kZTogJ2luc2Vuc2l0aXZlJyB9LFxuICAgICAgICAgIH0sXG4gICAgICAgICAge1xuICAgICAgICAgICAgZXhwZXJ0aXNlOiB7IGhhc1NvbWU6IFtxdWVyeV0gfSxcbiAgICAgICAgICB9LFxuICAgICAgICBdLFxuICAgICAgfTtcblxuICAgICAgaWYgKGZpbHRlcnMpIHtcbiAgICAgICAgaWYgKGZpbHRlcnMucHJvdmluY2UpIHtcbiAgICAgICAgICB3aGVyZS5wcm92aW5jZSA9IGZpbHRlcnMucHJvdmluY2U7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGZpbHRlcnMuZXhwZXJ0aXNlICYmIGZpbHRlcnMuZXhwZXJ0aXNlLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICB3aGVyZS5leHBlcnRpc2UgPSB7IGhhc1NvbWU6IGZpbHRlcnMuZXhwZXJ0aXNlIH07XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGZpbHRlcnMubWF4SG91cmx5UmF0ZSkge1xuICAgICAgICAgIHdoZXJlLmhvdXJseVJhdGUgPSB7IGx0ZTogZmlsdGVycy5tYXhIb3VybHlSYXRlIH07XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGZpbHRlcnMubWluRXhwZXJpZW5jZSkge1xuICAgICAgICAgIHdoZXJlLnllYXJzT2ZFeHBlcmllbmNlID0geyBndGU6IGZpbHRlcnMubWluRXhwZXJpZW5jZSB9O1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIHJldHVybiB0aGlzLnByaXNtYS50aGVyYXBpc3QuZmluZE1hbnkoe1xuICAgICAgICB3aGVyZSxcbiAgICAgICAgaW5jbHVkZToge1xuICAgICAgICAgIHVzZXI6IHtcbiAgICAgICAgICAgIHNlbGVjdDoge1xuICAgICAgICAgICAgICBpZDogdHJ1ZSxcbiAgICAgICAgICAgICAgZmlyc3ROYW1lOiB0cnVlLFxuICAgICAgICAgICAgICBsYXN0TmFtZTogdHJ1ZSxcbiAgICAgICAgICAgICAgYXZhdGFyVXJsOiB0cnVlLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgICBvcmRlckJ5OiB7IGNyZWF0ZWRBdDogJ2Rlc2MnIH0sXG4gICAgICAgIHRha2U6IDIwLFxuICAgICAgfSk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRocm93IG5ldyBJbnRlcm5hbFNlcnZlckVycm9yRXhjZXB0aW9uKFxuICAgICAgICBgRmFpbGVkIHRvIHNlYXJjaCB0aGVyYXBpc3RzOiAke2Vycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogU3RyaW5nKGVycm9yKX1gLFxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBzZWFyY2hQb3N0cyhxdWVyeTogc3RyaW5nLCBjb21tdW5pdHlJZD86IHN0cmluZykge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCB3aGVyZTogYW55ID0ge1xuICAgICAgICBPUjogW1xuICAgICAgICAgIHsgdGl0bGU6IHsgY29udGFpbnM6IHF1ZXJ5LCBtb2RlOiAnaW5zZW5zaXRpdmUnIH0gfSxcbiAgICAgICAgICB7IGNvbnRlbnQ6IHsgY29udGFpbnM6IHF1ZXJ5LCBtb2RlOiAnaW5zZW5zaXRpdmUnIH0gfSxcbiAgICAgICAgICB7IHRhZ3M6IHsgaGFzU29tZTogW3F1ZXJ5XSB9IH0sXG4gICAgICAgIF0sXG4gICAgICB9O1xuXG4gICAgICBpZiAoY29tbXVuaXR5SWQpIHtcbiAgICAgICAgd2hlcmUuY29tbXVuaXR5SWQgPSBjb21tdW5pdHlJZDtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHRoaXMucHJpc21hLnBvc3QuZmluZE1hbnkoe1xuICAgICAgICB3aGVyZSxcbiAgICAgICAgaW5jbHVkZToge1xuICAgICAgICAgIHVzZXI6IHtcbiAgICAgICAgICAgIHNlbGVjdDoge1xuICAgICAgICAgICAgICBpZDogdHJ1ZSxcbiAgICAgICAgICAgICAgZmlyc3ROYW1lOiB0cnVlLFxuICAgICAgICAgICAgICBsYXN0TmFtZTogdHJ1ZSxcbiAgICAgICAgICAgICAgYXZhdGFyVXJsOiB0cnVlLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9LFxuICAgICAgICAgIHJvb206IHtcbiAgICAgICAgICAgIGluY2x1ZGU6IHtcbiAgICAgICAgICAgICAgcm9vbUdyb3VwOiB7XG4gICAgICAgICAgICAgICAgaW5jbHVkZToge1xuICAgICAgICAgICAgICAgICAgY29tbXVuaXR5OiB7XG4gICAgICAgICAgICAgICAgICAgIHNlbGVjdDoge1xuICAgICAgICAgICAgICAgICAgICAgIGlkOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgICAgIG5hbWU6IHRydWUsXG4gICAgICAgICAgICAgICAgICAgICAgc2x1ZzogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgICBfY291bnQ6IHtcbiAgICAgICAgICAgIHNlbGVjdDoge1xuICAgICAgICAgICAgICBoZWFydHM6IHRydWUsXG4gICAgICAgICAgICAgIGNvbW1lbnRzOiB0cnVlLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgICBvcmRlckJ5OiB7IGNyZWF0ZWRBdDogJ2Rlc2MnIH0sXG4gICAgICAgIHRha2U6IDIwLFxuICAgICAgfSk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRocm93IG5ldyBJbnRlcm5hbFNlcnZlckVycm9yRXhjZXB0aW9uKFxuICAgICAgICBgRmFpbGVkIHRvIHNlYXJjaCBwb3N0czogJHtlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6IFN0cmluZyhlcnJvcil9YCxcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgc2VhcmNoQ29tbXVuaXRpZXMocXVlcnk6IHN0cmluZykge1xuICAgIHRyeSB7XG4gICAgICByZXR1cm4gdGhpcy5wcmlzbWEuY29tbXVuaXR5LmZpbmRNYW55KHtcbiAgICAgICAgd2hlcmU6IHtcbiAgICAgICAgICBPUjogW1xuICAgICAgICAgICAgeyBuYW1lOiB7IGNvbnRhaW5zOiBxdWVyeSwgbW9kZTogJ2luc2Vuc2l0aXZlJyB9IH0sXG4gICAgICAgICAgICB7IGRlc2NyaXB0aW9uOiB7IGNvbnRhaW5zOiBxdWVyeSwgbW9kZTogJ2luc2Vuc2l0aXZlJyB9IH0sXG4gICAgICAgICAgXSxcbiAgICAgICAgfSxcbiAgICAgICAgaW5jbHVkZToge1xuICAgICAgICAgIF9jb3VudDoge1xuICAgICAgICAgICAgc2VsZWN0OiB7XG4gICAgICAgICAgICAgIG1lbWJlcnNoaXBzOiB0cnVlLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgICBvcmRlckJ5OiB7IGNyZWF0ZWRBdDogJ2Rlc2MnIH0sXG4gICAgICAgIHRha2U6IDIwLFxuICAgICAgfSk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRocm93IG5ldyBJbnRlcm5hbFNlcnZlckVycm9yRXhjZXB0aW9uKFxuICAgICAgICBgRmFpbGVkIHRvIHNlYXJjaCBjb21tdW5pdGllczogJHtlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6IFN0cmluZyhlcnJvcil9YCxcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgc2VhcmNoVXNlcnMocXVlcnk6IHN0cmluZywgcm9sZT86IHN0cmluZykge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCB3aGVyZTogYW55ID0ge1xuICAgICAgICBPUjogW1xuICAgICAgICAgIHsgZmlyc3ROYW1lOiB7IGNvbnRhaW5zOiBxdWVyeSwgbW9kZTogJ2luc2Vuc2l0aXZlJyB9IH0sXG4gICAgICAgICAgeyBsYXN0TmFtZTogeyBjb250YWluczogcXVlcnksIG1vZGU6ICdpbnNlbnNpdGl2ZScgfSB9LFxuICAgICAgICAgIHsgZW1haWw6IHsgY29udGFpbnM6IHF1ZXJ5LCBtb2RlOiAnaW5zZW5zaXRpdmUnIH0gfSxcbiAgICAgICAgXSxcbiAgICAgIH07XG5cbiAgICAgIGlmIChyb2xlKSB7XG4gICAgICAgIHdoZXJlLnJvbGUgPSByb2xlO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gdGhpcy5wcmlzbWEudXNlci5maW5kTWFueSh7XG4gICAgICAgIHdoZXJlLFxuICAgICAgICBzZWxlY3Q6IHtcbiAgICAgICAgICBpZDogdHJ1ZSxcbiAgICAgICAgICBmaXJzdE5hbWU6IHRydWUsXG4gICAgICAgICAgbGFzdE5hbWU6IHRydWUsXG4gICAgICAgICAgZW1haWw6IHRydWUsXG4gICAgICAgICAgYXZhdGFyVXJsOiB0cnVlLFxuICAgICAgICAgIHJvbGU6IHRydWUsXG4gICAgICAgICAgY3JlYXRlZEF0OiB0cnVlLFxuICAgICAgICB9LFxuICAgICAgICBvcmRlckJ5OiB7IGNyZWF0ZWRBdDogJ2Rlc2MnIH0sXG4gICAgICAgIHRha2U6IDIwLFxuICAgICAgfSk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRocm93IG5ldyBJbnRlcm5hbFNlcnZlckVycm9yRXhjZXB0aW9uKFxuICAgICAgICBgRmFpbGVkIHRvIHNlYXJjaCB1c2VyczogJHtlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6IFN0cmluZyhlcnJvcil9YCxcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgZ2xvYmFsU2VhcmNoKFxuICAgIHF1ZXJ5OiBzdHJpbmcsXG4gICAgdHlwZXM/OlxuICAgICAgfCAoJ3RoZXJhcGlzdHMnIHwgJ3Bvc3RzJyB8ICdjb21tdW5pdGllcycgfCAndXNlcnMnKVtdXG4gICAgICB8ICd0aGVyYXBpc3RzJ1xuICAgICAgfCAncG9zdHMnXG4gICAgICB8ICdjb21tdW5pdGllcydcbiAgICAgIHwgJ3VzZXJzJyxcbiAgKSB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHJlc3VsdHM6IGFueSA9IHt9O1xuXG4gICAgICAvLyBIYW5kbGUgYm90aCBzaW5nbGUgdHlwZSBhbmQgYXJyYXkgb2YgdHlwZXNcbiAgICAgIGNvbnN0IHR5cGVzQXJyYXkgPSBBcnJheS5pc0FycmF5KHR5cGVzKVxuICAgICAgICA/IHR5cGVzXG4gICAgICAgIDogdHlwZXNcbiAgICAgICAgICA/IFt0eXBlc11cbiAgICAgICAgICA6IFsndGhlcmFwaXN0cycsICdwb3N0cycsICdjb21tdW5pdGllcycsICd1c2VycyddO1xuXG4gICAgICBpZiAodHlwZXNBcnJheS5pbmNsdWRlcygndGhlcmFwaXN0cycpKSB7XG4gICAgICAgIHJlc3VsdHMudGhlcmFwaXN0cyA9IGF3YWl0IHRoaXMuc2VhcmNoVGhlcmFwaXN0cyhxdWVyeSk7XG4gICAgICB9XG5cbiAgICAgIGlmICh0eXBlc0FycmF5LmluY2x1ZGVzKCdwb3N0cycpKSB7XG4gICAgICAgIHJlc3VsdHMucG9zdHMgPSBhd2FpdCB0aGlzLnNlYXJjaFBvc3RzKHF1ZXJ5KTtcbiAgICAgIH1cblxuICAgICAgaWYgKHR5cGVzQXJyYXkuaW5jbHVkZXMoJ2NvbW11bml0aWVzJykpIHtcbiAgICAgICAgcmVzdWx0cy5jb21tdW5pdGllcyA9IGF3YWl0IHRoaXMuc2VhcmNoQ29tbXVuaXRpZXMocXVlcnkpO1xuICAgICAgfVxuXG4gICAgICBpZiAodHlwZXNBcnJheS5pbmNsdWRlcygndXNlcnMnKSkge1xuICAgICAgICByZXN1bHRzLnVzZXJzID0gYXdhaXQgdGhpcy5zZWFyY2hVc2VycyhxdWVyeSk7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiByZXN1bHRzO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aHJvdyBuZXcgSW50ZXJuYWxTZXJ2ZXJFcnJvckV4Y2VwdGlvbihcbiAgICAgICAgYEZhaWxlZCB0byBwZXJmb3JtIGdsb2JhbCBzZWFyY2g6ICR7ZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiBTdHJpbmcoZXJyb3IpfWAsXG4gICAgICApO1xuICAgIH1cbiAgfVxufVxuIl0sInZlcnNpb24iOjN9