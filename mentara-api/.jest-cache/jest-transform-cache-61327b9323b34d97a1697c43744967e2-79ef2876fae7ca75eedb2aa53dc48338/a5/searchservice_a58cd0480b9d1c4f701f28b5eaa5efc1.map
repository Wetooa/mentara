{"file":"/home/wetooa/Documents/code/projects/mentara/mentara-api/src/search/search.service.ts","mappings":"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","names":[],"sources":["/home/wetooa/Documents/code/projects/mentara/mentara-api/src/search/search.service.ts"],"sourcesContent":["import { Injectable, InternalServerErrorException } from '@nestjs/common';\nimport { PrismaService } from '../providers/prisma-client.provider';\n\n@Injectable()\nexport class SearchService {\n  constructor(private readonly prisma: PrismaService) {}\n\n  async searchTherapists(\n    query: string,\n    filters?: {\n      province?: string;\n      location?: string;\n      expertise?: string[];\n      specialties?: string[];\n      maxHourlyRate?: number;\n      minExperience?: number;\n      experienceYears?: number;\n      rating?: number;\n      gender?: string;\n      languages?: string[];\n      availability?: any;\n      verifiedOnly?: boolean;\n      priceRange?: { min?: number; max?: number };\n    },\n  ) {\n    try {\n      const where: any = {\n        status: 'approved',\n        OR: [\n          {\n            user: {\n              firstName: { contains: query, mode: 'insensitive' },\n            },\n          },\n          {\n            user: {\n              lastName: { contains: query, mode: 'insensitive' },\n            },\n          },\n          {\n            bio: { contains: query, mode: 'insensitive' },\n          },\n          {\n            expertise: { hasSome: [query] },\n          },\n        ],\n      };\n\n      if (filters) {\n        if (filters.province) {\n          where.province = filters.province;\n        }\n        if (filters.expertise && filters.expertise.length > 0) {\n          where.expertise = { hasSome: filters.expertise };\n        }\n        if (filters.maxHourlyRate) {\n          where.hourlyRate = { lte: filters.maxHourlyRate };\n        }\n        if (filters.minExperience) {\n          where.yearsOfExperience = { gte: filters.minExperience };\n        }\n      }\n\n      return this.prisma.therapist.findMany({\n        where,\n        include: {\n          user: {\n            select: {\n              id: true,\n              firstName: true,\n              lastName: true,\n              avatarUrl: true,\n            },\n          },\n        },\n        orderBy: { createdAt: 'desc' },\n        take: 20,\n      });\n    } catch (error) {\n      throw new InternalServerErrorException(\n        `Failed to search therapists: ${error instanceof Error ? error.message : String(error)}`,\n      );\n    }\n  }\n\n  async searchPosts(query: string, communityId?: string) {\n    try {\n      const where: any = {\n        OR: [\n          { title: { contains: query, mode: 'insensitive' } },\n          { content: { contains: query, mode: 'insensitive' } },\n          { tags: { hasSome: [query] } },\n        ],\n      };\n\n      if (communityId) {\n        where.communityId = communityId;\n      }\n\n      return this.prisma.post.findMany({\n        where,\n        include: {\n          user: {\n            select: {\n              id: true,\n              firstName: true,\n              lastName: true,\n              avatarUrl: true,\n            },\n          },\n          room: {\n            include: {\n              roomGroup: {\n                include: {\n                  community: {\n                    select: {\n                      id: true,\n                      name: true,\n                      slug: true,\n                    },\n                  },\n                },\n              },\n            },\n          },\n          _count: {\n            select: {\n              hearts: true,\n              comments: true,\n            },\n          },\n        },\n        orderBy: { createdAt: 'desc' },\n        take: 20,\n      });\n    } catch (error) {\n      throw new InternalServerErrorException(\n        `Failed to search posts: ${error instanceof Error ? error.message : String(error)}`,\n      );\n    }\n  }\n\n  async searchCommunities(query: string) {\n    try {\n      return this.prisma.community.findMany({\n        where: {\n          OR: [\n            { name: { contains: query, mode: 'insensitive' } },\n            { description: { contains: query, mode: 'insensitive' } },\n          ],\n        },\n        include: {\n          _count: {\n            select: {\n              memberships: true,\n            },\n          },\n        },\n        orderBy: { createdAt: 'desc' },\n        take: 20,\n      });\n    } catch (error) {\n      throw new InternalServerErrorException(\n        `Failed to search communities: ${error instanceof Error ? error.message : String(error)}`,\n      );\n    }\n  }\n\n  async searchUsers(query: string, role?: string) {\n    try {\n      const where: any = {\n        OR: [\n          { firstName: { contains: query, mode: 'insensitive' } },\n          { lastName: { contains: query, mode: 'insensitive' } },\n          { email: { contains: query, mode: 'insensitive' } },\n        ],\n      };\n\n      if (role) {\n        where.role = role;\n      }\n\n      return this.prisma.user.findMany({\n        where,\n        select: {\n          id: true,\n          firstName: true,\n          lastName: true,\n          email: true,\n          avatarUrl: true,\n          role: true,\n          createdAt: true,\n        },\n        orderBy: { createdAt: 'desc' },\n        take: 20,\n      });\n    } catch (error) {\n      throw new InternalServerErrorException(\n        `Failed to search users: ${error instanceof Error ? error.message : String(error)}`,\n      );\n    }\n  }\n\n  async globalSearch(\n    query: string,\n    types?:\n      | ('therapists' | 'posts' | 'communities' | 'users')[]\n      | 'therapists'\n      | 'posts'\n      | 'communities'\n      | 'users',\n  ) {\n    try {\n      const results: any = {};\n\n      // Handle both single type and array of types\n      const typesArray = Array.isArray(types)\n        ? types\n        : types\n          ? [types]\n          : ['therapists', 'posts', 'communities', 'users'];\n\n      if (typesArray.includes('therapists')) {\n        results.therapists = await this.searchTherapists(query);\n      }\n\n      if (typesArray.includes('posts')) {\n        results.posts = await this.searchPosts(query);\n      }\n\n      if (typesArray.includes('communities')) {\n        results.communities = await this.searchCommunities(query);\n      }\n\n      if (typesArray.includes('users')) {\n        results.users = await this.searchUsers(query);\n      }\n\n      return results;\n    } catch (error) {\n      throw new InternalServerErrorException(\n        `Failed to perform global search: ${error instanceof Error ? error.message : String(error)}`,\n      );\n    }\n  }\n}\n"],"version":3}