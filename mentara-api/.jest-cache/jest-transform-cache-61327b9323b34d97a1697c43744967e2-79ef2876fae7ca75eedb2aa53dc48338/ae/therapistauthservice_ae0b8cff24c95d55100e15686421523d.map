{"file":"/home/wetooa/Documents/code/projects/mentara/mentara-api/src/auth/services/therapist-auth.service.ts","mappings":";;;;;;;;;;;;;AAAA,2CAKwB;AACxB,mFAAuE;AACvE,mDAA+C;AAC/C,6EAAwE;AACxE,gEAA4D;AAC5D,6FAAwF;AACxF,iGAA4F;AAM5F,iCAAiC;AAG1B,IAAM,oBAAoB,GAA1B,MAAM,oBAAoB;IAEZ;IACA;IACA;IACA;IACA;IACA;IANnB,YACmB,MAAqB,EACrB,YAA0B,EAC1B,wBAAkD,EAClD,YAA0B,EAC1B,sBAA8C,EAC9C,2BAAwD;QALxD,WAAM,GAAN,MAAM,CAAe;QACrB,iBAAY,GAAZ,YAAY,CAAc;QAC1B,6BAAwB,GAAxB,wBAAwB,CAA0B;QAClD,iBAAY,GAAZ,YAAY,CAAc;QAC1B,2BAAsB,GAAtB,sBAAsB,CAAwB;QAC9C,gCAA2B,GAA3B,2BAA2B,CAA6B;IACxE,CAAC;IAEJ,KAAK,CAAC,iBAAiB,CACrB,KAAa,EACb,QAAgB,EAChB,SAAiB,EACjB,QAAgB;QAEhB,+BAA+B;QAC/B,MAAM,YAAY,GAAG,MAAM,IAAI,CAAC,MAAM,CAAC,IAAI,CAAC,UAAU,CAAC;YACrD,KAAK,EAAE,EAAE,KAAK,EAAE;SACjB,CAAC,CAAC;QAEH,IAAI,YAAY,EAAE,CAAC;YACjB,MAAM,IAAI,4BAAmB,CAAC,qCAAqC,CAAC,CAAC;QACvE,CAAC;QAED,gBAAgB;QAChB,MAAM,cAAc,GAAG,MAAM,MAAM,CAAC,IAAI,CAAC,QAAQ,EAAE,EAAE,CAAC,CAAC;QAEvD,mDAAmD;QACnD,MAAM,MAAM,GAAG,MAAM,IAAI,CAAC,MAAM,CAAC,YAAY,CAAC,KAAK,EAAE,EAAE,EAAE,EAAE;YACzD,MAAM,IAAI,GAAG,MAAM,EAAE,CAAC,IAAI,CAAC,MAAM,CAAC;gBAChC,IAAI,EAAE;oBACJ,KAAK;oBACL,QAAQ,EAAE,cAAc;oBACxB,SAAS;oBACT,QAAQ;oBACR,IAAI,EAAE,WAAW;oBACjB,aAAa,EAAE,KAAK;iBACrB;aACF,CAAC,CAAC;YAEH,MAAM,SAAS,GAAG,MAAM,EAAE,CAAC,SAAS,CAAC,MAAM,CAAC;gBAC1C,IAAI,EAAE;oBACJ,MAAM,EAAE,IAAI,CAAC,EAAE;oBACf,MAAM,EAAE,SAAS;oBACjB,MAAM,EAAE,EAAE;oBACV,QAAQ,EAAE,EAAE;oBACZ,YAAY,EAAE,EAAE;oBAChB,uBAAuB,EAAE,EAAE;oBAC3B,aAAa,EAAE,EAAE;oBACjB,gBAAgB,EAAE,EAAE;oBACpB,uBAAuB,EAAE,IAAI,IAAI,EAAE;oBACnC,iBAAiB,EAAE,IAAI,IAAI,EAAE;oBAC7B,aAAa,EAAE,EAAE;oBACjB,UAAU,EAAE,CAAC;oBACb,2BAA2B,EAAE,KAAK;oBAClC,iCAAiC,EAAE,KAAK;oBACxC,0BAA0B,EAAE,KAAK;oBACjC,kCAAkC,EAAE,KAAK;oBACzC,qBAAqB,EAAE,EAAE;iBAC1B;aACF,CAAC,CAAC;YAEH,OAAO,EAAE,IAAI,EAAE,SAAS,EAAE,CAAC;QAC7B,CAAC,CAAC,CAAC;QAEH,kBAAkB;QAClB,MAAM,MAAM,GAAG,MAAM,IAAI,CAAC,YAAY,CAAC,iBAAiB,CACtD,MAAM,CAAC,IAAI,CAAC,EAAE,EACd,MAAM,CAAC,IAAI,CAAC,KAAK,EACjB,MAAM,CAAC,IAAI,CAAC,IAAI,CACjB,CAAC;QAEF,0BAA0B;QAC1B,MAAM,IAAI,CAAC,wBAAwB,CAAC,qBAAqB,CAAC,MAAM,CAAC,IAAI,CAAC,EAAE,CAAC,CAAC;QAE1E,OAAO;YACL,IAAI,EAAE,MAAM,CAAC,IAAI;YACjB,MAAM;YACN,OAAO,EACL,oGAAoG;SACvG,CAAC;IACJ,CAAC;IAED,KAAK,CAAC,cAAc,CAClB,KAAa,EACb,QAAgB,EAChB,SAAkB,EAClB,SAAkB;QAElB,gCAAgC;QAChC,MAAM,IAAI,GAAG,MAAM,IAAI,CAAC,MAAM,CAAC,IAAI,CAAC,SAAS,CAAC;YAC5C,KAAK,EAAE;gBACL,KAAK;gBACL,IAAI,EAAE,WAAW;aAClB;YACD,OAAO,EAAE;gBACP,SAAS,EAAE,IAAI;aAChB;SACF,CAAC,CAAC;QAEH,IAAI,CAAC,IAAI,EAAE,CAAC;YACV,MAAM,IAAI,8BAAqB,CAAC,qBAAqB,CAAC,CAAC;QACzD,CAAC;QAED,6BAA6B;QAC7B,IAAI,IAAI,CAAC,YAAY,IAAI,IAAI,CAAC,YAAY,GAAG,IAAI,IAAI,EAAE,EAAE,CAAC;YACxD,MAAM,IAAI,8BAAqB,CAC7B,4DAA4D,CAC7D,CAAC;QACJ,CAAC;QAED,kBAAkB;QAClB,IAAI,CAAC,IAAI,CAAC,QAAQ,EAAE,CAAC;YACnB,MAAM,IAAI,8BAAqB,CAAC,0BAA0B,CAAC,CAAC;QAC9D,CAAC;QACD,MAAM,eAAe,GAAG,MAAM,MAAM,CAAC,OAAO,CAAC,QAAQ,EAAE,IAAI,CAAC,QAAQ,CAAC,CAAC;QACtE,IAAI,CAAC,eAAe,EAAE,CAAC;YACrB,+BAA+B;YAC/B,MAAM,IAAI,CAAC,iBAAiB,CAAC,IAAI,CAAC,EAAE,CAAC,CAAC;YACtC,MAAM,IAAI,8BAAqB,CAAC,qBAAqB,CAAC,CAAC;QACzD,CAAC;QAED,iDAAiD;QACjD,MAAM,IAAI,CAAC,MAAM,CAAC,IAAI,CAAC,MAAM,CAAC;YAC5B,KAAK,EAAE,EAAE,EAAE,EAAE,IAAI,CAAC,EAAE,EAAE;YACtB,IAAI,EAAE;gBACJ,gBAAgB,EAAE,CAAC;gBACnB,YAAY,EAAE,IAAI;gBAClB,WAAW,EAAE,IAAI,IAAI,EAAE;aACxB;SACF,CAAC,CAAC;QAEH,kBAAkB;QAClB,MAAM,MAAM,GAAG,MAAM,IAAI,CAAC,YAAY,CAAC,iBAAiB,CACtD,IAAI,CAAC,EAAE,EACP,IAAI,CAAC,KAAK,EACV,IAAI,CAAC,IAAI,EACT,SAAS,EACT,SAAS,CACV,CAAC;QAEF,OAAO;YACL,IAAI;YACJ,MAAM;SACP,CAAC;IACJ,CAAC;IAED,KAAK,CAAC,mBAAmB,CAAC,MAAc;QACtC,MAAM,IAAI,GAAG,MAAM,IAAI,CAAC,MAAM,CAAC,IAAI,CAAC,UAAU,CAAC;YAC7C,KAAK,EAAE,EAAE,EAAE,EAAE,MAAM,EAAE;YACrB,OAAO,EAAE;gBACP,SAAS,EAAE;oBACT,OAAO,EAAE;wBACP,eAAe,EAAE;4BACf,OAAO,EAAE;gCACP,MAAM,EAAE;oCACN,OAAO,EAAE;wCACP,IAAI,EAAE;4CACJ,MAAM,EAAE;gDACN,EAAE,EAAE,IAAI;gDACR,SAAS,EAAE,IAAI;gDACf,QAAQ,EAAE,IAAI;gDACd,KAAK,EAAE,IAAI;gDACX,SAAS,EAAE,IAAI;6CAChB;yCACF;qCACF;iCACF;6BACF;yBACF;qBACF;iBACF;aACF;SACF,CAAC,CAAC;QAEH,IAAI,CAAC,IAAI,IAAI,IAAI,CAAC,IAAI,KAAK,WAAW,EAAE,CAAC;YACvC,MAAM,IAAI,8BAAqB,CAAC,qBAAqB,CAAC,CAAC;QACzD,CAAC;QAED,OAAO,IAAI,CAAC;IACd,CAAC;IAED,4EAA4E;IAC5E,KAAK,CAAC,8BAA8B,CAClC,eAA8C,EAC9C,KAA4B,EAC5B,WAAmC;QAEnC,OAAO,IAAI,CAAC,2BAA2B,CAAC,8BAA8B,CACpE,eAAe,EACf,KAAK,EACL,WAAW,CACZ,CAAC;IACJ,CAAC;IAED,KAAK,CAAC,kBAAkB,CAAC,MAIxB;QAMC,OAAO,IAAI,CAAC,2BAA2B,CAAC,kBAAkB,CAAC,MAAM,CAAC,CAAC;IACrE,CAAC;IAED,KAAK,CAAC,kBAAkB,CACtB,EAAU;QAEV,OAAO,IAAI,CAAC,2BAA2B,CAAC,kBAAkB,CAAC,EAAE,CAAC,CAAC;IACjE,CAAC;IAED,KAAK,CAAC,uBAAuB,CAC3B,EAAU,EACV,UAAsC;QAMtC,OAAO,IAAI,CAAC,2BAA2B,CAAC,uBAAuB,CAC7D,EAAE,EACF,UAAU,CACX,CAAC;IACJ,CAAC;IAED,KAAK,CAAC,mBAAmB,CAAC,aAAqB;QAQ7C,OAAO,IAAI,CAAC,2BAA2B,CAAC,mBAAmB,CAAC,aAAa,CAAC,CAAC;IAC7E,CAAC;IAEO,KAAK,CAAC,iBAAiB,CAAC,MAAc;QAC5C,MAAM,IAAI,GAAG,MAAM,IAAI,CAAC,MAAM,CAAC,IAAI,CAAC,UAAU,CAAC;YAC7C,KAAK,EAAE,EAAE,EAAE,EAAE,MAAM,EAAE;YACrB,MAAM,EAAE,EAAE,gBAAgB,EAAE,IAAI,EAAE;SACnC,CAAC,CAAC;QAEH,MAAM,cAAc,GAAG,CAAC,IAAI,EAAE,gBAAgB,IAAI,CAAC,CAAC,GAAG,CAAC,CAAC;QACzD,MAAM,WAAW,GAAG,CAAC,CAAC;QACtB,MAAM,eAAe,GAAG,EAAE,GAAG,EAAE,GAAG,IAAI,CAAC,CAAC,aAAa;QAErD,MAAM,UAAU,GAAQ;YACtB,gBAAgB,EAAE,cAAc;SACjC,CAAC;QAEF,IAAI,cAAc,IAAI,WAAW,EAAE,CAAC;YAClC,UAAU,CAAC,YAAY,GAAG,IAAI,IAAI,CAAC,IAAI,CAAC,GAAG,EAAE,GAAG,eAAe,CAAC,CAAC;QACnE,CAAC;QAED,MAAM,IAAI,CAAC,MAAM,CAAC,IAAI,CAAC,MAAM,CAAC;YAC5B,KAAK,EAAE,EAAE,EAAE,EAAE,MAAM,EAAE;YACrB,IAAI,EAAE,UAAU;SACjB,CAAC,CAAC;IACL,CAAC;CACF,CAAA;AAvQY,oDAAoB;+BAApB,oBAAoB;IADhC,IAAA,mBAAU,GAAE;yDAGgB,sCAAa,oBAAb,sCAAa,oDACP,4BAAY,oBAAZ,4BAAY,oDACA,qDAAwB,oBAAxB,qDAAwB,oDACpC,4BAAY,oBAAZ,4BAAY,oDACF,iDAAsB,oBAAtB,iDAAsB,oDACjB,2DAA2B,oBAA3B,2DAA2B;GAPhE,oBAAoB,CAuQhC","names":[],"sources":["/home/wetooa/Documents/code/projects/mentara/mentara-api/src/auth/services/therapist-auth.service.ts"],"sourcesContent":["import {\n  Injectable,\n  UnauthorizedException,\n  BadRequestException,\n  NotFoundException,\n} from '@nestjs/common';\nimport { PrismaService } from '../../providers/prisma-client.provider';\nimport { TokenService } from './token.service';\nimport { EmailVerificationService } from './email-verification.service';\nimport { EmailService } from '../../services/email.service';\nimport { SupabaseStorageService } from '../../common/services/supabase-storage.service';\nimport { TherapistApplicationService } from '../../therapist/therapist-application.service';\nimport { type TherapistApplicationCreateDto } from 'mentara-commons';\nimport {\n  TherapistApplicationResponse,\n  ApplicationStatusUpdateDto,\n} from '../../therapist/interfaces/therapist-application.interfaces';\nimport * as bcrypt from 'bcrypt';\n\n@Injectable()\nexport class TherapistAuthService {\n  constructor(\n    private readonly prisma: PrismaService,\n    private readonly tokenService: TokenService,\n    private readonly emailVerificationService: EmailVerificationService,\n    private readonly emailService: EmailService,\n    private readonly supabaseStorageService: SupabaseStorageService,\n    private readonly therapistApplicationService: TherapistApplicationService,\n  ) {}\n\n  async registerTherapist(\n    email: string,\n    password: string,\n    firstName: string,\n    lastName: string,\n  ) {\n    // Check if user already exists\n    const existingUser = await this.prisma.user.findUnique({\n      where: { email },\n    });\n\n    if (existingUser) {\n      throw new BadRequestException('User with this email already exists');\n    }\n\n    // Hash password\n    const hashedPassword = await bcrypt.hash(password, 12);\n\n    // Create user and therapist profile in transaction\n    const result = await this.prisma.$transaction(async (tx) => {\n      const user = await tx.user.create({\n        data: {\n          email,\n          password: hashedPassword,\n          firstName,\n          lastName,\n          role: 'therapist',\n          emailVerified: false,\n        },\n      });\n\n      const therapist = await tx.therapist.create({\n        data: {\n          userId: user.id,\n          status: 'pending',\n          mobile: '',\n          province: '',\n          providerType: '',\n          professionalLicenseType: '',\n          isPRCLicensed: '',\n          prcLicenseNumber: '',\n          expirationDateOfLicense: new Date(),\n          practiceStartDate: new Date(),\n          sessionLength: '',\n          hourlyRate: 0,\n          providedOnlineTherapyBefore: false,\n          comfortableUsingVideoConferencing: false,\n          compliesWithDataPrivacyAct: false,\n          willingToAbideByPlatformGuidelines: false,\n          treatmentSuccessRates: {},\n        },\n      });\n\n      return { user, therapist };\n    });\n\n    // Generate tokens\n    const tokens = await this.tokenService.generateTokenPair(\n      result.user.id,\n      result.user.email,\n      result.user.role,\n    );\n\n    // Send verification email\n    await this.emailVerificationService.sendVerificationEmail(result.user.id);\n\n    return {\n      user: result.user,\n      tokens,\n      message:\n        'Therapist registration successful. Please complete your application and submit required documents.',\n    };\n  }\n\n  async loginTherapist(\n    email: string,\n    password: string,\n    ipAddress?: string,\n    userAgent?: string,\n  ) {\n    // Find user with therapist role\n    const user = await this.prisma.user.findFirst({\n      where: {\n        email,\n        role: 'therapist',\n      },\n      include: {\n        therapist: true,\n      },\n    });\n\n    if (!user) {\n      throw new UnauthorizedException('Invalid credentials');\n    }\n\n    // Check if account is locked\n    if (user.lockoutUntil && user.lockoutUntil > new Date()) {\n      throw new UnauthorizedException(\n        'Account is temporarily locked due to failed login attempts',\n      );\n    }\n\n    // Verify password\n    if (!user.password) {\n      throw new UnauthorizedException('Account setup incomplete');\n    }\n    const isPasswordValid = await bcrypt.compare(password, user.password);\n    if (!isPasswordValid) {\n      // Increment failed login count\n      await this.handleFailedLogin(user.id);\n      throw new UnauthorizedException('Invalid credentials');\n    }\n\n    // Reset failed login count and update last login\n    await this.prisma.user.update({\n      where: { id: user.id },\n      data: {\n        failedLoginCount: 0,\n        lockoutUntil: null,\n        lastLoginAt: new Date(),\n      },\n    });\n\n    // Generate tokens\n    const tokens = await this.tokenService.generateTokenPair(\n      user.id,\n      user.email,\n      user.role,\n      ipAddress,\n      userAgent,\n    );\n\n    return {\n      user,\n      tokens,\n    };\n  }\n\n  async getTherapistProfile(userId: string) {\n    const user = await this.prisma.user.findUnique({\n      where: { id: userId },\n      include: {\n        therapist: {\n          include: {\n            assignedClients: {\n              include: {\n                client: {\n                  include: {\n                    user: {\n                      select: {\n                        id: true,\n                        firstName: true,\n                        lastName: true,\n                        email: true,\n                        avatarUrl: true,\n                      },\n                    },\n                  },\n                },\n              },\n            },\n          },\n        },\n      },\n    });\n\n    if (!user || user.role !== 'therapist') {\n      throw new UnauthorizedException('Therapist not found');\n    }\n\n    return user;\n  }\n\n  // Application management methods (delegated to TherapistApplicationService)\n  async createApplicationWithDocuments(\n    applicationData: TherapistApplicationCreateDto,\n    files: Express.Multer.File[],\n    fileTypeMap: Record<string, string>,\n  ) {\n    return this.therapistApplicationService.createApplicationWithDocuments(\n      applicationData,\n      files,\n      fileTypeMap,\n    );\n  }\n\n  async getAllApplications(params: {\n    status?: string;\n    page: number;\n    limit: number;\n  }): Promise<{\n    applications: TherapistApplicationResponse[];\n    totalCount: number;\n    page: number;\n    totalPages: number;\n  }> {\n    return this.therapistApplicationService.getAllApplications(params);\n  }\n\n  async getApplicationById(\n    id: string,\n  ): Promise<TherapistApplicationResponse | null> {\n    return this.therapistApplicationService.getApplicationById(id);\n  }\n\n  async updateApplicationStatus(\n    id: string,\n    updateData: ApplicationStatusUpdateDto,\n  ): Promise<{\n    success: boolean;\n    message: string;\n    credentials?: { email: string; password: string };\n  }> {\n    return this.therapistApplicationService.updateApplicationStatus(\n      id,\n      updateData,\n    );\n  }\n\n  async getApplicationFiles(applicationId: string): Promise<\n    Array<{\n      id: string;\n      fileName: string;\n      fileUrl: string;\n      uploadedAt: string;\n    }>\n  > {\n    return this.therapistApplicationService.getApplicationFiles(applicationId);\n  }\n\n  private async handleFailedLogin(userId: string) {\n    const user = await this.prisma.user.findUnique({\n      where: { id: userId },\n      select: { failedLoginCount: true },\n    });\n\n    const newFailedCount = (user?.failedLoginCount || 0) + 1;\n    const maxAttempts = 5;\n    const lockoutDuration = 30 * 60 * 1000; // 30 minutes\n\n    const updateData: any = {\n      failedLoginCount: newFailedCount,\n    };\n\n    if (newFailedCount >= maxAttempts) {\n      updateData.lockoutUntil = new Date(Date.now() + lockoutDuration);\n    }\n\n    await this.prisma.user.update({\n      where: { id: userId },\n      data: updateData,\n    });\n  }\n}\n"],"version":3}