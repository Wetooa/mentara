21d574eb737881ed823db88eb1ac0cb8
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var TherapistRecommendationService_1;
var _a, _b, _c, _d, _e;
Object.defineProperty(exports, "__esModule", { value: true });
exports.TherapistRecommendationService = void 0;
const common_1 = require("@nestjs/common");
const prisma_client_provider_1 = require("../providers/prisma-client.provider");
const advanced_matching_service_1 = require("./services/advanced-matching.service");
const compatibility_analysis_service_1 = require("./services/compatibility-analysis.service");
const matching_analytics_service_1 = require("./services/matching-analytics.service");
const pre_assessment_service_1 = require("../pre-assessment/pre-assessment.service");
let TherapistRecommendationService = TherapistRecommendationService_1 = class TherapistRecommendationService {
    prisma;
    advancedMatching;
    compatibilityAnalysis;
    matchingAnalytics;
    preAssessmentService;
    logger = new common_1.Logger(TherapistRecommendationService_1.name);
    constructor(prisma, advancedMatching, compatibilityAnalysis, matchingAnalytics, preAssessmentService) {
        this.prisma = prisma;
        this.advancedMatching = advancedMatching;
        this.compatibilityAnalysis = compatibilityAnalysis;
        this.matchingAnalytics = matchingAnalytics;
        this.preAssessmentService = preAssessmentService;
    }
    calculateYearsOfExperience(startDate) {
        const now = new Date();
        let years = now.getFullYear() - startDate.getFullYear();
        if (now.getMonth() < startDate.getMonth() ||
            (now.getMonth() === startDate.getMonth() &&
                now.getDate() < startDate.getDate())) {
            years--;
        }
        return years;
    }
    async getRecommendedTherapists(request) {
        // Input validation
        if (!request?.userId) {
            throw new common_1.BadRequestException('User ID is required');
        }
        if (request.limit && (request.limit < 1 || request.limit > 100)) {
            throw new common_1.BadRequestException('Limit must be between 1 and 100');
        }
        this.logger.log(`Getting enhanced recommendations for user ${request.userId} with limit ${request.limit || 10}`);
        try {
            // Get user's comprehensive data including preferences
            const user = await this.prisma.client.findUnique({
                where: { userId: request.userId },
                include: {
                    preAssessment: true,
                    clientPreferences: true,
                    user: true,
                },
            });
            if (!user) {
                this.logger.warn(`User not found: ${request.userId}`);
                throw new common_1.NotFoundException('User not found');
            }
            if (!user.preAssessment) {
                this.logger.warn(`No pre-assessment found for user: ${request.userId}`);
                throw new common_1.NotFoundException('No pre-assessment found for user');
            }
            // Get comprehensive clinical analysis for enhanced matching
            let clinicalAnalysis;
            try {
                clinicalAnalysis =
                    await this.preAssessmentService.getComprehensiveClinicalAnalysis(request.userId);
                this.logger.log(`Enhanced clinical insights available: ${clinicalAnalysis.clinicalProfile.primaryConditions.length} primary conditions`);
            }
            catch (analysisError) {
                this.logger.warn('Advanced clinical analysis unavailable, using basic assessment:', analysisError);
                clinicalAnalysis = null;
            }
            // Extract user conditions and severity levels
            const userConditions = this.extractUserConditions(user.preAssessment);
            const severityLevels = user.preAssessment.severityLevels;
            // Enhanced therapist filtering based on clinical insights
            const therapistWhere = {
                status: 'approved',
                ...(request.province && { province: request.province }),
                ...(request.maxHourlyRate && {
                    hourlyRate: { lte: request.maxHourlyRate },
                }),
            };
            // Apply enhanced filtering based on clinical analysis
            if (clinicalAnalysis?.treatmentPlan?.therapistCriteria) {
                const criteria = clinicalAnalysis.treatmentPlan.therapistCriteria;
                // Filter by required specializations
                if (criteria.requiredSpecializations.length > 0) {
                    therapistWhere.OR = criteria.requiredSpecializations.map((spec) => ({
                        expertise: { has: spec },
                    }));
                }
                // Filter by experience level
                if (criteria.experienceLevel !== 'any') {
                    const minYears = {
                        intermediate: 3,
                        senior: 7,
                        expert: 12,
                    }[criteria.experienceLevel] || 0;
                    therapistWhere.yearsOfExperience = { gte: minYears };
                }
            }
            // Fetch therapists with comprehensive data
            const therapists = await this.prisma.therapist.findMany({
                where: therapistWhere,
                orderBy: { createdAt: 'desc' },
                take: Math.min(request.limit ?? 10, 50), // Increase limit for better filtering
                include: {
                    user: true,
                    reviews: {
                        where: { status: 'APPROVED' },
                        select: {
                            rating: true,
                            status: true,
                        },
                    },
                },
            });
            // Use advanced matching algorithm with proper error handling and logging
            const therapistScores = [];
            let advancedMatchingFailures = 0;
            for (const therapist of therapists) {
                try {
                    // Cast user to proper type now that we've validated all required fields exist
                    const clientForMatching = {
                        ...user,
                        preAssessment: user.preAssessment,
                        clientPreferences: user.clientPreferences || [],
                        user: user.user,
                    };
                    const therapistForMatching = {
                        ...therapist,
                        user: therapist.user,
                        reviews: therapist.reviews || [],
                    };
                    const score = await this.advancedMatching.calculateAdvancedMatch(clientForMatching, therapistForMatching);
                    therapistScores.push(score);
                }
                catch (error) {
                    advancedMatchingFailures++;
                    // Log detailed error information for debugging
                    this.logger.error(`Advanced matching failed for therapist ${therapist.userId}`, {
                        error: error instanceof Error ? error.message : String(error),
                        stack: error instanceof Error ? error.stack : undefined,
                        therapistId: therapist.userId,
                        userId: request.userId,
                    });
                    // Fallback to basic scoring with clear indication this is a fallback
                    try {
                        const basicScore = this.calculateMatchScore(therapist, userConditions);
                        const therapistForMatching = {
                            ...therapist,
                            user: therapist.user,
                            reviews: therapist.reviews || [],
                        };
                        therapistScores.push({
                            therapist: therapistForMatching,
                            totalScore: basicScore,
                            breakdown: {
                                conditionScore: Math.round(basicScore * 0.6),
                                approachScore: 0,
                                experienceScore: Math.round(basicScore * 0.4),
                                reviewScore: 0,
                                logisticsScore: 0,
                            },
                            matchExplanation: {
                                primaryMatches: this.getPrimaryConditions(userConditions),
                                secondaryMatches: this.getSecondaryConditions(userConditions),
                                approachMatches: [],
                                experienceYears: this.calculateYearsOfExperience(therapist.practiceStartDate),
                                averageRating: 0,
                                totalReviews: 0,
                                successRates: {},
                            },
                        });
                        this.logger.warn(`Using basic scoring fallback for therapist ${therapist.userId} due to advanced matching failure`);
                    }
                    catch (basicScoringError) {
                        // If even basic scoring fails, log and skip this therapist
                        this.logger.error(`Both advanced and basic scoring failed for therapist ${therapist.userId}`, {
                            advancedError: error instanceof Error ? error.message : String(error),
                            basicError: basicScoringError instanceof Error
                                ? basicScoringError.message
                                : String(basicScoringError),
                            therapistId: therapist.userId,
                            userId: request.userId,
                        });
                        // Skip this therapist entirely
                        continue;
                    }
                }
            }
            // Log summary of matching performance
            this.logger.log(`Matching completed for user ${request.userId}: ${therapistScores.length} successful matches, ${advancedMatchingFailures} fallbacks`);
            // Sort by total score descending
            const sortedTherapistScores = therapistScores.sort((a, b) => b.totalScore - a.totalScore);
            // Take only the requested number of results
            const finalResults = sortedTherapistScores.slice(0, request.limit ?? 10);
            // Track recommendation analytics
            await this.matchingAnalytics.trackRecommendation(request.userId, finalResults, 'advanced_v1.0');
            // Transform to expected format with enhanced insights
            const therapistsWithScores = finalResults.map((score) => {
                const therapistData = {
                    ...score.therapist,
                    matchScore: score.totalScore,
                    scoreBreakdown: score.breakdown,
                    matchExplanation: score.matchExplanation,
                };
                // Add clinical insights if available
                if (clinicalAnalysis) {
                    therapistData.clinicalMatch = {
                        urgencyAlignment: this.assessUrgencyAlignment(score.therapist, clinicalAnalysis),
                        specializationMatch: this.assessSpecializationMatch(score.therapist, clinicalAnalysis),
                        experienceAdequacy: this.assessExperienceAdequacy(score.therapist, clinicalAnalysis),
                        approachCompatibility: this.assessApproachCompatibility(score.therapist, clinicalAnalysis),
                    };
                }
                return therapistData;
            });
            // Determine primary and secondary conditions (enhanced if clinical analysis available)
            const primaryConditions = clinicalAnalysis
                ? clinicalAnalysis.clinicalProfile.primaryConditions.map((pc) => pc.condition)
                : this.getPrimaryConditions(userConditions);
            const secondaryConditions = clinicalAnalysis
                ? clinicalAnalysis.clinicalProfile.secondaryConditions.map((sc) => sc.condition)
                : this.getSecondaryConditions(userConditions);
            return {
                totalCount: therapistsWithScores.length,
                userConditions: Object.keys(userConditions),
                therapists: therapistsWithScores,
                matchCriteria: {
                    primaryConditions,
                    secondaryConditions,
                    severityLevels,
                    ...(clinicalAnalysis && {
                        riskLevel: clinicalAnalysis.riskAssessment.overallRisk,
                        urgencyLevel: clinicalAnalysis.treatmentPlan.therapistCriteria.urgencyLevel,
                        requiredSpecializations: clinicalAnalysis.treatmentPlan.therapistCriteria
                            .requiredSpecializations,
                        preferredApproaches: clinicalAnalysis.treatmentPlan.therapistCriteria
                            .preferredApproaches,
                    }),
                },
                clinicalInsights: clinicalAnalysis
                    ? {
                        overallRiskLevel: clinicalAnalysis.clinicalProfile.overallRiskLevel,
                        primaryConditionsCount: clinicalAnalysis.clinicalProfile.primaryConditions.length,
                        therapeuticPriorities: clinicalAnalysis.clinicalProfile.therapeuticPriorities.slice(0, 3),
                        recommendedSessionFrequency: clinicalAnalysis.treatmentPlan.therapistCriteria
                            .sessionFrequency,
                    }
                    : null,
                page: 1,
                pageSize: request.limit ?? 10,
            };
        }
        catch (error) {
            // Handle specific error types with appropriate logging and responses
            if (error instanceof common_1.NotFoundException ||
                error instanceof common_1.BadRequestException) {
                // Re-throw validation and not found errors as-is
                throw error;
            }
            // Log unexpected errors with full context
            this.logger.error(`Unexpected error in getRecommendedTherapists for user ${request.userId}`, {
                error: error instanceof Error ? error.message : String(error),
                stack: error instanceof Error ? error.stack : undefined,
                userId: request.userId,
                requestParams: {
                    limit: request.limit,
                    province: request.province,
                    maxHourlyRate: request.maxHourlyRate,
                },
            });
            // Provide generic error message to client while logging specifics
            throw new common_1.InternalServerErrorException('Failed to get therapist recommendations. Please try again later.');
        }
    }
    /**
     * Get detailed compatibility analysis between a client and therapist
     */
    async getCompatibilityAnalysis(clientId, therapistId) {
        const client = await this.prisma.client.findUnique({
            where: { userId: clientId },
            include: {
                preAssessment: true,
                clientPreferences: true,
                user: true,
            },
        });
        const therapist = await this.prisma.therapist.findUnique({
            where: { userId: therapistId },
            include: {
                user: true,
                reviews: {
                    where: { status: 'APPROVED' },
                },
            },
        });
        if (!client || !therapist) {
            throw new common_1.NotFoundException('Client or therapist not found');
        }
        if (!client.preAssessment) {
            throw new common_1.NotFoundException('No pre-assessment found for client');
        }
        const compatibility = await this.compatibilityAnalysis.analyzeCompatibility(client, // Safe because we verified preAssessment exists above
        therapist);
        // Track compatibility analysis
        await this.matchingAnalytics.trackCompatibilityAnalysis(clientId, therapistId, compatibility, '1.0');
        return compatibility;
    }
    extractUserConditions(preAssessment) {
        const conditions = {};
        const severityLevels = preAssessment.severityLevels;
        const questionnaires = preAssessment.questionnaires;
        questionnaires.forEach((q) => {
            if (severityLevels[q]) {
                conditions[q] = severityLevels[q];
            }
        });
        return conditions;
    }
    calculateMatchScore(therapist, userConditions) {
        let score = 0;
        const expertise = therapist.expertise || [];
        Object.keys(userConditions).forEach((condition) => {
            if (expertise.includes(condition))
                score += 20;
        });
        score += Math.min(this.calculateYearsOfExperience(therapist.practiceStartDate) * 2, 20);
        // Add base score for experience
        score += therapist.yearsOfExperience ? therapist.yearsOfExperience * 2 : 0;
        return score;
    }
    getPrimaryConditions(userConditions) {
        return Object.entries(userConditions)
            .filter(([, severity]) => this.getSeverityWeight(severity) >= 4)
            .map(([condition]) => condition);
    }
    getSecondaryConditions(userConditions) {
        return Object.entries(userConditions)
            .filter(([, severity]) => {
            const weight = this.getSeverityWeight(severity);
            return weight >= 2 && weight < 4;
        })
            .map(([condition]) => condition);
    }
    getSeverityWeight(severity) {
        const severityWeights = {
            Minimal: 1,
            Mild: 2,
            Moderate: 3,
            'Moderately Severe': 4,
            Severe: 5,
            'Very Severe': 5,
            Extreme: 5,
            Low: 1,
            High: 4,
            Substantial: 4,
            Subclinical: 1,
            Clinical: 4,
            None: 0,
            Subthreshold: 2,
            Positive: 4,
            Negative: 0,
        };
        return severityWeights[severity] || 1;
    }
    /**
     * Assess how well therapist's availability aligns with client's urgency needs
     */
    assessUrgencyAlignment(therapist, clinicalAnalysis) {
        const urgencyLevel = clinicalAnalysis.treatmentPlan.therapistCriteria.urgencyLevel;
        const riskLevel = clinicalAnalysis.riskAssessment.overallRisk;
        let score = 70; // Base score
        let reasoning = 'Standard availability alignment';
        // Check if therapist can handle urgent cases
        if (urgencyLevel === 'immediate' || riskLevel === 'critical') {
            if (therapist.acceptsEmergencyAppointments ||
                therapist.hasImmediateAvailability) {
                score = 95;
                reasoning =
                    'Excellent for crisis intervention - immediate availability';
            }
            else {
                score = 30;
                reasoning = 'May not be suitable for immediate intervention needs';
            }
        }
        else if (urgencyLevel === 'high') {
            if (therapist.weeklyAvailability || therapist.flexibleScheduling) {
                score = 85;
                reasoning = 'Good availability for urgent therapeutic needs';
            }
        }
        return { score, reasoning };
    }
    /**
     * Assess therapist's specialization match with client's conditions
     */
    assessSpecializationMatch(therapist, clinicalAnalysis) {
        const requiredSpecs = clinicalAnalysis.treatmentPlan.therapistCriteria.requiredSpecializations;
        const therapistSpecs = [
            ...(therapist.expertise || []),
            ...(therapist.illnessSpecializations || []),
        ];
        const matchedSpecs = requiredSpecs.filter((req) => therapistSpecs.some((spec) => spec.toLowerCase().includes(req.toLowerCase()) ||
            req.toLowerCase().includes(spec.toLowerCase())));
        const matchRatio = requiredSpecs.length > 0 ? matchedSpecs.length / requiredSpecs.length : 1;
        const score = Math.round(matchRatio * 100);
        let reasoning = `Matches ${matchedSpecs.length}/${requiredSpecs.length} required specializations`;
        if (score >= 80)
            reasoning = 'Excellent specialization match';
        else if (score >= 60)
            reasoning = 'Good specialization alignment';
        else if (score >= 40)
            reasoning = 'Partial specialization match';
        else
            reasoning = 'Limited specialization match';
        return {
            score,
            matchedSpecializations: matchedSpecs,
            reasoning,
        };
    }
    /**
     * Assess if therapist has adequate experience for client's needs
     */
    assessExperienceAdequacy(therapist, clinicalAnalysis) {
        const requiredLevel = clinicalAnalysis.treatmentPlan.therapistCriteria.experienceLevel;
        const therapistYears = therapist.yearsOfExperience ||
            this.calculateYearsOfExperience(therapist.practiceStartDate);
        const requiredYears = {
            any: 0,
            intermediate: 3,
            senior: 7,
            expert: 12,
        }[requiredLevel] || 0;
        if (therapistYears >= requiredYears) {
            const score = Math.min(100, 70 + (therapistYears - requiredYears) * 3);
            return {
                score,
                reasoning: `${therapistYears} years experience meets ${requiredLevel} level requirement`,
            };
        }
        else {
            const score = Math.max(20, (therapistYears / requiredYears) * 60);
            return {
                score,
                reasoning: `${therapistYears} years experience below ${requiredLevel} level (${requiredYears}+ years)`,
            };
        }
    }
    /**
     * Assess therapist's therapeutic approach compatibility
     */
    assessApproachCompatibility(therapist, clinicalAnalysis) {
        const preferredApproaches = clinicalAnalysis.treatmentPlan.therapistCriteria.preferredApproaches;
        const therapistApproaches = [
            ...(therapist.approaches || []),
            ...(therapist.therapeuticApproachesUsedList || []),
        ];
        const matchedApproaches = preferredApproaches.filter((pref) => therapistApproaches.some((approach) => approach.toLowerCase().includes(pref.toLowerCase()) ||
            pref.toLowerCase().includes(approach.toLowerCase())));
        const matchRatio = preferredApproaches.length > 0
            ? matchedApproaches.length / preferredApproaches.length
            : 0.7;
        const score = Math.round(matchRatio * 100);
        let reasoning = `Matches ${matchedApproaches.length}/${preferredApproaches.length} preferred approaches`;
        if (score >= 80)
            reasoning = 'Excellent therapeutic approach match';
        else if (score >= 60)
            reasoning = 'Good approach compatibility';
        else if (score >= 40)
            reasoning = 'Some approach alignment';
        else
            reasoning = 'Limited approach match - may still be effective';
        return {
            score,
            matchedApproaches,
            reasoning,
        };
    }
};
exports.TherapistRecommendationService = TherapistRecommendationService;
exports.TherapistRecommendationService = TherapistRecommendationService = TherapistRecommendationService_1 = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [typeof (_a = typeof prisma_client_provider_1.PrismaService !== "undefined" && prisma_client_provider_1.PrismaService) === "function" ? _a : Object, typeof (_b = typeof advanced_matching_service_1.AdvancedMatchingService !== "undefined" && advanced_matching_service_1.AdvancedMatchingService) === "function" ? _b : Object, typeof (_c = typeof compatibility_analysis_service_1.CompatibilityAnalysisService !== "undefined" && compatibility_analysis_service_1.CompatibilityAnalysisService) === "function" ? _c : Object, typeof (_d = typeof matching_analytics_service_1.MatchingAnalyticsService !== "undefined" && matching_analytics_service_1.MatchingAnalyticsService) === "function" ? _d : Object, typeof (_e = typeof pre_assessment_service_1.PreAssessmentService !== "undefined" && pre_assessment_service_1.PreAssessmentService) === "function" ? _e : Object])
], TherapistRecommendationService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL3RoZXJhcGlzdC90aGVyYXBpc3QtcmVjb21tZW5kYXRpb24uc2VydmljZS50cyIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7OztBQUFBLDJDQU13QjtBQUN4QixnRkFBb0U7QUFNcEUsb0ZBSzhDO0FBQzlDLDhGQUF5RjtBQUN6RixzRkFBaUY7QUFDakYscUZBQWdGO0FBR3pFLElBQU0sOEJBQThCLHNDQUFwQyxNQUFNLDhCQUE4QjtJQUl0QjtJQUNBO0lBQ0E7SUFDQTtJQUNBO0lBUEYsTUFBTSxHQUFHLElBQUksZUFBTSxDQUFDLGdDQUE4QixDQUFDLElBQUksQ0FBQyxDQUFDO0lBRTFFLFlBQ21CLE1BQXFCLEVBQ3JCLGdCQUF5QyxFQUN6QyxxQkFBbUQsRUFDbkQsaUJBQTJDLEVBQzNDLG9CQUEwQztRQUoxQyxXQUFNLEdBQU4sTUFBTSxDQUFlO1FBQ3JCLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBeUI7UUFDekMsMEJBQXFCLEdBQXJCLHFCQUFxQixDQUE4QjtRQUNuRCxzQkFBaUIsR0FBakIsaUJBQWlCLENBQTBCO1FBQzNDLHlCQUFvQixHQUFwQixvQkFBb0IsQ0FBc0I7SUFDMUQsQ0FBQztJQUVJLDBCQUEwQixDQUFDLFNBQWU7UUFDaEQsTUFBTSxHQUFHLEdBQUcsSUFBSSxJQUFJLEVBQUUsQ0FBQztRQUN2QixJQUFJLEtBQUssR0FBRyxHQUFHLENBQUMsV0FBVyxFQUFFLEdBQUcsU0FBUyxDQUFDLFdBQVcsRUFBRSxDQUFDO1FBQ3hELElBQ0UsR0FBRyxDQUFDLFFBQVEsRUFBRSxHQUFHLFNBQVMsQ0FBQyxRQUFRLEVBQUU7WUFDckMsQ0FBQyxHQUFHLENBQUMsUUFBUSxFQUFFLEtBQUssU0FBUyxDQUFDLFFBQVEsRUFBRTtnQkFDdEMsR0FBRyxDQUFDLE9BQU8sRUFBRSxHQUFHLFNBQVMsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxFQUN0QyxDQUFDO1lBQ0QsS0FBSyxFQUFFLENBQUM7UUFDVixDQUFDO1FBQ0QsT0FBTyxLQUFLLENBQUM7SUFDZixDQUFDO0lBRUQsS0FBSyxDQUFDLHdCQUF3QixDQUM1QixPQUF1QztRQUV2QyxtQkFBbUI7UUFDbkIsSUFBSSxDQUFDLE9BQU8sRUFBRSxNQUFNLEVBQUUsQ0FBQztZQUNyQixNQUFNLElBQUksNEJBQW1CLENBQUMscUJBQXFCLENBQUMsQ0FBQztRQUN2RCxDQUFDO1FBRUQsSUFBSSxPQUFPLENBQUMsS0FBSyxJQUFJLENBQUMsT0FBTyxDQUFDLEtBQUssR0FBRyxDQUFDLElBQUksT0FBTyxDQUFDLEtBQUssR0FBRyxHQUFHLENBQUMsRUFBRSxDQUFDO1lBQ2hFLE1BQU0sSUFBSSw0QkFBbUIsQ0FBQyxpQ0FBaUMsQ0FBQyxDQUFDO1FBQ25FLENBQUM7UUFFRCxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FDYiw2Q0FBNkMsT0FBTyxDQUFDLE1BQU0sZUFBZSxPQUFPLENBQUMsS0FBSyxJQUFJLEVBQUUsRUFBRSxDQUNoRyxDQUFDO1FBRUYsSUFBSSxDQUFDO1lBQ0gsc0RBQXNEO1lBQ3RELE1BQU0sSUFBSSxHQUFHLE1BQU0sSUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsVUFBVSxDQUFDO2dCQUMvQyxLQUFLLEVBQUUsRUFBRSxNQUFNLEVBQUUsT0FBTyxDQUFDLE1BQU0sRUFBRTtnQkFDakMsT0FBTyxFQUFFO29CQUNQLGFBQWEsRUFBRSxJQUFJO29CQUNuQixpQkFBaUIsRUFBRSxJQUFJO29CQUN2QixJQUFJLEVBQUUsSUFBSTtpQkFDWDthQUNGLENBQUMsQ0FBQztZQUVILElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQztnQkFDVixJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxtQkFBbUIsT0FBTyxDQUFDLE1BQU0sRUFBRSxDQUFDLENBQUM7Z0JBQ3RELE1BQU0sSUFBSSwwQkFBaUIsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO1lBQ2hELENBQUM7WUFFRCxJQUFJLENBQUMsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO2dCQUN4QixJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxxQ0FBcUMsT0FBTyxDQUFDLE1BQU0sRUFBRSxDQUFDLENBQUM7Z0JBQ3hFLE1BQU0sSUFBSSwwQkFBaUIsQ0FBQyxrQ0FBa0MsQ0FBQyxDQUFDO1lBQ2xFLENBQUM7WUFFRCw0REFBNEQ7WUFDNUQsSUFBSSxnQkFBZ0IsQ0FBQztZQUNyQixJQUFJLENBQUM7Z0JBQ0gsZ0JBQWdCO29CQUNkLE1BQU0sSUFBSSxDQUFDLG9CQUFvQixDQUFDLGdDQUFnQyxDQUM5RCxPQUFPLENBQUMsTUFBTSxDQUNmLENBQUM7Z0JBQ0osSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQ2IseUNBQXlDLGdCQUFnQixDQUFDLGVBQWUsQ0FBQyxpQkFBaUIsQ0FBQyxNQUFNLHFCQUFxQixDQUN4SCxDQUFDO1lBQ0osQ0FBQztZQUFDLE9BQU8sYUFBYSxFQUFFLENBQUM7Z0JBQ3ZCLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUNkLGlFQUFpRSxFQUNqRSxhQUFhLENBQ2QsQ0FBQztnQkFDRixnQkFBZ0IsR0FBRyxJQUFJLENBQUM7WUFDMUIsQ0FBQztZQUVELDhDQUE4QztZQUM5QyxNQUFNLGNBQWMsR0FBRyxJQUFJLENBQUMscUJBQXFCLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxDQUFDO1lBQ3RFLE1BQU0sY0FBYyxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsY0FHekMsQ0FBQztZQUVGLDBEQUEwRDtZQUMxRCxNQUFNLGNBQWMsR0FBUTtnQkFDMUIsTUFBTSxFQUFFLFVBQVU7Z0JBQ2xCLEdBQUcsQ0FBQyxPQUFPLENBQUMsUUFBUSxJQUFJLEVBQUUsUUFBUSxFQUFFLE9BQU8sQ0FBQyxRQUFRLEVBQUUsQ0FBQztnQkFDdkQsR0FBRyxDQUFDLE9BQU8sQ0FBQyxhQUFhLElBQUk7b0JBQzNCLFVBQVUsRUFBRSxFQUFFLEdBQUcsRUFBRSxPQUFPLENBQUMsYUFBYSxFQUFFO2lCQUMzQyxDQUFDO2FBQ0gsQ0FBQztZQUVGLHNEQUFzRDtZQUN0RCxJQUFJLGdCQUFnQixFQUFFLGFBQWEsRUFBRSxpQkFBaUIsRUFBRSxDQUFDO2dCQUN2RCxNQUFNLFFBQVEsR0FBRyxnQkFBZ0IsQ0FBQyxhQUFhLENBQUMsaUJBQWlCLENBQUM7Z0JBRWxFLHFDQUFxQztnQkFDckMsSUFBSSxRQUFRLENBQUMsdUJBQXVCLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRSxDQUFDO29CQUNoRCxjQUFjLENBQUMsRUFBRSxHQUFHLFFBQVEsQ0FBQyx1QkFBdUIsQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUFDLENBQUM7d0JBQ2xFLFNBQVMsRUFBRSxFQUFFLEdBQUcsRUFBRSxJQUFJLEVBQUU7cUJBQ3pCLENBQUMsQ0FBQyxDQUFDO2dCQUNOLENBQUM7Z0JBRUQsNkJBQTZCO2dCQUM3QixJQUFJLFFBQVEsQ0FBQyxlQUFlLEtBQUssS0FBSyxFQUFFLENBQUM7b0JBQ3ZDLE1BQU0sUUFBUSxHQUNaO3dCQUNFLFlBQVksRUFBRSxDQUFDO3dCQUNmLE1BQU0sRUFBRSxDQUFDO3dCQUNULE1BQU0sRUFBRSxFQUFFO3FCQUNYLENBQUMsUUFBUSxDQUFDLGVBQWUsQ0FBQyxJQUFJLENBQUMsQ0FBQztvQkFFbkMsY0FBYyxDQUFDLGlCQUFpQixHQUFHLEVBQUUsR0FBRyxFQUFFLFFBQVEsRUFBRSxDQUFDO2dCQUN2RCxDQUFDO1lBQ0gsQ0FBQztZQUVELDJDQUEyQztZQUMzQyxNQUFNLFVBQVUsR0FBRyxNQUFNLElBQUksQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FBQztnQkFDdEQsS0FBSyxFQUFFLGNBQWM7Z0JBQ3JCLE9BQU8sRUFBRSxFQUFFLFNBQVMsRUFBRSxNQUFNLEVBQUU7Z0JBQzlCLElBQUksRUFBRSxJQUFJLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxLQUFLLElBQUksRUFBRSxFQUFFLEVBQUUsQ0FBQyxFQUFFLHNDQUFzQztnQkFDL0UsT0FBTyxFQUFFO29CQUNQLElBQUksRUFBRSxJQUFJO29CQUNWLE9BQU8sRUFBRTt3QkFDUCxLQUFLLEVBQUUsRUFBRSxNQUFNLEVBQUUsVUFBVSxFQUFFO3dCQUM3QixNQUFNLEVBQUU7NEJBQ04sTUFBTSxFQUFFLElBQUk7NEJBQ1osTUFBTSxFQUFFLElBQUk7eUJBQ2I7cUJBQ0Y7aUJBQ0Y7YUFDRixDQUFDLENBQUM7WUFFSCx5RUFBeUU7WUFDekUsTUFBTSxlQUFlLEdBQXFCLEVBQUUsQ0FBQztZQUM3QyxJQUFJLHdCQUF3QixHQUFHLENBQUMsQ0FBQztZQUVqQyxLQUFLLE1BQU0sU0FBUyxJQUFJLFVBQVUsRUFBRSxDQUFDO2dCQUNuQyxJQUFJLENBQUM7b0JBQ0gsOEVBQThFO29CQUM5RSxNQUFNLGlCQUFpQixHQUFzQjt3QkFDM0MsR0FBRyxJQUFJO3dCQUNQLGFBQWEsRUFBRSxJQUFJLENBQUMsYUFBYTt3QkFDakMsaUJBQWlCLEVBQUUsSUFBSSxDQUFDLGlCQUFpQixJQUFJLEVBQUU7d0JBQy9DLElBQUksRUFBRSxJQUFJLENBQUMsSUFBSTtxQkFDaEIsQ0FBQztvQkFFRixNQUFNLG9CQUFvQixHQUF5Qjt3QkFDakQsR0FBRyxTQUFTO3dCQUNaLElBQUksRUFBRSxTQUFTLENBQUMsSUFBSTt3QkFDcEIsT0FBTyxFQUFFLFNBQVMsQ0FBQyxPQUFPLElBQUksRUFBRTtxQkFDakMsQ0FBQztvQkFFRixNQUFNLEtBQUssR0FBRyxNQUFNLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxzQkFBc0IsQ0FDOUQsaUJBQWlCLEVBQ2pCLG9CQUFvQixDQUNyQixDQUFDO29CQUVGLGVBQWUsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7Z0JBQzlCLENBQUM7Z0JBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztvQkFDZix3QkFBd0IsRUFBRSxDQUFDO29CQUUzQiwrQ0FBK0M7b0JBQy9DLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUNmLDBDQUEwQyxTQUFTLENBQUMsTUFBTSxFQUFFLEVBQzVEO3dCQUNFLEtBQUssRUFBRSxLQUFLLFlBQVksS0FBSyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDO3dCQUM3RCxLQUFLLEVBQUUsS0FBSyxZQUFZLEtBQUssQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsU0FBUzt3QkFDdkQsV0FBVyxFQUFFLFNBQVMsQ0FBQyxNQUFNO3dCQUM3QixNQUFNLEVBQUUsT0FBTyxDQUFDLE1BQU07cUJBQ3ZCLENBQ0YsQ0FBQztvQkFFRixxRUFBcUU7b0JBQ3JFLElBQUksQ0FBQzt3QkFDSCxNQUFNLFVBQVUsR0FBRyxJQUFJLENBQUMsbUJBQW1CLENBQ3pDLFNBQVMsRUFDVCxjQUFjLENBQ2YsQ0FBQzt3QkFFRixNQUFNLG9CQUFvQixHQUF5Qjs0QkFDakQsR0FBRyxTQUFTOzRCQUNaLElBQUksRUFBRSxTQUFTLENBQUMsSUFBSTs0QkFDcEIsT0FBTyxFQUFFLFNBQVMsQ0FBQyxPQUFPLElBQUksRUFBRTt5QkFDakMsQ0FBQzt3QkFFRixlQUFlLENBQUMsSUFBSSxDQUFDOzRCQUNuQixTQUFTLEVBQUUsb0JBQW9COzRCQUMvQixVQUFVLEVBQUUsVUFBVTs0QkFDdEIsU0FBUyxFQUFFO2dDQUNULGNBQWMsRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLFVBQVUsR0FBRyxHQUFHLENBQUM7Z0NBQzVDLGFBQWEsRUFBRSxDQUFDO2dDQUNoQixlQUFlLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxVQUFVLEdBQUcsR0FBRyxDQUFDO2dDQUM3QyxXQUFXLEVBQUUsQ0FBQztnQ0FDZCxjQUFjLEVBQUUsQ0FBQzs2QkFDbEI7NEJBQ0QsZ0JBQWdCLEVBQUU7Z0NBQ2hCLGNBQWMsRUFBRSxJQUFJLENBQUMsb0JBQW9CLENBQUMsY0FBYyxDQUFDO2dDQUN6RCxnQkFBZ0IsRUFBRSxJQUFJLENBQUMsc0JBQXNCLENBQUMsY0FBYyxDQUFDO2dDQUM3RCxlQUFlLEVBQUUsRUFBRTtnQ0FDbkIsZUFBZSxFQUFFLElBQUksQ0FBQywwQkFBMEIsQ0FDOUMsU0FBUyxDQUFDLGlCQUFpQixDQUM1QjtnQ0FDRCxhQUFhLEVBQUUsQ0FBQztnQ0FDaEIsWUFBWSxFQUFFLENBQUM7Z0NBQ2YsWUFBWSxFQUFFLEVBQUU7NkJBQ2pCO3lCQUNGLENBQUMsQ0FBQzt3QkFFSCxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FDZCw4Q0FBOEMsU0FBUyxDQUFDLE1BQU0sbUNBQW1DLENBQ2xHLENBQUM7b0JBQ0osQ0FBQztvQkFBQyxPQUFPLGlCQUFpQixFQUFFLENBQUM7d0JBQzNCLDJEQUEyRDt3QkFDM0QsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQ2Ysd0RBQXdELFNBQVMsQ0FBQyxNQUFNLEVBQUUsRUFDMUU7NEJBQ0UsYUFBYSxFQUNYLEtBQUssWUFBWSxLQUFLLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUM7NEJBQ3hELFVBQVUsRUFDUixpQkFBaUIsWUFBWSxLQUFLO2dDQUNoQyxDQUFDLENBQUMsaUJBQWlCLENBQUMsT0FBTztnQ0FDM0IsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxpQkFBaUIsQ0FBQzs0QkFDL0IsV0FBVyxFQUFFLFNBQVMsQ0FBQyxNQUFNOzRCQUM3QixNQUFNLEVBQUUsT0FBTyxDQUFDLE1BQU07eUJBQ3ZCLENBQ0YsQ0FBQzt3QkFDRiwrQkFBK0I7d0JBQy9CLFNBQVM7b0JBQ1gsQ0FBQztnQkFDSCxDQUFDO1lBQ0gsQ0FBQztZQUVELHNDQUFzQztZQUN0QyxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FDYiwrQkFBK0IsT0FBTyxDQUFDLE1BQU0sS0FBSyxlQUFlLENBQUMsTUFBTSx3QkFBd0Isd0JBQXdCLFlBQVksQ0FDckksQ0FBQztZQUVGLGlDQUFpQztZQUNqQyxNQUFNLHFCQUFxQixHQUFHLGVBQWUsQ0FBQyxJQUFJLENBQ2hELENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLFVBQVUsR0FBRyxDQUFDLENBQUMsVUFBVSxDQUN0QyxDQUFDO1lBRUYsNENBQTRDO1lBQzVDLE1BQU0sWUFBWSxHQUFHLHFCQUFxQixDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUUsT0FBTyxDQUFDLEtBQUssSUFBSSxFQUFFLENBQUMsQ0FBQztZQUV6RSxpQ0FBaUM7WUFDakMsTUFBTSxJQUFJLENBQUMsaUJBQWlCLENBQUMsbUJBQW1CLENBQzlDLE9BQU8sQ0FBQyxNQUFNLEVBQ2QsWUFBWSxFQUNaLGVBQWUsQ0FDaEIsQ0FBQztZQUVGLHNEQUFzRDtZQUN0RCxNQUFNLG9CQUFvQixHQUFHLFlBQVksQ0FBQyxHQUFHLENBQUMsQ0FBQyxLQUFLLEVBQUUsRUFBRTtnQkFDdEQsTUFBTSxhQUFhLEdBQVE7b0JBQ3pCLEdBQUcsS0FBSyxDQUFDLFNBQVM7b0JBQ2xCLFVBQVUsRUFBRSxLQUFLLENBQUMsVUFBVTtvQkFDNUIsY0FBYyxFQUFFLEtBQUssQ0FBQyxTQUFTO29CQUMvQixnQkFBZ0IsRUFBRSxLQUFLLENBQUMsZ0JBQWdCO2lCQUN6QyxDQUFDO2dCQUVGLHFDQUFxQztnQkFDckMsSUFBSSxnQkFBZ0IsRUFBRSxDQUFDO29CQUNyQixhQUFhLENBQUMsYUFBYSxHQUFHO3dCQUM1QixnQkFBZ0IsRUFBRSxJQUFJLENBQUMsc0JBQXNCLENBQzNDLEtBQUssQ0FBQyxTQUFTLEVBQ2YsZ0JBQWdCLENBQ2pCO3dCQUNELG1CQUFtQixFQUFFLElBQUksQ0FBQyx5QkFBeUIsQ0FDakQsS0FBSyxDQUFDLFNBQVMsRUFDZixnQkFBZ0IsQ0FDakI7d0JBQ0Qsa0JBQWtCLEVBQUUsSUFBSSxDQUFDLHdCQUF3QixDQUMvQyxLQUFLLENBQUMsU0FBUyxFQUNmLGdCQUFnQixDQUNqQjt3QkFDRCxxQkFBcUIsRUFBRSxJQUFJLENBQUMsMkJBQTJCLENBQ3JELEtBQUssQ0FBQyxTQUFTLEVBQ2YsZ0JBQWdCLENBQ2pCO3FCQUNGLENBQUM7Z0JBQ0osQ0FBQztnQkFFRCxPQUFPLGFBQWEsQ0FBQztZQUN2QixDQUFDLENBQUMsQ0FBQztZQUVILHVGQUF1RjtZQUN2RixNQUFNLGlCQUFpQixHQUFHLGdCQUFnQjtnQkFDeEMsQ0FBQyxDQUFDLGdCQUFnQixDQUFDLGVBQWUsQ0FBQyxpQkFBaUIsQ0FBQyxHQUFHLENBQ3BELENBQUMsRUFBRSxFQUFFLEVBQUUsQ0FBQyxFQUFFLENBQUMsU0FBUyxDQUNyQjtnQkFDSCxDQUFDLENBQUMsSUFBSSxDQUFDLG9CQUFvQixDQUFDLGNBQWMsQ0FBQyxDQUFDO1lBRTlDLE1BQU0sbUJBQW1CLEdBQUcsZ0JBQWdCO2dCQUMxQyxDQUFDLENBQUMsZ0JBQWdCLENBQUMsZUFBZSxDQUFDLG1CQUFtQixDQUFDLEdBQUcsQ0FDdEQsQ0FBQyxFQUFFLEVBQUUsRUFBRSxDQUFDLEVBQUUsQ0FBQyxTQUFTLENBQ3JCO2dCQUNILENBQUMsQ0FBQyxJQUFJLENBQUMsc0JBQXNCLENBQUMsY0FBYyxDQUFDLENBQUM7WUFFaEQsT0FBTztnQkFDTCxVQUFVLEVBQUUsb0JBQW9CLENBQUMsTUFBTTtnQkFDdkMsY0FBYyxFQUFFLE1BQU0sQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDO2dCQUMzQyxVQUFVLEVBQUUsb0JBQW9CO2dCQUNoQyxhQUFhLEVBQUU7b0JBQ2IsaUJBQWlCO29CQUNqQixtQkFBbUI7b0JBQ25CLGNBQWM7b0JBQ2QsR0FBRyxDQUFDLGdCQUFnQixJQUFJO3dCQUN0QixTQUFTLEVBQUUsZ0JBQWdCLENBQUMsY0FBYyxDQUFDLFdBQVc7d0JBQ3RELFlBQVksRUFDVixnQkFBZ0IsQ0FBQyxhQUFhLENBQUMsaUJBQWlCLENBQUMsWUFBWTt3QkFDL0QsdUJBQXVCLEVBQ3JCLGdCQUFnQixDQUFDLGFBQWEsQ0FBQyxpQkFBaUI7NkJBQzdDLHVCQUF1Qjt3QkFDNUIsbUJBQW1CLEVBQ2pCLGdCQUFnQixDQUFDLGFBQWEsQ0FBQyxpQkFBaUI7NkJBQzdDLG1CQUFtQjtxQkFDekIsQ0FBQztpQkFDSDtnQkFDRCxnQkFBZ0IsRUFBRSxnQkFBZ0I7b0JBQ2hDLENBQUMsQ0FBQzt3QkFDRSxnQkFBZ0IsRUFDZCxnQkFBZ0IsQ0FBQyxlQUFlLENBQUMsZ0JBQWdCO3dCQUNuRCxzQkFBc0IsRUFDcEIsZ0JBQWdCLENBQUMsZUFBZSxDQUFDLGlCQUFpQixDQUFDLE1BQU07d0JBQzNELHFCQUFxQixFQUNuQixnQkFBZ0IsQ0FBQyxlQUFlLENBQUMscUJBQXFCLENBQUMsS0FBSyxDQUMxRCxDQUFDLEVBQ0QsQ0FBQyxDQUNGO3dCQUNILDJCQUEyQixFQUN6QixnQkFBZ0IsQ0FBQyxhQUFhLENBQUMsaUJBQWlCOzZCQUM3QyxnQkFBZ0I7cUJBQ3RCO29CQUNILENBQUMsQ0FBQyxJQUFJO2dCQUNSLElBQUksRUFBRSxDQUFDO2dCQUNQLFFBQVEsRUFBRSxPQUFPLENBQUMsS0FBSyxJQUFJLEVBQUU7YUFDOUIsQ0FBQztRQUNKLENBQUM7UUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1lBQ2YscUVBQXFFO1lBQ3JFLElBQ0UsS0FBSyxZQUFZLDBCQUFpQjtnQkFDbEMsS0FBSyxZQUFZLDRCQUFtQixFQUNwQyxDQUFDO2dCQUNELGlEQUFpRDtnQkFDakQsTUFBTSxLQUFLLENBQUM7WUFDZCxDQUFDO1lBRUQsMENBQTBDO1lBQzFDLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUNmLHlEQUF5RCxPQUFPLENBQUMsTUFBTSxFQUFFLEVBQ3pFO2dCQUNFLEtBQUssRUFBRSxLQUFLLFlBQVksS0FBSyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDO2dCQUM3RCxLQUFLLEVBQUUsS0FBSyxZQUFZLEtBQUssQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsU0FBUztnQkFDdkQsTUFBTSxFQUFFLE9BQU8sQ0FBQyxNQUFNO2dCQUN0QixhQUFhLEVBQUU7b0JBQ2IsS0FBSyxFQUFFLE9BQU8sQ0FBQyxLQUFLO29CQUNwQixRQUFRLEVBQUUsT0FBTyxDQUFDLFFBQVE7b0JBQzFCLGFBQWEsRUFBRSxPQUFPLENBQUMsYUFBYTtpQkFDckM7YUFDRixDQUNGLENBQUM7WUFFRixrRUFBa0U7WUFDbEUsTUFBTSxJQUFJLHFDQUE0QixDQUNwQyxrRUFBa0UsQ0FDbkUsQ0FBQztRQUNKLENBQUM7SUFDSCxDQUFDO0lBRUQ7O09BRUc7SUFDSCxLQUFLLENBQUMsd0JBQXdCLENBQUMsUUFBZ0IsRUFBRSxXQUFtQjtRQUNsRSxNQUFNLE1BQU0sR0FBRyxNQUFNLElBQUksQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQztZQUNqRCxLQUFLLEVBQUUsRUFBRSxNQUFNLEVBQUUsUUFBUSxFQUFFO1lBQzNCLE9BQU8sRUFBRTtnQkFDUCxhQUFhLEVBQUUsSUFBSTtnQkFDbkIsaUJBQWlCLEVBQUUsSUFBSTtnQkFDdkIsSUFBSSxFQUFFLElBQUk7YUFDWDtTQUNGLENBQUMsQ0FBQztRQUVILE1BQU0sU0FBUyxHQUFHLE1BQU0sSUFBSSxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUMsVUFBVSxDQUFDO1lBQ3ZELEtBQUssRUFBRSxFQUFFLE1BQU0sRUFBRSxXQUFXLEVBQUU7WUFDOUIsT0FBTyxFQUFFO2dCQUNQLElBQUksRUFBRSxJQUFJO2dCQUNWLE9BQU8sRUFBRTtvQkFDUCxLQUFLLEVBQUUsRUFBRSxNQUFNLEVBQUUsVUFBVSxFQUFFO2lCQUM5QjthQUNGO1NBQ0YsQ0FBQyxDQUFDO1FBRUgsSUFBSSxDQUFDLE1BQU0sSUFBSSxDQUFDLFNBQVMsRUFBRSxDQUFDO1lBQzFCLE1BQU0sSUFBSSwwQkFBaUIsQ0FBQywrQkFBK0IsQ0FBQyxDQUFDO1FBQy9ELENBQUM7UUFFRCxJQUFJLENBQUMsTUFBTSxDQUFDLGFBQWEsRUFBRSxDQUFDO1lBQzFCLE1BQU0sSUFBSSwwQkFBaUIsQ0FBQyxvQ0FBb0MsQ0FBQyxDQUFDO1FBQ3BFLENBQUM7UUFFRCxNQUFNLGFBQWEsR0FBRyxNQUFNLElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxvQkFBb0IsQ0FDekUsTUFBYSxFQUFFLHNEQUFzRDtRQUNyRSxTQUFTLENBQ1YsQ0FBQztRQUVGLCtCQUErQjtRQUMvQixNQUFNLElBQUksQ0FBQyxpQkFBaUIsQ0FBQywwQkFBMEIsQ0FDckQsUUFBUSxFQUNSLFdBQVcsRUFDWCxhQUFhLEVBQ2IsS0FBSyxDQUNOLENBQUM7UUFFRixPQUFPLGFBQWEsQ0FBQztJQUN2QixDQUFDO0lBRU8scUJBQXFCLENBQzNCLGFBQTRCO1FBRTVCLE1BQU0sVUFBVSxHQUEyQixFQUFFLENBQUM7UUFDOUMsTUFBTSxjQUFjLEdBQUcsYUFBYSxDQUFDLGNBR3BDLENBQUM7UUFDRixNQUFNLGNBQWMsR0FBRyxhQUFhLENBQUMsY0FBMEIsQ0FBQztRQUNoRSxjQUFjLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUU7WUFDM0IsSUFBSSxjQUFjLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQztnQkFDdEIsVUFBVSxDQUFDLENBQUMsQ0FBQyxHQUFHLGNBQWMsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNwQyxDQUFDO1FBQ0gsQ0FBQyxDQUFDLENBQUM7UUFDSCxPQUFPLFVBQVUsQ0FBQztJQUNwQixDQUFDO0lBRU8sbUJBQW1CLENBQ3pCLFNBQWMsRUFDZCxjQUFzQztRQUV0QyxJQUFJLEtBQUssR0FBRyxDQUFDLENBQUM7UUFDZCxNQUFNLFNBQVMsR0FBSSxTQUFTLENBQUMsU0FBc0IsSUFBSSxFQUFFLENBQUM7UUFDMUQsTUFBTSxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxTQUFTLEVBQUUsRUFBRTtZQUNoRCxJQUFJLFNBQVMsQ0FBQyxRQUFRLENBQUMsU0FBUyxDQUFDO2dCQUFFLEtBQUssSUFBSSxFQUFFLENBQUM7UUFDakQsQ0FBQyxDQUFDLENBQUM7UUFDSCxLQUFLLElBQUksSUFBSSxDQUFDLEdBQUcsQ0FDZixJQUFJLENBQUMsMEJBQTBCLENBQUMsU0FBUyxDQUFDLGlCQUFpQixDQUFDLEdBQUcsQ0FBQyxFQUNoRSxFQUFFLENBQ0gsQ0FBQztRQUNGLGdDQUFnQztRQUNoQyxLQUFLLElBQUksU0FBUyxDQUFDLGlCQUFpQixDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsaUJBQWlCLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDM0UsT0FBTyxLQUFLLENBQUM7SUFDZixDQUFDO0lBRU8sb0JBQW9CLENBQzFCLGNBQXNDO1FBRXRDLE9BQU8sTUFBTSxDQUFDLE9BQU8sQ0FBQyxjQUFjLENBQUM7YUFDbEMsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLFFBQVEsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsaUJBQWlCLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDO2FBQy9ELEdBQUcsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDLEVBQUUsRUFBRSxDQUFDLFNBQVMsQ0FBQyxDQUFDO0lBQ3JDLENBQUM7SUFFTyxzQkFBc0IsQ0FDNUIsY0FBc0M7UUFFdEMsT0FBTyxNQUFNLENBQUMsT0FBTyxDQUFDLGNBQWMsQ0FBQzthQUNsQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUsUUFBUSxDQUFDLEVBQUUsRUFBRTtZQUN2QixNQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsaUJBQWlCLENBQUMsUUFBUSxDQUFDLENBQUM7WUFDaEQsT0FBTyxNQUFNLElBQUksQ0FBQyxJQUFJLE1BQU0sR0FBRyxDQUFDLENBQUM7UUFDbkMsQ0FBQyxDQUFDO2FBQ0QsR0FBRyxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsRUFBRSxFQUFFLENBQUMsU0FBUyxDQUFDLENBQUM7SUFDckMsQ0FBQztJQUVPLGlCQUFpQixDQUFDLFFBQWdCO1FBQ3hDLE1BQU0sZUFBZSxHQUEyQjtZQUM5QyxPQUFPLEVBQUUsQ0FBQztZQUNWLElBQUksRUFBRSxDQUFDO1lBQ1AsUUFBUSxFQUFFLENBQUM7WUFDWCxtQkFBbUIsRUFBRSxDQUFDO1lBQ3RCLE1BQU0sRUFBRSxDQUFDO1lBQ1QsYUFBYSxFQUFFLENBQUM7WUFDaEIsT0FBTyxFQUFFLENBQUM7WUFDVixHQUFHLEVBQUUsQ0FBQztZQUNOLElBQUksRUFBRSxDQUFDO1lBQ1AsV0FBVyxFQUFFLENBQUM7WUFDZCxXQUFXLEVBQUUsQ0FBQztZQUNkLFFBQVEsRUFBRSxDQUFDO1lBQ1gsSUFBSSxFQUFFLENBQUM7WUFDUCxZQUFZLEVBQUUsQ0FBQztZQUNmLFFBQVEsRUFBRSxDQUFDO1lBQ1gsUUFBUSxFQUFFLENBQUM7U0FDWixDQUFDO1FBQ0YsT0FBTyxlQUFlLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ3hDLENBQUM7SUFFRDs7T0FFRztJQUNLLHNCQUFzQixDQUM1QixTQUFjLEVBQ2QsZ0JBQXFCO1FBS3JCLE1BQU0sWUFBWSxHQUNoQixnQkFBZ0IsQ0FBQyxhQUFhLENBQUMsaUJBQWlCLENBQUMsWUFBWSxDQUFDO1FBQ2hFLE1BQU0sU0FBUyxHQUFHLGdCQUFnQixDQUFDLGNBQWMsQ0FBQyxXQUFXLENBQUM7UUFFOUQsSUFBSSxLQUFLLEdBQUcsRUFBRSxDQUFDLENBQUMsYUFBYTtRQUM3QixJQUFJLFNBQVMsR0FBRyxpQ0FBaUMsQ0FBQztRQUVsRCw2Q0FBNkM7UUFDN0MsSUFBSSxZQUFZLEtBQUssV0FBVyxJQUFJLFNBQVMsS0FBSyxVQUFVLEVBQUUsQ0FBQztZQUM3RCxJQUNFLFNBQVMsQ0FBQyw0QkFBNEI7Z0JBQ3RDLFNBQVMsQ0FBQyx3QkFBd0IsRUFDbEMsQ0FBQztnQkFDRCxLQUFLLEdBQUcsRUFBRSxDQUFDO2dCQUNYLFNBQVM7b0JBQ1AsNERBQTRELENBQUM7WUFDakUsQ0FBQztpQkFBTSxDQUFDO2dCQUNOLEtBQUssR0FBRyxFQUFFLENBQUM7Z0JBQ1gsU0FBUyxHQUFHLHNEQUFzRCxDQUFDO1lBQ3JFLENBQUM7UUFDSCxDQUFDO2FBQU0sSUFBSSxZQUFZLEtBQUssTUFBTSxFQUFFLENBQUM7WUFDbkMsSUFBSSxTQUFTLENBQUMsa0JBQWtCLElBQUksU0FBUyxDQUFDLGtCQUFrQixFQUFFLENBQUM7Z0JBQ2pFLEtBQUssR0FBRyxFQUFFLENBQUM7Z0JBQ1gsU0FBUyxHQUFHLGdEQUFnRCxDQUFDO1lBQy9ELENBQUM7UUFDSCxDQUFDO1FBRUQsT0FBTyxFQUFFLEtBQUssRUFBRSxTQUFTLEVBQUUsQ0FBQztJQUM5QixDQUFDO0lBRUQ7O09BRUc7SUFDSyx5QkFBeUIsQ0FDL0IsU0FBYyxFQUNkLGdCQUFxQjtRQU1yQixNQUFNLGFBQWEsR0FDakIsZ0JBQWdCLENBQUMsYUFBYSxDQUFDLGlCQUFpQixDQUFDLHVCQUF1QixDQUFDO1FBQzNFLE1BQU0sY0FBYyxHQUFHO1lBQ3JCLEdBQUcsQ0FBQyxTQUFTLENBQUMsU0FBUyxJQUFJLEVBQUUsQ0FBQztZQUM5QixHQUFHLENBQUMsU0FBUyxDQUFDLHNCQUFzQixJQUFJLEVBQUUsQ0FBQztTQUM1QyxDQUFDO1FBRUYsTUFBTSxZQUFZLEdBQUcsYUFBYSxDQUFDLE1BQU0sQ0FBQyxDQUFDLEdBQUcsRUFBRSxFQUFFLENBQ2hELGNBQWMsQ0FBQyxJQUFJLENBQ2pCLENBQUMsSUFBSSxFQUFFLEVBQUUsQ0FDUCxJQUFJLENBQUMsV0FBVyxFQUFFLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxXQUFXLEVBQUUsQ0FBQztZQUM5QyxHQUFHLENBQUMsV0FBVyxFQUFFLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQyxDQUNqRCxDQUNGLENBQUM7UUFFRixNQUFNLFVBQVUsR0FDZCxhQUFhLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsWUFBWSxDQUFDLE1BQU0sR0FBRyxhQUFhLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDNUUsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxVQUFVLEdBQUcsR0FBRyxDQUFDLENBQUM7UUFFM0MsSUFBSSxTQUFTLEdBQUcsV0FBVyxZQUFZLENBQUMsTUFBTSxJQUFJLGFBQWEsQ0FBQyxNQUFNLDJCQUEyQixDQUFDO1FBQ2xHLElBQUksS0FBSyxJQUFJLEVBQUU7WUFBRSxTQUFTLEdBQUcsZ0NBQWdDLENBQUM7YUFDekQsSUFBSSxLQUFLLElBQUksRUFBRTtZQUFFLFNBQVMsR0FBRywrQkFBK0IsQ0FBQzthQUM3RCxJQUFJLEtBQUssSUFBSSxFQUFFO1lBQUUsU0FBUyxHQUFHLDhCQUE4QixDQUFDOztZQUM1RCxTQUFTLEdBQUcsOEJBQThCLENBQUM7UUFFaEQsT0FBTztZQUNMLEtBQUs7WUFDTCxzQkFBc0IsRUFBRSxZQUFZO1lBQ3BDLFNBQVM7U0FDVixDQUFDO0lBQ0osQ0FBQztJQUVEOztPQUVHO0lBQ0ssd0JBQXdCLENBQzlCLFNBQWMsRUFDZCxnQkFBcUI7UUFLckIsTUFBTSxhQUFhLEdBQ2pCLGdCQUFnQixDQUFDLGFBQWEsQ0FBQyxpQkFBaUIsQ0FBQyxlQUFlLENBQUM7UUFDbkUsTUFBTSxjQUFjLEdBQ2xCLFNBQVMsQ0FBQyxpQkFBaUI7WUFDM0IsSUFBSSxDQUFDLDBCQUEwQixDQUFDLFNBQVMsQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO1FBRS9ELE1BQU0sYUFBYSxHQUNqQjtZQUNFLEdBQUcsRUFBRSxDQUFDO1lBQ04sWUFBWSxFQUFFLENBQUM7WUFDZixNQUFNLEVBQUUsQ0FBQztZQUNULE1BQU0sRUFBRSxFQUFFO1NBQ1gsQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLENBQUM7UUFFeEIsSUFBSSxjQUFjLElBQUksYUFBYSxFQUFFLENBQUM7WUFDcEMsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLEVBQUUsRUFBRSxHQUFHLENBQUMsY0FBYyxHQUFHLGFBQWEsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1lBQ3ZFLE9BQU87Z0JBQ0wsS0FBSztnQkFDTCxTQUFTLEVBQUUsR0FBRyxjQUFjLDJCQUEyQixhQUFhLG9CQUFvQjthQUN6RixDQUFDO1FBQ0osQ0FBQzthQUFNLENBQUM7WUFDTixNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsRUFBRSxDQUFDLGNBQWMsR0FBRyxhQUFhLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQztZQUNsRSxPQUFPO2dCQUNMLEtBQUs7Z0JBQ0wsU0FBUyxFQUFFLEdBQUcsY0FBYywyQkFBMkIsYUFBYSxXQUFXLGFBQWEsVUFBVTthQUN2RyxDQUFDO1FBQ0osQ0FBQztJQUNILENBQUM7SUFFRDs7T0FFRztJQUNLLDJCQUEyQixDQUNqQyxTQUFjLEVBQ2QsZ0JBQXFCO1FBTXJCLE1BQU0sbUJBQW1CLEdBQ3ZCLGdCQUFnQixDQUFDLGFBQWEsQ0FBQyxpQkFBaUIsQ0FBQyxtQkFBbUIsQ0FBQztRQUN2RSxNQUFNLG1CQUFtQixHQUFHO1lBQzFCLEdBQUcsQ0FBQyxTQUFTLENBQUMsVUFBVSxJQUFJLEVBQUUsQ0FBQztZQUMvQixHQUFHLENBQUMsU0FBUyxDQUFDLDZCQUE2QixJQUFJLEVBQUUsQ0FBQztTQUNuRCxDQUFDO1FBRUYsTUFBTSxpQkFBaUIsR0FBRyxtQkFBbUIsQ0FBQyxNQUFNLENBQUMsQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUM1RCxtQkFBbUIsQ0FBQyxJQUFJLENBQ3RCLENBQUMsUUFBUSxFQUFFLEVBQUUsQ0FDWCxRQUFRLENBQUMsV0FBVyxFQUFFLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQztZQUNuRCxJQUFJLENBQUMsV0FBVyxFQUFFLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxXQUFXLEVBQUUsQ0FBQyxDQUN0RCxDQUNGLENBQUM7UUFFRixNQUFNLFVBQVUsR0FDZCxtQkFBbUIsQ0FBQyxNQUFNLEdBQUcsQ0FBQztZQUM1QixDQUFDLENBQUMsaUJBQWlCLENBQUMsTUFBTSxHQUFHLG1CQUFtQixDQUFDLE1BQU07WUFDdkQsQ0FBQyxDQUFDLEdBQUcsQ0FBQztRQUNWLE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsVUFBVSxHQUFHLEdBQUcsQ0FBQyxDQUFDO1FBRTNDLElBQUksU0FBUyxHQUFHLFdBQVcsaUJBQWlCLENBQUMsTUFBTSxJQUFJLG1CQUFtQixDQUFDLE1BQU0sdUJBQXVCLENBQUM7UUFDekcsSUFBSSxLQUFLLElBQUksRUFBRTtZQUFFLFNBQVMsR0FBRyxzQ0FBc0MsQ0FBQzthQUMvRCxJQUFJLEtBQUssSUFBSSxFQUFFO1lBQUUsU0FBUyxHQUFHLDZCQUE2QixDQUFDO2FBQzNELElBQUksS0FBSyxJQUFJLEVBQUU7WUFBRSxTQUFTLEdBQUcseUJBQXlCLENBQUM7O1lBQ3ZELFNBQVMsR0FBRyxpREFBaUQsQ0FBQztRQUVuRSxPQUFPO1lBQ0wsS0FBSztZQUNMLGlCQUFpQjtZQUNqQixTQUFTO1NBQ1YsQ0FBQztJQUNKLENBQUM7Q0FDRixDQUFBO0FBdnBCWSx3RUFBOEI7eUNBQTlCLDhCQUE4QjtJQUQxQyxJQUFBLG1CQUFVLEdBQUU7eURBS2dCLHNDQUFhLG9CQUFiLHNDQUFhLG9EQUNILG1EQUF1QixvQkFBdkIsbURBQXVCLG9EQUNsQiw2REFBNEIsb0JBQTVCLDZEQUE0QixvREFDaEMscURBQXdCLG9CQUF4QixxREFBd0Isb0RBQ3JCLDZDQUFvQixvQkFBcEIsNkNBQW9CO0dBUmxELDhCQUE4QixDQXVwQjFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9ob21lL3dldG9vYS9Eb2N1bWVudHMvY29kZS9wcm9qZWN0cy9tZW50YXJhL21lbnRhcmEtYXBpL3NyYy90aGVyYXBpc3QvdGhlcmFwaXN0LXJlY29tbWVuZGF0aW9uLnNlcnZpY2UudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgSW5qZWN0YWJsZSxcbiAgTm90Rm91bmRFeGNlcHRpb24sXG4gIEludGVybmFsU2VydmVyRXJyb3JFeGNlcHRpb24sXG4gIExvZ2dlcixcbiAgQmFkUmVxdWVzdEV4Y2VwdGlvbixcbn0gZnJvbSAnQG5lc3Rqcy9jb21tb24nO1xuaW1wb3J0IHsgUHJpc21hU2VydmljZSB9IGZyb20gJy4uL3Byb3ZpZGVycy9wcmlzbWEtY2xpZW50LnByb3ZpZGVyJztcbmltcG9ydCB7IFByZUFzc2Vzc21lbnQgfSBmcm9tICdAcHJpc21hL2NsaWVudCc7XG5pbXBvcnQge1xuICBUaGVyYXBpc3RSZWNvbW1lbmRhdGlvblJlcXVlc3QsXG4gIFRoZXJhcGlzdFJlY29tbWVuZGF0aW9uUmVzcG9uc2UsXG59IGZyb20gJ21lbnRhcmEtY29tbW9ucyc7XG5pbXBvcnQge1xuICBBZHZhbmNlZE1hdGNoaW5nU2VydmljZSxcbiAgVGhlcmFwaXN0U2NvcmUsXG4gIENsaWVudEZvck1hdGNoaW5nLFxuICBUaGVyYXBpc3RGb3JNYXRjaGluZyxcbn0gZnJvbSAnLi9zZXJ2aWNlcy9hZHZhbmNlZC1tYXRjaGluZy5zZXJ2aWNlJztcbmltcG9ydCB7IENvbXBhdGliaWxpdHlBbmFseXNpc1NlcnZpY2UgfSBmcm9tICcuL3NlcnZpY2VzL2NvbXBhdGliaWxpdHktYW5hbHlzaXMuc2VydmljZSc7XG5pbXBvcnQgeyBNYXRjaGluZ0FuYWx5dGljc1NlcnZpY2UgfSBmcm9tICcuL3NlcnZpY2VzL21hdGNoaW5nLWFuYWx5dGljcy5zZXJ2aWNlJztcbmltcG9ydCB7IFByZUFzc2Vzc21lbnRTZXJ2aWNlIH0gZnJvbSAnLi4vcHJlLWFzc2Vzc21lbnQvcHJlLWFzc2Vzc21lbnQuc2VydmljZSc7XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBUaGVyYXBpc3RSZWNvbW1lbmRhdGlvblNlcnZpY2Uge1xuICBwcml2YXRlIHJlYWRvbmx5IGxvZ2dlciA9IG5ldyBMb2dnZXIoVGhlcmFwaXN0UmVjb21tZW5kYXRpb25TZXJ2aWNlLm5hbWUpO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgcmVhZG9ubHkgcHJpc21hOiBQcmlzbWFTZXJ2aWNlLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgYWR2YW5jZWRNYXRjaGluZzogQWR2YW5jZWRNYXRjaGluZ1NlcnZpY2UsXG4gICAgcHJpdmF0ZSByZWFkb25seSBjb21wYXRpYmlsaXR5QW5hbHlzaXM6IENvbXBhdGliaWxpdHlBbmFseXNpc1NlcnZpY2UsXG4gICAgcHJpdmF0ZSByZWFkb25seSBtYXRjaGluZ0FuYWx5dGljczogTWF0Y2hpbmdBbmFseXRpY3NTZXJ2aWNlLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgcHJlQXNzZXNzbWVudFNlcnZpY2U6IFByZUFzc2Vzc21lbnRTZXJ2aWNlLFxuICApIHt9XG5cbiAgcHJpdmF0ZSBjYWxjdWxhdGVZZWFyc09mRXhwZXJpZW5jZShzdGFydERhdGU6IERhdGUpOiBudW1iZXIge1xuICAgIGNvbnN0IG5vdyA9IG5ldyBEYXRlKCk7XG4gICAgbGV0IHllYXJzID0gbm93LmdldEZ1bGxZZWFyKCkgLSBzdGFydERhdGUuZ2V0RnVsbFllYXIoKTtcbiAgICBpZiAoXG4gICAgICBub3cuZ2V0TW9udGgoKSA8IHN0YXJ0RGF0ZS5nZXRNb250aCgpIHx8XG4gICAgICAobm93LmdldE1vbnRoKCkgPT09IHN0YXJ0RGF0ZS5nZXRNb250aCgpICYmXG4gICAgICAgIG5vdy5nZXREYXRlKCkgPCBzdGFydERhdGUuZ2V0RGF0ZSgpKVxuICAgICkge1xuICAgICAgeWVhcnMtLTtcbiAgICB9XG4gICAgcmV0dXJuIHllYXJzO1xuICB9XG5cbiAgYXN5bmMgZ2V0UmVjb21tZW5kZWRUaGVyYXBpc3RzKFxuICAgIHJlcXVlc3Q6IFRoZXJhcGlzdFJlY29tbWVuZGF0aW9uUmVxdWVzdCxcbiAgKTogUHJvbWlzZTxhbnk+IHtcbiAgICAvLyBJbnB1dCB2YWxpZGF0aW9uXG4gICAgaWYgKCFyZXF1ZXN0Py51c2VySWQpIHtcbiAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0RXhjZXB0aW9uKCdVc2VyIElEIGlzIHJlcXVpcmVkJyk7XG4gICAgfVxuXG4gICAgaWYgKHJlcXVlc3QubGltaXQgJiYgKHJlcXVlc3QubGltaXQgPCAxIHx8IHJlcXVlc3QubGltaXQgPiAxMDApKSB7XG4gICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdEV4Y2VwdGlvbignTGltaXQgbXVzdCBiZSBiZXR3ZWVuIDEgYW5kIDEwMCcpO1xuICAgIH1cblxuICAgIHRoaXMubG9nZ2VyLmxvZyhcbiAgICAgIGBHZXR0aW5nIGVuaGFuY2VkIHJlY29tbWVuZGF0aW9ucyBmb3IgdXNlciAke3JlcXVlc3QudXNlcklkfSB3aXRoIGxpbWl0ICR7cmVxdWVzdC5saW1pdCB8fCAxMH1gLFxuICAgICk7XG5cbiAgICB0cnkge1xuICAgICAgLy8gR2V0IHVzZXIncyBjb21wcmVoZW5zaXZlIGRhdGEgaW5jbHVkaW5nIHByZWZlcmVuY2VzXG4gICAgICBjb25zdCB1c2VyID0gYXdhaXQgdGhpcy5wcmlzbWEuY2xpZW50LmZpbmRVbmlxdWUoe1xuICAgICAgICB3aGVyZTogeyB1c2VySWQ6IHJlcXVlc3QudXNlcklkIH0sXG4gICAgICAgIGluY2x1ZGU6IHtcbiAgICAgICAgICBwcmVBc3Nlc3NtZW50OiB0cnVlLFxuICAgICAgICAgIGNsaWVudFByZWZlcmVuY2VzOiB0cnVlLFxuICAgICAgICAgIHVzZXI6IHRydWUsXG4gICAgICAgIH0sXG4gICAgICB9KTtcblxuICAgICAgaWYgKCF1c2VyKSB7XG4gICAgICAgIHRoaXMubG9nZ2VyLndhcm4oYFVzZXIgbm90IGZvdW5kOiAke3JlcXVlc3QudXNlcklkfWApO1xuICAgICAgICB0aHJvdyBuZXcgTm90Rm91bmRFeGNlcHRpb24oJ1VzZXIgbm90IGZvdW5kJyk7XG4gICAgICB9XG5cbiAgICAgIGlmICghdXNlci5wcmVBc3Nlc3NtZW50KSB7XG4gICAgICAgIHRoaXMubG9nZ2VyLndhcm4oYE5vIHByZS1hc3Nlc3NtZW50IGZvdW5kIGZvciB1c2VyOiAke3JlcXVlc3QudXNlcklkfWApO1xuICAgICAgICB0aHJvdyBuZXcgTm90Rm91bmRFeGNlcHRpb24oJ05vIHByZS1hc3Nlc3NtZW50IGZvdW5kIGZvciB1c2VyJyk7XG4gICAgICB9XG5cbiAgICAgIC8vIEdldCBjb21wcmVoZW5zaXZlIGNsaW5pY2FsIGFuYWx5c2lzIGZvciBlbmhhbmNlZCBtYXRjaGluZ1xuICAgICAgbGV0IGNsaW5pY2FsQW5hbHlzaXM7XG4gICAgICB0cnkge1xuICAgICAgICBjbGluaWNhbEFuYWx5c2lzID1cbiAgICAgICAgICBhd2FpdCB0aGlzLnByZUFzc2Vzc21lbnRTZXJ2aWNlLmdldENvbXByZWhlbnNpdmVDbGluaWNhbEFuYWx5c2lzKFxuICAgICAgICAgICAgcmVxdWVzdC51c2VySWQsXG4gICAgICAgICAgKTtcbiAgICAgICAgdGhpcy5sb2dnZXIubG9nKFxuICAgICAgICAgIGBFbmhhbmNlZCBjbGluaWNhbCBpbnNpZ2h0cyBhdmFpbGFibGU6ICR7Y2xpbmljYWxBbmFseXNpcy5jbGluaWNhbFByb2ZpbGUucHJpbWFyeUNvbmRpdGlvbnMubGVuZ3RofSBwcmltYXJ5IGNvbmRpdGlvbnNgLFxuICAgICAgICApO1xuICAgICAgfSBjYXRjaCAoYW5hbHlzaXNFcnJvcikge1xuICAgICAgICB0aGlzLmxvZ2dlci53YXJuKFxuICAgICAgICAgICdBZHZhbmNlZCBjbGluaWNhbCBhbmFseXNpcyB1bmF2YWlsYWJsZSwgdXNpbmcgYmFzaWMgYXNzZXNzbWVudDonLFxuICAgICAgICAgIGFuYWx5c2lzRXJyb3IsXG4gICAgICAgICk7XG4gICAgICAgIGNsaW5pY2FsQW5hbHlzaXMgPSBudWxsO1xuICAgICAgfVxuXG4gICAgICAvLyBFeHRyYWN0IHVzZXIgY29uZGl0aW9ucyBhbmQgc2V2ZXJpdHkgbGV2ZWxzXG4gICAgICBjb25zdCB1c2VyQ29uZGl0aW9ucyA9IHRoaXMuZXh0cmFjdFVzZXJDb25kaXRpb25zKHVzZXIucHJlQXNzZXNzbWVudCk7XG4gICAgICBjb25zdCBzZXZlcml0eUxldmVscyA9IHVzZXIucHJlQXNzZXNzbWVudC5zZXZlcml0eUxldmVscyBhcyBSZWNvcmQ8XG4gICAgICAgIHN0cmluZyxcbiAgICAgICAgc3RyaW5nXG4gICAgICA+O1xuXG4gICAgICAvLyBFbmhhbmNlZCB0aGVyYXBpc3QgZmlsdGVyaW5nIGJhc2VkIG9uIGNsaW5pY2FsIGluc2lnaHRzXG4gICAgICBjb25zdCB0aGVyYXBpc3RXaGVyZTogYW55ID0ge1xuICAgICAgICBzdGF0dXM6ICdhcHByb3ZlZCcsXG4gICAgICAgIC4uLihyZXF1ZXN0LnByb3ZpbmNlICYmIHsgcHJvdmluY2U6IHJlcXVlc3QucHJvdmluY2UgfSksXG4gICAgICAgIC4uLihyZXF1ZXN0Lm1heEhvdXJseVJhdGUgJiYge1xuICAgICAgICAgIGhvdXJseVJhdGU6IHsgbHRlOiByZXF1ZXN0Lm1heEhvdXJseVJhdGUgfSxcbiAgICAgICAgfSksXG4gICAgICB9O1xuXG4gICAgICAvLyBBcHBseSBlbmhhbmNlZCBmaWx0ZXJpbmcgYmFzZWQgb24gY2xpbmljYWwgYW5hbHlzaXNcbiAgICAgIGlmIChjbGluaWNhbEFuYWx5c2lzPy50cmVhdG1lbnRQbGFuPy50aGVyYXBpc3RDcml0ZXJpYSkge1xuICAgICAgICBjb25zdCBjcml0ZXJpYSA9IGNsaW5pY2FsQW5hbHlzaXMudHJlYXRtZW50UGxhbi50aGVyYXBpc3RDcml0ZXJpYTtcblxuICAgICAgICAvLyBGaWx0ZXIgYnkgcmVxdWlyZWQgc3BlY2lhbGl6YXRpb25zXG4gICAgICAgIGlmIChjcml0ZXJpYS5yZXF1aXJlZFNwZWNpYWxpemF0aW9ucy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgdGhlcmFwaXN0V2hlcmUuT1IgPSBjcml0ZXJpYS5yZXF1aXJlZFNwZWNpYWxpemF0aW9ucy5tYXAoKHNwZWMpID0+ICh7XG4gICAgICAgICAgICBleHBlcnRpc2U6IHsgaGFzOiBzcGVjIH0sXG4gICAgICAgICAgfSkpO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gRmlsdGVyIGJ5IGV4cGVyaWVuY2UgbGV2ZWxcbiAgICAgICAgaWYgKGNyaXRlcmlhLmV4cGVyaWVuY2VMZXZlbCAhPT0gJ2FueScpIHtcbiAgICAgICAgICBjb25zdCBtaW5ZZWFycyA9XG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgIGludGVybWVkaWF0ZTogMyxcbiAgICAgICAgICAgICAgc2VuaW9yOiA3LFxuICAgICAgICAgICAgICBleHBlcnQ6IDEyLFxuICAgICAgICAgICAgfVtjcml0ZXJpYS5leHBlcmllbmNlTGV2ZWxdIHx8IDA7XG5cbiAgICAgICAgICB0aGVyYXBpc3RXaGVyZS55ZWFyc09mRXhwZXJpZW5jZSA9IHsgZ3RlOiBtaW5ZZWFycyB9O1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIC8vIEZldGNoIHRoZXJhcGlzdHMgd2l0aCBjb21wcmVoZW5zaXZlIGRhdGFcbiAgICAgIGNvbnN0IHRoZXJhcGlzdHMgPSBhd2FpdCB0aGlzLnByaXNtYS50aGVyYXBpc3QuZmluZE1hbnkoe1xuICAgICAgICB3aGVyZTogdGhlcmFwaXN0V2hlcmUsXG4gICAgICAgIG9yZGVyQnk6IHsgY3JlYXRlZEF0OiAnZGVzYycgfSxcbiAgICAgICAgdGFrZTogTWF0aC5taW4ocmVxdWVzdC5saW1pdCA/PyAxMCwgNTApLCAvLyBJbmNyZWFzZSBsaW1pdCBmb3IgYmV0dGVyIGZpbHRlcmluZ1xuICAgICAgICBpbmNsdWRlOiB7XG4gICAgICAgICAgdXNlcjogdHJ1ZSxcbiAgICAgICAgICByZXZpZXdzOiB7XG4gICAgICAgICAgICB3aGVyZTogeyBzdGF0dXM6ICdBUFBST1ZFRCcgfSxcbiAgICAgICAgICAgIHNlbGVjdDoge1xuICAgICAgICAgICAgICByYXRpbmc6IHRydWUsXG4gICAgICAgICAgICAgIHN0YXR1czogdHJ1ZSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgIH0pO1xuXG4gICAgICAvLyBVc2UgYWR2YW5jZWQgbWF0Y2hpbmcgYWxnb3JpdGhtIHdpdGggcHJvcGVyIGVycm9yIGhhbmRsaW5nIGFuZCBsb2dnaW5nXG4gICAgICBjb25zdCB0aGVyYXBpc3RTY29yZXM6IFRoZXJhcGlzdFNjb3JlW10gPSBbXTtcbiAgICAgIGxldCBhZHZhbmNlZE1hdGNoaW5nRmFpbHVyZXMgPSAwO1xuXG4gICAgICBmb3IgKGNvbnN0IHRoZXJhcGlzdCBvZiB0aGVyYXBpc3RzKSB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgLy8gQ2FzdCB1c2VyIHRvIHByb3BlciB0eXBlIG5vdyB0aGF0IHdlJ3ZlIHZhbGlkYXRlZCBhbGwgcmVxdWlyZWQgZmllbGRzIGV4aXN0XG4gICAgICAgICAgY29uc3QgY2xpZW50Rm9yTWF0Y2hpbmc6IENsaWVudEZvck1hdGNoaW5nID0ge1xuICAgICAgICAgICAgLi4udXNlcixcbiAgICAgICAgICAgIHByZUFzc2Vzc21lbnQ6IHVzZXIucHJlQXNzZXNzbWVudCxcbiAgICAgICAgICAgIGNsaWVudFByZWZlcmVuY2VzOiB1c2VyLmNsaWVudFByZWZlcmVuY2VzIHx8IFtdLFxuICAgICAgICAgICAgdXNlcjogdXNlci51c2VyLFxuICAgICAgICAgIH07XG5cbiAgICAgICAgICBjb25zdCB0aGVyYXBpc3RGb3JNYXRjaGluZzogVGhlcmFwaXN0Rm9yTWF0Y2hpbmcgPSB7XG4gICAgICAgICAgICAuLi50aGVyYXBpc3QsXG4gICAgICAgICAgICB1c2VyOiB0aGVyYXBpc3QudXNlcixcbiAgICAgICAgICAgIHJldmlld3M6IHRoZXJhcGlzdC5yZXZpZXdzIHx8IFtdLFxuICAgICAgICAgIH07XG5cbiAgICAgICAgICBjb25zdCBzY29yZSA9IGF3YWl0IHRoaXMuYWR2YW5jZWRNYXRjaGluZy5jYWxjdWxhdGVBZHZhbmNlZE1hdGNoKFxuICAgICAgICAgICAgY2xpZW50Rm9yTWF0Y2hpbmcsXG4gICAgICAgICAgICB0aGVyYXBpc3RGb3JNYXRjaGluZyxcbiAgICAgICAgICApO1xuXG4gICAgICAgICAgdGhlcmFwaXN0U2NvcmVzLnB1c2goc2NvcmUpO1xuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgIGFkdmFuY2VkTWF0Y2hpbmdGYWlsdXJlcysrO1xuXG4gICAgICAgICAgLy8gTG9nIGRldGFpbGVkIGVycm9yIGluZm9ybWF0aW9uIGZvciBkZWJ1Z2dpbmdcbiAgICAgICAgICB0aGlzLmxvZ2dlci5lcnJvcihcbiAgICAgICAgICAgIGBBZHZhbmNlZCBtYXRjaGluZyBmYWlsZWQgZm9yIHRoZXJhcGlzdCAke3RoZXJhcGlzdC51c2VySWR9YCxcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgZXJyb3I6IGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogU3RyaW5nKGVycm9yKSxcbiAgICAgICAgICAgICAgc3RhY2s6IGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5zdGFjayA6IHVuZGVmaW5lZCxcbiAgICAgICAgICAgICAgdGhlcmFwaXN0SWQ6IHRoZXJhcGlzdC51c2VySWQsXG4gICAgICAgICAgICAgIHVzZXJJZDogcmVxdWVzdC51c2VySWQsXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICk7XG5cbiAgICAgICAgICAvLyBGYWxsYmFjayB0byBiYXNpYyBzY29yaW5nIHdpdGggY2xlYXIgaW5kaWNhdGlvbiB0aGlzIGlzIGEgZmFsbGJhY2tcbiAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgY29uc3QgYmFzaWNTY29yZSA9IHRoaXMuY2FsY3VsYXRlTWF0Y2hTY29yZShcbiAgICAgICAgICAgICAgdGhlcmFwaXN0LFxuICAgICAgICAgICAgICB1c2VyQ29uZGl0aW9ucyxcbiAgICAgICAgICAgICk7XG5cbiAgICAgICAgICAgIGNvbnN0IHRoZXJhcGlzdEZvck1hdGNoaW5nOiBUaGVyYXBpc3RGb3JNYXRjaGluZyA9IHtcbiAgICAgICAgICAgICAgLi4udGhlcmFwaXN0LFxuICAgICAgICAgICAgICB1c2VyOiB0aGVyYXBpc3QudXNlcixcbiAgICAgICAgICAgICAgcmV2aWV3czogdGhlcmFwaXN0LnJldmlld3MgfHwgW10sXG4gICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICB0aGVyYXBpc3RTY29yZXMucHVzaCh7XG4gICAgICAgICAgICAgIHRoZXJhcGlzdDogdGhlcmFwaXN0Rm9yTWF0Y2hpbmcsXG4gICAgICAgICAgICAgIHRvdGFsU2NvcmU6IGJhc2ljU2NvcmUsXG4gICAgICAgICAgICAgIGJyZWFrZG93bjoge1xuICAgICAgICAgICAgICAgIGNvbmRpdGlvblNjb3JlOiBNYXRoLnJvdW5kKGJhc2ljU2NvcmUgKiAwLjYpLFxuICAgICAgICAgICAgICAgIGFwcHJvYWNoU2NvcmU6IDAsXG4gICAgICAgICAgICAgICAgZXhwZXJpZW5jZVNjb3JlOiBNYXRoLnJvdW5kKGJhc2ljU2NvcmUgKiAwLjQpLFxuICAgICAgICAgICAgICAgIHJldmlld1Njb3JlOiAwLFxuICAgICAgICAgICAgICAgIGxvZ2lzdGljc1Njb3JlOiAwLFxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICBtYXRjaEV4cGxhbmF0aW9uOiB7XG4gICAgICAgICAgICAgICAgcHJpbWFyeU1hdGNoZXM6IHRoaXMuZ2V0UHJpbWFyeUNvbmRpdGlvbnModXNlckNvbmRpdGlvbnMpLFxuICAgICAgICAgICAgICAgIHNlY29uZGFyeU1hdGNoZXM6IHRoaXMuZ2V0U2Vjb25kYXJ5Q29uZGl0aW9ucyh1c2VyQ29uZGl0aW9ucyksXG4gICAgICAgICAgICAgICAgYXBwcm9hY2hNYXRjaGVzOiBbXSxcbiAgICAgICAgICAgICAgICBleHBlcmllbmNlWWVhcnM6IHRoaXMuY2FsY3VsYXRlWWVhcnNPZkV4cGVyaWVuY2UoXG4gICAgICAgICAgICAgICAgICB0aGVyYXBpc3QucHJhY3RpY2VTdGFydERhdGUsXG4gICAgICAgICAgICAgICAgKSxcbiAgICAgICAgICAgICAgICBhdmVyYWdlUmF0aW5nOiAwLFxuICAgICAgICAgICAgICAgIHRvdGFsUmV2aWV3czogMCxcbiAgICAgICAgICAgICAgICBzdWNjZXNzUmF0ZXM6IHt9LFxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIHRoaXMubG9nZ2VyLndhcm4oXG4gICAgICAgICAgICAgIGBVc2luZyBiYXNpYyBzY29yaW5nIGZhbGxiYWNrIGZvciB0aGVyYXBpc3QgJHt0aGVyYXBpc3QudXNlcklkfSBkdWUgdG8gYWR2YW5jZWQgbWF0Y2hpbmcgZmFpbHVyZWAsXG4gICAgICAgICAgICApO1xuICAgICAgICAgIH0gY2F0Y2ggKGJhc2ljU2NvcmluZ0Vycm9yKSB7XG4gICAgICAgICAgICAvLyBJZiBldmVuIGJhc2ljIHNjb3JpbmcgZmFpbHMsIGxvZyBhbmQgc2tpcCB0aGlzIHRoZXJhcGlzdFxuICAgICAgICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoXG4gICAgICAgICAgICAgIGBCb3RoIGFkdmFuY2VkIGFuZCBiYXNpYyBzY29yaW5nIGZhaWxlZCBmb3IgdGhlcmFwaXN0ICR7dGhlcmFwaXN0LnVzZXJJZH1gLFxuICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgYWR2YW5jZWRFcnJvcjpcbiAgICAgICAgICAgICAgICAgIGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogU3RyaW5nKGVycm9yKSxcbiAgICAgICAgICAgICAgICBiYXNpY0Vycm9yOlxuICAgICAgICAgICAgICAgICAgYmFzaWNTY29yaW5nRXJyb3IgaW5zdGFuY2VvZiBFcnJvclxuICAgICAgICAgICAgICAgICAgICA/IGJhc2ljU2NvcmluZ0Vycm9yLm1lc3NhZ2VcbiAgICAgICAgICAgICAgICAgICAgOiBTdHJpbmcoYmFzaWNTY29yaW5nRXJyb3IpLFxuICAgICAgICAgICAgICAgIHRoZXJhcGlzdElkOiB0aGVyYXBpc3QudXNlcklkLFxuICAgICAgICAgICAgICAgIHVzZXJJZDogcmVxdWVzdC51c2VySWQsXG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICApO1xuICAgICAgICAgICAgLy8gU2tpcCB0aGlzIHRoZXJhcGlzdCBlbnRpcmVseVxuICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIC8vIExvZyBzdW1tYXJ5IG9mIG1hdGNoaW5nIHBlcmZvcm1hbmNlXG4gICAgICB0aGlzLmxvZ2dlci5sb2coXG4gICAgICAgIGBNYXRjaGluZyBjb21wbGV0ZWQgZm9yIHVzZXIgJHtyZXF1ZXN0LnVzZXJJZH06ICR7dGhlcmFwaXN0U2NvcmVzLmxlbmd0aH0gc3VjY2Vzc2Z1bCBtYXRjaGVzLCAke2FkdmFuY2VkTWF0Y2hpbmdGYWlsdXJlc30gZmFsbGJhY2tzYCxcbiAgICAgICk7XG5cbiAgICAgIC8vIFNvcnQgYnkgdG90YWwgc2NvcmUgZGVzY2VuZGluZ1xuICAgICAgY29uc3Qgc29ydGVkVGhlcmFwaXN0U2NvcmVzID0gdGhlcmFwaXN0U2NvcmVzLnNvcnQoXG4gICAgICAgIChhLCBiKSA9PiBiLnRvdGFsU2NvcmUgLSBhLnRvdGFsU2NvcmUsXG4gICAgICApO1xuXG4gICAgICAvLyBUYWtlIG9ubHkgdGhlIHJlcXVlc3RlZCBudW1iZXIgb2YgcmVzdWx0c1xuICAgICAgY29uc3QgZmluYWxSZXN1bHRzID0gc29ydGVkVGhlcmFwaXN0U2NvcmVzLnNsaWNlKDAsIHJlcXVlc3QubGltaXQgPz8gMTApO1xuXG4gICAgICAvLyBUcmFjayByZWNvbW1lbmRhdGlvbiBhbmFseXRpY3NcbiAgICAgIGF3YWl0IHRoaXMubWF0Y2hpbmdBbmFseXRpY3MudHJhY2tSZWNvbW1lbmRhdGlvbihcbiAgICAgICAgcmVxdWVzdC51c2VySWQsXG4gICAgICAgIGZpbmFsUmVzdWx0cyxcbiAgICAgICAgJ2FkdmFuY2VkX3YxLjAnLFxuICAgICAgKTtcblxuICAgICAgLy8gVHJhbnNmb3JtIHRvIGV4cGVjdGVkIGZvcm1hdCB3aXRoIGVuaGFuY2VkIGluc2lnaHRzXG4gICAgICBjb25zdCB0aGVyYXBpc3RzV2l0aFNjb3JlcyA9IGZpbmFsUmVzdWx0cy5tYXAoKHNjb3JlKSA9PiB7XG4gICAgICAgIGNvbnN0IHRoZXJhcGlzdERhdGE6IGFueSA9IHtcbiAgICAgICAgICAuLi5zY29yZS50aGVyYXBpc3QsXG4gICAgICAgICAgbWF0Y2hTY29yZTogc2NvcmUudG90YWxTY29yZSxcbiAgICAgICAgICBzY29yZUJyZWFrZG93bjogc2NvcmUuYnJlYWtkb3duLFxuICAgICAgICAgIG1hdGNoRXhwbGFuYXRpb246IHNjb3JlLm1hdGNoRXhwbGFuYXRpb24sXG4gICAgICAgIH07XG5cbiAgICAgICAgLy8gQWRkIGNsaW5pY2FsIGluc2lnaHRzIGlmIGF2YWlsYWJsZVxuICAgICAgICBpZiAoY2xpbmljYWxBbmFseXNpcykge1xuICAgICAgICAgIHRoZXJhcGlzdERhdGEuY2xpbmljYWxNYXRjaCA9IHtcbiAgICAgICAgICAgIHVyZ2VuY3lBbGlnbm1lbnQ6IHRoaXMuYXNzZXNzVXJnZW5jeUFsaWdubWVudChcbiAgICAgICAgICAgICAgc2NvcmUudGhlcmFwaXN0LFxuICAgICAgICAgICAgICBjbGluaWNhbEFuYWx5c2lzLFxuICAgICAgICAgICAgKSxcbiAgICAgICAgICAgIHNwZWNpYWxpemF0aW9uTWF0Y2g6IHRoaXMuYXNzZXNzU3BlY2lhbGl6YXRpb25NYXRjaChcbiAgICAgICAgICAgICAgc2NvcmUudGhlcmFwaXN0LFxuICAgICAgICAgICAgICBjbGluaWNhbEFuYWx5c2lzLFxuICAgICAgICAgICAgKSxcbiAgICAgICAgICAgIGV4cGVyaWVuY2VBZGVxdWFjeTogdGhpcy5hc3Nlc3NFeHBlcmllbmNlQWRlcXVhY3koXG4gICAgICAgICAgICAgIHNjb3JlLnRoZXJhcGlzdCxcbiAgICAgICAgICAgICAgY2xpbmljYWxBbmFseXNpcyxcbiAgICAgICAgICAgICksXG4gICAgICAgICAgICBhcHByb2FjaENvbXBhdGliaWxpdHk6IHRoaXMuYXNzZXNzQXBwcm9hY2hDb21wYXRpYmlsaXR5KFxuICAgICAgICAgICAgICBzY29yZS50aGVyYXBpc3QsXG4gICAgICAgICAgICAgIGNsaW5pY2FsQW5hbHlzaXMsXG4gICAgICAgICAgICApLFxuICAgICAgICAgIH07XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdGhlcmFwaXN0RGF0YTtcbiAgICAgIH0pO1xuXG4gICAgICAvLyBEZXRlcm1pbmUgcHJpbWFyeSBhbmQgc2Vjb25kYXJ5IGNvbmRpdGlvbnMgKGVuaGFuY2VkIGlmIGNsaW5pY2FsIGFuYWx5c2lzIGF2YWlsYWJsZSlcbiAgICAgIGNvbnN0IHByaW1hcnlDb25kaXRpb25zID0gY2xpbmljYWxBbmFseXNpc1xuICAgICAgICA/IGNsaW5pY2FsQW5hbHlzaXMuY2xpbmljYWxQcm9maWxlLnByaW1hcnlDb25kaXRpb25zLm1hcChcbiAgICAgICAgICAgIChwYykgPT4gcGMuY29uZGl0aW9uLFxuICAgICAgICAgIClcbiAgICAgICAgOiB0aGlzLmdldFByaW1hcnlDb25kaXRpb25zKHVzZXJDb25kaXRpb25zKTtcblxuICAgICAgY29uc3Qgc2Vjb25kYXJ5Q29uZGl0aW9ucyA9IGNsaW5pY2FsQW5hbHlzaXNcbiAgICAgICAgPyBjbGluaWNhbEFuYWx5c2lzLmNsaW5pY2FsUHJvZmlsZS5zZWNvbmRhcnlDb25kaXRpb25zLm1hcChcbiAgICAgICAgICAgIChzYykgPT4gc2MuY29uZGl0aW9uLFxuICAgICAgICAgIClcbiAgICAgICAgOiB0aGlzLmdldFNlY29uZGFyeUNvbmRpdGlvbnModXNlckNvbmRpdGlvbnMpO1xuXG4gICAgICByZXR1cm4ge1xuICAgICAgICB0b3RhbENvdW50OiB0aGVyYXBpc3RzV2l0aFNjb3Jlcy5sZW5ndGgsXG4gICAgICAgIHVzZXJDb25kaXRpb25zOiBPYmplY3Qua2V5cyh1c2VyQ29uZGl0aW9ucyksXG4gICAgICAgIHRoZXJhcGlzdHM6IHRoZXJhcGlzdHNXaXRoU2NvcmVzLFxuICAgICAgICBtYXRjaENyaXRlcmlhOiB7XG4gICAgICAgICAgcHJpbWFyeUNvbmRpdGlvbnMsXG4gICAgICAgICAgc2Vjb25kYXJ5Q29uZGl0aW9ucyxcbiAgICAgICAgICBzZXZlcml0eUxldmVscyxcbiAgICAgICAgICAuLi4oY2xpbmljYWxBbmFseXNpcyAmJiB7XG4gICAgICAgICAgICByaXNrTGV2ZWw6IGNsaW5pY2FsQW5hbHlzaXMucmlza0Fzc2Vzc21lbnQub3ZlcmFsbFJpc2ssXG4gICAgICAgICAgICB1cmdlbmN5TGV2ZWw6XG4gICAgICAgICAgICAgIGNsaW5pY2FsQW5hbHlzaXMudHJlYXRtZW50UGxhbi50aGVyYXBpc3RDcml0ZXJpYS51cmdlbmN5TGV2ZWwsXG4gICAgICAgICAgICByZXF1aXJlZFNwZWNpYWxpemF0aW9uczpcbiAgICAgICAgICAgICAgY2xpbmljYWxBbmFseXNpcy50cmVhdG1lbnRQbGFuLnRoZXJhcGlzdENyaXRlcmlhXG4gICAgICAgICAgICAgICAgLnJlcXVpcmVkU3BlY2lhbGl6YXRpb25zLFxuICAgICAgICAgICAgcHJlZmVycmVkQXBwcm9hY2hlczpcbiAgICAgICAgICAgICAgY2xpbmljYWxBbmFseXNpcy50cmVhdG1lbnRQbGFuLnRoZXJhcGlzdENyaXRlcmlhXG4gICAgICAgICAgICAgICAgLnByZWZlcnJlZEFwcHJvYWNoZXMsXG4gICAgICAgICAgfSksXG4gICAgICAgIH0sXG4gICAgICAgIGNsaW5pY2FsSW5zaWdodHM6IGNsaW5pY2FsQW5hbHlzaXNcbiAgICAgICAgICA/IHtcbiAgICAgICAgICAgICAgb3ZlcmFsbFJpc2tMZXZlbDpcbiAgICAgICAgICAgICAgICBjbGluaWNhbEFuYWx5c2lzLmNsaW5pY2FsUHJvZmlsZS5vdmVyYWxsUmlza0xldmVsLFxuICAgICAgICAgICAgICBwcmltYXJ5Q29uZGl0aW9uc0NvdW50OlxuICAgICAgICAgICAgICAgIGNsaW5pY2FsQW5hbHlzaXMuY2xpbmljYWxQcm9maWxlLnByaW1hcnlDb25kaXRpb25zLmxlbmd0aCxcbiAgICAgICAgICAgICAgdGhlcmFwZXV0aWNQcmlvcml0aWVzOlxuICAgICAgICAgICAgICAgIGNsaW5pY2FsQW5hbHlzaXMuY2xpbmljYWxQcm9maWxlLnRoZXJhcGV1dGljUHJpb3JpdGllcy5zbGljZShcbiAgICAgICAgICAgICAgICAgIDAsXG4gICAgICAgICAgICAgICAgICAzLFxuICAgICAgICAgICAgICAgICksXG4gICAgICAgICAgICAgIHJlY29tbWVuZGVkU2Vzc2lvbkZyZXF1ZW5jeTpcbiAgICAgICAgICAgICAgICBjbGluaWNhbEFuYWx5c2lzLnRyZWF0bWVudFBsYW4udGhlcmFwaXN0Q3JpdGVyaWFcbiAgICAgICAgICAgICAgICAgIC5zZXNzaW9uRnJlcXVlbmN5LFxuICAgICAgICAgICAgfVxuICAgICAgICAgIDogbnVsbCxcbiAgICAgICAgcGFnZTogMSxcbiAgICAgICAgcGFnZVNpemU6IHJlcXVlc3QubGltaXQgPz8gMTAsXG4gICAgICB9O1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAvLyBIYW5kbGUgc3BlY2lmaWMgZXJyb3IgdHlwZXMgd2l0aCBhcHByb3ByaWF0ZSBsb2dnaW5nIGFuZCByZXNwb25zZXNcbiAgICAgIGlmIChcbiAgICAgICAgZXJyb3IgaW5zdGFuY2VvZiBOb3RGb3VuZEV4Y2VwdGlvbiB8fFxuICAgICAgICBlcnJvciBpbnN0YW5jZW9mIEJhZFJlcXVlc3RFeGNlcHRpb25cbiAgICAgICkge1xuICAgICAgICAvLyBSZS10aHJvdyB2YWxpZGF0aW9uIGFuZCBub3QgZm91bmQgZXJyb3JzIGFzLWlzXG4gICAgICAgIHRocm93IGVycm9yO1xuICAgICAgfVxuXG4gICAgICAvLyBMb2cgdW5leHBlY3RlZCBlcnJvcnMgd2l0aCBmdWxsIGNvbnRleHRcbiAgICAgIHRoaXMubG9nZ2VyLmVycm9yKFxuICAgICAgICBgVW5leHBlY3RlZCBlcnJvciBpbiBnZXRSZWNvbW1lbmRlZFRoZXJhcGlzdHMgZm9yIHVzZXIgJHtyZXF1ZXN0LnVzZXJJZH1gLFxuICAgICAgICB7XG4gICAgICAgICAgZXJyb3I6IGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogU3RyaW5nKGVycm9yKSxcbiAgICAgICAgICBzdGFjazogZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLnN0YWNrIDogdW5kZWZpbmVkLFxuICAgICAgICAgIHVzZXJJZDogcmVxdWVzdC51c2VySWQsXG4gICAgICAgICAgcmVxdWVzdFBhcmFtczoge1xuICAgICAgICAgICAgbGltaXQ6IHJlcXVlc3QubGltaXQsXG4gICAgICAgICAgICBwcm92aW5jZTogcmVxdWVzdC5wcm92aW5jZSxcbiAgICAgICAgICAgIG1heEhvdXJseVJhdGU6IHJlcXVlc3QubWF4SG91cmx5UmF0ZSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgKTtcblxuICAgICAgLy8gUHJvdmlkZSBnZW5lcmljIGVycm9yIG1lc3NhZ2UgdG8gY2xpZW50IHdoaWxlIGxvZ2dpbmcgc3BlY2lmaWNzXG4gICAgICB0aHJvdyBuZXcgSW50ZXJuYWxTZXJ2ZXJFcnJvckV4Y2VwdGlvbihcbiAgICAgICAgJ0ZhaWxlZCB0byBnZXQgdGhlcmFwaXN0IHJlY29tbWVuZGF0aW9ucy4gUGxlYXNlIHRyeSBhZ2FpbiBsYXRlci4nLFxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogR2V0IGRldGFpbGVkIGNvbXBhdGliaWxpdHkgYW5hbHlzaXMgYmV0d2VlbiBhIGNsaWVudCBhbmQgdGhlcmFwaXN0XG4gICAqL1xuICBhc3luYyBnZXRDb21wYXRpYmlsaXR5QW5hbHlzaXMoY2xpZW50SWQ6IHN0cmluZywgdGhlcmFwaXN0SWQ6IHN0cmluZykge1xuICAgIGNvbnN0IGNsaWVudCA9IGF3YWl0IHRoaXMucHJpc21hLmNsaWVudC5maW5kVW5pcXVlKHtcbiAgICAgIHdoZXJlOiB7IHVzZXJJZDogY2xpZW50SWQgfSxcbiAgICAgIGluY2x1ZGU6IHtcbiAgICAgICAgcHJlQXNzZXNzbWVudDogdHJ1ZSxcbiAgICAgICAgY2xpZW50UHJlZmVyZW5jZXM6IHRydWUsXG4gICAgICAgIHVzZXI6IHRydWUsXG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgY29uc3QgdGhlcmFwaXN0ID0gYXdhaXQgdGhpcy5wcmlzbWEudGhlcmFwaXN0LmZpbmRVbmlxdWUoe1xuICAgICAgd2hlcmU6IHsgdXNlcklkOiB0aGVyYXBpc3RJZCB9LFxuICAgICAgaW5jbHVkZToge1xuICAgICAgICB1c2VyOiB0cnVlLFxuICAgICAgICByZXZpZXdzOiB7XG4gICAgICAgICAgd2hlcmU6IHsgc3RhdHVzOiAnQVBQUk9WRUQnIH0sXG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgaWYgKCFjbGllbnQgfHwgIXRoZXJhcGlzdCkge1xuICAgICAgdGhyb3cgbmV3IE5vdEZvdW5kRXhjZXB0aW9uKCdDbGllbnQgb3IgdGhlcmFwaXN0IG5vdCBmb3VuZCcpO1xuICAgIH1cblxuICAgIGlmICghY2xpZW50LnByZUFzc2Vzc21lbnQpIHtcbiAgICAgIHRocm93IG5ldyBOb3RGb3VuZEV4Y2VwdGlvbignTm8gcHJlLWFzc2Vzc21lbnQgZm91bmQgZm9yIGNsaWVudCcpO1xuICAgIH1cblxuICAgIGNvbnN0IGNvbXBhdGliaWxpdHkgPSBhd2FpdCB0aGlzLmNvbXBhdGliaWxpdHlBbmFseXNpcy5hbmFseXplQ29tcGF0aWJpbGl0eShcbiAgICAgIGNsaWVudCBhcyBhbnksIC8vIFNhZmUgYmVjYXVzZSB3ZSB2ZXJpZmllZCBwcmVBc3Nlc3NtZW50IGV4aXN0cyBhYm92ZVxuICAgICAgdGhlcmFwaXN0LFxuICAgICk7XG5cbiAgICAvLyBUcmFjayBjb21wYXRpYmlsaXR5IGFuYWx5c2lzXG4gICAgYXdhaXQgdGhpcy5tYXRjaGluZ0FuYWx5dGljcy50cmFja0NvbXBhdGliaWxpdHlBbmFseXNpcyhcbiAgICAgIGNsaWVudElkLFxuICAgICAgdGhlcmFwaXN0SWQsXG4gICAgICBjb21wYXRpYmlsaXR5LFxuICAgICAgJzEuMCcsXG4gICAgKTtcblxuICAgIHJldHVybiBjb21wYXRpYmlsaXR5O1xuICB9XG5cbiAgcHJpdmF0ZSBleHRyYWN0VXNlckNvbmRpdGlvbnMoXG4gICAgcHJlQXNzZXNzbWVudDogUHJlQXNzZXNzbWVudCxcbiAgKTogUmVjb3JkPHN0cmluZywgc3RyaW5nPiB7XG4gICAgY29uc3QgY29uZGl0aW9uczogUmVjb3JkPHN0cmluZywgc3RyaW5nPiA9IHt9O1xuICAgIGNvbnN0IHNldmVyaXR5TGV2ZWxzID0gcHJlQXNzZXNzbWVudC5zZXZlcml0eUxldmVscyBhcyBSZWNvcmQ8XG4gICAgICBzdHJpbmcsXG4gICAgICBzdHJpbmdcbiAgICA+O1xuICAgIGNvbnN0IHF1ZXN0aW9ubmFpcmVzID0gcHJlQXNzZXNzbWVudC5xdWVzdGlvbm5haXJlcyBhcyBzdHJpbmdbXTtcbiAgICBxdWVzdGlvbm5haXJlcy5mb3JFYWNoKChxKSA9PiB7XG4gICAgICBpZiAoc2V2ZXJpdHlMZXZlbHNbcV0pIHtcbiAgICAgICAgY29uZGl0aW9uc1txXSA9IHNldmVyaXR5TGV2ZWxzW3FdO1xuICAgICAgfVxuICAgIH0pO1xuICAgIHJldHVybiBjb25kaXRpb25zO1xuICB9XG5cbiAgcHJpdmF0ZSBjYWxjdWxhdGVNYXRjaFNjb3JlKFxuICAgIHRoZXJhcGlzdDogYW55LFxuICAgIHVzZXJDb25kaXRpb25zOiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+LFxuICApOiBudW1iZXIge1xuICAgIGxldCBzY29yZSA9IDA7XG4gICAgY29uc3QgZXhwZXJ0aXNlID0gKHRoZXJhcGlzdC5leHBlcnRpc2UgYXMgc3RyaW5nW10pIHx8IFtdO1xuICAgIE9iamVjdC5rZXlzKHVzZXJDb25kaXRpb25zKS5mb3JFYWNoKChjb25kaXRpb24pID0+IHtcbiAgICAgIGlmIChleHBlcnRpc2UuaW5jbHVkZXMoY29uZGl0aW9uKSkgc2NvcmUgKz0gMjA7XG4gICAgfSk7XG4gICAgc2NvcmUgKz0gTWF0aC5taW4oXG4gICAgICB0aGlzLmNhbGN1bGF0ZVllYXJzT2ZFeHBlcmllbmNlKHRoZXJhcGlzdC5wcmFjdGljZVN0YXJ0RGF0ZSkgKiAyLFxuICAgICAgMjAsXG4gICAgKTtcbiAgICAvLyBBZGQgYmFzZSBzY29yZSBmb3IgZXhwZXJpZW5jZVxuICAgIHNjb3JlICs9IHRoZXJhcGlzdC55ZWFyc09mRXhwZXJpZW5jZSA/IHRoZXJhcGlzdC55ZWFyc09mRXhwZXJpZW5jZSAqIDIgOiAwO1xuICAgIHJldHVybiBzY29yZTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0UHJpbWFyeUNvbmRpdGlvbnMoXG4gICAgdXNlckNvbmRpdGlvbnM6IFJlY29yZDxzdHJpbmcsIHN0cmluZz4sXG4gICk6IHN0cmluZ1tdIHtcbiAgICByZXR1cm4gT2JqZWN0LmVudHJpZXModXNlckNvbmRpdGlvbnMpXG4gICAgICAuZmlsdGVyKChbLCBzZXZlcml0eV0pID0+IHRoaXMuZ2V0U2V2ZXJpdHlXZWlnaHQoc2V2ZXJpdHkpID49IDQpXG4gICAgICAubWFwKChbY29uZGl0aW9uXSkgPT4gY29uZGl0aW9uKTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0U2Vjb25kYXJ5Q29uZGl0aW9ucyhcbiAgICB1c2VyQ29uZGl0aW9uczogUmVjb3JkPHN0cmluZywgc3RyaW5nPixcbiAgKTogc3RyaW5nW10ge1xuICAgIHJldHVybiBPYmplY3QuZW50cmllcyh1c2VyQ29uZGl0aW9ucylcbiAgICAgIC5maWx0ZXIoKFssIHNldmVyaXR5XSkgPT4ge1xuICAgICAgICBjb25zdCB3ZWlnaHQgPSB0aGlzLmdldFNldmVyaXR5V2VpZ2h0KHNldmVyaXR5KTtcbiAgICAgICAgcmV0dXJuIHdlaWdodCA+PSAyICYmIHdlaWdodCA8IDQ7XG4gICAgICB9KVxuICAgICAgLm1hcCgoW2NvbmRpdGlvbl0pID0+IGNvbmRpdGlvbik7XG4gIH1cblxuICBwcml2YXRlIGdldFNldmVyaXR5V2VpZ2h0KHNldmVyaXR5OiBzdHJpbmcpOiBudW1iZXIge1xuICAgIGNvbnN0IHNldmVyaXR5V2VpZ2h0czogUmVjb3JkPHN0cmluZywgbnVtYmVyPiA9IHtcbiAgICAgIE1pbmltYWw6IDEsXG4gICAgICBNaWxkOiAyLFxuICAgICAgTW9kZXJhdGU6IDMsXG4gICAgICAnTW9kZXJhdGVseSBTZXZlcmUnOiA0LFxuICAgICAgU2V2ZXJlOiA1LFxuICAgICAgJ1ZlcnkgU2V2ZXJlJzogNSxcbiAgICAgIEV4dHJlbWU6IDUsXG4gICAgICBMb3c6IDEsXG4gICAgICBIaWdoOiA0LFxuICAgICAgU3Vic3RhbnRpYWw6IDQsXG4gICAgICBTdWJjbGluaWNhbDogMSxcbiAgICAgIENsaW5pY2FsOiA0LFxuICAgICAgTm9uZTogMCxcbiAgICAgIFN1YnRocmVzaG9sZDogMixcbiAgICAgIFBvc2l0aXZlOiA0LFxuICAgICAgTmVnYXRpdmU6IDAsXG4gICAgfTtcbiAgICByZXR1cm4gc2V2ZXJpdHlXZWlnaHRzW3NldmVyaXR5XSB8fCAxO1xuICB9XG5cbiAgLyoqXG4gICAqIEFzc2VzcyBob3cgd2VsbCB0aGVyYXBpc3QncyBhdmFpbGFiaWxpdHkgYWxpZ25zIHdpdGggY2xpZW50J3MgdXJnZW5jeSBuZWVkc1xuICAgKi9cbiAgcHJpdmF0ZSBhc3Nlc3NVcmdlbmN5QWxpZ25tZW50KFxuICAgIHRoZXJhcGlzdDogYW55LFxuICAgIGNsaW5pY2FsQW5hbHlzaXM6IGFueSxcbiAgKToge1xuICAgIHNjb3JlOiBudW1iZXI7XG4gICAgcmVhc29uaW5nOiBzdHJpbmc7XG4gIH0ge1xuICAgIGNvbnN0IHVyZ2VuY3lMZXZlbCA9XG4gICAgICBjbGluaWNhbEFuYWx5c2lzLnRyZWF0bWVudFBsYW4udGhlcmFwaXN0Q3JpdGVyaWEudXJnZW5jeUxldmVsO1xuICAgIGNvbnN0IHJpc2tMZXZlbCA9IGNsaW5pY2FsQW5hbHlzaXMucmlza0Fzc2Vzc21lbnQub3ZlcmFsbFJpc2s7XG5cbiAgICBsZXQgc2NvcmUgPSA3MDsgLy8gQmFzZSBzY29yZVxuICAgIGxldCByZWFzb25pbmcgPSAnU3RhbmRhcmQgYXZhaWxhYmlsaXR5IGFsaWdubWVudCc7XG5cbiAgICAvLyBDaGVjayBpZiB0aGVyYXBpc3QgY2FuIGhhbmRsZSB1cmdlbnQgY2FzZXNcbiAgICBpZiAodXJnZW5jeUxldmVsID09PSAnaW1tZWRpYXRlJyB8fCByaXNrTGV2ZWwgPT09ICdjcml0aWNhbCcpIHtcbiAgICAgIGlmIChcbiAgICAgICAgdGhlcmFwaXN0LmFjY2VwdHNFbWVyZ2VuY3lBcHBvaW50bWVudHMgfHxcbiAgICAgICAgdGhlcmFwaXN0Lmhhc0ltbWVkaWF0ZUF2YWlsYWJpbGl0eVxuICAgICAgKSB7XG4gICAgICAgIHNjb3JlID0gOTU7XG4gICAgICAgIHJlYXNvbmluZyA9XG4gICAgICAgICAgJ0V4Y2VsbGVudCBmb3IgY3Jpc2lzIGludGVydmVudGlvbiAtIGltbWVkaWF0ZSBhdmFpbGFiaWxpdHknO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgc2NvcmUgPSAzMDtcbiAgICAgICAgcmVhc29uaW5nID0gJ01heSBub3QgYmUgc3VpdGFibGUgZm9yIGltbWVkaWF0ZSBpbnRlcnZlbnRpb24gbmVlZHMnO1xuICAgICAgfVxuICAgIH0gZWxzZSBpZiAodXJnZW5jeUxldmVsID09PSAnaGlnaCcpIHtcbiAgICAgIGlmICh0aGVyYXBpc3Qud2Vla2x5QXZhaWxhYmlsaXR5IHx8IHRoZXJhcGlzdC5mbGV4aWJsZVNjaGVkdWxpbmcpIHtcbiAgICAgICAgc2NvcmUgPSA4NTtcbiAgICAgICAgcmVhc29uaW5nID0gJ0dvb2QgYXZhaWxhYmlsaXR5IGZvciB1cmdlbnQgdGhlcmFwZXV0aWMgbmVlZHMnO1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiB7IHNjb3JlLCByZWFzb25pbmcgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiBBc3Nlc3MgdGhlcmFwaXN0J3Mgc3BlY2lhbGl6YXRpb24gbWF0Y2ggd2l0aCBjbGllbnQncyBjb25kaXRpb25zXG4gICAqL1xuICBwcml2YXRlIGFzc2Vzc1NwZWNpYWxpemF0aW9uTWF0Y2goXG4gICAgdGhlcmFwaXN0OiBhbnksXG4gICAgY2xpbmljYWxBbmFseXNpczogYW55LFxuICApOiB7XG4gICAgc2NvcmU6IG51bWJlcjtcbiAgICBtYXRjaGVkU3BlY2lhbGl6YXRpb25zOiBzdHJpbmdbXTtcbiAgICByZWFzb25pbmc6IHN0cmluZztcbiAgfSB7XG4gICAgY29uc3QgcmVxdWlyZWRTcGVjcyA9XG4gICAgICBjbGluaWNhbEFuYWx5c2lzLnRyZWF0bWVudFBsYW4udGhlcmFwaXN0Q3JpdGVyaWEucmVxdWlyZWRTcGVjaWFsaXphdGlvbnM7XG4gICAgY29uc3QgdGhlcmFwaXN0U3BlY3MgPSBbXG4gICAgICAuLi4odGhlcmFwaXN0LmV4cGVydGlzZSB8fCBbXSksXG4gICAgICAuLi4odGhlcmFwaXN0LmlsbG5lc3NTcGVjaWFsaXphdGlvbnMgfHwgW10pLFxuICAgIF07XG5cbiAgICBjb25zdCBtYXRjaGVkU3BlY3MgPSByZXF1aXJlZFNwZWNzLmZpbHRlcigocmVxKSA9PlxuICAgICAgdGhlcmFwaXN0U3BlY3Muc29tZShcbiAgICAgICAgKHNwZWMpID0+XG4gICAgICAgICAgc3BlYy50b0xvd2VyQ2FzZSgpLmluY2x1ZGVzKHJlcS50b0xvd2VyQ2FzZSgpKSB8fFxuICAgICAgICAgIHJlcS50b0xvd2VyQ2FzZSgpLmluY2x1ZGVzKHNwZWMudG9Mb3dlckNhc2UoKSksXG4gICAgICApLFxuICAgICk7XG5cbiAgICBjb25zdCBtYXRjaFJhdGlvID1cbiAgICAgIHJlcXVpcmVkU3BlY3MubGVuZ3RoID4gMCA/IG1hdGNoZWRTcGVjcy5sZW5ndGggLyByZXF1aXJlZFNwZWNzLmxlbmd0aCA6IDE7XG4gICAgY29uc3Qgc2NvcmUgPSBNYXRoLnJvdW5kKG1hdGNoUmF0aW8gKiAxMDApO1xuXG4gICAgbGV0IHJlYXNvbmluZyA9IGBNYXRjaGVzICR7bWF0Y2hlZFNwZWNzLmxlbmd0aH0vJHtyZXF1aXJlZFNwZWNzLmxlbmd0aH0gcmVxdWlyZWQgc3BlY2lhbGl6YXRpb25zYDtcbiAgICBpZiAoc2NvcmUgPj0gODApIHJlYXNvbmluZyA9ICdFeGNlbGxlbnQgc3BlY2lhbGl6YXRpb24gbWF0Y2gnO1xuICAgIGVsc2UgaWYgKHNjb3JlID49IDYwKSByZWFzb25pbmcgPSAnR29vZCBzcGVjaWFsaXphdGlvbiBhbGlnbm1lbnQnO1xuICAgIGVsc2UgaWYgKHNjb3JlID49IDQwKSByZWFzb25pbmcgPSAnUGFydGlhbCBzcGVjaWFsaXphdGlvbiBtYXRjaCc7XG4gICAgZWxzZSByZWFzb25pbmcgPSAnTGltaXRlZCBzcGVjaWFsaXphdGlvbiBtYXRjaCc7XG5cbiAgICByZXR1cm4ge1xuICAgICAgc2NvcmUsXG4gICAgICBtYXRjaGVkU3BlY2lhbGl6YXRpb25zOiBtYXRjaGVkU3BlY3MsXG4gICAgICByZWFzb25pbmcsXG4gICAgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiBBc3Nlc3MgaWYgdGhlcmFwaXN0IGhhcyBhZGVxdWF0ZSBleHBlcmllbmNlIGZvciBjbGllbnQncyBuZWVkc1xuICAgKi9cbiAgcHJpdmF0ZSBhc3Nlc3NFeHBlcmllbmNlQWRlcXVhY3koXG4gICAgdGhlcmFwaXN0OiBhbnksXG4gICAgY2xpbmljYWxBbmFseXNpczogYW55LFxuICApOiB7XG4gICAgc2NvcmU6IG51bWJlcjtcbiAgICByZWFzb25pbmc6IHN0cmluZztcbiAgfSB7XG4gICAgY29uc3QgcmVxdWlyZWRMZXZlbCA9XG4gICAgICBjbGluaWNhbEFuYWx5c2lzLnRyZWF0bWVudFBsYW4udGhlcmFwaXN0Q3JpdGVyaWEuZXhwZXJpZW5jZUxldmVsO1xuICAgIGNvbnN0IHRoZXJhcGlzdFllYXJzID1cbiAgICAgIHRoZXJhcGlzdC55ZWFyc09mRXhwZXJpZW5jZSB8fFxuICAgICAgdGhpcy5jYWxjdWxhdGVZZWFyc09mRXhwZXJpZW5jZSh0aGVyYXBpc3QucHJhY3RpY2VTdGFydERhdGUpO1xuXG4gICAgY29uc3QgcmVxdWlyZWRZZWFycyA9XG4gICAgICB7XG4gICAgICAgIGFueTogMCxcbiAgICAgICAgaW50ZXJtZWRpYXRlOiAzLFxuICAgICAgICBzZW5pb3I6IDcsXG4gICAgICAgIGV4cGVydDogMTIsXG4gICAgICB9W3JlcXVpcmVkTGV2ZWxdIHx8IDA7XG5cbiAgICBpZiAodGhlcmFwaXN0WWVhcnMgPj0gcmVxdWlyZWRZZWFycykge1xuICAgICAgY29uc3Qgc2NvcmUgPSBNYXRoLm1pbigxMDAsIDcwICsgKHRoZXJhcGlzdFllYXJzIC0gcmVxdWlyZWRZZWFycykgKiAzKTtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIHNjb3JlLFxuICAgICAgICByZWFzb25pbmc6IGAke3RoZXJhcGlzdFllYXJzfSB5ZWFycyBleHBlcmllbmNlIG1lZXRzICR7cmVxdWlyZWRMZXZlbH0gbGV2ZWwgcmVxdWlyZW1lbnRgLFxuICAgICAgfTtcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc3Qgc2NvcmUgPSBNYXRoLm1heCgyMCwgKHRoZXJhcGlzdFllYXJzIC8gcmVxdWlyZWRZZWFycykgKiA2MCk7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBzY29yZSxcbiAgICAgICAgcmVhc29uaW5nOiBgJHt0aGVyYXBpc3RZZWFyc30geWVhcnMgZXhwZXJpZW5jZSBiZWxvdyAke3JlcXVpcmVkTGV2ZWx9IGxldmVsICgke3JlcXVpcmVkWWVhcnN9KyB5ZWFycylgLFxuICAgICAgfTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogQXNzZXNzIHRoZXJhcGlzdCdzIHRoZXJhcGV1dGljIGFwcHJvYWNoIGNvbXBhdGliaWxpdHlcbiAgICovXG4gIHByaXZhdGUgYXNzZXNzQXBwcm9hY2hDb21wYXRpYmlsaXR5KFxuICAgIHRoZXJhcGlzdDogYW55LFxuICAgIGNsaW5pY2FsQW5hbHlzaXM6IGFueSxcbiAgKToge1xuICAgIHNjb3JlOiBudW1iZXI7XG4gICAgbWF0Y2hlZEFwcHJvYWNoZXM6IHN0cmluZ1tdO1xuICAgIHJlYXNvbmluZzogc3RyaW5nO1xuICB9IHtcbiAgICBjb25zdCBwcmVmZXJyZWRBcHByb2FjaGVzID1cbiAgICAgIGNsaW5pY2FsQW5hbHlzaXMudHJlYXRtZW50UGxhbi50aGVyYXBpc3RDcml0ZXJpYS5wcmVmZXJyZWRBcHByb2FjaGVzO1xuICAgIGNvbnN0IHRoZXJhcGlzdEFwcHJvYWNoZXMgPSBbXG4gICAgICAuLi4odGhlcmFwaXN0LmFwcHJvYWNoZXMgfHwgW10pLFxuICAgICAgLi4uKHRoZXJhcGlzdC50aGVyYXBldXRpY0FwcHJvYWNoZXNVc2VkTGlzdCB8fCBbXSksXG4gICAgXTtcblxuICAgIGNvbnN0IG1hdGNoZWRBcHByb2FjaGVzID0gcHJlZmVycmVkQXBwcm9hY2hlcy5maWx0ZXIoKHByZWYpID0+XG4gICAgICB0aGVyYXBpc3RBcHByb2FjaGVzLnNvbWUoXG4gICAgICAgIChhcHByb2FjaCkgPT5cbiAgICAgICAgICBhcHByb2FjaC50b0xvd2VyQ2FzZSgpLmluY2x1ZGVzKHByZWYudG9Mb3dlckNhc2UoKSkgfHxcbiAgICAgICAgICBwcmVmLnRvTG93ZXJDYXNlKCkuaW5jbHVkZXMoYXBwcm9hY2gudG9Mb3dlckNhc2UoKSksXG4gICAgICApLFxuICAgICk7XG5cbiAgICBjb25zdCBtYXRjaFJhdGlvID1cbiAgICAgIHByZWZlcnJlZEFwcHJvYWNoZXMubGVuZ3RoID4gMFxuICAgICAgICA/IG1hdGNoZWRBcHByb2FjaGVzLmxlbmd0aCAvIHByZWZlcnJlZEFwcHJvYWNoZXMubGVuZ3RoXG4gICAgICAgIDogMC43O1xuICAgIGNvbnN0IHNjb3JlID0gTWF0aC5yb3VuZChtYXRjaFJhdGlvICogMTAwKTtcblxuICAgIGxldCByZWFzb25pbmcgPSBgTWF0Y2hlcyAke21hdGNoZWRBcHByb2FjaGVzLmxlbmd0aH0vJHtwcmVmZXJyZWRBcHByb2FjaGVzLmxlbmd0aH0gcHJlZmVycmVkIGFwcHJvYWNoZXNgO1xuICAgIGlmIChzY29yZSA+PSA4MCkgcmVhc29uaW5nID0gJ0V4Y2VsbGVudCB0aGVyYXBldXRpYyBhcHByb2FjaCBtYXRjaCc7XG4gICAgZWxzZSBpZiAoc2NvcmUgPj0gNjApIHJlYXNvbmluZyA9ICdHb29kIGFwcHJvYWNoIGNvbXBhdGliaWxpdHknO1xuICAgIGVsc2UgaWYgKHNjb3JlID49IDQwKSByZWFzb25pbmcgPSAnU29tZSBhcHByb2FjaCBhbGlnbm1lbnQnO1xuICAgIGVsc2UgcmVhc29uaW5nID0gJ0xpbWl0ZWQgYXBwcm9hY2ggbWF0Y2ggLSBtYXkgc3RpbGwgYmUgZWZmZWN0aXZlJztcblxuICAgIHJldHVybiB7XG4gICAgICBzY29yZSxcbiAgICAgIG1hdGNoZWRBcHByb2FjaGVzLFxuICAgICAgcmVhc29uaW5nLFxuICAgIH07XG4gIH1cbn1cbiJdLCJ2ZXJzaW9uIjozfQ==