{"file":"/home/wetooa/Documents/code/projects/mentara/mentara-api/src/auth/services/admin-auth.service.ts","mappings":"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","names":[],"sources":["/home/wetooa/Documents/code/projects/mentara/mentara-api/src/auth/services/admin-auth.service.ts"],"sourcesContent":["import {\n  Injectable,\n  UnauthorizedException,\n  BadRequestException,\n} from '@nestjs/common';\nimport { PrismaService } from '../../providers/prisma-client.provider';\nimport { TokenService } from './token.service';\nimport { EmailVerificationService } from './email-verification.service';\nimport * as bcrypt from 'bcrypt';\n\n@Injectable()\nexport class AdminAuthService {\n  constructor(\n    private readonly prisma: PrismaService,\n    private readonly tokenService: TokenService,\n    private readonly emailVerificationService: EmailVerificationService,\n  ) {}\n\n  async createAdminAccount(\n    email: string,\n    password: string,\n    firstName: string,\n    lastName: string,\n    adminLevel: string = 'admin',\n    permissions: string[] = [],\n  ) {\n    // Check if user already exists\n    const existingUser = await this.prisma.user.findUnique({\n      where: { email },\n    });\n\n    if (existingUser) {\n      throw new BadRequestException('User with this email already exists');\n    }\n\n    // Hash password\n    const hashedPassword = await bcrypt.hash(password, 12);\n\n    // Create user and admin profile in transaction\n    const result = await this.prisma.$transaction(async (tx) => {\n      const user = await tx.user.create({\n        data: {\n          email,\n          password: hashedPassword,\n          firstName,\n          lastName,\n          role: 'admin',\n          emailVerified: true, // Admins are pre-verified\n        },\n      });\n\n      const admin = await tx.admin.create({\n        data: {\n          userId: user.id,\n          adminLevel,\n          permissions,\n        },\n      });\n\n      return { user, admin };\n    });\n\n    return {\n      user: result.user,\n      message: 'Admin account created successfully.',\n    };\n  }\n\n  async loginAdmin(\n    email: string,\n    password: string,\n    ipAddress?: string,\n    userAgent?: string,\n  ) {\n    // Find user with admin role\n    const user = await this.prisma.user.findFirst({\n      where: {\n        email,\n        role: 'admin',\n      },\n      include: {\n        admin: true,\n      },\n    });\n\n    if (!user) {\n      throw new UnauthorizedException('Invalid credentials');\n    }\n\n    // Check if account is locked\n    if (user.lockoutUntil && user.lockoutUntil > new Date()) {\n      throw new UnauthorizedException(\n        'Account is temporarily locked due to failed login attempts',\n      );\n    }\n\n    // Verify password\n    if (!user.password) {\n      throw new UnauthorizedException('Account setup incomplete');\n    }\n    const isPasswordValid = await bcrypt.compare(password, user.password);\n    if (!isPasswordValid) {\n      // Increment failed login count\n      await this.handleFailedLogin(user.id);\n      throw new UnauthorizedException('Invalid credentials');\n    }\n\n    // Reset failed login count and update last login\n    await this.prisma.user.update({\n      where: { id: user.id },\n      data: {\n        failedLoginCount: 0,\n        lockoutUntil: null,\n        lastLoginAt: new Date(),\n      },\n    });\n\n    // Generate tokens\n    const tokens = await this.tokenService.generateTokenPair(\n      user.id,\n      user.email,\n      user.role,\n      ipAddress,\n      userAgent,\n    );\n\n    return {\n      user,\n      tokens,\n    };\n  }\n\n  async getAdminProfile(userId: string) {\n    const user = await this.prisma.user.findUnique({\n      where: { id: userId },\n      include: {\n        admin: true,\n      },\n    });\n\n    if (!user || user.role !== 'admin') {\n      throw new UnauthorizedException('Admin not found');\n    }\n\n    return user;\n  }\n\n  async getAdminPermissions(userId: string) {\n    const admin = await this.prisma.admin.findUnique({\n      where: { userId },\n      select: {\n        permissions: true,\n        adminLevel: true,\n      },\n    });\n\n    if (!admin) {\n      throw new UnauthorizedException('Admin not found');\n    }\n\n    return admin;\n  }\n\n  async getAdminDashboardStats(userId: string) {\n    const admin = await this.prisma.admin.findUnique({\n      where: { userId },\n    });\n\n    if (!admin) {\n      throw new UnauthorizedException('Admin not found');\n    }\n\n    // Get various platform statistics\n    const [\n      totalUsers,\n      totalClients,\n      totalTherapists,\n      totalModerators,\n      totalAdmins,\n      pendingApplications,\n      totalCommunities,\n      totalPosts,\n    ] = await Promise.all([\n      this.prisma.user.count(),\n      this.prisma.client.count(),\n      this.prisma.therapist.count(),\n      this.prisma.moderator.count(),\n      this.prisma.admin.count(),\n      this.prisma.therapist.count({\n        where: { status: 'pending' },\n      }),\n      this.prisma.community.count(),\n      this.prisma.post.count(),\n    ]);\n\n    return {\n      totalUsers,\n      totalClients,\n      totalTherapists,\n      totalModerators,\n      totalAdmins,\n      pendingApplications,\n      totalCommunities,\n      totalPosts,\n    };\n  }\n\n  private async handleFailedLogin(userId: string) {\n    const user = await this.prisma.user.findUnique({\n      where: { id: userId },\n      select: { failedLoginCount: true },\n    });\n\n    const newFailedCount = (user?.failedLoginCount || 0) + 1;\n    const maxAttempts = 5;\n    const lockoutDuration = 30 * 60 * 1000; // 30 minutes\n\n    const updateData: any = {\n      failedLoginCount: newFailedCount,\n    };\n\n    if (newFailedCount >= maxAttempts) {\n      updateData.lockoutUntil = new Date(Date.now() + lockoutDuration);\n    }\n\n    await this.prisma.user.update({\n      where: { id: userId },\n      data: updateData,\n    });\n  }\n}\n"],"version":3}