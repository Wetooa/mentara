{"file":"/home/wetooa/Documents/code/projects/mentara/mentara-api/src/guards/clerk-auth.guard.ts","mappings":";;;;;;;;;AAAA,4CAA6C;AAC7C,2CAKwB;AAExB,4CAAmD;AAU5C,IAAM,cAAc,GAApB,MAAM,cAAc;IACR,MAAM,GAAG,IAAI,eAAM,EAAE,CAAC;IAEvC,KAAK,CAAC,WAAW,CAAC,OAAyB;QACzC,MAAM,OAAO,GAAG,OAAO,CAAC,YAAY,EAAE,CAAC,UAAU,EAAW,CAAC;QAC7D,MAAM,KAAK,GAAG,OAAO,EAAE,OAAO,CAAC,aAAa,EAAE,OAAO,CAAC,SAAS,EAAE,EAAE,CAAC,CAAC;QAErE,IAAI,CAAC,KAAK,EAAE,CAAC;YACX,OAAO,KAAK,CAAC;QACf,CAAC;QAED,IAAI,CAAC;YACH,MAAM,OAAO,GAAG,MAAM,IAAA,qBAAW,EAAC,KAAK,EAAE;gBACvC,SAAS,EAAE,OAAO,CAAC,GAAG,CAAC,gBAAgB,IAAI,EAAE;aAC9C,CAAC,CAAC;YAEH,IAAI,CAAC,OAAO,CAAC,GAAG,EAAE,CAAC;gBACjB,OAAO,KAAK,CAAC;YACf,CAAC;YAED,wBAAwB;YACxB,OAAO,CAAC,MAAM,GAAG,OAAO,CAAC,GAAG,CAAC;YAE7B,qEAAqE;YACrE,MAAM,WAAW,GAAG,IAAA,2BAAiB,EAAC;gBACpC,SAAS,EAAE,OAAO,CAAC,GAAG,CAAC,gBAAgB,IAAI,EAAE;aAC9C,CAAC,CAAC;YAEH,IAAI,CAAC;gBACH,MAAM,IAAI,GAAG,MAAM,WAAW,CAAC,KAAK,CAAC,OAAO,CAAC,OAAO,CAAC,GAAG,CAAC,CAAC;gBAC1D,MAAM,IAAI,GAAG,IAAI,CAAC,cAAc,EAAE,IAA0B,CAAC;gBAE7D,OAAO,CAAC,QAAQ,GAAG,IAAI,CAAC;gBACxB,OAAO,CAAC,GAAG,CAAC,+BAA+B,EAAE,IAAI,CAAC,CAAC;gBAEnD,OAAO,IAAI,CAAC;YACd,CAAC;YAAC,OAAO,UAAU,EAAE,CAAC;gBACpB,OAAO,CAAC,KAAK,CAAC,iCAAiC,EAAE,UAAU,CAAC,CAAC;gBAC7D,gDAAgD;gBAChD,OAAO,CAAC,QAAQ,GAAG,SAAS,CAAC;gBAC7B,OAAO,IAAI,CAAC;YACd,CAAC;QACH,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YACf,IAAI,CAAC,MAAM,CAAC,KAAK,CACf,uBAAuB,EACvB,KAAK,YAAY,KAAK,CAAC,CAAC,CAAC,KAAK,CAAC,OAAO,CAAC,CAAC,CAAC,KAAK,CAC/C,CAAC;YACF,OAAO,KAAK,CAAC;QACf,CAAC;IACH,CAAC;CACF,CAAA;AAlDY,wCAAc;yBAAd,cAAc;IAD1B,IAAA,mBAAU,GAAE;GACA,cAAc,CAkD1B","names":[],"sources":["/home/wetooa/Documents/code/projects/mentara/mentara-api/src/guards/clerk-auth.guard.ts"],"sourcesContent":["import { verifyToken } from '@clerk/backend';\nimport {\n  Injectable,\n  CanActivate,\n  ExecutionContext,\n  Logger,\n} from '@nestjs/common';\nimport { Request } from 'express';\nimport { createClerkClient } from '@clerk/backend';\n\ndeclare module 'express' {\n  interface Request {\n    userId: string;\n    userRole?: string;\n  }\n}\n\n@Injectable()\nexport class ClerkAuthGuard implements CanActivate {\n  private readonly logger = new Logger();\n\n  async canActivate(context: ExecutionContext) {\n    const request = context.switchToHttp().getRequest<Request>();\n    const token = request?.headers.authorization?.replace('Bearer ', '');\n\n    if (!token) {\n      return false;\n    }\n\n    try {\n      const session = await verifyToken(token, {\n        secretKey: process.env.CLERK_SECRET_KEY ?? '',\n      });\n\n      if (!session.sub) {\n        return false;\n      }\n\n      // Set userId from token\n      request.userId = session.sub;\n\n      // Use Clerk server-side API to get user with metadata including role\n      const clerkClient = createClerkClient({\n        secretKey: process.env.CLERK_SECRET_KEY ?? '',\n      });\n\n      try {\n        const user = await clerkClient.users.getUser(session.sub);\n        const role = user.publicMetadata?.role as string | undefined;\n\n        request.userRole = role;\n        console.log('Fetched user role from Clerk:', role);\n\n        return true;\n      } catch (clerkError) {\n        console.error('Error fetching user from Clerk:', clerkError);\n        // Continue without role if Clerk API call fails\n        request.userRole = undefined;\n        return true;\n      }\n    } catch (error) {\n      this.logger.error(\n        'Error verifying token',\n        error instanceof Error ? error.message : error,\n      );\n      return false;\n    }\n  }\n}\n"],"version":3}