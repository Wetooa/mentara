1d6ea94213e9f956efed3defd0c12646
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.ClerkAuthGuard = void 0;
const backend_1 = require("@clerk/backend");
const common_1 = require("@nestjs/common");
const backend_2 = require("@clerk/backend");
let ClerkAuthGuard = class ClerkAuthGuard {
    logger = new common_1.Logger();
    async canActivate(context) {
        const request = context.switchToHttp().getRequest();
        const token = request?.headers.authorization?.replace('Bearer ', '');
        if (!token) {
            return false;
        }
        try {
            const session = await (0, backend_1.verifyToken)(token, {
                secretKey: process.env.CLERK_SECRET_KEY ?? '',
            });
            if (!session.sub) {
                return false;
            }
            // Set userId from token
            request.userId = session.sub;
            // Use Clerk server-side API to get user with metadata including role
            const clerkClient = (0, backend_2.createClerkClient)({
                secretKey: process.env.CLERK_SECRET_KEY ?? '',
            });
            try {
                const user = await clerkClient.users.getUser(session.sub);
                const role = user.publicMetadata?.role;
                request.userRole = role;
                console.log('Fetched user role from Clerk:', role);
                return true;
            }
            catch (clerkError) {
                console.error('Error fetching user from Clerk:', clerkError);
                // Continue without role if Clerk API call fails
                request.userRole = undefined;
                return true;
            }
        }
        catch (error) {
            this.logger.error('Error verifying token', error instanceof Error ? error.message : error);
            return false;
        }
    }
};
exports.ClerkAuthGuard = ClerkAuthGuard;
exports.ClerkAuthGuard = ClerkAuthGuard = __decorate([
    (0, common_1.Injectable)()
], ClerkAuthGuard);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL2d1YXJkcy9jbGVyay1hdXRoLmd1YXJkLnRzIiwibWFwcGluZ3MiOiI7Ozs7Ozs7OztBQUFBLDRDQUE2QztBQUM3QywyQ0FLd0I7QUFFeEIsNENBQW1EO0FBVTVDLElBQU0sY0FBYyxHQUFwQixNQUFNLGNBQWM7SUFDUixNQUFNLEdBQUcsSUFBSSxlQUFNLEVBQUUsQ0FBQztJQUV2QyxLQUFLLENBQUMsV0FBVyxDQUFDLE9BQXlCO1FBQ3pDLE1BQU0sT0FBTyxHQUFHLE9BQU8sQ0FBQyxZQUFZLEVBQUUsQ0FBQyxVQUFVLEVBQVcsQ0FBQztRQUM3RCxNQUFNLEtBQUssR0FBRyxPQUFPLEVBQUUsT0FBTyxDQUFDLGFBQWEsRUFBRSxPQUFPLENBQUMsU0FBUyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBRXJFLElBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQztZQUNYLE9BQU8sS0FBSyxDQUFDO1FBQ2YsQ0FBQztRQUVELElBQUksQ0FBQztZQUNILE1BQU0sT0FBTyxHQUFHLE1BQU0sSUFBQSxxQkFBVyxFQUFDLEtBQUssRUFBRTtnQkFDdkMsU0FBUyxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsZ0JBQWdCLElBQUksRUFBRTthQUM5QyxDQUFDLENBQUM7WUFFSCxJQUFJLENBQUMsT0FBTyxDQUFDLEdBQUcsRUFBRSxDQUFDO2dCQUNqQixPQUFPLEtBQUssQ0FBQztZQUNmLENBQUM7WUFFRCx3QkFBd0I7WUFDeEIsT0FBTyxDQUFDLE1BQU0sR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDO1lBRTdCLHFFQUFxRTtZQUNyRSxNQUFNLFdBQVcsR0FBRyxJQUFBLDJCQUFpQixFQUFDO2dCQUNwQyxTQUFTLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxnQkFBZ0IsSUFBSSxFQUFFO2FBQzlDLENBQUMsQ0FBQztZQUVILElBQUksQ0FBQztnQkFDSCxNQUFNLElBQUksR0FBRyxNQUFNLFdBQVcsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQztnQkFDMUQsTUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLGNBQWMsRUFBRSxJQUEwQixDQUFDO2dCQUU3RCxPQUFPLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQztnQkFDeEIsT0FBTyxDQUFDLEdBQUcsQ0FBQywrQkFBK0IsRUFBRSxJQUFJLENBQUMsQ0FBQztnQkFFbkQsT0FBTyxJQUFJLENBQUM7WUFDZCxDQUFDO1lBQUMsT0FBTyxVQUFVLEVBQUUsQ0FBQztnQkFDcEIsT0FBTyxDQUFDLEtBQUssQ0FBQyxpQ0FBaUMsRUFBRSxVQUFVLENBQUMsQ0FBQztnQkFDN0QsZ0RBQWdEO2dCQUNoRCxPQUFPLENBQUMsUUFBUSxHQUFHLFNBQVMsQ0FBQztnQkFDN0IsT0FBTyxJQUFJLENBQUM7WUFDZCxDQUFDO1FBQ0gsQ0FBQztRQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7WUFDZixJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FDZix1QkFBdUIsRUFDdkIsS0FBSyxZQUFZLEtBQUssQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUMvQyxDQUFDO1lBQ0YsT0FBTyxLQUFLLENBQUM7UUFDZixDQUFDO0lBQ0gsQ0FBQztDQUNGLENBQUE7QUFsRFksd0NBQWM7eUJBQWQsY0FBYztJQUQxQixJQUFBLG1CQUFVLEdBQUU7R0FDQSxjQUFjLENBa0QxQiIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvaG9tZS93ZXRvb2EvRG9jdW1lbnRzL2NvZGUvcHJvamVjdHMvbWVudGFyYS9tZW50YXJhLWFwaS9zcmMvZ3VhcmRzL2NsZXJrLWF1dGguZ3VhcmQudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgdmVyaWZ5VG9rZW4gfSBmcm9tICdAY2xlcmsvYmFja2VuZCc7XG5pbXBvcnQge1xuICBJbmplY3RhYmxlLFxuICBDYW5BY3RpdmF0ZSxcbiAgRXhlY3V0aW9uQ29udGV4dCxcbiAgTG9nZ2VyLFxufSBmcm9tICdAbmVzdGpzL2NvbW1vbic7XG5pbXBvcnQgeyBSZXF1ZXN0IH0gZnJvbSAnZXhwcmVzcyc7XG5pbXBvcnQgeyBjcmVhdGVDbGVya0NsaWVudCB9IGZyb20gJ0BjbGVyay9iYWNrZW5kJztcblxuZGVjbGFyZSBtb2R1bGUgJ2V4cHJlc3MnIHtcbiAgaW50ZXJmYWNlIFJlcXVlc3Qge1xuICAgIHVzZXJJZDogc3RyaW5nO1xuICAgIHVzZXJSb2xlPzogc3RyaW5nO1xuICB9XG59XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBDbGVya0F1dGhHdWFyZCBpbXBsZW1lbnRzIENhbkFjdGl2YXRlIHtcbiAgcHJpdmF0ZSByZWFkb25seSBsb2dnZXIgPSBuZXcgTG9nZ2VyKCk7XG5cbiAgYXN5bmMgY2FuQWN0aXZhdGUoY29udGV4dDogRXhlY3V0aW9uQ29udGV4dCkge1xuICAgIGNvbnN0IHJlcXVlc3QgPSBjb250ZXh0LnN3aXRjaFRvSHR0cCgpLmdldFJlcXVlc3Q8UmVxdWVzdD4oKTtcbiAgICBjb25zdCB0b2tlbiA9IHJlcXVlc3Q/LmhlYWRlcnMuYXV0aG9yaXphdGlvbj8ucmVwbGFjZSgnQmVhcmVyICcsICcnKTtcblxuICAgIGlmICghdG9rZW4pIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICB0cnkge1xuICAgICAgY29uc3Qgc2Vzc2lvbiA9IGF3YWl0IHZlcmlmeVRva2VuKHRva2VuLCB7XG4gICAgICAgIHNlY3JldEtleTogcHJvY2Vzcy5lbnYuQ0xFUktfU0VDUkVUX0tFWSA/PyAnJyxcbiAgICAgIH0pO1xuXG4gICAgICBpZiAoIXNlc3Npb24uc3ViKSB7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgIH1cblxuICAgICAgLy8gU2V0IHVzZXJJZCBmcm9tIHRva2VuXG4gICAgICByZXF1ZXN0LnVzZXJJZCA9IHNlc3Npb24uc3ViO1xuXG4gICAgICAvLyBVc2UgQ2xlcmsgc2VydmVyLXNpZGUgQVBJIHRvIGdldCB1c2VyIHdpdGggbWV0YWRhdGEgaW5jbHVkaW5nIHJvbGVcbiAgICAgIGNvbnN0IGNsZXJrQ2xpZW50ID0gY3JlYXRlQ2xlcmtDbGllbnQoe1xuICAgICAgICBzZWNyZXRLZXk6IHByb2Nlc3MuZW52LkNMRVJLX1NFQ1JFVF9LRVkgPz8gJycsXG4gICAgICB9KTtcblxuICAgICAgdHJ5IHtcbiAgICAgICAgY29uc3QgdXNlciA9IGF3YWl0IGNsZXJrQ2xpZW50LnVzZXJzLmdldFVzZXIoc2Vzc2lvbi5zdWIpO1xuICAgICAgICBjb25zdCByb2xlID0gdXNlci5wdWJsaWNNZXRhZGF0YT8ucm9sZSBhcyBzdHJpbmcgfCB1bmRlZmluZWQ7XG5cbiAgICAgICAgcmVxdWVzdC51c2VyUm9sZSA9IHJvbGU7XG4gICAgICAgIGNvbnNvbGUubG9nKCdGZXRjaGVkIHVzZXIgcm9sZSBmcm9tIENsZXJrOicsIHJvbGUpO1xuXG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgfSBjYXRjaCAoY2xlcmtFcnJvcikge1xuICAgICAgICBjb25zb2xlLmVycm9yKCdFcnJvciBmZXRjaGluZyB1c2VyIGZyb20gQ2xlcms6JywgY2xlcmtFcnJvcik7XG4gICAgICAgIC8vIENvbnRpbnVlIHdpdGhvdXQgcm9sZSBpZiBDbGVyayBBUEkgY2FsbCBmYWlsc1xuICAgICAgICByZXF1ZXN0LnVzZXJSb2xlID0gdW5kZWZpbmVkO1xuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgIH1cbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoXG4gICAgICAgICdFcnJvciB2ZXJpZnlpbmcgdG9rZW4nLFxuICAgICAgICBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6IGVycm9yLFxuICAgICAgKTtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gIH1cbn1cbiJdLCJ2ZXJzaW9uIjozfQ==