2f14f1376259b92b93bc2eb14ac61452
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var OnboardingService_1;
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
exports.OnboardingService = void 0;
const common_1 = require("@nestjs/common");
const prisma_client_provider_1 = require("../providers/prisma-client.provider");
let OnboardingService = OnboardingService_1 = class OnboardingService {
    prisma;
    logger = new common_1.Logger(OnboardingService_1.name);
    constructor(prisma) {
        this.prisma = prisma;
    }
    getRequiredStepsForRole(role) {
        const baseSteps = ['profile_setup', 'email_verification'];
        switch (role) {
            case 'client':
                return [...baseSteps, 'pre_assessment', 'community_assignment'];
            case 'therapist':
                return [
                    ...baseSteps,
                    'license_verification',
                    'profile_completion',
                    'availability_setup',
                ];
            case 'admin':
                return [...baseSteps, 'admin_training'];
            case 'moderator':
                return [...baseSteps, 'moderation_training', 'community_assignment'];
            default:
                return baseSteps;
        }
    }
    async getOnboardingStatus(userId) {
        try {
            const user = await this.prisma.user.findUnique({
                where: { id: userId },
                include: {
                    client: {
                        include: {
                            preAssessment: true,
                        },
                    },
                    memberships: true,
                    therapist: true,
                    admin: true,
                    moderator: true,
                },
            });
            if (!user) {
                throw new common_1.NotFoundException('User not found');
            }
            const requiredSteps = this.getRequiredStepsForRole(user.role);
            const steps = [];
            // Check each required step
            for (const stepName of requiredSteps) {
                const stepStatus = await this.checkStepCompletion(user, stepName);
                steps.push({
                    step: stepName,
                    completed: stepStatus.completed,
                    completedAt: stepStatus.completedAt,
                    required: true,
                });
            }
            const completedSteps = steps.filter((s) => s.completed).length;
            const overallProgress = Math.round((completedSteps / steps.length) * 100);
            const isComplete = completedSteps === steps.length;
            const nextStep = steps.find((s) => !s.completed)?.step;
            return {
                userId,
                role: user.role,
                overallProgress,
                steps,
                isComplete,
                nextStep,
            };
        }
        catch (error) {
            this.logger.error(`Failed to get onboarding status for user ${userId}:`, error);
            throw error;
        }
    }
    async checkStepCompletion(user, stepName) {
        switch (stepName) {
            case 'profile_setup': {
                const hasBasicInfo = user.firstName && user.lastName && user.email;
                return {
                    completed: hasBasicInfo,
                    completedAt: hasBasicInfo ? user.updatedAt : undefined,
                };
            }
            case 'email_verification': {
                return {
                    completed: user.isVerified,
                    completedAt: user.isVerified ? user.updatedAt : undefined,
                };
            }
            case 'pre_assessment': {
                const hasPreAssessment = user.client?.preAssessment;
                return {
                    completed: !!hasPreAssessment,
                    completedAt: hasPreAssessment
                        ? user.client.preAssessment.createdAt
                        : undefined,
                };
            }
            case 'community_assignment': {
                const hasCommunityMemberships = user.memberships?.length > 0;
                return {
                    completed: hasCommunityMemberships,
                    completedAt: hasCommunityMemberships
                        ? user.memberships[0].joinedAt
                        : undefined,
                };
            }
            case 'license_verification': {
                const hasVerifiedLicense = user.therapist?.licenseVerified;
                return {
                    completed: !!hasVerifiedLicense,
                    completedAt: hasVerifiedLicense
                        ? user.therapist.licenseVerifiedAt
                        : undefined,
                };
            }
            case 'profile_completion': {
                const hasCompleteProfile = user.therapist &&
                    user.therapist.areasOfExpertise?.length > 0 &&
                    user.therapist.therapeuticApproachesUsedList?.length > 0;
                return {
                    completed: !!hasCompleteProfile,
                    completedAt: hasCompleteProfile
                        ? user.therapist.updatedAt
                        : undefined,
                };
            }
            case 'availability_setup': {
                const hasAvailability = await this.prisma.therapistAvailability.findFirst({
                    where: { therapistId: user.id },
                });
                return {
                    completed: !!hasAvailability,
                    completedAt: hasAvailability ? hasAvailability.createdAt : undefined,
                };
            }
            case 'admin_training': {
                // For now, assume admin training is complete if they have admin permissions
                return {
                    completed: !!user.admin,
                    completedAt: user.admin ? user.admin.createdAt : undefined,
                };
            }
            case 'moderation_training': {
                // For now, assume moderation training is complete if they have moderator permissions
                return {
                    completed: !!user.moderator,
                    completedAt: user.moderator ? user.moderator.createdAt : undefined,
                };
            }
            default:
                return { completed: false };
        }
    }
    async markStepCompleted(userId, stepName) {
        try {
            // In a real implementation, you might want to validate that the step is actually completed
            // before marking it as such. For now, we'll just recalculate the status.
            this.logger.log(`Marking step ${stepName} as completed for user ${userId}`);
            // Create audit log
            await this.prisma.auditLog.create({
                data: {
                    userId,
                    action: 'COMPLETE_ONBOARDING_STEP',
                    entity: 'onboarding',
                    entityId: userId,
                    metadata: {
                        step: stepName,
                        timestamp: new Date().toISOString(),
                    },
                },
            });
            return await this.getOnboardingStatus(userId);
        }
        catch (error) {
            this.logger.error(`Failed to mark step ${stepName} as completed for user ${userId}:`, error);
            throw error;
        }
    }
    async validateOnboardingCompleteness(userId) {
        try {
            const status = await this.getOnboardingStatus(userId);
            const missingSteps = status.steps
                .filter((step) => step.required && !step.completed)
                .map((step) => step.step);
            const canProceed = status.overallProgress >= 80; // Allow some flexibility
            return {
                isComplete: status.isComplete,
                missingSteps,
                canProceed,
            };
        }
        catch (error) {
            this.logger.error(`Failed to validate onboarding completeness for user ${userId}:`, error);
            throw error;
        }
    }
    async getOnboardingInsights() {
        try {
            const allUsers = await this.prisma.user.findMany({
                include: {
                    client: {
                        include: {
                            preAssessment: true,
                        },
                    },
                    memberships: true,
                    therapist: true,
                    admin: true,
                    moderator: true,
                },
            });
            let totalProgress = 0;
            let completeCount = 0;
            const stepCompletionCounts = {};
            for (const user of allUsers) {
                const status = await this.getOnboardingStatus(user.id);
                totalProgress += status.overallProgress;
                if (status.isComplete) {
                    completeCount++;
                }
                // Track step completion for dropout analysis
                for (const step of status.steps) {
                    if (!stepCompletionCounts[step.step]) {
                        stepCompletionCounts[step.step] = 0;
                    }
                    if (step.completed) {
                        stepCompletionCounts[step.step]++;
                    }
                }
            }
            const averageProgress = allUsers.length > 0 ? totalProgress / allUsers.length : 0;
            // Find steps with lowest completion rates (potential dropoff points)
            const commonDropoffSteps = Object.entries(stepCompletionCounts)
                .sort(([, a], [, b]) => a - b)
                .slice(0, 3)
                .map(([step]) => step);
            return {
                totalUsers: allUsers.length,
                completeOnboarding: completeCount,
                incompleteOnboarding: allUsers.length - completeCount,
                averageProgress,
                commonDropoffSteps,
            };
        }
        catch (error) {
            this.logger.error('Failed to get onboarding insights:', error);
            throw error;
        }
    }
};
exports.OnboardingService = OnboardingService;
exports.OnboardingService = OnboardingService = OnboardingService_1 = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [typeof (_a = typeof prisma_client_provider_1.PrismaService !== "undefined" && prisma_client_provider_1.PrismaService) === "function" ? _a : Object])
], OnboardingService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL29uYm9hcmRpbmcvb25ib2FyZGluZy5zZXJ2aWNlLnRzIiwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7O0FBQUEsMkNBQXVFO0FBQ3ZFLGdGQUFvRTtBQW1CN0QsSUFBTSxpQkFBaUIseUJBQXZCLE1BQU0saUJBQWlCO0lBR0M7SUFGWixNQUFNLEdBQUcsSUFBSSxlQUFNLENBQUMsbUJBQWlCLENBQUMsSUFBSSxDQUFDLENBQUM7SUFFN0QsWUFBNkIsTUFBcUI7UUFBckIsV0FBTSxHQUFOLE1BQU0sQ0FBZTtJQUFHLENBQUM7SUFFOUMsdUJBQXVCLENBQUMsSUFBWTtRQUMxQyxNQUFNLFNBQVMsR0FBRyxDQUFDLGVBQWUsRUFBRSxvQkFBb0IsQ0FBQyxDQUFDO1FBRTFELFFBQVEsSUFBSSxFQUFFLENBQUM7WUFDYixLQUFLLFFBQVE7Z0JBQ1gsT0FBTyxDQUFDLEdBQUcsU0FBUyxFQUFFLGdCQUFnQixFQUFFLHNCQUFzQixDQUFDLENBQUM7WUFDbEUsS0FBSyxXQUFXO2dCQUNkLE9BQU87b0JBQ0wsR0FBRyxTQUFTO29CQUNaLHNCQUFzQjtvQkFDdEIsb0JBQW9CO29CQUNwQixvQkFBb0I7aUJBQ3JCLENBQUM7WUFDSixLQUFLLE9BQU87Z0JBQ1YsT0FBTyxDQUFDLEdBQUcsU0FBUyxFQUFFLGdCQUFnQixDQUFDLENBQUM7WUFDMUMsS0FBSyxXQUFXO2dCQUNkLE9BQU8sQ0FBQyxHQUFHLFNBQVMsRUFBRSxxQkFBcUIsRUFBRSxzQkFBc0IsQ0FBQyxDQUFDO1lBQ3ZFO2dCQUNFLE9BQU8sU0FBUyxDQUFDO1FBQ3JCLENBQUM7SUFDSCxDQUFDO0lBRUQsS0FBSyxDQUFDLG1CQUFtQixDQUFDLE1BQWM7UUFDdEMsSUFBSSxDQUFDO1lBQ0gsTUFBTSxJQUFJLEdBQUcsTUFBTSxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUM7Z0JBQzdDLEtBQUssRUFBRSxF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LEdBQUcsYUFBYTtnQkFDckQsZUFBZTtnQkFDZixrQkFBa0I7YUFDbkIsQ0FBQztRQUNKLENBQUM7UUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1lBQ2YsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsb0NBQW9DLEVBQUUsS0FBSyxDQUFDLENBQUM7WUFDL0QsTUFBTSxLQUFLLENBQUM7UUFDZCxDQUFDO0lBQ0gsQ0FBQztDQUNGLENBQUE7QUFwVFksOENBQWlCOzRCQUFqQixpQkFBaUI7SUFEN0IsSUFBQSxtQkFBVSxHQUFFO3lEQUkwQixzQ0FBYSxvQkFBYixzQ0FBYTtHQUh2QyxpQkFBaUIsQ0FvVDdCIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9ob21lL3dldG9vYS9Eb2N1bWVudHMvY29kZS9wcm9qZWN0cy9tZW50YXJhL21lbnRhcmEtYXBpL3NyYy9vbmJvYXJkaW5nL29uYm9hcmRpbmcuc2VydmljZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlLCBMb2dnZXIsIE5vdEZvdW5kRXhjZXB0aW9uIH0gZnJvbSAnQG5lc3Rqcy9jb21tb24nO1xuaW1wb3J0IHsgUHJpc21hU2VydmljZSB9IGZyb20gJy4uL3Byb3ZpZGVycy9wcmlzbWEtY2xpZW50LnByb3ZpZGVyJztcblxuZXhwb3J0IGludGVyZmFjZSBPbmJvYXJkaW5nU3RlcCB7XG4gIHN0ZXA6IHN0cmluZztcbiAgY29tcGxldGVkOiBib29sZWFuO1xuICBjb21wbGV0ZWRBdD86IERhdGU7XG4gIHJlcXVpcmVkOiBib29sZWFuO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIE9uYm9hcmRpbmdTdGF0dXMge1xuICB1c2VySWQ6IHN0cmluZztcbiAgcm9sZTogc3RyaW5nO1xuICBvdmVyYWxsUHJvZ3Jlc3M6IG51bWJlcjtcbiAgc3RlcHM6IE9uYm9hcmRpbmdTdGVwW107XG4gIGlzQ29tcGxldGU6IGJvb2xlYW47XG4gIG5leHRTdGVwPzogc3RyaW5nO1xufVxuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgT25ib2FyZGluZ1NlcnZpY2Uge1xuICBwcml2YXRlIHJlYWRvbmx5IGxvZ2dlciA9IG5ldyBMb2dnZXIoT25ib2FyZGluZ1NlcnZpY2UubmFtZSk7XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSByZWFkb25seSBwcmlzbWE6IFByaXNtYVNlcnZpY2UpIHt9XG5cbiAgcHJpdmF0ZSBnZXRSZXF1aXJlZFN0ZXBzRm9yUm9sZShyb2xlOiBzdHJpbmcpOiBzdHJpbmdbXSB7XG4gICAgY29uc3QgYmFzZVN0ZXBzID0gWydwcm9maWxlX3NldHVwJywgJ2VtYWlsX3ZlcmlmaWNhdGlvbiddO1xuXG4gICAgc3dpdGNoIChyb2xlKSB7XG4gICAgICBjYXNlICdjbGllbnQnOlxuICAgICAgICByZXR1cm4gWy4uLmJhc2VTdGVwcywgJ3ByZV9hc3Nlc3NtZW50JywgJ2NvbW11bml0eV9hc3NpZ25tZW50J107XG4gICAgICBjYXNlICd0aGVyYXBpc3QnOlxuICAgICAgICByZXR1cm4gW1xuICAgICAgICAgIC4uLmJhc2VTdGVwcyxcbiAgICAgICAgICAnbGljZW5zZV92ZXJpZmljYXRpb24nLFxuICAgICAgICAgICdwcm9maWxlX2NvbXBsZXRpb24nLFxuICAgICAgICAgICdhdmFpbGFiaWxpdHlfc2V0dXAnLFxuICAgICAgICBdO1xuICAgICAgY2FzZSAnYWRtaW4nOlxuICAgICAgICByZXR1cm4gWy4uLmJhc2VTdGVwcywgJ2FkbWluX3RyYWluaW5nJ107XG4gICAgICBjYXNlICdtb2RlcmF0b3InOlxuICAgICAgICByZXR1cm4gWy4uLmJhc2VTdGVwcywgJ21vZGVyYXRpb25fdHJhaW5pbmcnLCAnY29tbXVuaXR5X2Fzc2lnbm1lbnQnXTtcbiAgICAgIGRlZmF1bHQ6XG4gICAgICAgIHJldHVybiBiYXNlU3RlcHM7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgZ2V0T25ib2FyZGluZ1N0YXR1cyh1c2VySWQ6IHN0cmluZyk6IFByb21pc2U8T25ib2FyZGluZ1N0YXR1cz4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCB1c2VyID0gYXdhaXQgdGhpcy5wcmlzbWEudXNlci5maW5kVW5pcXVlKHtcbiAgICAgICAgd2hlcmU6IHsgaWQ6IHVzZXJJZCB9LFxuICAgICAgICBpbmNsdWRlOiB7XG4gICAgICAgICAgY2xpZW50OiB7XG4gICAgICAgICAgICBpbmNsdWRlOiB7XG4gICAgICAgICAgICAgIHByZUFzc2Vzc21lbnQ6IHRydWUsXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0sXG4gICAgICAgICAgbWVtYmVyc2hpcHM6IHRydWUsXG4gICAgICAgICAgdGhlcmFwaXN0OiB0cnVlLFxuICAgICAgICAgIGFkbWluOiB0cnVlLFxuICAgICAgICAgIG1vZGVyYXRvcjogdHJ1ZSxcbiAgICAgICAgfSxcbiAgICAgIH0pO1xuXG4gICAgICBpZiAoIXVzZXIpIHtcbiAgICAgICAgdGhyb3cgbmV3IE5vdEZvdW5kRXhjZXB0aW9uKCdVc2VyIG5vdCBmb3VuZCcpO1xuICAgICAgfVxuXG4gICAgICBjb25zdCByZXF1aXJlZFN0ZXBzID0gdGhpcy5nZXRSZXF1aXJlZFN0ZXBzRm9yUm9sZSh1c2VyLnJvbGUpO1xuICAgICAgY29uc3Qgc3RlcHM6IE9uYm9hcmRpbmdTdGVwW10gPSBbXTtcblxuICAgICAgLy8gQ2hlY2sgZWFjaCByZXF1aXJlZCBzdGVwXG4gICAgICBmb3IgKGNvbnN0IHN0ZXBOYW1lIG9mIHJlcXVpcmVkU3RlcHMpIHtcbiAgICAgICAgY29uc3Qgc3RlcFN0YXR1cyA9IGF3YWl0IHRoaXMuY2hlY2tTdGVwQ29tcGxldGlvbih1c2VyLCBzdGVwTmFtZSk7XG4gICAgICAgIHN0ZXBzLnB1c2goe1xuICAgICAgICAgIHN0ZXA6IHN0ZXBOYW1lLFxuICAgICAgICAgIGNvbXBsZXRlZDogc3RlcFN0YXR1cy5jb21wbGV0ZWQsXG4gICAgICAgICAgY29tcGxldGVkQXQ6IHN0ZXBTdGF0dXMuY29tcGxldGVkQXQsXG4gICAgICAgICAgcmVxdWlyZWQ6IHRydWUsXG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBjb21wbGV0ZWRTdGVwcyA9IHN0ZXBzLmZpbHRlcigocykgPT4gcy5jb21wbGV0ZWQpLmxlbmd0aDtcbiAgICAgIGNvbnN0IG92ZXJhbGxQcm9ncmVzcyA9IE1hdGgucm91bmQoKGNvbXBsZXRlZFN0ZXBzIC8gc3RlcHMubGVuZ3RoKSAqIDEwMCk7XG4gICAgICBjb25zdCBpc0NvbXBsZXRlID0gY29tcGxldGVkU3RlcHMgPT09IHN0ZXBzLmxlbmd0aDtcbiAgICAgIGNvbnN0IG5leHRTdGVwID0gc3RlcHMuZmluZCgocykgPT4gIXMuY29tcGxldGVkKT8uc3RlcDtcblxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgdXNlcklkLFxuICAgICAgICByb2xlOiB1c2VyLnJvbGUsXG4gICAgICAgIG92ZXJhbGxQcm9ncmVzcyxcbiAgICAgICAgc3RlcHMsXG4gICAgICAgIGlzQ29tcGxldGUsXG4gICAgICAgIG5leHRTdGVwLFxuICAgICAgfTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoXG4gICAgICAgIGBGYWlsZWQgdG8gZ2V0IG9uYm9hcmRpbmcgc3RhdHVzIGZvciB1c2VyICR7dXNlcklkfTpgLFxuICAgICAgICBlcnJvcixcbiAgICAgICk7XG4gICAgICB0aHJvdyBlcnJvcjtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGNoZWNrU3RlcENvbXBsZXRpb24oXG4gICAgdXNlcjogYW55LFxuICAgIHN0ZXBOYW1lOiBzdHJpbmcsXG4gICk6IFByb21pc2U8eyBjb21wbGV0ZWQ6IGJvb2xlYW47IGNvbXBsZXRlZEF0PzogRGF0ZSB9PiB7XG4gICAgc3dpdGNoIChzdGVwTmFtZSkge1xuICAgICAgY2FzZSAncHJvZmlsZV9zZXR1cCc6IHtcbiAgICAgICAgY29uc3QgaGFzQmFzaWNJbmZvID0gdXNlci5maXJzdE5hbWUgJiYgdXNlci5sYXN0TmFtZSAmJiB1c2VyLmVtYWlsO1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIGNvbXBsZXRlZDogaGFzQmFzaWNJbmZvLFxuICAgICAgICAgIGNvbXBsZXRlZEF0OiBoYXNCYXNpY0luZm8gPyB1c2VyLnVwZGF0ZWRBdCA6IHVuZGVmaW5lZCxcbiAgICAgICAgfTtcbiAgICAgIH1cblxuICAgICAgY2FzZSAnZW1haWxfdmVyaWZpY2F0aW9uJzoge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIGNvbXBsZXRlZDogdXNlci5pc1ZlcmlmaWVkLFxuICAgICAgICAgIGNvbXBsZXRlZEF0OiB1c2VyLmlzVmVyaWZpZWQgPyB1c2VyLnVwZGF0ZWRBdCA6IHVuZGVmaW5lZCxcbiAgICAgICAgfTtcbiAgICAgIH1cblxuICAgICAgY2FzZSAncHJlX2Fzc2Vzc21lbnQnOiB7XG4gICAgICAgIGNvbnN0IGhhc1ByZUFzc2Vzc21lbnQgPSB1c2VyLmNsaWVudD8ucHJlQXNzZXNzbWVudDtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBjb21wbGV0ZWQ6ICEhaGFzUHJlQXNzZXNzbWVudCxcbiAgICAgICAgICBjb21wbGV0ZWRBdDogaGFzUHJlQXNzZXNzbWVudFxuICAgICAgICAgICAgPyB1c2VyLmNsaWVudC5wcmVBc3Nlc3NtZW50LmNyZWF0ZWRBdFxuICAgICAgICAgICAgOiB1bmRlZmluZWQsXG4gICAgICAgIH07XG4gICAgICB9XG5cbiAgICAgIGNhc2UgJ2NvbW11bml0eV9hc3NpZ25tZW50Jzoge1xuICAgICAgICBjb25zdCBoYXNDb21tdW5pdHlNZW1iZXJzaGlwcyA9IHVzZXIubWVtYmVyc2hpcHM/Lmxlbmd0aCA+IDA7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgY29tcGxldGVkOiBoYXNDb21tdW5pdHlNZW1iZXJzaGlwcyxcbiAgICAgICAgICBjb21wbGV0ZWRBdDogaGFzQ29tbXVuaXR5TWVtYmVyc2hpcHNcbiAgICAgICAgICAgID8gdXNlci5tZW1iZXJzaGlwc1swXS5qb2luZWRBdFxuICAgICAgICAgICAgOiB1bmRlZmluZWQsXG4gICAgICAgIH07XG4gICAgICB9XG5cbiAgICAgIGNhc2UgJ2xpY2Vuc2VfdmVyaWZpY2F0aW9uJzoge1xuICAgICAgICBjb25zdCBoYXNWZXJpZmllZExpY2Vuc2UgPSB1c2VyLnRoZXJhcGlzdD8ubGljZW5zZVZlcmlmaWVkO1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIGNvbXBsZXRlZDogISFoYXNWZXJpZmllZExpY2Vuc2UsXG4gICAgICAgICAgY29tcGxldGVkQXQ6IGhhc1ZlcmlmaWVkTGljZW5zZVxuICAgICAgICAgICAgPyB1c2VyLnRoZXJhcGlzdC5saWNlbnNlVmVyaWZpZWRBdFxuICAgICAgICAgICAgOiB1bmRlZmluZWQsXG4gICAgICAgIH07XG4gICAgICB9XG5cbiAgICAgIGNhc2UgJ3Byb2ZpbGVfY29tcGxldGlvbic6IHtcbiAgICAgICAgY29uc3QgaGFzQ29tcGxldGVQcm9maWxlID1cbiAgICAgICAgICB1c2VyLnRoZXJhcGlzdCAmJlxuICAgICAgICAgIHVzZXIudGhlcmFwaXN0LmFyZWFzT2ZFeHBlcnRpc2U/Lmxlbmd0aCA+IDAgJiZcbiAgICAgICAgICB1c2VyLnRoZXJhcGlzdC50aGVyYXBldXRpY0FwcHJvYWNoZXNVc2VkTGlzdD8ubGVuZ3RoID4gMDtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBjb21wbGV0ZWQ6ICEhaGFzQ29tcGxldGVQcm9maWxlLFxuICAgICAgICAgIGNvbXBsZXRlZEF0OiBoYXNDb21wbGV0ZVByb2ZpbGVcbiAgICAgICAgICAgID8gdXNlci50aGVyYXBpc3QudXBkYXRlZEF0XG4gICAgICAgICAgICA6IHVuZGVmaW5lZCxcbiAgICAgICAgfTtcbiAgICAgIH1cblxuICAgICAgY2FzZSAnYXZhaWxhYmlsaXR5X3NldHVwJzoge1xuICAgICAgICBjb25zdCBoYXNBdmFpbGFiaWxpdHkgPVxuICAgICAgICAgIGF3YWl0IHRoaXMucHJpc21hLnRoZXJhcGlzdEF2YWlsYWJpbGl0eS5maW5kRmlyc3Qoe1xuICAgICAgICAgICAgd2hlcmU6IHsgdGhlcmFwaXN0SWQ6IHVzZXIuaWQgfSxcbiAgICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBjb21wbGV0ZWQ6ICEhaGFzQXZhaWxhYmlsaXR5LFxuICAgICAgICAgIGNvbXBsZXRlZEF0OiBoYXNBdmFpbGFiaWxpdHkgPyBoYXNBdmFpbGFiaWxpdHkuY3JlYXRlZEF0IDogdW5kZWZpbmVkLFxuICAgICAgICB9O1xuICAgICAgfVxuXG4gICAgICBjYXNlICdhZG1pbl90cmFpbmluZyc6IHtcbiAgICAgICAgLy8gRm9yIG5vdywgYXNzdW1lIGFkbWluIHRyYWluaW5nIGlzIGNvbXBsZXRlIGlmIHRoZXkgaGF2ZSBhZG1pbiBwZXJtaXNzaW9uc1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIGNvbXBsZXRlZDogISF1c2VyLmFkbWluLFxuICAgICAgICAgIGNvbXBsZXRlZEF0OiB1c2VyLmFkbWluID8gdXNlci5hZG1pbi5jcmVhdGVkQXQgOiB1bmRlZmluZWQsXG4gICAgICAgIH07XG4gICAgICB9XG5cbiAgICAgIGNhc2UgJ21vZGVyYXRpb25fdHJhaW5pbmcnOiB7XG4gICAgICAgIC8vIEZvciBub3csIGFzc3VtZSBtb2RlcmF0aW9uIHRyYWluaW5nIGlzIGNvbXBsZXRlIGlmIHRoZXkgaGF2ZSBtb2RlcmF0b3IgcGVybWlzc2lvbnNcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBjb21wbGV0ZWQ6ICEhdXNlci5tb2RlcmF0b3IsXG4gICAgICAgICAgY29tcGxldGVkQXQ6IHVzZXIubW9kZXJhdG9yID8gdXNlci5tb2RlcmF0b3IuY3JlYXRlZEF0IDogdW5kZWZpbmVkLFxuICAgICAgICB9O1xuICAgICAgfVxuXG4gICAgICBkZWZhdWx0OlxuICAgICAgICByZXR1cm4geyBjb21wbGV0ZWQ6IGZhbHNlIH07XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgbWFya1N0ZXBDb21wbGV0ZWQoXG4gICAgdXNlcklkOiBzdHJpbmcsXG4gICAgc3RlcE5hbWU6IHN0cmluZyxcbiAgKTogUHJvbWlzZTxPbmJvYXJkaW5nU3RhdHVzPiB7XG4gICAgdHJ5IHtcbiAgICAgIC8vIEluIGEgcmVhbCBpbXBsZW1lbnRhdGlvbiwgeW91IG1pZ2h0IHdhbnQgdG8gdmFsaWRhdGUgdGhhdCB0aGUgc3RlcCBpcyBhY3R1YWxseSBjb21wbGV0ZWRcbiAgICAgIC8vIGJlZm9yZSBtYXJraW5nIGl0IGFzIHN1Y2guIEZvciBub3csIHdlJ2xsIGp1c3QgcmVjYWxjdWxhdGUgdGhlIHN0YXR1cy5cblxuICAgICAgdGhpcy5sb2dnZXIubG9nKFxuICAgICAgICBgTWFya2luZyBzdGVwICR7c3RlcE5hbWV9IGFzIGNvbXBsZXRlZCBmb3IgdXNlciAke3VzZXJJZH1gLFxuICAgICAgKTtcblxuICAgICAgLy8gQ3JlYXRlIGF1ZGl0IGxvZ1xuICAgICAgYXdhaXQgdGhpcy5wcmlzbWEuYXVkaXRMb2cuY3JlYXRlKHtcbiAgICAgICAgZGF0YToge1xuICAgICAgICAgIHVzZXJJZCxcbiAgICAgICAgICBhY3Rpb246ICdDT01QTEVURV9PTkJPQVJESU5HX1NURVAnLFxuICAgICAgICAgIGVudGl0eTogJ29uYm9hcmRpbmcnLFxuICAgICAgICAgIGVudGl0eUlkOiB1c2VySWQsXG4gICAgICAgICAgbWV0YWRhdGE6IHtcbiAgICAgICAgICAgIHN0ZXA6IHN0ZXBOYW1lLFxuICAgICAgICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgIH0pO1xuXG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy5nZXRPbmJvYXJkaW5nU3RhdHVzKHVzZXJJZCk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRoaXMubG9nZ2VyLmVycm9yKFxuICAgICAgICBgRmFpbGVkIHRvIG1hcmsgc3RlcCAke3N0ZXBOYW1lfSBhcyBjb21wbGV0ZWQgZm9yIHVzZXIgJHt1c2VySWR9OmAsXG4gICAgICAgIGVycm9yLFxuICAgICAgKTtcbiAgICAgIHRocm93IGVycm9yO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIHZhbGlkYXRlT25ib2FyZGluZ0NvbXBsZXRlbmVzcyh1c2VySWQ6IHN0cmluZyk6IFByb21pc2U8e1xuICAgIGlzQ29tcGxldGU6IGJvb2xlYW47XG4gICAgbWlzc2luZ1N0ZXBzOiBzdHJpbmdbXTtcbiAgICBjYW5Qcm9jZWVkOiBib29sZWFuO1xuICB9PiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHN0YXR1cyA9IGF3YWl0IHRoaXMuZ2V0T25ib2FyZGluZ1N0YXR1cyh1c2VySWQpO1xuICAgICAgY29uc3QgbWlzc2luZ1N0ZXBzID0gc3RhdHVzLnN0ZXBzXG4gICAgICAgIC5maWx0ZXIoKHN0ZXApID0+IHN0ZXAucmVxdWlyZWQgJiYgIXN0ZXAuY29tcGxldGVkKVxuICAgICAgICAubWFwKChzdGVwKSA9PiBzdGVwLnN0ZXApO1xuXG4gICAgICBjb25zdCBjYW5Qcm9jZWVkID0gc3RhdHVzLm92ZXJhbGxQcm9ncmVzcyA+PSA4MDsgLy8gQWxsb3cgc29tZSBmbGV4aWJpbGl0eVxuXG4gICAgICByZXR1cm4ge1xuICAgICAgICBpc0NvbXBsZXRlOiBzdGF0dXMuaXNDb21wbGV0ZSxcbiAgICAgICAgbWlzc2luZ1N0ZXBzLFxuICAgICAgICBjYW5Qcm9jZWVkLFxuICAgICAgfTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoXG4gICAgICAgIGBGYWlsZWQgdG8gdmFsaWRhdGUgb25ib2FyZGluZyBjb21wbGV0ZW5lc3MgZm9yIHVzZXIgJHt1c2VySWR9OmAsXG4gICAgICAgIGVycm9yLFxuICAgICAgKTtcbiAgICAgIHRocm93IGVycm9yO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGdldE9uYm9hcmRpbmdJbnNpZ2h0cygpOiBQcm9taXNlPHtcbiAgICB0b3RhbFVzZXJzOiBudW1iZXI7XG4gICAgY29tcGxldGVPbmJvYXJkaW5nOiBudW1iZXI7XG4gICAgaW5jb21wbGV0ZU9uYm9hcmRpbmc6IG51bWJlcjtcbiAgICBhdmVyYWdlUHJvZ3Jlc3M6IG51bWJlcjtcbiAgICBjb21tb25Ecm9wb2ZmU3RlcHM6IHN0cmluZ1tdO1xuICB9PiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGFsbFVzZXJzID0gYXdhaXQgdGhpcy5wcmlzbWEudXNlci5maW5kTWFueSh7XG4gICAgICAgIGluY2x1ZGU6IHtcbiAgICAgICAgICBjbGllbnQ6IHtcbiAgICAgICAgICAgIGluY2x1ZGU6IHtcbiAgICAgICAgICAgICAgcHJlQXNzZXNzbWVudDogdHJ1ZSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgICBtZW1iZXJzaGlwczogdHJ1ZSxcbiAgICAgICAgICB0aGVyYXBpc3Q6IHRydWUsXG4gICAgICAgICAgYWRtaW46IHRydWUsXG4gICAgICAgICAgbW9kZXJhdG9yOiB0cnVlLFxuICAgICAgICB9LFxuICAgICAgfSk7XG5cbiAgICAgIGxldCB0b3RhbFByb2dyZXNzID0gMDtcbiAgICAgIGxldCBjb21wbGV0ZUNvdW50ID0gMDtcbiAgICAgIGNvbnN0IHN0ZXBDb21wbGV0aW9uQ291bnRzOiBSZWNvcmQ8c3RyaW5nLCBudW1iZXI+ID0ge307XG5cbiAgICAgIGZvciAoY29uc3QgdXNlciBvZiBhbGxVc2Vycykge1xuICAgICAgICBjb25zdCBzdGF0dXMgPSBhd2FpdCB0aGlzLmdldE9uYm9hcmRpbmdTdGF0dXModXNlci5pZCk7XG4gICAgICAgIHRvdGFsUHJvZ3Jlc3MgKz0gc3RhdHVzLm92ZXJhbGxQcm9ncmVzcztcblxuICAgICAgICBpZiAoc3RhdHVzLmlzQ29tcGxldGUpIHtcbiAgICAgICAgICBjb21wbGV0ZUNvdW50Kys7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBUcmFjayBzdGVwIGNvbXBsZXRpb24gZm9yIGRyb3BvdXQgYW5hbHlzaXNcbiAgICAgICAgZm9yIChjb25zdCBzdGVwIG9mIHN0YXR1cy5zdGVwcykge1xuICAgICAgICAgIGlmICghc3RlcENvbXBsZXRpb25Db3VudHNbc3RlcC5zdGVwXSkge1xuICAgICAgICAgICAgc3RlcENvbXBsZXRpb25Db3VudHNbc3RlcC5zdGVwXSA9IDA7XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmIChzdGVwLmNvbXBsZXRlZCkge1xuICAgICAgICAgICAgc3RlcENvbXBsZXRpb25Db3VudHNbc3RlcC5zdGVwXSsrO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICBjb25zdCBhdmVyYWdlUHJvZ3Jlc3MgPVxuICAgICAgICBhbGxVc2Vycy5sZW5ndGggPiAwID8gdG90YWxQcm9ncmVzcyAvIGFsbFVzZXJzLmxlbmd0aCA6IDA7XG5cbiAgICAgIC8vIEZpbmQgc3RlcHMgd2l0aCBsb3dlc3QgY29tcGxldGlvbiByYXRlcyAocG90ZW50aWFsIGRyb3BvZmYgcG9pbnRzKVxuICAgICAgY29uc3QgY29tbW9uRHJvcG9mZlN0ZXBzID0gT2JqZWN0LmVudHJpZXMoc3RlcENvbXBsZXRpb25Db3VudHMpXG4gICAgICAgIC5zb3J0KChbLCBhXSwgWywgYl0pID0+IGEgLSBiKVxuICAgICAgICAuc2xpY2UoMCwgMylcbiAgICAgICAgLm1hcCgoW3N0ZXBdKSA9PiBzdGVwKTtcblxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgdG90YWxVc2VyczogYWxsVXNlcnMubGVuZ3RoLFxuICAgICAgICBjb21wbGV0ZU9uYm9hcmRpbmc6IGNvbXBsZXRlQ291bnQsXG4gICAgICAgIGluY29tcGxldGVPbmJvYXJkaW5nOiBhbGxVc2Vycy5sZW5ndGggLSBjb21wbGV0ZUNvdW50LFxuICAgICAgICBhdmVyYWdlUHJvZ3Jlc3MsXG4gICAgICAgIGNvbW1vbkRyb3BvZmZTdGVwcyxcbiAgICAgIH07XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRoaXMubG9nZ2VyLmVycm9yKCdGYWlsZWQgdG8gZ2V0IG9uYm9hcmRpbmcgaW5zaWdodHM6JywgZXJyb3IpO1xuICAgICAgdGhyb3cgZXJyb3I7XG4gICAgfVxuICB9XG59XG4iXSwidmVyc2lvbiI6M30=