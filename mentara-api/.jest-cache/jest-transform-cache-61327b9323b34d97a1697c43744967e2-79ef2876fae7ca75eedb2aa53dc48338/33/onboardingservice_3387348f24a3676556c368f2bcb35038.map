{"file":"/home/wetooa/Documents/code/projects/mentara/mentara-api/src/onboarding/onboarding.service.ts","mappings":"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","names":[],"sources":["/home/wetooa/Documents/code/projects/mentara/mentara-api/src/onboarding/onboarding.service.ts"],"sourcesContent":["import { Injectable, Logger, NotFoundException } from '@nestjs/common';\nimport { PrismaService } from '../providers/prisma-client.provider';\n\nexport interface OnboardingStep {\n  step: string;\n  completed: boolean;\n  completedAt?: Date;\n  required: boolean;\n}\n\nexport interface OnboardingStatus {\n  userId: string;\n  role: string;\n  overallProgress: number;\n  steps: OnboardingStep[];\n  isComplete: boolean;\n  nextStep?: string;\n}\n\n@Injectable()\nexport class OnboardingService {\n  private readonly logger = new Logger(OnboardingService.name);\n\n  constructor(private readonly prisma: PrismaService) {}\n\n  private getRequiredStepsForRole(role: string): string[] {\n    const baseSteps = ['profile_setup', 'email_verification'];\n\n    switch (role) {\n      case 'client':\n        return [...baseSteps, 'pre_assessment', 'community_assignment'];\n      case 'therapist':\n        return [\n          ...baseSteps,\n          'license_verification',\n          'profile_completion',\n          'availability_setup',\n        ];\n      case 'admin':\n        return [...baseSteps, 'admin_training'];\n      case 'moderator':\n        return [...baseSteps, 'moderation_training', 'community_assignment'];\n      default:\n        return baseSteps;\n    }\n  }\n\n  async getOnboardingStatus(userId: string): Promise<OnboardingStatus> {\n    try {\n      const user = await this.prisma.user.findUnique({\n        where: { id: userId },\n        include: {\n          client: {\n            include: {\n              preAssessment: true,\n            },\n          },\n          memberships: true,\n          therapist: true,\n          admin: true,\n          moderator: true,\n        },\n      });\n\n      if (!user) {\n        throw new NotFoundException('User not found');\n      }\n\n      const requiredSteps = this.getRequiredStepsForRole(user.role);\n      const steps: OnboardingStep[] = [];\n\n      // Check each required step\n      for (const stepName of requiredSteps) {\n        const stepStatus = await this.checkStepCompletion(user, stepName);\n        steps.push({\n          step: stepName,\n          completed: stepStatus.completed,\n          completedAt: stepStatus.completedAt,\n          required: true,\n        });\n      }\n\n      const completedSteps = steps.filter((s) => s.completed).length;\n      const overallProgress = Math.round((completedSteps / steps.length) * 100);\n      const isComplete = completedSteps === steps.length;\n      const nextStep = steps.find((s) => !s.completed)?.step;\n\n      return {\n        userId,\n        role: user.role,\n        overallProgress,\n        steps,\n        isComplete,\n        nextStep,\n      };\n    } catch (error) {\n      this.logger.error(\n        `Failed to get onboarding status for user ${userId}:`,\n        error,\n      );\n      throw error;\n    }\n  }\n\n  private async checkStepCompletion(\n    user: any,\n    stepName: string,\n  ): Promise<{ completed: boolean; completedAt?: Date }> {\n    switch (stepName) {\n      case 'profile_setup': {\n        const hasBasicInfo = user.firstName && user.lastName && user.email;\n        return {\n          completed: hasBasicInfo,\n          completedAt: hasBasicInfo ? user.updatedAt : undefined,\n        };\n      }\n\n      case 'email_verification': {\n        return {\n          completed: user.isVerified,\n          completedAt: user.isVerified ? user.updatedAt : undefined,\n        };\n      }\n\n      case 'pre_assessment': {\n        const hasPreAssessment = user.client?.preAssessment;\n        return {\n          completed: !!hasPreAssessment,\n          completedAt: hasPreAssessment\n            ? user.client.preAssessment.createdAt\n            : undefined,\n        };\n      }\n\n      case 'community_assignment': {\n        const hasCommunityMemberships = user.memberships?.length > 0;\n        return {\n          completed: hasCommunityMemberships,\n          completedAt: hasCommunityMemberships\n            ? user.memberships[0].joinedAt\n            : undefined,\n        };\n      }\n\n      case 'license_verification': {\n        const hasVerifiedLicense = user.therapist?.licenseVerified;\n        return {\n          completed: !!hasVerifiedLicense,\n          completedAt: hasVerifiedLicense\n            ? user.therapist.licenseVerifiedAt\n            : undefined,\n        };\n      }\n\n      case 'profile_completion': {\n        const hasCompleteProfile =\n          user.therapist &&\n          user.therapist.areasOfExpertise?.length > 0 &&\n          user.therapist.therapeuticApproachesUsedList?.length > 0;\n        return {\n          completed: !!hasCompleteProfile,\n          completedAt: hasCompleteProfile\n            ? user.therapist.updatedAt\n            : undefined,\n        };\n      }\n\n      case 'availability_setup': {\n        const hasAvailability =\n          await this.prisma.therapistAvailability.findFirst({\n            where: { therapistId: user.id },\n          });\n        return {\n          completed: !!hasAvailability,\n          completedAt: hasAvailability ? hasAvailability.createdAt : undefined,\n        };\n      }\n\n      case 'admin_training': {\n        // For now, assume admin training is complete if they have admin permissions\n        return {\n          completed: !!user.admin,\n          completedAt: user.admin ? user.admin.createdAt : undefined,\n        };\n      }\n\n      case 'moderation_training': {\n        // For now, assume moderation training is complete if they have moderator permissions\n        return {\n          completed: !!user.moderator,\n          completedAt: user.moderator ? user.moderator.createdAt : undefined,\n        };\n      }\n\n      default:\n        return { completed: false };\n    }\n  }\n\n  async markStepCompleted(\n    userId: string,\n    stepName: string,\n  ): Promise<OnboardingStatus> {\n    try {\n      // In a real implementation, you might want to validate that the step is actually completed\n      // before marking it as such. For now, we'll just recalculate the status.\n\n      this.logger.log(\n        `Marking step ${stepName} as completed for user ${userId}`,\n      );\n\n      // Create audit log\n      await this.prisma.auditLog.create({\n        data: {\n          userId,\n          action: 'COMPLETE_ONBOARDING_STEP',\n          entity: 'onboarding',\n          entityId: userId,\n          metadata: {\n            step: stepName,\n            timestamp: new Date().toISOString(),\n          },\n        },\n      });\n\n      return await this.getOnboardingStatus(userId);\n    } catch (error) {\n      this.logger.error(\n        `Failed to mark step ${stepName} as completed for user ${userId}:`,\n        error,\n      );\n      throw error;\n    }\n  }\n\n  async validateOnboardingCompleteness(userId: string): Promise<{\n    isComplete: boolean;\n    missingSteps: string[];\n    canProceed: boolean;\n  }> {\n    try {\n      const status = await this.getOnboardingStatus(userId);\n      const missingSteps = status.steps\n        .filter((step) => step.required && !step.completed)\n        .map((step) => step.step);\n\n      const canProceed = status.overallProgress >= 80; // Allow some flexibility\n\n      return {\n        isComplete: status.isComplete,\n        missingSteps,\n        canProceed,\n      };\n    } catch (error) {\n      this.logger.error(\n        `Failed to validate onboarding completeness for user ${userId}:`,\n        error,\n      );\n      throw error;\n    }\n  }\n\n  async getOnboardingInsights(): Promise<{\n    totalUsers: number;\n    completeOnboarding: number;\n    incompleteOnboarding: number;\n    averageProgress: number;\n    commonDropoffSteps: string[];\n  }> {\n    try {\n      const allUsers = await this.prisma.user.findMany({\n        include: {\n          client: {\n            include: {\n              preAssessment: true,\n            },\n          },\n          memberships: true,\n          therapist: true,\n          admin: true,\n          moderator: true,\n        },\n      });\n\n      let totalProgress = 0;\n      let completeCount = 0;\n      const stepCompletionCounts: Record<string, number> = {};\n\n      for (const user of allUsers) {\n        const status = await this.getOnboardingStatus(user.id);\n        totalProgress += status.overallProgress;\n\n        if (status.isComplete) {\n          completeCount++;\n        }\n\n        // Track step completion for dropout analysis\n        for (const step of status.steps) {\n          if (!stepCompletionCounts[step.step]) {\n            stepCompletionCounts[step.step] = 0;\n          }\n          if (step.completed) {\n            stepCompletionCounts[step.step]++;\n          }\n        }\n      }\n\n      const averageProgress =\n        allUsers.length > 0 ? totalProgress / allUsers.length : 0;\n\n      // Find steps with lowest completion rates (potential dropoff points)\n      const commonDropoffSteps = Object.entries(stepCompletionCounts)\n        .sort(([, a], [, b]) => a - b)\n        .slice(0, 3)\n        .map(([step]) => step);\n\n      return {\n        totalUsers: allUsers.length,\n        completeOnboarding: completeCount,\n        incompleteOnboarding: allUsers.length - completeCount,\n        averageProgress,\n        commonDropoffSteps,\n      };\n    } catch (error) {\n      this.logger.error('Failed to get onboarding insights:', error);\n      throw error;\n    }\n  }\n}\n"],"version":3}