{"file":"/home/wetooa/Documents/code/projects/mentara/mentara-api/src/auth/services/password-reset.service.spec.ts","mappings":"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","names":[],"sources":["/home/wetooa/Documents/code/projects/mentara/mentara-api/src/auth/services/password-reset.service.spec.ts"],"sourcesContent":["import { Test, TestingModule } from '@nestjs/testing';\nimport { PasswordResetService } from './password-reset.service';\nimport { PrismaService } from '../../providers/prisma-client.provider';\nimport { EmailService } from '../../services/email.service';\nimport { TokenService } from './token.service';\nimport {\n  BadRequestException,\n  NotFoundException,\n} from '@nestjs/common';\nimport * as crypto from 'crypto';\n\njest.mock('crypto');\n\ndescribe('PasswordResetService', () => {\n  let service: PasswordResetService;\n  let prismaService: jest.Mocked<PrismaService>;\n  let emailService: jest.Mocked<EmailService>;\n  let tokenService: jest.Mocked<TokenService>;\n\n  const mockUser = {\n    id: 'user-123',\n    email: 'test@example.com',\n    firstName: 'John',\n    deactivatedAt: null,\n    resetToken: null,\n    resetTokenExpiry: null,\n    password: 'current-hashed-password',\n  };\n\n  const mockUserWithToken = {\n    id: 'user-123',\n    email: 'test@example.com',\n    firstName: 'John',\n    deactivatedAt: null,\n    resetToken: 'hashed-token',\n    resetTokenExpiry: new Date(Date.now() + 60 * 60 * 1000), // 1 hour from now\n    password: 'current-hashed-password',\n  };\n\n  const mockTokenData = {\n    token: 'raw-token',\n    hashedToken: 'hashed-token',\n    expiresAt: new Date(Date.now() + 60 * 60 * 1000),\n  };\n\n  beforeEach(async () => {\n    const module: TestingModule = await Test.createTestingModule({\n      providers: [\n        PasswordResetService,\n        {\n          provide: PrismaService,\n          useValue: {\n            user: {\n              findUnique: jest.fn(),\n              update: jest.fn(),\n              updateMany: jest.fn(),\n            },\n          },\n        },\n        {\n          provide: EmailService,\n          useValue: {\n            sendGenericEmail: jest.fn(),\n          },\n        },\n        {\n          provide: TokenService,\n          useValue: {\n            generatePasswordResetToken: jest.fn(),\n            comparePassword: jest.fn(),\n            hashPassword: jest.fn(),\n            revokeAllUserTokens: jest.fn(),\n          },\n        },\n      ],\n    }).compile();\n\n    service = module.get<PasswordResetService>(PasswordResetService);\n    prismaService = module.get(PrismaService);\n    emailService = module.get(EmailService);\n    tokenService = module.get(TokenService);\n\n    // Setup crypto mock\n    (crypto.createHash as jest.Mock).mockImplementation(() => ({\n      update: jest.fn().mockReturnThis(),\n      digest: jest.fn().mockReturnValue('hashed-token'),\n    }));\n\n    // Setup environment variables\n    process.env.FRONTEND_URL = 'https://mentara.com';\n    process.env.SUPPORT_EMAIL = 'support@mentara.com';\n    process.env.MIN_PASSWORD_LENGTH = '8';\n  });\n\n  afterEach(() => {\n    jest.clearAllMocks();\n  });\n\n  it('should be defined', () => {\n    expect(service).toBeDefined();\n  });\n\n  describe('requestPasswordReset', () => {\n    it('should send password reset email for valid user', async () => {\n      prismaService.user.findUnique.mockResolvedValue(mockUser);\n      tokenService.generatePasswordResetToken.mockResolvedValue(mockTokenData);\n      prismaService.user.update.mockResolvedValue(mockUser);\n      emailService.sendGenericEmail.mockResolvedValue(undefined);\n\n      await service.requestPasswordReset('test@example.com');\n\n      expect(prismaService.user.findUnique).toHaveBeenCalledWith({\n        where: { email: 'test@example.com' },\n        select: {\n          id: true,\n          email: true,\n          firstName: true,\n          deactivatedAt: true,\n          resetToken: true,\n          resetTokenExpiry: true,\n        },\n      });\n\n      expect(tokenService.generatePasswordResetToken).toHaveBeenCalled();\n      expect(prismaService.user.update).toHaveBeenCalledWith({\n        where: { id: 'user-123' },\n        data: {\n          resetToken: mockTokenData.hashedToken,\n          resetTokenExpiry: mockTokenData.expiresAt,\n        },\n      });\n\n      expect(emailService.sendGenericEmail).toHaveBeenCalledWith({\n        to: 'test@example.com',\n        subject: 'Reset Your Mentara Password',\n        template: 'password-reset',\n        data: {\n          firstName: 'John',\n          resetUrl: `https://mentara.com/reset-password?token=${mockTokenData.token}`,\n          expiryTime: '1 hour',\n          supportEmail: 'support@mentara.com',\n        },\n      });\n    });\n\n    it('should silently return for non-existent user (security)', async () => {\n      prismaService.user.findUnique.mockResolvedValue(null);\n\n      await expect(service.requestPasswordReset('nonexistent@example.com')).resolves.not.toThrow();\n      expect(tokenService.generatePasswordResetToken).not.toHaveBeenCalled();\n      expect(emailService.sendGenericEmail).not.toHaveBeenCalled();\n    });\n\n    it('should throw BadRequestException for deactivated user', async () => {\n      const deactivatedUser = {\n        ...mockUser,\n        deactivatedAt: new Date(),\n      };\n\n      prismaService.user.findUnique.mockResolvedValue(deactivatedUser);\n\n      await expect(service.requestPasswordReset('test@example.com')).rejects.toThrow(\n        BadRequestException,\n      );\n    });\n\n    it('should throw BadRequestException for recent token request', async () => {\n      const userWithRecentToken = {\n        ...mockUser,\n        resetToken: 'existing-token',\n        resetTokenExpiry: new Date(Date.now() + 55 * 60 * 1000), // 55 minutes from now\n      };\n\n      prismaService.user.findUnique.mockResolvedValue(userWithRecentToken);\n\n      await expect(service.requestPasswordReset('test@example.com')).rejects.toThrow(\n        BadRequestException,\n      );\n    });\n\n    it('should allow new token request for old token with less than 10 minutes remaining', async () => {\n      const userWithOldToken = {\n        ...mockUser,\n        resetToken: 'existing-token',\n        resetTokenExpiry: new Date(Date.now() + 5 * 60 * 1000), // 5 minutes from now\n      };\n\n      prismaService.user.findUnique.mockResolvedValue(userWithOldToken);\n      tokenService.generatePasswordResetToken.mockResolvedValue(mockTokenData);\n      prismaService.user.update.mockResolvedValue(mockUser);\n      emailService.sendGenericEmail.mockResolvedValue(undefined);\n\n      await service.requestPasswordReset('test@example.com');\n\n      expect(tokenService.generatePasswordResetToken).toHaveBeenCalled();\n    });\n\n    it('should handle email service failure', async () => {\n      prismaService.user.findUnique.mockResolvedValue(mockUser);\n      tokenService.generatePasswordResetToken.mockResolvedValue(mockTokenData);\n      prismaService.user.update.mockResolvedValue(mockUser);\n      emailService.sendGenericEmail.mockRejectedValue(new Error('Email service error'));\n\n      await expect(service.requestPasswordReset('test@example.com')).rejects.toThrow(\n        BadRequestException,\n      );\n    });\n  });\n\n  describe('resetPassword', () => {\n    const validPassword = 'NewPassword123!';\n\n    it('should reset password successfully', async () => {\n      const token = 'valid-token';\n      const hashedNewPassword = 'new-hashed-password';\n\n      prismaService.user.findUnique.mockResolvedValue(mockUserWithToken);\n      tokenService.comparePassword.mockResolvedValue(false); // New password is different\n      tokenService.hashPassword.mockResolvedValue(hashedNewPassword);\n      prismaService.user.update.mockResolvedValue(mockUser);\n      tokenService.revokeAllUserTokens.mockResolvedValue(undefined);\n      emailService.sendGenericEmail.mockResolvedValue(undefined);\n\n      const result = await service.resetPassword(token, validPassword);\n\n      expect(result).toEqual({\n        success: true,\n        message: 'Password reset successfully',\n      });\n\n      expect(prismaService.user.update).toHaveBeenCalledWith({\n        where: { id: 'user-123' },\n        data: {\n          password: hashedNewPassword,\n          resetToken: null,\n          resetTokenExpiry: null,\n          failedLoginCount: 0,\n          lockoutUntil: null,\n        },\n      });\n\n      expect(tokenService.revokeAllUserTokens).toHaveBeenCalledWith('user-123');\n    });\n\n    it('should throw BadRequestException for missing token', async () => {\n      await expect(service.resetPassword('', validPassword)).rejects.toThrow(\n        BadRequestException,\n      );\n    });\n\n    it('should throw BadRequestException for missing password', async () => {\n      await expect(service.resetPassword('token', '')).rejects.toThrow(\n        BadRequestException,\n      );\n    });\n\n    it('should throw BadRequestException for weak password', async () => {\n      const weakPassword = 'weak';\n\n      await expect(service.resetPassword('token', weakPassword)).rejects.toThrow(\n        BadRequestException,\n      );\n    });\n\n    it('should throw BadRequestException for invalid token', async () => {\n      prismaService.user.findUnique.mockResolvedValue(null);\n\n      await expect(service.resetPassword('invalid-token', validPassword)).rejects.toThrow(\n        BadRequestException,\n      );\n    });\n\n    it('should throw BadRequestException for expired token', async () => {\n      const userWithExpiredToken = {\n        ...mockUserWithToken,\n        resetTokenExpiry: new Date(Date.now() - 1000),\n      };\n\n      prismaService.user.findUnique.mockResolvedValue(userWithExpiredToken);\n      prismaService.user.update.mockResolvedValue(mockUser);\n\n      await expect(service.resetPassword('expired-token', validPassword)).rejects.toThrow(\n        BadRequestException,\n      );\n\n      expect(prismaService.user.update).toHaveBeenCalledWith({\n        where: { id: 'user-123' },\n        data: {\n          resetToken: null,\n          resetTokenExpiry: null,\n        },\n      });\n    });\n\n    it('should throw BadRequestException for deactivated user', async () => {\n      const deactivatedUser = {\n        ...mockUserWithToken,\n        deactivatedAt: new Date(),\n      };\n\n      prismaService.user.findUnique.mockResolvedValue(deactivatedUser);\n\n      await expect(service.resetPassword('token', validPassword)).rejects.toThrow(\n        BadRequestException,\n      );\n    });\n\n    it('should throw BadRequestException for same password', async () => {\n      const token = 'valid-token';\n\n      prismaService.user.findUnique.mockResolvedValue(mockUserWithToken);\n      tokenService.comparePassword.mockResolvedValue(true); // Same password\n\n      await expect(service.resetPassword(token, validPassword)).rejects.toThrow(\n        BadRequestException,\n      );\n    });\n\n    it('should allow password reset for user without existing password', async () => {\n      const token = 'valid-token';\n      const userWithoutPassword = {\n        ...mockUserWithToken,\n        password: null,\n      };\n      const hashedNewPassword = 'new-hashed-password';\n\n      prismaService.user.findUnique.mockResolvedValue(userWithoutPassword);\n      tokenService.hashPassword.mockResolvedValue(hashedNewPassword);\n      prismaService.user.update.mockResolvedValue(mockUser);\n      tokenService.revokeAllUserTokens.mockResolvedValue(undefined);\n      emailService.sendGenericEmail.mockResolvedValue(undefined);\n\n      const result = await service.resetPassword(token, validPassword);\n\n      expect(result.success).toBe(true);\n      expect(tokenService.comparePassword).not.toHaveBeenCalled();\n    });\n  });\n\n  describe('validateResetToken', () => {\n    it('should validate token successfully', async () => {\n      const token = 'valid-token';\n      const userWithValidToken = {\n        email: 'test@example.com',\n        resetTokenExpiry: new Date(Date.now() + 60 * 60 * 1000),\n        deactivatedAt: null,\n      };\n\n      prismaService.user.findUnique.mockResolvedValue(userWithValidToken);\n\n      const result = await service.validateResetToken(token);\n\n      expect(result).toEqual({\n        valid: true,\n        email: 'test@example.com',\n      });\n    });\n\n    it('should return invalid for missing token', async () => {\n      const result = await service.validateResetToken('');\n\n      expect(result).toEqual({ valid: false });\n    });\n\n    it('should return invalid for non-existent token', async () => {\n      prismaService.user.findUnique.mockResolvedValue(null);\n\n      const result = await service.validateResetToken('invalid-token');\n\n      expect(result).toEqual({ valid: false });\n    });\n\n    it('should return invalid for deactivated user', async () => {\n      const deactivatedUser = {\n        email: 'test@example.com',\n        resetTokenExpiry: new Date(Date.now() + 60 * 60 * 1000),\n        deactivatedAt: new Date(),\n      };\n\n      prismaService.user.findUnique.mockResolvedValue(deactivatedUser);\n\n      const result = await service.validateResetToken('token');\n\n      expect(result).toEqual({ valid: false });\n    });\n\n    it('should return invalid for expired token', async () => {\n      const userWithExpiredToken = {\n        email: 'test@example.com',\n        resetTokenExpiry: new Date(Date.now() - 1000),\n        deactivatedAt: null,\n      };\n\n      prismaService.user.findUnique.mockResolvedValue(userWithExpiredToken);\n\n      const result = await service.validateResetToken('expired-token');\n\n      expect(result).toEqual({ valid: false });\n    });\n\n    it('should return invalid for token without expiry', async () => {\n      const userWithoutExpiry = {\n        email: 'test@example.com',\n        resetTokenExpiry: null,\n        deactivatedAt: null,\n      };\n\n      prismaService.user.findUnique.mockResolvedValue(userWithoutExpiry);\n\n      const result = await service.validateResetToken('token');\n\n      expect(result).toEqual({ valid: false });\n    });\n  });\n\n  describe('validatePasswordStrength', () => {\n    it('should validate strong password', () => {\n      const strongPassword = 'StrongPassword123!';\n      expect(() => (service as any).validatePasswordStrength(strongPassword)).not.toThrow();\n    });\n\n    it('should throw for too short password', () => {\n      const shortPassword = 'Ab1!';\n      expect(() => (service as any).validatePasswordStrength(shortPassword)).toThrow(\n        BadRequestException,\n      );\n    });\n\n    it('should throw for password without uppercase', () => {\n      const noUpperPassword = 'password123!';\n      expect(() => (service as any).validatePasswordStrength(noUpperPassword)).toThrow(\n        BadRequestException,\n      );\n    });\n\n    it('should throw for password without lowercase', () => {\n      const noLowerPassword = 'PASSWORD123!';\n      expect(() => (service as any).validatePasswordStrength(noLowerPassword)).toThrow(\n        BadRequestException,\n      );\n    });\n\n    it('should throw for password without number', () => {\n      const noNumberPassword = 'Password!';\n      expect(() => (service as any).validatePasswordStrength(noNumberPassword)).toThrow(\n        BadRequestException,\n      );\n    });\n\n    it('should throw for password without special character', () => {\n      const noSpecialPassword = 'Password123';\n      expect(() => (service as any).validatePasswordStrength(noSpecialPassword)).toThrow(\n        BadRequestException,\n      );\n    });\n\n    it('should throw for common password', () => {\n      const commonPassword = 'password123';\n      expect(() => (service as any).validatePasswordStrength(commonPassword)).toThrow(\n        BadRequestException,\n      );\n    });\n\n    it('should use default min length when env variable not set', () => {\n      delete process.env.MIN_PASSWORD_LENGTH;\n      const shortPassword = 'Ab1!567'; // 7 characters\n      expect(() => (service as any).validatePasswordStrength(shortPassword)).toThrow(\n        BadRequestException,\n      );\n    });\n\n    it('should accept various special characters', () => {\n      const specialChars = '!@#$%^&*()_+-=[]{};\\':\"|,.<>/?';\n      for (const char of specialChars) {\n        const password = `Password123${char}`;\n        expect(() => (service as any).validatePasswordStrength(password)).not.toThrow();\n      }\n    });\n  });\n\n  describe('cleanupExpiredTokens', () => {\n    it('should clean up expired reset tokens', async () => {\n      prismaService.user.updateMany.mockResolvedValue({ count: 3 });\n\n      await service.cleanupExpiredTokens();\n\n      expect(prismaService.user.updateMany).toHaveBeenCalledWith({\n        where: {\n          resetTokenExpiry: {\n            lt: expect.any(Date),\n          },\n        },\n        data: {\n          resetToken: null,\n          resetTokenExpiry: null,\n        },\n      });\n    });\n  });\n\n  describe('sendPasswordResetEmail (private method)', () => {\n    it('should send password reset email with correct template data', async () => {\n      const email = 'test@example.com';\n      const firstName = 'John';\n      const token = 'reset-token';\n\n      emailService.sendGenericEmail.mockResolvedValue(undefined);\n\n      await (service as any).sendPasswordResetEmail(email, firstName, token);\n\n      expect(emailService.sendGenericEmail).toHaveBeenCalledWith({\n        to: email,\n        subject: 'Reset Your Mentara Password',\n        template: 'password-reset',\n        data: {\n          firstName,\n          resetUrl: `https://mentara.com/reset-password?token=${token}`,\n          expiryTime: '1 hour',\n          supportEmail: 'support@mentara.com',\n        },\n      });\n    });\n\n    it('should use default support email when env variable not set', async () => {\n      delete process.env.SUPPORT_EMAIL;\n      const email = 'test@example.com';\n      const firstName = 'John';\n      const token = 'reset-token';\n\n      emailService.sendGenericEmail.mockResolvedValue(undefined);\n\n      await (service as any).sendPasswordResetEmail(email, firstName, token);\n\n      expect(emailService.sendGenericEmail).toHaveBeenCalledWith({\n        to: email,\n        subject: 'Reset Your Mentara Password',\n        template: 'password-reset',\n        data: {\n          firstName,\n          resetUrl: `https://mentara.com/reset-password?token=${token}`,\n          expiryTime: '1 hour',\n          supportEmail: 'support@mentara.com',\n        },\n      });\n    });\n\n    it('should handle email service failure', async () => {\n      const email = 'test@example.com';\n      const firstName = 'John';\n      const token = 'reset-token';\n\n      emailService.sendGenericEmail.mockRejectedValue(new Error('Email service error'));\n\n      await expect(\n        (service as any).sendPasswordResetEmail(email, firstName, token),\n      ).rejects.toThrow(BadRequestException);\n    });\n  });\n\n  describe('sendPasswordResetConfirmationEmail (private method)', () => {\n    it('should send confirmation email after successful reset', async () => {\n      const email = 'test@example.com';\n\n      emailService.sendGenericEmail.mockResolvedValue(undefined);\n\n      await (service as any).sendPasswordResetConfirmationEmail(email);\n\n      expect(emailService.sendGenericEmail).toHaveBeenCalledWith({\n        to: email,\n        subject: 'Password Reset Successful',\n        template: 'password-reset-confirmation',\n        data: {\n          supportEmail: 'support@mentara.com',\n          loginUrl: 'https://mentara.com/login',\n        },\n      });\n    });\n\n    it('should not throw error if confirmation email fails', async () => {\n      const email = 'test@example.com';\n\n      emailService.sendGenericEmail.mockRejectedValue(new Error('Email service error'));\n\n      await expect(\n        (service as any).sendPasswordResetConfirmationEmail(email),\n      ).resolves.not.toThrow();\n    });\n  });\n\n  describe('crypto hash integration', () => {\n    it('should use crypto.createHash for token hashing', async () => {\n      const token = 'test-token';\n      const mockHash = {\n        update: jest.fn().mockReturnThis(),\n        digest: jest.fn().mockReturnValue('hashed-token'),\n      };\n\n      (crypto.createHash as jest.Mock).mockReturnValue(mockHash);\n\n      await service.validateResetToken(token);\n\n      expect(crypto.createHash).toHaveBeenCalledWith('sha256');\n      expect(mockHash.update).toHaveBeenCalledWith(token);\n      expect(mockHash.digest).toHaveBeenCalledWith('hex');\n    });\n  });\n\n  describe('environment variable handling', () => {\n    it('should handle missing FRONTEND_URL in reset email', async () => {\n      delete process.env.FRONTEND_URL;\n      const email = 'test@example.com';\n      const firstName = 'John';\n      const token = 'reset-token';\n\n      emailService.sendGenericEmail.mockResolvedValue(undefined);\n\n      await (service as any).sendPasswordResetEmail(email, firstName, token);\n\n      expect(emailService.sendGenericEmail).toHaveBeenCalledWith({\n        to: email,\n        subject: 'Reset Your Mentara Password',\n        template: 'password-reset',\n        data: {\n          firstName,\n          resetUrl: `undefined/reset-password?token=${token}`,\n          expiryTime: '1 hour',\n          supportEmail: 'support@mentara.com',\n        },\n      });\n    });\n\n    it('should handle missing FRONTEND_URL in confirmation email', async () => {\n      delete process.env.FRONTEND_URL;\n      const email = 'test@example.com';\n\n      emailService.sendGenericEmail.mockResolvedValue(undefined);\n\n      await (service as any).sendPasswordResetConfirmationEmail(email);\n\n      expect(emailService.sendGenericEmail).toHaveBeenCalledWith({\n        to: email,\n        subject: 'Password Reset Successful',\n        template: 'password-reset-confirmation',\n        data: {\n          supportEmail: 'support@mentara.com',\n          loginUrl: 'undefined/login',\n        },\n      });\n    });\n  });\n});"],"version":3}