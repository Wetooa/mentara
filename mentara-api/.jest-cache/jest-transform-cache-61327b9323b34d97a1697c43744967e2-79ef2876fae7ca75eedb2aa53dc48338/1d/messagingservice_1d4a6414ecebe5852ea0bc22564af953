470d523fec01f4aabd8f9cbcb8ddd64f
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var _a, _b;
Object.defineProperty(exports, "__esModule", { value: true });
exports.MessagingService = void 0;
const common_1 = require("@nestjs/common");
const prisma_client_provider_1 = require("../providers/prisma-client.provider");
const client_1 = require("@prisma/client");
const event_bus_service_1 = require("../common/events/event-bus.service");
const messaging_events_1 = require("../common/events/messaging-events");
let MessagingService = class MessagingService {
    prisma;
    eventBus;
    constructor(prisma, eventBus) {
        this.prisma = prisma;
        this.eventBus = eventBus;
    }
    // Conversation Management
    async createConversation(userId, createConversationDto) {
        const { participantIds, type = client_1.ConversationType.DIRECT, title, } = createConversationDto;
        // Validate conversation type and participants
        if (type === client_1.ConversationType.DIRECT && participantIds.length !== 1) {
            throw new common_1.BadRequestException('Direct conversations must have exactly one other participant');
        }
        // Check if direct conversation already exists
        if (type === client_1.ConversationType.DIRECT) {
            const existingConversation = await this.findDirectConversation(userId, participantIds[0]);
            if (existingConversation) {
                return existingConversation;
            }
        }
        // Create conversation with participants
        const conversation = await this.prisma.conversation.create({
            data: {
                type,
                title,
                participants: {
                    create: [
                        { userId, role: client_1.ParticipantRole.ADMIN },
                        ...participantIds.map((participantId) => ({
                            userId: participantId,
                            role: client_1.ParticipantRole.MEMBER,
                        })),
                    ],
                },
            },
            include: {
                participants: {
                    include: {
                        user: {
                            select: {
                                id: true,
                                firstName: true,
                                lastName: true,
                                avatarUrl: true,
                                role: true,
                            },
                        },
                    },
                },
                messages: {
                    take: 1,
                    orderBy: { createdAt: 'desc' },
                    include: {
                        sender: {
                            select: {
                                id: true,
                                firstName: true,
                                lastName: true,
                                avatarUrl: true,
                            },
                        },
                    },
                },
            },
        });
        // Publish conversation created event
        await this.eventBus.emit(new messaging_events_1.ConversationCreatedEvent({
            conversationId: conversation.id,
            createdBy: userId,
            participantIds: [userId, ...participantIds],
            conversationType: type.toLowerCase(),
            title: title || undefined,
            isPrivate: type === client_1.ConversationType.DIRECT,
        }));
        return conversation;
    }
    async getUserConversations(userId, page = 1, limit = 20) {
        const skip = (page - 1) * limit;
        const conversations = await this.prisma.conversation.findMany({
            where: {
                participants: {
                    some: {
                        userId,
                        isActive: true,
                    },
                },
                isActive: true,
            },
            include: {
                participants: {
                    where: { isActive: true },
                    include: {
                        user: {
                            select: {
                                id: true,
                                firstName: true,
                                lastName: true,
                                avatarUrl: true,
                                role: true,
                            },
                        },
                    },
                },
                messages: {
                    take: 1,
                    orderBy: { createdAt: 'desc' },
                    where: { isDeleted: false },
                    include: {
                        sender: {
                            select: {
                                id: true,
                                firstName: true,
                                lastName: true,
                                avatarUrl: true,
                            },
                        },
                    },
                },
                _count: {
                    select: {
                        messages: {
                            where: {
                                isDeleted: false,
                                readReceipts: {
                                    none: { userId },
                                },
                            },
                        },
                    },
                },
            },
            orderBy: { lastMessageAt: 'desc' },
            skip,
            take: limit,
        });
        return conversations;
    }
    // Message Management
    async sendMessage(userId, conversationId, sendMessageDto, attachmentUrls = [], attachmentNames = [], attachmentSizes = []) {
        // Verify user is participant in conversation
        await this.verifyParticipant(userId, conversationId);
        const { content, messageType = client_1.MessageType.TEXT, replyToId, attachmentUrl, attachmentName, attachmentSize, } = sendMessageDto;
        const message = await this.prisma.message.create({
            data: {
                conversationId,
                senderId: userId,
                content,
                messageType,
                replyToId,
                // Keep backward compatibility with single attachment fields
                attachmentUrl: attachmentUrls[0] || attachmentUrl,
                attachmentName: attachmentNames[0] || attachmentName,
                attachmentSize: attachmentSizes[0] || attachmentSize,
                // Add new multiple attachment fields
                attachmentUrls,
                attachmentNames,
                attachmentSizes,
            },
            include: {
                sender: {
                    select: {
                        id: true,
                        firstName: true,
                        lastName: true,
                        avatarUrl: true,
                    },
                },
                replyTo: {
                    include: {
                        sender: {
                            select: {
                                id: true,
                                firstName: true,
                                lastName: true,
                            },
                        },
                    },
                },
                reactions: {
                    include: {
                        user: {
                            select: {
                                id: true,
                                firstName: true,
                                lastName: true,
                            },
                        },
                    },
                },
            },
        });
        // Update conversation lastMessageAt
        await this.prisma.conversation.update({
            where: { id: conversationId },
            data: { lastMessageAt: new Date() },
        });
        // Get conversation participants for event
        const conversation = await this.prisma.conversation.findUnique({
            where: { id: conversationId },
            include: {
                participants: {
                    where: { isActive: true },
                    select: { userId: true },
                },
            },
        });
        const recipientIds = conversation?.participants
            .map((p) => p.userId)
            .filter((id) => id !== userId) || [];
        // Publish message sent event
        await this.eventBus.emit(new messaging_events_1.MessageSentEvent({
            messageId: message.id,
            conversationId,
            senderId: userId,
            content: message.content,
            messageType: message.messageType.toLowerCase(),
            sentAt: message.createdAt,
            recipientIds,
            replyToMessageId: message.replyToId || undefined,
            fileAttachments: attachmentUrls.length > 0
                ? attachmentUrls
                : message.attachmentUrl
                    ? [message.attachmentUrl]
                    : undefined,
        }));
        return message;
    }
    async getConversationMessages(userId, conversationId, page = 1, limit = 50) {
        // Verify user is participant in conversation
        await this.verifyParticipant(userId, conversationId);
        const skip = (page - 1) * limit;
        const messages = await this.prisma.message.findMany({
            where: {
                conversationId,
                isDeleted: false,
            },
            include: {
                sender: {
                    select: {
                        id: true,
                        firstName: true,
                        lastName: true,
                        avatarUrl: true,
                    },
                },
                replyTo: {
                    include: {
                        sender: {
                            select: {
                                id: true,
                                firstName: true,
                                lastName: true,
                            },
                        },
                    },
                },
                reactions: {
                    include: {
                        user: {
                            select: {
                                id: true,
                                firstName: true,
                                lastName: true,
                            },
                        },
                    },
                },
                readReceipts: {
                    include: {
                        user: {
                            select: {
                                id: true,
                                firstName: true,
                                lastName: true,
                            },
                        },
                    },
                },
            },
            orderBy: { createdAt: 'desc' },
            skip,
            take: limit,
        });
        return messages.reverse(); // Return in chronological order
    }
    async updateMessage(userId, messageId, updateMessageDto) {
        const message = await this.prisma.message.findUnique({
            where: { id: messageId },
        });
        if (!message) {
            throw new common_1.NotFoundException('Message not found');
        }
        if (message.senderId !== userId) {
            throw new common_1.ForbiddenException('You can only edit your own messages');
        }
        if (message.isDeleted) {
            throw new common_1.BadRequestException('Cannot edit deleted message');
        }
        const updatedMessage = await this.prisma.message.update({
            where: { id: messageId },
            data: {
                content: updateMessageDto.content,
                isEdited: true,
                editedAt: new Date(),
            },
            include: {
                sender: {
                    select: {
                        id: true,
                        firstName: true,
                        lastName: true,
                        avatarUrl: true,
                    },
                },
                reactions: {
                    include: {
                        user: {
                            select: {
                                id: true,
                                firstName: true,
                                lastName: true,
                            },
                        },
                    },
                },
            },
        });
        return updatedMessage;
    }
    async deleteMessage(userId, messageId) {
        const message = await this.prisma.message.findUnique({
            where: { id: messageId },
        });
        if (!message) {
            throw new common_1.NotFoundException('Message not found');
        }
        if (message.senderId !== userId) {
            throw new common_1.ForbiddenException('You can only delete your own messages');
        }
        await this.prisma.message.update({
            where: { id: messageId },
            data: { isDeleted: true },
        });
        return { success: true };
    }
    // Read Receipts
    async markMessageAsRead(userId, messageId) {
        const message = await this.prisma.message.findUnique({
            where: { id: messageId },
        });
        if (!message) {
            throw new common_1.NotFoundException('Message not found');
        }
        // Don't create read receipt for own messages
        if (message.senderId === userId) {
            return;
        }
        // Verify user is participant in conversation
        await this.verifyParticipant(userId, message.conversationId);
        await this.prisma.messageReadReceipt.upsert({
            where: {
                messageId_userId: {
                    messageId,
                    userId,
                },
            },
            create: {
                messageId,
                userId,
            },
            update: {
                readAt: new Date(),
            },
        });
        // Update participant's lastReadAt
        await this.prisma.conversationParticipant.updateMany({
            where: {
                conversationId: message.conversationId,
                userId,
            },
            data: {
                lastReadAt: new Date(),
            },
        });
        // Publish message read event
        await this.eventBus.emit(new messaging_events_1.MessageReadEvent({
            messageId,
            readBy: userId,
            readAt: new Date(),
            conversationId: message.conversationId,
            messagesSinceLastRead: 1, // Could be enhanced to calculate actual count
        }));
    }
    // Message Reactions
    async addMessageReaction(userId, messageId, emoji) {
        const message = await this.prisma.message.findUnique({
            where: { id: messageId },
        });
        if (!message) {
            throw new common_1.NotFoundException('Message not found');
        }
        // Verify user is participant in conversation
        await this.verifyParticipant(userId, message.conversationId);
        const reaction = await this.prisma.messageReaction.upsert({
            where: {
                messageId_userId_emoji: {
                    messageId,
                    userId,
                    emoji,
                },
            },
            create: {
                messageId,
                userId,
                emoji,
            },
            update: {
                emoji,
            },
            include: {
                user: {
                    select: {
                        id: true,
                        firstName: true,
                        lastName: true,
                    },
                },
            },
        });
        return reaction;
    }
    async removeMessageReaction(userId, messageId, emoji) {
        await this.prisma.messageReaction.deleteMany({
            where: {
                messageId,
                userId,
                emoji,
            },
        });
        return { success: true };
    }
    // User Blocking
    async blockUser(blockerId, blockedId, reason) {
        if (blockerId === blockedId) {
            throw new common_1.BadRequestException('Cannot block yourself');
        }
        await this.prisma.userBlock.upsert({
            where: {
                blockerId_blockedId: {
                    blockerId,
                    blockedId,
                },
            },
            create: {
                blockerId,
                blockedId,
                reason,
            },
            update: {
                reason,
            },
        });
        return { success: true };
    }
    async unblockUser(blockerId, blockedId) {
        await this.prisma.userBlock.deleteMany({
            where: {
                blockerId,
                blockedId,
            },
        });
        return { success: true };
    }
    // Helper Methods
    async findDirectConversation(user1Id, user2Id) {
        return this.prisma.conversation.findFirst({
            where: {
                type: client_1.ConversationType.DIRECT,
                participants: {
                    every: {
                        userId: { in: [user1Id, user2Id] },
                    },
                },
            },
            include: {
                participants: {
                    include: {
                        user: {
                            select: {
                                id: true,
                                firstName: true,
                                lastName: true,
                                avatarUrl: true,
                                role: true,
                            },
                        },
                    },
                },
            },
        });
    }
    async verifyParticipant(userId, conversationId) {
        const participant = await this.prisma.conversationParticipant.findUnique({
            where: {
                conversationId_userId: {
                    conversationId,
                    userId,
                },
            },
        });
        if (!participant || !participant.isActive) {
            throw new common_1.ForbiddenException('You are not a participant in this conversation');
        }
        return participant;
    }
    // Search Messages
    async searchMessages(userId, query, conversationId, page = 1, limit = 20) {
        const skip = (page - 1) * limit;
        const whereClause = {
            content: {
                contains: query,
                mode: 'insensitive',
            },
            isDeleted: false,
            conversation: {
                participants: {
                    some: {
                        userId,
                        isActive: true,
                    },
                },
            },
        };
        if (conversationId) {
            whereClause.conversationId = conversationId;
        }
        const messages = await this.prisma.message.findMany({
            where: whereClause,
            include: {
                sender: {
                    select: {
                        id: true,
                        firstName: true,
                        lastName: true,
                        avatarUrl: true,
                    },
                },
                conversation: {
                    select: {
                        id: true,
                        type: true,
                        title: true,
                    },
                },
            },
            orderBy: { createdAt: 'desc' },
            skip,
            take: limit,
        });
        return messages;
    }
};
exports.MessagingService = MessagingService;
exports.MessagingService = MessagingService = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [typeof (_a = typeof prisma_client_provider_1.PrismaService !== "undefined" && prisma_client_provider_1.PrismaService) === "function" ? _a : Object, typeof (_b = typeof event_bus_service_1.EventBusService !== "undefined" && event_bus_service_1.EventBusService) === "function" ? _b : Object])
], MessagingService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL21lc3NhZ2luZy9tZXNzYWdpbmcuc2VydmljZS50cyIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7O0FBQUEsMkNBS3dCO0FBQ3hCLGdGQUFvRTtBQU1wRSwyQ0FBZ0Y7QUFDaEYsMEVBQXFFO0FBQ3JFLHdFQUkyQztBQUdwQyxJQUFNLGdCQUFnQixHQUF0QixNQUFNLGdCQUFnQjtJQUVSO0lBQ0E7SUFGbkIsWUFDbUIsTUFBcUIsRUFDckIsUUFBeUI7UUFEekIsV0FBTSxHQUFOLE1BQU0sQ0FBZTtRQUNyQixhQUFRLEdBQVIsUUFBUSxDQUFpQjtJQUN6QyxDQUFDO0lBRUosMEJBQTBCO0lBQzFCLEtBQUssQ0FBQyxrQkFBa0IsQ0FDdEIsTUFBYyxFQUNkLHFCQUE0QztRQUU1QyxNQUFNLEVBQ0osY0FBYyxFQUNkLElBQUksR0FBRyx5QkFBZ0IsQ0FBQyxNQUFNLEVBQzlCLEtBQUssR0FDTixHQUFHLHFCQUFxQixDQUFDO1FBRTFCLDhDQUE4QztRQUM5QyxJQUFJLElBQUksS0FBSyx5QkFBZ0IsQ0FBQyxNQUFNLElBQUksY0FBYyxDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUUsQ0FBQztZQUNwRSxNQUFNLElBQUksNEJBQW1CLENBQzNCLDhEQUE4RCxDQUMvRCxDQUFDO1FBQ0osQ0FBQztRQUVELDhDQUE4QztRQUM5QyxJQUFJLElBQUksS0FBSyx5QkFBZ0IsQ0FBQyxNQUFNLEVBQUUsQ0FBQztZQUNyQyxNQUFNLG9CQUFvQixHQUFHLE1BQU0sSUFBSSxDQUFDLHNCQUFzQixDQUM1RCxNQUFNLEVBQ04sY0FBYyxDQUFDLENBQUMsQ0FBQyxDQUNsQixDQUFDO1lBQ0YsSUFBSSxvQkFBb0IsRUFBRSxDQUFDO2dCQUN6QixPQUFPLG9CQUFvQixDQUFDO1lBQzlCLENBQUM7UUFDSCxDQUFDO1FBRUQsd0NBQXdDO1FBQ3hDLE1BQU0sWUFBWSxHQUFHLE1BQU0sSUFBSSxDQUFDLE1BQU0s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L2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL21lc3NhZ2luZy9tZXNzYWdpbmcuc2VydmljZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBJbmplY3RhYmxlLFxuICBOb3RGb3VuZEV4Y2VwdGlvbixcbiAgRm9yYmlkZGVuRXhjZXB0aW9uLFxuICBCYWRSZXF1ZXN0RXhjZXB0aW9uLFxufSBmcm9tICdAbmVzdGpzL2NvbW1vbic7XG5pbXBvcnQgeyBQcmlzbWFTZXJ2aWNlIH0gZnJvbSAnLi4vcHJvdmlkZXJzL3ByaXNtYS1jbGllbnQucHJvdmlkZXInO1xuaW1wb3J0IHtcbiAgQ3JlYXRlQ29udmVyc2F0aW9uRHRvLFxuICBTZW5kTWVzc2FnZUR0byxcbiAgVXBkYXRlTWVzc2FnZUR0byxcbn0gZnJvbSAnbWVudGFyYS1jb21tb25zJztcbmltcG9ydCB7IENvbnZlcnNhdGlvblR5cGUsIE1lc3NhZ2VUeXBlLCBQYXJ0aWNpcGFudFJvbGUgfSBmcm9tICdAcHJpc21hL2NsaWVudCc7XG5pbXBvcnQgeyBFdmVudEJ1c1NlcnZpY2UgfSBmcm9tICcuLi9jb21tb24vZXZlbnRzL2V2ZW50LWJ1cy5zZXJ2aWNlJztcbmltcG9ydCB7XG4gIE1lc3NhZ2VTZW50RXZlbnQsXG4gIE1lc3NhZ2VSZWFkRXZlbnQsXG4gIENvbnZlcnNhdGlvbkNyZWF0ZWRFdmVudCxcbn0gZnJvbSAnLi4vY29tbW9uL2V2ZW50cy9tZXNzYWdpbmctZXZlbnRzJztcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIE1lc3NhZ2luZ1NlcnZpY2Uge1xuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHJlYWRvbmx5IHByaXNtYTogUHJpc21hU2VydmljZSxcbiAgICBwcml2YXRlIHJlYWRvbmx5IGV2ZW50QnVzOiBFdmVudEJ1c1NlcnZpY2UsXG4gICkge31cblxuICAvLyBDb252ZXJzYXRpb24gTWFuYWdlbWVudFxuICBhc3luYyBjcmVhdGVDb252ZXJzYXRpb24oXG4gICAgdXNlcklkOiBzdHJpbmcsXG4gICAgY3JlYXRlQ29udmVyc2F0aW9uRHRvOiBDcmVhdGVDb252ZXJzYXRpb25EdG8sXG4gICkge1xuICAgIGNvbnN0IHtcbiAgICAgIHBhcnRpY2lwYW50SWRzLFxuICAgICAgdHlwZSA9IENvbnZlcnNhdGlvblR5cGUuRElSRUNULFxuICAgICAgdGl0bGUsXG4gICAgfSA9IGNyZWF0ZUNvbnZlcnNhdGlvbkR0bztcblxuICAgIC8vIFZhbGlkYXRlIGNvbnZlcnNhdGlvbiB0eXBlIGFuZCBwYXJ0aWNpcGFudHNcbiAgICBpZiAodHlwZSA9PT0gQ29udmVyc2F0aW9uVHlwZS5ESVJFQ1QgJiYgcGFydGljaXBhbnRJZHMubGVuZ3RoICE9PSAxKSB7XG4gICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdEV4Y2VwdGlvbihcbiAgICAgICAgJ0RpcmVjdCBjb252ZXJzYXRpb25zIG11c3QgaGF2ZSBleGFjdGx5IG9uZSBvdGhlciBwYXJ0aWNpcGFudCcsXG4gICAgICApO1xuICAgIH1cblxuICAgIC8vIENoZWNrIGlmIGRpcmVjdCBjb252ZXJzYXRpb24gYWxyZWFkeSBleGlzdHNcbiAgICBpZiAodHlwZSA9PT0gQ29udmVyc2F0aW9uVHlwZS5ESVJFQ1QpIHtcbiAgICAgIGNvbnN0IGV4aXN0aW5nQ29udmVyc2F0aW9uID0gYXdhaXQgdGhpcy5maW5kRGlyZWN0Q29udmVyc2F0aW9uKFxuICAgICAgICB1c2VySWQsXG4gICAgICAgIHBhcnRpY2lwYW50SWRzWzBdLFxuICAgICAgKTtcbiAgICAgIGlmIChleGlzdGluZ0NvbnZlcnNhdGlvbikge1xuICAgICAgICByZXR1cm4gZXhpc3RpbmdDb252ZXJzYXRpb247XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gQ3JlYXRlIGNvbnZlcnNhdGlvbiB3aXRoIHBhcnRpY2lwYW50c1xuICAgIGNvbnN0IGNvbnZlcnNhdGlvbiA9IGF3YWl0IHRoaXMucHJpc21hLmNvbnZlcnNhdGlvbi5jcmVhdGUoe1xuICAgICAgZGF0YToge1xuICAgICAgICB0eXBlLFxuICAgICAgICB0aXRsZSxcbiAgICAgICAgcGFydGljaXBhbnRzOiB7XG4gICAgICAgICAgY3JlYXRlOiBbXG4gICAgICAgICAgICB7IHVzZXJJZCwgcm9sZTogUGFydGljaXBhbnRSb2xlLkFETUlOIH0sXG4gICAgICAgICAgICAuLi5wYXJ0aWNpcGFudElkcy5tYXAoKHBhcnRpY2lwYW50SWQpID0+ICh7XG4gICAgICAgICAgICAgIHVzZXJJZDogcGFydGljaXBhbnRJZCxcbiAgICAgICAgICAgICAgcm9sZTogUGFydGljaXBhbnRSb2xlLk1FTUJFUixcbiAgICAgICAgICAgIH0pKSxcbiAgICAgICAgICBdLFxuICAgICAgICB9LFxuICAgICAgfSxcbiAgICAgIGluY2x1ZGU6IHtcbiAgICAgICAgcGFydGljaXBhbnRzOiB7XG4gICAgICAgICAgaW5jbHVkZToge1xuICAgICAgICAgICAgdXNlcjoge1xuICAgICAgICAgICAgICBzZWxlY3Q6IHtcbiAgICAgICAgICAgICAgICBpZDogdHJ1ZSxcbiAgICAgICAgICAgICAgICBmaXJzdE5hbWU6IHRydWUsXG4gICAgICAgICAgICAgICAgbGFzdE5hbWU6IHRydWUsXG4gICAgICAgICAgICAgICAgYXZhdGFyVXJsOiB0cnVlLFxuICAgICAgICAgICAgICAgIHJvbGU6IHRydWUsXG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICAgIG1lc3NhZ2VzOiB7XG4gICAgICAgICAgdGFrZTogMSxcbiAgICAgICAgICBvcmRlckJ5OiB7IGNyZWF0ZWRBdDogJ2Rlc2MnIH0sXG4gICAgICAgICAgaW5jbHVkZToge1xuICAgICAgICAgICAgc2VuZGVyOiB7XG4gICAgICAgICAgICAgIHNlbGVjdDoge1xuICAgICAgICAgICAgICAgIGlkOiB0cnVlLFxuICAgICAgICAgICAgICAgIGZpcnN0TmFtZTogdHJ1ZSxcbiAgICAgICAgICAgICAgICBsYXN0TmFtZTogdHJ1ZSxcbiAgICAgICAgICAgICAgICBhdmF0YXJVcmw6IHRydWUsXG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgLy8gUHVibGlzaCBjb252ZXJzYXRpb24gY3JlYXRlZCBldmVudFxuICAgIGF3YWl0IHRoaXMuZXZlbnRCdXMuZW1pdChcbiAgICAgIG5ldyBDb252ZXJzYXRpb25DcmVhdGVkRXZlbnQoe1xuICAgICAgICBjb252ZXJzYXRpb25JZDogY29udmVyc2F0aW9uLmlkLFxuICAgICAgICBjcmVhdGVkQnk6IHVzZXJJZCxcbiAgICAgICAgcGFydGljaXBhbnRJZHM6IFt1c2VySWQsIC4uLnBhcnRpY2lwYW50SWRzXSxcbiAgICAgICAgY29udmVyc2F0aW9uVHlwZTogdHlwZS50b0xvd2VyQ2FzZSgpIGFzXG4gICAgICAgICAgfCAnZGlyZWN0J1xuICAgICAgICAgIHwgJ2dyb3VwJ1xuICAgICAgICAgIHwgJ3N1cHBvcnQnXG4gICAgICAgICAgfCAndGhlcmFweScsXG4gICAgICAgIHRpdGxlOiB0aXRsZSB8fCB1bmRlZmluZWQsXG4gICAgICAgIGlzUHJpdmF0ZTogdHlwZSA9PT0gQ29udmVyc2F0aW9uVHlwZS5ESVJFQ1QsXG4gICAgICB9KSxcbiAgICApO1xuXG4gICAgcmV0dXJuIGNvbnZlcnNhdGlvbjtcbiAgfVxuXG4gIGFzeW5jIGdldFVzZXJDb252ZXJzYXRpb25zKHVzZXJJZDogc3RyaW5nLCBwYWdlID0gMSwgbGltaXQgPSAyMCkge1xuICAgIGNvbnN0IHNraXAgPSAocGFnZSAtIDEpICogbGltaXQ7XG5cbiAgICBjb25zdCBjb252ZXJzYXRpb25zID0gYXdhaXQgdGhpcy5wcmlzbWEuY29udmVyc2F0aW9uLmZpbmRNYW55KHtcbiAgICAgIHdoZXJlOiB7XG4gICAgICAgIHBhcnRpY2lwYW50czoge1xuICAgICAgICAgIHNvbWU6IHtcbiAgICAgICAgICAgIHVzZXJJZCxcbiAgICAgICAgICAgIGlzQWN0aXZlOiB0cnVlLFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICAgIGlzQWN0aXZlOiB0cnVlLFxuICAgICAgfSxcbiAgICAgIGluY2x1ZGU6IHtcbiAgICAgICAgcGFydGljaXBhbnRzOiB7XG4gICAgICAgICAgd2hlcmU6IHsgaXNBY3RpdmU6IHRydWUgfSxcbiAgICAgICAgICBpbmNsdWRlOiB7XG4gICAgICAgICAgICB1c2VyOiB7XG4gICAgICAgICAgICAgIHNlbGVjdDoge1xuICAgICAgICAgICAgICAgIGlkOiB0cnVlLFxuICAgICAgICAgICAgICAgIGZpcnN0TmFtZTogdHJ1ZSxcbiAgICAgICAgICAgICAgICBsYXN0TmFtZTogdHJ1ZSxcbiAgICAgICAgICAgICAgICBhdmF0YXJVcmw6IHRydWUsXG4gICAgICAgICAgICAgICAgcm9sZTogdHJ1ZSxcbiAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgICAgbWVzc2FnZXM6IHtcbiAgICAgICAgICB0YWtlOiAxLFxuICAgICAgICAgIG9yZGVyQnk6IHsgY3JlYXRlZEF0OiAnZGVzYycgfSxcbiAgICAgICAgICB3aGVyZTogeyBpc0RlbGV0ZWQ6IGZhbHNlIH0sXG4gICAgICAgICAgaW5jbHVkZToge1xuICAgICAgICAgICAgc2VuZGVyOiB7XG4gICAgICAgICAgICAgIHNlbGVjdDoge1xuICAgICAgICAgICAgICAgIGlkOiB0cnVlLFxuICAgICAgICAgICAgICAgIGZpcnN0TmFtZTogdHJ1ZSxcbiAgICAgICAgICAgICAgICBsYXN0TmFtZTogdHJ1ZSxcbiAgICAgICAgICAgICAgICBhdmF0YXJVcmw6IHRydWUsXG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICAgIF9jb3VudDoge1xuICAgICAgICAgIHNlbGVjdDoge1xuICAgICAgICAgICAgbWVzc2FnZXM6IHtcbiAgICAgICAgICAgICAgd2hlcmU6IHtcbiAgICAgICAgICAgICAgICBpc0RlbGV0ZWQ6IGZhbHNlLFxuICAgICAgICAgICAgICAgIHJlYWRSZWNlaXB0czoge1xuICAgICAgICAgICAgICAgICAgbm9uZTogeyB1c2VySWQgfSxcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgfSxcbiAgICAgIG9yZGVyQnk6IHsgbGFzdE1lc3NhZ2VBdDogJ2Rlc2MnIH0sXG4gICAgICBza2lwLFxuICAgICAgdGFrZTogbGltaXQsXG4gICAgfSk7XG5cbiAgICByZXR1cm4gY29udmVyc2F0aW9ucztcbiAgfVxuXG4gIC8vIE1lc3NhZ2UgTWFuYWdlbWVudFxuICBhc3luYyBzZW5kTWVzc2FnZShcbiAgICB1c2VySWQ6IHN0cmluZyxcbiAgICBjb252ZXJzYXRpb25JZDogc3RyaW5nLFxuICAgIHNlbmRNZXNzYWdlRHRvOiBTZW5kTWVzc2FnZUR0byxcbiAgICBhdHRhY2htZW50VXJsczogc3RyaW5nW10gPSBbXSxcbiAgICBhdHRhY2htZW50TmFtZXM6IHN0cmluZ1tdID0gW10sXG4gICAgYXR0YWNobWVudFNpemVzOiBudW1iZXJbXSA9IFtdLFxuICApIHtcbiAgICAvLyBWZXJpZnkgdXNlciBpcyBwYXJ0aWNpcGFudCBpbiBjb252ZXJzYXRpb25cbiAgICBhd2FpdCB0aGlzLnZlcmlmeVBhcnRpY2lwYW50KHVzZXJJZCwgY29udmVyc2F0aW9uSWQpO1xuXG4gICAgY29uc3Qge1xuICAgICAgY29udGVudCxcbiAgICAgIG1lc3NhZ2VUeXBlID0gTWVzc2FnZVR5cGUuVEVYVCxcbiAgICAgIHJlcGx5VG9JZCxcbiAgICAgIGF0dGFjaG1lbnRVcmwsXG4gICAgICBhdHRhY2htZW50TmFtZSxcbiAgICAgIGF0dGFjaG1lbnRTaXplLFxuICAgIH0gPSBzZW5kTWVzc2FnZUR0bztcblxuICAgIGNvbnN0IG1lc3NhZ2UgPSBhd2FpdCB0aGlzLnByaXNtYS5tZXNzYWdlLmNyZWF0ZSh7XG4gICAgICBkYXRhOiB7XG4gICAgICAgIGNvbnZlcnNhdGlvbklkLFxuICAgICAgICBzZW5kZXJJZDogdXNlcklkLFxuICAgICAgICBjb250ZW50LFxuICAgICAgICBtZXNzYWdlVHlwZSxcbiAgICAgICAgcmVwbHlUb0lkLFxuICAgICAgICAvLyBLZWVwIGJhY2t3YXJkIGNvbXBhdGliaWxpdHkgd2l0aCBzaW5nbGUgYXR0YWNobWVudCBmaWVsZHNcbiAgICAgICAgYXR0YWNobWVudFVybDogYXR0YWNobWVudFVybHNbMF0gfHwgYXR0YWNobWVudFVybCxcbiAgICAgICAgYXR0YWNobWVudE5hbWU6IGF0dGFjaG1lbnROYW1lc1swXSB8fCBhdHRhY2htZW50TmFtZSxcbiAgICAgICAgYXR0YWNobWVudFNpemU6IGF0dGFjaG1lbnRTaXplc1swXSB8fCBhdHRhY2htZW50U2l6ZSxcbiAgICAgICAgLy8gQWRkIG5ldyBtdWx0aXBsZSBhdHRhY2htZW50IGZpZWxkc1xuICAgICAgICBhdHRhY2htZW50VXJscyxcbiAgICAgICAgYXR0YWNobWVudE5hbWVzLFxuICAgICAgICBhdHRhY2htZW50U2l6ZXMsXG4gICAgICB9LFxuICAgICAgaW5jbHVkZToge1xuICAgICAgICBzZW5kZXI6IHtcbiAgICAgICAgICBzZWxlY3Q6IHtcbiAgICAgICAgICAgIGlkOiB0cnVlLFxuICAgICAgICAgICAgZmlyc3ROYW1lOiB0cnVlLFxuICAgICAgICAgICAgbGFzdE5hbWU6IHRydWUsXG4gICAgICAgICAgICBhdmF0YXJVcmw6IHRydWUsXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgICAgcmVwbHlUbzoge1xuICAgICAgICAgIGluY2x1ZGU6IHtcbiAgICAgICAgICAgIHNlbmRlcjoge1xuICAgICAgICAgICAgICBzZWxlY3Q6IHtcbiAgICAgICAgICAgICAgICBpZDogdHJ1ZSxcbiAgICAgICAgICAgICAgICBmaXJzdE5hbWU6IHRydWUsXG4gICAgICAgICAgICAgICAgbGFzdE5hbWU6IHRydWUsXG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICAgIHJlYWN0aW9uczoge1xuICAgICAgICAgIGluY2x1ZGU6IHtcbiAgICAgICAgICAgIHVzZXI6IHtcbiAgICAgICAgICAgICAgc2VsZWN0OiB7XG4gICAgICAgICAgICAgICAgaWQ6IHRydWUsXG4gICAgICAgICAgICAgICAgZmlyc3ROYW1lOiB0cnVlLFxuICAgICAgICAgICAgICAgIGxhc3ROYW1lOiB0cnVlLFxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgfSxcbiAgICB9KTtcblxuICAgIC8vIFVwZGF0ZSBjb252ZXJzYXRpb24gbGFzdE1lc3NhZ2VBdFxuICAgIGF3YWl0IHRoaXMucHJpc21hLmNvbnZlcnNhdGlvbi51cGRhdGUoe1xuICAgICAgd2hlcmU6IHsgaWQ6IGNvbnZlcnNhdGlvbklkIH0sXG4gICAgICBkYXRhOiB7IGxhc3RNZXNzYWdlQXQ6IG5ldyBEYXRlKCkgfSxcbiAgICB9KTtcblxuICAgIC8vIEdldCBjb252ZXJzYXRpb24gcGFydGljaXBhbnRzIGZvciBldmVudFxuICAgIGNvbnN0IGNvbnZlcnNhdGlvbiA9IGF3YWl0IHRoaXMucHJpc21hLmNvbnZlcnNhdGlvbi5maW5kVW5pcXVlKHtcbiAgICAgIHdoZXJlOiB7IGlkOiBjb252ZXJzYXRpb25JZCB9LFxuICAgICAgaW5jbHVkZToge1xuICAgICAgICBwYXJ0aWNpcGFudHM6IHtcbiAgICAgICAgICB3aGVyZTogeyBpc0FjdGl2ZTogdHJ1ZSB9LFxuICAgICAgICAgIHNlbGVjdDogeyB1c2VySWQ6IHRydWUgfSxcbiAgICAgICAgfSxcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICBjb25zdCByZWNpcGllbnRJZHMgPVxuICAgICAgY29udmVyc2F0aW9uPy5wYXJ0aWNpcGFudHNcbiAgICAgICAgLm1hcCgocCkgPT4gcC51c2VySWQpXG4gICAgICAgIC5maWx0ZXIoKGlkKSA9PiBpZCAhPT0gdXNlcklkKSB8fCBbXTtcblxuICAgIC8vIFB1Ymxpc2ggbWVzc2FnZSBzZW50IGV2ZW50XG4gICAgYXdhaXQgdGhpcy5ldmVudEJ1cy5lbWl0KFxuICAgICAgbmV3IE1lc3NhZ2VTZW50RXZlbnQoe1xuICAgICAgICBtZXNzYWdlSWQ6IG1lc3NhZ2UuaWQsXG4gICAgICAgIGNvbnZlcnNhdGlvbklkLFxuICAgICAgICBzZW5kZXJJZDogdXNlcklkLFxuICAgICAgICBjb250ZW50OiBtZXNzYWdlLmNvbnRlbnQsXG4gICAgICAgIG1lc3NhZ2VUeXBlOiBtZXNzYWdlLm1lc3NhZ2VUeXBlLnRvTG93ZXJDYXNlKCkgYXNcbiAgICAgICAgICB8ICd0ZXh0J1xuICAgICAgICAgIHwgJ2ltYWdlJ1xuICAgICAgICAgIHwgJ2ZpbGUnXG4gICAgICAgICAgfCAnYXVkaW8nXG4gICAgICAgICAgfCAndmlkZW8nXG4gICAgICAgICAgfCAnc3lzdGVtJyxcbiAgICAgICAgc2VudEF0OiBtZXNzYWdlLmNyZWF0ZWRBdCxcbiAgICAgICAgcmVjaXBpZW50SWRzLFxuICAgICAgICByZXBseVRvTWVzc2FnZUlkOiBtZXNzYWdlLnJlcGx5VG9JZCB8fCB1bmRlZmluZWQsXG4gICAgICAgIGZpbGVBdHRhY2htZW50czpcbiAgICAgICAgICBhdHRhY2htZW50VXJscy5sZW5ndGggPiAwXG4gICAgICAgICAgICA/IGF0dGFjaG1lbnRVcmxzXG4gICAgICAgICAgICA6IG1lc3NhZ2UuYXR0YWNobWVudFVybFxuICAgICAgICAgICAgICA/IFttZXNzYWdlLmF0dGFjaG1lbnRVcmxdXG4gICAgICAgICAgICAgIDogdW5kZWZpbmVkLFxuICAgICAgfSksXG4gICAgKTtcblxuICAgIHJldHVybiBtZXNzYWdlO1xuICB9XG5cbiAgYXN5bmMgZ2V0Q29udmVyc2F0aW9uTWVzc2FnZXMoXG4gICAgdXNlcklkOiBzdHJpbmcsXG4gICAgY29udmVyc2F0aW9uSWQ6IHN0cmluZyxcbiAgICBwYWdlID0gMSxcbiAgICBsaW1pdCA9IDUwLFxuICApIHtcbiAgICAvLyBWZXJpZnkgdXNlciBpcyBwYXJ0aWNpcGFudCBpbiBjb252ZXJzYXRpb25cbiAgICBhd2FpdCB0aGlzLnZlcmlmeVBhcnRpY2lwYW50KHVzZXJJZCwgY29udmVyc2F0aW9uSWQpO1xuXG4gICAgY29uc3Qgc2tpcCA9IChwYWdlIC0gMSkgKiBsaW1pdDtcblxuICAgIGNvbnN0IG1lc3NhZ2VzID0gYXdhaXQgdGhpcy5wcmlzbWEubWVzc2FnZS5maW5kTWFueSh7XG4gICAgICB3aGVyZToge1xuICAgICAgICBjb252ZXJzYXRpb25JZCxcbiAgICAgICAgaXNEZWxldGVkOiBmYWxzZSxcbiAgICAgIH0sXG4gICAgICBpbmNsdWRlOiB7XG4gICAgICAgIHNlbmRlcjoge1xuICAgICAgICAgIHNlbGVjdDoge1xuICAgICAgICAgICAgaWQ6IHRydWUsXG4gICAgICAgICAgICBmaXJzdE5hbWU6IHRydWUsXG4gICAgICAgICAgICBsYXN0TmFtZTogdHJ1ZSxcbiAgICAgICAgICAgIGF2YXRhclVybDogdHJ1ZSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgICByZXBseVRvOiB7XG4gICAgICAgICAgaW5jbHVkZToge1xuICAgICAgICAgICAgc2VuZGVyOiB7XG4gICAgICAgICAgICAgIHNlbGVjdDoge1xuICAgICAgICAgICAgICAgIGlkOiB0cnVlLFxuICAgICAgICAgICAgICAgIGZpcnN0TmFtZTogdHJ1ZSxcbiAgICAgICAgICAgICAgICBsYXN0TmFtZTogdHJ1ZSxcbiAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgICAgcmVhY3Rpb25zOiB7XG4gICAgICAgICAgaW5jbHVkZToge1xuICAgICAgICAgICAgdXNlcjoge1xuICAgICAgICAgICAgICBzZWxlY3Q6IHtcbiAgICAgICAgICAgICAgICBpZDogdHJ1ZSxcbiAgICAgICAgICAgICAgICBmaXJzdE5hbWU6IHRydWUsXG4gICAgICAgICAgICAgICAgbGFzdE5hbWU6IHRydWUsXG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICAgIHJlYWRSZWNlaXB0czoge1xuICAgICAgICAgIGluY2x1ZGU6IHtcbiAgICAgICAgICAgIHVzZXI6IHtcbiAgICAgICAgICAgICAgc2VsZWN0OiB7XG4gICAgICAgICAgICAgICAgaWQ6IHRydWUsXG4gICAgICAgICAgICAgICAgZmlyc3ROYW1lOiB0cnVlLFxuICAgICAgICAgICAgICAgIGxhc3ROYW1lOiB0cnVlLFxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgfSxcbiAgICAgIG9yZGVyQnk6IHsgY3JlYXRlZEF0OiAnZGVzYycgfSxcbiAgICAgIHNraXAsXG4gICAgICB0YWtlOiBsaW1pdCxcbiAgICB9KTtcblxuICAgIHJldHVybiBtZXNzYWdlcy5yZXZlcnNlKCk7IC8vIFJldHVybiBpbiBjaHJvbm9sb2dpY2FsIG9yZGVyXG4gIH1cblxuICBhc3luYyB1cGRhdGVNZXNzYWdlKFxuICAgIHVzZXJJZDogc3RyaW5nLFxuICAgIG1lc3NhZ2VJZDogc3RyaW5nLFxuICAgIHVwZGF0ZU1lc3NhZ2VEdG86IFVwZGF0ZU1lc3NhZ2VEdG8sXG4gICkge1xuICAgIGNvbnN0IG1lc3NhZ2UgPSBhd2FpdCB0aGlzLnByaXNtYS5tZXNzYWdlLmZpbmRVbmlxdWUoe1xuICAgICAgd2hlcmU6IHsgaWQ6IG1lc3NhZ2VJZCB9LFxuICAgIH0pO1xuXG4gICAgaWYgKCFtZXNzYWdlKSB7XG4gICAgICB0aHJvdyBuZXcgTm90Rm91bmRFeGNlcHRpb24oJ01lc3NhZ2Ugbm90IGZvdW5kJyk7XG4gICAgfVxuXG4gICAgaWYgKG1lc3NhZ2Uuc2VuZGVySWQgIT09IHVzZXJJZCkge1xuICAgICAgdGhyb3cgbmV3IEZvcmJpZGRlbkV4Y2VwdGlvbignWW91IGNhbiBvbmx5IGVkaXQgeW91ciBvd24gbWVzc2FnZXMnKTtcbiAgICB9XG5cbiAgICBpZiAobWVzc2FnZS5pc0RlbGV0ZWQpIHtcbiAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0RXhjZXB0aW9uKCdDYW5ub3QgZWRpdCBkZWxldGVkIG1lc3NhZ2UnKTtcbiAgICB9XG5cbiAgICBjb25zdCB1cGRhdGVkTWVzc2FnZSA9IGF3YWl0IHRoaXMucHJpc21hLm1lc3NhZ2UudXBkYXRlKHtcbiAgICAgIHdoZXJlOiB7IGlkOiBtZXNzYWdlSWQgfSxcbiAgICAgIGRhdGE6IHtcbiAgICAgICAgY29udGVudDogdXBkYXRlTWVzc2FnZUR0by5jb250ZW50LFxuICAgICAgICBpc0VkaXRlZDogdHJ1ZSxcbiAgICAgICAgZWRpdGVkQXQ6IG5ldyBEYXRlKCksXG4gICAgICB9LFxuICAgICAgaW5jbHVkZToge1xuICAgICAgICBzZW5kZXI6IHtcbiAgICAgICAgICBzZWxlY3Q6IHtcbiAgICAgICAgICAgIGlkOiB0cnVlLFxuICAgICAgICAgICAgZmlyc3ROYW1lOiB0cnVlLFxuICAgICAgICAgICAgbGFzdE5hbWU6IHRydWUsXG4gICAgICAgICAgICBhdmF0YXJVcmw6IHRydWUsXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgICAgcmVhY3Rpb25zOiB7XG4gICAgICAgICAgaW5jbHVkZToge1xuICAgICAgICAgICAgdXNlcjoge1xuICAgICAgICAgICAgICBzZWxlY3Q6IHtcbiAgICAgICAgICAgICAgICBpZDogdHJ1ZSxcbiAgICAgICAgICAgICAgICBmaXJzdE5hbWU6IHRydWUsXG4gICAgICAgICAgICAgICAgbGFzdE5hbWU6IHRydWUsXG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgcmV0dXJuIHVwZGF0ZWRNZXNzYWdlO1xuICB9XG5cbiAgYXN5bmMgZGVsZXRlTWVzc2FnZSh1c2VySWQ6IHN0cmluZywgbWVzc2FnZUlkOiBzdHJpbmcpIHtcbiAgICBjb25zdCBtZXNzYWdlID0gYXdhaXQgdGhpcy5wcmlzbWEubWVzc2FnZS5maW5kVW5pcXVlKHtcbiAgICAgIHdoZXJlOiB7IGlkOiBtZXNzYWdlSWQgfSxcbiAgICB9KTtcblxuICAgIGlmICghbWVzc2FnZSkge1xuICAgICAgdGhyb3cgbmV3IE5vdEZvdW5kRXhjZXB0aW9uKCdNZXNzYWdlIG5vdCBmb3VuZCcpO1xuICAgIH1cblxuICAgIGlmIChtZXNzYWdlLnNlbmRlcklkICE9PSB1c2VySWQpIHtcbiAgICAgIHRocm93IG5ldyBGb3JiaWRkZW5FeGNlcHRpb24oJ1lvdSBjYW4gb25seSBkZWxldGUgeW91ciBvd24gbWVzc2FnZXMnKTtcbiAgICB9XG5cbiAgICBhd2FpdCB0aGlzLnByaXNtYS5tZXNzYWdlLnVwZGF0ZSh7XG4gICAgICB3aGVyZTogeyBpZDogbWVzc2FnZUlkIH0sXG4gICAgICBkYXRhOiB7IGlzRGVsZXRlZDogdHJ1ZSB9LFxuICAgIH0pO1xuXG4gICAgcmV0dXJuIHsgc3VjY2VzczogdHJ1ZSB9O1xuICB9XG5cbiAgLy8gUmVhZCBSZWNlaXB0c1xuICBhc3luYyBtYXJrTWVzc2FnZUFzUmVhZCh1c2VySWQ6IHN0cmluZywgbWVzc2FnZUlkOiBzdHJpbmcpIHtcbiAgICBjb25zdCBtZXNzYWdlID0gYXdhaXQgdGhpcy5wcmlzbWEubWVzc2FnZS5maW5kVW5pcXVlKHtcbiAgICAgIHdoZXJlOiB7IGlkOiBtZXNzYWdlSWQgfSxcbiAgICB9KTtcblxuICAgIGlmICghbWVzc2FnZSkge1xuICAgICAgdGhyb3cgbmV3IE5vdEZvdW5kRXhjZXB0aW9uKCdNZXNzYWdlIG5vdCBmb3VuZCcpO1xuICAgIH1cblxuICAgIC8vIERvbid0IGNyZWF0ZSByZWFkIHJlY2VpcHQgZm9yIG93biBtZXNzYWdlc1xuICAgIGlmIChtZXNzYWdlLnNlbmRlcklkID09PSB1c2VySWQpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICAvLyBWZXJpZnkgdXNlciBpcyBwYXJ0aWNpcGFudCBpbiBjb252ZXJzYXRpb25cbiAgICBhd2FpdCB0aGlzLnZlcmlmeVBhcnRpY2lwYW50KHVzZXJJZCwgbWVzc2FnZS5jb252ZXJzYXRpb25JZCk7XG5cbiAgICBhd2FpdCB0aGlzLnByaXNtYS5tZXNzYWdlUmVhZFJlY2VpcHQudXBzZXJ0KHtcbiAgICAgIHdoZXJlOiB7XG4gICAgICAgIG1lc3NhZ2VJZF91c2VySWQ6IHtcbiAgICAgICAgICBtZXNzYWdlSWQsXG4gICAgICAgICAgdXNlcklkLFxuICAgICAgICB9LFxuICAgICAgfSxcbiAgICAgIGNyZWF0ZToge1xuICAgICAgICBtZXNzYWdlSWQsXG4gICAgICAgIHVzZXJJZCxcbiAgICAgIH0sXG4gICAgICB1cGRhdGU6IHtcbiAgICAgICAgcmVhZEF0OiBuZXcgRGF0ZSgpLFxuICAgICAgfSxcbiAgICB9KTtcblxuICAgIC8vIFVwZGF0ZSBwYXJ0aWNpcGFudCdzIGxhc3RSZWFkQXRcbiAgICBhd2FpdCB0aGlzLnByaXNtYS5jb252ZXJzYXRpb25QYXJ0aWNpcGFudC51cGRhdGVNYW55KHtcbiAgICAgIHdoZXJlOiB7XG4gICAgICAgIGNvbnZlcnNhdGlvbklkOiBtZXNzYWdlLmNvbnZlcnNhdGlvbklkLFxuICAgICAgICB1c2VySWQsXG4gICAgICB9LFxuICAgICAgZGF0YToge1xuICAgICAgICBsYXN0UmVhZEF0OiBuZXcgRGF0ZSgpLFxuICAgICAgfSxcbiAgICB9KTtcblxuICAgIC8vIFB1Ymxpc2ggbWVzc2FnZSByZWFkIGV2ZW50XG4gICAgYXdhaXQgdGhpcy5ldmVudEJ1cy5lbWl0KFxuICAgICAgbmV3IE1lc3NhZ2VSZWFkRXZlbnQoe1xuICAgICAgICBtZXNzYWdlSWQsXG4gICAgICAgIHJlYWRCeTogdXNlcklkLFxuICAgICAgICByZWFkQXQ6IG5ldyBEYXRlKCksXG4gICAgICAgIGNvbnZlcnNhdGlvbklkOiBtZXNzYWdlLmNvbnZlcnNhdGlvbklkLFxuICAgICAgICBtZXNzYWdlc1NpbmNlTGFzdFJlYWQ6IDEsIC8vIENvdWxkIGJlIGVuaGFuY2VkIHRvIGNhbGN1bGF0ZSBhY3R1YWwgY291bnRcbiAgICAgIH0pLFxuICAgICk7XG4gIH1cblxuICAvLyBNZXNzYWdlIFJlYWN0aW9uc1xuICBhc3luYyBhZGRNZXNzYWdlUmVhY3Rpb24odXNlcklkOiBzdHJpbmcsIG1lc3NhZ2VJZDogc3RyaW5nLCBlbW9qaTogc3RyaW5nKSB7XG4gICAgY29uc3QgbWVzc2FnZSA9IGF3YWl0IHRoaXMucHJpc21hLm1lc3NhZ2UuZmluZFVuaXF1ZSh7XG4gICAgICB3aGVyZTogeyBpZDogbWVzc2FnZUlkIH0sXG4gICAgfSk7XG5cbiAgICBpZiAoIW1lc3NhZ2UpIHtcbiAgICAgIHRocm93IG5ldyBOb3RGb3VuZEV4Y2VwdGlvbignTWVzc2FnZSBub3QgZm91bmQnKTtcbiAgICB9XG5cbiAgICAvLyBWZXJpZnkgdXNlciBpcyBwYXJ0aWNpcGFudCBpbiBjb252ZXJzYXRpb25cbiAgICBhd2FpdCB0aGlzLnZlcmlmeVBhcnRpY2lwYW50KHVzZXJJZCwgbWVzc2FnZS5jb252ZXJzYXRpb25JZCk7XG5cbiAgICBjb25zdCByZWFjdGlvbiA9IGF3YWl0IHRoaXMucHJpc21hLm1lc3NhZ2VSZWFjdGlvbi51cHNlcnQoe1xuICAgICAgd2hlcmU6IHtcbiAgICAgICAgbWVzc2FnZUlkX3VzZXJJZF9lbW9qaToge1xuICAgICAgICAgIG1lc3NhZ2VJZCxcbiAgICAgICAgICB1c2VySWQsXG4gICAgICAgICAgZW1vamksXG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgICAgY3JlYXRlOiB7XG4gICAgICAgIG1lc3NhZ2VJZCxcbiAgICAgICAgdXNlcklkLFxuICAgICAgICBlbW9qaSxcbiAgICAgIH0sXG4gICAgICB1cGRhdGU6IHtcbiAgICAgICAgZW1vamksXG4gICAgICB9LFxuICAgICAgaW5jbHVkZToge1xuICAgICAgICB1c2VyOiB7XG4gICAgICAgICAgc2VsZWN0OiB7XG4gICAgICAgICAgICBpZDogdHJ1ZSxcbiAgICAgICAgICAgIGZpcnN0TmFtZTogdHJ1ZSxcbiAgICAgICAgICAgIGxhc3ROYW1lOiB0cnVlLFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgcmV0dXJuIHJlYWN0aW9uO1xuICB9XG5cbiAgYXN5bmMgcmVtb3ZlTWVzc2FnZVJlYWN0aW9uKFxuICAgIHVzZXJJZDogc3RyaW5nLFxuICAgIG1lc3NhZ2VJZDogc3RyaW5nLFxuICAgIGVtb2ppOiBzdHJpbmcsXG4gICkge1xuICAgIGF3YWl0IHRoaXMucHJpc21hLm1lc3NhZ2VSZWFjdGlvbi5kZWxldGVNYW55KHtcbiAgICAgIHdoZXJlOiB7XG4gICAgICAgIG1lc3NhZ2VJZCxcbiAgICAgICAgdXNlcklkLFxuICAgICAgICBlbW9qaSxcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICByZXR1cm4geyBzdWNjZXNzOiB0cnVlIH07XG4gIH1cblxuICAvLyBVc2VyIEJsb2NraW5nXG4gIGFzeW5jIGJsb2NrVXNlcihibG9ja2VySWQ6IHN0cmluZywgYmxvY2tlZElkOiBzdHJpbmcsIHJlYXNvbj86IHN0cmluZykge1xuICAgIGlmIChibG9ja2VySWQgPT09IGJsb2NrZWRJZCkge1xuICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFeGNlcHRpb24oJ0Nhbm5vdCBibG9jayB5b3Vyc2VsZicpO1xuICAgIH1cblxuICAgIGF3YWl0IHRoaXMucHJpc21hLnVzZXJCbG9jay51cHNlcnQoe1xuICAgICAgd2hlcmU6IHtcbiAgICAgICAgYmxvY2tlcklkX2Jsb2NrZWRJZDoge1xuICAgICAgICAgIGJsb2NrZXJJZCxcbiAgICAgICAgICBibG9ja2VkSWQsXG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgICAgY3JlYXRlOiB7XG4gICAgICAgIGJsb2NrZXJJZCxcbiAgICAgICAgYmxvY2tlZElkLFxuICAgICAgICByZWFzb24sXG4gICAgICB9LFxuICAgICAgdXBkYXRlOiB7XG4gICAgICAgIHJlYXNvbixcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICByZXR1cm4geyBzdWNjZXNzOiB0cnVlIH07XG4gIH1cblxuICBhc3luYyB1bmJsb2NrVXNlcihibG9ja2VySWQ6IHN0cmluZywgYmxvY2tlZElkOiBzdHJpbmcpIHtcbiAgICBhd2FpdCB0aGlzLnByaXNtYS51c2VyQmxvY2suZGVsZXRlTWFueSh7XG4gICAgICB3aGVyZToge1xuICAgICAgICBibG9ja2VySWQsXG4gICAgICAgIGJsb2NrZWRJZCxcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICByZXR1cm4geyBzdWNjZXNzOiB0cnVlIH07XG4gIH1cblxuICAvLyBIZWxwZXIgTWV0aG9kc1xuICBwcml2YXRlIGFzeW5jIGZpbmREaXJlY3RDb252ZXJzYXRpb24odXNlcjFJZDogc3RyaW5nLCB1c2VyMklkOiBzdHJpbmcpIHtcbiAgICByZXR1cm4gdGhpcy5wcmlzbWEuY29udmVyc2F0aW9uLmZpbmRGaXJzdCh7XG4gICAgICB3aGVyZToge1xuICAgICAgICB0eXBlOiBDb252ZXJzYXRpb25UeXBlLkRJUkVDVCxcbiAgICAgICAgcGFydGljaXBhbnRzOiB7XG4gICAgICAgICAgZXZlcnk6IHtcbiAgICAgICAgICAgIHVzZXJJZDogeyBpbjogW3VzZXIxSWQsIHVzZXIySWRdIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgIH0sXG4gICAgICBpbmNsdWRlOiB7XG4gICAgICAgIHBhcnRpY2lwYW50czoge1xuICAgICAgICAgIGluY2x1ZGU6IHtcbiAgICAgICAgICAgIHVzZXI6IHtcbiAgICAgICAgICAgICAgc2VsZWN0OiB7XG4gICAgICAgICAgICAgICAgaWQ6IHRydWUsXG4gICAgICAgICAgICAgICAgZmlyc3ROYW1lOiB0cnVlLFxuICAgICAgICAgICAgICAgIGxhc3ROYW1lOiB0cnVlLFxuICAgICAgICAgICAgICAgIGF2YXRhclVybDogdHJ1ZSxcbiAgICAgICAgICAgICAgICByb2xlOiB0cnVlLFxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgfSxcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgdmVyaWZ5UGFydGljaXBhbnQodXNlcklkOiBzdHJpbmcsIGNvbnZlcnNhdGlvbklkOiBzdHJpbmcpIHtcbiAgICBjb25zdCBwYXJ0aWNpcGFudCA9IGF3YWl0IHRoaXMucHJpc21hLmNvbnZlcnNhdGlvblBhcnRpY2lwYW50LmZpbmRVbmlxdWUoe1xuICAgICAgd2hlcmU6IHtcbiAgICAgICAgY29udmVyc2F0aW9uSWRfdXNlcklkOiB7XG4gICAgICAgICAgY29udmVyc2F0aW9uSWQsXG4gICAgICAgICAgdXNlcklkLFxuICAgICAgICB9LFxuICAgICAgfSxcbiAgICB9KTtcblxuICAgIGlmICghcGFydGljaXBhbnQgfHwgIXBhcnRpY2lwYW50LmlzQWN0aXZlKSB7XG4gICAgICB0aHJvdyBuZXcgRm9yYmlkZGVuRXhjZXB0aW9uKFxuICAgICAgICAnWW91IGFyZSBub3QgYSBwYXJ0aWNpcGFudCBpbiB0aGlzIGNvbnZlcnNhdGlvbicsXG4gICAgICApO1xuICAgIH1cblxuICAgIHJldHVybiBwYXJ0aWNpcGFudDtcbiAgfVxuXG4gIC8vIFNlYXJjaCBNZXNzYWdlc1xuICBhc3luYyBzZWFyY2hNZXNzYWdlcyhcbiAgICB1c2VySWQ6IHN0cmluZyxcbiAgICBxdWVyeTogc3RyaW5nLFxuICAgIGNvbnZlcnNhdGlvbklkPzogc3RyaW5nLFxuICAgIHBhZ2UgPSAxLFxuICAgIGxpbWl0ID0gMjAsXG4gICkge1xuICAgIGNvbnN0IHNraXAgPSAocGFnZSAtIDEpICogbGltaXQ7XG5cbiAgICBjb25zdCB3aGVyZUNsYXVzZTogYW55ID0ge1xuICAgICAgY29udGVudDoge1xuICAgICAgICBjb250YWluczogcXVlcnksXG4gICAgICAgIG1vZGU6ICdpbnNlbnNpdGl2ZScsXG4gICAgICB9LFxuICAgICAgaXNEZWxldGVkOiBmYWxzZSxcbiAgICAgIGNvbnZlcnNhdGlvbjoge1xuICAgICAgICBwYXJ0aWNpcGFudHM6IHtcbiAgICAgICAgICBzb21lOiB7XG4gICAgICAgICAgICB1c2VySWQsXG4gICAgICAgICAgICBpc0FjdGl2ZTogdHJ1ZSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgfSxcbiAgICB9O1xuXG4gICAgaWYgKGNvbnZlcnNhdGlvbklkKSB7XG4gICAgICB3aGVyZUNsYXVzZS5jb252ZXJzYXRpb25JZCA9IGNvbnZlcnNhdGlvbklkO1xuICAgIH1cblxuICAgIGNvbnN0IG1lc3NhZ2VzID0gYXdhaXQgdGhpcy5wcmlzbWEubWVzc2FnZS5maW5kTWFueSh7XG4gICAgICB3aGVyZTogd2hlcmVDbGF1c2UsXG4gICAgICBpbmNsdWRlOiB7XG4gICAgICAgIHNlbmRlcjoge1xuICAgICAgICAgIHNlbGVjdDoge1xuICAgICAgICAgICAgaWQ6IHRydWUsXG4gICAgICAgICAgICBmaXJzdE5hbWU6IHRydWUsXG4gICAgICAgICAgICBsYXN0TmFtZTogdHJ1ZSxcbiAgICAgICAgICAgIGF2YXRhclVybDogdHJ1ZSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgICBjb252ZXJzYXRpb246IHtcbiAgICAgICAgICBzZWxlY3Q6IHtcbiAgICAgICAgICAgIGlkOiB0cnVlLFxuICAgICAgICAgICAgdHlwZTogdHJ1ZSxcbiAgICAgICAgICAgIHRpdGxlOiB0cnVlLFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgICAgb3JkZXJCeTogeyBjcmVhdGVkQXQ6ICdkZXNjJyB9LFxuICAgICAgc2tpcCxcbiAgICAgIHRha2U6IGxpbWl0LFxuICAgIH0pO1xuXG4gICAgcmV0dXJuIG1lc3NhZ2VzO1xuICB9XG59XG4iXSwidmVyc2lvbiI6M30=