{"file":"/home/wetooa/Documents/code/projects/mentara/mentara-api/src/auth/guards/community-access.guard.ts","mappings":"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","names":[],"sources":["/home/wetooa/Documents/code/projects/mentara/mentara-api/src/auth/guards/community-access.guard.ts"],"sourcesContent":["import {\n  Injectable,\n  CanActivate,\n  ExecutionContext,\n  ForbiddenException,\n  BadRequestException,\n  NotFoundException,\n  SetMetadata,\n} from '@nestjs/common';\nimport { Reflector } from '@nestjs/core';\nimport { PrismaService } from 'src/providers/prisma-client.provider';\n\n// Decorator for requiring community membership\nexport const RequireCommunityMembership = () =>\n  SetMetadata('require_community_membership', true);\n\n// Decorator for requiring room access (community membership + room visibility)\nexport const RequireRoomAccess = () => SetMetadata('require_room_access', true);\n\n// Decorator for requiring posting permission in room\nexport const RequirePostingRole = () =>\n  SetMetadata('require_posting_role', true);\n\n// Decorator for requiring moderator role in community context\nexport const RequireCommunityModerator = () =>\n  SetMetadata('require_community_moderator', true);\n\n@Injectable()\nexport class CommunityAccessGuard implements CanActivate {\n  constructor(\n    private reflector: Reflector,\n    private prisma: PrismaService,\n  ) {}\n\n  async canActivate(context: ExecutionContext): Promise<boolean> {\n    const request = context.switchToHttp().getRequest();\n    const userId = request.userId || request.user?.userId;\n\n    if (!userId) {\n      throw new ForbiddenException('User not authenticated');\n    }\n\n    // Check if community membership is required\n    const requiresCommunityMembership =\n      this.reflector.getAllAndOverride<boolean>(\n        'require_community_membership',\n        [context.getHandler(), context.getClass()],\n      );\n\n    if (requiresCommunityMembership) {\n      const communityId = await this.extractCommunityId(request);\n      if (communityId) {\n        await this.validateCommunityMembership(userId, communityId);\n      }\n    }\n\n    // Check if room access is required\n    const requiresRoomAccess = this.reflector.getAllAndOverride<boolean>(\n      'require_room_access',\n      [context.getHandler(), context.getClass()],\n    );\n\n    if (requiresRoomAccess) {\n      const roomId = await this.extractRoomId(request);\n      if (roomId) {\n        await this.validateRoomAccess(userId, roomId);\n      }\n    }\n\n    // Check if posting role is required\n    const requiresPostingRole = this.reflector.getAllAndOverride<boolean>(\n      'require_posting_role',\n      [context.getHandler(), context.getClass()],\n    );\n\n    if (requiresPostingRole) {\n      const roomId = await this.extractRoomId(request);\n      if (roomId) {\n        await this.validatePostingPermission(userId, roomId);\n      }\n    }\n\n    // Check if community moderator role is required\n    const requiresCommunityModerator =\n      this.reflector.getAllAndOverride<boolean>('require_community_moderator', [\n        context.getHandler(),\n        context.getClass(),\n      ]);\n\n    if (requiresCommunityModerator) {\n      const communityId = await this.extractCommunityId(request);\n      if (communityId) {\n        await this.validateCommunityModerator(userId, communityId);\n      }\n    }\n\n    return true;\n  }\n\n  private async extractCommunityId(request: any): Promise<string | null> {\n    // Direct community ID from params\n    if (request.params?.communityId) {\n      return request.params.communityId;\n    }\n\n    // Community ID from body\n    if (request.body?.communityId) {\n      return request.body.communityId;\n    }\n\n    // Extract from room ID\n    const roomId = request.params?.roomId || request.body?.roomId;\n    if (roomId) {\n      const room = await this.prisma.room.findUnique({\n        where: { id: roomId },\n        include: {\n          roomGroup: {\n            include: {\n              community: true,\n            },\n          },\n        },\n      });\n      return room?.roomGroup?.community?.id || null;\n    }\n\n    // Extract from post ID\n    const postId =\n      request.params?.id || request.params?.postId || request.body?.postId;\n    if (postId && request.path.includes('post')) {\n      const post = await this.prisma.post.findUnique({\n        where: { id: postId },\n        include: {\n          room: {\n            include: {\n              roomGroup: {\n                include: {\n                  community: true,\n                },\n              },\n            },\n          },\n        },\n      });\n      return post?.room?.roomGroup?.community?.id || null;\n    }\n\n    return null;\n  }\n\n  private async extractRoomId(request: any): Promise<string | null> {\n    // Direct room ID from params\n    if (request.params?.roomId) {\n      return request.params.roomId;\n    }\n\n    // Room ID from body\n    if (request.body?.roomId) {\n      return request.body.roomId;\n    }\n\n    // Extract from post ID\n    const postId =\n      request.params?.id || request.params?.postId || request.body?.postId;\n    if (postId && request.path.includes('post')) {\n      const post = await this.prisma.post.findUnique({\n        where: { id: postId },\n        select: { roomId: true },\n      });\n      return post?.roomId || null;\n    }\n\n    // Extract from comment ID\n    const commentId = request.params?.id || request.params?.commentId;\n    if (commentId && request.path.includes('comment')) {\n      const comment = await this.prisma.comment.findUnique({\n        where: { id: commentId },\n        include: {\n          post: {\n            select: { roomId: true },\n          },\n        },\n      });\n      return comment?.post?.roomId || null;\n    }\n\n    return null;\n  }\n\n  private async validateCommunityMembership(\n    userId: string,\n    communityId: string,\n  ): Promise<void> {\n    const membership = await this.prisma.membership.findFirst({\n      where: {\n        userId,\n        communityId,\n      },\n    });\n\n    if (!membership) {\n      throw new ForbiddenException(\n        'You must be a member of this community to access this resource',\n      );\n    }\n  }\n\n  private async validateRoomAccess(\n    userId: string,\n    roomId: string,\n  ): Promise<void> {\n    const room = await this.prisma.room.findUnique({\n      where: { id: roomId },\n      include: {\n        roomGroup: {\n          include: {\n            community: {\n              include: {\n                memberships: {\n                  where: { userId },\n                },\n              },\n            },\n          },\n        },\n      },\n    });\n\n    if (!room) {\n      throw new NotFoundException('Room not found');\n    }\n\n    const membership = room.roomGroup.community.memberships[0];\n    if (!membership) {\n      throw new ForbiddenException(\n        'You must be a member of this community to access this room',\n      );\n    }\n\n    // Additional room-level access checks can be added here if needed\n    // For now, community membership grants access to all rooms within the community\n  }\n\n  private async validatePostingPermission(\n    userId: string,\n    roomId: string,\n  ): Promise<void> {\n    const room = await this.prisma.room.findUnique({\n      where: { id: roomId },\n      include: {\n        roomGroup: {\n          include: {\n            community: {\n              include: {\n                memberships: {\n                  where: { userId },\n                },\n              },\n            },\n          },\n        },\n      },\n    });\n\n    if (!room) {\n      throw new NotFoundException('Room not found');\n    }\n\n    const membership = room.roomGroup.community.memberships[0];\n    if (!membership) {\n      throw new ForbiddenException(\n        'You must be a member of this community to post',\n      );\n    }\n\n    // Check room posting role requirements\n    // Get user's global role and check if they're a community moderator\n    const user = await this.prisma.user.findUnique({\n      where: { id: userId },\n      select: { role: true },\n    });\n\n    const isCommunityModerator = await this.prisma.moderatorCommunity.findFirst({\n      where: {\n        moderatorId: userId,\n        communityId: room.roomGroup.community.id,\n      },\n    });\n\n    // Determine effective user role in this community\n    let userRole = 'member'; // Default role for community members\n    if (user?.role === 'admin') {\n      userRole = 'admin';\n    } else if (isCommunityModerator || user?.role === 'moderator') {\n      userRole = 'moderator';\n    }\n\n    const requiredRole = room.postingRole;\n\n    // Define role hierarchy\n    const roleHierarchy = {\n      member: 0,\n      moderator: 1,\n      admin: 2,\n    };\n\n    const userRoleLevel =\n      roleHierarchy[userRole as keyof typeof roleHierarchy] ?? -1;\n    const requiredRoleLevel =\n      roleHierarchy[requiredRole as keyof typeof roleHierarchy] ?? 0;\n\n    if (userRoleLevel < requiredRoleLevel) {\n      throw new ForbiddenException(\n        `You need ${requiredRole} role or higher to post in this room`,\n      );\n    }\n  }\n\n  private async validateCommunityModerator(\n    userId: string,\n    communityId: string,\n  ): Promise<void> {\n    // Check if user is a global admin\n    const user = await this.prisma.user.findUnique({\n      where: { id: userId },\n      select: { role: true },\n    });\n\n    if (user?.role === 'admin') {\n      return; // Global admins have access to all communities\n    }\n\n    // Check if user is assigned as a moderator for this specific community\n    const moderatorCommunity = await this.prisma.moderatorCommunity.findFirst({\n      where: {\n        moderatorId: userId,\n        communityId,\n      },\n    });\n\n    if (!moderatorCommunity) {\n      throw new ForbiddenException(\n        'You must be a moderator or admin of this community',\n      );\n    }\n  }\n\n  // Helper method to get user's role in a community\n  async getUserCommunityRole(\n    userId: string,\n    communityId: string,\n  ): Promise<string | null> {\n    // Check if user is a member of the community\n    const membership = await this.prisma.membership.findFirst({\n      where: {\n        userId,\n        communityId,\n      },\n    });\n\n    if (!membership) {\n      return null; // User is not a member\n    }\n\n    // Get user's global role\n    const user = await this.prisma.user.findUnique({\n      where: { id: userId },\n      select: { role: true },\n    });\n\n    // Check if user is assigned as a moderator for this specific community\n    const moderatorCommunity = await this.prisma.moderatorCommunity.findFirst({\n      where: {\n        moderatorId: userId,\n        communityId,\n      },\n    });\n\n    // Determine effective role in this community\n    if (user?.role === 'admin') {\n      return 'admin';\n    } else if (moderatorCommunity || user?.role === 'moderator') {\n      return 'moderator';\n    } else {\n      return 'member'; // Default role for community members\n    }\n  }\n\n  // Helper method to check if user can perform moderation actions\n  async canModerate(userId: string, communityId: string): Promise<boolean> {\n    try {\n      await this.validateCommunityModerator(userId, communityId);\n      return true;\n    } catch {\n      return false;\n    }\n  }\n}\n"],"version":3}