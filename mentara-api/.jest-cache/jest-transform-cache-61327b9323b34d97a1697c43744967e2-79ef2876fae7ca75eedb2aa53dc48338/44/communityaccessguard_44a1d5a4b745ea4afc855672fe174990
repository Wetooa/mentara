5fa5ce628ca439432c5b094ef97b9d6f
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var _a, _b;
Object.defineProperty(exports, "__esModule", { value: true });
exports.CommunityAccessGuard = exports.RequireCommunityModerator = exports.RequirePostingRole = exports.RequireRoomAccess = exports.RequireCommunityMembership = void 0;
const common_1 = require("@nestjs/common");
const core_1 = require("@nestjs/core");
const prisma_client_provider_1 = require("src/providers/prisma-client.provider");
// Decorator for requiring community membership
const RequireCommunityMembership = () => (0, common_1.SetMetadata)('require_community_membership', true);
exports.RequireCommunityMembership = RequireCommunityMembership;
// Decorator for requiring room access (community membership + room visibility)
const RequireRoomAccess = () => (0, common_1.SetMetadata)('require_room_access', true);
exports.RequireRoomAccess = RequireRoomAccess;
// Decorator for requiring posting permission in room
const RequirePostingRole = () => (0, common_1.SetMetadata)('require_posting_role', true);
exports.RequirePostingRole = RequirePostingRole;
// Decorator for requiring moderator role in community context
const RequireCommunityModerator = () => (0, common_1.SetMetadata)('require_community_moderator', true);
exports.RequireCommunityModerator = RequireCommunityModerator;
let CommunityAccessGuard = class CommunityAccessGuard {
    reflector;
    prisma;
    constructor(reflector, prisma) {
        this.reflector = reflector;
        this.prisma = prisma;
    }
    async canActivate(context) {
        const request = context.switchToHttp().getRequest();
        const userId = request.userId || request.user?.userId;
        if (!userId) {
            throw new common_1.ForbiddenException('User not authenticated');
        }
        // Check if community membership is required
        const requiresCommunityMembership = this.reflector.getAllAndOverride('require_community_membership', [context.getHandler(), context.getClass()]);
        if (requiresCommunityMembership) {
            const communityId = await this.extractCommunityId(request);
            if (communityId) {
                await this.validateCommunityMembership(userId, communityId);
            }
        }
        // Check if room access is required
        const requiresRoomAccess = this.reflector.getAllAndOverride('require_room_access', [context.getHandler(), context.getClass()]);
        if (requiresRoomAccess) {
            const roomId = await this.extractRoomId(request);
            if (roomId) {
                await this.validateRoomAccess(userId, roomId);
            }
        }
        // Check if posting role is required
        const requiresPostingRole = this.reflector.getAllAndOverride('require_posting_role', [context.getHandler(), context.getClass()]);
        if (requiresPostingRole) {
            const roomId = await this.extractRoomId(request);
            if (roomId) {
                await this.validatePostingPermission(userId, roomId);
            }
        }
        // Check if community moderator role is required
        const requiresCommunityModerator = this.reflector.getAllAndOverride('require_community_moderator', [
            context.getHandler(),
            context.getClass(),
        ]);
        if (requiresCommunityModerator) {
            const communityId = await this.extractCommunityId(request);
            if (communityId) {
                await this.validateCommunityModerator(userId, communityId);
            }
        }
        return true;
    }
    async extractCommunityId(request) {
        // Direct community ID from params
        if (request.params?.communityId) {
            return request.params.communityId;
        }
        // Community ID from body
        if (request.body?.communityId) {
            return request.body.communityId;
        }
        // Extract from room ID
        const roomId = request.params?.roomId || request.body?.roomId;
        if (roomId) {
            const room = await this.prisma.room.findUnique({
                where: { id: roomId },
                include: {
                    roomGroup: {
                        include: {
                            community: true,
                        },
                    },
                },
            });
            return room?.roomGroup?.community?.id || null;
        }
        // Extract from post ID
        const postId = request.params?.id || request.params?.postId || request.body?.postId;
        if (postId && request.path.includes('post')) {
            const post = await this.prisma.post.findUnique({
                where: { id: postId },
                include: {
                    room: {
                        include: {
                            roomGroup: {
                                include: {
                                    community: true,
                                },
                            },
                        },
                    },
                },
            });
            return post?.room?.roomGroup?.community?.id || null;
        }
        return null;
    }
    async extractRoomId(request) {
        // Direct room ID from params
        if (request.params?.roomId) {
            return request.params.roomId;
        }
        // Room ID from body
        if (request.body?.roomId) {
            return request.body.roomId;
        }
        // Extract from post ID
        const postId = request.params?.id || request.params?.postId || request.body?.postId;
        if (postId && request.path.includes('post')) {
            const post = await this.prisma.post.findUnique({
                where: { id: postId },
                select: { roomId: true },
            });
            return post?.roomId || null;
        }
        // Extract from comment ID
        const commentId = request.params?.id || request.params?.commentId;
        if (commentId && request.path.includes('comment')) {
            const comment = await this.prisma.comment.findUnique({
                where: { id: commentId },
                include: {
                    post: {
                        select: { roomId: true },
                    },
                },
            });
            return comment?.post?.roomId || null;
        }
        return null;
    }
    async validateCommunityMembership(userId, communityId) {
        const membership = await this.prisma.membership.findFirst({
            where: {
                userId,
                communityId,
            },
        });
        if (!membership) {
            throw new common_1.ForbiddenException('You must be a member of this community to access this resource');
        }
    }
    async validateRoomAccess(userId, roomId) {
        const room = await this.prisma.room.findUnique({
            where: { id: roomId },
            include: {
                roomGroup: {
                    include: {
                        community: {
                            include: {
                                memberships: {
                                    where: { userId },
                                },
                            },
                        },
                    },
                },
            },
        });
        if (!room) {
            throw new common_1.NotFoundException('Room not found');
        }
        const membership = room.roomGroup.community.memberships[0];
        if (!membership) {
            throw new common_1.ForbiddenException('You must be a member of this community to access this room');
        }
        // Additional room-level access checks can be added here if needed
        // For now, community membership grants access to all rooms within the community
    }
    async validatePostingPermission(userId, roomId) {
        const room = await this.prisma.room.findUnique({
            where: { id: roomId },
            include: {
                roomGroup: {
                    include: {
                        community: {
                            include: {
                                memberships: {
                                    where: { userId },
                                },
                            },
                        },
                    },
                },
            },
        });
        if (!room) {
            throw new common_1.NotFoundException('Room not found');
        }
        const membership = room.roomGroup.community.memberships[0];
        if (!membership) {
            throw new common_1.ForbiddenException('You must be a member of this community to post');
        }
        // Check room posting role requirements
        // Get user's global role and check if they're a community moderator
        const user = await this.prisma.user.findUnique({
            where: { id: userId },
            select: { role: true },
        });
        const isCommunityModerator = await this.prisma.moderatorCommunity.findFirst({
            where: {
                moderatorId: userId,
                communityId: room.roomGroup.community.id,
            },
        });
        // Determine effective user role in this community
        let userRole = 'member'; // Default role for community members
        if (user?.role === 'admin') {
            userRole = 'admin';
        }
        else if (isCommunityModerator || user?.role === 'moderator') {
            userRole = 'moderator';
        }
        const requiredRole = room.postingRole;
        // Define role hierarchy
        const roleHierarchy = {
            member: 0,
            moderator: 1,
            admin: 2,
        };
        const userRoleLevel = roleHierarchy[userRole] ?? -1;
        const requiredRoleLevel = roleHierarchy[requiredRole] ?? 0;
        if (userRoleLevel < requiredRoleLevel) {
            throw new common_1.ForbiddenException(`You need ${requiredRole} role or higher to post in this room`);
        }
    }
    async validateCommunityModerator(userId, communityId) {
        // Check if user is a global admin
        const user = await this.prisma.user.findUnique({
            where: { id: userId },
            select: { role: true },
        });
        if (user?.role === 'admin') {
            return; // Global admins have access to all communities
        }
        // Check if user is assigned as a moderator for this specific community
        const moderatorCommunity = await this.prisma.moderatorCommunity.findFirst({
            where: {
                moderatorId: userId,
                communityId,
            },
        });
        if (!moderatorCommunity) {
            throw new common_1.ForbiddenException('You must be a moderator or admin of this community');
        }
    }
    // Helper method to get user's role in a community
    async getUserCommunityRole(userId, communityId) {
        // Check if user is a member of the community
        const membership = await this.prisma.membership.findFirst({
            where: {
                userId,
                communityId,
            },
        });
        if (!membership) {
            return null; // User is not a member
        }
        // Get user's global role
        const user = await this.prisma.user.findUnique({
            where: { id: userId },
            select: { role: true },
        });
        // Check if user is assigned as a moderator for this specific community
        const moderatorCommunity = await this.prisma.moderatorCommunity.findFirst({
            where: {
                moderatorId: userId,
                communityId,
            },
        });
        // Determine effective role in this community
        if (user?.role === 'admin') {
            return 'admin';
        }
        else if (moderatorCommunity || user?.role === 'moderator') {
            return 'moderator';
        }
        else {
            return 'member'; // Default role for community members
        }
    }
    // Helper method to check if user can perform moderation actions
    async canModerate(userId, communityId) {
        try {
            await this.validateCommunityModerator(userId, communityId);
            return true;
        }
        catch {
            return false;
        }
    }
};
exports.CommunityAccessGuard = CommunityAccessGuard;
exports.CommunityAccessGuard = CommunityAccessGuard = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [typeof (_a = typeof core_1.Reflector !== "undefined" && core_1.Reflector) === "function" ? _a : Object, typeof (_b = typeof prisma_client_provider_1.PrismaService !== "undefined" && prisma_client_provider_1.PrismaService) === "function" ? _b : Object])
], CommunityAccessGuard);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL2F1dGgvZ3VhcmRzL2NvbW11bml0eS1hY2Nlc3MuZ3VhcmQudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7OztBQUFBLDJDQVF3QjtBQUN4Qix1Q0FBeUM7QUFDekMsaUZBQXFFO0FBRXJFLCtDQUErQztBQUN4QyxNQUFNLDBCQUEwQixHQUFHLEdBQUcsRUFBRSxDQUM3QyxJQUFBLG9CQUFXLEVBQUMsOEJBQThCLEVBQUUsSUFBSSxDQUFDLENBQUM7QUFEdkMsUUFBQSwwQkFBMEIsOEJBQ2E7QUFFcEQsK0VBQStFO0FBQ3hFLE1BQU0saUJBQWlCLEdBQUcsR0FBRyxFQUFFLENBQUMsSUFBQSxvQkFBVyxFQUFDLHFCQUFxQixFQUFFLElBQUksQ0FBQyxDQUFDO0FBQW5FLFFBQUEsaUJBQWlCLHFCQUFrRDtBQUVoRixxREFBcUQ7QUFDOUMsTUFBTSxrQkFBa0IsR0FBRyxHQUFHLEVBQUUsQ0FDckMsSUFBQSxvQkFBVyxFQUFDLHNCQUFzQixFQUFFLElBQUksQ0FBQyxDQUFDO0FBRC9CLFFBQUEsa0JBQWtCLHNCQUNhO0FBRTVDLDhEQUE4RDtBQUN2RCxNQUFNLHlCQUF5QixHQUFHLEdBQUcsRUFBRSxDQUM1QyxJQUFBLG9CQUFXLEVBQUMsNkJBQTZCLEVBQUUsSUFBSSxDQUFDLENBQUM7QUFEdEMsUUFBQSx5QkFBeUIsNkJBQ2E7QUFHNUMsSUFBTSxvQkFBb0IsR0FBMUIsTUFBTSxvQkFBb0I7SUFFckI7SUFDQTtJQUZWLFlBQ1UsU0FBb0IsRUFDcEIsTUFBcUI7UUFEckIsY0FBUyxHQUFULFNBQVMsQ0FBVztRQUNwQixXQUFNLEdBQU4sTUFBTSxDQUFlO0lBQzVCLENBQUM7SUFFSixLQUFLLENBQUMsV0FBVyxDQUFDLE9BQXlCO1FBQ3pDLE1BQU0sT0FBTyxHQUFHLE9BQU8sQ0FBQyxZQUFZLEVBQUUsQ0FBQyxVQUFVLEVBQUUsQ0FBQztRQUNwRCxNQUFNLE1BQU0sR0FBRyxP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YXJhL21lbnRhcmEtYXBpL3NyYy9hdXRoL2d1YXJkcy9jb21tdW5pdHktYWNjZXNzLmd1YXJkLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIEluamVjdGFibGUsXG4gIENhbkFjdGl2YXRlLFxuICBFeGVjdXRpb25Db250ZXh0LFxuICBGb3JiaWRkZW5FeGNlcHRpb24sXG4gIEJhZFJlcXVlc3RFeGNlcHRpb24sXG4gIE5vdEZvdW5kRXhjZXB0aW9uLFxuICBTZXRNZXRhZGF0YSxcbn0gZnJvbSAnQG5lc3Rqcy9jb21tb24nO1xuaW1wb3J0IHsgUmVmbGVjdG9yIH0gZnJvbSAnQG5lc3Rqcy9jb3JlJztcbmltcG9ydCB7IFByaXNtYVNlcnZpY2UgfSBmcm9tICdzcmMvcHJvdmlkZXJzL3ByaXNtYS1jbGllbnQucHJvdmlkZXInO1xuXG4vLyBEZWNvcmF0b3IgZm9yIHJlcXVpcmluZyBjb21tdW5pdHkgbWVtYmVyc2hpcFxuZXhwb3J0IGNvbnN0IFJlcXVpcmVDb21tdW5pdHlNZW1iZXJzaGlwID0gKCkgPT5cbiAgU2V0TWV0YWRhdGEoJ3JlcXVpcmVfY29tbXVuaXR5X21lbWJlcnNoaXAnLCB0cnVlKTtcblxuLy8gRGVjb3JhdG9yIGZvciByZXF1aXJpbmcgcm9vbSBhY2Nlc3MgKGNvbW11bml0eSBtZW1iZXJzaGlwICsgcm9vbSB2aXNpYmlsaXR5KVxuZXhwb3J0IGNvbnN0IFJlcXVpcmVSb29tQWNjZXNzID0gKCkgPT4gU2V0TWV0YWRhdGEoJ3JlcXVpcmVfcm9vbV9hY2Nlc3MnLCB0cnVlKTtcblxuLy8gRGVjb3JhdG9yIGZvciByZXF1aXJpbmcgcG9zdGluZyBwZXJtaXNzaW9uIGluIHJvb21cbmV4cG9ydCBjb25zdCBSZXF1aXJlUG9zdGluZ1JvbGUgPSAoKSA9PlxuICBTZXRNZXRhZGF0YSgncmVxdWlyZV9wb3N0aW5nX3JvbGUnLCB0cnVlKTtcblxuLy8gRGVjb3JhdG9yIGZvciByZXF1aXJpbmcgbW9kZXJhdG9yIHJvbGUgaW4gY29tbXVuaXR5IGNvbnRleHRcbmV4cG9ydCBjb25zdCBSZXF1aXJlQ29tbXVuaXR5TW9kZXJhdG9yID0gKCkgPT5cbiAgU2V0TWV0YWRhdGEoJ3JlcXVpcmVfY29tbXVuaXR5X21vZGVyYXRvcicsIHRydWUpO1xuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgQ29tbXVuaXR5QWNjZXNzR3VhcmQgaW1wbGVtZW50cyBDYW5BY3RpdmF0ZSB7XG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgcmVmbGVjdG9yOiBSZWZsZWN0b3IsXG4gICAgcHJpdmF0ZSBwcmlzbWE6IFByaXNtYVNlcnZpY2UsXG4gICkge31cblxuICBhc3luYyBjYW5BY3RpdmF0ZShjb250ZXh0OiBFeGVjdXRpb25Db250ZXh0KTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgY29uc3QgcmVxdWVzdCA9IGNvbnRleHQuc3dpdGNoVG9IdHRwKCkuZ2V0UmVxdWVzdCgpO1xuICAgIGNvbnN0IHVzZXJJZCA9IHJlcXVlc3QudXNlcklkIHx8IHJlcXVlc3QudXNlcj8udXNlcklkO1xuXG4gICAgaWYgKCF1c2VySWQpIHtcbiAgICAgIHRocm93IG5ldyBGb3JiaWRkZW5FeGNlcHRpb24oJ1VzZXIgbm90IGF1dGhlbnRpY2F0ZWQnKTtcbiAgICB9XG5cbiAgICAvLyBDaGVjayBpZiBjb21tdW5pdHkgbWVtYmVyc2hpcCBpcyByZXF1aXJlZFxuICAgIGNvbnN0IHJlcXVpcmVzQ29tbXVuaXR5TWVtYmVyc2hpcCA9XG4gICAgICB0aGlzLnJlZmxlY3Rvci5nZXRBbGxBbmRPdmVycmlkZTxib29sZWFuPihcbiAgICAgICAgJ3JlcXVpcmVfY29tbXVuaXR5X21lbWJlcnNoaXAnLFxuICAgICAgICBbY29udGV4dC5nZXRIYW5kbGVyKCksIGNvbnRleHQuZ2V0Q2xhc3MoKV0sXG4gICAgICApO1xuXG4gICAgaWYgKHJlcXVpcmVzQ29tbXVuaXR5TWVtYmVyc2hpcCkge1xuICAgICAgY29uc3QgY29tbXVuaXR5SWQgPSBhd2FpdCB0aGlzLmV4dHJhY3RDb21tdW5pdHlJZChyZXF1ZXN0KTtcbiAgICAgIGlmIChjb21tdW5pdHlJZCkge1xuICAgICAgICBhd2FpdCB0aGlzLnZhbGlkYXRlQ29tbXVuaXR5TWVtYmVyc2hpcCh1c2VySWQsIGNvbW11bml0eUlkKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBDaGVjayBpZiByb29tIGFjY2VzcyBpcyByZXF1aXJlZFxuICAgIGNvbnN0IHJlcXVpcmVzUm9vbUFjY2VzcyA9IHRoaXMucmVmbGVjdG9yLmdldEFsbEFuZE92ZXJyaWRlPGJvb2xlYW4+KFxuICAgICAgJ3JlcXVpcmVfcm9vbV9hY2Nlc3MnLFxuICAgICAgW2NvbnRleHQuZ2V0SGFuZGxlcigpLCBjb250ZXh0LmdldENsYXNzKCldLFxuICAgICk7XG5cbiAgICBpZiAocmVxdWlyZXNSb29tQWNjZXNzKSB7XG4gICAgICBjb25zdCByb29tSWQgPSBhd2FpdCB0aGlzLmV4dHJhY3RSb29tSWQocmVxdWVzdCk7XG4gICAgICBpZiAocm9vbUlkKSB7XG4gICAgICAgIGF3YWl0IHRoaXMudmFsaWRhdGVSb29tQWNjZXNzKHVzZXJJZCwgcm9vbUlkKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBDaGVjayBpZiBwb3N0aW5nIHJvbGUgaXMgcmVxdWlyZWRcbiAgICBjb25zdCByZXF1aXJlc1Bvc3RpbmdSb2xlID0gdGhpcy5yZWZsZWN0b3IuZ2V0QWxsQW5kT3ZlcnJpZGU8Ym9vbGVhbj4oXG4gICAgICAncmVxdWlyZV9wb3N0aW5nX3JvbGUnLFxuICAgICAgW2NvbnRleHQuZ2V0SGFuZGxlcigpLCBjb250ZXh0LmdldENsYXNzKCldLFxuICAgICk7XG5cbiAgICBpZiAocmVxdWlyZXNQb3N0aW5nUm9sZSkge1xuICAgICAgY29uc3Qgcm9vbUlkID0gYXdhaXQgdGhpcy5leHRyYWN0Um9vbUlkKHJlcXVlc3QpO1xuICAgICAgaWYgKHJvb21JZCkge1xuICAgICAgICBhd2FpdCB0aGlzLnZhbGlkYXRlUG9zdGluZ1Blcm1pc3Npb24odXNlcklkLCByb29tSWQpO1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vIENoZWNrIGlmIGNvbW11bml0eSBtb2RlcmF0b3Igcm9sZSBpcyByZXF1aXJlZFxuICAgIGNvbnN0IHJlcXVpcmVzQ29tbXVuaXR5TW9kZXJhdG9yID1cbiAgICAgIHRoaXMucmVmbGVjdG9yLmdldEFsbEFuZE92ZXJyaWRlPGJvb2xlYW4+KCdyZXF1aXJlX2NvbW11bml0eV9tb2RlcmF0b3InLCBbXG4gICAgICAgIGNvbnRleHQuZ2V0SGFuZGxlcigpLFxuICAgICAgICBjb250ZXh0LmdldENsYXNzKCksXG4gICAgICBdKTtcblxuICAgIGlmIChyZXF1aXJlc0NvbW11bml0eU1vZGVyYXRvcikge1xuICAgICAgY29uc3QgY29tbXVuaXR5SWQgPSBhd2FpdCB0aGlzLmV4dHJhY3RDb21tdW5pdHlJZChyZXF1ZXN0KTtcbiAgICAgIGlmIChjb21tdW5pdHlJZCkge1xuICAgICAgICBhd2FpdCB0aGlzLnZhbGlkYXRlQ29tbXVuaXR5TW9kZXJhdG9yKHVzZXJJZCwgY29tbXVuaXR5SWQpO1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiB0cnVlO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBleHRyYWN0Q29tbXVuaXR5SWQocmVxdWVzdDogYW55KTogUHJvbWlzZTxzdHJpbmcgfCBudWxsPiB7XG4gICAgLy8gRGlyZWN0IGNvbW11bml0eSBJRCBmcm9tIHBhcmFtc1xuICAgIGlmIChyZXF1ZXN0LnBhcmFtcz8uY29tbXVuaXR5SWQpIHtcbiAgICAgIHJldHVybiByZXF1ZXN0LnBhcmFtcy5jb21tdW5pdHlJZDtcbiAgICB9XG5cbiAgICAvLyBDb21tdW5pdHkgSUQgZnJvbSBib2R5XG4gICAgaWYgKHJlcXVlc3QuYm9keT8uY29tbXVuaXR5SWQpIHtcbiAgICAgIHJldHVybiByZXF1ZXN0LmJvZHkuY29tbXVuaXR5SWQ7XG4gICAgfVxuXG4gICAgLy8gRXh0cmFjdCBmcm9tIHJvb20gSURcbiAgICBjb25zdCByb29tSWQgPSByZXF1ZXN0LnBhcmFtcz8ucm9vbUlkIHx8IHJlcXVlc3QuYm9keT8ucm9vbUlkO1xuICAgIGlmIChyb29tSWQpIHtcbiAgICAgIGNvbnN0IHJvb20gPSBhd2FpdCB0aGlzLnByaXNtYS5yb29tLmZpbmRVbmlxdWUoe1xuICAgICAgICB3aGVyZTogeyBpZDogcm9vbUlkIH0sXG4gICAgICAgIGluY2x1ZGU6IHtcbiAgICAgICAgICByb29tR3JvdXA6IHtcbiAgICAgICAgICAgIGluY2x1ZGU6IHtcbiAgICAgICAgICAgICAgY29tbXVuaXR5OiB0cnVlLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgfSk7XG4gICAgICByZXR1cm4gcm9vbT8ucm9vbUdyb3VwPy5jb21tdW5pdHk/LmlkIHx8IG51bGw7XG4gICAgfVxuXG4gICAgLy8gRXh0cmFjdCBmcm9tIHBvc3QgSURcbiAgICBjb25zdCBwb3N0SWQgPVxuICAgICAgcmVxdWVzdC5wYXJhbXM/LmlkIHx8IHJlcXVlc3QucGFyYW1zPy5wb3N0SWQgfHwgcmVxdWVzdC5ib2R5Py5wb3N0SWQ7XG4gICAgaWYgKHBvc3RJZCAmJiByZXF1ZXN0LnBhdGguaW5jbHVkZXMoJ3Bvc3QnKSkge1xuICAgICAgY29uc3QgcG9zdCA9IGF3YWl0IHRoaXMucHJpc21hLnBvc3QuZmluZFVuaXF1ZSh7XG4gICAgICAgIHdoZXJlOiB7IGlkOiBwb3N0SWQgfSxcbiAgICAgICAgaW5jbHVkZToge1xuICAgICAgICAgIHJvb206IHtcbiAgICAgICAgICAgIGluY2x1ZGU6IHtcbiAgICAgICAgICAgICAgcm9vbUdyb3VwOiB7XG4gICAgICAgICAgICAgICAgaW5jbHVkZToge1xuICAgICAgICAgICAgICAgICAgY29tbXVuaXR5OiB0cnVlLFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICB9KTtcbiAgICAgIHJldHVybiBwb3N0Py5yb29tPy5yb29tR3JvdXA/LmNvbW11bml0eT8uaWQgfHwgbnVsbDtcbiAgICB9XG5cbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgZXh0cmFjdFJvb21JZChyZXF1ZXN0OiBhbnkpOiBQcm9taXNlPHN0cmluZyB8IG51bGw+IHtcbiAgICAvLyBEaXJlY3Qgcm9vbSBJRCBmcm9tIHBhcmFtc1xuICAgIGlmIChyZXF1ZXN0LnBhcmFtcz8ucm9vbUlkKSB7XG4gICAgICByZXR1cm4gcmVxdWVzdC5wYXJhbXMucm9vbUlkO1xuICAgIH1cblxuICAgIC8vIFJvb20gSUQgZnJvbSBib2R5XG4gICAgaWYgKHJlcXVlc3QuYm9keT8ucm9vbUlkKSB7XG4gICAgICByZXR1cm4gcmVxdWVzdC5ib2R5LnJvb21JZDtcbiAgICB9XG5cbiAgICAvLyBFeHRyYWN0IGZyb20gcG9zdCBJRFxuICAgIGNvbnN0IHBvc3RJZCA9XG4gICAgICByZXF1ZXN0LnBhcmFtcz8uaWQgfHwgcmVxdWVzdC5wYXJhbXM/LnBvc3RJZCB8fCByZXF1ZXN0LmJvZHk/LnBvc3RJZDtcbiAgICBpZiAocG9zdElkICYmIHJlcXVlc3QucGF0aC5pbmNsdWRlcygncG9zdCcpKSB7XG4gICAgICBjb25zdCBwb3N0ID0gYXdhaXQgdGhpcy5wcmlzbWEucG9zdC5maW5kVW5pcXVlKHtcbiAgICAgICAgd2hlcmU6IHsgaWQ6IHBvc3RJZCB9LFxuICAgICAgICBzZWxlY3Q6IHsgcm9vbUlkOiB0cnVlIH0sXG4gICAgICB9KTtcbiAgICAgIHJldHVybiBwb3N0Py5yb29tSWQgfHwgbnVsbDtcbiAgICB9XG5cbiAgICAvLyBFeHRyYWN0IGZyb20gY29tbWVudCBJRFxuICAgIGNvbnN0IGNvbW1lbnRJZCA9IHJlcXVlc3QucGFyYW1zPy5pZCB8fCByZXF1ZXN0LnBhcmFtcz8uY29tbWVudElkO1xuICAgIGlmIChjb21tZW50SWQgJiYgcmVxdWVzdC5wYXRoLmluY2x1ZGVzKCdjb21tZW50JykpIHtcbiAgICAgIGNvbnN0IGNvbW1lbnQgPSBhd2FpdCB0aGlzLnByaXNtYS5jb21tZW50LmZpbmRVbmlxdWUoe1xuICAgICAgICB3aGVyZTogeyBpZDogY29tbWVudElkIH0sXG4gICAgICAgIGluY2x1ZGU6IHtcbiAgICAgICAgICBwb3N0OiB7XG4gICAgICAgICAgICBzZWxlY3Q6IHsgcm9vbUlkOiB0cnVlIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgIH0pO1xuICAgICAgcmV0dXJuIGNvbW1lbnQ/LnBvc3Q/LnJvb21JZCB8fCBudWxsO1xuICAgIH1cblxuICAgIHJldHVybiBudWxsO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyB2YWxpZGF0ZUNvbW11bml0eU1lbWJlcnNoaXAoXG4gICAgdXNlcklkOiBzdHJpbmcsXG4gICAgY29tbXVuaXR5SWQ6IHN0cmluZyxcbiAgKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgY29uc3QgbWVtYmVyc2hpcCA9IGF3YWl0IHRoaXMucHJpc21hLm1lbWJlcnNoaXAuZmluZEZpcnN0KHtcbiAgICAgIHdoZXJlOiB7XG4gICAgICAgIHVzZXJJZCxcbiAgICAgICAgY29tbXVuaXR5SWQsXG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgaWYgKCFtZW1iZXJzaGlwKSB7XG4gICAgICB0aHJvdyBuZXcgRm9yYmlkZGVuRXhjZXB0aW9uKFxuICAgICAgICAnWW91IG11c3QgYmUgYSBtZW1iZXIgb2YgdGhpcyBjb21tdW5pdHkgdG8gYWNjZXNzIHRoaXMgcmVzb3VyY2UnLFxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIHZhbGlkYXRlUm9vbUFjY2VzcyhcbiAgICB1c2VySWQ6IHN0cmluZyxcbiAgICByb29tSWQ6IHN0cmluZyxcbiAgKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgY29uc3Qgcm9vbSA9IGF3YWl0IHRoaXMucHJpc21hLnJvb20uZmluZFVuaXF1ZSh7XG4gICAgICB3aGVyZTogeyBpZDogcm9vbUlkIH0sXG4gICAgICBpbmNsdWRlOiB7XG4gICAgICAgIHJvb21Hcm91cDoge1xuICAgICAgICAgIGluY2x1ZGU6IHtcbiAgICAgICAgICAgIGNvbW11bml0eToge1xuICAgICAgICAgICAgICBpbmNsdWRlOiB7XG4gICAgICAgICAgICAgICAgbWVtYmVyc2hpcHM6IHtcbiAgICAgICAgICAgICAgICAgIHdoZXJlOiB7IHVzZXJJZCB9LFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgaWYgKCFyb29tKSB7XG4gICAgICB0aHJvdyBuZXcgTm90Rm91bmRFeGNlcHRpb24oJ1Jvb20gbm90IGZvdW5kJyk7XG4gICAgfVxuXG4gICAgY29uc3QgbWVtYmVyc2hpcCA9IHJvb20ucm9vbUdyb3VwLmNvbW11bml0eS5tZW1iZXJzaGlwc1swXTtcbiAgICBpZiAoIW1lbWJlcnNoaXApIHtcbiAgICAgIHRocm93IG5ldyBGb3JiaWRkZW5FeGNlcHRpb24oXG4gICAgICAgICdZb3UgbXVzdCBiZSBhIG1lbWJlciBvZiB0aGlzIGNvbW11bml0eSB0byBhY2Nlc3MgdGhpcyByb29tJyxcbiAgICAgICk7XG4gICAgfVxuXG4gICAgLy8gQWRkaXRpb25hbCByb29tLWxldmVsIGFjY2VzcyBjaGVja3MgY2FuIGJlIGFkZGVkIGhlcmUgaWYgbmVlZGVkXG4gICAgLy8gRm9yIG5vdywgY29tbXVuaXR5IG1lbWJlcnNoaXAgZ3JhbnRzIGFjY2VzcyB0byBhbGwgcm9vbXMgd2l0aGluIHRoZSBjb21tdW5pdHlcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgdmFsaWRhdGVQb3N0aW5nUGVybWlzc2lvbihcbiAgICB1c2VySWQ6IHN0cmluZyxcbiAgICByb29tSWQ6IHN0cmluZyxcbiAgKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgY29uc3Qgcm9vbSA9IGF3YWl0IHRoaXMucHJpc21hLnJvb20uZmluZFVuaXF1ZSh7XG4gICAgICB3aGVyZTogeyBpZDogcm9vbUlkIH0sXG4gICAgICBpbmNsdWRlOiB7XG4gICAgICAgIHJvb21Hcm91cDoge1xuICAgICAgICAgIGluY2x1ZGU6IHtcbiAgICAgICAgICAgIGNvbW11bml0eToge1xuICAgICAgICAgICAgICBpbmNsdWRlOiB7XG4gICAgICAgICAgICAgICAgbWVtYmVyc2hpcHM6IHtcbiAgICAgICAgICAgICAgICAgIHdoZXJlOiB7IHVzZXJJZCB9LFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgaWYgKCFyb29tKSB7XG4gICAgICB0aHJvdyBuZXcgTm90Rm91bmRFeGNlcHRpb24oJ1Jvb20gbm90IGZvdW5kJyk7XG4gICAgfVxuXG4gICAgY29uc3QgbWVtYmVyc2hpcCA9IHJvb20ucm9vbUdyb3VwLmNvbW11bml0eS5tZW1iZXJzaGlwc1swXTtcbiAgICBpZiAoIW1lbWJlcnNoaXApIHtcbiAgICAgIHRocm93IG5ldyBGb3JiaWRkZW5FeGNlcHRpb24oXG4gICAgICAgICdZb3UgbXVzdCBiZSBhIG1lbWJlciBvZiB0aGlzIGNvbW11bml0eSB0byBwb3N0JyxcbiAgICAgICk7XG4gICAgfVxuXG4gICAgLy8gQ2hlY2sgcm9vbSBwb3N0aW5nIHJvbGUgcmVxdWlyZW1lbnRzXG4gICAgLy8gR2V0IHVzZXIncyBnbG9iYWwgcm9sZSBhbmQgY2hlY2sgaWYgdGhleSdyZSBhIGNvbW11bml0eSBtb2RlcmF0b3JcbiAgICBjb25zdCB1c2VyID0gYXdhaXQgdGhpcy5wcmlzbWEudXNlci5maW5kVW5pcXVlKHtcbiAgICAgIHdoZXJlOiB7IGlkOiB1c2VySWQgfSxcbiAgICAgIHNlbGVjdDogeyByb2xlOiB0cnVlIH0sXG4gICAgfSk7XG5cbiAgICBjb25zdCBpc0NvbW11bml0eU1vZGVyYXRvciA9IGF3YWl0IHRoaXMucHJpc21hLm1vZGVyYXRvckNvbW11bml0eS5maW5kRmlyc3Qoe1xuICAgICAgd2hlcmU6IHtcbiAgICAgICAgbW9kZXJhdG9ySWQ6IHVzZXJJZCxcbiAgICAgICAgY29tbXVuaXR5SWQ6IHJvb20ucm9vbUdyb3VwLmNvbW11bml0eS5pZCxcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICAvLyBEZXRlcm1pbmUgZWZmZWN0aXZlIHVzZXIgcm9sZSBpbiB0aGlzIGNvbW11bml0eVxuICAgIGxldCB1c2VyUm9sZSA9ICdtZW1iZXInOyAvLyBEZWZhdWx0IHJvbGUgZm9yIGNvbW11bml0eSBtZW1iZXJzXG4gICAgaWYgKHVzZXI/LnJvbGUgPT09ICdhZG1pbicpIHtcbiAgICAgIHVzZXJSb2xlID0gJ2FkbWluJztcbiAgICB9IGVsc2UgaWYgKGlzQ29tbXVuaXR5TW9kZXJhdG9yIHx8IHVzZXI/LnJvbGUgPT09ICdtb2RlcmF0b3InKSB7XG4gICAgICB1c2VyUm9sZSA9ICdtb2RlcmF0b3InO1xuICAgIH1cblxuICAgIGNvbnN0IHJlcXVpcmVkUm9sZSA9IHJvb20ucG9zdGluZ1JvbGU7XG5cbiAgICAvLyBEZWZpbmUgcm9sZSBoaWVyYXJjaHlcbiAgICBjb25zdCByb2xlSGllcmFyY2h5ID0ge1xuICAgICAgbWVtYmVyOiAwLFxuICAgICAgbW9kZXJhdG9yOiAxLFxuICAgICAgYWRtaW46IDIsXG4gICAgfTtcblxuICAgIGNvbnN0IHVzZXJSb2xlTGV2ZWwgPVxuICAgICAgcm9sZUhpZXJhcmNoeVt1c2VyUm9sZSBhcyBrZXlvZiB0eXBlb2Ygcm9sZUhpZXJhcmNoeV0gPz8gLTE7XG4gICAgY29uc3QgcmVxdWlyZWRSb2xlTGV2ZWwgPVxuICAgICAgcm9sZUhpZXJhcmNoeVtyZXF1aXJlZFJvbGUgYXMga2V5b2YgdHlwZW9mIHJvbGVIaWVyYXJjaHldID8/IDA7XG5cbiAgICBpZiAodXNlclJvbGVMZXZlbCA8IHJlcXVpcmVkUm9sZUxldmVsKSB7XG4gICAgICB0aHJvdyBuZXcgRm9yYmlkZGVuRXhjZXB0aW9uKFxuICAgICAgICBgWW91IG5lZWQgJHtyZXF1aXJlZFJvbGV9IHJvbGUgb3IgaGlnaGVyIHRvIHBvc3QgaW4gdGhpcyByb29tYCxcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyB2YWxpZGF0ZUNvbW11bml0eU1vZGVyYXRvcihcbiAgICB1c2VySWQ6IHN0cmluZyxcbiAgICBjb21tdW5pdHlJZDogc3RyaW5nLFxuICApOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAvLyBDaGVjayBpZiB1c2VyIGlzIGEgZ2xvYmFsIGFkbWluXG4gICAgY29uc3QgdXNlciA9IGF3YWl0IHRoaXMucHJpc21hLnVzZXIuZmluZFVuaXF1ZSh7XG4gICAgICB3aGVyZTogeyBpZDogdXNlcklkIH0sXG4gICAgICBzZWxlY3Q6IHsgcm9sZTogdHJ1ZSB9LFxuICAgIH0pO1xuXG4gICAgaWYgKHVzZXI/LnJvbGUgPT09ICdhZG1pbicpIHtcbiAgICAgIHJldHVybjsgLy8gR2xvYmFsIGFkbWlucyBoYXZlIGFjY2VzcyB0byBhbGwgY29tbXVuaXRpZXNcbiAgICB9XG5cbiAgICAvLyBDaGVjayBpZiB1c2VyIGlzIGFzc2lnbmVkIGFzIGEgbW9kZXJhdG9yIGZvciB0aGlzIHNwZWNpZmljIGNvbW11bml0eVxuICAgIGNvbnN0IG1vZGVyYXRvckNvbW11bml0eSA9IGF3YWl0IHRoaXMucHJpc21hLm1vZGVyYXRvckNvbW11bml0eS5maW5kRmlyc3Qoe1xuICAgICAgd2hlcmU6IHtcbiAgICAgICAgbW9kZXJhdG9ySWQ6IHVzZXJJZCxcbiAgICAgICAgY29tbXVuaXR5SWQsXG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgaWYgKCFtb2RlcmF0b3JDb21tdW5pdHkpIHtcbiAgICAgIHRocm93IG5ldyBGb3JiaWRkZW5FeGNlcHRpb24oXG4gICAgICAgICdZb3UgbXVzdCBiZSBhIG1vZGVyYXRvciBvciBhZG1pbiBvZiB0aGlzIGNvbW11bml0eScsXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIC8vIEhlbHBlciBtZXRob2QgdG8gZ2V0IHVzZXIncyByb2xlIGluIGEgY29tbXVuaXR5XG4gIGFzeW5jIGdldFVzZXJDb21tdW5pdHlSb2xlKFxuICAgIHVzZXJJZDogc3RyaW5nLFxuICAgIGNvbW11bml0eUlkOiBzdHJpbmcsXG4gICk6IFByb21pc2U8c3RyaW5nIHwgbnVsbD4ge1xuICAgIC8vIENoZWNrIGlmIHVzZXIgaXMgYSBtZW1iZXIgb2YgdGhlIGNvbW11bml0eVxuICAgIGNvbnN0IG1lbWJlcnNoaXAgPSBhd2FpdCB0aGlzLnByaXNtYS5tZW1iZXJzaGlwLmZpbmRGaXJzdCh7XG4gICAgICB3aGVyZToge1xuICAgICAgICB1c2VySWQsXG4gICAgICAgIGNvbW11bml0eUlkLFxuICAgICAgfSxcbiAgICB9KTtcblxuICAgIGlmICghbWVtYmVyc2hpcCkge1xuICAgICAgcmV0dXJuIG51bGw7IC8vIFVzZXIgaXMgbm90IGEgbWVtYmVyXG4gICAgfVxuXG4gICAgLy8gR2V0IHVzZXIncyBnbG9iYWwgcm9sZVxuICAgIGNvbnN0IHVzZXIgPSBhd2FpdCB0aGlzLnByaXNtYS51c2VyLmZpbmRVbmlxdWUoe1xuICAgICAgd2hlcmU6IHsgaWQ6IHVzZXJJZCB9LFxuICAgICAgc2VsZWN0OiB7IHJvbGU6IHRydWUgfSxcbiAgICB9KTtcblxuICAgIC8vIENoZWNrIGlmIHVzZXIgaXMgYXNzaWduZWQgYXMgYSBtb2RlcmF0b3IgZm9yIHRoaXMgc3BlY2lmaWMgY29tbXVuaXR5XG4gICAgY29uc3QgbW9kZXJhdG9yQ29tbXVuaXR5ID0gYXdhaXQgdGhpcy5wcmlzbWEubW9kZXJhdG9yQ29tbXVuaXR5LmZpbmRGaXJzdCh7XG4gICAgICB3aGVyZToge1xuICAgICAgICBtb2RlcmF0b3JJZDogdXNlcklkLFxuICAgICAgICBjb21tdW5pdHlJZCxcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICAvLyBEZXRlcm1pbmUgZWZmZWN0aXZlIHJvbGUgaW4gdGhpcyBjb21tdW5pdHlcbiAgICBpZiAodXNlcj8ucm9sZSA9PT0gJ2FkbWluJykge1xuICAgICAgcmV0dXJuICdhZG1pbic7XG4gICAgfSBlbHNlIGlmIChtb2RlcmF0b3JDb21tdW5pdHkgfHwgdXNlcj8ucm9sZSA9PT0gJ21vZGVyYXRvcicpIHtcbiAgICAgIHJldHVybiAnbW9kZXJhdG9yJztcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuICdtZW1iZXInOyAvLyBEZWZhdWx0IHJvbGUgZm9yIGNvbW11bml0eSBtZW1iZXJzXG4gICAgfVxuICB9XG5cbiAgLy8gSGVscGVyIG1ldGhvZCB0byBjaGVjayBpZiB1c2VyIGNhbiBwZXJmb3JtIG1vZGVyYXRpb24gYWN0aW9uc1xuICBhc3luYyBjYW5Nb2RlcmF0ZSh1c2VySWQ6IHN0cmluZywgY29tbXVuaXR5SWQ6IHN0cmluZyk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCB0aGlzLnZhbGlkYXRlQ29tbXVuaXR5TW9kZXJhdG9yKHVzZXJJZCwgY29tbXVuaXR5SWQpO1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfSBjYXRjaCB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICB9XG59XG4iXSwidmVyc2lvbiI6M30=