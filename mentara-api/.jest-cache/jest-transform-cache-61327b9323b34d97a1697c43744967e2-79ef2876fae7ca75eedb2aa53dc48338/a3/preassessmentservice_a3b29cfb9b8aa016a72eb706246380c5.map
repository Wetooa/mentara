{"file":"/home/wetooa/Documents/code/projects/mentara/mentara-api/src/pre-assessment/pre-assessment.service.ts","mappings":"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","names":[],"sources":["/home/wetooa/Documents/code/projects/mentara/mentara-api/src/pre-assessment/pre-assessment.service.ts"],"sourcesContent":["import {\n  Injectable,\n  NotFoundException,\n  InternalServerErrorException,\n  BadRequestException,\n  Logger,\n} from '@nestjs/common';\nimport { PrismaService } from '../providers/prisma-client.provider';\nimport {\n  processPreAssessmentAnswers,\n  LIST_OF_QUESTIONNAIRES,\n} from './pre-assessment.utils';\nimport { PreAssessment } from '@prisma/client';\nimport { CreatePreAssessmentDto } from '../../schema/pre-assessment';\nimport { AiServiceClient } from './services/ai-service.client';\nimport { ClinicalInsightsService } from './analysis/clinical-insights.service';\nimport { TherapeuticRecommendationsService } from './analysis/therapeutic-recommendations.service';\nimport { QuestionnaireScores } from './pre-assessment.utils';\n\n@Injectable()\nexport class PreAssessmentService {\n  private readonly logger = new Logger(PreAssessmentService.name);\n\n  constructor(\n    private readonly prisma: PrismaService,\n    private readonly aiServiceClient: AiServiceClient,\n    private readonly clinicalInsightsService: ClinicalInsightsService,\n    private readonly therapeuticRecommendationsService: TherapeuticRecommendationsService,\n  ) {}\n\n  private async getAiEstimate(\n    answers: number[],\n  ): Promise<Record<string, boolean> | null> {\n    try {\n      this.logger.debug(\n        `Requesting AI prediction for ${answers.length} values`,\n      );\n\n      const result = await this.aiServiceClient.predict(answers);\n\n      if (!result.success) {\n        this.logger.warn(`AI prediction failed: ${result.error}`);\n        return null;\n      }\n\n      this.logger.log(\n        `AI prediction completed successfully in ${result.responseTime}ms`,\n      );\n      return result.predictions || null;\n    } catch (error) {\n      this.logger.error(\n        'AI model prediction error:',\n        error instanceof Error ? error.message : error,\n      );\n      return null;\n    }\n  }\n\n  private validateFlatAnswers(answers: number[]): void {\n    if (!Array.isArray(answers)) {\n      throw new BadRequestException('Answers must be an array');\n    }\n\n    if (answers.length !== 201) {\n      throw new BadRequestException(\n        `Expected exactly 201 answer values, got ${answers.length}`,\n      );\n    }\n\n    // Validate all values are numbers in reasonable range (0-10 for most scales)\n    for (let i = 0; i < answers.length; i++) {\n      const value = answers[i];\n\n      if (typeof value !== 'number' || !Number.isFinite(value)) {\n        throw new BadRequestException(\n          `Invalid answer value at index ${i}: ${value}. Must be a finite number.`,\n        );\n      }\n\n      if (value < 0 || value > 10) {\n        throw new BadRequestException(\n          `Answer value out of range (0-10) at index ${i}: ${value}`,\n        );\n      }\n    }\n\n    this.logger.debug('Flat answers array validation passed');\n  }\n\n  async createPreAssessment(\n    userId: string,\n    data: CreatePreAssessmentDto,\n  ): Promise<PreAssessment> {\n    try {\n      this.logger.log(`Creating pre-assessment for user ${userId}`);\n\n      // Validate user exists and is active\n      const user = await this.prisma.user.findUnique({\n        where: { id: userId, isActive: true },\n        select: { id: true, isActive: true },\n      });\n      if (!user) {\n        throw new NotFoundException('User not found or inactive');\n      }\n\n      // Validate client exists\n      const client = await this.prisma.client.findUnique({\n        where: { userId: userId },\n        select: { userId: true },\n      });\n      if (!client) {\n        throw new NotFoundException('Client profile not found');\n      }\n\n      // Check for existing pre-assessment\n      const existingAssessment = await this.prisma.preAssessment.findUnique({\n        where: { clientId: userId },\n      });\n      if (existingAssessment) {\n        throw new BadRequestException(\n          'Pre-assessment already exists for this user',\n        );\n      }\n\n      // Validate flat answers array\n      this.validateFlatAnswers(data.answers);\n\n      let scores: Record<string, number> = data.scores as Record<\n        string,\n        number\n      >;\n      let severityLevels: Record<string, string> =\n        data.severityLevels as Record<string, string>;\n\n      // Calculate scores if not provided\n      if (!data.scores || !data.severityLevels) {\n        this.logger.debug(\n          'Calculating scores and severity levels from flat answers',\n        );\n        const result = processPreAssessmentAnswers(data.answers);\n        scores = result.scores;\n        severityLevels = result.severityLevels;\n      }\n\n      // Attempt AI prediction with flat answers\n      let aiEstimate: Record<string, boolean> = {};\n      try {\n        this.logger.debug('Attempting AI prediction with validated input');\n        const aiResult = await this.getAiEstimate(data.answers);\n        if (aiResult) {\n          aiEstimate = aiResult;\n          this.logger.log('AI prediction successful');\n        } else {\n          this.logger.warn(\n            'AI prediction failed, continuing without AI estimate',\n          );\n        }\n      } catch (aiError) {\n        this.logger.error(\n          'AI prediction error, continuing without AI estimate:',\n          aiError,\n        );\n        // Continue without AI estimate - don't fail the entire assessment\n      }\n\n      // Create pre-assessment with validated data\n      const preAssessment = await this.prisma.preAssessment.create({\n        data: {\n          clientId: userId,\n          answers: data.answers, // Flat array of 201 numeric responses\n          scores, // Assessment scale scores\n          severityLevels, // Severity classifications\n          aiEstimate, // AI analysis results\n          isProcessed: true, // Mark as processed\n          processedAt: new Date(), // Set processing timestamp\n        },\n      });\n\n      this.logger.log(`Pre-assessment completed for user ${userId}`);\n\n      // Generate comprehensive clinical analysis in background\n      // This provides detailed insights for therapist matching and treatment planning\n      try {\n        // Convert scores to QuestionnaireScores format for analysis\n        const questionnaireScores: QuestionnaireScores = {};\n        const severityLevelsForAnalysis = severityLevels;\n\n        // Get all questionnaire names from the calculated scores\n        const questionnaires = Object.keys(scores);\n        questionnaires.forEach((questionnaire) => {\n          if (scores[questionnaire] !== undefined) {\n            questionnaireScores[questionnaire] = {\n              score: scores[questionnaire],\n              severity: severityLevelsForAnalysis[questionnaire] || 'Unknown',\n            };\n          }\n        });\n\n        const analysis = await this.generateClinicalAnalysis(\n          preAssessment,\n          questionnaires,\n          questionnaireScores,\n        );\n\n        this.logger.log(\n          `Clinical analysis generated: ${analysis.clinicalProfile.primaryConditions.length} primary conditions, ` +\n            `risk level: ${analysis.clinicalProfile.overallRiskLevel}`,\n        );\n      } catch (analysisError) {\n        this.logger.warn(\n          'Advanced clinical analysis failed but core assessment succeeded:',\n          analysisError instanceof Error\n            ? analysisError.message\n            : analysisError,\n        );\n        // Don't fail the entire process - basic scoring is still available\n      }\n\n      return preAssessment;\n    } catch (error) {\n      if (\n        error instanceof NotFoundException ||\n        error instanceof BadRequestException\n      ) {\n        throw error;\n      }\n\n      this.logger.error(\n        'Error creating pre-assessment:',\n        error instanceof Error ? error.message : error,\n      );\n      throw new InternalServerErrorException('Failed to create pre-assessment');\n    }\n  }\n\n  private handleError(error: unknown, message: string): never {\n    if (error instanceof NotFoundException) {\n      throw error;\n    }\n    if (error instanceof Error) {\n      console.error(message, error.message);\n      throw new InternalServerErrorException(error.message);\n    }\n    console.error(message, error);\n    throw new InternalServerErrorException(message);\n  }\n\n  async getPreAssessmentByUserId(userId: string): Promise<PreAssessment> {\n    try {\n      const preAssessment = await this.prisma.preAssessment.findUnique({\n        where: { clientId: userId },\n      });\n\n      if (!preAssessment) {\n        throw new NotFoundException('Pre-assessment not found');\n      }\n\n      return preAssessment;\n    } catch (error: unknown) {\n      this.handleError(error, 'Error retrieving pre-assessment');\n    }\n  }\n\n  async getPreAssessmentByClientId(clientId: string): Promise<PreAssessment> {\n    try {\n      const preAssessment = await this.prisma.preAssessment.findUnique({\n        where: { clientId: clientId },\n        include: { client: { include: { user: true } } },\n      });\n\n      if (!preAssessment) {\n        throw new NotFoundException('Pre-assessment not found');\n      }\n\n      return preAssessment;\n    } catch (error: unknown) {\n      this.handleError(error, 'Error retrieving pre-assessment');\n    }\n  }\n\n  private isValidScores(scores: unknown): scores is Record<string, number> {\n    if (typeof scores !== 'object' || scores === null) return false;\n    return Object.entries(scores).every(\n      ([key, value]) => typeof key === 'string' && typeof value === 'number',\n    );\n  }\n\n  private isValidSeverityLevels(\n    levels: unknown,\n  ): levels is Record<string, string> {\n    if (typeof levels !== 'object' || levels === null) return false;\n    return Object.entries(levels).every(\n      ([key, value]) => typeof key === 'string' && typeof value === 'string',\n    );\n  }\n\n  async updatePreAssessment(\n    userId: string,\n    data: Partial<CreatePreAssessmentDto>,\n  ): Promise<PreAssessment> {\n    try {\n      const client = await this.prisma.client.findUnique({\n        where: { userId: userId },\n      });\n      if (!client) {\n        throw new NotFoundException('Client not found');\n      }\n\n      // Get existing pre-assessment to preserve current data\n      const existingAssessment = await this.prisma.preAssessment.findUnique({\n        where: { clientId: userId },\n      });\n\n      if (!existingAssessment) {\n        throw new NotFoundException('Pre-assessment not found');\n      }\n\n      // Extract current data from existing assessment\n      const currentScores =\n        (existingAssessment.scores as Record<string, number>) || {};\n      const currentSeverityLevels =\n        (existingAssessment.severityLevels as Record<string, string>) || {};\n      const currentAiEstimate =\n        (existingAssessment.aiEstimate as Record<string, boolean>) || {};\n\n      let scores: Record<string, number>;\n      let severityLevels: Record<string, string>;\n      let aiEstimate: Record<string, boolean> = currentAiEstimate;\n\n      if (data.scores && this.isValidScores(data.scores)) {\n        scores = data.scores;\n      } else {\n        scores = currentScores;\n      }\n\n      if (\n        data.severityLevels &&\n        this.isValidSeverityLevels(data.severityLevels)\n      ) {\n        severityLevels = data.severityLevels;\n      } else {\n        severityLevels = currentSeverityLevels;\n      }\n\n      // Recalculate scores if new answers provided\n      if (data.answers && (!data.scores || !data.severityLevels)) {\n        this.validateFlatAnswers(data.answers);\n\n        const result = processPreAssessmentAnswers(data.answers);\n        scores = result.scores;\n        severityLevels = result.severityLevels;\n\n        // Attempt to get new AI estimate if answers changed\n        try {\n          const aiResult = await this.getAiEstimate(data.answers);\n          if (aiResult) {\n            aiEstimate = aiResult;\n          }\n        } catch (aiError) {\n          this.logger.warn('AI prediction failed during update:', aiError);\n        }\n      }\n\n      // Update pre-assessment with new data\n      const preAssessment = await this.prisma.preAssessment.update({\n        where: { clientId: userId },\n        data: {\n          answers: data.answers || (existingAssessment.answers as number[]),\n          scores,\n          severityLevels,\n          aiEstimate,\n        },\n      });\n\n      return preAssessment;\n    } catch (error: unknown) {\n      this.handleError(error, 'Error updating pre-assessment');\n    }\n  }\n\n  async deletePreAssessment(userId: string): Promise<null> {\n    try {\n      await this.prisma.preAssessment.delete({\n        where: { clientId: userId },\n      });\n      return null;\n    } catch (error: unknown) {\n      this.handleError(error, 'Error deleting pre-assessment');\n    }\n  }\n\n  /**\n   * Generate comprehensive clinical analysis from pre-assessment data\n   * This method orchestrates the clinical insights and therapeutic recommendations\n   */\n  async generateClinicalAnalysis(\n    preAssessment: PreAssessment,\n    questionnaires: string[],\n    scores: QuestionnaireScores,\n  ) {\n    try {\n      this.logger.log('Generating comprehensive clinical analysis');\n\n      // Generate clinical profile with insights\n      const clinicalProfile =\n        await this.clinicalInsightsService.generateClinicalProfile(\n          preAssessment,\n          questionnaires,\n          scores,\n        );\n\n      // Generate personalized treatment plan\n      const treatmentPlan =\n        await this.therapeuticRecommendationsService.generatePersonalizedTreatmentPlan(\n          clinicalProfile,\n        );\n\n      // Extract risk assessment\n      const riskAssessment = {\n        overallRisk: clinicalProfile.overallRiskLevel,\n        riskFactors: clinicalProfile.riskFactors,\n        immediateInterventionNeeded:\n          clinicalProfile.overallRiskLevel === 'critical',\n        crisisRisk: clinicalProfile.riskFactors.some(\n          (rf) => rf.type === 'suicide' && rf.level === 'critical',\n        ),\n      };\n\n      return {\n        clinicalProfile,\n        treatmentPlan,\n        riskAssessment,\n        analysisTimestamp: new Date().toISOString(),\n      };\n    } catch (error) {\n      this.logger.error('Error generating clinical analysis:', error);\n      throw new InternalServerErrorException(\n        'Failed to generate clinical analysis',\n      );\n    }\n  }\n\n  /**\n   * Get comprehensive clinical analysis for a user\n   * Returns cached analysis if available, otherwise generates new one\n   */\n  async getComprehensiveClinicalAnalysis(userId: string) {\n    try {\n      // Get user's pre-assessment\n      const preAssessment = await this.getPreAssessmentByUserId(userId);\n\n      if (!preAssessment) {\n        throw new NotFoundException('Pre-assessment not found for user');\n      }\n\n      // Extract data from the separate database fields (correct approach)\n      const flatAnswers = preAssessment.answers as number[];\n      const scores = preAssessment.scores as Record<string, number>;\n      const severityLevels = preAssessment.severityLevels as Record<string, string>;\n      \n      // Use the questionnaire list from utils\n      const questionnaires = [...LIST_OF_QUESTIONNAIRES] as string[];\n\n      if (!flatAnswers || !scores || !severityLevels) {\n        throw new BadRequestException('Invalid pre-assessment data structure');\n      }\n\n      // Convert scores to QuestionnaireScores format\n      const questionnaireScores: QuestionnaireScores = {};\n      \n      questionnaires.forEach((questionnaire) => {\n        if (scores[questionnaire] !== undefined) {\n          questionnaireScores[questionnaire] = {\n            score: scores[questionnaire],\n            severity: severityLevels[questionnaire] || 'Unknown',\n          };\n        }\n      });\n\n      // Generate comprehensive analysis\n      return await this.generateClinicalAnalysis(\n        preAssessment,\n        questionnaires,\n        questionnaireScores,\n      );\n    } catch (error) {\n      this.logger.error(\n        `Error getting clinical analysis for user ${userId}:`,\n        error,\n      );\n      throw error;\n    }\n  }\n\n  /**\n   * Get crisis assessment for a user\n   * Returns immediate risk factors and intervention needs\n   */\n  async getCrisisAssessment(userId: string) {\n    try {\n      const analysis = await this.getComprehensiveClinicalAnalysis(userId);\n\n      return {\n        overallRisk: analysis.riskAssessment.overallRisk,\n        immediateInterventionNeeded:\n          analysis.riskAssessment.immediateInterventionNeeded,\n        crisisRisk: analysis.riskAssessment.crisisRisk,\n        riskFactors: analysis.riskAssessment.riskFactors,\n        primaryConcerns: analysis.clinicalProfile.primaryConditions.map(\n          (pc) => ({\n            condition: pc.condition,\n            riskLevel: pc.riskLevel,\n            priority: pc.priority,\n          }),\n        ),\n        emergencyContacts:\n          analysis.treatmentPlan.contingencyPlan.crisisContacts,\n        safetyPlan: analysis.treatmentPlan.contingencyPlan.emergencySteps,\n      };\n    } catch (error) {\n      this.logger.error(\n        `Error getting crisis assessment for user ${userId}:`,\n        error,\n      );\n      throw error;\n    }\n  }\n}\n"],"version":3}