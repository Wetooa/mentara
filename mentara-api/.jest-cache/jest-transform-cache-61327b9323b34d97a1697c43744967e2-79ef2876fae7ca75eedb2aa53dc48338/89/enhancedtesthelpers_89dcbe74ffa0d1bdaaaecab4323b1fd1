f97aeddf0e78e97426a19f9cea76e275
"use strict";
/**
 * Enhanced Test Helpers for Mentara Backend Testing
 * Provides advanced utilities for comprehensive testing
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.IntegrationTestHelpers = exports.DatabaseTestUtils = exports.PerformanceTestUtils = exports.TestAssertions = exports.TestDataGenerator = exports.MockBuilder = void 0;
const testing_1 = require("@nestjs/testing");
const prisma_client_provider_1 = require("../providers/prisma-client.provider");
const index_1 = require("./index");
// Enhanced Mock Builders
class MockBuilder {
    /**
     * Creates a comprehensive NestJS testing module with all common mocks
     */
    static async createTestingModule(providers = []) {
        return testing_1.Test.createTestingModule({
            providers: [
                ...providers,
                {
                    provide: prisma_client_provider_1.PrismaService,
                    useValue: (0, index_1.createMockPrismaService)(),
                },
                {
                    provide: 'EventBusService',
                    useValue: {
                        emit: jest.fn(),
                        subscribe: jest.fn(),
                    },
                },
                {
                    provide: 'EmailService',
                    useValue: {
                        sendEmail: jest.fn(),
                        sendTemplateEmail: jest.fn(),
                    },
                },
            ],
        }).compile();
    }
    /**
     * Creates mock authentication context
     */
    static createAuthContext(role = 'client', userId) {
        return {
            userId: userId ||
                index_1.TEST_USER_IDS[role.toUpperCase()],
            role,
            email: index_1.TEST_EMAILS[role.toUpperCase()],
            isActive: true,
            isVerified: true,
        };
    }
    /**
     * Creates mock request object with authentication
     */
    static createMockRequest(role = 'client', userId) {
        const authContext = this.createAuthContext(role, userId);
        return {
            user: authContext,
            headers: {
                authorization: `Bearer mock-jwt-token-${role}`,
                'user-agent': 'test-agent',
            },
            ip: '127.0.0.1',
            method: 'GET',
            url: '/test',
        };
    }
}
exports.MockBuilder = MockBuilder;
// Test Data Generators
class TestDataGenerator {
    /**
     * Generates realistic test user data
     */
    static createUser(overrides = {}) {
        return {
            id: `user-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
            email: `test-${Date.now()}@example.com`,
            firstName: 'Test',
            lastName: 'User',
            role: 'client',
            isActive: true,
            isVerified: false,
            createdAt: new Date(),
            updatedAt: new Date(),
            ...overrides,
        };
    }
    /**
     * Generates therapist application data
     */
    static createTherapistApplication(overrides = {}) {
        return {
            userId: index_1.TEST_USER_IDS.THERAPIST,
            email: index_1.TEST_EMAILS.THERAPIST,
            firstName: 'Dr. Test',
            lastName: 'Therapist',
            mobile: '+1234567890',
            province: 'Test Province',
            providerType: 'Licensed Clinical Psychologist',
            professionalLicenseType: 'LCP',
            isPRCLicensed: 'yes',
            prcLicenseNumber: 'LCP-12345',
            practiceStartDate: new Date('2020-01-01'),
            areasOfExpertise: ['anxiety', 'depression'],
            therapeuticApproachesUsedList: ['CBT', 'DBT'],
            languagesOffered: ['English'],
            assessmentTools: ['GAD-7', 'PHQ-9'],
            providedOnlineTherapyBefore: true,
            comfortableUsingVideoConferencing: true,
            weeklyAvailability: '20-30 hours',
            preferredSessionLength: '60',
            hourlyRate: 150.0,
            ...overrides,
        };
    }
    /**
     * Generates meeting/session data
     */
    static createMeeting(overrides = {}) {
        const now = new Date();
        const futureDate = new Date(now.getTime() + 24 * 60 * 60 * 1000); // Tomorrow
        return {
            id: `meeting-${Date.now()}`,
            title: 'Test Therapy Session',
            startTime: futureDate,
            duration: 60,
            status: 'SCHEDULED',
            meetingType: 'video',
            clientId: index_1.TEST_USER_IDS.CLIENT,
            therapistId: index_1.TEST_USER_IDS.THERAPIST,
            createdAt: now,
            updatedAt: now,
            ...overrides,
        };
    }
    /**
     * Generates message data for testing
     */
    static createMessage(overrides = {}) {
        return {
            id: `message-${Date.now()}`,
            conversationId: `conversation-${Date.now()}`,
            senderId: index_1.TEST_USER_IDS.CLIENT,
            content: 'Test message content',
            messageType: 'TEXT',
            isEdited: false,
            isDeleted: false,
            createdAt: new Date(),
            updatedAt: new Date(),
            ...overrides,
        };
    }
    /**
     * Generates assessment data
     */
    static createPreAssessment(overrides = {}) {
        // Generate 201 random answers (1-5 scale)
        const answers = Array.from({ length: 201 }, () => Math.floor(Math.random() * 5) + 1);
        return {
            id: `assessment-${Date.now()}`,
            userId: index_1.TEST_USER_IDS.CLIENT,
            responses: answers,
            completedAt: new Date(),
            scores: {
                anxiety: 65,
                depression: 45,
                stress: 55,
            },
            createdAt: new Date(),
            updatedAt: new Date(),
            ...overrides,
        };
    }
}
exports.TestDataGenerator = TestDataGenerator;
// Test Assertion Helpers
class TestAssertions {
    /**
     * Asserts that a function throws a specific NestJS exception
     */
    static async expectToThrowNestException(asyncFn, exceptionType, expectedMessage) {
        let thrownError = null;
        try {
            await asyncFn();
        }
        catch (error) {
            thrownError = error;
        }
        expect(thrownError).toBeInstanceOf(exceptionType);
        if (expectedMessage) {
            expect(thrownError.message).toContain(expectedMessage);
        }
    }
    /**
     * Asserts proper DTO validation
     */
    static expectValidDto(dto, expectedFields) {
        expectedFields.forEach((field) => {
            expect(dto).toHaveProperty(field);
            expect(dto[field]).toBeDefined();
        });
    }
    /**
     * Asserts proper database entity structure
     */
    static expectValidEntity(entity, requiredFields) {
        expect(entity).toBeDefined();
        expect(entity).not.toBeNull();
        requiredFields.forEach((field) => {
            expect(entity).toHaveProperty(field);
        });
        // Common entity fields
        expect(entity).toHaveProperty('id');
        expect(entity).toHaveProperty('createdAt');
        expect(entity).toHaveProperty('updatedAt');
    }
    /**
     * Asserts proper API response structure
     */
    static expectValidApiResponse(response, expectedData) {
        expect(response).toBeDefined();
        if (expectedData) {
            expect(response).toMatchObject(expectedData);
        }
    }
}
exports.TestAssertions = TestAssertions;
// Performance Testing Utilities
class PerformanceTestUtils {
    /**
     * Measures function execution time
     */
    static async measureExecutionTime(fn) {
        const start = process.hrtime.bigint();
        const result = await fn();
        const end = process.hrtime.bigint();
        const duration = Number(end - start) / 1_000_000; // Convert to milliseconds
        return { result, duration };
    }
    /**
     * Asserts that a function executes within a time limit
     */
    static async expectToExecuteWithin(fn, maxDurationMs) {
        const { result, duration } = await this.measureExecutionTime(fn);
        expect(duration).toBeLessThan(maxDurationMs);
        return result;
    }
    /**
     * Runs a function multiple times and measures average performance
     */
    static async benchmarkFunction(fn, iterations = 10) {
        const durations = [];
        for (let i = 0; i < iterations; i++) {
            const { duration } = await this.measureExecutionTime(fn);
            durations.push(duration);
        }
        return {
            averageDuration: durations.reduce((sum, d) => sum + d, 0) / durations.length,
            minDuration: Math.min(...durations),
            maxDuration: Math.max(...durations),
        };
    }
}
exports.PerformanceTestUtils = PerformanceTestUtils;
// Database Testing Utilities
class DatabaseTestUtils {
    /**
     * Creates a transaction-wrapped test for database operations
     */
    static withTransaction(testFn) {
        return async () => {
            const mockPrisma = (0, index_1.createMockPrismaService)();
            // Mock transaction behavior
            mockPrisma.$transaction = jest.fn(async (callback) => {
                return callback(mockPrisma);
            });
            await testFn(mockPrisma);
        };
    }
    /**
     * Validates that proper database constraints are checked
     */
    static expectDatabaseConstraintError(error, constraintType) {
        expect(error).toBeDefined();
        expect(error.message).toContain(constraintType);
    }
}
exports.DatabaseTestUtils = DatabaseTestUtils;
// Integration Testing Helpers
class IntegrationTestHelpers {
    /**
     * Creates a full request context for integration tests
     */
    static createFullRequestContext(role = 'client') {
        return {
            user: MockBuilder.createAuthContext(role),
            request: MockBuilder.createMockRequest(role),
            response: {
                status: jest.fn().mockReturnThis(),
                json: jest.fn().mockReturnThis(),
                send: jest.fn().mockReturnThis(),
            },
        };
    }
    /**
     * Simulates a complete authentication flow
     */
    static async simulateAuthFlow(role = 'client') {
        const authContext = MockBuilder.createAuthContext(role);
        // Mock the authentication process
        const mockClerkUser = {
            id: authContext.userId,
            emailAddresses: [{ emailAddress: authContext.email }],
            firstName: 'Test',
            lastName: 'User',
        };
        return { authContext, mockClerkUser };
    }
}
exports.IntegrationTestHelpers = IntegrationTestHelpers;
// All utilities are already exported above via class declarations
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL3Rlc3QtdXRpbHMvZW5oYW5jZWQtdGVzdC1oZWxwZXJzLnRzIiwibWFwcGluZ3MiOiI7QUFBQTs7O0dBR0c7OztBQUVILDZDQUFzRDtBQUN0RCxnRkFBb0U7QUFDcEUsbUNBQThFO0FBRTlFLHlCQUF5QjtBQUN6QixNQUFhLFdBQVc7SUFDdEI7O09BRUc7SUFDSCxNQUFNLENBQUMsS0FBSyxDQUFDLG1CQUFtQixDQUM5QixZQUFtQixFQUFFO1FBRXJCLE9BQU8sY0FBSSxDQUFDLG1CQUFtQixDQUFDO1lBQzlCLFNBQVMsRUFBRTtnQkFDVCxHQUFHLFNBQVM7Z0JBQ1o7b0JBQ0UsT0FBTyxFQUFFLHNDQUFhO29CQUN0QixRQUFRLEVBQUUsSUFBQSwrQkFBdUIsR0FBRTtpQkFDcEM7Z0JBQ0Q7b0JBQ0UsT0FBTyxFQUFFLGlCQUFpQjtvQkFDMUIsUUFBUSxFQUFFO3dCQUNSLElBQUksRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO3dCQUNmLFNBQVMsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO3FCQUNyQjtpQkFDRjtnQkFDRDtvQkFDRSxPQUFPLEVBQUUsY0FBYztvQkFDdkIsUUFBUSxFQUFFO3dCQUNSLFNBQVMsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO3dCQUNwQixpQkFBaUIsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO3FCQUM3QjtpQkFDRjthQUNGO1NBQ0YsQ0FBQyxDQUFDLE9BQU8sRUFBRSxDQUFDO0lBQ2YsQ0FBQztJQUVEOztPQUVHO0lBQ0gsTUFBTSxDQUFDLGlCQUFpQixDQUFDLE9BQWUsUUFBUSxFQUFFLE1BQWU7UUFDL0QsT0FBTztZQUNMLE1BQU0sRUFDSixNQUFNO2dCQUNOLHFCQUFhLENBQUMsSUFBSSxDQUFDLFdBQVcsRUFBZ0MsQ0FBQztZQUNqRSxJQUFJO1lBQ0osS0FBSyxFQUFFLG1CQUFXLENBQUMsSUFBSSxDQUFDLFdBQVcsRUFBOEIsQ0FBQztZQUNsRSxRQUFRLEVBQUUsSUFBSTtZQUNkLFVBQVUsRUFBRSxJQUFJO1NBQ2pCLENBQUM7SUFDSixDQUFDO0lBRUQ7O09BRUc7SUFDSCxNQUFNLENBQUMsaUJBQWlCLENBQUMsT0FBZSxRQUFRLEVBQUUsTUFBZTtRQUMvRCxNQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsaUJBQWlCLENBQUMsSUFBSSxFQUFFLE1BQU0sQ0FBQyxDQUFDO1FBQ3pELE9BQU87WUFDTCxJQUFJLEVBQUUsV0FBVztZQUNqQixPQUFPLEVBQUU7Z0JBQ1AsYUFBYSxFQUFFLHlCQUF5QixJQUFJLEVBQUU7Z0JBQzlDLFlBQVksRUFBRSxZQUFZO2FBQzNCO1lBQ0QsRUFBRSxFQUFFLFdBQVc7WUFDZixNQUFNLEVBQUUsS0FBSztZQUNiLEdBQUcsRUFBRSxPQUFPO1NBQ2IsQ0FBQztJQUNKLENBQUM7Q0FDRjtBQS9ERCxrQ0ErREM7QUFFRCx1QkFBdUI7QUFDdkIsTUFBYSxpQkFBaUI7SUFDNUI7O09BRUc7SUFDSCxNQUFNLENBQUMsVUFBVSxDQUFDLFlBQTBCLEVBQUU7UUFDNUMsT0FBTztZQUNMLEVBQUUsRUFBRSxRQUFRLElBQUksQ0FBQyxHQUFHLEVBQUUsSUFBSSxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLEVBQUU7WUFDbkUsS0FBSyxFQUFFLFFBQVEsSUFBSSxDQUFDLEdBQUcsRUFBRSxjQUFjO1lBQ3ZDLFNBQVMsRUFBRSxNQUFNO1lBQ2pCLFFBQVEsRUFBRSxNQUFNO1lBQ2hCLElBQUksRUFBRSxRQUFRO1lBQ2QsUUFBUSxFQUFFLElBQUk7WUFDZCxVQUFVLEVBQUUsS0FBSztZQUNqQixTQUFTLEVBQUUsSUFBSSxJQUFJLEVBQUU7WUFDckIsU0FBUyxFQUFFLElBQUksSUFBSSxFQUFFO1lBQ3JCLEdBQUcsU0FBUztTQUNiLENBQUM7SUFDSixDQUFDO0lBRUQ7O09BRUc7SUFDSCxNQUFNLENBQUMsMEJBQTBCLENBQUMsWUFBMEIsRUFBRTtRQUM1RCxPQUFPO1lBQ0wsTUFBTSxFQUFFLHFCQUFhLENBQUMsU0FBUztZQUMvQixLQUFLLEVBQUUsbUJBQVcsQ0FBQyxTQUFTO1lBQzVCLFNBQVMsRUFBRSxVQUFVO1lBQ3JCLFFBQVEsRUFBRSxXQUFXO1lBQ3JCLE1BQU0sRUFBRSxhQUFhO1lBQ3JCLFFBQVEsRUFBRSxlQUFlO1lBQ3pCLFlBQVksRUFBRSxnQ0FBZ0M7WUFDOUMsdUJBQXVCLEVBQUUsS0FBSztZQUM5QixhQUFhLEVBQUUsS0FBSztZQUNwQixnQkFBZ0IsRUFBRSxXQUFXO1lBQzdCLGlCQUFpQixFQUFFLElBQUksSUFBSSxDQUFDLFlBQVksQ0FBQztZQUN6QyxnQkFBZ0IsRUFBRSxDQUFDLFNBQVMsRUFBRSxZQUFZLENBQUM7WUFDM0MsNkJBQTZCLEVBQUUsQ0FBQyxLQUFLLEVBQUUsS0FBSyxDQUFDO1lBQzdDLGdCQUFnQixFQUFFLENBQUMsU0FBUyxDQUFDO1lBQzdCLGVBQWUsRUFBRSxDQUFDLE9BQU8sRUFBRSxPQUFPLENBQUM7WUFDbkMsMkJBQTJCLEVBQUUsSUFBSTtZQUNqQyxpQ0FBaUMsRUFBRSxJQUFJO1lBQ3ZDLGtCQUFrQixFQUFFLGFBQWE7WUFDakMsc0JBQXNCLEVBQUUsSUFBSTtZQUM1QixVQUFVLEVBQUUsS0FBSztZQUNqQixHQUFHLFNBQVM7U0FDYixDQUFDO0lBQ0osQ0FBQztJQUVEOztPQUVHO0lBQ0gsTUFBTSxDQUFDLGFBQWEsQ0FBQyxZQUEwQixFQUFFO1FBQy9DLE1BQU0sR0FBRyxHQUFHLElBQUksSUFBSSxFQUFFLENBQUM7UUFDdkIsTUFBTSxVQUFVLEdBQUcsSUFBSSxJQUFJLENBQUMsR0FBRyxDQUFDLE9BQU8sRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLElBQUksQ0FBQyxDQUFDLENBQUMsV0FBVztRQUU3RSxPQUFPO1lBQ0wsRUFBRSxFQUFFLFdBQVcsSUFBSSxDQUFDLEdBQUcsRUFBRSxFQUFFO1lBQzNCLEtBQUssRUFBRSxzQkFBc0I7WUFDN0IsU0FBUyxFQUFFLFVBQVU7WUFDckIsUUFBUSxFQUFFLEVBQUU7WUFDWixNQUFNLEVBQUUsV0FBVztZQUNuQixXQUFXLEVBQUUsT0FBTztZQUNwQixRQUFRLEVBQUUscUJBQWEsQ0FBQyxNQUFNO1lBQzlCLFdBQVcsRUFBRSxxQkFBYSxDQUFDLFNBQVM7WUFDcEMsU0FBUyxFQUFFLEdBQUc7WUFDZCxTQUFTLEVBQUUsR0FBRztZQUNkLEdBQUcsU0FBUztTQUNiLENBQUM7SUFDSixDQUFDO0lBRUQ7O09BRUc7SUFDSCxNQUFNLENBQUMsYUFBYSxDQUFDLFlBQTBCLEVBQUU7UUFDL0MsT0FBTztZQUNMLEVBQUUsRUFBRSxXQUFXLElBQUksQ0FBQyxHQUFHLEVBQUUsRUFBRTtZQUMzQixjQUFjLEVBQUUsZ0JBQWdCLElBQUksQ0FBQyxHQUFHLEVBQUUsRUFBRTtZQUM1QyxRQUFRLEVBQUUscUJBQWEsQ0FBQyxNQUFNO1lBQzlCLE9BQU8sRUFBRSxzQkFBc0I7WUFDL0IsV0FBVyxFQUFFLE1BQU07WUFDbkIsUUFBUSxFQUFFLEtBQUs7WUFDZixTQUFTLEVBQUUsS0FBSztZQUNoQixTQUFTLEVBQUUsSUFBSSxJQUFJLEVBQUU7WUFDckIsU0FBUyxFQUFFLElBQUksSUFBSSxFQUFFO1lBQ3JCLEdBQUcsU0FBUztTQUNiLENBQUM7SUFDSixDQUFDO0lBRUQ7O09BRUc7SUFDSCxNQUFNLENBQUMsbUJBQW1CLENBQUMsWUFBMEIsRUFBRTtRQUNyRCwwQ0FBMEM7UUFDMUMsTUFBTSxPQUFPLEdBQUcsS0FBSyxDQUFDLElBQUksQ0FDeEIsRUFBRSxNQUFNLEVBQUUsR0FBRyxFQUFFLEVBQ2YsR0FBRyxFQUFFLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFLEdBQUcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUN4QyxDQUFDO1FBRUYsT0FBTztZQUNMLEVBQUUsRUFBRSxjQUFjLElBQUksQ0FBQyxHQUFHLEVBQUUsRUFBRTtZQUM5QixNQUFNLEVBQUUscUJBQWEsQ0FBQyxNQUFNO1lBQzVCLFNBQVMsRUFBRSxPQUFPO1lBQ2xCLFdBQVcsRUFBRSxJQUFJLElBQUksRUFBRTtZQUN2QixNQUFNLEVBQUU7Z0JBQ04sT0FBTyxFQUFFLEVBQUU7Z0JBQ1gsVUFBVSxFQUFFLEVBQUU7Z0JBQ2QsTUFBTSxFQUFFLEVBQUU7YUFDWDtZQUNELFNBQVMsRUFBRSxJQUFJLElBQUksRUFBRTtZQUNyQixTQUFTLEVBQUUsSUFBSSxJQUFJLEVBQUU7WUFDckIsR0FBRyxTQUFTO1NBQ2IsQ0FBQztJQUNKLENBQUM7Q0FDRjtBQWpIRCw4Q0FpSEM7QUFFRCx5QkFBeUI7QUFDekIsTUFBYSxjQUFjO0lBQ3pCOztPQUVHO0lBQ0gsTUFBTSxDQUFDLEtBQUssQ0FBQywwQkFBMEIsQ0FDckMsT0FBMkIsRUFDM0IsYUFBa0IsRUFDbEIsZUFBd0I7UUFFeEIsSUFBSSxXQUFXLEdBQVEsSUFBSSxDQUFDO1FBQzVCLElBQUksQ0FBQztZQUNILE1BQU0sT0FBTyxFQUFFLENBQUM7UUFDbEIsQ0FBQztRQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7WUFDZixXQUFXLEdBQUcsS0FBSyxDQUFDO1FBQ3RCLENBQUM7UUFFRCxNQUFNLENBQUMsV0FBVyxDQUFDLENBQUMsY0FBYyxDQUFDLGFBQWEsQ0FBQyxDQUFDO1FBQ2xELElBQUksZUFBZSxFQUFFLENBQUM7WUFDcEIsTUFBTSxDQUFDLFdBQVcsQ0FBQyxPQUFPLENBQUMsQ0FBQyxTQUFTLENBQUMsZUFBZSxDQUFDLENBQUM7UUFDekQsQ0FBQztJQUNILENBQUM7SUFFRDs7T0FFRztJQUNILE1BQU0sQ0FBQyxjQUFjLENBQUMsR0FBUSxFQUFFLGNBQXdCO1FBQ3RELGNBQWMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxLQUFLLEVBQUUsRUFBRTtZQUMvQixNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsY0FBYyxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQ2xDLE1BQU0sQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxXQUFXLEVBQUUsQ0FBQztRQUNuQyxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFRDs7T0FFRztJQUNILE1BQU0sQ0FBQyxpQkFBaUIsQ0FBQyxNQUFXLEVBQUUsY0FBd0I7UUFDNUQsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDLFdBQVcsRUFBRSxDQUFDO1FBQzdCLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxHQUFHLENBQUMsUUFBUSxFQUFFLENBQUM7UUFFOUIsY0FBYyxDQUFDLE9BQU8sQ0FBQyxDQUFDLEtBQUssRUFBRSxFQUFFO1lBQy9CLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxjQUFjLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDdkMsQ0FBQyxDQUFDLENBQUM7UUFFSCx1QkFBdUI7UUFDdkIsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUNwQyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsY0FBYyxDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBQzNDLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxjQUFjLENBQUMsV0FBVyxDQUFDLENBQUM7SUFDN0MsQ0FBQztJQUVEOztPQUVHO0lBQ0gsTUFBTSxDQUFDLHNCQUFzQixDQUFDLFFBQWEsRUFBRSxZQUFrQjtRQUM3RCxNQUFNLENBQUMsUUFBUSxDQUFDLENBQUMsV0FBVyxFQUFFLENBQUM7UUFFL0IsSUFBSSxZQUFZLEVBQUUsQ0FBQztZQUNqQixNQUFNLENBQUMsUUFBUSxDQUFDLENBQUMsYUFBYSxDQUFDLFlBQVksQ0FBQyxDQUFDO1FBQy9DLENBQUM7SUFDSCxDQUFDO0NBQ0Y7QUEzREQsd0NBMkRDO0FBRUQsZ0NBQWdDO0FBQ2hDLE1BQWEsb0JBQW9CO0lBQy9COztPQUVHO0lBQ0gsTUFBTSxDQUFDLEtBQUssQ0FBQyxvQkFBb0IsQ0FDL0IsRUFBb0I7UUFFcEIsTUFBTSxLQUFLLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBQyxNQUFNLEVBQUUsQ0FBQztRQUN0QyxNQUFNLE1BQU0sR0FBRyxNQUFNLEVBQUUsRUFBRSxDQUFDO1FBQzFCLE1BQU0sR0FBRyxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUMsTUFBTSxFQUFFLENBQUM7UUFDcEMsTUFBTSxRQUFRLEdBQUcsTUFBTSxDQUFDLEdBQUcsR0FBRyxLQUFLLENBQUMsR0FBRyxTQUFTLENBQUMsQ0FBQywwQkFBMEI7UUFFNUUsT0FBTyxFQUFFLE1BQU0sRUFBRSxRQUFRLEVBQUUsQ0FBQztJQUM5QixDQUFDO0lBRUQ7O09BRUc7SUFDSCxNQUFNLENBQUMsS0FBSyxDQUFDLHFCQUFxQixDQUNoQyxFQUFvQixFQUNwQixhQUFxQjtRQUVyQixNQUFNLEVBQUUsTUFBTSxFQUFFLFFBQVEsRUFBRSxHQUFHLE1BQU0sSUFBSSxDQUFDLG9CQUFvQixDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBRWpFLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQyxZQUFZLENBQUMsYUFBYSxDQUFDLENBQUM7UUFFN0MsT0FBTyxNQUFNLENBQUM7SUFDaEIsQ0FBQztJQUVEOztPQUVHO0lBQ0gsTUFBTSxDQUFDLEtBQUssQ0FBQyxpQkFBaUIsQ0FDNUIsRUFBb0IsRUFDcEIsYUFBcUIsRUFBRTtRQU12QixNQUFNLFNBQVMsR0FBYSxFQUFFLENBQUM7UUFFL0IsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLFVBQVUsRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDO1lBQ3BDLE1BQU0sRUFBRSxRQUFRLEVBQUUsR0FBRyxNQUFNLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxFQUFFLENBQUMsQ0FBQztZQUN6RCxTQUFTLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQzNCLENBQUM7UUFFRCxPQUFPO1lBQ0wsZUFBZSxFQUNiLFNBQVMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxHQUFHLEdBQUcsQ0FBQyxFQUFFLENBQUMsQ0FBQyxHQUFHLFNBQVMsQ0FBQyxNQUFNO1lBQzdELFdBQVcsRUFBRSxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsU0FBUyxDQUFDO1lBQ25DLFdBQVcsRUFBRSxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsU0FBUyxDQUFDO1NBQ3BDLENBQUM7SUFDSixDQUFDO0NBQ0Y7QUF0REQsb0RBc0RDO0FBRUQsNkJBQTZCO0FBQzdCLE1BQWEsaUJBQWlCO0lBQzVCOztPQUVHO0lBQ0gsTUFBTSxDQUFDLGVBQWUsQ0FBQyxNQUFzQztRQUMzRCxPQUFPLEtBQUssSUFBSSxFQUFFO1lBQ2hCLE1BQU0sVUFBVSxHQUFHLElBQUEsK0JBQXVCLEdBQUUsQ0FBQztZQUU3Qyw0QkFBNEI7WUFDNUIsVUFBVSxDQUFDLFlBQVksR0FBRyxJQUFJLENBQUMsRUFBRSxDQUFDLEtBQUssRUFBRSxRQUFRLEVBQUUsRUFBRTtnQkFDbkQsT0FBTyxRQUFRLENBQUMsVUFBVSxDQUFDLENBQUM7WUFDOUIsQ0FBQyxDQUFDLENBQUM7WUFFSCxNQUFNLE1BQU0sQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUMzQixDQUFDLENBQUM7SUFDSixDQUFDO0lBRUQ7O09BRUc7SUFDSCxNQUFNLENBQUMsNkJBQTZCLENBQUMsS0FBVSxFQUFFLGNBQXNCO1FBQ3JFLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQyxXQUFXLEVBQUUsQ0FBQztRQUM1QixNQUFNLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDLFNBQVMsQ0FBQyxjQUFjLENBQUMsQ0FBQztJQUNsRCxDQUFDO0NBQ0Y7QUF4QkQsOENBd0JDO0FBRUQsOEJBQThCO0FBQzlCLE1BQWEsc0JBQXNCO0lBQ2pDOztPQUVHO0lBQ0gsTUFBTSxDQUFDLHdCQUF3QixDQUFDLE9BQWUsUUFBUTtRQUNyRCxPQUFPO1lBQ0wsSUFBSSxFQUFFLFdBQVcsQ0FBQyxpQkFBaUIsQ0FBQyxJQUFJLENBQUM7WUFDekMsT0FBTyxFQUFFLFdBQVcsQ0FBQyxpQkFBaUIsQ0FBQyxJQUFJLENBQUM7WUFDNUMsUUFBUSxFQUFFO2dCQUNSLE1BQU0sRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsY0FBYyxFQUFFO2dCQUNsQyxJQUFJLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLGNBQWMsRUFBRTtnQkFDaEMsSUFBSSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxjQUFjLEVBQUU7YUFDakM7U0FDRixDQUFDO0lBQ0osQ0FBQztJQUVEOztPQUVHO0lBQ0gsTUFBTSxDQUFDLEtBQUssQ0FBQyxnQkFBZ0IsQ0FBQyxPQUFlLFFBQVE7UUFDbkQsTUFBTSxXQUFXLEdBQUcsV0FBVyxDQUFDLGlCQUFpQixDQUFDLElBQUksQ0FBQyxDQUFDO1FBRXhELGtDQUFrQztRQUNsQyxNQUFNLGFBQWEsR0FBRztZQUNwQixFQUFFLEVBQUUsV0FBVyxDQUFDLE1BQU07WUFDdEIsY0FBYyxFQUFFLENBQUMsRUFBRSxZQUFZLEVBQUUsV0FBVyxDQUFDLEtBQUssRUFBRSxDQUFDO1lBQ3JELFNBQVMsRUFBRSxNQUFNO1lBQ2pCLFFBQVEsRUFBRSxNQUFNO1NBQ2pCLENBQUM7UUFFRixPQUFPLEVBQUUsV0FBVyxFQUFFLGFBQWEsRUFBRSxDQUFDO0lBQ3hDLENBQUM7Q0FDRjtBQWhDRCx3REFnQ0M7QUFFRCxrRUFBa0UiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL3Rlc3QtdXRpbHMvZW5oYW5jZWQtdGVzdC1oZWxwZXJzLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogRW5oYW5jZWQgVGVzdCBIZWxwZXJzIGZvciBNZW50YXJhIEJhY2tlbmQgVGVzdGluZ1xuICogUHJvdmlkZXMgYWR2YW5jZWQgdXRpbGl0aWVzIGZvciBjb21wcmVoZW5zaXZlIHRlc3RpbmdcbiAqL1xuXG5pbXBvcnQgeyBUZXN0LCBUZXN0aW5nTW9kdWxlIH0gZnJvbSAnQG5lc3Rqcy90ZXN0aW5nJztcbmltcG9ydCB7IFByaXNtYVNlcnZpY2UgfSBmcm9tICcuLi9wcm92aWRlcnMvcHJpc21hLWNsaWVudC5wcm92aWRlcic7XG5pbXBvcnQgeyBjcmVhdGVNb2NrUHJpc21hU2VydmljZSwgVEVTVF9VU0VSX0lEUywgVEVTVF9FTUFJTFMgfSBmcm9tICcuL2luZGV4JztcblxuLy8gRW5oYW5jZWQgTW9jayBCdWlsZGVyc1xuZXhwb3J0IGNsYXNzIE1vY2tCdWlsZGVyIHtcbiAgLyoqXG4gICAqIENyZWF0ZXMgYSBjb21wcmVoZW5zaXZlIE5lc3RKUyB0ZXN0aW5nIG1vZHVsZSB3aXRoIGFsbCBjb21tb24gbW9ja3NcbiAgICovXG4gIHN0YXRpYyBhc3luYyBjcmVhdGVUZXN0aW5nTW9kdWxlKFxuICAgIHByb3ZpZGVyczogYW55W10gPSBbXSxcbiAgKTogUHJvbWlzZTxUZXN0aW5nTW9kdWxlPiB7XG4gICAgcmV0dXJuIFRlc3QuY3JlYXRlVGVzdGluZ01vZHVsZSh7XG4gICAgICBwcm92aWRlcnM6IFtcbiAgICAgICAgLi4ucHJvdmlkZXJzLFxuICAgICAgICB7XG4gICAgICAgICAgcHJvdmlkZTogUHJpc21hU2VydmljZSxcbiAgICAgICAgICB1c2VWYWx1ZTogY3JlYXRlTW9ja1ByaXNtYVNlcnZpY2UoKSxcbiAgICAgICAgfSxcbiAgICAgICAge1xuICAgICAgICAgIHByb3ZpZGU6ICdFdmVudEJ1c1NlcnZpY2UnLFxuICAgICAgICAgIHVzZVZhbHVlOiB7XG4gICAgICAgICAgICBlbWl0OiBqZXN0LmZuKCksXG4gICAgICAgICAgICBzdWJzY3JpYmU6IGplc3QuZm4oKSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgICB7XG4gICAgICAgICAgcHJvdmlkZTogJ0VtYWlsU2VydmljZScsXG4gICAgICAgICAgdXNlVmFsdWU6IHtcbiAgICAgICAgICAgIHNlbmRFbWFpbDogamVzdC5mbigpLFxuICAgICAgICAgICAgc2VuZFRlbXBsYXRlRW1haWw6IGplc3QuZm4oKSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgXSxcbiAgICB9KS5jb21waWxlKCk7XG4gIH1cblxuICAvKipcbiAgICogQ3JlYXRlcyBtb2NrIGF1dGhlbnRpY2F0aW9uIGNvbnRleHRcbiAgICovXG4gIHN0YXRpYyBjcmVhdGVBdXRoQ29udGV4dChyb2xlOiBzdHJpbmcgPSAnY2xpZW50JywgdXNlcklkPzogc3RyaW5nKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIHVzZXJJZDpcbiAgICAgICAgdXNlcklkIHx8XG4gICAgICAgIFRFU1RfVVNFUl9JRFNbcm9sZS50b1VwcGVyQ2FzZSgpIGFzIGtleW9mIHR5cGVvZiBURVNUX1VTRVJfSURTXSxcbiAgICAgIHJvbGUsXG4gICAgICBlbWFpbDogVEVTVF9FTUFJTFNbcm9sZS50b1VwcGVyQ2FzZSgpIGFzIGtleW9mIHR5cGVvZiBURVNUX0VNQUlMU10sXG4gICAgICBpc0FjdGl2ZTogdHJ1ZSxcbiAgICAgIGlzVmVyaWZpZWQ6IHRydWUsXG4gICAgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDcmVhdGVzIG1vY2sgcmVxdWVzdCBvYmplY3Qgd2l0aCBhdXRoZW50aWNhdGlvblxuICAgKi9cbiAgc3RhdGljIGNyZWF0ZU1vY2tSZXF1ZXN0KHJvbGU6IHN0cmluZyA9ICdjbGllbnQnLCB1c2VySWQ/OiBzdHJpbmcpIHtcbiAgICBjb25zdCBhdXRoQ29udGV4dCA9IHRoaXMuY3JlYXRlQXV0aENvbnRleHQocm9sZSwgdXNlcklkKTtcbiAgICByZXR1cm4ge1xuICAgICAgdXNlcjogYXV0aENvbnRleHQsXG4gICAgICBoZWFkZXJzOiB7XG4gICAgICAgIGF1dGhvcml6YXRpb246IGBCZWFyZXIgbW9jay1qd3QtdG9rZW4tJHtyb2xlfWAsXG4gICAgICAgICd1c2VyLWFnZW50JzogJ3Rlc3QtYWdlbnQnLFxuICAgICAgfSxcbiAgICAgIGlwOiAnMTI3LjAuMC4xJyxcbiAgICAgIG1ldGhvZDogJ0dFVCcsXG4gICAgICB1cmw6ICcvdGVzdCcsXG4gICAgfTtcbiAgfVxufVxuXG4vLyBUZXN0IERhdGEgR2VuZXJhdG9yc1xuZXhwb3J0IGNsYXNzIFRlc3REYXRhR2VuZXJhdG9yIHtcbiAgLyoqXG4gICAqIEdlbmVyYXRlcyByZWFsaXN0aWMgdGVzdCB1c2VyIGRhdGFcbiAgICovXG4gIHN0YXRpYyBjcmVhdGVVc2VyKG92ZXJyaWRlczogUGFydGlhbDxhbnk+ID0ge30pIHtcbiAgICByZXR1cm4ge1xuICAgICAgaWQ6IGB1c2VyLSR7RGF0ZS5ub3coKX0tJHtNYXRoLnJhbmRvbSgpLnRvU3RyaW5nKDM2KS5zdWJzdHIoMiwgOSl9YCxcbiAgICAgIGVtYWlsOiBgdGVzdC0ke0RhdGUubm93KCl9QGV4YW1wbGUuY29tYCxcbiAgICAgIGZpcnN0TmFtZTogJ1Rlc3QnLFxuICAgICAgbGFzdE5hbWU6ICdVc2VyJyxcbiAgICAgIHJvbGU6ICdjbGllbnQnLFxuICAgICAgaXNBY3RpdmU6IHRydWUsXG4gICAgICBpc1ZlcmlmaWVkOiBmYWxzZSxcbiAgICAgIGNyZWF0ZWRBdDogbmV3IERhdGUoKSxcbiAgICAgIHVwZGF0ZWRBdDogbmV3IERhdGUoKSxcbiAgICAgIC4uLm92ZXJyaWRlcyxcbiAgICB9O1xuICB9XG5cbiAgLyoqXG4gICAqIEdlbmVyYXRlcyB0aGVyYXBpc3QgYXBwbGljYXRpb24gZGF0YVxuICAgKi9cbiAgc3RhdGljIGNyZWF0ZVRoZXJhcGlzdEFwcGxpY2F0aW9uKG92ZXJyaWRlczogUGFydGlhbDxhbnk+ID0ge30pIHtcbiAgICByZXR1cm4ge1xuICAgICAgdXNlcklkOiBURVNUX1VTRVJfSURTLlRIRVJBUElTVCxcbiAgICAgIGVtYWlsOiBURVNUX0VNQUlMUy5USEVSQVBJU1QsXG4gICAgICBmaXJzdE5hbWU6ICdEci4gVGVzdCcsXG4gICAgICBsYXN0TmFtZTogJ1RoZXJhcGlzdCcsXG4gICAgICBtb2JpbGU6ICcrMTIzNDU2Nzg5MCcsXG4gICAgICBwcm92aW5jZTogJ1Rlc3QgUHJvdmluY2UnLFxuICAgICAgcHJvdmlkZXJUeXBlOiAnTGljZW5zZWQgQ2xpbmljYWwgUHN5Y2hvbG9naXN0JyxcbiAgICAgIHByb2Zlc3Npb25hbExpY2Vuc2VUeXBlOiAnTENQJyxcbiAgICAgIGlzUFJDTGljZW5zZWQ6ICd5ZXMnLFxuICAgICAgcHJjTGljZW5zZU51bWJlcjogJ0xDUC0xMjM0NScsXG4gICAgICBwcmFjdGljZVN0YXJ0RGF0ZTogbmV3IERhdGUoJzIwMjAtMDEtMDEnKSxcbiAgICAgIGFyZWFzT2ZFeHBlcnRpc2U6IFsnYW54aWV0eScsICdkZXByZXNzaW9uJ10sXG4gICAgICB0aGVyYXBldXRpY0FwcHJvYWNoZXNVc2VkTGlzdDogWydDQlQnLCAnREJUJ10sXG4gICAgICBsYW5ndWFnZXNPZmZlcmVkOiBbJ0VuZ2xpc2gnXSxcbiAgICAgIGFzc2Vzc21lbnRUb29sczogWydHQUQtNycsICdQSFEtOSddLFxuICAgICAgcHJvdmlkZWRPbmxpbmVUaGVyYXB5QmVmb3JlOiB0cnVlLFxuICAgICAgY29tZm9ydGFibGVVc2luZ1ZpZGVvQ29uZmVyZW5jaW5nOiB0cnVlLFxuICAgICAgd2Vla2x5QXZhaWxhYmlsaXR5OiAnMjAtMzAgaG91cnMnLFxuICAgICAgcHJlZmVycmVkU2Vzc2lvbkxlbmd0aDogJzYwJyxcbiAgICAgIGhvdXJseVJhdGU6IDE1MC4wLFxuICAgICAgLi4ub3ZlcnJpZGVzLFxuICAgIH07XG4gIH1cblxuICAvKipcbiAgICogR2VuZXJhdGVzIG1lZXRpbmcvc2Vzc2lvbiBkYXRhXG4gICAqL1xuICBzdGF0aWMgY3JlYXRlTWVldGluZyhvdmVycmlkZXM6IFBhcnRpYWw8YW55PiA9IHt9KSB7XG4gICAgY29uc3Qgbm93ID0gbmV3IERhdGUoKTtcbiAgICBjb25zdCBmdXR1cmVEYXRlID0gbmV3IERhdGUobm93LmdldFRpbWUoKSArIDI0ICogNjAgKiA2MCAqIDEwMDApOyAvLyBUb21vcnJvd1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIGlkOiBgbWVldGluZy0ke0RhdGUubm93KCl9YCxcbiAgICAgIHRpdGxlOiAnVGVzdCBUaGVyYXB5IFNlc3Npb24nLFxuICAgICAgc3RhcnRUaW1lOiBmdXR1cmVEYXRlLFxuICAgICAgZHVyYXRpb246IDYwLFxuICAgICAgc3RhdHVzOiAnU0NIRURVTEVEJyxcbiAgICAgIG1lZXRpbmdUeXBlOiAndmlkZW8nLFxuICAgICAgY2xpZW50SWQ6IFRFU1RfVVNFUl9JRFMuQ0xJRU5ULFxuICAgICAgdGhlcmFwaXN0SWQ6IFRFU1RfVVNFUl9JRFMuVEhFUkFQSVNULFxuICAgICAgY3JlYXRlZEF0OiBub3csXG4gICAgICB1cGRhdGVkQXQ6IG5vdyxcbiAgICAgIC4uLm92ZXJyaWRlcyxcbiAgICB9O1xuICB9XG5cbiAgLyoqXG4gICAqIEdlbmVyYXRlcyBtZXNzYWdlIGRhdGEgZm9yIHRlc3RpbmdcbiAgICovXG4gIHN0YXRpYyBjcmVhdGVNZXNzYWdlKG92ZXJyaWRlczogUGFydGlhbDxhbnk+ID0ge30pIHtcbiAgICByZXR1cm4ge1xuICAgICAgaWQ6IGBtZXNzYWdlLSR7RGF0ZS5ub3coKX1gLFxuICAgICAgY29udmVyc2F0aW9uSWQ6IGBjb252ZXJzYXRpb24tJHtEYXRlLm5vdygpfWAsXG4gICAgICBzZW5kZXJJZDogVEVTVF9VU0VSX0lEUy5DTElFTlQsXG4gICAgICBjb250ZW50OiAnVGVzdCBtZXNzYWdlIGNvbnRlbnQnLFxuICAgICAgbWVzc2FnZVR5cGU6ICdURVhUJyxcbiAgICAgIGlzRWRpdGVkOiBmYWxzZSxcbiAgICAgIGlzRGVsZXRlZDogZmFsc2UsXG4gICAgICBjcmVhdGVkQXQ6IG5ldyBEYXRlKCksXG4gICAgICB1cGRhdGVkQXQ6IG5ldyBEYXRlKCksXG4gICAgICAuLi5vdmVycmlkZXMsXG4gICAgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZW5lcmF0ZXMgYXNzZXNzbWVudCBkYXRhXG4gICAqL1xuICBzdGF0aWMgY3JlYXRlUHJlQXNzZXNzbWVudChvdmVycmlkZXM6IFBhcnRpYWw8YW55PiA9IHt9KSB7XG4gICAgLy8gR2VuZXJhdGUgMjAxIHJhbmRvbSBhbnN3ZXJzICgxLTUgc2NhbGUpXG4gICAgY29uc3QgYW5zd2VycyA9IEFycmF5LmZyb20oXG4gICAgICB7IGxlbmd0aDogMjAxIH0sXG4gICAgICAoKSA9PiBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiA1KSArIDEsXG4gICAgKTtcblxuICAgIHJldHVybiB7XG4gICAgICBpZDogYGFzc2Vzc21lbnQtJHtEYXRlLm5vdygpfWAsXG4gICAgICB1c2VySWQ6IFRFU1RfVVNFUl9JRFMuQ0xJRU5ULFxuICAgICAgcmVzcG9uc2VzOiBhbnN3ZXJzLFxuICAgICAgY29tcGxldGVkQXQ6IG5ldyBEYXRlKCksXG4gICAgICBzY29yZXM6IHtcbiAgICAgICAgYW54aWV0eTogNjUsXG4gICAgICAgIGRlcHJlc3Npb246IDQ1LFxuICAgICAgICBzdHJlc3M6IDU1LFxuICAgICAgfSxcbiAgICAgIGNyZWF0ZWRBdDogbmV3IERhdGUoKSxcbiAgICAgIHVwZGF0ZWRBdDogbmV3IERhdGUoKSxcbiAgICAgIC4uLm92ZXJyaWRlcyxcbiAgICB9O1xuICB9XG59XG5cbi8vIFRlc3QgQXNzZXJ0aW9uIEhlbHBlcnNcbmV4cG9ydCBjbGFzcyBUZXN0QXNzZXJ0aW9ucyB7XG4gIC8qKlxuICAgKiBBc3NlcnRzIHRoYXQgYSBmdW5jdGlvbiB0aHJvd3MgYSBzcGVjaWZpYyBOZXN0SlMgZXhjZXB0aW9uXG4gICAqL1xuICBzdGF0aWMgYXN5bmMgZXhwZWN0VG9UaHJvd05lc3RFeGNlcHRpb24oXG4gICAgYXN5bmNGbjogKCkgPT4gUHJvbWlzZTxhbnk+LFxuICAgIGV4Y2VwdGlvblR5cGU6IGFueSxcbiAgICBleHBlY3RlZE1lc3NhZ2U/OiBzdHJpbmcsXG4gICkge1xuICAgIGxldCB0aHJvd25FcnJvcjogYW55ID0gbnVsbDtcbiAgICB0cnkge1xuICAgICAgYXdhaXQgYXN5bmNGbigpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aHJvd25FcnJvciA9IGVycm9yO1xuICAgIH1cblxuICAgIGV4cGVjdCh0aHJvd25FcnJvcikudG9CZUluc3RhbmNlT2YoZXhjZXB0aW9uVHlwZSk7XG4gICAgaWYgKGV4cGVjdGVkTWVzc2FnZSkge1xuICAgICAgZXhwZWN0KHRocm93bkVycm9yLm1lc3NhZ2UpLnRvQ29udGFpbihleHBlY3RlZE1lc3NhZ2UpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBBc3NlcnRzIHByb3BlciBEVE8gdmFsaWRhdGlvblxuICAgKi9cbiAgc3RhdGljIGV4cGVjdFZhbGlkRHRvKGR0bzogYW55LCBleHBlY3RlZEZpZWxkczogc3RyaW5nW10pIHtcbiAgICBleHBlY3RlZEZpZWxkcy5mb3JFYWNoKChmaWVsZCkgPT4ge1xuICAgICAgZXhwZWN0KGR0bykudG9IYXZlUHJvcGVydHkoZmllbGQpO1xuICAgICAgZXhwZWN0KGR0b1tmaWVsZF0pLnRvQmVEZWZpbmVkKCk7XG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogQXNzZXJ0cyBwcm9wZXIgZGF0YWJhc2UgZW50aXR5IHN0cnVjdHVyZVxuICAgKi9cbiAgc3RhdGljIGV4cGVjdFZhbGlkRW50aXR5KGVudGl0eTogYW55LCByZXF1aXJlZEZpZWxkczogc3RyaW5nW10pIHtcbiAgICBleHBlY3QoZW50aXR5KS50b0JlRGVmaW5lZCgpO1xuICAgIGV4cGVjdChlbnRpdHkpLm5vdC50b0JlTnVsbCgpO1xuXG4gICAgcmVxdWlyZWRGaWVsZHMuZm9yRWFjaCgoZmllbGQpID0+IHtcbiAgICAgIGV4cGVjdChlbnRpdHkpLnRvSGF2ZVByb3BlcnR5KGZpZWxkKTtcbiAgICB9KTtcblxuICAgIC8vIENvbW1vbiBlbnRpdHkgZmllbGRzXG4gICAgZXhwZWN0KGVudGl0eSkudG9IYXZlUHJvcGVydHkoJ2lkJyk7XG4gICAgZXhwZWN0KGVudGl0eSkudG9IYXZlUHJvcGVydHkoJ2NyZWF0ZWRBdCcpO1xuICAgIGV4cGVjdChlbnRpdHkpLnRvSGF2ZVByb3BlcnR5KCd1cGRhdGVkQXQnKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBBc3NlcnRzIHByb3BlciBBUEkgcmVzcG9uc2Ugc3RydWN0dXJlXG4gICAqL1xuICBzdGF0aWMgZXhwZWN0VmFsaWRBcGlSZXNwb25zZShyZXNwb25zZTogYW55LCBleHBlY3RlZERhdGE/OiBhbnkpIHtcbiAgICBleHBlY3QocmVzcG9uc2UpLnRvQmVEZWZpbmVkKCk7XG5cbiAgICBpZiAoZXhwZWN0ZWREYXRhKSB7XG4gICAgICBleHBlY3QocmVzcG9uc2UpLnRvTWF0Y2hPYmplY3QoZXhwZWN0ZWREYXRhKTtcbiAgICB9XG4gIH1cbn1cblxuLy8gUGVyZm9ybWFuY2UgVGVzdGluZyBVdGlsaXRpZXNcbmV4cG9ydCBjbGFzcyBQZXJmb3JtYW5jZVRlc3RVdGlscyB7XG4gIC8qKlxuICAgKiBNZWFzdXJlcyBmdW5jdGlvbiBleGVjdXRpb24gdGltZVxuICAgKi9cbiAgc3RhdGljIGFzeW5jIG1lYXN1cmVFeGVjdXRpb25UaW1lPFQ+KFxuICAgIGZuOiAoKSA9PiBQcm9taXNlPFQ+LFxuICApOiBQcm9taXNlPHsgcmVzdWx0OiBUOyBkdXJhdGlvbjogbnVtYmVyIH0+IHtcbiAgICBjb25zdCBzdGFydCA9IHByb2Nlc3MuaHJ0aW1lLmJpZ2ludCgpO1xuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGZuKCk7XG4gICAgY29uc3QgZW5kID0gcHJvY2Vzcy5ocnRpbWUuYmlnaW50KCk7XG4gICAgY29uc3QgZHVyYXRpb24gPSBOdW1iZXIoZW5kIC0gc3RhcnQpIC8gMV8wMDBfMDAwOyAvLyBDb252ZXJ0IHRvIG1pbGxpc2Vjb25kc1xuXG4gICAgcmV0dXJuIHsgcmVzdWx0LCBkdXJhdGlvbiB9O1xuICB9XG5cbiAgLyoqXG4gICAqIEFzc2VydHMgdGhhdCBhIGZ1bmN0aW9uIGV4ZWN1dGVzIHdpdGhpbiBhIHRpbWUgbGltaXRcbiAgICovXG4gIHN0YXRpYyBhc3luYyBleHBlY3RUb0V4ZWN1dGVXaXRoaW48VD4oXG4gICAgZm46ICgpID0+IFByb21pc2U8VD4sXG4gICAgbWF4RHVyYXRpb25NczogbnVtYmVyLFxuICApOiBQcm9taXNlPFQ+IHtcbiAgICBjb25zdCB7IHJlc3VsdCwgZHVyYXRpb24gfSA9IGF3YWl0IHRoaXMubWVhc3VyZUV4ZWN1dGlvblRpbWUoZm4pO1xuXG4gICAgZXhwZWN0KGR1cmF0aW9uKS50b0JlTGVzc1RoYW4obWF4RHVyYXRpb25Ncyk7XG5cbiAgICByZXR1cm4gcmVzdWx0O1xuICB9XG5cbiAgLyoqXG4gICAqIFJ1bnMgYSBmdW5jdGlvbiBtdWx0aXBsZSB0aW1lcyBhbmQgbWVhc3VyZXMgYXZlcmFnZSBwZXJmb3JtYW5jZVxuICAgKi9cbiAgc3RhdGljIGFzeW5jIGJlbmNobWFya0Z1bmN0aW9uPFQ+KFxuICAgIGZuOiAoKSA9PiBQcm9taXNlPFQ+LFxuICAgIGl0ZXJhdGlvbnM6IG51bWJlciA9IDEwLFxuICApOiBQcm9taXNlPHtcbiAgICBhdmVyYWdlRHVyYXRpb246IG51bWJlcjtcbiAgICBtaW5EdXJhdGlvbjogbnVtYmVyO1xuICAgIG1heER1cmF0aW9uOiBudW1iZXI7XG4gIH0+IHtcbiAgICBjb25zdCBkdXJhdGlvbnM6IG51bWJlcltdID0gW107XG5cbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGl0ZXJhdGlvbnM7IGkrKykge1xuICAgICAgY29uc3QgeyBkdXJhdGlvbiB9ID0gYXdhaXQgdGhpcy5tZWFzdXJlRXhlY3V0aW9uVGltZShmbik7XG4gICAgICBkdXJhdGlvbnMucHVzaChkdXJhdGlvbik7XG4gICAgfVxuXG4gICAgcmV0dXJuIHtcbiAgICAgIGF2ZXJhZ2VEdXJhdGlvbjpcbiAgICAgICAgZHVyYXRpb25zLnJlZHVjZSgoc3VtLCBkKSA9PiBzdW0gKyBkLCAwKSAvIGR1cmF0aW9ucy5sZW5ndGgsXG4gICAgICBtaW5EdXJhdGlvbjogTWF0aC5taW4oLi4uZHVyYXRpb25zKSxcbiAgICAgIG1heER1cmF0aW9uOiBNYXRoLm1heCguLi5kdXJhdGlvbnMpLFxuICAgIH07XG4gIH1cbn1cblxuLy8gRGF0YWJhc2UgVGVzdGluZyBVdGlsaXRpZXNcbmV4cG9ydCBjbGFzcyBEYXRhYmFzZVRlc3RVdGlscyB7XG4gIC8qKlxuICAgKiBDcmVhdGVzIGEgdHJhbnNhY3Rpb24td3JhcHBlZCB0ZXN0IGZvciBkYXRhYmFzZSBvcGVyYXRpb25zXG4gICAqL1xuICBzdGF0aWMgd2l0aFRyYW5zYWN0aW9uKHRlc3RGbjogKHByaXNtYTogYW55KSA9PiBQcm9taXNlPHZvaWQ+KSB7XG4gICAgcmV0dXJuIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IG1vY2tQcmlzbWEgPSBjcmVhdGVNb2NrUHJpc21hU2VydmljZSgpO1xuXG4gICAgICAvLyBNb2NrIHRyYW5zYWN0aW9uIGJlaGF2aW9yXG4gICAgICBtb2NrUHJpc21hLiR0cmFuc2FjdGlvbiA9IGplc3QuZm4oYXN5bmMgKGNhbGxiYWNrKSA9PiB7XG4gICAgICAgIHJldHVybiBjYWxsYmFjayhtb2NrUHJpc21hKTtcbiAgICAgIH0pO1xuXG4gICAgICBhd2FpdCB0ZXN0Rm4obW9ja1ByaXNtYSk7XG4gICAgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiBWYWxpZGF0ZXMgdGhhdCBwcm9wZXIgZGF0YWJhc2UgY29uc3RyYWludHMgYXJlIGNoZWNrZWRcbiAgICovXG4gIHN0YXRpYyBleHBlY3REYXRhYmFzZUNvbnN0cmFpbnRFcnJvcihlcnJvcjogYW55LCBjb25zdHJhaW50VHlwZTogc3RyaW5nKSB7XG4gICAgZXhwZWN0KGVycm9yKS50b0JlRGVmaW5lZCgpO1xuICAgIGV4cGVjdChlcnJvci5tZXNzYWdlKS50b0NvbnRhaW4oY29uc3RyYWludFR5cGUpO1xuICB9XG59XG5cbi8vIEludGVncmF0aW9uIFRlc3RpbmcgSGVscGVyc1xuZXhwb3J0IGNsYXNzIEludGVncmF0aW9uVGVzdEhlbHBlcnMge1xuICAvKipcbiAgICogQ3JlYXRlcyBhIGZ1bGwgcmVxdWVzdCBjb250ZXh0IGZvciBpbnRlZ3JhdGlvbiB0ZXN0c1xuICAgKi9cbiAgc3RhdGljIGNyZWF0ZUZ1bGxSZXF1ZXN0Q29udGV4dChyb2xlOiBzdHJpbmcgPSAnY2xpZW50Jykge1xuICAgIHJldHVybiB7XG4gICAgICB1c2VyOiBNb2NrQnVpbGRlci5jcmVhdGVBdXRoQ29udGV4dChyb2xlKSxcbiAgICAgIHJlcXVlc3Q6IE1vY2tCdWlsZGVyLmNyZWF0ZU1vY2tSZXF1ZXN0KHJvbGUpLFxuICAgICAgcmVzcG9uc2U6IHtcbiAgICAgICAgc3RhdHVzOiBqZXN0LmZuKCkubW9ja1JldHVyblRoaXMoKSxcbiAgICAgICAganNvbjogamVzdC5mbigpLm1vY2tSZXR1cm5UaGlzKCksXG4gICAgICAgIHNlbmQ6IGplc3QuZm4oKS5tb2NrUmV0dXJuVGhpcygpLFxuICAgICAgfSxcbiAgICB9O1xuICB9XG5cbiAgLyoqXG4gICAqIFNpbXVsYXRlcyBhIGNvbXBsZXRlIGF1dGhlbnRpY2F0aW9uIGZsb3dcbiAgICovXG4gIHN0YXRpYyBhc3luYyBzaW11bGF0ZUF1dGhGbG93KHJvbGU6IHN0cmluZyA9ICdjbGllbnQnKSB7XG4gICAgY29uc3QgYXV0aENvbnRleHQgPSBNb2NrQnVpbGRlci5jcmVhdGVBdXRoQ29udGV4dChyb2xlKTtcblxuICAgIC8vIE1vY2sgdGhlIGF1dGhlbnRpY2F0aW9uIHByb2Nlc3NcbiAgICBjb25zdCBtb2NrQ2xlcmtVc2VyID0ge1xuICAgICAgaWQ6IGF1dGhDb250ZXh0LnVzZXJJZCxcbiAgICAgIGVtYWlsQWRkcmVzc2VzOiBbeyBlbWFpbEFkZHJlc3M6IGF1dGhDb250ZXh0LmVtYWlsIH1dLFxuICAgICAgZmlyc3ROYW1lOiAnVGVzdCcsXG4gICAgICBsYXN0TmFtZTogJ1VzZXInLFxuICAgIH07XG5cbiAgICByZXR1cm4geyBhdXRoQ29udGV4dCwgbW9ja0NsZXJrVXNlciB9O1xuICB9XG59XG5cbi8vIEFsbCB1dGlsaXRpZXMgYXJlIGFscmVhZHkgZXhwb3J0ZWQgYWJvdmUgdmlhIGNsYXNzIGRlY2xhcmF0aW9uc1xuIl0sInZlcnNpb24iOjN9