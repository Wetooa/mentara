{"file":"/home/wetooa/Documents/code/projects/mentara/mentara-api/src/auth/auth.service.ts","mappings":"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","names":[],"sources":["/home/wetooa/Documents/code/projects/mentara/mentara-api/src/auth/auth.service.ts"],"sourcesContent":["import { createClerkClient } from '@clerk/backend';\nimport {\n  ConflictException,\n  Injectable,\n  InternalServerErrorException,\n} from '@nestjs/common';\nimport { PrismaService } from 'src/providers/prisma-client.provider';\nimport {\n  ClientCreateDto,\n  ClientResponse,\n  TherapistCreateDto,\n  TherapistResponse,\n} from '../../schema/auth';\nimport { EventBusService } from '../common/events/event-bus.service';\nimport { UserRegisteredEvent } from '../common/events/user-events';\n\n@Injectable()\nexport class AuthService {\n  private readonly clerkClient = createClerkClient({\n    secretKey: process.env.CLERK_SECRET_KEY,\n  });\n\n  constructor(\n    private readonly prisma: PrismaService,\n    private readonly eventBus: EventBusService,\n  ) {}\n\n  async registerClient(\n    userId: string,\n    registerClientDto: ClientCreateDto,\n  ): Promise<ClientResponse> {\n    try {\n      // Check if user already exists\n      const existingUser = await this.prisma.user.findUnique({\n        where: { id: userId },\n      });\n\n      if (existingUser) {\n        throw new ConflictException('User already exists');\n      }\n\n      await this.clerkClient.users.updateUserMetadata(userId, {\n        publicMetadata: {\n          role: 'client',\n        },\n      });\n\n      await this.prisma.user.create({\n        data: registerClientDto.user,\n      });\n\n      // Create user\n      const client = await this.prisma.client.create({\n        data: {\n          ...registerClientDto,\n          user: { connect: { id: userId } },\n        },\n        include: {\n          user: true,\n        },\n      });\n\n      // Publish user registration event\n      await this.eventBus.emit(\n        new UserRegisteredEvent({\n          userId,\n          email: client.user.email,\n          firstName: client.user.firstName,\n          lastName: client.user.lastName,\n          role: 'client',\n          registrationMethod: 'email', // Default, could be enhanced\n        }),\n      );\n\n      return client;\n    } catch (error) {\n      console.error(\n        'User registration error:',\n        error instanceof Error ? error.message : error,\n      );\n      if (error instanceof ConflictException) {\n        throw error;\n      }\n      throw new InternalServerErrorException('User registration failed');\n    }\n  }\n\n  async registerTherapist(\n    userId: string,\n    registerTherapistDto: TherapistCreateDto,\n  ): Promise<TherapistResponse> {\n    try {\n      // Check if user already exists\n      const existingUser = await this.prisma.user.findUnique({\n        where: { id: userId },\n      });\n\n      if (existingUser) {\n        throw new ConflictException('User already exists');\n      }\n\n      await this.clerkClient.users.updateUserMetadata(userId, {\n        publicMetadata: {\n          role: 'therapist',\n        },\n      });\n\n      // Create user first\n      await this.prisma.user.create({\n        data: registerTherapistDto.user,\n      });\n\n      // Create therapist\n      const therapist = await this.prisma.therapist.create({\n        data: {\n          ...registerTherapistDto,\n          user: { connect: { id: userId } },\n          status: 'pending',\n        },\n        include: {\n          user: true,\n        },\n      });\n\n      // Publish user registration event\n      await this.eventBus.emit(\n        new UserRegisteredEvent({\n          userId,\n          email: therapist.user.email,\n          firstName: therapist.user.firstName,\n          lastName: therapist.user.lastName,\n          role: 'therapist',\n          registrationMethod: 'email', // Default, could be enhanced\n        }),\n      );\n\n      return {\n        ...therapist,\n        treatmentSuccessRates:\n          (therapist.treatmentSuccessRates as Record<string, any>) || {},\n      };\n    } catch (error) {\n      console.error(\n        'Therapist registration error:',\n        error instanceof Error ? error.message : error,\n      );\n      if (error instanceof ConflictException) {\n        throw error;\n      }\n      throw new InternalServerErrorException('Therapist registration failed');\n    }\n  }\n\n  async getUsers() {\n    return this.clerkClient.users.getUserList();\n  }\n\n  async getUser(userId: string) {\n    return this.clerkClient.users.getUser(userId);\n  }\n\n  async forceLogout(userId: string) {\n    try {\n      // Revoke all sessions for the user\n      const sessions = await this.clerkClient.sessions.getSessionList({\n        userId: userId,\n      });\n\n      // Revoke each active session\n      const revokePromises = sessions.data.map((session) =>\n        this.clerkClient.sessions.revokeSession(session.id),\n      );\n\n      await Promise.all(revokePromises);\n\n      return { success: true, message: 'User sessions revoked successfully' };\n    } catch (error) {\n      console.error(\n        'Force logout error:',\n        error instanceof Error ? error.message : error,\n      );\n      throw new InternalServerErrorException('Force logout failed');\n    }\n  }\n}\n"],"version":3}