{"file":"/home/wetooa/Documents/code/projects/mentara/mentara-api/src/pre-assessment/services/ai-service.client.ts","mappings":"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","names":[],"sources":["/home/wetooa/Documents/code/projects/mentara/mentara-api/src/pre-assessment/services/ai-service.client.ts"],"sourcesContent":["import { Injectable, Logger } from '@nestjs/common';\nimport { ConfigService } from '@nestjs/config';\nimport axios, { AxiosInstance, AxiosError } from 'axios';\nimport {\n  IsArray,\n  IsNumber,\n  validateSync,\n  Min,\n  Max,\n  ArrayMinSize,\n  ArrayMaxSize,\n} from 'class-validator';\n\n// DTO for AI service input validation\nclass AiPredictionInputDto {\n  @IsArray()\n  @ArrayMinSize(201, { message: 'Input array must contain exactly 201 values' })\n  @ArrayMaxSize(201, { message: 'Input array must contain exactly 201 values' })\n  @IsNumber({}, { each: true, message: 'All values must be numbers' })\n  @Min(0, { each: true, message: 'All values must be non-negative' })\n  @Max(10, { each: true, message: 'All values must be 10 or less' })\n  inputs!: number[];\n}\n\nexport interface AiPredictionResult {\n  success: boolean;\n  predictions?: Record<string, boolean>;\n  error?: string;\n  responseTime?: number;\n}\n\n@Injectable()\nexport class AiServiceClient {\n  private readonly logger = new Logger(AiServiceClient.name);\n  private readonly axiosInstance: AxiosInstance;\n  private readonly maxRetries: number = 3;\n  private readonly timeoutMs: number = 30000; // 30 seconds\n  private readonly baseURL: string;\n  private requestCount = 0;\n  private readonly maxRequestsPerMinute = 60; // Rate limiting\n  private lastResetTime = Date.now();\n\n  constructor(private readonly configService: ConfigService) {\n    // Get AI service URL from environment with fallback\n    this.baseURL =\n      this.configService.get<string>('AI_SERVICE_URL') ||\n      'http://localhost:5000';\n\n    this.axiosInstance = axios.create({\n      baseURL: this.baseURL,\n      timeout: this.timeoutMs,\n      headers: {\n        'Content-Type': 'application/json',\n        'User-Agent': 'Mentara-API/1.0',\n      },\n    });\n\n    // Add request interceptor for logging\n    this.axiosInstance.interceptors.request.use(\n      (config) => {\n        this.logger.debug(`Making AI service request to ${config.url}`);\n        return config;\n      },\n      (error) => {\n        this.logger.error('AI service request interceptor error:', error);\n        return Promise.reject(new Error(String(error)));\n      },\n    );\n\n    // Add response interceptor for logging\n    this.axiosInstance.interceptors.response.use(\n      (response) => {\n        this.logger.debug(`AI service response received: ${response.status}`);\n        return response;\n      },\n      (error) => {\n        this.logger.error(\n          'AI service response error:',\n          error?.response?.status || error.message,\n        );\n        return Promise.reject(new Error(String(error)));\n      },\n    );\n  }\n\n  private validateInput(flatAnswers: number[]): boolean {\n    const inputDto = new AiPredictionInputDto();\n    inputDto.inputs = flatAnswers;\n\n    const errors = validateSync(inputDto);\n\n    if (errors.length > 0) {\n      this.logger.warn(\n        'AI service input validation failed:',\n        errors.map((e) => e.toString()),\n      );\n      return false;\n    }\n\n    return true;\n  }\n\n  private isRateLimited(): boolean {\n    const now = Date.now();\n\n    // Reset counter every minute\n    if (now - this.lastResetTime > 60000) {\n      this.requestCount = 0;\n      this.lastResetTime = now;\n    }\n\n    if (this.requestCount >= this.maxRequestsPerMinute) {\n      this.logger.warn('AI service rate limit exceeded');\n      return true;\n    }\n\n    this.requestCount++;\n    return false;\n  }\n\n  private sanitizeInput(flatAnswers: number[]): number[] {\n    // Sanitize input values to prevent injection attacks\n    return flatAnswers.map((value) => {\n      // Ensure value is a finite number\n      if (!Number.isFinite(value)) {\n        this.logger.warn(`Invalid value detected: ${value}, replacing with 0`);\n        return 0;\n      }\n\n      // Clamp values to expected range\n      return Math.max(0, Math.min(10, Math.round(value * 100) / 100)); // Round to 2 decimal places\n    });\n  }\n\n  async predict(flatAnswers: number[]): Promise<AiPredictionResult> {\n    const startTime = Date.now();\n\n    try {\n      // Rate limiting check\n      if (this.isRateLimited()) {\n        return {\n          success: false,\n          error: 'Rate limit exceeded. Please try again later.',\n        };\n      }\n\n      // Input validation\n      if (!this.validateInput(flatAnswers)) {\n        return {\n          success: false,\n          error: 'Invalid input data for AI prediction',\n        };\n      }\n\n      // Sanitize input\n      const sanitizedInput = this.sanitizeInput(flatAnswers);\n\n      // Make the prediction with retry logic\n      const result = await this.makeRequestWithRetry(sanitizedInput);\n\n      const responseTime = Date.now() - startTime;\n      this.logger.log(`AI prediction completed in ${responseTime}ms`);\n\n      return {\n        success: true,\n        predictions: result,\n        responseTime,\n      };\n    } catch (error) {\n      const responseTime = Date.now() - startTime;\n      this.logger.error(`AI prediction failed after ${responseTime}ms:`, error);\n\n      return {\n        success: false,\n        error: this.getErrorMessage(error),\n        responseTime,\n      };\n    }\n  }\n\n  private async makeRequestWithRetry(\n    sanitizedInput: number[],\n    attempt: number = 1,\n  ): Promise<Record<string, boolean>> {\n    try {\n      const response = await this.axiosInstance.post('/predict', {\n        inputs: sanitizedInput,\n      });\n\n      // Validate response structure\n      if (!response.data || typeof response.data !== 'object') {\n        throw new Error('Invalid response format from AI service');\n      }\n\n      return response.data as Record<string, boolean>;\n    } catch (error) {\n      if (attempt < this.maxRetries && this.isRetryableError(error)) {\n        this.logger.warn(\n          `AI service request failed (attempt ${attempt}/${this.maxRetries}), retrying...`,\n        );\n\n        // Exponential backoff\n        const delay = Math.min(1000 * Math.pow(2, attempt - 1), 5000);\n        await new Promise((resolve) => setTimeout(resolve, delay));\n\n        return this.makeRequestWithRetry(sanitizedInput, attempt + 1);\n      }\n\n      throw error;\n    }\n  }\n\n  private isRetryableError(error: unknown): boolean {\n    if (error instanceof AxiosError) {\n      // Retry on network errors, timeouts, and 5xx server errors\n      return (\n        !error.response ||\n        error.response.status >= 500 ||\n        error.code === 'ECONNRESET' ||\n        error.code === 'ETIMEDOUT'\n      );\n    }\n    return false;\n  }\n\n  private getErrorMessage(error: unknown): string {\n    if (error instanceof AxiosError) {\n      if (error.code === 'ECONNREFUSED') {\n        return 'AI service is currently unavailable';\n      }\n      if (error.code === 'ETIMEDOUT') {\n        return 'AI service request timed out';\n      }\n      if (error.response?.status === 400) {\n        return 'Invalid request to AI service';\n      }\n      if (error.response?.status === 429) {\n        return 'AI service rate limit exceeded';\n      }\n      if (error.response?.status && error.response.status >= 500) {\n        return 'AI service internal error';\n      }\n    }\n\n    return 'Unknown error occurred while contacting AI service';\n  }\n\n  async healthCheck(): Promise<boolean> {\n    try {\n      const response = await this.axiosInstance.get('/health', {\n        timeout: 5000,\n      });\n      return response.status === 200;\n    } catch (error) {\n      this.logger.warn('AI service health check failed:', error);\n      return false;\n    }\n  }\n\n  getServiceInfo(): { baseURL: string; timeout: number; maxRetries: number } {\n    return {\n      baseURL: this.baseURL,\n      timeout: this.timeoutMs,\n      maxRetries: this.maxRetries,\n    };\n  }\n}\n"],"version":3}