0fb75feab74563e2e6f6ac936582b133
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.validateSchema = validateSchema;
exports.validateWithCustomErrors = validateWithCustomErrors;
exports.validateSchemaAsync = validateSchemaAsync;
exports.validatePartial = validatePartial;
exports.validateArray = validateArray;
exports.validateAndTransform = validateAndTransform;
exports.formatValidationErrors = formatValidationErrors;
exports.hasValidationErrors = hasValidationErrors;
exports.getFirstValidationError = getFirstValidationError;
exports.createValidationMiddleware = createValidationMiddleware;
exports.validateWithCoercion = validateWithCoercion;
exports.validateForEnvironment = validateForEnvironment;
const zod_1 = require("zod");
// Generic validation function
function validateSchema(schema, data) {
    const result = schema.safeParse(data);
    if (result.success) {
        return {
            success: true,
            data: result.data
        };
    }
    return {
        success: false,
        errors: result.error.errors.map(error => ({
            path: error.path,
            message: error.message,
            code: error.code
        }))
    };
}
// Validation with custom error formatting
function validateWithCustomErrors(schema, data, customErrors) {
    const result = validateSchema(schema, data);
    if (!result.success && customErrors && result.errors) {
        result.errors = result.errors.map(error => ({
            ...error,
            message: customErrors[error.path.join('.')] || error.message
        }));
    }
    return result;
}
// Async validation function
async function validateSchemaAsync(schema, data) {
    const result = await schema.safeParseAsync(data);
    if (result.success) {
        return {
            success: true,
            data: result.data
        };
    }
    return {
        success: false,
        errors: result.error.errors.map(error => ({
            path: error.path,
            message: error.message,
            code: error.code
        }))
    };
}
// Partial validation - only validate provided fields
function validatePartial(schema, data) {
    const partialSchema = schema.partial();
    return validateSchema(partialSchema, data);
}
// Array validation with detailed error reporting
function validateArray(itemSchema, data) {
    const arraySchema = zod_1.z.array(itemSchema);
    return validateSchema(arraySchema, data);
}
// Validation with transformation
function validateAndTransform(schema, data, transform) {
    const result = validateSchema(schema, data);
    if (result.success && result.data) {
        return {
            success: true,
            data: transform(result.data)
        };
    }
    return {
        success: false,
        errors: result.errors || []
    };
}
// Validation error formatter for API responses
function formatValidationErrors(errors) {
    if (!errors || errors.length === 0) {
        return 'Unknown validation error';
    }
    return errors
        .map(error => `${error.path.join('.')}: ${error.message}`)
        .join('; ');
}
// Check if validation result has errors
function hasValidationErrors(result) {
    return !result.success && Array.isArray(result.errors) && result.errors.length > 0;
}
// Extract first validation error
function getFirstValidationError(result) {
    if (hasValidationErrors(result)) {
        return result.errors[0]?.message || null;
    }
    return null;
}
// Create validation middleware for express-like frameworks
function createValidationMiddleware(schema) {
    return (data) => {
        const result = validateSchema(schema, data);
        if (!result.success) {
            const errorMessage = formatValidationErrors(result.errors);
            throw new Error(`Validation failed: ${errorMessage}`);
        }
        return result.data;
    };
}
// Validation with coercion for string inputs (useful for query parameters)
function validateWithCoercion(schema, data) {
    // Create a coerced version of the schema for common types
    const coercedData = {};
    Object.entries(data).forEach(([key, value]) => {
        // Try to coerce string values to appropriate types
        if (value === 'true') {
            coercedData[key] = true;
        }
        else if (value === 'false') {
            coercedData[key] = false;
        }
        else if (value === 'null') {
            coercedData[key] = null;
        }
        else if (value === 'undefined') {
            coercedData[key] = undefined;
        }
        else if (!isNaN(Number(value)) && value !== '') {
            coercedData[key] = Number(value);
        }
        else {
            coercedData[key] = value;
        }
    });
    return validateSchema(schema, coercedData);
}
// Validation with environment-specific rules
function validateForEnvironment(schema, data, environment) {
    // In development, we might want more lenient validation
    if (environment === 'development') {
        // Could implement more permissive validation here
        return validateSchema(schema, data);
    }
    // Production validation is strict
    return validateSchema(schema, data);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1jb21tb25zL2Rpc3QvdXRpbHMvdmFsaWRhdGlvbi5qcyIsIm1hcHBpbmdzIjoiQUFBQSxZQUFZLENBQUM7QUFDYixNQUFNLENBQUMsY0FBYyxDQUFDLE9BQU8sRUFBRSxZQUFZLEVBQUUsRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQztBQUM5RCxPQUFPLENBQUMsY0FBYyxHQUFHLGNBQWMsQ0FBQztBQUN4QyxPQUFPLENBQUMsd0JBQXdCLEdBQUcsd0JBQXdCLENBQUM7QUFDNUQsT0FBTyxDQUFDLG1CQUFtQixHQUFHLG1CQUFtQixDQUFDO0FBQ2xELE9BQU8sQ0FBQyxlQUFlLEdBQUcsZUFBZSxDQUFDO0FBQzFDLE9BQU8sQ0FBQyxhQUFhLEdBQUcsYUFBYSxDQUFDO0FBQ3RDLE9BQU8sQ0FBQyxvQkFBb0IsR0FBRyxvQkFBb0IsQ0FBQztBQUNwRCxPQUFPLENBQUMsc0JBQXNCLEdBQUcsc0JBQXNCLENBQUM7QUFDeEQsT0FBTyxDQUFDLG1CQUFtQixHQUFHLG1CQUFtQixDQUFDO0FBQ2xELE9BQU8sQ0FBQyx1QkFBdUIsR0FBRyx1QkFBdUIsQ0FBQztBQUMxRCxPQUFPLENBQUMsMEJBQTBCLEdBQUcsMEJBQTBCLENBQUM7QUFDaEUsT0FBTyxDQUFDLG9CQUFvQixHQUFHLG9CQUFvQixDQUFDO0FBQ3BELE9BQU8sQ0FBQyxzQkFBc0IsR0FBRyxzQkFBc0IsQ0FBQztBQUN4RCxNQUFNLEtBQUssR0FBRyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUM7QUFDN0IsOEJBQThCO0FBQzlCLFNBQVMsY0FBYyxDQUFDLE1BQU0sRUFBRSxJQUFJO0lBQ2hDLE1BQU0sTUFBTSxHQUFHLE1BQU0sQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDdEMsSUFBSSxNQUFNLENBQUMsT0FBTyxFQUFFLENBQUM7UUFDakIsT0FBTztZQUNILE9BQU8sRUFBRSxJQUFJO1lBQ2IsSUFBSSxF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QUFHLENBQUMsR0FBRyxLQUFLLENBQUM7UUFDN0IsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFDO0lBQ0gsT0FBTyxjQUFjLENBQUMsTUFBTSxFQUFFLFdBQVcsQ0FBQyxDQUFDO0FBQy9DLENBQUM7QUFDRCw2Q0FBNkM7QUFDN0MsU0FBUyxzQkFBc0IsQ0FBQyxNQUFNLEVBQUUsSUFBSSxFQUFFLFdBQVc7SUFDckQsd0RBQXdEO0lBQ3hELElBQUksV0FBVyxLQUFLLGFBQWEsRUFBRSxDQUFDO1FBQ2hDLGtEQUFrRDtRQUNsRCxPQUFPLGNBQWMsQ0FBQyxNQUFNLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFDeEMsQ0FBQztJQUNELGtDQUFrQztJQUNsQyxPQUFPLGNBQWMsQ0FBQyxNQUFNLEVBQUUsSUFBSSxDQUFDLENBQUM7QUFDeEMsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvaG9tZS93ZXRvb2EvRG9jdW1lbnRzL2NvZGUvcHJvamVjdHMvbWVudGFyYS9tZW50YXJhLWNvbW1vbnMvZGlzdC91dGlscy92YWxpZGF0aW9uLmpzIl0sInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFwiX19lc01vZHVsZVwiLCB7IHZhbHVlOiB0cnVlIH0pO1xuZXhwb3J0cy52YWxpZGF0ZVNjaGVtYSA9IHZhbGlkYXRlU2NoZW1hO1xuZXhwb3J0cy52YWxpZGF0ZVdpdGhDdXN0b21FcnJvcnMgPSB2YWxpZGF0ZVdpdGhDdXN0b21FcnJvcnM7XG5leHBvcnRzLnZhbGlkYXRlU2NoZW1hQXN5bmMgPSB2YWxpZGF0ZVNjaGVtYUFzeW5jO1xuZXhwb3J0cy52YWxpZGF0ZVBhcnRpYWwgPSB2YWxpZGF0ZVBhcnRpYWw7XG5leHBvcnRzLnZhbGlkYXRlQXJyYXkgPSB2YWxpZGF0ZUFycmF5O1xuZXhwb3J0cy52YWxpZGF0ZUFuZFRyYW5zZm9ybSA9IHZhbGlkYXRlQW5kVHJhbnNmb3JtO1xuZXhwb3J0cy5mb3JtYXRWYWxpZGF0aW9uRXJyb3JzID0gZm9ybWF0VmFsaWRhdGlvbkVycm9ycztcbmV4cG9ydHMuaGFzVmFsaWRhdGlvbkVycm9ycyA9IGhhc1ZhbGlkYXRpb25FcnJvcnM7XG5leHBvcnRzLmdldEZpcnN0VmFsaWRhdGlvbkVycm9yID0gZ2V0Rmlyc3RWYWxpZGF0aW9uRXJyb3I7XG5leHBvcnRzLmNyZWF0ZVZhbGlkYXRpb25NaWRkbGV3YXJlID0gY3JlYXRlVmFsaWRhdGlvbk1pZGRsZXdhcmU7XG5leHBvcnRzLnZhbGlkYXRlV2l0aENvZXJjaW9uID0gdmFsaWRhdGVXaXRoQ29lcmNpb247XG5leHBvcnRzLnZhbGlkYXRlRm9yRW52aXJvbm1lbnQgPSB2YWxpZGF0ZUZvckVudmlyb25tZW50O1xuY29uc3Qgem9kXzEgPSByZXF1aXJlKFwiem9kXCIpO1xuLy8gR2VuZXJpYyB2YWxpZGF0aW9uIGZ1bmN0aW9uXG5mdW5jdGlvbiB2YWxpZGF0ZVNjaGVtYShzY2hlbWEsIGRhdGEpIHtcbiAgICBjb25zdCByZXN1bHQgPSBzY2hlbWEuc2FmZVBhcnNlKGRhdGEpO1xuICAgIGlmIChyZXN1bHQuc3VjY2Vzcykge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgc3VjY2VzczogdHJ1ZSxcbiAgICAgICAgICAgIGRhdGE6IHJlc3VsdC5kYXRhXG4gICAgICAgIH07XG4gICAgfVxuICAgIHJldHVybiB7XG4gICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICBlcnJvcnM6IHJlc3VsdC5lcnJvci5lcnJvcnMubWFwKGVycm9yID0+ICh7XG4gICAgICAgICAgICBwYXRoOiBlcnJvci5wYXRoLFxuICAgICAgICAgICAgbWVzc2FnZTogZXJyb3IubWVzc2FnZSxcbiAgICAgICAgICAgIGNvZGU6IGVycm9yLmNvZGVcbiAgICAgICAgfSkpXG4gICAgfTtcbn1cbi8vIFZhbGlkYXRpb24gd2l0aCBjdXN0b20gZXJyb3IgZm9ybWF0dGluZ1xuZnVuY3Rpb24gdmFsaWRhdGVXaXRoQ3VzdG9tRXJyb3JzKHNjaGVtYSwgZGF0YSwgY3VzdG9tRXJyb3JzKSB7XG4gICAgY29uc3QgcmVzdWx0ID0gdmFsaWRhdGVTY2hlbWEoc2NoZW1hLCBkYXRhKTtcbiAgICBpZiAoIXJlc3VsdC5zdWNjZXNzICYmIGN1c3RvbUVycm9ycyAmJiByZXN1bHQuZXJyb3JzKSB7XG4gICAgICAgIHJlc3VsdC5lcnJvcnMgPSByZXN1bHQuZXJyb3JzLm1hcChlcnJvciA9PiAoe1xuICAgICAgICAgICAgLi4uZXJyb3IsXG4gICAgICAgICAgICBtZXNzYWdlOiBjdXN0b21FcnJvcnNbZXJyb3IucGF0aC5qb2luKCcuJyldIHx8IGVycm9yLm1lc3NhZ2VcbiAgICAgICAgfSkpO1xuICAgIH1cbiAgICByZXR1cm4gcmVzdWx0O1xufVxuLy8gQXN5bmMgdmFsaWRhdGlvbiBmdW5jdGlvblxuYXN5bmMgZnVuY3Rpb24gdmFsaWRhdGVTY2hlbWFBc3luYyhzY2hlbWEsIGRhdGEpIHtcbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBzY2hlbWEuc2FmZVBhcnNlQXN5bmMoZGF0YSk7XG4gICAgaWYgKHJlc3VsdC5zdWNjZXNzKSB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgICAgICAgZGF0YTogcmVzdWx0LmRhdGFcbiAgICAgICAgfTtcbiAgICB9XG4gICAgcmV0dXJuIHtcbiAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgIGVycm9yczogcmVzdWx0LmVycm9yLmVycm9ycy5tYXAoZXJyb3IgPT4gKHtcbiAgICAgICAgICAgIHBhdGg6IGVycm9yLnBhdGgsXG4gICAgICAgICAgICBtZXNzYWdlOiBlcnJvci5tZXNzYWdlLFxuICAgICAgICAgICAgY29kZTogZXJyb3IuY29kZVxuICAgICAgICB9KSlcbiAgICB9O1xufVxuLy8gUGFydGlhbCB2YWxpZGF0aW9uIC0gb25seSB2YWxpZGF0ZSBwcm92aWRlZCBmaWVsZHNcbmZ1bmN0aW9uIHZhbGlkYXRlUGFydGlhbChzY2hlbWEsIGRhdGEpIHtcbiAgICBjb25zdCBwYXJ0aWFsU2NoZW1hID0gc2NoZW1hLnBhcnRpYWwoKTtcbiAgICByZXR1cm4gdmFsaWRhdGVTY2hlbWEocGFydGlhbFNjaGVtYSwgZGF0YSk7XG59XG4vLyBBcnJheSB2YWxpZGF0aW9uIHdpdGggZGV0YWlsZWQgZXJyb3IgcmVwb3J0aW5nXG5mdW5jdGlvbiB2YWxpZGF0ZUFycmF5KGl0ZW1TY2hlbWEsIGRhdGEpIHtcbiAgICBjb25zdCBhcnJheVNjaGVtYSA9IHpvZF8xLnouYXJyYXkoaXRlbVNjaGVtYSk7XG4gICAgcmV0dXJuIHZhbGlkYXRlU2NoZW1hKGFycmF5U2NoZW1hLCBkYXRhKTtcbn1cbi8vIFZhbGlkYXRpb24gd2l0aCB0cmFuc2Zvcm1hdGlvblxuZnVuY3Rpb24gdmFsaWRhdGVBbmRUcmFuc2Zvcm0oc2NoZW1hLCBkYXRhLCB0cmFuc2Zvcm0pIHtcbiAgICBjb25zdCByZXN1bHQgPSB2YWxpZGF0ZVNjaGVtYShzY2hlbWEsIGRhdGEpO1xuICAgIGlmIChyZXN1bHQuc3VjY2VzcyAmJiByZXN1bHQuZGF0YSkge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgc3VjY2VzczogdHJ1ZSxcbiAgICAgICAgICAgIGRhdGE6IHRyYW5zZm9ybShyZXN1bHQuZGF0YSlcbiAgICAgICAgfTtcbiAgICB9XG4gICAgcmV0dXJuIHtcbiAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgIGVycm9yczogcmVzdWx0LmVycm9ycyB8fCBbXVxuICAgIH07XG59XG4vLyBWYWxpZGF0aW9uIGVycm9yIGZvcm1hdHRlciBmb3IgQVBJIHJlc3BvbnNlc1xuZnVuY3Rpb24gZm9ybWF0VmFsaWRhdGlvbkVycm9ycyhlcnJvcnMpIHtcbiAgICBpZiAoIWVycm9ycyB8fCBlcnJvcnMubGVuZ3RoID09PSAwKSB7XG4gICAgICAgIHJldHVybiAnVW5rbm93biB2YWxpZGF0aW9uIGVycm9yJztcbiAgICB9XG4gICAgcmV0dXJuIGVycm9yc1xuICAgICAgICAubWFwKGVycm9yID0+IGAke2Vycm9yLnBhdGguam9pbignLicpfTogJHtlcnJvci5tZXNzYWdlfWApXG4gICAgICAgIC5qb2luKCc7ICcpO1xufVxuLy8gQ2hlY2sgaWYgdmFsaWRhdGlvbiByZXN1bHQgaGFzIGVycm9yc1xuZnVuY3Rpb24gaGFzVmFsaWRhdGlvbkVycm9ycyhyZXN1bHQpIHtcbiAgICByZXR1cm4gIXJlc3VsdC5zdWNjZXNzICYmIEFycmF5LmlzQXJyYXkocmVzdWx0LmVycm9ycykgJiYgcmVzdWx0LmVycm9ycy5sZW5ndGggPiAwO1xufVxuLy8gRXh0cmFjdCBmaXJzdCB2YWxpZGF0aW9uIGVycm9yXG5mdW5jdGlvbiBnZXRGaXJzdFZhbGlkYXRpb25FcnJvcihyZXN1bHQpIHtcbiAgICBpZiAoaGFzVmFsaWRhdGlvbkVycm9ycyhyZXN1bHQpKSB7XG4gICAgICAgIHJldHVybiByZXN1bHQuZXJyb3JzWzBdPy5tZXNzYWdlIHx8IG51bGw7XG4gICAgfVxuICAgIHJldHVybiBudWxsO1xufVxuLy8gQ3JlYXRlIHZhbGlkYXRpb24gbWlkZGxld2FyZSBmb3IgZXhwcmVzcy1saWtlIGZyYW1ld29ya3NcbmZ1bmN0aW9uIGNyZWF0ZVZhbGlkYXRpb25NaWRkbGV3YXJlKHNjaGVtYSkge1xuICAgIHJldHVybiAoZGF0YSkgPT4ge1xuICAgICAgICBjb25zdCByZXN1bHQgPSB2YWxpZGF0ZVNjaGVtYShzY2hlbWEsIGRhdGEpO1xuICAgICAgICBpZiAoIXJlc3VsdC5zdWNjZXNzKSB7XG4gICAgICAgICAgICBjb25zdCBlcnJvck1lc3NhZ2UgPSBmb3JtYXRWYWxpZGF0aW9uRXJyb3JzKHJlc3VsdC5lcnJvcnMpO1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBWYWxpZGF0aW9uIGZhaWxlZDogJHtlcnJvck1lc3NhZ2V9YCk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHJlc3VsdC5kYXRhO1xuICAgIH07XG59XG4vLyBWYWxpZGF0aW9uIHdpdGggY29lcmNpb24gZm9yIHN0cmluZyBpbnB1dHMgKHVzZWZ1bCBmb3IgcXVlcnkgcGFyYW1ldGVycylcbmZ1bmN0aW9uIHZhbGlkYXRlV2l0aENvZXJjaW9uKHNjaGVtYSwgZGF0YSkge1xuICAgIC8vIENyZWF0ZSBhIGNvZXJjZWQgdmVyc2lvbiBvZiB0aGUgc2NoZW1hIGZvciBjb21tb24gdHlwZXNcbiAgICBjb25zdCBjb2VyY2VkRGF0YSA9IHt9O1xuICAgIE9iamVjdC5lbnRyaWVzKGRhdGEpLmZvckVhY2goKFtrZXksIHZhbHVlXSkgPT4ge1xuICAgICAgICAvLyBUcnkgdG8gY29lcmNlIHN0cmluZyB2YWx1ZXMgdG8gYXBwcm9wcmlhdGUgdHlwZXNcbiAgICAgICAgaWYgKHZhbHVlID09PSAndHJ1ZScpIHtcbiAgICAgICAgICAgIGNvZXJjZWREYXRhW2tleV0gPSB0cnVlO1xuICAgICAgICB9XG4gICAgICAgIGVsc2UgaWYgKHZhbHVlID09PSAnZmFsc2UnKSB7XG4gICAgICAgICAgICBjb2VyY2VkRGF0YVtrZXldID0gZmFsc2U7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSBpZiAodmFsdWUgPT09ICdudWxsJykge1xuICAgICAgICAgICAgY29lcmNlZERhdGFba2V5XSA9IG51bGw7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSBpZiAodmFsdWUgPT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAgICAgICBjb2VyY2VkRGF0YVtrZXldID0gdW5kZWZpbmVkO1xuICAgICAgICB9XG4gICAgICAgIGVsc2UgaWYgKCFpc05hTihOdW1iZXIodmFsdWUpKSAmJiB2YWx1ZSAhPT0gJycpIHtcbiAgICAgICAgICAgIGNvZXJjZWREYXRhW2tleV0gPSBOdW1iZXIodmFsdWUpO1xuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgY29lcmNlZERhdGFba2V5XSA9IHZhbHVlO1xuICAgICAgICB9XG4gICAgfSk7XG4gICAgcmV0dXJuIHZhbGlkYXRlU2NoZW1hKHNjaGVtYSwgY29lcmNlZERhdGEpO1xufVxuLy8gVmFsaWRhdGlvbiB3aXRoIGVudmlyb25tZW50LXNwZWNpZmljIHJ1bGVzXG5mdW5jdGlvbiB2YWxpZGF0ZUZvckVudmlyb25tZW50KHNjaGVtYSwgZGF0YSwgZW52aXJvbm1lbnQpIHtcbiAgICAvLyBJbiBkZXZlbG9wbWVudCwgd2UgbWlnaHQgd2FudCBtb3JlIGxlbmllbnQgdmFsaWRhdGlvblxuICAgIGlmIChlbnZpcm9ubWVudCA9PT0gJ2RldmVsb3BtZW50Jykge1xuICAgICAgICAvLyBDb3VsZCBpbXBsZW1lbnQgbW9yZSBwZXJtaXNzaXZlIHZhbGlkYXRpb24gaGVyZVxuICAgICAgICByZXR1cm4gdmFsaWRhdGVTY2hlbWEoc2NoZW1hLCBkYXRhKTtcbiAgICB9XG4gICAgLy8gUHJvZHVjdGlvbiB2YWxpZGF0aW9uIGlzIHN0cmljdFxuICAgIHJldHVybiB2YWxpZGF0ZVNjaGVtYShzY2hlbWEsIGRhdGEpO1xufVxuLy8jIHNvdXJjZU1hcHBpbmdVUkw9dmFsaWRhdGlvbi5qcy5tYXAiXSwidmVyc2lvbiI6M30=