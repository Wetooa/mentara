9944d2f2764f741bb61b0d309c8c055c
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
exports.RoleUtils = exports.UserRole = void 0;
const common_1 = require("@nestjs/common");
const prisma_client_provider_1 = require("src/providers/prisma-client.provider");
var UserRole;
(function (UserRole) {
    UserRole["USER"] = "user";
    UserRole["THERAPIST"] = "therapist";
    UserRole["ADMIN"] = "admin";
    UserRole["MODERATOR"] = "moderator";
})(UserRole || (exports.UserRole = UserRole = {}));
let RoleUtils = class RoleUtils {
    prisma;
    constructor(prisma) {
        this.prisma = prisma;
    }
    async getUserRole(clerkId) {
        try {
            const user = await this.prisma.user.findUnique({
                where: { id: clerkId },
                select: { role: true },
            });
            return user?.role || null;
        }
        catch (error) {
            console.error('Error getting user role:', error instanceof Error ? error.message : error);
            return null;
        }
    }
    async isUserAdmin(clerkId) {
        const role = await this.getUserRole(clerkId);
        return role === UserRole.ADMIN;
    }
    async isUserTherapist(clerkId) {
        const role = await this.getUserRole(clerkId);
        return role === UserRole.THERAPIST;
    }
    async isUserModerator(clerkId) {
        const role = await this.getUserRole(clerkId);
        return role === UserRole.MODERATOR;
    }
    async isUserRegularUser(clerkId) {
        const role = await this.getUserRole(clerkId);
        return role === UserRole.USER;
    }
    getRolePermissions(role) {
        switch (role) {
            case UserRole.ADMIN:
                return {
                    canAccessAdminPanel: true,
                    canManageUsers: true,
                    canManageTherapists: true,
                    canModerateContent: true,
                    canCreateWorksheets: true,
                    canAssignWorksheets: true,
                };
            case UserRole.MODERATOR:
                return {
                    canAccessAdminPanel: false,
                    canManageUsers: false,
                    canManageTherapists: false,
                    canModerateContent: true,
                    canCreateWorksheets: false,
                    canAssignWorksheets: false,
                };
            case UserRole.THERAPIST:
                return {
                    canAccessAdminPanel: false,
                    canManageUsers: false,
                    canManageTherapists: false,
                    canModerateContent: false,
                    canCreateWorksheets: true,
                    canAssignWorksheets: true,
                };
            case UserRole.USER:
            default:
                return {
                    canAccessAdminPanel: false,
                    canManageUsers: false,
                    canManageTherapists: false,
                    canModerateContent: false,
                    canCreateWorksheets: false,
                    canAssignWorksheets: false,
                };
        }
    }
    async getUserPermissions(clerkId) {
        const role = await this.getUserRole(clerkId);
        return this.getRolePermissions(role || UserRole.USER);
    }
    async requireRole(clerkId, requiredRole) {
        const userRole = await this.getUserRole(clerkId);
        if (!userRole)
            return false;
        const roleHierarchy = {
            [UserRole.USER]: 1,
            [UserRole.THERAPIST]: 2,
            [UserRole.MODERATOR]: 3,
            [UserRole.ADMIN]: 4,
        };
        return roleHierarchy[userRole] >= roleHierarchy[requiredRole];
    }
};
exports.RoleUtils = RoleUtils;
exports.RoleUtils = RoleUtils = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [typeof (_a = typeof prisma_client_provider_1.PrismaService !== "undefined" && prisma_client_provider_1.PrismaService) === "function" ? _a : Object])
], RoleUtils);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL3V0aWxzL3JvbGUtdXRpbHMudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7OztBQUFBLDJDQUE0QztBQUM1QyxpRkFBcUU7QUFFckUsSUFBWSxRQUtYO0FBTEQsV0FBWSxRQUFRO0lBQ2xCLHlCQUFhLENBQUE7SUFDYixtQ0FBdUIsQ0FBQTtJQUN2QiwyQkFBZSxDQUFBO0lBQ2YsbUNBQXVCLENBQUE7QUFDekIsQ0FBQyxFQUxXLFFBQVEsd0JBQVIsUUFBUSxRQUtuQjtBQVlNLElBQU0sU0FBUyxHQUFmLE1BQU0sU0FBUztJQUNBO0lBQXBCLFlBQW9CLE1BQXFCO1FBQXJCLFdBQU0sR0FBTixNQUFNLENBQWU7SUFBRyxDQUFDO0lBRTdDLEtBQUssQ0FBQyxXQUFXLENBQUMsT0FBZTtRQUMvQixJQUFJLENBQUM7WUFDSCxNQUFNLElBQUksR0FBRyxNQUFNLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQztnQkFDN0MsS0FBSyxFQUFFLEVBQUUsRUFBRSxFQUFFLE9BQU8sRUFBRTtnQkFDdEIsTUFBTSxFQUFFLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRTthQUN2QixDQUFDLENBQUM7WUFDSCxPQUFRLElBQUksRUFBRSxJQUFpQixJQUFJLElBQUksQ0FBQztRQUMxQyxDQUFDO1FBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztZQUNmLE9BQU8sQ0FBQyxLQUFLLENBQ1gsMEJBQTBCLEVBQzFCLEtBQUssWUFBWSxLQUFLLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FDL0MsQ0FBQztZQUNGLE9BQU8sSUFBSSxDQUFDO1FBQ2QsQ0FBQztJQUNILENBQUM7SUFFRCxLQUFLLENBQUMsV0FBVyxDQUFDLE9BQWU7UUFDL0IsTUFBTSxJQUFJLEdBQUcsTUFBTSxJQUFJLENBQUMsV0FBVyxDQUFDLE9BQU8sQ0FBQyxDQUFD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QyxLQUFLLENBQUMsRUFBRSxDQUFDO1NBQ3BCLENBQUM7UUFFRixPQUFPLGFBQWEsQ0FBQyxRQUFRLENBQUMsSUFBSSxhQUFhLENBQUMsWUFBWSxDQUFDLENBQUM7SUFDaEUsQ0FBQztDQUNGLENBQUE7QUFuR1ksOEJBQVM7b0JBQVQsU0FBUztJQURyQixJQUFBLG1CQUFVLEdBQUU7eURBRWlCLHNDQUFhLG9CQUFiLHNDQUFhO0dBRDlCLFNBQVMsQ0FtR3JCIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9ob21lL3dldG9vYS9Eb2N1bWVudHMvY29kZS9wcm9qZWN0cy9tZW50YXJhL21lbnRhcmEtYXBpL3NyYy91dGlscy9yb2xlLXV0aWxzLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAbmVzdGpzL2NvbW1vbic7XG5pbXBvcnQgeyBQcmlzbWFTZXJ2aWNlIH0gZnJvbSAnc3JjL3Byb3ZpZGVycy9wcmlzbWEtY2xpZW50LnByb3ZpZGVyJztcblxuZXhwb3J0IGVudW0gVXNlclJvbGUge1xuICBVU0VSID0gJ3VzZXInLFxuICBUSEVSQVBJU1QgPSAndGhlcmFwaXN0JyxcbiAgQURNSU4gPSAnYWRtaW4nLFxuICBNT0RFUkFUT1IgPSAnbW9kZXJhdG9yJyxcbn1cblxuZXhwb3J0IGludGVyZmFjZSBSb2xlUGVybWlzc2lvbnMge1xuICBjYW5BY2Nlc3NBZG1pblBhbmVsOiBib29sZWFuO1xuICBjYW5NYW5hZ2VVc2VyczogYm9vbGVhbjtcbiAgY2FuTWFuYWdlVGhlcmFwaXN0czogYm9vbGVhbjtcbiAgY2FuTW9kZXJhdGVDb250ZW50OiBib29sZWFuO1xuICBjYW5DcmVhdGVXb3Jrc2hlZXRzOiBib29sZWFuO1xuICBjYW5Bc3NpZ25Xb3Jrc2hlZXRzOiBib29sZWFuO1xufVxuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgUm9sZVV0aWxzIHtcbiAgY29uc3RydWN0b3IocHJpdmF0ZSBwcmlzbWE6IFByaXNtYVNlcnZpY2UpIHt9XG5cbiAgYXN5bmMgZ2V0VXNlclJvbGUoY2xlcmtJZDogc3RyaW5nKTogUHJvbWlzZTxVc2VyUm9sZSB8IG51bGw+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgdXNlciA9IGF3YWl0IHRoaXMucHJpc21hLnVzZXIuZmluZFVuaXF1ZSh7XG4gICAgICAgIHdoZXJlOiB7IGlkOiBjbGVya0lkIH0sXG4gICAgICAgIHNlbGVjdDogeyByb2xlOiB0cnVlIH0sXG4gICAgICB9KTtcbiAgICAgIHJldHVybiAodXNlcj8ucm9sZSBhcyBVc2VyUm9sZSkgfHwgbnVsbDtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc29sZS5lcnJvcihcbiAgICAgICAgJ0Vycm9yIGdldHRpbmcgdXNlciByb2xlOicsXG4gICAgICAgIGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogZXJyb3IsXG4gICAgICApO1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgaXNVc2VyQWRtaW4oY2xlcmtJZDogc3RyaW5nKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgY29uc3Qgcm9sZSA9IGF3YWl0IHRoaXMuZ2V0VXNlclJvbGUoY2xlcmtJZCk7XG4gICAgcmV0dXJuIHJvbGUgPT09IFVzZXJSb2xlLkFETUlOO1xuICB9XG5cbiAgYXN5bmMgaXNVc2VyVGhlcmFwaXN0KGNsZXJrSWQ6IHN0cmluZyk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgIGNvbnN0IHJvbGUgPSBhd2FpdCB0aGlzLmdldFVzZXJSb2xlKGNsZXJrSWQpO1xuICAgIHJldHVybiByb2xlID09PSBVc2VyUm9sZS5USEVSQVBJU1Q7XG4gIH1cblxuICBhc3luYyBpc1VzZXJNb2RlcmF0b3IoY2xlcmtJZDogc3RyaW5nKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgY29uc3Qgcm9sZSA9IGF3YWl0IHRoaXMuZ2V0VXNlclJvbGUoY2xlcmtJZCk7XG4gICAgcmV0dXJuIHJvbGUgPT09IFVzZXJSb2xlLk1PREVSQVRPUjtcbiAgfVxuXG4gIGFzeW5jIGlzVXNlclJlZ3VsYXJVc2VyKGNsZXJrSWQ6IHN0cmluZyk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgIGNvbnN0IHJvbGUgPSBhd2FpdCB0aGlzLmdldFVzZXJSb2xlKGNsZXJrSWQpO1xuICAgIHJldHVybiByb2xlID09PSBVc2VyUm9sZS5VU0VSO1xuICB9XG5cbiAgZ2V0Um9sZVBlcm1pc3Npb25zKHJvbGU6IFVzZXJSb2xlKTogUm9sZVBlcm1pc3Npb25zIHtcbiAgICBzd2l0Y2ggKHJvbGUpIHtcbiAgICAgIGNhc2UgVXNlclJvbGUuQURNSU46XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgY2FuQWNjZXNzQWRtaW5QYW5lbDogdHJ1ZSxcbiAgICAgICAgICBjYW5NYW5hZ2VVc2VyczogdHJ1ZSxcbiAgICAgICAgICBjYW5NYW5hZ2VUaGVyYXBpc3RzOiB0cnVlLFxuICAgICAgICAgIGNhbk1vZGVyYXRlQ29udGVudDogdHJ1ZSxcbiAgICAgICAgICBjYW5DcmVhdGVXb3Jrc2hlZXRzOiB0cnVlLFxuICAgICAgICAgIGNhbkFzc2lnbldvcmtzaGVldHM6IHRydWUsXG4gICAgICAgIH07XG4gICAgICBjYXNlIFVzZXJSb2xlLk1PREVSQVRPUjpcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBjYW5BY2Nlc3NBZG1pblBhbmVsOiBmYWxzZSxcbiAgICAgICAgICBjYW5NYW5hZ2VVc2VyczogZmFsc2UsXG4gICAgICAgICAgY2FuTWFuYWdlVGhlcmFwaXN0czogZmFsc2UsXG4gICAgICAgICAgY2FuTW9kZXJhdGVDb250ZW50OiB0cnVlLFxuICAgICAgICAgIGNhbkNyZWF0ZVdvcmtzaGVldHM6IGZhbHNlLFxuICAgICAgICAgIGNhbkFzc2lnbldvcmtzaGVldHM6IGZhbHNlLFxuICAgICAgICB9O1xuICAgICAgY2FzZSBVc2VyUm9sZS5USEVSQVBJU1Q6XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgY2FuQWNjZXNzQWRtaW5QYW5lbDogZmFsc2UsXG4gICAgICAgICAgY2FuTWFuYWdlVXNlcnM6IGZhbHNlLFxuICAgICAgICAgIGNhbk1hbmFnZVRoZXJhcGlzdHM6IGZhbHNlLFxuICAgICAgICAgIGNhbk1vZGVyYXRlQ29udGVudDogZmFsc2UsXG4gICAgICAgICAgY2FuQ3JlYXRlV29ya3NoZWV0czogdHJ1ZSxcbiAgICAgICAgICBjYW5Bc3NpZ25Xb3Jrc2hlZXRzOiB0cnVlLFxuICAgICAgICB9O1xuICAgICAgY2FzZSBVc2VyUm9sZS5VU0VSOlxuICAgICAgZGVmYXVsdDpcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBjYW5BY2Nlc3NBZG1pblBhbmVsOiBmYWxzZSxcbiAgICAgICAgICBjYW5NYW5hZ2VVc2VyczogZmFsc2UsXG4gICAgICAgICAgY2FuTWFuYWdlVGhlcmFwaXN0czogZmFsc2UsXG4gICAgICAgICAgY2FuTW9kZXJhdGVDb250ZW50OiBmYWxzZSxcbiAgICAgICAgICBjYW5DcmVhdGVXb3Jrc2hlZXRzOiBmYWxzZSxcbiAgICAgICAgICBjYW5Bc3NpZ25Xb3Jrc2hlZXRzOiBmYWxzZSxcbiAgICAgICAgfTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBnZXRVc2VyUGVybWlzc2lvbnMoY2xlcmtJZDogc3RyaW5nKTogUHJvbWlzZTxSb2xlUGVybWlzc2lvbnM+IHtcbiAgICBjb25zdCByb2xlID0gYXdhaXQgdGhpcy5nZXRVc2VyUm9sZShjbGVya0lkKTtcbiAgICByZXR1cm4gdGhpcy5nZXRSb2xlUGVybWlzc2lvbnMocm9sZSB8fCBVc2VyUm9sZS5VU0VSKTtcbiAgfVxuXG4gIGFzeW5jIHJlcXVpcmVSb2xlKGNsZXJrSWQ6IHN0cmluZywgcmVxdWlyZWRSb2xlOiBVc2VyUm9sZSk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgIGNvbnN0IHVzZXJSb2xlID0gYXdhaXQgdGhpcy5nZXRVc2VyUm9sZShjbGVya0lkKTtcbiAgICBpZiAoIXVzZXJSb2xlKSByZXR1cm4gZmFsc2U7XG5cbiAgICBjb25zdCByb2xlSGllcmFyY2h5ID0ge1xuICAgICAgW1VzZXJSb2xlLlVTRVJdOiAxLFxuICAgICAgW1VzZXJSb2xlLlRIRVJBUElTVF06IDIsXG4gICAgICBbVXNlclJvbGUuTU9ERVJBVE9SXTogMyxcbiAgICAgIFtVc2VyUm9sZS5BRE1JTl06IDQsXG4gICAgfTtcblxuICAgIHJldHVybiByb2xlSGllcmFyY2h5W3VzZXJSb2xlXSA+PSByb2xlSGllcmFyY2h5W3JlcXVpcmVkUm9sZV07XG4gIH1cbn1cbiJdLCJ2ZXJzaW9uIjozfQ==