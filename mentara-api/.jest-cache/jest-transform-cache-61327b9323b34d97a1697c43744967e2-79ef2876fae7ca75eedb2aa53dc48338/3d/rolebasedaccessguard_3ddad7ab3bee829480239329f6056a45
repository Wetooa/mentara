e85beb1862281f39127ea3e849725a5b
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var _a, _b;
Object.defineProperty(exports, "__esModule", { value: true });
exports.RoleBasedAccessGuard = exports.AllowResourceOwner = exports.RequireRole = exports.RequirePermissions = void 0;
const common_1 = require("@nestjs/common");
const core_1 = require("@nestjs/core");
const prisma_client_provider_1 = require("src/providers/prisma-client.provider");
// Define role hierarchy - higher numbers have more permissions
const ROLE_HIERARCHY = {
    client: 0,
    therapist: 1,
    moderator: 2,
    admin: 3,
};
// Define role-based permissions for different resources
const ROLE_PERMISSIONS = {
    // User management
    'users:create': ['admin'],
    'users:read:all': ['admin', 'moderator'],
    'users:read:own': ['client', 'therapist', 'moderator', 'admin'],
    'users:update:own': ['client', 'therapist', 'moderator', 'admin'],
    'users:update:others': ['admin'],
    'users:delete': ['admin'],
    'users:deactivate': ['admin', 'moderator'],
    // Therapist management
    'therapists:create': ['admin'],
    'therapists:read:all': ['admin', 'moderator'],
    'therapists:read:public': ['client', 'therapist', 'moderator', 'admin'],
    'therapists:update:own': ['therapist', 'admin'],
    'therapists:update:others': ['admin'],
    'therapists:approve': ['admin'],
    'therapists:assign': ['admin', 'moderator'],
    // Client management
    'clients:create': ['admin'],
    'clients:read:all': ['admin', 'moderator'],
    'clients:read:assigned': ['therapist'],
    'clients:read:own': ['client', 'admin'],
    'clients:update:own': ['client', 'admin'],
    'clients:update:assigned': ['therapist', 'admin'],
    // Assessment management
    'assessments:create:own': ['client'],
    'assessments:read:own': ['client', 'admin'],
    'assessments:read:assigned': ['therapist'],
    'assessments:read:all': ['admin', 'moderator'],
    'assessments:update:own': ['client'],
    'assessments:delete:own': ['client', 'admin'],
    'assessments:delete:all': ['admin'],
    // Session management
    'sessions:create': ['therapist', 'admin'],
    'sessions:read:own': ['client', 'therapist'],
    'sessions:read:all': ['admin', 'moderator'],
    'sessions:update:own': ['therapist'],
    'sessions:cancel:own': ['client', 'therapist'],
    'sessions:cancel:all': ['admin'],
    // Messaging
    'messages:create': ['client', 'therapist'],
    'messages:read:own': ['client', 'therapist'],
    'messages:read:all': ['admin', 'moderator'],
    'messages:moderate': ['moderator', 'admin'],
    // Community management
    'communities:create': ['admin'],
    'communities:read:all': ['client', 'therapist', 'moderator', 'admin'],
    'communities:update': ['admin', 'moderator'],
    'communities:moderate': ['moderator', 'admin'],
    'communities:join': ['client', 'therapist'],
    // Content management
    'posts:create': ['client', 'therapist'],
    'posts:read:all': ['client', 'therapist', 'moderator', 'admin'],
    'posts:update:own': ['client', 'therapist'],
    'posts:delete:own': ['client', 'therapist'],
    'posts:moderate': ['moderator', 'admin'],
    // File management
    'files:upload:own': ['client', 'therapist'],
    'files:read:own': ['client', 'therapist'],
    'files:read:assigned': ['therapist'],
    'files:read:all': ['admin'],
    'files:delete:own': ['client', 'therapist', 'admin'],
    'files:delete:all': ['admin'],
    // Admin functions
    'admin:access': ['admin'],
    'admin:analytics': ['admin', 'moderator'],
    'admin:system-config': ['admin'],
    // Billing
    'billing:create': ['admin'],
    'billing:read:own': ['client', 'therapist'],
    'billing:read:all': ['admin'],
    'billing:update': ['admin'],
    // Notifications
    'notifications:create': ['admin', 'moderator'],
    'notifications:read:own': ['client', 'therapist', 'moderator', 'admin'],
    'notifications:update:own': ['client', 'therapist', 'moderator', 'admin'],
};
// Decorator to define required permissions
const RequirePermissions = (...permissions) => Reflect.defineMetadata('permissions', permissions, Reflect);
exports.RequirePermissions = RequirePermissions;
// Decorator to define minimum role required
const RequireRole = (role) => Reflect.defineMetadata('min_role', role, Reflect);
exports.RequireRole = RequireRole;
// Decorator to allow resource owner access
const AllowResourceOwner = (resourceIdParam = 'id') => Reflect.defineMetadata('resource_owner_param', resourceIdParam, Reflect);
exports.AllowResourceOwner = AllowResourceOwner;
let RoleBasedAccessGuard = class RoleBasedAccessGuard {
    reflector;
    prisma;
    constructor(reflector, prisma) {
        this.reflector = reflector;
        this.prisma = prisma;
    }
    async canActivate(context) {
        const request = context.switchToHttp().getRequest();
        const user = request.user;
        const userRole = request.userRole || user?.role;
        const userId = request.userId || user?.userId;
        if (!userRole || !userId) {
            // If no role or user ID, deny access (unless it's a public route)
            return false;
        }
        // Check for required permissions
        const requiredPermissions = this.reflector.getAllAndOverride('permissions', [context.getHandler(), context.getClass()]);
        if (requiredPermissions) {
            const hasPermission = this.checkPermissions(userRole, requiredPermissions);
            if (!hasPermission) {
                throw new common_1.ForbiddenException('Insufficient permissions');
            }
        }
        // Check for minimum role requirement
        const minimumRole = this.reflector.getAllAndOverride('min_role', [context.getHandler(), context.getClass()]);
        if (minimumRole) {
            const hasRole = this.checkRole(userRole, minimumRole);
            if (!hasRole) {
                throw new common_1.ForbiddenException(`Minimum role '${minimumRole}' required`);
            }
        }
        // Check for resource owner access
        const resourceOwnerParam = this.reflector.getAllAndOverride('resource_owner_param', [context.getHandler(), context.getClass()]);
        if (resourceOwnerParam) {
            const resourceId = request.params[resourceOwnerParam];
            const isOwner = this.checkResourceOwnership(userId, resourceId, userRole, request);
            if (!isOwner) {
                throw new common_1.ForbiddenException('Access denied - not resource owner');
            }
        }
        // Special validation for therapist-client relationships
        if (userRole === 'therapist') {
            const clientId = request.params.clientId || request.body?.clientId;
            if (clientId) {
                const isValidRelationship = await this.validateTherapistClientRelationship(userId, clientId);
                if (!isValidRelationship) {
                    throw new common_1.ForbiddenException('Access denied - no active therapist-client relationship');
                }
            }
        }
        return true;
    }
    checkPermissions(userRole, requiredPermissions) {
        return requiredPermissions.some((permission) => {
            const allowedRoles = ROLE_PERMISSIONS[permission] || [];
            return allowedRoles.includes(userRole);
        });
    }
    checkRole(userRole, minimumRole) {
        const userRoleLevel = ROLE_HIERARCHY[userRole];
        const minimumRoleLevel = ROLE_HIERARCHY[minimumRole];
        return userRoleLevel !== undefined && userRoleLevel >= minimumRoleLevel;
    }
    checkResourceOwnership(userId, resourceId, userRole, request) {
        // If no resource ID specified, allow access
        if (!resourceId)
            return true;
        // Admin can access any resource
        if (userRole === 'admin')
            return true;
        // Check if the resource ID matches the user ID
        if (resourceId === userId)
            return true;
        // For therapists, deny access here - specific therapist-client validation 
        // is handled in the main canActivate method above
        if (userRole === 'therapist') {
            return false;
        }
        // For moderators, allow access to community resources
        if (userRole === 'moderator') {
            const path = request.path;
            if (path.includes('/communities') ||
                path.includes('/posts') ||
                path.includes('/comments')) {
                return true;
            }
        }
        return false;
    }
    /**
     * Validate that a therapist has an active relationship with a client
     */
    async validateTherapistClientRelationship(therapistId, clientId) {
        try {
            const relationship = await this.prisma.clientTherapist.findFirst({
                where: {
                    therapistId,
                    clientId,
                },
            });
            return !!relationship;
        }
        catch (error) {
            // Log error and deny access on database errors for security
            console.error('Error validating therapist-client relationship:', error);
            return false;
        }
    }
    // Helper method to get user permissions for debugging
    static getUserPermissions(userRole) {
        return Object.entries(ROLE_PERMISSIONS)
            .filter(([_, roles]) => roles.includes(userRole))
            .map(([permission]) => permission);
    }
    // Helper method to check if a user can access a specific resource
    static canAccessResource(userRole, permission, userId, resourceOwnerId) {
        const allowedRoles = ROLE_PERMISSIONS[permission] || [];
        const hasRolePermission = allowedRoles.includes(userRole);
        if (hasRolePermission)
            return true;
        // Check resource ownership
        if (userId && resourceOwnerId && userId === resourceOwnerId) {
            return true;
        }
        return false;
    }
};
exports.RoleBasedAccessGuard = RoleBasedAccessGuard;
exports.RoleBasedAccessGuard = RoleBasedAccessGuard = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [typeof (_a = typeof core_1.Reflector !== "undefined" && core_1.Reflector) === "function" ? _a : Object, typeof (_b = typeof prisma_client_provider_1.PrismaService !== "undefined" && prisma_client_provider_1.PrismaService) === "function" ? _b : Object])
], RoleBasedAccessGuard);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL2F1dGgvZ3VhcmRzL3JvbGUtYmFzZWQtYWNjZXNzLmd1YXJkLnRzIiwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7QUFBQSwyQ0FLd0I7QUFDeEIsdUNBQXlDO0FBQ3pDLGlGQUFxRTtBQUVyRSwrREFBK0Q7QUFDL0QsTUFBTSxjQUFjLEdBQUc7SUFDckIsTUFBTSxFQUFFLENBQUM7SUFDVCxTQUFTLEVBQUUsQ0FBQztJQUNaLFNBQVMsRUFBRSxDQUFDO0lBQ1osS0FBSyxFQUFFLENBQUM7Q0FDVCxDQUFDO0FBRUYsd0RBQXdEO0FBQ3hELE1BQU0sZ0JBQWdCLEdBQUc7SUFDdkIsa0JBQWtCO0lBQ2xCLGNBQWMsRUFBRSxDQUFDLE9BQU8sQ0FBQztJQUN6QixnQkFBZ0IsRUFBRSxDQUFDLE9BQU8sRUFBRSxXQUFXLENBQUM7SUFDeEMsZ0JBQWdCLEVBQUUsQ0FBQyxRQUFRLEVBQUUsV0FBVyxFQUFFLFdBQVcsRUFBRSxPQUFPLENBQUM7SUFDL0Qsa0JBQWtCLEVBQUUsQ0FBQyxRQUFRLEVBQUUsV0FBVyxFQUFFLFdBQVcsRUFBRSxPQUFPLENBQUM7SUFDakUscUJBQXFCLEVBQUUsQ0FBQyxPQUFPLENBQUM7SUFDaEMsY0FBYyxFQUFFLENBQUMsT0FBTyxDQUFDO0lBQ3pCLGtCQUFrQixFQUFFLENBQUMsT0FBTyxFQUFFLFdBQVcsQ0FBQztJQUUxQyx1QkFBdUI7SUFDdkIsbUJBQW1CLEVBQUUsQ0FBQyxPQUFPLENBQUM7SUFDOUIscUJBQXFCLEVBQUUsQ0FBQyxPQUFPLEVBQUUsV0FBVyxDQUFDO0lBQzdDLHdCQUF3QixFQUFFLENBQUMsUUFBUSxFQUFFLFdBQVcsRUFBRSxXQUFXLEVBQUUsT0FBTyxDQUFDO0lBQ3ZFLHVCQUF1QixFQUFFLENBQUMsV0FBVyxFQUFFLE9BQU8sQ0FBQztJQUMvQywwQkFBMEIsRUFBRSxDQUFDLE9BQU8sQ0FBQztJQUNyQyxvQkFBb0IsRUFBRSxDQUFDLE9BQU8sQ0FBQztJQUMvQixtQkFBbUIsRUFBRSxDQUFDLE9BQU8sRUFBRSxXQUFXLENBQUM7SUFFM0Msb0JBQW9CO0lBQ3BCLGdCQUFnQixFQUFFLENBQUMsT0FBTyxDQUFDO0lBQzNCLGtCQUFrQixFQUFFLENBQUMsT0FBTyxFQUFFLFdBQVcsQ0FBQztJQUMxQyx1QkFBdUIsRUFBRSxDQUFDLFdBQVcsQ0FBQztJQUN0QyxrQkFBa0IsRUFBRSxDQUFDLFFBQVEsRUFBRSxPQUFPLENBQUM7SUFDdkMsb0JBQW9CLEVBQUUsQ0FBQyxRQUFRLEVBQUUsT0FBTyxDQUFDO0lBQ3pDLHlCQUF5QixFQUFFLENBQUMsV0FBVyxFQUFFLE9BQU8sQ0FBQztJQUVqRCx3QkFBd0I7SUFDeEIsd0JBQXdCLEVBQUUsQ0FBQyxRQUFRLENBQUM7SUFDcEMsc0JBQXNCLEVBQUUsQ0FBQyxRQUFRLEVBQUUsT0FBTyxDQUFDO0lBQzNDLDJCQUEyQixFQUFFLENBQUMsV0FBVyxDQUFDO0lBQzFDLHNCQUFzQixFQUFFLENBQUMsT0FBTyxFQUFFLFdBQVcsQ0FBQztJQUM5Qyx3QkFBd0IsRUFBRSxDQUFDLFFBQVEsQ0FBQztJQUNwQyx3QkFBd0IsRUFBRSxDQUFDLFFBQVEsRUFBRSxPQUFPLENBQUM7SUFDN0Msd0JBQXdCLEVBQUUsQ0FBQyxPQUFPLENBQUM7SUFFbkMscUJBQXFCO0lBQ3JCLGlCQUFpQixFQUFFLENBQUMsV0FBVyxFQUFFLE9BQU8sQ0FBQztJQUN6QyxtQkFBbUIsRUFBRSxDQUFDLFFBQVEsRUFBRSxXQUFXLENBQUM7SUFDNUMsbUJBQW1CLEVBQUUsQ0FBQyxPQUFPLEVBQUUsV0FBVyxDQUFDO0lBQzNDLHFCQUFxQixFQUFFLENBQUMsV0FBVyxDQUFDO0lBQ3BDLHFCQUFxQixFQUFFLENBQUMsUUFBUSxFQUFFLFdBQVcsQ0FBQztJQUM5QyxxQkFBcUIsRUFBRSxDQUFDLE9BQU8sQ0FBQztJQUVoQyxZQUFZO0lBQ1osaUJBQWlCLEVBQUUsQ0FBQyxRQUFRLEVBQUUsV0FBVyxDQUFDO0lBQzFDLG1CQUFtQixFQUFFLENBQUMsUUFBUSxFQUFFLFdBQVcsQ0FBQztJQUM1QyxtQkFBbUIsRUFBRSxDQUFDLE9BQU8sRUFBRSxXQUFXLENBQUM7SUFDM0MsbUJBQW1CLEVBQUUsQ0FBQyxXQUFXLEVBQUUsT0FBTyxDQUFDO0lBRTNDLHVCQUF1QjtJQUN2QixvQkFBb0IsRUFBRSxDQUFDLE9BQU8sQ0FBQztJQUMvQixzQkFBc0IsRUFBRSxDQUFDLFFBQVEsRUFBRSxXQUFXLEVBQUUsV0FBVyxFQUFFLE9BQU8sQ0FBQztJQUNyRSxvQkFBb0IsRUFBRSxDQUFDLE9BQU8sRUFBRSxXQUFXLENBQUM7SUFDNUMsc0JBQXNCLEVBQUUsQ0FBQyxXQUFXLEVBQUUsT0FBTyxDQUFDO0lBQzlDLGtCQUFrQixFQUFFLENBQUMsUUFBUSxFQUFFLFdBQVcsQ0FBQztJQUUzQyxxQkFBcUI7SUFDckIsY0FBYyxFQUFFLENBQUMsUUFBUSxFQUFFLFdBQVcsQ0FBQztJQUN2QyxnQkFBZ0IsRUFBRSxDQUFDLFFBQVEsRUFBRSxXQUFXLEVBQUUsV0FBVyxFQUFFLE9BQU8sQ0FBQztJQUMvRCxrQkFBa0IsRUFBRSxDQUFDLFFBQVEsRUFBRSxXQUFXLENBQUM7SUFDM0Msa0JBQWtCLEVBQUUsQ0FBQyxRQUFRLEVBQUUsV0FBVyxDQUFDO0lBQzNDLGdCQUFnQixFQUFFLENBQUMsV0FBVyxFQUFFLE9BQU8sQ0FBQztJQUV4QyxrQkFBa0I7SUFDbEIsa0JBQWtCLEVBQUUsQ0FBQyxRQUFRLEVBQUUsV0FBVyxDQUFDO0lBQzNDLGdCQUFnQixFQUFFLENBQUMsUUFBUSxFQUFFLFdBQVcsQ0FBQztJQUN6QyxxQkFBcUIsRUFBRSxDQUFDLFdBQVcsQ0FBQztJQUNwQyxnQkFBZ0IsRUFBRSxDQUFDLE9BQU8sQ0FBQztJQUMzQixrQkFBa0IsRUFBRSxDQUFDLFFBQVEsRUFBRSxXQUFXLEVBQUUsT0FBTyxDQUFDO0lBQ3BELGtCQUFrQixFQUFFLENBQUMsT0FBTyxDQUFDO0lBRTdCLGtCQUFrQjtJQUNsQixjQUFjLEVBQUUsQ0FBQyxPQUFPLENBQUM7SUFDekIsaUJBQWlCLEVBQUUsQ0FBQyxPQUFPLEVBQUUsV0FBVyxDQUFDO0lBQ3pDLHFCQUFxQixFQUFFLENBQUMsT0FBTyxDQUFDO0lBRWhDLFVBQVU7SUFDVixnQkFBZ0IsRUFBRSxDQUFDLE9BQU8sQ0FBQztJQUMzQixrQkFBa0IsRUFBRSxDQUFDLFFBQVEsRUFBRSxXQUFXLENBQUM7SUFDM0Msa0JBQWtCLEVBQUUsQ0FBQyxPQUFPLENBQUM7SUFDN0IsZ0JBQWdCLEVBQUUsQ0FBQyxPQUFPLENBQUM7SUFFM0IsZ0JBQWdCO0lBQ2hCLHNCQUFzQixFQUFFLENBQUMsT0FBTyxFQUFFLFdBQVcsQ0FBQztJQUM5Qyx3QkFBd0IsRUFBRSxDQUFDLFFBQVEsRUFBRSxXQUFXLEVBQUUsV0FBVyxFQUFFLE9BQU8sQ0FBQztJQUN2RSwwQkFBMEIsRUFBRSxDQUFDLFFBQVEsRUFBRSxXQUFXLEVBQUUsV0FBVyxFQUFFLE9BQU8sQ0FBQztDQUMxRSxDQUFDO0FBRUYsMkNBQTJDO0FBQ3BDLE1BQU0sa0JBQWtCLEdBQUcsQ0FBQyxHQUFHLFdBQXFCLEVBQUUsRUFBRSxDQUM3RCxPQUFPLENBQUMsY0FBYyxDQUFDLGFBQWEsRUFBRSxXQUFXLEVBQUUsT0FBTyxDQUFDLENBQUM7QUFEakQsUUFBQSxrQkFBa0Isc0JBQytCO0FBRTlELDRDQUE0QztBQUNyQyxNQUFNLFdBQVcsR0FBRyxDQUFDLElBQWlDLEVBQUUsRUFBRSxDQUMvRCxPQUFPLENBQUMsY0FBYyxDQUFDLFVBQVUsRUFBRSxJQUFJLEVBQUUsT0FBTyxDQUFDLENBQUM7QUFEdkMsUUFBQSxXQUFXLGVBQzRCO0FBRXBELDJDQUEyQztBQUNwQyxNQUFNLGtCQUFrQixHQUFHLENBQUMsa0JBQTBCLElBQUksRUFBRSxFQUFFLENBQ25FLE9BQU8sQ0FBQyxjQUFjLENBQUMsc0JBQXNCLEVBQUUsZUFBZSxFQUFFLE9BQU8sQ0FBQyxDQUFDO0FBRDlELFFBQUEsa0JBQWtCLHNCQUM0QztBQUdwRSxJQUFNLG9CQUFvQixHQUExQixNQUFNLG9CQUFvQjtJQUVyQjtJQUNBO0lBRlYsWUFDVSxTQUFvQixFQUNwQixNQUFxQjtRQURyQixjQUFTLEdBQVQsU0FBUyxDQUFXO1FBQ3BCLFdBQU0sR0FBTixNQUFNLENBQWU7SUFDNUIsQ0FBQztJQUVKLEtBQUssQ0FBQyxXQUFXLENBQUMsT0FBeUI7UUFDekMsTUFBTSxPQUFPLEdBQUcsT0FBTyxDQUFDLFlBQVksRUFBRSxDQUFDLFVBQVUsRUFBRSxDQUFDO1FBQ3BELE1BQU0sSUFBSSxHQUFHLE9BQU8sQ0FBQyxJQUFJLENBQUM7UUFDMUIsTUFBTSxRQUFRLEdBQUcsT0FBTyxDQUFDLFFBQVEsSUFBSSxJQUFJLEVBQUUsSUFBSSxDQUFDO1FBQ2hELE1BQU0sTUFBTSxHQUFHLE9BQU8sQ0FBQyxNQUFNLElBQUksSUFBSSxFQUFFLE1BQU0sQ0FBQztRQUU5QyxJQUFJLENBQUMsUUFBUSxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUM7WUFDekIsa0VBQWtFO1lBQ2xFLE9BQU8sS0FBSyxDQUFDO1FBQ2YsQ0FBQztRQUVELGlDQUFpQztRQUNqQyxNQUFNLG1CQUFtQixHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsaUJBQWlCLENBQzFELGFBQWEsRUFDYixDQUFDLE9BQU8sQ0FBQyxVQUFVLEVBQUUsRUFBRSxPQUFPLENBQUMsUUFBUSxFQUFFLENBQUMsQ0FDM0MsQ0FBQztRQUVGLElBQUksbUJBQW1CLEVBQUUsQ0FBQztZQUN4QixNQUFNLGFBQWEsR0FBRyxJQUFJLENBQUMsZ0JBQWdCLENBQ3pDLFFBQVEsRUFDUixtQkFBbUIsQ0FDcEIsQ0FBQztZQUNGLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztnQkFDbkIsTUFBTSxJQUFJLDJCQUFrQixDQUFDLDBCQUEwQixDQUFDLENBQUM7WUFDM0QsQ0FBQztRQUNILENBQUM7UUFFRCxxQ0FBcUM7UUFDckMsTUFBTSxXQUFXLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxpQkFBaUIsQ0FFbEQsVUFBVSxFQUFFLENBQUMsT0FBTyxDQUFDLFVBQVUsRUFBRSxFQUFFLE9BQU8sQ0FBQyxRQUFRLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFFMUQsSUFBSSxXQUFXLEVBQUUsQ0FBQztZQUNoQixNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLFFBQVEsRUFBRSxXQUFXLENBQUMsQ0FBQztZQUN0RCxJQUFJLENBQUMsT0FBTyxFQUFFLENBQUM7Z0JBQ2IsTUFBTSxJQUFJLDJCQUFrQixDQUFDLGlCQUFpQixXQUFXLFlBQVksQ0FBQyxDQUFDO1lBQ3pFLENBQUM7UUFDSCxDQUFDO1FBRUQsa0NBQWtDO1FBQ2xDLE1BQU0sa0JBQWtCLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxpQkFBaUIsQ0FDekQsc0JBQXNCLEVBQ3RCLENBQUMsT0FBTyxDQUFDLFVBQVUsRUFBRSxFQUFFLE9BQU8sQ0FBQyxRQUFRLEVBQUUsQ0FBQyxDQUMzQyxDQUFDO1FBRUYsSUFBSSxrQkFBa0IsRUFBRSxDQUFDO1lBQ3ZCLE1BQU0sVUFBVSxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUMsa0JBQWtCLENBQUMsQ0FBQztZQUN0RCxNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsc0JBQXNCLENBQ3pDLE1BQU0sRUFDTixVQUFVLEVBQ1YsUUFBUSxFQUNSLE9BQU8sQ0FDUixDQUFDO1lBQ0YsSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFDO2dCQUNiLE1BQU0sSUFBSSwyQkFBa0IsQ0FBQyxvQ0FBb0MsQ0FBQyxDQUFDO1lBQ3JFLENBQUM7UUFDSCxDQUFDO1FBRUQsd0RBQXdEO1FBQ3hELElBQUksUUFBUSxLQUFLLFdBQVcsRUFBRSxDQUFDO1lBQzdCLE1BQU0sUUFBUSxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUMsUUFBUSxJQUFJLE9BQU8sQ0FBQyxJQUFJLEVBQUUsUUFBUSxDQUFDO1lBQ25FLElBQUksUUFBUSxFQUFFLENBQUM7Z0JBQ2IsTUFBTSxtQkFBbUIsR0FBRyxNQUFNLElBQUksQ0FBQyxtQ0FBbUMsQ0FDeEUsTUFBTSxFQUNOLFFBQVEsQ0FDVCxDQUFDO2dCQUNGLElBQUksQ0FBQyxtQkFBbUIsRUFBRSxDQUFDO29CQUN6QixNQUFNLElBQUksMkJBQWtCLENBQzFCLHlEQUF5RCxDQUMxRCxDQUFDO2dCQUNKLENBQUM7WUFDSCxDQUFDO1FBQ0gsQ0FBQztRQUVELE9BQU8sSUFBSSxDQUFDO0lBQ2QsQ0FBQztJQUVPLGdCQUFnQixDQUN0QixRQUFnQixFQUNoQixtQkFBNkI7UUFFN0IsT0FBTyxtQkFBbUIsQ0FBQyxJQUFJLENBQUMsQ0FBQyxVQUFVLEVBQUUsRUFBRTtZQUM3QyxNQUFNLFlBQVksR0FBRyxnQkFBZ0IsQ0FBQyxVQUFVLENBQUMsSUFBSSxFQUFFLENBQUM7WUFDeEQsT0FBTyxZQUFZLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQ3pDLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVPLFNBQVMsQ0FDZixRQUFnQixFQUNoQixXQUF3QztRQUV4QyxNQUFNLGFBQWEsR0FDakIsY0FBYyxDQUFDLFFBQXVDLENBQUMsQ0FBQztRQUMxRCxNQUFNLGdCQUFnQixHQUFHLGNBQWMsQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUVyRCxPQUFPLGFBQWEsS0FBSyxTQUFTLElBQUksYUFBYSxJQUFJLGdCQUFnQixDQUFDO0lBQzFFLENBQUM7SUFFTyxzQkFBc0IsQ0FDNUIsTUFBYyxFQUNkLFVBQWtCLEVBQ2xCLFFBQWdCLEVBQ2hCLE9BQVk7UUFFWiw0Q0FBNEM7UUFDNUMsSUFBSSxDQUFDLFVBQVU7WUFBRSxPQUFPLElBQUksQ0FBQztRQUU3QixnQ0FBZ0M7UUFDaEMsSUFBSSxRQUFRLEtBQUssT0FBTztZQUFFLE9BQU8sSUFBSSxDQUFDO1FBRXRDLCtDQUErQztRQUMvQyxJQUFJLFVBQVUsS0FBSyxNQUFNO1lBQUUsT0FBTyxJQUFJLENBQUM7UUFFdkMsMkVBQTJFO1FBQzNFLGtEQUFrRDtRQUNsRCxJQUFJLFFBQVEsS0FBSyxXQUFXLEVBQUUsQ0FBQztZQUM3QixPQUFPLEtBQUssQ0FBQztRQUNmLENBQUM7UUFFRCxzREFBc0Q7UUFDdEQsSUFBSSxRQUFRLEtBQUssV0FBVyxFQUFFLENBQUM7WUFDN0IsTUFBTSxJQUFJLEdBQUcsT0FBTyxDQUFDLElBQUksQ0FBQztZQUMxQixJQUNFLElBQUksQ0FBQyxRQUFRLENBQUMsY0FBYyxDQUFDO2dCQUM3QixJQUFJLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQztnQkFDdkIsSUFBSSxDQUFDLFFBQVEsQ0FBQyxXQUFXLENBQUMsRUFDMUIsQ0FBQztnQkFDRCxPQUFPLElBQUksQ0FBQztZQUNkLENBQUM7UUFDSCxDQUFDO1FBRUQsT0FBTyxLQUFLLENBQUM7SUFDZixDQUFDO0lBRUQ7O09BRUc7SUFDSyxLQUFLLENBQUMsbUNBQW1DLENBQy9DLFdBQW1CLEVBQ25CLFFBQWdCO1FBRWhCLElBQUksQ0FBQztZQUNILE1BQU0sWUFBWSxHQUFHLE1BQU0sSUFBSSxDQUFDLE1BQU0sQ0FBQyxlQUFlLENBQUMsU0FBUyxDQUFDO2dCQUMvRCxLQUFLLEVBQUU7b0JBQ0wsV0FBVztvQkFDWCxRQUFRO2lCQUNUO2FBQ0YsQ0FBQyxDQUFDO1lBRUgsT0FBTyxDQUFDLENBQUMsWUFBWSxDQUFDO1FBQ3hCLENBQUM7UUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1lBQ2YsNERBQTREO1lBQzVELE9BQU8sQ0FBQyxLQUFLLENBQUMsaURBQWlELEVBQUUsS0FBSyxDQUFDLENBQUM7WUFDeEUsT0FBTyxLQUFLLENBQUM7UUFDZixDQUFDO0lBQ0gsQ0FBQztJQUVELHNEQUFzRDtJQUN0RCxNQUFNLENBQUMsa0JBQWtCLENBQUMsUUFBZ0I7UUFDeEMsT0FBTyxNQUFNLENBQUMsT0FBTyxDQUFDLGdCQUFnQixDQUFDO2FBQ3BDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLEtBQUssQ0FBQyxFQUFFLEVBQUUsQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxDQUFDO2FBQ2hELEdBQUcsQ0FBQyxDQUFDLENBQUMsVUFBVSxDQUFDLEVBQUUsRUFBRSxDQUFDLFVBQVUsQ0FBQyxDQUFDO0lBQ3ZDLENBQUM7SUFFRCxrRUFBa0U7SUFDbEUsTUFBTSxDQUFDLGlCQUFpQixDQUN0QixRQUFnQixFQUNoQixVQUFrQixFQUNsQixNQUFlLEVBQ2YsZUFBd0I7UUFFeEIsTUFBTSxZQUFZLEdBQUcsZ0JBQWdCLENBQUMsVUFBVSxDQUFDLElBQUksRUFBRSxDQUFDO1FBQ3hELE1BQU0saUJBQWlCLEdBQUcsWUFBWSxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUUxRCxJQUFJLGlCQUFpQjtZQUFFLE9BQU8sSUFBSSxDQUFDO1FBRW5DLDJCQUEyQjtRQUMzQixJQUFJLE1BQU0sSUFBSSxlQUFlLElBQUksTUFBTSxLQUFLLGVBQWUsRUFBRSxDQUFDO1lBQzVELE9BQU8sSUFBSSxDQUFDO1FBQ2QsQ0FBQztRQUVELE9BQU8sS0FBSyxDQUFDO0lBQ2YsQ0FBQztDQUNGLENBQUE7QUE3TFksb0RBQW9COytCQUFwQixvQkFBb0I7SUFEaEMsSUFBQSxtQkFBVSxHQUFFO3lEQUdVLGdCQUFTLG9CQUFULGdCQUFTLG9EQUNaLHNDQUFhLG9CQUFiLHNDQUFhO0dBSHBCLG9CQUFvQixDQTZMaEMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL2F1dGgvZ3VhcmRzL3JvbGUtYmFzZWQtYWNjZXNzLmd1YXJkLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIEluamVjdGFibGUsXG4gIENhbkFjdGl2YXRlLFxuICBFeGVjdXRpb25Db250ZXh0LFxuICBGb3JiaWRkZW5FeGNlcHRpb24sXG59IGZyb20gJ0BuZXN0anMvY29tbW9uJztcbmltcG9ydCB7IFJlZmxlY3RvciB9IGZyb20gJ0BuZXN0anMvY29yZSc7XG5pbXBvcnQgeyBQcmlzbWFTZXJ2aWNlIH0gZnJvbSAnc3JjL3Byb3ZpZGVycy9wcmlzbWEtY2xpZW50LnByb3ZpZGVyJztcblxuLy8gRGVmaW5lIHJvbGUgaGllcmFyY2h5IC0gaGlnaGVyIG51bWJlcnMgaGF2ZSBtb3JlIHBlcm1pc3Npb25zXG5jb25zdCBST0xFX0hJRVJBUkNIWSA9IHtcbiAgY2xpZW50OiAwLFxuICB0aGVyYXBpc3Q6IDEsXG4gIG1vZGVyYXRvcjogMixcbiAgYWRtaW46IDMsXG59O1xuXG4vLyBEZWZpbmUgcm9sZS1iYXNlZCBwZXJtaXNzaW9ucyBmb3IgZGlmZmVyZW50IHJlc291cmNlc1xuY29uc3QgUk9MRV9QRVJNSVNTSU9OUyA9IHtcbiAgLy8gVXNlciBtYW5hZ2VtZW50XG4gICd1c2VyczpjcmVhdGUnOiBbJ2FkbWluJ10sXG4gICd1c2VyczpyZWFkOmFsbCc6IFsnYWRtaW4nLCAnbW9kZXJhdG9yJ10sXG4gICd1c2VyczpyZWFkOm93bic6IFsnY2xpZW50JywgJ3RoZXJhcGlzdCcsICdtb2RlcmF0b3InLCAnYWRtaW4nXSxcbiAgJ3VzZXJzOnVwZGF0ZTpvd24nOiBbJ2NsaWVudCcsICd0aGVyYXBpc3QnLCAnbW9kZXJhdG9yJywgJ2FkbWluJ10sXG4gICd1c2Vyczp1cGRhdGU6b3RoZXJzJzogWydhZG1pbiddLFxuICAndXNlcnM6ZGVsZXRlJzogWydhZG1pbiddLFxuICAndXNlcnM6ZGVhY3RpdmF0ZSc6IFsnYWRtaW4nLCAnbW9kZXJhdG9yJ10sXG5cbiAgLy8gVGhlcmFwaXN0IG1hbmFnZW1lbnRcbiAgJ3RoZXJhcGlzdHM6Y3JlYXRlJzogWydhZG1pbiddLFxuICAndGhlcmFwaXN0czpyZWFkOmFsbCc6IFsnYWRtaW4nLCAnbW9kZXJhdG9yJ10sXG4gICd0aGVyYXBpc3RzOnJlYWQ6cHVibGljJzogWydjbGllbnQnLCAndGhlcmFwaXN0JywgJ21vZGVyYXRvcicsICdhZG1pbiddLFxuICAndGhlcmFwaXN0czp1cGRhdGU6b3duJzogWyd0aGVyYXBpc3QnLCAnYWRtaW4nXSxcbiAgJ3RoZXJhcGlzdHM6dXBkYXRlOm90aGVycyc6IFsnYWRtaW4nXSxcbiAgJ3RoZXJhcGlzdHM6YXBwcm92ZSc6IFsnYWRtaW4nXSxcbiAgJ3RoZXJhcGlzdHM6YXNzaWduJzogWydhZG1pbicsICdtb2RlcmF0b3InXSxcblxuICAvLyBDbGllbnQgbWFuYWdlbWVudFxuICAnY2xpZW50czpjcmVhdGUnOiBbJ2FkbWluJ10sXG4gICdjbGllbnRzOnJlYWQ6YWxsJzogWydhZG1pbicsICdtb2RlcmF0b3InXSxcbiAgJ2NsaWVudHM6cmVhZDphc3NpZ25lZCc6IFsndGhlcmFwaXN0J10sXG4gICdjbGllbnRzOnJlYWQ6b3duJzogWydjbGllbnQnLCAnYWRtaW4nXSxcbiAgJ2NsaWVudHM6dXBkYXRlOm93bic6IFsnY2xpZW50JywgJ2FkbWluJ10sXG4gICdjbGllbnRzOnVwZGF0ZTphc3NpZ25lZCc6IFsndGhlcmFwaXN0JywgJ2FkbWluJ10sXG5cbiAgLy8gQXNzZXNzbWVudCBtYW5hZ2VtZW50XG4gICdhc3Nlc3NtZW50czpjcmVhdGU6b3duJzogWydjbGllbnQnXSxcbiAgJ2Fzc2Vzc21lbnRzOnJlYWQ6b3duJzogWydjbGllbnQnLCAnYWRtaW4nXSxcbiAgJ2Fzc2Vzc21lbnRzOnJlYWQ6YXNzaWduZWQnOiBbJ3RoZXJhcGlzdCddLFxuICAnYXNzZXNzbWVudHM6cmVhZDphbGwnOiBbJ2FkbWluJywgJ21vZGVyYXRvciddLFxuICAnYXNzZXNzbWVudHM6dXBkYXRlOm93bic6IFsnY2xpZW50J10sXG4gICdhc3Nlc3NtZW50czpkZWxldGU6b3duJzogWydjbGllbnQnLCAnYWRtaW4nXSxcbiAgJ2Fzc2Vzc21lbnRzOmRlbGV0ZTphbGwnOiBbJ2FkbWluJ10sXG5cbiAgLy8gU2Vzc2lvbiBtYW5hZ2VtZW50XG4gICdzZXNzaW9uczpjcmVhdGUnOiBbJ3RoZXJhcGlzdCcsICdhZG1pbiddLFxuICAnc2Vzc2lvbnM6cmVhZDpvd24nOiBbJ2NsaWVudCcsICd0aGVyYXBpc3QnXSxcbiAgJ3Nlc3Npb25zOnJlYWQ6YWxsJzogWydhZG1pbicsICdtb2RlcmF0b3InXSxcbiAgJ3Nlc3Npb25zOnVwZGF0ZTpvd24nOiBbJ3RoZXJhcGlzdCddLFxuICAnc2Vzc2lvbnM6Y2FuY2VsOm93bic6IFsnY2xpZW50JywgJ3RoZXJhcGlzdCddLFxuICAnc2Vzc2lvbnM6Y2FuY2VsOmFsbCc6IFsnYWRtaW4nXSxcblxuICAvLyBNZXNzYWdpbmdcbiAgJ21lc3NhZ2VzOmNyZWF0ZSc6IFsnY2xpZW50JywgJ3RoZXJhcGlzdCddLFxuICAnbWVzc2FnZXM6cmVhZDpvd24nOiBbJ2NsaWVudCcsICd0aGVyYXBpc3QnXSxcbiAgJ21lc3NhZ2VzOnJlYWQ6YWxsJzogWydhZG1pbicsICdtb2RlcmF0b3InXSxcbiAgJ21lc3NhZ2VzOm1vZGVyYXRlJzogWydtb2RlcmF0b3InLCAnYWRtaW4nXSxcblxuICAvLyBDb21tdW5pdHkgbWFuYWdlbWVudFxuICAnY29tbXVuaXRpZXM6Y3JlYXRlJzogWydhZG1pbiddLFxuICAnY29tbXVuaXRpZXM6cmVhZDphbGwnOiBbJ2NsaWVudCcsICd0aGVyYXBpc3QnLCAnbW9kZXJhdG9yJywgJ2FkbWluJ10sXG4gICdjb21tdW5pdGllczp1cGRhdGUnOiBbJ2FkbWluJywgJ21vZGVyYXRvciddLFxuICAnY29tbXVuaXRpZXM6bW9kZXJhdGUnOiBbJ21vZGVyYXRvcicsICdhZG1pbiddLFxuICAnY29tbXVuaXRpZXM6am9pbic6IFsnY2xpZW50JywgJ3RoZXJhcGlzdCddLFxuXG4gIC8vIENvbnRlbnQgbWFuYWdlbWVudFxuICAncG9zdHM6Y3JlYXRlJzogWydjbGllbnQnLCAndGhlcmFwaXN0J10sXG4gICdwb3N0czpyZWFkOmFsbCc6IFsnY2xpZW50JywgJ3RoZXJhcGlzdCcsICdtb2RlcmF0b3InLCAnYWRtaW4nXSxcbiAgJ3Bvc3RzOnVwZGF0ZTpvd24nOiBbJ2NsaWVudCcsICd0aGVyYXBpc3QnXSxcbiAgJ3Bvc3RzOmRlbGV0ZTpvd24nOiBbJ2NsaWVudCcsICd0aGVyYXBpc3QnXSxcbiAgJ3Bvc3RzOm1vZGVyYXRlJzogWydtb2RlcmF0b3InLCAnYWRtaW4nXSxcblxuICAvLyBGaWxlIG1hbmFnZW1lbnRcbiAgJ2ZpbGVzOnVwbG9hZDpvd24nOiBbJ2NsaWVudCcsICd0aGVyYXBpc3QnXSxcbiAgJ2ZpbGVzOnJlYWQ6b3duJzogWydjbGllbnQnLCAndGhlcmFwaXN0J10sXG4gICdmaWxlczpyZWFkOmFzc2lnbmVkJzogWyd0aGVyYXBpc3QnXSxcbiAgJ2ZpbGVzOnJlYWQ6YWxsJzogWydhZG1pbiddLFxuICAnZmlsZXM6ZGVsZXRlOm93bic6IFsnY2xpZW50JywgJ3RoZXJhcGlzdCcsICdhZG1pbiddLFxuICAnZmlsZXM6ZGVsZXRlOmFsbCc6IFsnYWRtaW4nXSxcblxuICAvLyBBZG1pbiBmdW5jdGlvbnNcbiAgJ2FkbWluOmFjY2Vzcyc6IFsnYWRtaW4nXSxcbiAgJ2FkbWluOmFuYWx5dGljcyc6IFsnYWRtaW4nLCAnbW9kZXJhdG9yJ10sXG4gICdhZG1pbjpzeXN0ZW0tY29uZmlnJzogWydhZG1pbiddLFxuXG4gIC8vIEJpbGxpbmdcbiAgJ2JpbGxpbmc6Y3JlYXRlJzogWydhZG1pbiddLFxuICAnYmlsbGluZzpyZWFkOm93bic6IFsnY2xpZW50JywgJ3RoZXJhcGlzdCddLFxuICAnYmlsbGluZzpyZWFkOmFsbCc6IFsnYWRtaW4nXSxcbiAgJ2JpbGxpbmc6dXBkYXRlJzogWydhZG1pbiddLFxuXG4gIC8vIE5vdGlmaWNhdGlvbnNcbiAgJ25vdGlmaWNhdGlvbnM6Y3JlYXRlJzogWydhZG1pbicsICdtb2RlcmF0b3InXSxcbiAgJ25vdGlmaWNhdGlvbnM6cmVhZDpvd24nOiBbJ2NsaWVudCcsICd0aGVyYXBpc3QnLCAnbW9kZXJhdG9yJywgJ2FkbWluJ10sXG4gICdub3RpZmljYXRpb25zOnVwZGF0ZTpvd24nOiBbJ2NsaWVudCcsICd0aGVyYXBpc3QnLCAnbW9kZXJhdG9yJywgJ2FkbWluJ10sXG59O1xuXG4vLyBEZWNvcmF0b3IgdG8gZGVmaW5lIHJlcXVpcmVkIHBlcm1pc3Npb25zXG5leHBvcnQgY29uc3QgUmVxdWlyZVBlcm1pc3Npb25zID0gKC4uLnBlcm1pc3Npb25zOiBzdHJpbmdbXSkgPT5cbiAgUmVmbGVjdC5kZWZpbmVNZXRhZGF0YSgncGVybWlzc2lvbnMnLCBwZXJtaXNzaW9ucywgUmVmbGVjdCk7XG5cbi8vIERlY29yYXRvciB0byBkZWZpbmUgbWluaW11bSByb2xlIHJlcXVpcmVkXG5leHBvcnQgY29uc3QgUmVxdWlyZVJvbGUgPSAocm9sZToga2V5b2YgdHlwZW9mIFJPTEVfSElFUkFSQ0hZKSA9PlxuICBSZWZsZWN0LmRlZmluZU1ldGFkYXRhKCdtaW5fcm9sZScsIHJvbGUsIFJlZmxlY3QpO1xuXG4vLyBEZWNvcmF0b3IgdG8gYWxsb3cgcmVzb3VyY2Ugb3duZXIgYWNjZXNzXG5leHBvcnQgY29uc3QgQWxsb3dSZXNvdXJjZU93bmVyID0gKHJlc291cmNlSWRQYXJhbTogc3RyaW5nID0gJ2lkJykgPT5cbiAgUmVmbGVjdC5kZWZpbmVNZXRhZGF0YSgncmVzb3VyY2Vfb3duZXJfcGFyYW0nLCByZXNvdXJjZUlkUGFyYW0sIFJlZmxlY3QpO1xuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgUm9sZUJhc2VkQWNjZXNzR3VhcmQgaW1wbGVtZW50cyBDYW5BY3RpdmF0ZSB7XG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgcmVmbGVjdG9yOiBSZWZsZWN0b3IsXG4gICAgcHJpdmF0ZSBwcmlzbWE6IFByaXNtYVNlcnZpY2UsXG4gICkge31cblxuICBhc3luYyBjYW5BY3RpdmF0ZShjb250ZXh0OiBFeGVjdXRpb25Db250ZXh0KTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgY29uc3QgcmVxdWVzdCA9IGNvbnRleHQuc3dpdGNoVG9IdHRwKCkuZ2V0UmVxdWVzdCgpO1xuICAgIGNvbnN0IHVzZXIgPSByZXF1ZXN0LnVzZXI7XG4gICAgY29uc3QgdXNlclJvbGUgPSByZXF1ZXN0LnVzZXJSb2xlIHx8IHVzZXI/LnJvbGU7XG4gICAgY29uc3QgdXNlcklkID0gcmVxdWVzdC51c2VySWQgfHwgdXNlcj8udXNlcklkO1xuXG4gICAgaWYgKCF1c2VyUm9sZSB8fCAhdXNlcklkKSB7XG4gICAgICAvLyBJZiBubyByb2xlIG9yIHVzZXIgSUQsIGRlbnkgYWNjZXNzICh1bmxlc3MgaXQncyBhIHB1YmxpYyByb3V0ZSlcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICAvLyBDaGVjayBmb3IgcmVxdWlyZWQgcGVybWlzc2lvbnNcbiAgICBjb25zdCByZXF1aXJlZFBlcm1pc3Npb25zID0gdGhpcy5yZWZsZWN0b3IuZ2V0QWxsQW5kT3ZlcnJpZGU8c3RyaW5nW10+KFxuICAgICAgJ3Blcm1pc3Npb25zJyxcbiAgICAgIFtjb250ZXh0LmdldEhhbmRsZXIoKSwgY29udGV4dC5nZXRDbGFzcygpXSxcbiAgICApO1xuXG4gICAgaWYgKHJlcXVpcmVkUGVybWlzc2lvbnMpIHtcbiAgICAgIGNvbnN0IGhhc1Blcm1pc3Npb24gPSB0aGlzLmNoZWNrUGVybWlzc2lvbnMoXG4gICAgICAgIHVzZXJSb2xlLFxuICAgICAgICByZXF1aXJlZFBlcm1pc3Npb25zLFxuICAgICAgKTtcbiAgICAgIGlmICghaGFzUGVybWlzc2lvbikge1xuICAgICAgICB0aHJvdyBuZXcgRm9yYmlkZGVuRXhjZXB0aW9uKCdJbnN1ZmZpY2llbnQgcGVybWlzc2lvbnMnKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBDaGVjayBmb3IgbWluaW11bSByb2xlIHJlcXVpcmVtZW50XG4gICAgY29uc3QgbWluaW11bVJvbGUgPSB0aGlzLnJlZmxlY3Rvci5nZXRBbGxBbmRPdmVycmlkZTxcbiAgICAgIGtleW9mIHR5cGVvZiBST0xFX0hJRVJBUkNIWVxuICAgID4oJ21pbl9yb2xlJywgW2NvbnRleHQuZ2V0SGFuZGxlcigpLCBjb250ZXh0LmdldENsYXNzKCldKTtcblxuICAgIGlmIChtaW5pbXVtUm9sZSkge1xuICAgICAgY29uc3QgaGFzUm9sZSA9IHRoaXMuY2hlY2tSb2xlKHVzZXJSb2xlLCBtaW5pbXVtUm9sZSk7XG4gICAgICBpZiAoIWhhc1JvbGUpIHtcbiAgICAgICAgdGhyb3cgbmV3IEZvcmJpZGRlbkV4Y2VwdGlvbihgTWluaW11bSByb2xlICcke21pbmltdW1Sb2xlfScgcmVxdWlyZWRgKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBDaGVjayBmb3IgcmVzb3VyY2Ugb3duZXIgYWNjZXNzXG4gICAgY29uc3QgcmVzb3VyY2VPd25lclBhcmFtID0gdGhpcy5yZWZsZWN0b3IuZ2V0QWxsQW5kT3ZlcnJpZGU8c3RyaW5nPihcbiAgICAgICdyZXNvdXJjZV9vd25lcl9wYXJhbScsXG4gICAgICBbY29udGV4dC5nZXRIYW5kbGVyKCksIGNvbnRleHQuZ2V0Q2xhc3MoKV0sXG4gICAgKTtcblxuICAgIGlmIChyZXNvdXJjZU93bmVyUGFyYW0pIHtcbiAgICAgIGNvbnN0IHJlc291cmNlSWQgPSByZXF1ZXN0LnBhcmFtc1tyZXNvdXJjZU93bmVyUGFyYW1dO1xuICAgICAgY29uc3QgaXNPd25lciA9IHRoaXMuY2hlY2tSZXNvdXJjZU93bmVyc2hpcChcbiAgICAgICAgdXNlcklkLFxuICAgICAgICByZXNvdXJjZUlkLFxuICAgICAgICB1c2VyUm9sZSxcbiAgICAgICAgcmVxdWVzdCxcbiAgICAgICk7XG4gICAgICBpZiAoIWlzT3duZXIpIHtcbiAgICAgICAgdGhyb3cgbmV3IEZvcmJpZGRlbkV4Y2VwdGlvbignQWNjZXNzIGRlbmllZCAtIG5vdCByZXNvdXJjZSBvd25lcicpO1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vIFNwZWNpYWwgdmFsaWRhdGlvbiBmb3IgdGhlcmFwaXN0LWNsaWVudCByZWxhdGlvbnNoaXBzXG4gICAgaWYgKHVzZXJSb2xlID09PSAndGhlcmFwaXN0Jykge1xuICAgICAgY29uc3QgY2xpZW50SWQgPSByZXF1ZXN0LnBhcmFtcy5jbGllbnRJZCB8fCByZXF1ZXN0LmJvZHk/LmNsaWVudElkO1xuICAgICAgaWYgKGNsaWVudElkKSB7XG4gICAgICAgIGNvbnN0IGlzVmFsaWRSZWxhdGlvbnNoaXAgPSBhd2FpdCB0aGlzLnZhbGlkYXRlVGhlcmFwaXN0Q2xpZW50UmVsYXRpb25zaGlwKFxuICAgICAgICAgIHVzZXJJZCxcbiAgICAgICAgICBjbGllbnRJZCxcbiAgICAgICAgKTtcbiAgICAgICAgaWYgKCFpc1ZhbGlkUmVsYXRpb25zaGlwKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEZvcmJpZGRlbkV4Y2VwdGlvbihcbiAgICAgICAgICAgICdBY2Nlc3MgZGVuaWVkIC0gbm8gYWN0aXZlIHRoZXJhcGlzdC1jbGllbnQgcmVsYXRpb25zaGlwJyxcbiAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIHRydWU7XG4gIH1cblxuICBwcml2YXRlIGNoZWNrUGVybWlzc2lvbnMoXG4gICAgdXNlclJvbGU6IHN0cmluZyxcbiAgICByZXF1aXJlZFBlcm1pc3Npb25zOiBzdHJpbmdbXSxcbiAgKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHJlcXVpcmVkUGVybWlzc2lvbnMuc29tZSgocGVybWlzc2lvbikgPT4ge1xuICAgICAgY29uc3QgYWxsb3dlZFJvbGVzID0gUk9MRV9QRVJNSVNTSU9OU1twZXJtaXNzaW9uXSB8fCBbXTtcbiAgICAgIHJldHVybiBhbGxvd2VkUm9sZXMuaW5jbHVkZXModXNlclJvbGUpO1xuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBjaGVja1JvbGUoXG4gICAgdXNlclJvbGU6IHN0cmluZyxcbiAgICBtaW5pbXVtUm9sZToga2V5b2YgdHlwZW9mIFJPTEVfSElFUkFSQ0hZLFxuICApOiBib29sZWFuIHtcbiAgICBjb25zdCB1c2VyUm9sZUxldmVsID1cbiAgICAgIFJPTEVfSElFUkFSQ0hZW3VzZXJSb2xlIGFzIGtleW9mIHR5cGVvZiBST0xFX0hJRVJBUkNIWV07XG4gICAgY29uc3QgbWluaW11bVJvbGVMZXZlbCA9IFJPTEVfSElFUkFSQ0hZW21pbmltdW1Sb2xlXTtcblxuICAgIHJldHVybiB1c2VyUm9sZUxldmVsICE9PSB1bmRlZmluZWQgJiYgdXNlclJvbGVMZXZlbCA+PSBtaW5pbXVtUm9sZUxldmVsO1xuICB9XG5cbiAgcHJpdmF0ZSBjaGVja1Jlc291cmNlT3duZXJzaGlwKFxuICAgIHVzZXJJZDogc3RyaW5nLFxuICAgIHJlc291cmNlSWQ6IHN0cmluZyxcbiAgICB1c2VyUm9sZTogc3RyaW5nLFxuICAgIHJlcXVlc3Q6IGFueSxcbiAgKTogYm9vbGVhbiB7XG4gICAgLy8gSWYgbm8gcmVzb3VyY2UgSUQgc3BlY2lmaWVkLCBhbGxvdyBhY2Nlc3NcbiAgICBpZiAoIXJlc291cmNlSWQpIHJldHVybiB0cnVlO1xuXG4gICAgLy8gQWRtaW4gY2FuIGFjY2VzcyBhbnkgcmVzb3VyY2VcbiAgICBpZiAodXNlclJvbGUgPT09ICdhZG1pbicpIHJldHVybiB0cnVlO1xuXG4gICAgLy8gQ2hlY2sgaWYgdGhlIHJlc291cmNlIElEIG1hdGNoZXMgdGhlIHVzZXIgSURcbiAgICBpZiAocmVzb3VyY2VJZCA9PT0gdXNlcklkKSByZXR1cm4gdHJ1ZTtcblxuICAgIC8vIEZvciB0aGVyYXBpc3RzLCBkZW55IGFjY2VzcyBoZXJlIC0gc3BlY2lmaWMgdGhlcmFwaXN0LWNsaWVudCB2YWxpZGF0aW9uIFxuICAgIC8vIGlzIGhhbmRsZWQgaW4gdGhlIG1haW4gY2FuQWN0aXZhdGUgbWV0aG9kIGFib3ZlXG4gICAgaWYgKHVzZXJSb2xlID09PSAndGhlcmFwaXN0Jykge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cblxuICAgIC8vIEZvciBtb2RlcmF0b3JzLCBhbGxvdyBhY2Nlc3MgdG8gY29tbXVuaXR5IHJlc291cmNlc1xuICAgIGlmICh1c2VyUm9sZSA9PT0gJ21vZGVyYXRvcicpIHtcbiAgICAgIGNvbnN0IHBhdGggPSByZXF1ZXN0LnBhdGg7XG4gICAgICBpZiAoXG4gICAgICAgIHBhdGguaW5jbHVkZXMoJy9jb21tdW5pdGllcycpIHx8XG4gICAgICAgIHBhdGguaW5jbHVkZXMoJy9wb3N0cycpIHx8XG4gICAgICAgIHBhdGguaW5jbHVkZXMoJy9jb21tZW50cycpXG4gICAgICApIHtcbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG5cbiAgLyoqXG4gICAqIFZhbGlkYXRlIHRoYXQgYSB0aGVyYXBpc3QgaGFzIGFuIGFjdGl2ZSByZWxhdGlvbnNoaXAgd2l0aCBhIGNsaWVudFxuICAgKi9cbiAgcHJpdmF0ZSBhc3luYyB2YWxpZGF0ZVRoZXJhcGlzdENsaWVudFJlbGF0aW9uc2hpcChcbiAgICB0aGVyYXBpc3RJZDogc3RyaW5nLFxuICAgIGNsaWVudElkOiBzdHJpbmcsXG4gICk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCByZWxhdGlvbnNoaXAgPSBhd2FpdCB0aGlzLnByaXNtYS5jbGllbnRUaGVyYXBpc3QuZmluZEZpcnN0KHtcbiAgICAgICAgd2hlcmU6IHtcbiAgICAgICAgICB0aGVyYXBpc3RJZCxcbiAgICAgICAgICBjbGllbnRJZCxcbiAgICAgICAgfSxcbiAgICAgIH0pO1xuXG4gICAgICByZXR1cm4gISFyZWxhdGlvbnNoaXA7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIC8vIExvZyBlcnJvciBhbmQgZGVueSBhY2Nlc3Mgb24gZGF0YWJhc2UgZXJyb3JzIGZvciBzZWN1cml0eVxuICAgICAgY29uc29sZS5lcnJvcignRXJyb3IgdmFsaWRhdGluZyB0aGVyYXBpc3QtY2xpZW50IHJlbGF0aW9uc2hpcDonLCBlcnJvcik7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICB9XG5cbiAgLy8gSGVscGVyIG1ldGhvZCB0byBnZXQgdXNlciBwZXJtaXNzaW9ucyBmb3IgZGVidWdnaW5nXG4gIHN0YXRpYyBnZXRVc2VyUGVybWlzc2lvbnModXNlclJvbGU6IHN0cmluZyk6IHN0cmluZ1tdIHtcbiAgICByZXR1cm4gT2JqZWN0LmVudHJpZXMoUk9MRV9QRVJNSVNTSU9OUylcbiAgICAgIC5maWx0ZXIoKFtfLCByb2xlc10pID0+IHJvbGVzLmluY2x1ZGVzKHVzZXJSb2xlKSlcbiAgICAgIC5tYXAoKFtwZXJtaXNzaW9uXSkgPT4gcGVybWlzc2lvbik7XG4gIH1cblxuICAvLyBIZWxwZXIgbWV0aG9kIHRvIGNoZWNrIGlmIGEgdXNlciBjYW4gYWNjZXNzIGEgc3BlY2lmaWMgcmVzb3VyY2VcbiAgc3RhdGljIGNhbkFjY2Vzc1Jlc291cmNlKFxuICAgIHVzZXJSb2xlOiBzdHJpbmcsXG4gICAgcGVybWlzc2lvbjogc3RyaW5nLFxuICAgIHVzZXJJZD86IHN0cmluZyxcbiAgICByZXNvdXJjZU93bmVySWQ/OiBzdHJpbmcsXG4gICk6IGJvb2xlYW4ge1xuICAgIGNvbnN0IGFsbG93ZWRSb2xlcyA9IFJPTEVfUEVSTUlTU0lPTlNbcGVybWlzc2lvbl0gfHwgW107XG4gICAgY29uc3QgaGFzUm9sZVBlcm1pc3Npb24gPSBhbGxvd2VkUm9sZXMuaW5jbHVkZXModXNlclJvbGUpO1xuXG4gICAgaWYgKGhhc1JvbGVQZXJtaXNzaW9uKSByZXR1cm4gdHJ1ZTtcblxuICAgIC8vIENoZWNrIHJlc291cmNlIG93bmVyc2hpcFxuICAgIGlmICh1c2VySWQgJiYgcmVzb3VyY2VPd25lcklkICYmIHVzZXJJZCA9PT0gcmVzb3VyY2VPd25lcklkKSB7XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG5cbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cbn1cbiJdLCJ2ZXJzaW9uIjozfQ==