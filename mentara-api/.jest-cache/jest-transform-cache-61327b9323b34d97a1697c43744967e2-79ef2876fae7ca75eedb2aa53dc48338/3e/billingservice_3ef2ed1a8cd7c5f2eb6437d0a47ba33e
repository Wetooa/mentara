1094b51af839201743dd4b20512fbc6d
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.BillingService = void 0;
const common_1 = require("@nestjs/common");
const prisma_client_provider_1 = require("src/providers/prisma-client.provider");
const client_1 = require("@prisma/client");
let BillingService = class BillingService {
    prisma;
    constructor(prisma) {
        this.prisma = prisma;
    }
    // Subscription Management
    async createSubscription(data) {
        const plan = await this.prisma.subscriptionPlan.findUnique({
            where: { id: data.planId },
        });
        if (!plan) {
            throw new common_1.NotFoundException(`Subscription plan with ID ${data.planId} not found`);
        }
        const amount = data.billingCycle === client_1.BillingCycle.YEARLY
            ? plan.yearlyPrice || plan.monthlyPrice
            : plan.monthlyPrice;
        const currentPeriodStart = new Date();
        const currentPeriodEnd = new Date();
        if (data.billingCycle === client_1.BillingCycle.YEARLY) {
            currentPeriodEnd.setFullYear(currentPeriodEnd.getFullYear() + 1);
        }
        else {
            currentPeriodEnd.setMonth(currentPeriodEnd.getMonth() + 1);
        }
        return this.prisma.subscription.create({
            data: {
                userId: data.userId,
                planId: data.planId,
                tier: plan.tier,
                billingCycle: data.billingCycle || client_1.BillingCycle.MONTHLY,
                amount,
                currentPeriodStart,
                currentPeriodEnd,
                trialStart: data.trialStart,
                trialEnd: data.trialEnd,
                defaultPaymentMethodId: data.defaultPaymentMethodId,
                status: data.trialStart
                    ? client_1.SubscriptionStatus.TRIALING
                    : client_1.SubscriptionStatus.ACTIVE,
            },
            include: {
                plan: true,
                defaultPaymentMethod: true,
            },
        });
    }
    async findUserSubscription(userId) {
        return this.prisma.subscription.findUnique({
            where: { userId },
            include: {
                plan: true,
                defaultPaymentMethod: true,
                invoices: {
                    orderBy: { createdAt: 'desc' },
                    take: 5,
                },
            },
        });
    }
    async updateSubscription(userId, data) {
        const subscription = await this.findUserSubscription(userId);
        if (!subscription) {
            throw new common_1.NotFoundException(`Subscription for user ${userId} not found`);
        }
        const updateData = { ...data };
        // If changing plan, update amount
        if (data.planId) {
            const plan = await this.prisma.subscriptionPlan.findUnique({
                where: { id: data.planId },
            });
            if (!plan) {
                throw new common_1.NotFoundException(`Subscription plan with ID ${data.planId} not found`);
            }
            updateData.tier = plan.tier;
            updateData.amount =
                data.billingCycle === client_1.BillingCycle.YEARLY
                    ? plan.yearlyPrice || plan.monthlyPrice
                    : plan.monthlyPrice;
        }
        return this.prisma.subscription.update({
            where: { userId },
            data: updateData,
            include: {
                plan: true,
                defaultPaymentMethod: true,
            },
        });
    }
    async cancelSubscription(userId) {
        return this.updateSubscription(userId, {
            status: client_1.SubscriptionStatus.CANCELED,
        });
    }
    // Subscription Plans
    async createSubscriptionPlan(data) {
        return this.prisma.subscriptionPlan.create({
            data,
        });
    }
    async findAllPlans(isActive = true) {
        return this.prisma.subscriptionPlan.findMany({
            where: { isActive },
            orderBy: { monthlyPrice: 'asc' },
        });
    }
    async updatePlan(id, data) {
        return this.prisma.subscriptionPlan.update({
            where: { id },
            data,
        });
    }
    // Payment Methods
    async createPaymentMethod(data) {
        // If this is set as default, unset other default payment methods
        if (data.isDefault) {
            await this.prisma.paymentMethod.updateMany({
                where: { userId: data.userId, isDefault: true },
                data: { isDefault: false },
            });
        }
        return this.prisma.paymentMethod.create({
            data,
        });
    }
    async findUserPaymentMethods(userId) {
        return this.prisma.paymentMethod.findMany({
            where: { userId, isActive: true },
            orderBy: [{ isDefault: 'desc' }, { createdAt: 'desc' }],
        });
    }
    async updatePaymentMethod(id, data) {
        const paymentMethod = await this.prisma.paymentMethod.findUnique({
            where: { id },
        });
        if (!paymentMethod) {
            throw new common_1.NotFoundException(`Payment method with ID ${id} not found`);
        }
        // If setting as default, unset other defaults for this user
        if (data.isDefault) {
            await this.prisma.paymentMethod.updateMany({
                where: { userId: paymentMethod.userId, isDefault: true },
                data: { isDefault: false },
            });
        }
        return this.prisma.paymentMethod.update({
            where: { id },
            data,
        });
    }
    async deletePaymentMethod(id) {
        return this.prisma.paymentMethod.update({
            where: { id },
            data: { isActive: false },
        });
    }
    // Payments
    async createPayment(data) {
        return this.prisma.payment.create({
            data: {
                ...data,
                status: client_1.PaymentStatus.PENDING,
                currency: data.currency || 'USD',
            },
            include: {
                paymentMethod: true,
                subscription: true,
                invoice: true,
            },
        });
    }
    async updatePaymentStatus(id, status, metadata) {
        const updateData = { status };
        if (status === client_1.PaymentStatus.SUCCEEDED) {
            updateData.processedAt = new Date();
        }
        else if (status === client_1.PaymentStatus.FAILED) {
            updateData.failedAt = new Date();
            if (metadata?.failureCode)
                updateData.failureCode = metadata.failureCode;
            if (metadata?.failureMessage)
                updateData.failureMessage = metadata.failureMessage;
        }
        return this.prisma.payment.update({
            where: { id },
            data: updateData,
        });
    }
    async findPayments(subscriptionId, status, startDate, endDate) {
        const where = {};
        if (subscriptionId)
            where.subscriptionId = subscriptionId;
        if (status)
            where.status = status;
        if (startDate)
            where.createdAt = { ...where.createdAt, gte: startDate };
        if (endDate)
            where.createdAt = { ...where.createdAt, lte: endDate };
        return this.prisma.payment.findMany({
            where,
            include: {
                paymentMethod: true,
                subscription: true,
                invoice: true,
            },
            orderBy: { createdAt: 'desc' },
        });
    }
    // Invoices
    async createInvoice(data) {
        const total = data.subtotal + (data.taxAmount || 0) - (data.discountAmount || 0);
        const invoiceNumber = await this.generateInvoiceNumber();
        return this.prisma.invoice.create({
            data: {
                ...data,
                number: invoiceNumber,
                total,
                amountDue: total,
                status: client_1.InvoiceStatus.OPEN,
            },
            include: {
                subscription: true,
                lineItems: true,
            },
        });
    }
    async findInvoices(subscriptionId, status) {
        const where = {};
        if (subscriptionId)
            where.subscriptionId = subscriptionId;
        if (status)
            where.status = status;
        return this.prisma.invoice.findMany({
            where,
            include: {
                subscription: {
                    include: { user: true },
                },
                lineItems: true,
                payments: true,
            },
            orderBy: { createdAt: 'desc' },
        });
    }
    async markInvoiceAsPaid(id) {
        const invoice = await this.prisma.invoice.findUnique({
            where: { id },
            include: { payments: true },
        });
        if (!invoice) {
            throw new common_1.NotFoundException(`Invoice with ID ${id} not found`);
        }
        const totalPaid = invoice.payments
            .filter((p) => p.status === client_1.PaymentStatus.SUCCEEDED)
            .reduce((sum, p) => sum + Number(p.amount), 0);
        return this.prisma.invoice.update({
            where: { id },
            data: {
                status: totalPaid >= Number(invoice.total)
                    ? client_1.InvoiceStatus.PAID
                    : client_1.InvoiceStatus.OPEN,
                amountPaid: totalPaid,
                paidAt: totalPaid >= Number(invoice.total) ? new Date() : null,
            },
        });
    }
    // Discounts
    async createDiscount(data) {
        return this.prisma.discount.create({
            data: {
                ...data,
                validFrom: data.validFrom || new Date(),
            },
        });
    }
    async validateDiscount(code, userId, amount) {
        const discount = await this.prisma.discount.findUnique({
            where: { code },
            include: {
                redemptions: {
                    where: { userId },
                },
            },
        });
        if (!discount || !discount.isActive) {
            throw new common_1.BadRequestException('Invalid discount code');
        }
        const now = new Date();
        if (discount.validUntil && discount.validUntil < now) {
            throw new common_1.BadRequestException('Discount code has expired');
        }
        if (discount.maxUses && discount.currentUses >= discount.maxUses) {
            throw new common_1.BadRequestException('Discount code usage limit reached');
        }
        if (discount.maxUsesPerUser &&
            discount.redemptions.length >= discount.maxUsesPerUser) {
            throw new common_1.BadRequestException('You have already used this discount code');
        }
        const minAmountNum = Number(discount.minAmount);
        if (discount.minAmount && !isNaN(minAmountNum) && amount < minAmountNum) {
            throw new common_1.BadRequestException(`Minimum amount of ${String(discount.minAmount)} required`);
        }
        return discount;
    }
    async redeemDiscount(discountId, userId, amountSaved) {
        await this.prisma.$transaction(async (tx) => {
            // Create redemption record
            await tx.discountRedemption.create({
                data: {
                    discountId,
                    userId,
                    amountSaved,
                },
            });
            // Update discount usage count
            await tx.discount.update({
                where: { id: discountId },
                data: {
                    currentUses: { increment: 1 },
                },
            });
        });
    }
    // Usage Records
    async recordUsage(data) {
        return this.prisma.usageRecord.create({
            data: {
                ...data,
                usageDate: data.usageDate || new Date(),
            },
        });
    }
    async getUsageRecords(subscriptionId, feature, startDate, endDate) {
        const where = { subscriptionId };
        if (feature)
            where.feature = feature;
        if (startDate)
            where.usageDate = { ...where.usageDate, gte: startDate };
        if (endDate)
            where.usageDate = { ...where.usageDate, lte: endDate };
        return this.prisma.usageRecord.findMany({
            where,
            orderBy: { usageDate: 'desc' },
        });
    }
    // Helper methods
    async generateInvoiceNumber() {
        const year = new Date().getFullYear();
        const lastInvoice = await this.prisma.invoice.findFirst({
            where: {
                number: { startsWith: `INV-${year}-` },
            },
            orderBy: { number: 'desc' },
        });
        let nextNumber = 1;
        if (lastInvoice) {
            const parts = lastInvoice.number.split('-');
            if (parts.length >= 3 && parts[2]) {
                const lastNumber = parseInt(parts[2], 10);
                if (!isNaN(lastNumber)) {
                    nextNumber = lastNumber + 1;
                }
            }
        }
        return `INV-${year}-${nextNumber.toString().padStart(6, '0')}`;
    }
    async getBillingStatistics(startDate, endDate) {
        const where = {};
        if (startDate)
            where.createdAt = { ...where.createdAt, gte: startDate };
        if (endDate)
            where.createdAt = { ...where.createdAt, lte: endDate };
        const [totalRevenue, activeSubscriptions, trialSubscriptions, canceledSubscriptions, subscriptionsByTier,] = await Promise.all([
            this.prisma.payment.aggregate({
                where: { ...where, status: client_1.PaymentStatus.SUCCEEDED },
                _sum: { amount: true },
            }),
            this.prisma.subscription.count({
                where: { status: client_1.SubscriptionStatus.ACTIVE },
            }),
            this.prisma.subscription.count({
                where: { status: client_1.SubscriptionStatus.TRIALING },
            }),
            this.prisma.subscription.count({
                where: { status: client_1.SubscriptionStatus.CANCELED },
            }),
            this.prisma.subscription.groupBy({
                by: ['tier'],
                where: { status: client_1.SubscriptionStatus.ACTIVE },
                _count: { tier: true },
            }),
        ]);
        return {
            totalRevenue: totalRevenue._sum.amount || 0,
            activeSubscriptions,
            trialSubscriptions,
            canceledSubscriptions,
            subscriptionsByTier,
        };
    }
};
exports.BillingService = BillingService;
exports.BillingService = BillingService = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [prisma_client_provider_1.PrismaService])
], BillingService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL2JpbGxpbmcvYmlsbGluZy5zZXJ2aWNlLnRzIiwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7OztBQUFBLDJDQUl3QjtBQUN4QixpRkFBcUU7QUFDckUsMkNBUXdCO0FBR2pCLElBQU0sY0FBYyxHQUFwQixNQUFNLGNBQWM7SUFDSTtJQUE3QixZQUE2QixNQUFxQjtRQUFyQixXQUFNLEdBQU4sTUFBTSxDQUFlO0lBQUcsQ0FBQztJQUV0RCwwQkFBMEI7SUFDMUIsS0FBSyxDQUFDLGtCQUFrQixDQUFDLElBT3hCO1FBQ0MsTUFBTSxJQUFJLEdBQUcsTUFBTSxJQUFJLENBQUMsTUFBTSxDQUFDLGdCQUFnQixDQUFDLFVBQVUsQ0FBQztZQUN6RCxLQUFLLEVBQUUsRUFBRSxFQUFFLEVBQUUsSUFBSSxDQUFDLE1BQU0sRUFBRTtTQUMzQixDQUFDLENBQUM7UUFFSCxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUM7WUFDVixNQUFNLElBQUksMEJBQWlCLENBQ3pCLDZCQUE2QixJQUFJLENBQUMsTUFBTSxZQUFZLENBQ3JELENBQUM7UUFDSixDQUFDO1FBRUQsTUFBTSxNQUFNLEdBQ1YsSUFBSSxDQUFDLFlBQVksS0FBSyxxQkFBWSxDQUFDLE1BQU07WUFDdkMsQ0FBQyxDQUFDLElBQUksQ0FBQyxXQUFXLElBQUksSUFBSSxDQUFDLFlBQVk7WUFDdkMsQ0FBQyxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUM7UUFFeEIsTUFBTSxrQkFBa0IsR0FBRyxJQUFJLElBQUksRUFBRSxDQUFDO1FBQ3RDLE1BQU0sZ0JBQWdCLEdBQUcsSUFBSSxJQUFJLEVBQUUsQ0FBQztRQUVwQyxJQUFJLElBQUksQ0FBQyxZQUFZLEtBQUsscUJBQVksQ0FBQyxNQUFNLEVBQUUsQ0FBQztZQUM5QyxnQkFBZ0IsQ0FBQyxXQUFXLENBQUMsZ0JBQWdCLENBQUMsV0FBVyxFQUFFLEdBQUcsQ0FBQyxDQUFDLENBQUM7UUFDbkUs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QWEsQ0FBQyxTQUFTLEVBQUU7Z0JBQ3BELElBQUksRUFBRSxFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUU7YUFDdkIsQ0FBQztZQUNGLElBQUksQ0FBQyxNQUFNLENBQUMsWUFBWSxDQUFDLEtBQUssQ0FBQztnQkFDN0IsS0FBSyxFQUFFLEVBQUUsTUFBTSxFQUFFLDJCQUFrQixDQUFDLE1BQU0sRUFBRTthQUM3QyxDQUFDO1lBQ0YsSUFBSSxDQUFDLE1BQU0sQ0FBQyxZQUFZLENBQUMsS0FBSyxDQUFDO2dCQUM3QixLQUFLLEVBQUUsRUFBRSxNQUFNLEVBQUUsMkJBQWtCLENBQUMsUUFBUSxFQUFFO2FBQy9DLENBQUM7WUFDRixJQUFJLENBQUMsTUFBTSxDQUFDLFlBQVksQ0FBQyxLQUFLLENBQUM7Z0JBQzdCLEtBQUssRUFBRSxFQUFFLE1BQU0sRUFBRSwyQkFBa0IsQ0FBQyxRQUFRLEVBQUU7YUFDL0MsQ0FBQztZQUNGLElBQUksQ0FBQyxNQUFNLENBQUMsWUFBWSxDQUFDLE9BQU8sQ0FBQztnQkFDL0IsRUFBRSxFQUFFLENBQUMsTUFBTSxDQUFDO2dCQUNaLEtBQUssRUFBRSxFQUFFLE1BQU0sRUFBRSwyQkFBa0IsQ0FBQyxNQUFNLEVBQUU7Z0JBQzVDLE1BQU0sRUFBRSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUU7YUFDdkIsQ0FBQztTQUNILENBQUMsQ0FBQztRQUVILE9BQU87WUFDTCxZQUFZLEVBQUUsWUFBWSxDQUFDLElBQUksQ0FBQyxNQUFNLElBQUksQ0FBQztZQUMzQyxtQkFBbUI7WUFDbkIsa0JBQWtCO1lBQ2xCLHFCQUFxQjtZQUNyQixtQkFBbUI7U0FDcEIsQ0FBQztJQUNKLENBQUM7Q0FDRixDQUFBO0FBaGpCWSx3Q0FBYzt5QkFBZCxjQUFjO0lBRDFCLElBQUEsbUJBQVUsR0FBRTtxQ0FFMEIsc0NBQWE7R0FEdkMsY0FBYyxDQWdqQjFCIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9ob21lL3dldG9vYS9Eb2N1bWVudHMvY29kZS9wcm9qZWN0cy9tZW50YXJhL21lbnRhcmEtYXBpL3NyYy9iaWxsaW5nL2JpbGxpbmcuc2VydmljZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBJbmplY3RhYmxlLFxuICBOb3RGb3VuZEV4Y2VwdGlvbixcbiAgQmFkUmVxdWVzdEV4Y2VwdGlvbixcbn0gZnJvbSAnQG5lc3Rqcy9jb21tb24nO1xuaW1wb3J0IHsgUHJpc21hU2VydmljZSB9IGZyb20gJ3NyYy9wcm92aWRlcnMvcHJpc21hLWNsaWVudC5wcm92aWRlcic7XG5pbXBvcnQge1xuICBTdWJzY3JpcHRpb25TdGF0dXMsXG4gIFN1YnNjcmlwdGlvblRpZXIsXG4gIEJpbGxpbmdDeWNsZSxcbiAgUGF5bWVudFN0YXR1cyxcbiAgUGF5bWVudE1ldGhvZFR5cGUsXG4gIEludm9pY2VTdGF0dXMsXG4gIERpc2NvdW50VHlwZSxcbn0gZnJvbSAnQHByaXNtYS9jbGllbnQnO1xuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgQmlsbGluZ1NlcnZpY2Uge1xuICBjb25zdHJ1Y3Rvcihwcml2YXRlIHJlYWRvbmx5IHByaXNtYTogUHJpc21hU2VydmljZSkge31cblxuICAvLyBTdWJzY3JpcHRpb24gTWFuYWdlbWVudFxuICBhc3luYyBjcmVhdGVTdWJzY3JpcHRpb24oZGF0YToge1xuICAgIHVzZXJJZDogc3RyaW5nO1xuICAgIHBsYW5JZDogc3RyaW5nO1xuICAgIGJpbGxpbmdDeWNsZT86IEJpbGxpbmdDeWNsZTtcbiAgICBkZWZhdWx0UGF5bWVudE1ldGhvZElkPzogc3RyaW5nO1xuICAgIHRyaWFsU3RhcnQ/OiBEYXRlO1xuICAgIHRyaWFsRW5kPzogRGF0ZTtcbiAgfSkge1xuICAgIGNvbnN0IHBsYW4gPSBhd2FpdCB0aGlzLnByaXNtYS5zdWJzY3JpcHRpb25QbGFuLmZpbmRVbmlxdWUoe1xuICAgICAgd2hlcmU6IHsgaWQ6IGRhdGEucGxhbklkIH0sXG4gICAgfSk7XG5cbiAgICBpZiAoIXBsYW4pIHtcbiAgICAgIHRocm93IG5ldyBOb3RGb3VuZEV4Y2VwdGlvbihcbiAgICAgICAgYFN1YnNjcmlwdGlvbiBwbGFuIHdpdGggSUQgJHtkYXRhLnBsYW5JZH0gbm90IGZvdW5kYCxcbiAgICAgICk7XG4gICAgfVxuXG4gICAgY29uc3QgYW1vdW50ID1cbiAgICAgIGRhdGEuYmlsbGluZ0N5Y2xlID09PSBCaWxsaW5nQ3ljbGUuWUVBUkxZXG4gICAgICAgID8gcGxhbi55ZWFybHlQcmljZSB8fCBwbGFuLm1vbnRobHlQcmljZVxuICAgICAgICA6IHBsYW4ubW9udGhseVByaWNlO1xuXG4gICAgY29uc3QgY3VycmVudFBlcmlvZFN0YXJ0ID0gbmV3IERhdGUoKTtcbiAgICBjb25zdCBjdXJyZW50UGVyaW9kRW5kID0gbmV3IERhdGUoKTtcblxuICAgIGlmIChkYXRhLmJpbGxpbmdDeWNsZSA9PT0gQmlsbGluZ0N5Y2xlLllFQVJMWSkge1xuICAgICAgY3VycmVudFBlcmlvZEVuZC5zZXRGdWxsWWVhcihjdXJyZW50UGVyaW9kRW5kLmdldEZ1bGxZZWFyKCkgKyAxKTtcbiAgICB9IGVsc2Uge1xuICAgICAgY3VycmVudFBlcmlvZEVuZC5zZXRNb250aChjdXJyZW50UGVyaW9kRW5kLmdldE1vbnRoKCkgKyAxKTtcbiAgICB9XG5cbiAgICByZXR1cm4gdGhpcy5wcmlzbWEuc3Vic2NyaXB0aW9uLmNyZWF0ZSh7XG4gICAgICBkYXRhOiB7XG4gICAgICAgIHVzZXJJZDogZGF0YS51c2VySWQsXG4gICAgICAgIHBsYW5JZDogZGF0YS5wbGFuSWQsXG4gICAgICAgIHRpZXI6IHBsYW4udGllcixcbiAgICAgICAgYmlsbGluZ0N5Y2xlOiBkYXRhLmJpbGxpbmdDeWNsZSB8fCBCaWxsaW5nQ3ljbGUuTU9OVEhMWSxcbiAgICAgICAgYW1vdW50LFxuICAgICAgICBjdXJyZW50UGVyaW9kU3RhcnQsXG4gICAgICAgIGN1cnJlbnRQZXJpb2RFbmQsXG4gICAgICAgIHRyaWFsU3RhcnQ6IGRhdGEudHJpYWxTdGFydCxcbiAgICAgICAgdHJpYWxFbmQ6IGRhdGEudHJpYWxFbmQsXG4gICAgICAgIGRlZmF1bHRQYXltZW50TWV0aG9kSWQ6IGRhdGEuZGVmYXVsdFBheW1lbnRNZXRob2RJZCxcbiAgICAgICAgc3RhdHVzOiBkYXRhLnRyaWFsU3RhcnRcbiAgICAgICAgICA/IFN1YnNjcmlwdGlvblN0YXR1cy5UUklBTElOR1xuICAgICAgICAgIDogU3Vic2NyaXB0aW9uU3RhdHVzLkFDVElWRSxcbiAgICAgIH0sXG4gICAgICBpbmNsdWRlOiB7XG4gICAgICAgIHBsYW46IHRydWUsXG4gICAgICAgIGRlZmF1bHRQYXltZW50TWV0aG9kOiB0cnVlLFxuICAgICAgfSxcbiAgICB9KTtcbiAgfVxuXG4gIGFzeW5jIGZpbmRVc2VyU3Vic2NyaXB0aW9uKHVzZXJJZDogc3RyaW5nKSB7XG4gICAgcmV0dXJuIHRoaXMucHJpc21hLnN1YnNjcmlwdGlvbi5maW5kVW5pcXVlKHtcbiAgICAgIHdoZXJlOiB7IHVzZXJJZCB9LFxuICAgICAgaW5jbHVkZToge1xuICAgICAgICBwbGFuOiB0cnVlLFxuICAgICAgICBkZWZhdWx0UGF5bWVudE1ldGhvZDogdHJ1ZSxcbiAgICAgICAgaW52b2ljZXM6IHtcbiAgICAgICAgICBvcmRlckJ5OiB7IGNyZWF0ZWRBdDogJ2Rlc2MnIH0sXG4gICAgICAgICAgdGFrZTogNSxcbiAgICAgICAgfSxcbiAgICAgIH0sXG4gICAgfSk7XG4gIH1cblxuICBhc3luYyB1cGRhdGVTdWJzY3JpcHRpb24oXG4gICAgdXNlcklkOiBzdHJpbmcsXG4gICAgZGF0YToge1xuICAgICAgcGxhbklkPzogc3RyaW5nO1xuICAgICAgYmlsbGluZ0N5Y2xlPzogQmlsbGluZ0N5Y2xlO1xuICAgICAgc3RhdHVzPzogU3Vic2NyaXB0aW9uU3RhdHVzO1xuICAgICAgZGVmYXVsdFBheW1lbnRNZXRob2RJZD86IHN0cmluZztcbiAgICB9LFxuICApIHtcbiAgICBjb25zdCBzdWJzY3JpcHRpb24gPSBhd2FpdCB0aGlzLmZpbmRVc2VyU3Vic2NyaXB0aW9uKHVzZXJJZCk7XG4gICAgaWYgKCFzdWJzY3JpcHRpb24pIHtcbiAgICAgIHRocm93IG5ldyBOb3RGb3VuZEV4Y2VwdGlvbihgU3Vic2NyaXB0aW9uIGZvciB1c2VyICR7dXNlcklkfSBub3QgZm91bmRgKTtcbiAgICB9XG5cbiAgICBjb25zdCB1cGRhdGVEYXRhOiBhbnkgPSB7IC4uLmRhdGEgfTtcblxuICAgIC8vIElmIGNoYW5naW5nIHBsYW4sIHVwZGF0ZSBhbW91bnRcbiAgICBpZiAoZGF0YS5wbGFuSWQpIHtcbiAgICAgIGNvbnN0IHBsYW4gPSBhd2FpdCB0aGlzLnByaXNtYS5zdWJzY3JpcHRpb25QbGFuLmZpbmRVbmlxdWUoe1xuICAgICAgICB3aGVyZTogeyBpZDogZGF0YS5wbGFuSWQgfSxcbiAgICAgIH0pO1xuICAgICAgaWYgKCFwbGFuKSB7XG4gICAgICAgIHRocm93IG5ldyBOb3RGb3VuZEV4Y2VwdGlvbihcbiAgICAgICAgICBgU3Vic2NyaXB0aW9uIHBsYW4gd2l0aCBJRCAke2RhdGEucGxhbklkfSBub3QgZm91bmRgLFxuICAgICAgICApO1xuICAgICAgfVxuXG4gICAgICB1cGRhdGVEYXRhLnRpZXIgPSBwbGFuLnRpZXI7XG4gICAgICB1cGRhdGVEYXRhLmFtb3VudCA9XG4gICAgICAgIGRhdGEuYmlsbGluZ0N5Y2xlID09PSBCaWxsaW5nQ3ljbGUuWUVBUkxZXG4gICAgICAgICAgPyBwbGFuLnllYXJseVByaWNlIHx8IHBsYW4ubW9udGhseVByaWNlXG4gICAgICAgICAgOiBwbGFuLm1vbnRobHlQcmljZTtcbiAgICB9XG5cbiAgICByZXR1cm4gdGhpcy5wcmlzbWEuc3Vic2NyaXB0aW9uLnVwZGF0ZSh7XG4gICAgICB3aGVyZTogeyB1c2VySWQgfSxcbiAgICAgIGRhdGE6IHVwZGF0ZURhdGEsXG4gICAgICBpbmNsdWRlOiB7XG4gICAgICAgIHBsYW46IHRydWUsXG4gICAgICAgIGRlZmF1bHRQYXltZW50TWV0aG9kOiB0cnVlLFxuICAgICAgfSxcbiAgICB9KTtcbiAgfVxuXG4gIGFzeW5jIGNhbmNlbFN1YnNjcmlwdGlvbih1c2VySWQ6IHN0cmluZykge1xuICAgIHJldHVybiB0aGlzLnVwZGF0ZVN1YnNjcmlwdGlvbih1c2VySWQsIHtcbiAgICAgIHN0YXR1czogU3Vic2NyaXB0aW9uU3RhdHVzLkNBTkNFTEVELFxuICAgIH0pO1xuICB9XG5cbiAgLy8gU3Vic2NyaXB0aW9uIFBsYW5zXG4gIGFzeW5jIGNyZWF0ZVN1YnNjcmlwdGlvblBsYW4oZGF0YToge1xuICAgIG5hbWU6IHN0cmluZztcbiAgICBkZXNjcmlwdGlvbj86IHN0cmluZztcbiAgICB0aWVyOiBTdWJzY3JpcHRpb25UaWVyO1xuICAgIG1vbnRobHlQcmljZTogbnVtYmVyO1xuICAgIHllYXJseVByaWNlPzogbnVtYmVyO1xuICAgIGZlYXR1cmVzOiBhbnk7XG4gICAgbGltaXRzOiBhbnk7XG4gICAgdHJpYWxEYXlzPzogbnVtYmVyO1xuICB9KSB7XG4gICAgcmV0dXJuIHRoaXMucHJpc21hLnN1YnNjcmlwdGlvblBsYW4uY3JlYXRlKHtcbiAgICAgIGRhdGEsXG4gICAgfSk7XG4gIH1cblxuICBhc3luYyBmaW5kQWxsUGxhbnMoaXNBY3RpdmUgPSB0cnVlKSB7XG4gICAgcmV0dXJuIHRoaXMucHJpc21hLnN1YnNjcmlwdGlvblBsYW4uZmluZE1hbnkoe1xuICAgICAgd2hlcmU6IHsgaXNBY3RpdmUgfSxcbiAgICAgIG9yZGVyQnk6IHsgbW9udGhseVByaWNlOiAnYXNjJyB9LFxuICAgIH0pO1xuICB9XG5cbiAgYXN5bmMgdXBkYXRlUGxhbihcbiAgICBpZDogc3RyaW5nLFxuICAgIGRhdGE6IFBhcnRpYWw8e1xuICAgICAgbmFtZTogc3RyaW5nO1xuICAgICAgZGVzY3JpcHRpb246IHN0cmluZztcbiAgICAgIG1vbnRobHlQcmljZTogbnVtYmVyO1xuICAgICAgeWVhcmx5UHJpY2U6IG51bWJlcjtcbiAgICAgIGZlYXR1cmVzOiBhbnk7XG4gICAgICBsaW1pdHM6IGFueTtcbiAgICAgIHRyaWFsRGF5czogbnVtYmVyO1xuICAgICAgaXNBY3RpdmU6IGJvb2xlYW47XG4gICAgfT4sXG4gICkge1xuICAgIHJldHVybiB0aGlzLnByaXNtYS5zdWJzY3JpcHRpb25QbGFuLnVwZGF0ZSh7XG4gICAgICB3aGVyZTogeyBpZCB9LFxuICAgICAgZGF0YSxcbiAgICB9KTtcbiAgfVxuXG4gIC8vIFBheW1lbnQgTWV0aG9kc1xuICBhc3luYyBjcmVhdGVQYXltZW50TWV0aG9kKGRhdGE6IHtcbiAgICB1c2VySWQ6IHN0cmluZztcbiAgICB0eXBlOiBQYXltZW50TWV0aG9kVHlwZTtcbiAgICBjYXJkTGFzdDQ/OiBzdHJpbmc7XG4gICAgY2FyZEJyYW5kPzogc3RyaW5nO1xuICAgIGNhcmRFeHBNb250aD86IG51bWJlcjtcbiAgICBjYXJkRXhwWWVhcj86IG51bWJlcjtcbiAgICBzdHJpcGVQYXltZW50TWV0aG9kSWQ/OiBzdHJpbmc7XG4gICAgaXNEZWZhdWx0PzogYm9vbGVhbjtcbiAgfSkge1xuICAgIC8vIElmIHRoaXMgaXMgc2V0IGFzIGRlZmF1bHQsIHVuc2V0IG90aGVyIGRlZmF1bHQgcGF5bWVudCBtZXRob2RzXG4gICAgaWYgKGRhdGEuaXNEZWZhdWx0KSB7XG4gICAgICBhd2FpdCB0aGlzLnByaXNtYS5wYXltZW50TWV0aG9kLnVwZGF0ZU1hbnkoe1xuICAgICAgICB3aGVyZTogeyB1c2VySWQ6IGRhdGEudXNlcklkLCBpc0RlZmF1bHQ6IHRydWUgfSxcbiAgICAgICAgZGF0YTogeyBpc0RlZmF1bHQ6IGZhbHNlIH0sXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICByZXR1cm4gdGhpcy5wcmlzbWEucGF5bWVudE1ldGhvZC5jcmVhdGUoe1xuICAgICAgZGF0YSxcbiAgICB9KTtcbiAgfVxuXG4gIGFzeW5jIGZpbmRVc2VyUGF5bWVudE1ldGhvZHModXNlcklkOiBzdHJpbmcpIHtcbiAgICByZXR1cm4gdGhpcy5wcmlzbWEucGF5bWVudE1ldGhvZC5maW5kTWFueSh7XG4gICAgICB3aGVyZTogeyB1c2VySWQsIGlzQWN0aXZlOiB0cnVlIH0sXG4gICAgICBvcmRlckJ5OiBbeyBpc0RlZmF1bHQ6ICdkZXNjJyB9LCB7IGNyZWF0ZWRBdDogJ2Rlc2MnIH1dLFxuICAgIH0pO1xuICB9XG5cbiAgYXN5bmMgdXBkYXRlUGF5bWVudE1ldGhvZChcbiAgICBpZDogc3RyaW5nLFxuICAgIGRhdGE6IFBhcnRpYWw8e1xuICAgICAgaXNEZWZhdWx0OiBib29sZWFuO1xuICAgICAgaXNBY3RpdmU6IGJvb2xlYW47XG4gICAgfT4sXG4gICkge1xuICAgIGNvbnN0IHBheW1lbnRNZXRob2QgPSBhd2FpdCB0aGlzLnByaXNtYS5wYXltZW50TWV0aG9kLmZpbmRVbmlxdWUoe1xuICAgICAgd2hlcmU6IHsgaWQgfSxcbiAgICB9KTtcblxuICAgIGlmICghcGF5bWVudE1ldGhvZCkge1xuICAgICAgdGhyb3cgbmV3IE5vdEZvdW5kRXhjZXB0aW9uKGBQYXltZW50IG1ldGhvZCB3aXRoIElEICR7aWR9IG5vdCBmb3VuZGApO1xuICAgIH1cblxuICAgIC8vIElmIHNldHRpbmcgYXMgZGVmYXVsdCwgdW5zZXQgb3RoZXIgZGVmYXVsdHMgZm9yIHRoaXMgdXNlclxuICAgIGlmIChkYXRhLmlzRGVmYXVsdCkge1xuICAgICAgYXdhaXQgdGhpcy5wcmlzbWEucGF5bWVudE1ldGhvZC51cGRhdGVNYW55KHtcbiAgICAgICAgd2hlcmU6IHsgdXNlcklkOiBwYXltZW50TWV0aG9kLnVzZXJJZCwgaXNEZWZhdWx0OiB0cnVlIH0sXG4gICAgICAgIGRhdGE6IHsgaXNEZWZhdWx0OiBmYWxzZSB9LFxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXMucHJpc21hLnBheW1lbnRNZXRob2QudXBkYXRlKHtcbiAgICAgIHdoZXJlOiB7IGlkIH0sXG4gICAgICBkYXRhLFxuICAgIH0pO1xuICB9XG5cbiAgYXN5bmMgZGVsZXRlUGF5bWVudE1ldGhvZChpZDogc3RyaW5nKSB7XG4gICAgcmV0dXJuIHRoaXMucHJpc21hLnBheW1lbnRNZXRob2QudXBkYXRlKHtcbiAgICAgIHdoZXJlOiB7IGlkIH0sXG4gICAgICBkYXRhOiB7IGlzQWN0aXZlOiBmYWxzZSB9LFxuICAgIH0pO1xuICB9XG5cbiAgLy8gUGF5bWVudHNcbiAgYXN5bmMgY3JlYXRlUGF5bWVudChkYXRhOiB7XG4gICAgYW1vdW50OiBudW1iZXI7XG4gICAgY3VycmVuY3k/OiBzdHJpbmc7XG4gICAgcGF5bWVudE1ldGhvZElkPzogc3RyaW5nO1xuICAgIHN1YnNjcmlwdGlvbklkPzogc3RyaW5nO1xuICAgIGludm9pY2VJZD86IHN0cmluZztcbiAgICBtZWV0aW5nSWQ/OiBzdHJpbmc7XG4gICAgZGVzY3JpcHRpb24/OiBzdHJpbmc7XG4gICAgcHJvdmlkZXJQYXltZW50SWQ/OiBzdHJpbmc7XG4gIH0pIHtcbiAgICByZXR1cm4gdGhpcy5wcmlzbWEucGF5bWVudC5jcmVhdGUoe1xuICAgICAgZGF0YToge1xuICAgICAgICAuLi5kYXRhLFxuICAgICAgICBzdGF0dXM6IFBheW1lbnRTdGF0dXMuUEVORElORyxcbiAgICAgICAgY3VycmVuY3k6IGRhdGEuY3VycmVuY3kgfHwgJ1VTRCcsXG4gICAgICB9LFxuICAgICAgaW5jbHVkZToge1xuICAgICAgICBwYXltZW50TWV0aG9kOiB0cnVlLFxuICAgICAgICBzdWJzY3JpcHRpb246IHRydWUsXG4gICAgICAgIGludm9pY2U6IHRydWUsXG4gICAgICB9LFxuICAgIH0pO1xuICB9XG5cbiAgYXN5bmMgdXBkYXRlUGF5bWVudFN0YXR1cyhpZDogc3RyaW5nLCBzdGF0dXM6IFBheW1lbnRTdGF0dXMsIG1ldGFkYXRhPzogYW55KSB7XG4gICAgY29uc3QgdXBkYXRlRGF0YTogYW55ID0geyBzdGF0dXMgfTtcblxuICAgIGlmIChzdGF0dXMgPT09IFBheW1lbnRTdGF0dXMuU1VDQ0VFREVEKSB7XG4gICAgICB1cGRhdGVEYXRhLnByb2Nlc3NlZEF0ID0gbmV3IERhdGUoKTtcbiAgICB9IGVsc2UgaWYgKHN0YXR1cyA9PT0gUGF5bWVudFN0YXR1cy5GQUlMRUQpIHtcbiAgICAgIHVwZGF0ZURhdGEuZmFpbGVkQXQgPSBuZXcgRGF0ZSgpO1xuICAgICAgaWYgKG1ldGFkYXRhPy5mYWlsdXJlQ29kZSkgdXBkYXRlRGF0YS5mYWlsdXJlQ29kZSA9IG1ldGFkYXRhLmZhaWx1cmVDb2RlO1xuICAgICAgaWYgKG1ldGFkYXRhPy5mYWlsdXJlTWVzc2FnZSlcbiAgICAgICAgdXBkYXRlRGF0YS5mYWlsdXJlTWVzc2FnZSA9IG1ldGFkYXRhLmZhaWx1cmVNZXNzYWdlO1xuICAgIH1cblxuICAgIHJldHVybiB0aGlzLnByaXNtYS5wYXltZW50LnVwZGF0ZSh7XG4gICAgICB3aGVyZTogeyBpZCB9LFxuICAgICAgZGF0YTogdXBkYXRlRGF0YSxcbiAgICB9KTtcbiAgfVxuXG4gIGFzeW5jIGZpbmRQYXltZW50cyhcbiAgICBzdWJzY3JpcHRpb25JZD86IHN0cmluZyxcbiAgICBzdGF0dXM/OiBQYXltZW50U3RhdHVzLFxuICAgIHN0YXJ0RGF0ZT86IERhdGUsXG4gICAgZW5kRGF0ZT86IERhdGUsXG4gICkge1xuICAgIGNvbnN0IHdoZXJlOiBhbnkgPSB7fTtcblxuICAgIGlmIChzdWJzY3JpcHRpb25JZCkgd2hlcmUuc3Vic2NyaXB0aW9uSWQgPSBzdWJzY3JpcHRpb25JZDtcbiAgICBpZiAoc3RhdHVzKSB3aGVyZS5zdGF0dXMgPSBzdGF0dXM7XG4gICAgaWYgKHN0YXJ0RGF0ZSkgd2hlcmUuY3JlYXRlZEF0ID0geyAuLi53aGVyZS5jcmVhdGVkQXQsIGd0ZTogc3RhcnREYXRlIH07XG4gICAgaWYgKGVuZERhdGUpIHdoZXJlLmNyZWF0ZWRBdCA9IHsgLi4ud2hlcmUuY3JlYXRlZEF0LCBsdGU6IGVuZERhdGUgfTtcblxuICAgIHJldHVybiB0aGlzLnByaXNtYS5wYXltZW50LmZpbmRNYW55KHtcbiAgICAgIHdoZXJlLFxuICAgICAgaW5jbHVkZToge1xuICAgICAgICBwYXltZW50TWV0aG9kOiB0cnVlLFxuICAgICAgICBzdWJzY3JpcHRpb246IHRydWUsXG4gICAgICAgIGludm9pY2U6IHRydWUsXG4gICAgICB9LFxuICAgICAgb3JkZXJCeTogeyBjcmVhdGVkQXQ6ICdkZXNjJyB9LFxuICAgIH0pO1xuICB9XG5cbiAgLy8gSW52b2ljZXNcbiAgYXN5bmMgY3JlYXRlSW52b2ljZShkYXRhOiB7XG4gICAgc3Vic2NyaXB0aW9uSWQ6IHN0cmluZztcbiAgICBzdWJ0b3RhbDogbnVtYmVyO1xuICAgIHRheEFtb3VudD86IG51bWJlcjtcbiAgICBkaXNjb3VudEFtb3VudD86IG51bWJlcjtcbiAgICBkdWVEYXRlOiBEYXRlO1xuICAgIGJpbGxpbmdBZGRyZXNzPzogYW55O1xuICB9KSB7XG4gICAgY29uc3QgdG90YWwgPVxuICAgICAgZGF0YS5zdWJ0b3RhbCArIChkYXRhLnRheEFtb3VudCB8fCAwKSAtIChkYXRhLmRpc2NvdW50QW1vdW50IHx8IDApO1xuICAgIGNvbnN0IGludm9pY2VOdW1iZXIgPSBhd2FpdCB0aGlzLmdlbmVyYXRlSW52b2ljZU51bWJlcigpO1xuXG4gICAgcmV0dXJuIHRoaXMucHJpc21hLmludm9pY2UuY3JlYXRlKHtcbiAgICAgIGRhdGE6IHtcbiAgICAgICAgLi4uZGF0YSxcbiAgICAgICAgbnVtYmVyOiBpbnZvaWNlTnVtYmVyLFxuICAgICAgICB0b3RhbCxcbiAgICAgICAgYW1vdW50RHVlOiB0b3RhbCxcbiAgICAgICAgc3RhdHVzOiBJbnZvaWNlU3RhdHVzLk9QRU4sXG4gICAgICB9LFxuICAgICAgaW5jbHVkZToge1xuICAgICAgICBzdWJzY3JpcHRpb246IHRydWUsXG4gICAgICAgIGxpbmVJdGVtczogdHJ1ZSxcbiAgICAgIH0sXG4gICAgfSk7XG4gIH1cblxuICBhc3luYyBmaW5kSW52b2ljZXMoc3Vic2NyaXB0aW9uSWQ/OiBzdHJpbmcsIHN0YXR1cz86IEludm9pY2VTdGF0dXMpIHtcbiAgICBjb25zdCB3aGVyZTogYW55ID0ge307XG5cbiAgICBpZiAoc3Vic2NyaXB0aW9uSWQpIHdoZXJlLnN1YnNjcmlwdGlvbklkID0gc3Vic2NyaXB0aW9uSWQ7XG4gICAgaWYgKHN0YXR1cykgd2hlcmUuc3RhdHVzID0gc3RhdHVzO1xuXG4gICAgcmV0dXJuIHRoaXMucHJpc21hLmludm9pY2UuZmluZE1hbnkoe1xuICAgICAgd2hlcmUsXG4gICAgICBpbmNsdWRlOiB7XG4gICAgICAgIHN1YnNjcmlwdGlvbjoge1xuICAgICAgICAgIGluY2x1ZGU6IHsgdXNlcjogdHJ1ZSB9LFxuICAgICAgICB9LFxuICAgICAgICBsaW5lSXRlbXM6IHRydWUsXG4gICAgICAgIHBheW1lbnRzOiB0cnVlLFxuICAgICAgfSxcbiAgICAgIG9yZGVyQnk6IHsgY3JlYXRlZEF0OiAnZGVzYycgfSxcbiAgICB9KTtcbiAgfVxuXG4gIGFzeW5jIG1hcmtJbnZvaWNlQXNQYWlkKGlkOiBzdHJpbmcpIHtcbiAgICBjb25zdCBpbnZvaWNlID0gYXdhaXQgdGhpcy5wcmlzbWEuaW52b2ljZS5maW5kVW5pcXVlKHtcbiAgICAgIHdoZXJlOiB7IGlkIH0sXG4gICAgICBpbmNsdWRlOiB7IHBheW1lbnRzOiB0cnVlIH0sXG4gICAgfSk7XG5cbiAgICBpZiAoIWludm9pY2UpIHtcbiAgICAgIHRocm93IG5ldyBOb3RGb3VuZEV4Y2VwdGlvbihgSW52b2ljZSB3aXRoIElEICR7aWR9IG5vdCBmb3VuZGApO1xuICAgIH1cblxuICAgIGNvbnN0IHRvdGFsUGFpZCA9IGludm9pY2UucGF5bWVudHNcbiAgICAgIC5maWx0ZXIoKHApID0+IHAuc3RhdHVzID09PSBQYXltZW50U3RhdHVzLlNVQ0NFRURFRClcbiAgICAgIC5yZWR1Y2UoKHN1bSwgcCkgPT4gc3VtICsgTnVtYmVyKHAuYW1vdW50KSwgMCk7XG5cbiAgICByZXR1cm4gdGhpcy5wcmlzbWEuaW52b2ljZS51cGRhdGUoe1xuICAgICAgd2hlcmU6IHsgaWQgfSxcbiAgICAgIGRhdGE6IHtcbiAgICAgICAgc3RhdHVzOlxuICAgICAgICAgIHRvdGFsUGFpZCA+PSBOdW1iZXIoaW52b2ljZS50b3RhbClcbiAgICAgICAgICAgID8gSW52b2ljZVN0YXR1cy5QQUlEXG4gICAgICAgICAgICA6IEludm9pY2VTdGF0dXMuT1BFTixcbiAgICAgICAgYW1vdW50UGFpZDogdG90YWxQYWlkLFxuICAgICAgICBwYWlkQXQ6IHRvdGFsUGFpZCA+PSBOdW1iZXIoaW52b2ljZS50b3RhbCkgPyBuZXcgRGF0ZSgpIDogbnVsbCxcbiAgICAgIH0sXG4gICAgfSk7XG4gIH1cblxuICAvLyBEaXNjb3VudHNcbiAgYXN5bmMgY3JlYXRlRGlzY291bnQoZGF0YToge1xuICAgIGNvZGU/OiBzdHJpbmc7XG4gICAgbmFtZTogc3RyaW5nO1xuICAgIGRlc2NyaXB0aW9uPzogc3RyaW5nO1xuICAgIHR5cGU6IERpc2NvdW50VHlwZTtcbiAgICBwZXJjZW50T2ZmPzogbnVtYmVyO1xuICAgIGFtb3VudE9mZj86IG51bWJlcjtcbiAgICB2YWxpZEZyb20/OiBEYXRlO1xuICAgIHZhbGlkVW50aWw/OiBEYXRlO1xuICAgIG1heFVzZXM/OiBudW1iZXI7XG4gICAgbWF4VXNlc1BlclVzZXI/OiBudW1iZXI7XG4gICAgYXBwbGljYWJsZVRpZXJzPzogU3Vic2NyaXB0aW9uVGllcltdO1xuICAgIG1pbkFtb3VudD86IG51bWJlcjtcbiAgfSkge1xuICAgIHJldHVybiB0aGlzLnByaXNtYS5kaXNjb3VudC5jcmVhdGUoe1xuICAgICAgZGF0YToge1xuICAgICAgICAuLi5kYXRhLFxuICAgICAgICB2YWxpZEZyb206IGRhdGEudmFsaWRGcm9tIHx8IG5ldyBEYXRlKCksXG4gICAgICB9LFxuICAgIH0pO1xuICB9XG5cbiAgYXN5bmMgdmFsaWRhdGVEaXNjb3VudChjb2RlOiBzdHJpbmcsIHVzZXJJZDogc3RyaW5nLCBhbW91bnQ6IG51bWJlcikge1xuICAgIGNvbnN0IGRpc2NvdW50ID0gYXdhaXQgdGhpcy5wcmlzbWEuZGlzY291bnQuZmluZFVuaXF1ZSh7XG4gICAgICB3aGVyZTogeyBjb2RlIH0sXG4gICAgICBpbmNsdWRlOiB7XG4gICAgICAgIHJlZGVtcHRpb25zOiB7XG4gICAgICAgICAgd2hlcmU6IHsgdXNlcklkIH0sXG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgaWYgKCFkaXNjb3VudCB8fCAhZGlzY291bnQuaXNBY3RpdmUpIHtcbiAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0RXhjZXB0aW9uKCdJbnZhbGlkIGRpc2NvdW50IGNvZGUnKTtcbiAgICB9XG5cbiAgICBjb25zdCBub3cgPSBuZXcgRGF0ZSgpO1xuICAgIGlmIChkaXNjb3VudC52YWxpZFVudGlsICYmIGRpc2NvdW50LnZhbGlkVW50aWwgPCBub3cpIHtcbiAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0RXhjZXB0aW9uKCdEaXNjb3VudCBjb2RlIGhhcyBleHBpcmVkJyk7XG4gICAgfVxuXG4gICAgaWYgKGRpc2NvdW50Lm1heFVzZXMgJiYgZGlzY291bnQuY3VycmVudFVzZXMgPj0gZGlzY291bnQubWF4VXNlcykge1xuICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFeGNlcHRpb24oJ0Rpc2NvdW50IGNvZGUgdXNhZ2UgbGltaXQgcmVhY2hlZCcpO1xuICAgIH1cblxuICAgIGlmIChcbiAgICAgIGRpc2NvdW50Lm1heFVzZXNQZXJVc2VyICYmXG4gICAgICBkaXNjb3VudC5yZWRlbXB0aW9ucy5sZW5ndGggPj0gZGlzY291bnQubWF4VXNlc1BlclVzZXJcbiAgICApIHtcbiAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0RXhjZXB0aW9uKCdZb3UgaGF2ZSBhbHJlYWR5IHVzZWQgdGhpcyBkaXNjb3VudCBjb2RlJyk7XG4gICAgfVxuXG4gICAgY29uc3QgbWluQW1vdW50TnVtID0gTnVtYmVyKGRpc2NvdW50Lm1pbkFtb3VudCk7XG4gICAgaWYgKGRpc2NvdW50Lm1pbkFtb3VudCAmJiAhaXNOYU4obWluQW1vdW50TnVtKSAmJiBhbW91bnQgPCBtaW5BbW91bnROdW0pIHtcbiAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0RXhjZXB0aW9uKFxuICAgICAgICBgTWluaW11bSBhbW91bnQgb2YgJHtTdHJpbmcoZGlzY291bnQubWluQW1vdW50KX0gcmVxdWlyZWRgLFxuICAgICAgKTtcbiAgICB9XG5cbiAgICByZXR1cm4gZGlzY291bnQ7XG4gIH1cblxuICBhc3luYyByZWRlZW1EaXNjb3VudChcbiAgICBkaXNjb3VudElkOiBzdHJpbmcsXG4gICAgdXNlcklkOiBzdHJpbmcsXG4gICAgYW1vdW50U2F2ZWQ6IG51bWJlcixcbiAgKSB7XG4gICAgYXdhaXQgdGhpcy5wcmlzbWEuJHRyYW5zYWN0aW9uKGFzeW5jICh0eCkgPT4ge1xuICAgICAgLy8gQ3JlYXRlIHJlZGVtcHRpb24gcmVjb3JkXG4gICAgICBhd2FpdCB0eC5kaXNjb3VudFJlZGVtcHRpb24uY3JlYXRlKHtcbiAgICAgICAgZGF0YToge1xuICAgICAgICAgIGRpc2NvdW50SWQsXG4gICAgICAgICAgdXNlcklkLFxuICAgICAgICAgIGFtb3VudFNhdmVkLFxuICAgICAgICB9LFxuICAgICAgfSk7XG5cbiAgICAgIC8vIFVwZGF0ZSBkaXNjb3VudCB1c2FnZSBjb3VudFxuICAgICAgYXdhaXQgdHguZGlzY291bnQudXBkYXRlKHtcbiAgICAgICAgd2hlcmU6IHsgaWQ6IGRpc2NvdW50SWQgfSxcbiAgICAgICAgZGF0YToge1xuICAgICAgICAgIGN1cnJlbnRVc2VzOiB7IGluY3JlbWVudDogMSB9LFxuICAgICAgICB9LFxuICAgICAgfSk7XG4gICAgfSk7XG4gIH1cblxuICAvLyBVc2FnZSBSZWNvcmRzXG4gIGFzeW5jIHJlY29yZFVzYWdlKGRhdGE6IHtcbiAgICBzdWJzY3JpcHRpb25JZDogc3RyaW5nO1xuICAgIGZlYXR1cmU6IHN0cmluZztcbiAgICBxdWFudGl0eTogbnVtYmVyO1xuICAgIHVuaXQ6IHN0cmluZztcbiAgICB1c2FnZURhdGU/OiBEYXRlO1xuICAgIG1ldGFkYXRhPzogYW55O1xuICB9KSB7XG4gICAgcmV0dXJuIHRoaXMucHJpc21hLnVzYWdlUmVjb3JkLmNyZWF0ZSh7XG4gICAgICBkYXRhOiB7XG4gICAgICAgIC4uLmRhdGEsXG4gICAgICAgIHVzYWdlRGF0ZTogZGF0YS51c2FnZURhdGUgfHwgbmV3IERhdGUoKSxcbiAgICAgIH0sXG4gICAgfSk7XG4gIH1cblxuICBhc3luYyBnZXRVc2FnZVJlY29yZHMoXG4gICAgc3Vic2NyaXB0aW9uSWQ6IHN0cmluZyxcbiAgICBmZWF0dXJlPzogc3RyaW5nLFxuICAgIHN0YXJ0RGF0ZT86IERhdGUsXG4gICAgZW5kRGF0ZT86IERhdGUsXG4gICkge1xuICAgIGNvbnN0IHdoZXJlOiBhbnkgPSB7IHN1YnNjcmlwdGlvbklkIH07XG5cbiAgICBpZiAoZmVhdHVyZSkgd2hlcmUuZmVhdHVyZSA9IGZlYXR1cmU7XG4gICAgaWYgKHN0YXJ0RGF0ZSkgd2hlcmUudXNhZ2VEYXRlID0geyAuLi53aGVyZS51c2FnZURhdGUsIGd0ZTogc3RhcnREYXRlIH07XG4gICAgaWYgKGVuZERhdGUpIHdoZXJlLnVzYWdlRGF0ZSA9IHsgLi4ud2hlcmUudXNhZ2VEYXRlLCBsdGU6IGVuZERhdGUgfTtcblxuICAgIHJldHVybiB0aGlzLnByaXNtYS51c2FnZVJlY29yZC5maW5kTWFueSh7XG4gICAgICB3aGVyZSxcbiAgICAgIG9yZGVyQnk6IHsgdXNhZ2VEYXRlOiAnZGVzYycgfSxcbiAgICB9KTtcbiAgfVxuXG4gIC8vIEhlbHBlciBtZXRob2RzXG4gIHByaXZhdGUgYXN5bmMgZ2VuZXJhdGVJbnZvaWNlTnVtYmVyKCk6IFByb21pc2U8c3RyaW5nPiB7XG4gICAgY29uc3QgeWVhciA9IG5ldyBEYXRlKCkuZ2V0RnVsbFllYXIoKTtcbiAgICBjb25zdCBsYXN0SW52b2ljZSA9IGF3YWl0IHRoaXMucHJpc21hLmludm9pY2UuZmluZEZpcnN0KHtcbiAgICAgIHdoZXJlOiB7XG4gICAgICAgIG51bWJlcjogeyBzdGFydHNXaXRoOiBgSU5WLSR7eWVhcn0tYCB9LFxuICAgICAgfSxcbiAgICAgIG9yZGVyQnk6IHsgbnVtYmVyOiAnZGVzYycgfSxcbiAgICB9KTtcblxuICAgIGxldCBuZXh0TnVtYmVyID0gMTtcbiAgICBpZiAobGFzdEludm9pY2UpIHtcbiAgICAgIGNvbnN0IHBhcnRzID0gbGFzdEludm9pY2UubnVtYmVyLnNwbGl0KCctJyk7XG4gICAgICBpZiAocGFydHMubGVuZ3RoID49IDMgJiYgcGFydHNbMl0pIHtcbiAgICAgICAgY29uc3QgbGFzdE51bWJlciA9IHBhcnNlSW50KHBhcnRzWzJdLCAxMCk7XG4gICAgICAgIGlmICghaXNOYU4obGFzdE51bWJlcikpIHtcbiAgICAgICAgICBuZXh0TnVtYmVyID0gbGFzdE51bWJlciArIDE7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gYElOVi0ke3llYXJ9LSR7bmV4dE51bWJlci50b1N0cmluZygpLnBhZFN0YXJ0KDYsICcwJyl9YDtcbiAgfVxuXG4gIGFzeW5jIGdldEJpbGxpbmdTdGF0aXN0aWNzKHN0YXJ0RGF0ZT86IERhdGUsIGVuZERhdGU/OiBEYXRlKSB7XG4gICAgY29uc3Qgd2hlcmU6IGFueSA9IHt9O1xuICAgIGlmIChzdGFydERhdGUpIHdoZXJlLmNyZWF0ZWRBdCA9IHsgLi4ud2hlcmUuY3JlYXRlZEF0LCBndGU6IHN0YXJ0RGF0ZSB9O1xuICAgIGlmIChlbmREYXRlKSB3aGVyZS5jcmVhdGVkQXQgPSB7IC4uLndoZXJlLmNyZWF0ZWRBdCwgbHRlOiBlbmREYXRlIH07XG5cbiAgICBjb25zdCBbXG4gICAgICB0b3RhbFJldmVudWUsXG4gICAgICBhY3RpdmVTdWJzY3JpcHRpb25zLFxuICAgICAgdHJpYWxTdWJzY3JpcHRpb25zLFxuICAgICAgY2FuY2VsZWRTdWJzY3JpcHRpb25zLFxuICAgICAgc3Vic2NyaXB0aW9uc0J5VGllcixcbiAgICBdID0gYXdhaXQgUHJvbWlzZS5hbGwoW1xuICAgICAgdGhpcy5wcmlzbWEucGF5bWVudC5hZ2dyZWdhdGUoe1xuICAgICAgICB3aGVyZTogeyAuLi53aGVyZSwgc3RhdHVzOiBQYXltZW50U3RhdHVzLlNVQ0NFRURFRCB9LFxuICAgICAgICBfc3VtOiB7IGFtb3VudDogdHJ1ZSB9LFxuICAgICAgfSksXG4gICAgICB0aGlzLnByaXNtYS5zdWJzY3JpcHRpb24uY291bnQoe1xuICAgICAgICB3aGVyZTogeyBzdGF0dXM6IFN1YnNjcmlwdGlvblN0YXR1cy5BQ1RJVkUgfSxcbiAgICAgIH0pLFxuICAgICAgdGhpcy5wcmlzbWEuc3Vic2NyaXB0aW9uLmNvdW50KHtcbiAgICAgICAgd2hlcmU6IHsgc3RhdHVzOiBTdWJzY3JpcHRpb25TdGF0dXMuVFJJQUxJTkcgfSxcbiAgICAgIH0pLFxuICAgICAgdGhpcy5wcmlzbWEuc3Vic2NyaXB0aW9uLmNvdW50KHtcbiAgICAgICAgd2hlcmU6IHsgc3RhdHVzOiBTdWJzY3JpcHRpb25TdGF0dXMuQ0FOQ0VMRUQgfSxcbiAgICAgIH0pLFxuICAgICAgdGhpcy5wcmlzbWEuc3Vic2NyaXB0aW9uLmdyb3VwQnkoe1xuICAgICAgICBieTogWyd0aWVyJ10sXG4gICAgICAgIHdoZXJlOiB7IHN0YXR1czogU3Vic2NyaXB0aW9uU3RhdHVzLkFDVElWRSB9LFxuICAgICAgICBfY291bnQ6IHsgdGllcjogdHJ1ZSB9LFxuICAgICAgfSksXG4gICAgXSk7XG5cbiAgICByZXR1cm4ge1xuICAgICAgdG90YWxSZXZlbnVlOiB0b3RhbFJldmVudWUuX3N1bS5hbW91bnQgfHwgMCxcbiAgICAgIGFjdGl2ZVN1YnNjcmlwdGlvbnMsXG4gICAgICB0cmlhbFN1YnNjcmlwdGlvbnMsXG4gICAgICBjYW5jZWxlZFN1YnNjcmlwdGlvbnMsXG4gICAgICBzdWJzY3JpcHRpb25zQnlUaWVyLFxuICAgIH07XG4gIH1cbn1cbiJdLCJ2ZXJzaW9uIjozfQ==