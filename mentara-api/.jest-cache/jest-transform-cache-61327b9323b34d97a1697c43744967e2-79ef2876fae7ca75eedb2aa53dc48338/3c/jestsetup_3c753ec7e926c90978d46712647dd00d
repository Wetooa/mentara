99b2cc738413b4905c2fda33687b5294
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.TEST_TIMEOUT = void 0;
// Mock external dependencies
jest.mock('axios');
jest.mock('@clerk/backend', () => ({
    clerkClient: {
        users: {
            getUser: jest.fn(),
            updateUser: jest.fn(),
            deleteUser: jest.fn(),
        },
    },
    createClerkClient: jest.fn(),
}));
require("reflect-metadata");
// Global test setup for unit tests
beforeAll(async () => {
    // Set test environment variables
    process.env.NODE_ENV = 'test';
    process.env.DATABASE_URL =
        process.env.TEST_DATABASE_URL ||
            'postgresql://test:test@localhost:5432/mentara_test';
    // Disable external services in tests
    process.env.DISABLE_CLERK_WEBHOOK = 'true';
    process.env.DISABLE_EMAIL_SERVICE = 'true';
    process.env.DISABLE_AI_SERVICE = 'true';
    // Test-specific configurations
    process.env.JWT_SECRET = 'test-jwt-secret-key';
    process.env.ENCRYPTION_KEY = 'test-encryption-key-32-chars!!';
});
// Note: File upload and AI service mocks will be added per-test as needed
// This prevents global module resolution issues when dependencies aren't installed
// Enhanced console mocking with test insights
const originalConsole = { ...console };
global.console = {
    ...console,
    // Suppress console.log during tests unless explicitly needed
    log: jest.fn((message) => {
        if (process.env.DEBUG_TESTS === 'true') {
            originalConsole.log('[TEST DEBUG]', message);
        }
    }),
    debug: jest.fn(),
    info: jest.fn(),
    warn: (message) => {
        if (process.env.SHOW_WARNINGS === 'true') {
            originalConsole.warn('[TEST WARN]', message);
        }
    },
    error: originalConsole.error.bind(originalConsole), // Always show errors
};
// Setup global test timeout
jest.setTimeout(10000);
// Enhanced cleanup after each test
afterEach(async () => {
    jest.clearAllMocks();
    jest.clearAllTimers();
    // Reset environment variables that might have been modified
    delete process.env.TEST_USER_ID;
    delete process.env.TEST_ROLE;
});
// Global cleanup
afterAll(async () => {
    // Clean up any remaining async operations
    await new Promise((resolve) => setTimeout(resolve, 100));
});
// Test environment validation
if (process.env.JEST_TEST_TYPE === 'integration' &&
    !process.env.DATABASE_URL?.includes('test')) {
    throw new Error('Integration tests must use a test database. DATABASE_URL must contain "test"');
}
// Prevent tests from running against production database
if (process.env.DATABASE_URL?.includes('prod')) {
    throw new Error('Tests cannot run against production database!');
}
// Enhanced test timeouts with categories
exports.TEST_TIMEOUT = {
    UNIT: 5000,
    INTEGRATION: 15000,
    E2E: 30000,
    DATABASE: 20000,
    ASYNC_OPERATION: 10000,
};
// Test performance tracking
const testStartTimes = new Map();
beforeEach(() => {
    const testName = expect.getState().currentTestName;
    testStartTimes.set(testName, Date.now());
});
afterEach(() => {
    const testName = expect.getState().currentTestName;
    const startTime = testStartTimes.get(testName);
    if (startTime && process.env.TRACK_TEST_PERFORMANCE === 'true') {
        const duration = Date.now() - startTime;
        if (duration > 1000) {
            console.warn(`Slow test detected: ${testName} took ${duration}ms`);
        }
    }
    testStartTimes.delete(testName);
});
// Global error handlers for unhandled promises
process.on('unhandledRejection', (reason, promise) => {
    console.error('Unhandled Rejection at:', promise, 'reason:', reason);
});
process.on('uncaughtException', (error) => {
    console.error('Uncaught Exception:', error);
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL3Rlc3QtdXRpbHMvamVzdC5zZXR1cC50cyIsIm1hcHBpbmdzIjoiOzs7QUFvQkEsNkJBQTZCO0FBQzdCLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7QUFDbkIsSUFBSSxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsRUFBRSxHQUFHLEVBQUUsQ0FBQyxDQUFDO0lBQ2pDLFdBQVcsRUFBRTtRQUNYLEtBQUssRUFBRTtZQUNMLE9BQU8sRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO1lBQ2xCLFVBQVUsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO1lBQ3JCLFVBQVUsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO1NBQ3RCO0tBQ0Y7SUFDRCxpQkFBaUIsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO0NBQzdCLENBQUMsQ0FBQyxDQUFDO0FBL0JKLDRCQUEwQjtBQUUxQixtQ0FBbUM7QUFDbkMsU0FBUyxDQUFDLEtBQUssSUFBSSxFQUFFO0lBQ25CLGlDQUFpQztJQUNqQyxPQUFPLENBQUMsR0FBRyxDQUFDLFFBQVEsR0FBRyxNQUFNLENBQUM7SUFDOUIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxZQUFZO1FBQ3RCLE9BQU8sQ0FBQyxHQUFHLENBQUMsaUJBQWlCO1lBQzdCLG9EQUFvRCxDQUFDO0lBRXZELHFDQUFxQztJQUNyQyxPQUFPLENBQUMsR0FBRyxDQUFDLHFCQUFxQixHQUFHLE1BQU0sQ0FBQztJQUMzQyxPQUFPLENBQUMsR0FBRyxDQUFDLHFCQUFxQixHQUFHLE1BQU0sQ0FBQztJQUMzQyxPQUFPLENBQUMsR0FBRyxDQUFDLGtCQUFrQixHQUFHLE1BQU0sQ0FBQztJQUV4QywrQkFBK0I7SUFDL0IsT0FBTyxDQUFDLEdBQUcsQ0FBQyxVQUFVLEdBQUcscUJBQXFCLENBQUM7SUFDL0MsT0FBTyxDQUFDLEdBQUcsQ0FBQyxjQUFjLEdBQUcsZ0NBQWdDLENBQUM7QUFDaEUs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QUcsRUFBRTtJQUNiLE1BQU0sUUFBUSxHQUFHLE1BQU0sQ0FBQyxRQUFRLEVBQUUsQ0FBQyxlQUFlLENBQUM7SUFDbkQsTUFBTSxTQUFTLEdBQUcsY0FBYyxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsQ0FBQztJQUMvQyxJQUFJLFNBQVMsSUFBSSxPQUFPLENBQUMsR0FBRyxDQUFDLHNCQUFzQixLQUFLLE1BQU0sRUFBRSxDQUFDO1FBQy9ELE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxHQUFHLEVBQUUsR0FBRyxTQUFTLENBQUM7UUFDeEMsSUFBSSxRQUFRLEdBQUcsSUFBSSxFQUFFLENBQUM7WUFDcEIsT0FBTyxDQUFDLElBQUksQ0FBQyx1QkFBdUIsUUFBUSxTQUFTLFFBQVEsSUFBSSxDQUFDLENBQUM7UUFDckUsQ0FBQztJQUNILENBQUM7SUFDRCxjQUFjLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxDQUFDO0FBQ2xDLENBQUMsQ0FBQyxDQUFDO0FBRUgsK0NBQStDO0FBQy9DLE9BQU8sQ0FBQyxFQUFFLENBQUMsb0JBQW9CLEVBQUUsQ0FBQyxNQUFNLEVBQUUsT0FBTyxFQUFFLEVBQUU7SUFDbkQsT0FBTyxDQUFDLEtBQUssQ0FBQyx5QkFBeUIsRUFBRSxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sQ0FBQyxDQUFDO0FBQ3ZFLENBQUMsQ0FBQyxDQUFDO0FBRUgsT0FBTyxDQUFDLEVBQUUsQ0FBQyxtQkFBbUIsRUFBRSxDQUFDLEtBQUssRUFBRSxFQUFFO0lBQ3hDLE9BQU8sQ0FBQyxLQUFLLENBQUMscUJBQXFCLEVBQUUsS0FBSyxDQUFDLENBQUM7QUFDOUMsQ0FBQyxDQUFDLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL3Rlc3QtdXRpbHMvamVzdC5zZXR1cC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgJ3JlZmxlY3QtbWV0YWRhdGEnO1xuXG4vLyBHbG9iYWwgdGVzdCBzZXR1cCBmb3IgdW5pdCB0ZXN0c1xuYmVmb3JlQWxsKGFzeW5jICgpID0+IHtcbiAgLy8gU2V0IHRlc3QgZW52aXJvbm1lbnQgdmFyaWFibGVzXG4gIHByb2Nlc3MuZW52Lk5PREVfRU5WID0gJ3Rlc3QnO1xuICBwcm9jZXNzLmVudi5EQVRBQkFTRV9VUkwgPVxuICAgIHByb2Nlc3MuZW52LlRFU1RfREFUQUJBU0VfVVJMIHx8XG4gICAgJ3Bvc3RncmVzcWw6Ly90ZXN0OnRlc3RAbG9jYWxob3N0OjU0MzIvbWVudGFyYV90ZXN0JztcblxuICAvLyBEaXNhYmxlIGV4dGVybmFsIHNlcnZpY2VzIGluIHRlc3RzXG4gIHByb2Nlc3MuZW52LkRJU0FCTEVfQ0xFUktfV0VCSE9PSyA9ICd0cnVlJztcbiAgcHJvY2Vzcy5lbnYuRElTQUJMRV9FTUFJTF9TRVJWSUNFID0gJ3RydWUnO1xuICBwcm9jZXNzLmVudi5ESVNBQkxFX0FJX1NFUlZJQ0UgPSAndHJ1ZSc7XG5cbiAgLy8gVGVzdC1zcGVjaWZpYyBjb25maWd1cmF0aW9uc1xuICBwcm9jZXNzLmVudi5KV1RfU0VDUkVUID0gJ3Rlc3Qtand0LXNlY3JldC1rZXknO1xuICBwcm9jZXNzLmVudi5FTkNSWVBUSU9OX0tFWSA9ICd0ZXN0LWVuY3J5cHRpb24ta2V5LTMyLWNoYXJzISEnO1xufSk7XG5cbi8vIE1vY2sgZXh0ZXJuYWwgZGVwZW5kZW5jaWVzXG5qZXN0Lm1vY2soJ2F4aW9zJyk7XG5qZXN0Lm1vY2soJ0BjbGVyay9iYWNrZW5kJywgKCkgPT4gKHtcbiAgY2xlcmtDbGllbnQ6IHtcbiAgICB1c2Vyczoge1xuICAgICAgZ2V0VXNlcjogamVzdC5mbigpLFxuICAgICAgdXBkYXRlVXNlcjogamVzdC5mbigpLFxuICAgICAgZGVsZXRlVXNlcjogamVzdC5mbigpLFxuICAgIH0sXG4gIH0sXG4gIGNyZWF0ZUNsZXJrQ2xpZW50OiBqZXN0LmZuKCksXG59KSk7XG5cbi8vIE5vdGU6IEZpbGUgdXBsb2FkIGFuZCBBSSBzZXJ2aWNlIG1vY2tzIHdpbGwgYmUgYWRkZWQgcGVyLXRlc3QgYXMgbmVlZGVkXG4vLyBUaGlzIHByZXZlbnRzIGdsb2JhbCBtb2R1bGUgcmVzb2x1dGlvbiBpc3N1ZXMgd2hlbiBkZXBlbmRlbmNpZXMgYXJlbid0IGluc3RhbGxlZFxuXG4vLyBFbmhhbmNlZCBjb25zb2xlIG1vY2tpbmcgd2l0aCB0ZXN0IGluc2lnaHRzXG5jb25zdCBvcmlnaW5hbENvbnNvbGUgPSB7IC4uLmNvbnNvbGUgfTtcbmdsb2JhbC5jb25zb2xlID0ge1xuICAuLi5jb25zb2xlLFxuICAvLyBTdXBwcmVzcyBjb25zb2xlLmxvZyBkdXJpbmcgdGVzdHMgdW5sZXNzIGV4cGxpY2l0bHkgbmVlZGVkXG4gIGxvZzogamVzdC5mbigobWVzc2FnZSkgPT4ge1xuICAgIGlmIChwcm9jZXNzLmVudi5ERUJVR19URVNUUyA9PT0gJ3RydWUnKSB7XG4gICAgICBvcmlnaW5hbENvbnNvbGUubG9nKCdbVEVTVCBERUJVR10nLCBtZXNzYWdlKTtcbiAgICB9XG4gIH0pLFxuICBkZWJ1ZzogamVzdC5mbigpLFxuICBpbmZvOiBqZXN0LmZuKCksXG4gIHdhcm46IChtZXNzYWdlKSA9PiB7XG4gICAgaWYgKHByb2Nlc3MuZW52LlNIT1dfV0FSTklOR1MgPT09ICd0cnVlJykge1xuICAgICAgb3JpZ2luYWxDb25zb2xlLndhcm4oJ1tURVNUIFdBUk5dJywgbWVzc2FnZSk7XG4gICAgfVxuICB9LFxuICBlcnJvcjogb3JpZ2luYWxDb25zb2xlLmVycm9yLmJpbmQob3JpZ2luYWxDb25zb2xlKSwgLy8gQWx3YXlzIHNob3cgZXJyb3JzXG59O1xuXG4vLyBTZXR1cCBnbG9iYWwgdGVzdCB0aW1lb3V0XG5qZXN0LnNldFRpbWVvdXQoMTAwMDApO1xuXG4vLyBFbmhhbmNlZCBjbGVhbnVwIGFmdGVyIGVhY2ggdGVzdFxuYWZ0ZXJFYWNoKGFzeW5jICgpID0+IHtcbiAgamVzdC5jbGVhckFsbE1vY2tzKCk7XG4gIGplc3QuY2xlYXJBbGxUaW1lcnMoKTtcblxuICAvLyBSZXNldCBlbnZpcm9ubWVudCB2YXJpYWJsZXMgdGhhdCBtaWdodCBoYXZlIGJlZW4gbW9kaWZpZWRcbiAgZGVsZXRlIHByb2Nlc3MuZW52LlRFU1RfVVNFUl9JRDtcbiAgZGVsZXRlIHByb2Nlc3MuZW52LlRFU1RfUk9MRTtcbn0pO1xuXG4vLyBHbG9iYWwgY2xlYW51cFxuYWZ0ZXJBbGwoYXN5bmMgKCkgPT4ge1xuICAvLyBDbGVhbiB1cCBhbnkgcmVtYWluaW5nIGFzeW5jIG9wZXJhdGlvbnNcbiAgYXdhaXQgbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHNldFRpbWVvdXQocmVzb2x2ZSwgMTAwKSk7XG59KTtcblxuLy8gVGVzdCBlbnZpcm9ubWVudCB2YWxpZGF0aW9uXG5pZiAoXG4gIHByb2Nlc3MuZW52LkpFU1RfVEVTVF9UWVBFID09PSAnaW50ZWdyYXRpb24nICYmXG4gICFwcm9jZXNzLmVudi5EQVRBQkFTRV9VUkw/LmluY2x1ZGVzKCd0ZXN0Jylcbikge1xuICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgJ0ludGVncmF0aW9uIHRlc3RzIG11c3QgdXNlIGEgdGVzdCBkYXRhYmFzZS4gREFUQUJBU0VfVVJMIG11c3QgY29udGFpbiBcInRlc3RcIicsXG4gICk7XG59XG5cbi8vIFByZXZlbnQgdGVzdHMgZnJvbSBydW5uaW5nIGFnYWluc3QgcHJvZHVjdGlvbiBkYXRhYmFzZVxuaWYgKHByb2Nlc3MuZW52LkRBVEFCQVNFX1VSTD8uaW5jbHVkZXMoJ3Byb2QnKSkge1xuICB0aHJvdyBuZXcgRXJyb3IoJ1Rlc3RzIGNhbm5vdCBydW4gYWdhaW5zdCBwcm9kdWN0aW9uIGRhdGFiYXNlIScpO1xufVxuXG4vLyBHbG9iYWwgdGVzdCBjb25zdGFudHNcbmRlY2xhcmUgZ2xvYmFsIHtcbiAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby1uYW1lc3BhY2VcbiAgbmFtZXNwYWNlIE5vZGVKUyB7XG4gICAgaW50ZXJmYWNlIEdsb2JhbCB7XG4gICAgICB0ZXN0RGI6IGFueTtcbiAgICAgIHRlc3RGYWN0b3J5OiBhbnk7XG4gICAgfVxuICB9XG59XG5cbi8vIEVuaGFuY2VkIHRlc3QgdGltZW91dHMgd2l0aCBjYXRlZ29yaWVzXG5leHBvcnQgY29uc3QgVEVTVF9USU1FT1VUID0ge1xuICBVTklUOiA1MDAwLFxuICBJTlRFR1JBVElPTjogMTUwMDAsXG4gIEUyRTogMzAwMDAsXG4gIERBVEFCQVNFOiAyMDAwMCxcbiAgQVNZTkNfT1BFUkFUSU9OOiAxMDAwMCxcbn07XG5cbi8vIFRlc3QgcGVyZm9ybWFuY2UgdHJhY2tpbmdcbmNvbnN0IHRlc3RTdGFydFRpbWVzID0gbmV3IE1hcCgpO1xuXG5iZWZvcmVFYWNoKCgpID0+IHtcbiAgY29uc3QgdGVzdE5hbWUgPSBleHBlY3QuZ2V0U3RhdGUoKS5jdXJyZW50VGVzdE5hbWU7XG4gIHRlc3RTdGFydFRpbWVzLnNldCh0ZXN0TmFtZSwgRGF0ZS5ub3coKSk7XG59KTtcblxuYWZ0ZXJFYWNoKCgpID0+IHtcbiAgY29uc3QgdGVzdE5hbWUgPSBleHBlY3QuZ2V0U3RhdGUoKS5jdXJyZW50VGVzdE5hbWU7XG4gIGNvbnN0IHN0YXJ0VGltZSA9IHRlc3RTdGFydFRpbWVzLmdldCh0ZXN0TmFtZSk7XG4gIGlmIChzdGFydFRpbWUgJiYgcHJvY2Vzcy5lbnYuVFJBQ0tfVEVTVF9QRVJGT1JNQU5DRSA9PT0gJ3RydWUnKSB7XG4gICAgY29uc3QgZHVyYXRpb24gPSBEYXRlLm5vdygpIC0gc3RhcnRUaW1lO1xuICAgIGlmIChkdXJhdGlvbiA+IDEwMDApIHtcbiAgICAgIGNvbnNvbGUud2FybihgU2xvdyB0ZXN0IGRldGVjdGVkOiAke3Rlc3ROYW1lfSB0b29rICR7ZHVyYXRpb259bXNgKTtcbiAgICB9XG4gIH1cbiAgdGVzdFN0YXJ0VGltZXMuZGVsZXRlKHRlc3ROYW1lKTtcbn0pO1xuXG4vLyBHbG9iYWwgZXJyb3IgaGFuZGxlcnMgZm9yIHVuaGFuZGxlZCBwcm9taXNlc1xucHJvY2Vzcy5vbigndW5oYW5kbGVkUmVqZWN0aW9uJywgKHJlYXNvbiwgcHJvbWlzZSkgPT4ge1xuICBjb25zb2xlLmVycm9yKCdVbmhhbmRsZWQgUmVqZWN0aW9uIGF0OicsIHByb21pc2UsICdyZWFzb246JywgcmVhc29uKTtcbn0pO1xuXG5wcm9jZXNzLm9uKCd1bmNhdWdodEV4Y2VwdGlvbicsIChlcnJvcikgPT4ge1xuICBjb25zb2xlLmVycm9yKCdVbmNhdWdodCBFeGNlcHRpb246JywgZXJyb3IpO1xufSk7XG4iXSwidmVyc2lvbiI6M30=