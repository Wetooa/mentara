9efbc96f87c59d86836aa005c53213b5
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const testing_1 = require("@nestjs/testing");
const request = require("supertest");
const prisma_client_provider_1 = require("../../providers/prisma-client.provider");
const auth_module_1 = require("../../auth/auth.module");
const database_test_setup_1 = require("../database-test.setup");
describe('Auth Integration Tests', () => {
    let app;
    let prisma;
    let moduleRef;
    beforeAll(async () => {
        // Setup test database
        prisma = await database_test_setup_1.DatabaseTestSetup.setupTestDatabase();
        moduleRef = await testing_1.Test.createTestingModule({
            imports: [auth_module_1.AuthModule],
            providers: [
                {
                    provide: prisma_client_provider_1.PrismaService,
                    useValue: prisma,
                },
            ],
        }).compile();
        app = moduleRef.createNestApplication();
        await app.init();
    });
    afterEach(async () => {
        // Clean database after each test
        await database_test_setup_1.DatabaseTestSetup.cleanupDatabase();
    });
    afterAll(async () => {
        await database_test_setup_1.DatabaseTestSetup.stopContainer();
        await app.close();
        await moduleRef.close();
    });
    describe('POST /auth/register/client', () => {
        it('should create a new client successfully', async () => {
            const clientData = {
                user: {
                    firstName: 'John',
                    lastName: 'Doe',
                    email: 'john.doe@example.com',
                    mobile: '+1234567890',
                    address: '123 Main St',
                    birthDate: '1990-01-01',
                },
                hasSeenTherapistRecommendations: false,
            };
            const response = await request(app.getHttpServer())
                .post('/auth/register/client')
                .send(clientData)
                .expect(201);
            expect(response.body).toMatchObject({
                success: true,
                data: expect.objectContaining({
                    id: expect.any(String),
                    user: expect.objectContaining({
                        firstName: 'John',
                        lastName: 'Doe',
                        email: 'john.doe@example.com',
                    }),
                }),
            });
            // Verify in database
            const user = await prisma.user.findUnique({
                where: { email: 'john.doe@example.com' },
                include: { client: true },
            });
            expect(user).toBeTruthy();
            expect(user?.client).toBeTruthy();
            expect(user?.role).toBe('client');
        });
        it('should reject duplicate email registration', async () => {
            // First registration
            await prisma.user.create({
                data: {
                    id: 'existing-user',
                    email: 'existing@example.com',
                    firstName: 'Existing',
                    lastName: 'User',
                    role: 'client',
                },
            });
            const clientData = {
                user: {
                    firstName: 'New',
                    lastName: 'User',
                    email: 'existing@example.com',
                    mobile: '+1234567890',
                },
                hasSeenTherapistRecommendations: false,
            };
            await request(app.getHttpServer())
                .post('/auth/register/client')
                .send(clientData)
                .expect(409);
        });
        it('should validate required fields', async () => {
            const invalidData = {
                user: {
                    firstName: 'John',
                    // Missing required fields
                },
                hasSeenTherapistRecommendations: false,
            };
            await request(app.getHttpServer())
                .post('/auth/register/client')
                .send(invalidData)
                .expect(400);
        });
    });
    describe('POST /auth/register/therapist', () => {
        it('should create a new therapist application', async () => {
            const therapistData = {
                userId: 'therapist-123',
                email: 'therapist@example.com',
                firstName: 'Jane',
                lastName: 'Smith',
                mobile: '+1234567890',
                province: 'Ontario',
                providerType: 'Clinical Psychologist',
                professionalLicenseType: 'Licensed',
                isPRCLicensed: 'yes',
                prcLicenseNumber: 'PRC123456',
                isLicenseActive: 'yes',
                practiceStartDate: '2020-01-01',
                yearsOfExperience: 5,
                areasOfExpertise: ['Anxiety', 'Depression'],
                assessmentTools: ['PHQ-9', 'GAD-7'],
                therapeuticApproachesUsedList: ['CBT', 'DBT'],
                languagesOffered: ['English', 'French'],
                providedOnlineTherapyBefore: 'yes',
                comfortableUsingVideoConferencing: 'yes',
                weeklyAvailability: '20',
                preferredSessionLength: '60',
                accepts: ['Individual', 'Couples'],
                hourlyRate: 150,
                bio: 'Experienced therapist.',
            };
            const response = await request(app.getHttpServer())
                .post('/auth/register/therapist')
                .send(therapistData)
                .expect(201);
            expect(response.body).toMatchObject({
                success: true,
                data: expect.objectContaining({
                    id: expect.any(String),
                    applicationStatus: 'PENDING',
                    email: 'therapist@example.com',
                }),
            });
            // Verify in database
            const therapist = await prisma.therapist.findUnique({
                where: { userId: response.body.data.id },
            });
            expect(therapist).toBeTruthy();
            expect(therapist?.status).toBe('PENDING');
        });
        it('should validate professional license requirements', async () => {
            const invalidTherapistData = {
                userId: 'therapist-123',
                email: 'therapist@example.com',
                firstName: 'Jane',
                lastName: 'Smith',
                // Missing professional license info
            };
            await request(app.getHttpServer())
                .post('/auth/register/therapist')
                .send(invalidTherapistData)
                .expect(400);
        });
    });
    describe('Database Transactions', () => {
        it('should rollback on client registration failure', async () => {
            // Mock a scenario where user creation succeeds but client creation fails
            const clientData = {
                user: {
                    firstName: 'Test',
                    lastName: 'User',
                    email: 'test@example.com',
                    mobile: '+1234567890',
                },
                hasSeenTherapistRecommendations: false,
            };
            // Attempt registration with invalid data that would cause a rollback
            try {
                await request(app.getHttpServer())
                    .post('/auth/register/client')
                    .send(clientData);
            }
            catch {
                // Expected to fail
            }
            // Verify no orphaned user record exists
            const user = await prisma.user.findUnique({
                where: { email: 'test@example.com' },
            });
            // Should be null if transaction was properly rolled back
            expect(user).toBeNull();
        });
    });
    describe('Data Integrity', () => {
        it('should maintain referential integrity', async () => {
            // Create a user and client
            const user = await prisma.user.create({
                data: {
                    id: 'test-user-123',
                    email: 'integrity@example.com',
                    firstName: 'Test',
                    lastName: 'User',
                    role: 'client',
                },
            });
            const client = await prisma.client.create({
                data: {
                    userId: user.id,
                    hasSeenTherapistRecommendations: false,
                },
            });
            // Verify relationships
            const userWithClient = await prisma.user.findUnique({
                where: { id: user.id },
                include: { client: true },
            });
            expect(userWithClient?.client?.userId).toBe(client.userId);
            expect(userWithClient?.client?.userId).toBe(user.id);
        });
        it('should enforce unique constraints', async () => {
            // Create first user
            await prisma.user.create({
                data: {
                    id: 'user-1',
                    email: 'unique@example.com',
                    firstName: 'First',
                    lastName: 'User',
                    role: 'client',
                },
            });
            // Try to create second user with same email - should fail
            await expect(prisma.user.create({
                data: {
                    id: 'user-2',
                    email: 'unique@example.com',
                    firstName: 'Second',
                    lastName: 'User',
                    role: 'client',
                },
            })).rejects.toThrow();
        });
    });
    describe('Complex Queries', () => {
        beforeEach(async () => {
            // Setup test data
            await prisma.user.createMany({
                data: [
                    {
                        id: 'client-1',
                        email: 'client1@example.com',
                        firstName: 'Client',
                        lastName: 'One',
                        role: 'client',
                    },
                    {
                        id: 'therapist-1',
                        firstName: 'Therapist',
                        lastName: 'One',
                        email: 'therapist1@example.com',
                        role: 'therapist',
                    },
                ],
            });
            await prisma.client.create({
                data: {
                    userId: 'client-1',
                    hasSeenTherapistRecommendations: false,
                },
            });
            await prisma.therapist.create({
                data: {
                    userId: 'therapist-1',
                    mobile: '+1234567890',
                    province: 'Ontario',
                    providerType: 'Clinical Psychologist',
                    professionalLicenseType: 'Licensed',
                    isPRCLicensed: 'yes',
                    prcLicenseNumber: 'PRC123456',
                    practiceStartDate: new Date('2020-01-01'),
                    yearsOfExperience: 5,
                    areasOfExpertise: ['Anxiety'],
                    assessmentTools: ['PHQ-9'],
                    therapeuticApproachesUsedList: ['CBT'],
                    languagesOffered: ['English'],
                    providedOnlineTherapyBefore: true,
                    comfortableUsingVideoConferencing: true,
                    preferredSessionLength: [60],
                    acceptTypes: ['Individual'],
                    status: 'APPROVED',
                    hourlyRate: 150,
                    expirationDateOfLicense: new Date('2025-01-01'),
                    compliesWithDataPrivacyAct: true,
                    willingToAbideByPlatformGuidelines: true,
                    treatmentSuccessRates: {},
                    sessionLength: '60 minutes',
                },
            });
        });
        it('should perform complex joins correctly', async () => {
            const result = await prisma.user.findMany({
                where: { role: 'therapist' },
                include: {
                    therapist: {
                        select: {
                            status: true,
                            hourlyRate: true,
                            areasOfExpertise: true,
                        },
                    },
                },
            });
            expect(result).toHaveLength(1);
            expect(result[0].therapist?.status).toBe('APPROVED');
            expect(Number(result[0].therapist?.hourlyRate)).toBeCloseTo(150);
        });
        it('should handle aggregation queries', async () => {
            const stats = await prisma.user.groupBy({
                by: ['role'],
                _count: { id: true },
            });
            expect(stats).toEqual(expect.arrayContaining([
                expect.objectContaining({
                    role: 'client',
                    _count: { id: 1 },
                }),
                expect.objectContaining({
                    role: 'therapist',
                    _count: { id: 1 },
                }),
            ]));
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL3Rlc3QtdXRpbHMvaW50ZWdyYXRpb24tdGVzdHMvYXV0aC5pbnRlZ3JhdGlvbi5zcGVjLnRzIiwibWFwcGluZ3MiOiI7O0FBQUEsNkNBQXNEO0FBRXRELHFDQUFxQztBQUNyQyxtRkFBdUU7QUFDdkUsd0RBQW9EO0FBQ3BELGdFQUEyRDtBQUUzRCxRQUFRLENBQUMsd0JBQXdCLEVBQUUsR0FBRyxFQUFFO0lBQ3RDLElBQUksR0FBcUIsQ0FBQztJQUMxQixJQUFJLE1BQXFCLENBQUM7SUFDMUIsSUFBSSxTQUF3QixDQUFDO0lBRTdCLFNBQVMsQ0FBQyxLQUFLLElBQUksRUFBRTtRQUNuQixzQkFBc0I7UUFDdEIsTUFBTSxHQUFHLE1BQU0sdUNBQWlCLENBQUMsaUJBQWlCLEVBQUUsQ0FBQztRQUVyRCxTQUFTLEdBQUcsTUFBTSxjQUFJLENBQUMsbUJBQW1CLENBQUM7WUFDekMsT0FBTyxFQUFFLENBQUMsd0JBQVUsQ0FBQztZQUNyQixTQUFTLEVBQUU7Z0JBQ1Q7b0JBQ0UsT0FBTyxFQUFFLHNDQUFhO29CQUN0QixRQUFRLEVBQUUsTUFBTTtpQkFDakI7YUFDRjtTQUNGLENBQUMsQ0FBQyxPQUFPLEVBQUUsQ0FBQztRQUViLEdBQUcsR0FBRyxTQUFTLENBQUMscUJBQXFCLEVBQUUsQ0FBQztRQUN4QyxNQUFNLEdBQUcsQ0FBQyxJQUFJLEVBQUUsQ0FBQztJQUNuQixDQUFDLENBQUMsQ0FBQztJQUVILFNBQVMsQ0FBQyxLQUFLLElBQUksRUFBRTtRQUNuQixpQ0FBaUM7UUFDakMsTUFBTSx1Q0FBaUIsQ0FBQyxlQUFlLEVBQUUsQ0FBQztJQUM1QyxDQUFDLENBQUMsQ0FBQztJQUVILFFBQVEsQ0FBQyxLQUFLLElBQUksRUFBRTtRQUNsQixNQUFNLHVDQUFpQixDQUFDLGFBQWEsRUFBRSxDQUFDO1FBQ3hDLE1BQU0sR0FBRyxDQUFDLEtBQUssRUFBRSxDQUFDO1FBQ2xCLE1BQU0s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TUFBTSxFQUFFLEVBQUUsRUFBRSxFQUFFLENBQUMsRUFBRTtpQkFDbEIsQ0FBQzthQUNILENBQUMsQ0FDSCxDQUFDO1FBQ0osQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9ob21lL3dldG9vYS9Eb2N1bWVudHMvY29kZS9wcm9qZWN0cy9tZW50YXJhL21lbnRhcmEtYXBpL3NyYy90ZXN0LXV0aWxzL2ludGVncmF0aW9uLXRlc3RzL2F1dGguaW50ZWdyYXRpb24uc3BlYy50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBUZXN0LCBUZXN0aW5nTW9kdWxlIH0gZnJvbSAnQG5lc3Rqcy90ZXN0aW5nJztcbmltcG9ydCB7IElOZXN0QXBwbGljYXRpb24gfSBmcm9tICdAbmVzdGpzL2NvbW1vbic7XG5pbXBvcnQgKiBhcyByZXF1ZXN0IGZyb20gJ3N1cGVydGVzdCc7XG5pbXBvcnQgeyBQcmlzbWFTZXJ2aWNlIH0gZnJvbSAnLi4vLi4vcHJvdmlkZXJzL3ByaXNtYS1jbGllbnQucHJvdmlkZXInO1xuaW1wb3J0IHsgQXV0aE1vZHVsZSB9IGZyb20gJy4uLy4uL2F1dGgvYXV0aC5tb2R1bGUnO1xuaW1wb3J0IHsgRGF0YWJhc2VUZXN0U2V0dXAgfSBmcm9tICcuLi9kYXRhYmFzZS10ZXN0LnNldHVwJztcblxuZGVzY3JpYmUoJ0F1dGggSW50ZWdyYXRpb24gVGVzdHMnLCAoKSA9PiB7XG4gIGxldCBhcHA6IElOZXN0QXBwbGljYXRpb247XG4gIGxldCBwcmlzbWE6IFByaXNtYVNlcnZpY2U7XG4gIGxldCBtb2R1bGVSZWY6IFRlc3RpbmdNb2R1bGU7XG5cbiAgYmVmb3JlQWxsKGFzeW5jICgpID0+IHtcbiAgICAvLyBTZXR1cCB0ZXN0IGRhdGFiYXNlXG4gICAgcHJpc21hID0gYXdhaXQgRGF0YWJhc2VUZXN0U2V0dXAuc2V0dXBUZXN0RGF0YWJhc2UoKTtcblxuICAgIG1vZHVsZVJlZiA9IGF3YWl0IFRlc3QuY3JlYXRlVGVzdGluZ01vZHVsZSh7XG4gICAgICBpbXBvcnRzOiBbQXV0aE1vZHVsZV0sXG4gICAgICBwcm92aWRlcnM6IFtcbiAgICAgICAge1xuICAgICAgICAgIHByb3ZpZGU6IFByaXNtYVNlcnZpY2UsXG4gICAgICAgICAgdXNlVmFsdWU6IHByaXNtYSxcbiAgICAgICAgfSxcbiAgICAgIF0sXG4gICAgfSkuY29tcGlsZSgpO1xuXG4gICAgYXBwID0gbW9kdWxlUmVmLmNyZWF0ZU5lc3RBcHBsaWNhdGlvbigpO1xuICAgIGF3YWl0IGFwcC5pbml0KCk7XG4gIH0pO1xuXG4gIGFmdGVyRWFjaChhc3luYyAoKSA9PiB7XG4gICAgLy8gQ2xlYW4gZGF0YWJhc2UgYWZ0ZXIgZWFjaCB0ZXN0XG4gICAgYXdhaXQgRGF0YWJhc2VUZXN0U2V0dXAuY2xlYW51cERhdGFiYXNlKCk7XG4gIH0pO1xuXG4gIGFmdGVyQWxsKGFzeW5jICgpID0+IHtcbiAgICBhd2FpdCBEYXRhYmFzZVRlc3RTZXR1cC5zdG9wQ29udGFpbmVyKCk7XG4gICAgYXdhaXQgYXBwLmNsb3NlKCk7XG4gICAgYXdhaXQgbW9kdWxlUmVmLmNsb3NlKCk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdQT1NUIC9hdXRoL3JlZ2lzdGVyL2NsaWVudCcsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIGNyZWF0ZSBhIG5ldyBjbGllbnQgc3VjY2Vzc2Z1bGx5JywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgY2xpZW50RGF0YSA9IHtcbiAgICAgICAgdXNlcjoge1xuICAgICAgICAgIGZpcnN0TmFtZTogJ0pvaG4nLFxuICAgICAgICAgIGxhc3ROYW1lOiAnRG9lJyxcbiAgICAgICAgICBlbWFpbDogJ2pvaG4uZG9lQGV4YW1wbGUuY29tJyxcbiAgICAgICAgICBtb2JpbGU6ICcrMTIzNDU2Nzg5MCcsXG4gICAgICAgICAgYWRkcmVzczogJzEyMyBNYWluIFN0JyxcbiAgICAgICAgICBiaXJ0aERhdGU6ICcxOTkwLTAxLTAxJyxcbiAgICAgICAgfSxcbiAgICAgICAgaGFzU2VlblRoZXJhcGlzdFJlY29tbWVuZGF0aW9uczogZmFsc2UsXG4gICAgICB9O1xuXG4gICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHJlcXVlc3QoYXBwLmdldEh0dHBTZXJ2ZXIoKSlcbiAgICAgICAgLnBvc3QoJy9hdXRoL3JlZ2lzdGVyL2NsaWVudCcpXG4gICAgICAgIC5zZW5kKGNsaWVudERhdGEpXG4gICAgICAgIC5leHBlY3QoMjAxKTtcblxuICAgICAgZXhwZWN0KHJlc3BvbnNlLmJvZHkpLnRvTWF0Y2hPYmplY3Qoe1xuICAgICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgICBkYXRhOiBleHBlY3Qub2JqZWN0Q29udGFpbmluZyh7XG4gICAgICAgICAgaWQ6IGV4cGVjdC5hbnkoU3RyaW5nKSxcbiAgICAgICAgICB1c2VyOiBleHBlY3Qub2JqZWN0Q29udGFpbmluZyh7XG4gICAgICAgICAgICBmaXJzdE5hbWU6ICdKb2huJyxcbiAgICAgICAgICAgIGxhc3ROYW1lOiAnRG9lJyxcbiAgICAgICAgICAgIGVtYWlsOiAnam9obi5kb2VAZXhhbXBsZS5jb20nLFxuICAgICAgICAgIH0pLFxuICAgICAgICB9KSxcbiAgICAgIH0pO1xuXG4gICAgICAvLyBWZXJpZnkgaW4gZGF0YWJhc2VcbiAgICAgIGNvbnN0IHVzZXIgPSBhd2FpdCBwcmlzbWEudXNlci5maW5kVW5pcXVlKHtcbiAgICAgICAgd2hlcmU6IHsgZW1haWw6ICdqb2huLmRvZUBleGFtcGxlLmNvbScgfSxcbiAgICAgICAgaW5jbHVkZTogeyBjbGllbnQ6IHRydWUgfSxcbiAgICAgIH0pO1xuXG4gICAgICBleHBlY3QodXNlcikudG9CZVRydXRoeSgpO1xuICAgICAgZXhwZWN0KHVzZXI/LmNsaWVudCkudG9CZVRydXRoeSgpO1xuICAgICAgZXhwZWN0KHVzZXI/LnJvbGUpLnRvQmUoJ2NsaWVudCcpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCByZWplY3QgZHVwbGljYXRlIGVtYWlsIHJlZ2lzdHJhdGlvbicsIGFzeW5jICgpID0+IHtcbiAgICAgIC8vIEZpcnN0IHJlZ2lzdHJhdGlvblxuICAgICAgYXdhaXQgcHJpc21hLnVzZXIuY3JlYXRlKHtcbiAgICAgICAgZGF0YToge1xuICAgICAgICAgIGlkOiAnZXhpc3RpbmctdXNlcicsXG4gICAgICAgICAgZW1haWw6ICdleGlzdGluZ0BleGFtcGxlLmNvbScsXG4gICAgICAgICAgZmlyc3ROYW1lOiAnRXhpc3RpbmcnLFxuICAgICAgICAgIGxhc3ROYW1lOiAnVXNlcicsXG4gICAgICAgICAgcm9sZTogJ2NsaWVudCcsXG4gICAgICAgIH0sXG4gICAgICB9KTtcblxuICAgICAgY29uc3QgY2xpZW50RGF0YSA9IHtcbiAgICAgICAgdXNlcjoge1xuICAgICAgICAgIGZpcnN0TmFtZTogJ05ldycsXG4gICAgICAgICAgbGFzdE5hbWU6ICdVc2VyJyxcbiAgICAgICAgICBlbWFpbDogJ2V4aXN0aW5nQGV4YW1wbGUuY29tJyxcbiAgICAgICAgICBtb2JpbGU6ICcrMTIzNDU2Nzg5MCcsXG4gICAgICAgIH0sXG4gICAgICAgIGhhc1NlZW5UaGVyYXBpc3RSZWNvbW1lbmRhdGlvbnM6IGZhbHNlLFxuICAgICAgfTtcblxuICAgICAgYXdhaXQgcmVxdWVzdChhcHAuZ2V0SHR0cFNlcnZlcigpKVxuICAgICAgICAucG9zdCgnL2F1dGgvcmVnaXN0ZXIvY2xpZW50JylcbiAgICAgICAgLnNlbmQoY2xpZW50RGF0YSlcbiAgICAgICAgLmV4cGVjdCg0MDkpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCB2YWxpZGF0ZSByZXF1aXJlZCBmaWVsZHMnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBpbnZhbGlkRGF0YSA9IHtcbiAgICAgICAgdXNlcjoge1xuICAgICAgICAgIGZpcnN0TmFtZTogJ0pvaG4nLFxuICAgICAgICAgIC8vIE1pc3NpbmcgcmVxdWlyZWQgZmllbGRzXG4gICAgICAgIH0sXG4gICAgICAgIGhhc1NlZW5UaGVyYXBpc3RSZWNvbW1lbmRhdGlvbnM6IGZhbHNlLFxuICAgICAgfTtcblxuICAgICAgYXdhaXQgcmVxdWVzdChhcHAuZ2V0SHR0cFNlcnZlcigpKVxuICAgICAgICAucG9zdCgnL2F1dGgvcmVnaXN0ZXIvY2xpZW50JylcbiAgICAgICAgLnNlbmQoaW52YWxpZERhdGEpXG4gICAgICAgIC5leHBlY3QoNDAwKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ1BPU1QgL2F1dGgvcmVnaXN0ZXIvdGhlcmFwaXN0JywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgY3JlYXRlIGEgbmV3IHRoZXJhcGlzdCBhcHBsaWNhdGlvbicsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IHRoZXJhcGlzdERhdGEgPSB7XG4gICAgICAgIHVzZXJJZDogJ3RoZXJhcGlzdC0xMjMnLFxuICAgICAgICBlbWFpbDogJ3RoZXJhcGlzdEBleGFtcGxlLmNvbScsXG4gICAgICAgIGZpcnN0TmFtZTogJ0phbmUnLFxuICAgICAgICBsYXN0TmFtZTogJ1NtaXRoJyxcbiAgICAgICAgbW9iaWxlOiAnKzEyMzQ1Njc4OTAnLFxuICAgICAgICBwcm92aW5jZTogJ09udGFyaW8nLFxuICAgICAgICBwcm92aWRlclR5cGU6ICdDbGluaWNhbCBQc3ljaG9sb2dpc3QnLFxuICAgICAgICBwcm9mZXNzaW9uYWxMaWNlbnNlVHlwZTogJ0xpY2Vuc2VkJyxcbiAgICAgICAgaXNQUkNMaWNlbnNlZDogJ3llcycsXG4gICAgICAgIHByY0xpY2Vuc2VOdW1iZXI6ICdQUkMxMjM0NTYnLFxuICAgICAgICBpc0xpY2Vuc2VBY3RpdmU6ICd5ZXMnLFxuICAgICAgICBwcmFjdGljZVN0YXJ0RGF0ZTogJzIwMjAtMDEtMDEnLFxuICAgICAgICB5ZWFyc09mRXhwZXJpZW5jZTogNSxcbiAgICAgICAgYXJlYXNPZkV4cGVydGlzZTogWydBbnhpZXR5JywgJ0RlcHJlc3Npb24nXSxcbiAgICAgICAgYXNzZXNzbWVudFRvb2xzOiBbJ1BIUS05JywgJ0dBRC03J10sXG4gICAgICAgIHRoZXJhcGV1dGljQXBwcm9hY2hlc1VzZWRMaXN0OiBbJ0NCVCcsICdEQlQnXSxcbiAgICAgICAgbGFuZ3VhZ2VzT2ZmZXJlZDogWydFbmdsaXNoJywgJ0ZyZW5jaCddLFxuICAgICAgICBwcm92aWRlZE9ubGluZVRoZXJhcHlCZWZvcmU6ICd5ZXMnLFxuICAgICAgICBjb21mb3J0YWJsZVVzaW5nVmlkZW9Db25mZXJlbmNpbmc6ICd5ZXMnLFxuICAgICAgICB3ZWVrbHlBdmFpbGFiaWxpdHk6ICcyMCcsXG4gICAgICAgIHByZWZlcnJlZFNlc3Npb25MZW5ndGg6ICc2MCcsXG4gICAgICAgIGFjY2VwdHM6IFsnSW5kaXZpZHVhbCcsICdDb3VwbGVzJ10sXG4gICAgICAgIGhvdXJseVJhdGU6IDE1MCxcbiAgICAgICAgYmlvOiAnRXhwZXJpZW5jZWQgdGhlcmFwaXN0LicsXG4gICAgICB9O1xuXG4gICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHJlcXVlc3QoYXBwLmdldEh0dHBTZXJ2ZXIoKSlcbiAgICAgICAgLnBvc3QoJy9hdXRoL3JlZ2lzdGVyL3RoZXJhcGlzdCcpXG4gICAgICAgIC5zZW5kKHRoZXJhcGlzdERhdGEpXG4gICAgICAgIC5leHBlY3QoMjAxKTtcblxuICAgICAgZXhwZWN0KHJlc3BvbnNlLmJvZHkpLnRvTWF0Y2hPYmplY3Qoe1xuICAgICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgICBkYXRhOiBleHBlY3Qub2JqZWN0Q29udGFpbmluZyh7XG4gICAgICAgICAgaWQ6IGV4cGVjdC5hbnkoU3RyaW5nKSxcbiAgICAgICAgICBhcHBsaWNhdGlvblN0YXR1czogJ1BFTkRJTkcnLFxuICAgICAgICAgIGVtYWlsOiAndGhlcmFwaXN0QGV4YW1wbGUuY29tJyxcbiAgICAgICAgfSksXG4gICAgICB9KTtcblxuICAgICAgLy8gVmVyaWZ5IGluIGRhdGFiYXNlXG4gICAgICBjb25zdCB0aGVyYXBpc3QgPSBhd2FpdCBwcmlzbWEudGhlcmFwaXN0LmZpbmRVbmlxdWUoe1xuICAgICAgICB3aGVyZTogeyB1c2VySWQ6IHJlc3BvbnNlLmJvZHkuZGF0YS5pZCB9LFxuICAgICAgfSk7XG5cbiAgICAgIGV4cGVjdCh0aGVyYXBpc3QpLnRvQmVUcnV0aHkoKTtcbiAgICAgIGV4cGVjdCh0aGVyYXBpc3Q/LnN0YXR1cykudG9CZSgnUEVORElORycpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCB2YWxpZGF0ZSBwcm9mZXNzaW9uYWwgbGljZW5zZSByZXF1aXJlbWVudHMnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBpbnZhbGlkVGhlcmFwaXN0RGF0YSA9IHtcbiAgICAgICAgdXNlcklkOiAndGhlcmFwaXN0LTEyMycsXG4gICAgICAgIGVtYWlsOiAndGhlcmFwaXN0QGV4YW1wbGUuY29tJyxcbiAgICAgICAgZmlyc3ROYW1lOiAnSmFuZScsXG4gICAgICAgIGxhc3ROYW1lOiAnU21pdGgnLFxuICAgICAgICAvLyBNaXNzaW5nIHByb2Zlc3Npb25hbCBsaWNlbnNlIGluZm9cbiAgICAgIH07XG5cbiAgICAgIGF3YWl0IHJlcXVlc3QoYXBwLmdldEh0dHBTZXJ2ZXIoKSlcbiAgICAgICAgLnBvc3QoJy9hdXRoL3JlZ2lzdGVyL3RoZXJhcGlzdCcpXG4gICAgICAgIC5zZW5kKGludmFsaWRUaGVyYXBpc3REYXRhKVxuICAgICAgICAuZXhwZWN0KDQwMCk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdEYXRhYmFzZSBUcmFuc2FjdGlvbnMnLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCByb2xsYmFjayBvbiBjbGllbnQgcmVnaXN0cmF0aW9uIGZhaWx1cmUnLCBhc3luYyAoKSA9PiB7XG4gICAgICAvLyBNb2NrIGEgc2NlbmFyaW8gd2hlcmUgdXNlciBjcmVhdGlvbiBzdWNjZWVkcyBidXQgY2xpZW50IGNyZWF0aW9uIGZhaWxzXG4gICAgICBjb25zdCBjbGllbnREYXRhID0ge1xuICAgICAgICB1c2VyOiB7XG4gICAgICAgICAgZmlyc3ROYW1lOiAnVGVzdCcsXG4gICAgICAgICAgbGFzdE5hbWU6ICdVc2VyJyxcbiAgICAgICAgICBlbWFpbDogJ3Rlc3RAZXhhbXBsZS5jb20nLFxuICAgICAgICAgIG1vYmlsZTogJysxMjM0NTY3ODkwJyxcbiAgICAgICAgfSxcbiAgICAgICAgaGFzU2VlblRoZXJhcGlzdFJlY29tbWVuZGF0aW9uczogZmFsc2UsXG4gICAgICB9O1xuXG4gICAgICAvLyBBdHRlbXB0IHJlZ2lzdHJhdGlvbiB3aXRoIGludmFsaWQgZGF0YSB0aGF0IHdvdWxkIGNhdXNlIGEgcm9sbGJhY2tcbiAgICAgIHRyeSB7XG4gICAgICAgIGF3YWl0IHJlcXVlc3QoYXBwLmdldEh0dHBTZXJ2ZXIoKSlcbiAgICAgICAgICAucG9zdCgnL2F1dGgvcmVnaXN0ZXIvY2xpZW50JylcbiAgICAgICAgICAuc2VuZChjbGllbnREYXRhKTtcbiAgICAgIH0gY2F0Y2gge1xuICAgICAgICAvLyBFeHBlY3RlZCB0byBmYWlsXG4gICAgICB9XG5cbiAgICAgIC8vIFZlcmlmeSBubyBvcnBoYW5lZCB1c2VyIHJlY29yZCBleGlzdHNcbiAgICAgIGNvbnN0IHVzZXIgPSBhd2FpdCBwcmlzbWEudXNlci5maW5kVW5pcXVlKHtcbiAgICAgICAgd2hlcmU6IHsgZW1haWw6ICd0ZXN0QGV4YW1wbGUuY29tJyB9LFxuICAgICAgfSk7XG5cbiAgICAgIC8vIFNob3VsZCBiZSBudWxsIGlmIHRyYW5zYWN0aW9uIHdhcyBwcm9wZXJseSByb2xsZWQgYmFja1xuICAgICAgZXhwZWN0KHVzZXIpLnRvQmVOdWxsKCk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdEYXRhIEludGVncml0eScsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIG1haW50YWluIHJlZmVyZW50aWFsIGludGVncml0eScsIGFzeW5jICgpID0+IHtcbiAgICAgIC8vIENyZWF0ZSBhIHVzZXIgYW5kIGNsaWVudFxuICAgICAgY29uc3QgdXNlciA9IGF3YWl0IHByaXNtYS51c2VyLmNyZWF0ZSh7XG4gICAgICAgIGRhdGE6IHtcbiAgICAgICAgICBpZDogJ3Rlc3QtdXNlci0xMjMnLFxuICAgICAgICAgIGVtYWlsOiAnaW50ZWdyaXR5QGV4YW1wbGUuY29tJyxcbiAgICAgICAgICBmaXJzdE5hbWU6ICdUZXN0JyxcbiAgICAgICAgICBsYXN0TmFtZTogJ1VzZXInLFxuICAgICAgICAgIHJvbGU6ICdjbGllbnQnLFxuICAgICAgICB9LFxuICAgICAgfSk7XG5cbiAgICAgIGNvbnN0IGNsaWVudCA9IGF3YWl0IHByaXNtYS5jbGllbnQuY3JlYXRlKHtcbiAgICAgICAgZGF0YToge1xuICAgICAgICAgIHVzZXJJZDogdXNlci5pZCxcbiAgICAgICAgICBoYXNTZWVuVGhlcmFwaXN0UmVjb21tZW5kYXRpb25zOiBmYWxzZSxcbiAgICAgICAgfSxcbiAgICAgIH0pO1xuXG4gICAgICAvLyBWZXJpZnkgcmVsYXRpb25zaGlwc1xuICAgICAgY29uc3QgdXNlcldpdGhDbGllbnQgPSBhd2FpdCBwcmlzbWEudXNlci5maW5kVW5pcXVlKHtcbiAgICAgICAgd2hlcmU6IHsgaWQ6IHVzZXIuaWQgfSxcbiAgICAgICAgaW5jbHVkZTogeyBjbGllbnQ6IHRydWUgfSxcbiAgICAgIH0pO1xuXG4gICAgICBleHBlY3QodXNlcldpdGhDbGllbnQ/LmNsaWVudD8udXNlcklkKS50b0JlKGNsaWVudC51c2VySWQpO1xuICAgICAgZXhwZWN0KHVzZXJXaXRoQ2xpZW50Py5jbGllbnQ/LnVzZXJJZCkudG9CZSh1c2VyLmlkKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgZW5mb3JjZSB1bmlxdWUgY29uc3RyYWludHMnLCBhc3luYyAoKSA9PiB7XG4gICAgICAvLyBDcmVhdGUgZmlyc3QgdXNlclxuICAgICAgYXdhaXQgcHJpc21hLnVzZXIuY3JlYXRlKHtcbiAgICAgICAgZGF0YToge1xuICAgICAgICAgIGlkOiAndXNlci0xJyxcbiAgICAgICAgICBlbWFpbDogJ3VuaXF1ZUBleGFtcGxlLmNvbScsXG4gICAgICAgICAgZmlyc3ROYW1lOiAnRmlyc3QnLFxuICAgICAgICAgIGxhc3ROYW1lOiAnVXNlcicsXG4gICAgICAgICAgcm9sZTogJ2NsaWVudCcsXG4gICAgICAgIH0sXG4gICAgICB9KTtcblxuICAgICAgLy8gVHJ5IHRvIGNyZWF0ZSBzZWNvbmQgdXNlciB3aXRoIHNhbWUgZW1haWwgLSBzaG91bGQgZmFpbFxuICAgICAgYXdhaXQgZXhwZWN0KFxuICAgICAgICBwcmlzbWEudXNlci5jcmVhdGUoe1xuICAgICAgICAgIGRhdGE6IHtcbiAgICAgICAgICAgIGlkOiAndXNlci0yJyxcbiAgICAgICAgICAgIGVtYWlsOiAndW5pcXVlQGV4YW1wbGUuY29tJyxcbiAgICAgICAgICAgIGZpcnN0TmFtZTogJ1NlY29uZCcsXG4gICAgICAgICAgICBsYXN0TmFtZTogJ1VzZXInLFxuICAgICAgICAgICAgcm9sZTogJ2NsaWVudCcsXG4gICAgICAgICAgfSxcbiAgICAgICAgfSksXG4gICAgICApLnJlamVjdHMudG9UaHJvdygpO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnQ29tcGxleCBRdWVyaWVzJywgKCkgPT4ge1xuICAgIGJlZm9yZUVhY2goYXN5bmMgKCkgPT4ge1xuICAgICAgLy8gU2V0dXAgdGVzdCBkYXRhXG4gICAgICBhd2FpdCBwcmlzbWEudXNlci5jcmVhdGVNYW55KHtcbiAgICAgICAgZGF0YTogW1xuICAgICAgICAgIHtcbiAgICAgICAgICAgIGlkOiAnY2xpZW50LTEnLFxuICAgICAgICAgICAgZW1haWw6ICdjbGllbnQxQGV4YW1wbGUuY29tJyxcbiAgICAgICAgICAgIGZpcnN0TmFtZTogJ0NsaWVudCcsXG4gICAgICAgICAgICBsYXN0TmFtZTogJ09uZScsXG4gICAgICAgICAgICByb2xlOiAnY2xpZW50JyxcbiAgICAgICAgICB9LFxuICAgICAgICAgIHtcbiAgICAgICAgICAgIGlkOiAndGhlcmFwaXN0LTEnLFxuICAgICAgICAgICAgZmlyc3ROYW1lOiAnVGhlcmFwaXN0JyxcbiAgICAgICAgICAgIGxhc3ROYW1lOiAnT25lJyxcbiAgICAgICAgICAgIGVtYWlsOiAndGhlcmFwaXN0MUBleGFtcGxlLmNvbScsXG4gICAgICAgICAgICByb2xlOiAndGhlcmFwaXN0JyxcbiAgICAgICAgICB9LFxuICAgICAgICBdLFxuICAgICAgfSk7XG5cbiAgICAgIGF3YWl0IHByaXNtYS5jbGllbnQuY3JlYXRlKHtcbiAgICAgICAgZGF0YToge1xuICAgICAgICAgIHVzZXJJZDogJ2NsaWVudC0xJyxcbiAgICAgICAgICBoYXNTZWVuVGhlcmFwaXN0UmVjb21tZW5kYXRpb25zOiBmYWxzZSxcbiAgICAgICAgfSxcbiAgICAgIH0pO1xuXG4gICAgICBhd2FpdCBwcmlzbWEudGhlcmFwaXN0LmNyZWF0ZSh7XG4gICAgICAgIGRhdGE6IHtcbiAgICAgICAgICB1c2VySWQ6ICd0aGVyYXBpc3QtMScsXG4gICAgICAgICAgbW9iaWxlOiAnKzEyMzQ1Njc4OTAnLFxuICAgICAgICAgIHByb3ZpbmNlOiAnT250YXJpbycsXG4gICAgICAgICAgcHJvdmlkZXJUeXBlOiAnQ2xpbmljYWwgUHN5Y2hvbG9naXN0JyxcbiAgICAgICAgICBwcm9mZXNzaW9uYWxMaWNlbnNlVHlwZTogJ0xpY2Vuc2VkJyxcbiAgICAgICAgICBpc1BSQ0xpY2Vuc2VkOiAneWVzJyxcbiAgICAgICAgICBwcmNMaWNlbnNlTnVtYmVyOiAnUFJDMTIzNDU2JyxcbiAgICAgICAgICBwcmFjdGljZVN0YXJ0RGF0ZTogbmV3IERhdGUoJzIwMjAtMDEtMDEnKSxcbiAgICAgICAgICB5ZWFyc09mRXhwZXJpZW5jZTogNSxcbiAgICAgICAgICBhcmVhc09mRXhwZXJ0aXNlOiBbJ0FueGlldHknXSxcbiAgICAgICAgICBhc3Nlc3NtZW50VG9vbHM6IFsnUEhRLTknXSxcbiAgICAgICAgICB0aGVyYXBldXRpY0FwcHJvYWNoZXNVc2VkTGlzdDogWydDQlQnXSxcbiAgICAgICAgICBsYW5ndWFnZXNPZmZlcmVkOiBbJ0VuZ2xpc2gnXSxcbiAgICAgICAgICBwcm92aWRlZE9ubGluZVRoZXJhcHlCZWZvcmU6IHRydWUsXG4gICAgICAgICAgY29tZm9ydGFibGVVc2luZ1ZpZGVvQ29uZmVyZW5jaW5nOiB0cnVlLFxuICAgICAgICAgIHByZWZlcnJlZFNlc3Npb25MZW5ndGg6IFs2MF0sXG4gICAgICAgICAgYWNjZXB0VHlwZXM6IFsnSW5kaXZpZHVhbCddLFxuICAgICAgICAgIHN0YXR1czogJ0FQUFJPVkVEJyxcbiAgICAgICAgICBob3VybHlSYXRlOiAxNTAsXG4gICAgICAgICAgZXhwaXJhdGlvbkRhdGVPZkxpY2Vuc2U6IG5ldyBEYXRlKCcyMDI1LTAxLTAxJyksXG4gICAgICAgICAgY29tcGxpZXNXaXRoRGF0YVByaXZhY3lBY3Q6IHRydWUsXG4gICAgICAgICAgd2lsbGluZ1RvQWJpZGVCeVBsYXRmb3JtR3VpZGVsaW5lczogdHJ1ZSxcbiAgICAgICAgICB0cmVhdG1lbnRTdWNjZXNzUmF0ZXM6IHt9LFxuICAgICAgICAgIHNlc3Npb25MZW5ndGg6ICc2MCBtaW51dGVzJyxcbiAgICAgICAgfSxcbiAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBwZXJmb3JtIGNvbXBsZXggam9pbnMgY29ycmVjdGx5JywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgcHJpc21hLnVzZXIuZmluZE1hbnkoe1xuICAgICAgICB3aGVyZTogeyByb2xlOiAndGhlcmFwaXN0JyB9LFxuICAgICAgICBpbmNsdWRlOiB7XG4gICAgICAgICAgdGhlcmFwaXN0OiB7XG4gICAgICAgICAgICBzZWxlY3Q6IHtcbiAgICAgICAgICAgICAgc3RhdHVzOiB0cnVlLFxuICAgICAgICAgICAgICBob3VybHlSYXRlOiB0cnVlLFxuICAgICAgICAgICAgICBhcmVhc09mRXhwZXJ0aXNlOiB0cnVlLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgfSk7XG5cbiAgICAgIGV4cGVjdChyZXN1bHQpLnRvSGF2ZUxlbmd0aCgxKTtcbiAgICAgIGV4cGVjdChyZXN1bHRbMF0udGhlcmFwaXN0Py5zdGF0dXMpLnRvQmUoJ0FQUFJPVkVEJyk7XG4gICAgICBleHBlY3QoTnVtYmVyKHJlc3VsdFswXS50aGVyYXBpc3Q/LmhvdXJseVJhdGUpKS50b0JlQ2xvc2VUbygxNTApO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBoYW5kbGUgYWdncmVnYXRpb24gcXVlcmllcycsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IHN0YXRzID0gYXdhaXQgcHJpc21hLnVzZXIuZ3JvdXBCeSh7XG4gICAgICAgIGJ5OiBbJ3JvbGUnXSxcbiAgICAgICAgX2NvdW50OiB7IGlkOiB0cnVlIH0sXG4gICAgICB9KTtcblxuICAgICAgZXhwZWN0KHN0YXRzKS50b0VxdWFsKFxuICAgICAgICBleHBlY3QuYXJyYXlDb250YWluaW5nKFtcbiAgICAgICAgICBleHBlY3Qub2JqZWN0Q29udGFpbmluZyh7XG4gICAgICAgICAgICByb2xlOiAnY2xpZW50JyxcbiAgICAgICAgICAgIF9jb3VudDogeyBpZDogMSB9LFxuICAgICAgICAgIH0pLFxuICAgICAgICAgIGV4cGVjdC5vYmplY3RDb250YWluaW5nKHtcbiAgICAgICAgICAgIHJvbGU6ICd0aGVyYXBpc3QnLFxuICAgICAgICAgICAgX2NvdW50OiB7IGlkOiAxIH0sXG4gICAgICAgICAgfSksXG4gICAgICAgIF0pLFxuICAgICAgKTtcbiAgICB9KTtcbiAgfSk7XG59KTtcbiJdLCJ2ZXJzaW9uIjozfQ==