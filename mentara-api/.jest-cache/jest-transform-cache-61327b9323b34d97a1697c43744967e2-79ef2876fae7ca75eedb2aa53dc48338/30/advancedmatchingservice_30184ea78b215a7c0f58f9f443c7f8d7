f5b3e6480a1c9a3325c48336ce60e08a
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
exports.AdvancedMatchingService = void 0;
const common_1 = require("@nestjs/common");
const prisma_client_provider_1 = require("../../providers/prisma-client.provider");
let AdvancedMatchingService = class AdvancedMatchingService {
    prisma;
    defaultWeights = {
        conditionMatch: 0.4,
        approachCompatibility: 0.25,
        experienceAndSuccess: 0.2,
        reviewsAndRatings: 0.1,
        availabilityAndLogistics: 0.05,
    };
    severityWeights = {
        // Depression/Anxiety scales
        Minimal: 1,
        Mild: 2,
        Moderate: 3,
        'Moderately Severe': 4,
        Severe: 5,
        'Very Severe': 5,
        Extreme: 5,
        // General severity levels
        Low: 1,
        High: 4,
        Substantial: 4,
        // Clinical thresholds
        Subclinical: 1,
        Clinical: 4,
        Subthreshold: 2,
        // Binary indicators
        Positive: 4,
        Negative: 0,
        None: 0,
    };
    constructor(prisma) {
        this.prisma = prisma;
    }
    async calculateAdvancedMatch(client, therapist, weights = this.defaultWeights) {
        // Input validation to prevent runtime errors
        if (!client?.preAssessment) {
            throw new Error('Client must have a valid pre-assessment');
        }
        if (!client.clientPreferences) {
            throw new Error('Client preferences are required for matching');
        }
        if (!therapist?.user) {
            throw new Error('Therapist must have valid user information');
        }
        // Build user condition profile
        const userProfile = this.buildUserConditionProfile(client);
        // Calculate individual score components
        const conditionScore = this.calculateConditionMatchScore(userProfile, therapist);
        const approachScore = this.calculateApproachCompatibilityScore(userProfile, therapist);
        const experienceScore = this.calculateExperienceAndSuccessScore(userProfile, therapist);
        const reviewScore = await this.calculateReviewScore(therapist);
        const logisticsScore = this.calculateLogisticsScore(userProfile, therapist);
        // Calculate weighted total score
        const totalScore = Math.round(conditionScore * weights.conditionMatch +
            approachScore * weights.approachCompatibility +
            experienceScore * weights.experienceAndSuccess +
            reviewScore * weights.reviewsAndRatings +
            logisticsScore * weights.availabilityAndLogistics);
        // Build match explanation
        const matchExplanation = this.buildMatchExplanation(userProfile, therapist, conditionScore, approachScore, experienceScore, reviewScore);
        return {
            therapist,
            totalScore,
            breakdown: {
                conditionScore: Math.round(conditionScore),
                approachScore: Math.round(approachScore),
                experienceScore: Math.round(experienceScore),
                reviewScore: Math.round(reviewScore),
                logisticsScore: Math.round(logisticsScore),
            },
            matchExplanation,
        };
    }
    buildUserConditionProfile(client) {
        const severityLevels = client.preAssessment.severityLevels;
        const questionnaires = client.preAssessment.questionnaires;
        // Categorize conditions by severity
        const primaryConditions = [];
        const secondaryConditions = [];
        questionnaires.forEach((condition) => {
            const severity = severityLevels[condition];
            const weight = this.severityWeights[severity] || 1;
            if (weight >= 4) {
                primaryConditions.push({ condition, severity, weight });
            }
            else if (weight >= 2) {
                secondaryConditions.push({ condition, severity, weight });
            }
        });
        // Extract preferences from client preferences
        const preferences = this.parseClientPreferences(client.clientPreferences);
        return {
            primaryConditions,
            secondaryConditions,
            preferredApproaches: preferences.approaches || [],
            sessionPreferences: {
                format: preferences.sessionFormat || ['online', 'in-person'],
                duration: preferences.sessionDuration || [],
                frequency: preferences.sessionFrequency || 'weekly',
            },
            demographics: {
                ageRange: preferences.therapistAge || 'any',
                genderPreference: preferences.therapistGender,
                languagePreference: preferences.languages || ['English'],
            },
            logistics: {
                maxHourlyRate: preferences.maxBudget,
                province: preferences.location,
                insuranceTypes: preferences.insurance || [],
            },
        };
    }
    /**
     * Calculates how well a therapist's expertise matches the client's mental health conditions.
     *
     * Scoring Logic:
     * - Primary conditions (severe, clinical): 30 points base, scaled by severity weight (1-5)
     * - Secondary conditions (moderate): 15 points base, scaled by severity weight
     * - Expertise depth bonus: 5 points per matched condition, max 20 bonus points
     * - Total score capped at 100 points
     *
     * @param userProfile Client's condition profile with severity weights
     * @param therapist Therapist with expertise and specialization arrays
     * @returns Score from 0-100 indicating condition match quality
     */
    calculateConditionMatchScore(userProfile, therapist) {
        let score = 0;
        const expertise = therapist.expertise || [];
        const specializations = therapist.illnessSpecializations || [];
        const allTherapistConditions = [...expertise, ...specializations];
        // Primary conditions scoring: most critical conditions get highest weight
        // Base score of 30 points, multiplied by severity ratio (weight/5)
        // Example: Severe depression (weight=5) = 30 * (5/5) = 30 points
        // Example: Moderate anxiety (weight=3) = 30 * (3/5) = 18 points
        userProfile.primaryConditions.forEach(({ condition, weight }) => {
            if (allTherapistConditions.includes(condition)) {
                score += 30 * (weight / 5); // Scale by severity (1-5 range)
            }
        });
        // Secondary conditions scoring: less critical but still important
        // Base score of 15 points, also scaled by severity
        userProfile.secondaryConditions.forEach(({ condition, weight }) => {
            if (allTherapistConditions.includes(condition)) {
                score += 15 * (weight / 5); // Scale by severity (1-5 range)
            }
        });
        // Expertise depth bonus: reward therapists who match multiple conditions
        // This indicates broader competency in the client's problem areas
        const matchedConditions = [
            ...userProfile.primaryConditions.map((c) => c.condition),
            ...userProfile.secondaryConditions.map((c) => c.condition),
        ].filter((condition) => allTherapistConditions.includes(condition));
        // 5 points per matched condition, capped at 20 to prevent overweighting
        const expertiseDepthBonus = Math.min(matchedConditions.length * 5, 20);
        score += expertiseDepthBonus;
        // Cap final score at 100 to maintain consistent scoring scale
        return Math.min(score, 100);
    }
    calculateApproachCompatibilityScore(userProfile, therapist) {
        let score = 0;
        const therapistApproaches = therapist.approaches || [];
        const therapistApproachesList = therapist.therapeuticApproachesUsedList || [];
        const allApproaches = [...therapistApproaches, ...therapistApproachesList];
        // If user has preferred approaches, match them
        if (userProfile.preferredApproaches.length > 0) {
            const matchedApproaches = userProfile.preferredApproaches.filter((approach) => allApproaches.includes(approach));
            score =
                (matchedApproaches.length / userProfile.preferredApproaches.length) *
                    100;
        }
        else {
            // If no preference specified, give points for evidence-based approaches
            const evidenceBasedApproaches = [
                'Cognitive Behavioral Therapy (CBT)',
                'Dialectical Behavior Therapy (DBT)',
                'Acceptance and Commitment Therapy (ACT)',
                'Eye Movement Desensitization and Reprocessing (EMDR)',
                'Mindfulness-Based Cognitive Therapy (MBCT)',
            ];
            const evidenceBasedCount = allApproaches.filter((approach) => evidenceBasedApproaches.includes(approach)).length;
            score = Math.min(evidenceBasedCount * 20, 80); // Max 80 for general evidence-based
        }
        // Bonus for comprehensive approach diversity
        const diversityBonus = Math.min(allApproaches.length * 2, 20);
        score += diversityBonus;
        return Math.min(score, 100);
    }
    /**
     * Calculates therapist experience and success rate score using a diminishing returns curve.
     *
     * Experience Scoring (70-90 points):
     * - Years 0-5: 8 points per year (0-40 points) - new therapist learning curve
     * - Years 5-10: 6 points per year (40-70 points) - experienced but still growing
     * - Years 10+: 2 points per year (70-90 points, max 20 bonus) - diminishing returns
     *
     * Success Rate Bonus (0-20 points):
     * - Based on therapist's documented success rates for client's specific conditions
     * - Averages success rates across all relevant conditions
     * - Scales linearly: 80% success rate = 16 bonus points
     *
     * @param userProfile Client's condition profile
     * @param therapist Therapist with experience and success rate data
     * @returns Score from 0-100 indicating experience quality
     */
    calculateExperienceAndSuccessScore(userProfile, therapist) {
        let score = 0;
        // Calculate total years of experience from multiple sources
        const yearsExperience = this.calculateYearsOfExperience(therapist.practiceStartDate);
        const additionalYears = therapist.yearsOfExperience || 0;
        const totalYears = Math.max(yearsExperience, additionalYears);
        // Experience scoring with diminishing returns curve
        // Reflects that experience gains are most valuable early in career
        if (totalYears <= 5) {
            // New therapists: high learning curve, significant improvement per year
            score += totalYears * 8; // 0-40 points for 0-5 years
        }
        else if (totalYears <= 10) {
            // Experienced therapists: still gaining skills but at slower rate
            score += 40 + (totalYears - 5) * 6; // 40-70 points for 5-10 years
        }
        else {
            // Senior therapists: diminishing returns, max practical benefit around 15-20 years
            score += 70 + Math.min((totalYears - 10) * 2, 20); // 70-90 points for 10+ years
        }
        // Treatment success rates bonus: reward documented effectiveness
        // Only considers success rates for conditions relevant to this specific client
        const successRates = therapist.treatmentSuccessRates || {};
        const relevantConditions = [
            ...userProfile.primaryConditions.map((c) => c.condition),
            ...userProfile.secondaryConditions.map((c) => c.condition),
        ];
        let successRateBonus = 0;
        let applicableRates = 0;
        // Calculate average success rate across all relevant conditions
        relevantConditions.forEach((condition) => {
            if (successRates[condition] !== undefined) {
                successRateBonus += successRates[condition];
                applicableRates++;
            }
        });
        if (applicableRates > 0) {
            const averageSuccessRate = successRateBonus / applicableRates;
            // Convert percentage to points: 100% success = 20 points, 50% = 10 points
            score += (averageSuccessRate / 100) * 20; // Up to 20 bonus points
        }
        return Math.min(score, 100);
    }
    async calculateReviewScore(therapist) {
        if (!therapist.reviews || therapist.reviews.length === 0) {
            return 50; // Neutral score for new therapists
        }
        const approvedReviews = therapist.reviews.filter((review) => review.status === 'APPROVED');
        if (approvedReviews.length === 0) {
            return 50;
        }
        // Calculate average rating
        const totalRating = approvedReviews.reduce((sum, review) => sum + review.rating, 0);
        const averageRating = totalRating / approvedReviews.length;
        // Convert 1-5 rating to 0-100 score
        let score = ((averageRating - 1) / 4) * 100;
        // Bonus for volume of reviews (credibility factor)
        const volumeBonus = Math.min(approvedReviews.length * 2, 20);
        score += volumeBonus;
        // Penalty for very few reviews
        if (approvedReviews.length < 3) {
            score *= 0.8; // 20% penalty for low review count
        }
        return Math.min(score, 100);
    }
    calculateLogisticsScore(userProfile, therapist) {
        let score = 100; // Start with perfect score, deduct for mismatches
        // Location matching
        if (userProfile.logistics.province &&
            therapist.province !== userProfile.logistics.province) {
            score -= 30; // Significant penalty for location mismatch
        }
        // Budget compatibility
        if (userProfile.logistics.maxHourlyRate &&
            Number(therapist.hourlyRate) > userProfile.logistics.maxHourlyRate) {
            score -= 40; // Major penalty for budget overrun
        }
        // Insurance compatibility
        if (userProfile.logistics.insuranceTypes &&
            userProfile.logistics.insuranceTypes.length > 0) {
            const acceptedTypes = therapist.acceptedInsuranceTypes || [];
            const hasInsuranceMatch = userProfile.logistics.insuranceTypes.some((type) => acceptedTypes.includes(type));
            if (!hasInsuranceMatch && therapist.acceptsInsurance) {
                score -= 20; // Penalty for insurance mismatch
            }
        }
        // Language compatibility
        const therapistLanguages = therapist.languagesOffered || ['English'];
        const hasLanguageMatch = userProfile.demographics.languagePreference.some((lang) => therapistLanguages.includes(lang));
        if (!hasLanguageMatch) {
            score -= 25; // Penalty for language barrier
        }
        return Math.max(score, 0);
    }
    buildMatchExplanation(userProfile, therapist, conditionScore, approachScore, experienceScore, reviewScore) {
        const expertise = therapist.expertise || [];
        const specializations = therapist.illnessSpecializations || [];
        const approaches = [
            ...(therapist.approaches || []),
            ...(therapist.therapeuticApproachesUsedList || []),
        ];
        const primaryMatches = userProfile.primaryConditions
            .map((c) => c.condition)
            .filter((condition) => [...expertise, ...specializations].includes(condition));
        const secondaryMatches = userProfile.secondaryConditions
            .map((c) => c.condition)
            .filter((condition) => [...expertise, ...specializations].includes(condition));
        const approachMatches = userProfile.preferredApproaches.filter((approach) => approaches.includes(approach));
        const experienceYears = this.calculateYearsOfExperience(therapist.practiceStartDate);
        const approvedReviews = therapist.reviews?.filter((r) => r.status === 'APPROVED') || [];
        const averageRating = approvedReviews.length > 0
            ? approvedReviews.reduce((sum, r) => sum + r.rating, 0) /
                approvedReviews.length
            : 0;
        const successRates = therapist.treatmentSuccessRates || {};
        return {
            primaryMatches,
            secondaryMatches,
            approachMatches,
            experienceYears: Math.max(experienceYears, therapist.yearsOfExperience || 0),
            averageRating: Math.round(averageRating * 10) / 10,
            totalReviews: approvedReviews.length,
            successRates,
        };
    }
    parseClientPreferences(preferences) {
        const parsed = {};
        preferences.forEach((pref) => {
            try {
                // Handle JSON string values
                if (typeof pref.value === 'string' && pref.value.startsWith('[')) {
                    parsed[pref.key] = JSON.parse(pref.value);
                }
                else {
                    parsed[pref.key] = pref.value;
                }
            }
            catch (error) {
                // Log parsing errors for debugging but continue with fallback
                console.warn(`Failed to parse client preference ${pref.key}:`, error);
                parsed[pref.key] = pref.value; // Fallback to raw value
            }
        });
        return parsed;
    }
    calculateYearsOfExperience(startDate) {
        const now = new Date();
        let years = now.getFullYear() - startDate.getFullYear();
        if (now.getMonth() < startDate.getMonth() ||
            (now.getMonth() === startDate.getMonth() &&
                now.getDate() < startDate.getDate())) {
            years--;
        }
        return Math.max(years, 0);
    }
};
exports.AdvancedMatchingService = AdvancedMatchingService;
exports.AdvancedMatchingService = AdvancedMatchingService = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [typeof (_a = typeof prisma_client_provider_1.PrismaService !== "undefined" && prisma_client_provider_1.PrismaService) === "function" ? _a : Object])
], AdvancedMatchingService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL3RoZXJhcGlzdC9zZXJ2aWNlcy9hZHZhbmNlZC1tYXRjaGluZy5zZXJ2aWNlLnRzIiwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7QUFBQSwyQ0FBNEM7QUFDNUMsbUZBQXVFO0FBNEZoRSxJQUFNLHVCQUF1QixHQUE3QixNQUFNLHVCQUF1QjtJQW1DTDtJQWxDWixjQUFjLEdBQW9CO1FBQ2pELGNBQWMsRUFBRSxHQUFHO1FBQ25CLHFCQUFxQixFQUFFLElBQUk7UUFDM0Isb0JBQW9CLEVBQUUsR0FBRztRQUN6QixpQkFBaUIsRUFBRSxHQUFHO1FBQ3RCLHdCQUF3QixFQUFFLElBQUk7S0FDL0IsQ0FBQztJQUVlLGVBQWUsR0FBb0I7UUFDbEQsNEJBQTRCO1FBQzVCLE9BQU8sRUFBRSxDQUFDO1FBQ1YsSUFBSSxFQUFFLENBQUM7UUFDUCxRQUFRLEVBQUUsQ0FBQztRQUNYLG1CQUFtQixFQUFFLENBQUM7UUFDdEIsTUFBTSxFQUFFLENBQUM7UUFDVCxhQUFhLEVBQUUsQ0FBQztRQUNoQixPQUFPLEVBQUUsQ0FBQztRQUVWLDBCQUEwQjtRQUMxQixHQUFHLEVBQUUsQ0FBQztRQUNOLElBQUksRUFBRSxDQUFDO1FBQ1AsV0FBVyxFQUFFLENBQUM7UUFFZCxzQkFBc0I7UUFDdEIsV0FBVyxFQUFFLENBQUM7UUFDZCxRQUFRLEVBQUUsQ0FBQztRQUNYLFlBQVksRUFBRSxDQUFDO1FBRWYsb0JBQW9CO1FBQ3BCLFFBQVEsRUFBRSxDQUFDO1FBQ1gsUUFBUSxFQUFFLENBQUM7UUFDWCxJQUFJLEVBQUUsQ0FBQztLQUNSLENBQUM7SUFFRixZQUE2QixNQUFxQjtRQUFyQixXQUFNLEdBQU4sTUFBTSxDQUFlO0lBQUcsQ0FBQztJQUV0RCxLQUFLLENBQUMsc0JBQXNCLENBQzFCLE1BQXlCLEVBQ3pCLFNBQStCLEVBQy9CLFVBQTJCLElBQUksQ0FBQyxjQUFjO1FBRTlDLDZDQUE2QztRQUM3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QUFDLENBQUM7UUFFSCxPQUFPLE1BQU0sQ0FBQztJQUNoQixDQUFDO0lBRU8sMEJBQTBCLENBQUMsU0FBZTtRQUNoRCxNQUFNLEdBQUcsR0FBRyxJQUFJLElBQUksRUFBRSxDQUFDO1FBQ3ZCLElBQUksS0FBSyxHQUFHLEdBQUcsQ0FBQyxXQUFXLEVBQUUsR0FBRyxTQUFTLENBQUMsV0FBVyxFQUFFLENBQUM7UUFFeEQsSUFDRSxHQUFHLENBQUMsUUFBUSxFQUFFLEdBQUcsU0FBUyxDQUFDLFFBQVEsRUFBRTtZQUNyQyxDQUFDLEdBQUcsQ0FBQyxRQUFRLEVBQUUsS0FBSyxTQUFTLENBQUMsUUFBUSxFQUFFO2dCQUN0QyxHQUFHLENBQUMsT0FBTyxFQUFFLEdBQUcsU0FBUyxDQUFDLE9BQU8sRUFBRSxDQUFDLEVBQ3RDLENBQUM7WUFDRCxLQUFLLEVBQUUsQ0FBQztRQUNWLENBQUM7UUFFRCxPQUFPLElBQUksQ0FBQyxHQUFHLENBQUMsS0FBSyxFQUFFLENBQUMsQ0FBQyxDQUFDO0lBQzVCLENBQUM7Q0FDRixDQUFBO0FBcmdCWSwwREFBdUI7a0NBQXZCLHVCQUF1QjtJQURuQyxJQUFBLG1CQUFVLEdBQUU7eURBb0MwQixzQ0FBYSxvQkFBYixzQ0FBYTtHQW5DdkMsdUJBQXVCLENBcWdCbkMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL3RoZXJhcGlzdC9zZXJ2aWNlcy9hZHZhbmNlZC1tYXRjaGluZy5zZXJ2aWNlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAbmVzdGpzL2NvbW1vbic7XG5pbXBvcnQgeyBQcmlzbWFTZXJ2aWNlIH0gZnJvbSAnLi4vLi4vcHJvdmlkZXJzL3ByaXNtYS1jbGllbnQucHJvdmlkZXInO1xuaW1wb3J0IHtcbiAgUHJlQXNzZXNzbWVudCxcbiAgVGhlcmFwaXN0LFxuICBDbGllbnQsXG4gIFVzZXIsXG4gIFJldmlldyxcbiAgQ2xpZW50UHJlZmVyZW5jZSxcbn0gZnJvbSAnQHByaXNtYS9jbGllbnQnO1xuXG4vLyBUeXBlIGRlZmluaXRpb25zIGZvciBtYXRjaGluZyBzZXJ2aWNlXG5leHBvcnQgdHlwZSBVc2VyRm9yTWF0Y2hpbmcgPSBQaWNrPFxuICBVc2VyLFxuICAnZmlyc3ROYW1lJyB8ICdsYXN0TmFtZScgfCAnYXZhdGFyVXJsJ1xuPjtcblxuZXhwb3J0IHR5cGUgUmV2aWV3Rm9yTWF0Y2hpbmcgPSBQaWNrPFJldmlldywgJ3JhdGluZycgfCAnc3RhdHVzJz47XG5cbmV4cG9ydCB0eXBlIENsaWVudEZvck1hdGNoaW5nID0gQ2xpZW50ICYge1xuICBwcmVBc3Nlc3NtZW50OiBQcmVBc3Nlc3NtZW50O1xuICBjbGllbnRQcmVmZXJlbmNlczogQ2xpZW50UHJlZmVyZW5jZVtdO1xuICB1c2VyOiBVc2VyRm9yTWF0Y2hpbmc7XG59O1xuXG5leHBvcnQgdHlwZSBUaGVyYXBpc3RGb3JNYXRjaGluZyA9IFRoZXJhcGlzdCAmIHtcbiAgdXNlcjogVXNlckZvck1hdGNoaW5nO1xuICByZXZpZXdzOiBSZXZpZXdGb3JNYXRjaGluZ1tdO1xufTtcblxuZXhwb3J0IGludGVyZmFjZSBNYXRjaGluZ1dlaWdodHMge1xuICBjb25kaXRpb25NYXRjaDogbnVtYmVyOyAvLyA0MCVcbiAgYXBwcm9hY2hDb21wYXRpYmlsaXR5OiBudW1iZXI7IC8vIDI1JVxuICBleHBlcmllbmNlQW5kU3VjY2VzczogbnVtYmVyOyAvLyAyMCVcbiAgcmV2aWV3c0FuZFJhdGluZ3M6IG51bWJlcjsgLy8gMTAlXG4gIGF2YWlsYWJpbGl0eUFuZExvZ2lzdGljczogbnVtYmVyOyAvLyA1JVxufVxuXG5leHBvcnQgaW50ZXJmYWNlIFRoZXJhcGlzdFNjb3JlIHtcbiAgdGhlcmFwaXN0OiBUaGVyYXBpc3RGb3JNYXRjaGluZztcbiAgdG90YWxTY29yZTogbnVtYmVyO1xuICBicmVha2Rvd246IHtcbiAgICBjb25kaXRpb25TY29yZTogbnVtYmVyO1xuICAgIGFwcHJvYWNoU2NvcmU6IG51bWJlcjtcbiAgICBleHBlcmllbmNlU2NvcmU6IG51bWJlcjtcbiAgICByZXZpZXdTY29yZTogbnVtYmVyO1xuICAgIGxvZ2lzdGljc1Njb3JlOiBudW1iZXI7XG4gIH07XG4gIG1hdGNoRXhwbGFuYXRpb246IHtcbiAgICBwcmltYXJ5TWF0Y2hlczogc3RyaW5nW107XG4gICAgc2Vjb25kYXJ5TWF0Y2hlczogc3RyaW5nW107XG4gICAgYXBwcm9hY2hNYXRjaGVzOiBzdHJpbmdbXTtcbiAgICBleHBlcmllbmNlWWVhcnM6IG51bWJlcjtcbiAgICBhdmVyYWdlUmF0aW5nOiBudW1iZXI7XG4gICAgdG90YWxSZXZpZXdzOiBudW1iZXI7XG4gICAgc3VjY2Vzc1JhdGVzOiBSZWNvcmQ8c3RyaW5nLCBudW1iZXI+O1xuICB9O1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIFNldmVyaXR5TWFwcGluZyB7XG4gIFtrZXk6IHN0cmluZ106IG51bWJlcjtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBVc2VyQ29uZGl0aW9uUHJvZmlsZSB7XG4gIHByaW1hcnlDb25kaXRpb25zOiBBcnJheTx7XG4gICAgY29uZGl0aW9uOiBzdHJpbmc7XG4gICAgc2V2ZXJpdHk6IHN0cmluZztcbiAgICB3ZWlnaHQ6IG51bWJlcjtcbiAgfT47XG4gIHNlY29uZGFyeUNvbmRpdGlvbnM6IEFycmF5PHtcbiAgICBjb25kaXRpb246IHN0cmluZztcbiAgICBzZXZlcml0eTogc3RyaW5nO1xuICAgIHdlaWdodDogbnVtYmVyO1xuICB9PjtcbiAgcHJlZmVycmVkQXBwcm9hY2hlczogc3RyaW5nW107XG4gIHNlc3Npb25QcmVmZXJlbmNlczoge1xuICAgIGZvcm1hdDogc3RyaW5nW107IC8vIG9ubGluZSwgaW4tcGVyc29uLCBoeWJyaWRcbiAgICBkdXJhdGlvbjogc3RyaW5nW107XG4gICAgZnJlcXVlbmN5OiBzdHJpbmc7XG4gIH07XG4gIGRlbW9ncmFwaGljczoge1xuICAgIGFnZVJhbmdlOiBzdHJpbmc7XG4gICAgZ2VuZGVyUHJlZmVyZW5jZT86IHN0cmluZztcbiAgICBsYW5ndWFnZVByZWZlcmVuY2U6IHN0cmluZ1tdO1xuICB9O1xuICBsb2dpc3RpY3M6IHtcbiAgICBtYXhIb3VybHlSYXRlPzogbnVtYmVyO1xuICAgIHByb3ZpbmNlPzogc3RyaW5nO1xuICAgIGluc3VyYW5jZVR5cGVzPzogc3RyaW5nW107XG4gIH07XG59XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBBZHZhbmNlZE1hdGNoaW5nU2VydmljZSB7XG4gIHByaXZhdGUgcmVhZG9ubHkgZGVmYXVsdFdlaWdodHM6IE1hdGNoaW5nV2VpZ2h0cyA9IHtcbiAgICBjb25kaXRpb25NYXRjaDogMC40LFxuICAgIGFwcHJvYWNoQ29tcGF0aWJpbGl0eTogMC4yNSxcbiAgICBleHBlcmllbmNlQW5kU3VjY2VzczogMC4yLFxuICAgIHJldmlld3NBbmRSYXRpbmdzOiAwLjEsXG4gICAgYXZhaWxhYmlsaXR5QW5kTG9naXN0aWNzOiAwLjA1LFxuICB9O1xuXG4gIHByaXZhdGUgcmVhZG9ubHkgc2V2ZXJpdHlXZWlnaHRzOiBTZXZlcml0eU1hcHBpbmcgPSB7XG4gICAgLy8gRGVwcmVzc2lvbi9BbnhpZXR5IHNjYWxlc1xuICAgIE1pbmltYWw6IDEsXG4gICAgTWlsZDogMixcbiAgICBNb2RlcmF0ZTogMyxcbiAgICAnTW9kZXJhdGVseSBTZXZlcmUnOiA0LFxuICAgIFNldmVyZTogNSxcbiAgICAnVmVyeSBTZXZlcmUnOiA1LFxuICAgIEV4dHJlbWU6IDUsXG5cbiAgICAvLyBHZW5lcmFsIHNldmVyaXR5IGxldmVsc1xuICAgIExvdzogMSxcbiAgICBIaWdoOiA0LFxuICAgIFN1YnN0YW50aWFsOiA0LFxuXG4gICAgLy8gQ2xpbmljYWwgdGhyZXNob2xkc1xuICAgIFN1YmNsaW5pY2FsOiAxLFxuICAgIENsaW5pY2FsOiA0LFxuICAgIFN1YnRocmVzaG9sZDogMixcblxuICAgIC8vIEJpbmFyeSBpbmRpY2F0b3JzXG4gICAgUG9zaXRpdmU6IDQsXG4gICAgTmVnYXRpdmU6IDAsXG4gICAgTm9uZTogMCxcbiAgfTtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIHJlYWRvbmx5IHByaXNtYTogUHJpc21hU2VydmljZSkge31cblxuICBhc3luYyBjYWxjdWxhdGVBZHZhbmNlZE1hdGNoKFxuICAgIGNsaWVudDogQ2xpZW50Rm9yTWF0Y2hpbmcsXG4gICAgdGhlcmFwaXN0OiBUaGVyYXBpc3RGb3JNYXRjaGluZyxcbiAgICB3ZWlnaHRzOiBNYXRjaGluZ1dlaWdodHMgPSB0aGlzLmRlZmF1bHRXZWlnaHRzLFxuICApOiBQcm9taXNlPFRoZXJhcGlzdFNjb3JlPiB7XG4gICAgLy8gSW5wdXQgdmFsaWRhdGlvbiB0byBwcmV2ZW50IHJ1bnRpbWUgZXJyb3JzXG4gICAgaWYgKCFjbGllbnQ/LnByZUFzc2Vzc21lbnQpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignQ2xpZW50IG11c3QgaGF2ZSBhIHZhbGlkIHByZS1hc3Nlc3NtZW50Jyk7XG4gICAgfVxuXG4gICAgaWYgKCFjbGllbnQuY2xpZW50UHJlZmVyZW5jZXMpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignQ2xpZW50IHByZWZlcmVuY2VzIGFyZSByZXF1aXJlZCBmb3IgbWF0Y2hpbmcnKTtcbiAgICB9XG5cbiAgICBpZiAoIXRoZXJhcGlzdD8udXNlcikge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdUaGVyYXBpc3QgbXVzdCBoYXZlIHZhbGlkIHVzZXIgaW5mb3JtYXRpb24nKTtcbiAgICB9XG4gICAgLy8gQnVpbGQgdXNlciBjb25kaXRpb24gcHJvZmlsZVxuICAgIGNvbnN0IHVzZXJQcm9maWxlID0gdGhpcy5idWlsZFVzZXJDb25kaXRpb25Qcm9maWxlKGNsaWVudCk7XG5cbiAgICAvLyBDYWxjdWxhdGUgaW5kaXZpZHVhbCBzY29yZSBjb21wb25lbnRzXG4gICAgY29uc3QgY29uZGl0aW9uU2NvcmUgPSB0aGlzLmNhbGN1bGF0ZUNvbmRpdGlvbk1hdGNoU2NvcmUoXG4gICAgICB1c2VyUHJvZmlsZSxcbiAgICAgIHRoZXJhcGlzdCxcbiAgICApO1xuICAgIGNvbnN0IGFwcHJvYWNoU2NvcmUgPSB0aGlzLmNhbGN1bGF0ZUFwcHJvYWNoQ29tcGF0aWJpbGl0eVNjb3JlKFxuICAgICAgdXNlclByb2ZpbGUsXG4gICAgICB0aGVyYXBpc3QsXG4gICAgKTtcbiAgICBjb25zdCBleHBlcmllbmNlU2NvcmUgPSB0aGlzLmNhbGN1bGF0ZUV4cGVyaWVuY2VBbmRTdWNjZXNzU2NvcmUoXG4gICAgICB1c2VyUHJvZmlsZSxcbiAgICAgIHRoZXJhcGlzdCxcbiAgICApO1xuICAgIGNvbnN0IHJldmlld1Njb3JlID0gYXdhaXQgdGhpcy5jYWxjdWxhdGVSZXZpZXdTY29yZSh0aGVyYXBpc3QpO1xuICAgIGNvbnN0IGxvZ2lzdGljc1Njb3JlID0gdGhpcy5jYWxjdWxhdGVMb2dpc3RpY3NTY29yZSh1c2VyUHJvZmlsZSwgdGhlcmFwaXN0KTtcblxuICAgIC8vIENhbGN1bGF0ZSB3ZWlnaHRlZCB0b3RhbCBzY29yZVxuICAgIGNvbnN0IHRvdGFsU2NvcmUgPSBNYXRoLnJvdW5kKFxuICAgICAgY29uZGl0aW9uU2NvcmUgKiB3ZWlnaHRzLmNvbmRpdGlvbk1hdGNoICtcbiAgICAgICAgYXBwcm9hY2hTY29yZSAqIHdlaWdodHMuYXBwcm9hY2hDb21wYXRpYmlsaXR5ICtcbiAgICAgICAgZXhwZXJpZW5jZVNjb3JlICogd2VpZ2h0cy5leHBlcmllbmNlQW5kU3VjY2VzcyArXG4gICAgICAgIHJldmlld1Njb3JlICogd2VpZ2h0cy5yZXZpZXdzQW5kUmF0aW5ncyArXG4gICAgICAgIGxvZ2lzdGljc1Njb3JlICogd2VpZ2h0cy5hdmFpbGFiaWxpdHlBbmRMb2dpc3RpY3MsXG4gICAgKTtcblxuICAgIC8vIEJ1aWxkIG1hdGNoIGV4cGxhbmF0aW9uXG4gICAgY29uc3QgbWF0Y2hFeHBsYW5hdGlvbiA9IHRoaXMuYnVpbGRNYXRjaEV4cGxhbmF0aW9uKFxuICAgICAgdXNlclByb2ZpbGUsXG4gICAgICB0aGVyYXBpc3QsXG4gICAgICBjb25kaXRpb25TY29yZSxcbiAgICAgIGFwcHJvYWNoU2NvcmUsXG4gICAgICBleHBlcmllbmNlU2NvcmUsXG4gICAgICByZXZpZXdTY29yZSxcbiAgICApO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIHRoZXJhcGlzdCxcbiAgICAgIHRvdGFsU2NvcmUsXG4gICAgICBicmVha2Rvd246IHtcbiAgICAgICAgY29uZGl0aW9uU2NvcmU6IE1hdGgucm91bmQoY29uZGl0aW9uU2NvcmUpLFxuICAgICAgICBhcHByb2FjaFNjb3JlOiBNYXRoLnJvdW5kKGFwcHJvYWNoU2NvcmUpLFxuICAgICAgICBleHBlcmllbmNlU2NvcmU6IE1hdGgucm91bmQoZXhwZXJpZW5jZVNjb3JlKSxcbiAgICAgICAgcmV2aWV3U2NvcmU6IE1hdGgucm91bmQocmV2aWV3U2NvcmUpLFxuICAgICAgICBsb2dpc3RpY3NTY29yZTogTWF0aC5yb3VuZChsb2dpc3RpY3NTY29yZSksXG4gICAgICB9LFxuICAgICAgbWF0Y2hFeHBsYW5hdGlvbixcbiAgICB9O1xuICB9XG5cbiAgcHJpdmF0ZSBidWlsZFVzZXJDb25kaXRpb25Qcm9maWxlKFxuICAgIGNsaWVudDogQ2xpZW50Rm9yTWF0Y2hpbmcsXG4gICk6IFVzZXJDb25kaXRpb25Qcm9maWxlIHtcbiAgICBjb25zdCBzZXZlcml0eUxldmVscyA9IGNsaWVudC5wcmVBc3Nlc3NtZW50LnNldmVyaXR5TGV2ZWxzIGFzIFJlY29yZDxcbiAgICAgIHN0cmluZyxcbiAgICAgIHN0cmluZ1xuICAgID47XG4gICAgY29uc3QgcXVlc3Rpb25uYWlyZXMgPSBjbGllbnQucHJlQXNzZXNzbWVudC5xdWVzdGlvbm5haXJlcyBhcyBzdHJpbmdbXTtcblxuICAgIC8vIENhdGVnb3JpemUgY29uZGl0aW9ucyBieSBzZXZlcml0eVxuICAgIGNvbnN0IHByaW1hcnlDb25kaXRpb25zOiBBcnJheTx7XG4gICAgICBjb25kaXRpb246IHN0cmluZztcbiAgICAgIHNldmVyaXR5OiBzdHJpbmc7XG4gICAgICB3ZWlnaHQ6IG51bWJlcjtcbiAgICB9PiA9IFtdO1xuICAgIGNvbnN0IHNlY29uZGFyeUNvbmRpdGlvbnM6IEFycmF5PHtcbiAgICAgIGNvbmRpdGlvbjogc3RyaW5nO1xuICAgICAgc2V2ZXJpdHk6IHN0cmluZztcbiAgICAgIHdlaWdodDogbnVtYmVyO1xuICAgIH0+ID0gW107XG5cbiAgICBxdWVzdGlvbm5haXJlcy5mb3JFYWNoKChjb25kaXRpb24pID0+IHtcbiAgICAgIGNvbnN0IHNldmVyaXR5ID0gc2V2ZXJpdHlMZXZlbHNbY29uZGl0aW9uXTtcbiAgICAgIGNvbnN0IHdlaWdodCA9IHRoaXMuc2V2ZXJpdHlXZWlnaHRzW3NldmVyaXR5XSB8fCAxO1xuXG4gICAgICBpZiAod2VpZ2h0ID49IDQpIHtcbiAgICAgICAgcHJpbWFyeUNvbmRpdGlvbnMucHVzaCh7IGNvbmRpdGlvbiwgc2V2ZXJpdHksIHdlaWdodCB9KTtcbiAgICAgIH0gZWxzZSBpZiAod2VpZ2h0ID49IDIpIHtcbiAgICAgICAgc2Vjb25kYXJ5Q29uZGl0aW9ucy5wdXNoKHsgY29uZGl0aW9uLCBzZXZlcml0eSwgd2VpZ2h0IH0pO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgLy8gRXh0cmFjdCBwcmVmZXJlbmNlcyBmcm9tIGNsaWVudCBwcmVmZXJlbmNlc1xuICAgIGNvbnN0IHByZWZlcmVuY2VzID0gdGhpcy5wYXJzZUNsaWVudFByZWZlcmVuY2VzKGNsaWVudC5jbGllbnRQcmVmZXJlbmNlcyk7XG5cbiAgICByZXR1cm4ge1xuICAgICAgcHJpbWFyeUNvbmRpdGlvbnMsXG4gICAgICBzZWNvbmRhcnlDb25kaXRpb25zLFxuICAgICAgcHJlZmVycmVkQXBwcm9hY2hlczogcHJlZmVyZW5jZXMuYXBwcm9hY2hlcyB8fCBbXSxcbiAgICAgIHNlc3Npb25QcmVmZXJlbmNlczoge1xuICAgICAgICBmb3JtYXQ6IHByZWZlcmVuY2VzLnNlc3Npb25Gb3JtYXQgfHwgWydvbmxpbmUnLCAnaW4tcGVyc29uJ10sXG4gICAgICAgIGR1cmF0aW9uOiBwcmVmZXJlbmNlcy5zZXNzaW9uRHVyYXRpb24gfHwgW10sXG4gICAgICAgIGZyZXF1ZW5jeTogcHJlZmVyZW5jZXMuc2Vzc2lvbkZyZXF1ZW5jeSB8fCAnd2Vla2x5JyxcbiAgICAgIH0sXG4gICAgICBkZW1vZ3JhcGhpY3M6IHtcbiAgICAgICAgYWdlUmFuZ2U6IHByZWZlcmVuY2VzLnRoZXJhcGlzdEFnZSB8fCAnYW55JyxcbiAgICAgICAgZ2VuZGVyUHJlZmVyZW5jZTogcHJlZmVyZW5jZXMudGhlcmFwaXN0R2VuZGVyLFxuICAgICAgICBsYW5ndWFnZVByZWZlcmVuY2U6IHByZWZlcmVuY2VzLmxhbmd1YWdlcyB8fCBbJ0VuZ2xpc2gnXSxcbiAgICAgIH0sXG4gICAgICBsb2dpc3RpY3M6IHtcbiAgICAgICAgbWF4SG91cmx5UmF0ZTogcHJlZmVyZW5jZXMubWF4QnVkZ2V0LFxuICAgICAgICBwcm92aW5jZTogcHJlZmVyZW5jZXMubG9jYXRpb24sXG4gICAgICAgIGluc3VyYW5jZVR5cGVzOiBwcmVmZXJlbmNlcy5pbnN1cmFuY2UgfHwgW10sXG4gICAgICB9LFxuICAgIH07XG4gIH1cblxuICAvKipcbiAgICogQ2FsY3VsYXRlcyBob3cgd2VsbCBhIHRoZXJhcGlzdCdzIGV4cGVydGlzZSBtYXRjaGVzIHRoZSBjbGllbnQncyBtZW50YWwgaGVhbHRoIGNvbmRpdGlvbnMuXG4gICAqXG4gICAqIFNjb3JpbmcgTG9naWM6XG4gICAqIC0gUHJpbWFyeSBjb25kaXRpb25zIChzZXZlcmUsIGNsaW5pY2FsKTogMzAgcG9pbnRzIGJhc2UsIHNjYWxlZCBieSBzZXZlcml0eSB3ZWlnaHQgKDEtNSlcbiAgICogLSBTZWNvbmRhcnkgY29uZGl0aW9ucyAobW9kZXJhdGUpOiAxNSBwb2ludHMgYmFzZSwgc2NhbGVkIGJ5IHNldmVyaXR5IHdlaWdodFxuICAgKiAtIEV4cGVydGlzZSBkZXB0aCBib251czogNSBwb2ludHMgcGVyIG1hdGNoZWQgY29uZGl0aW9uLCBtYXggMjAgYm9udXMgcG9pbnRzXG4gICAqIC0gVG90YWwgc2NvcmUgY2FwcGVkIGF0IDEwMCBwb2ludHNcbiAgICpcbiAgICogQHBhcmFtIHVzZXJQcm9maWxlIENsaWVudCdzIGNvbmRpdGlvbiBwcm9maWxlIHdpdGggc2V2ZXJpdHkgd2VpZ2h0c1xuICAgKiBAcGFyYW0gdGhlcmFwaXN0IFRoZXJhcGlzdCB3aXRoIGV4cGVydGlzZSBhbmQgc3BlY2lhbGl6YXRpb24gYXJyYXlzXG4gICAqIEByZXR1cm5zIFNjb3JlIGZyb20gMC0xMDAgaW5kaWNhdGluZyBjb25kaXRpb24gbWF0Y2ggcXVhbGl0eVxuICAgKi9cbiAgcHJpdmF0ZSBjYWxjdWxhdGVDb25kaXRpb25NYXRjaFNjb3JlKFxuICAgIHVzZXJQcm9maWxlOiBVc2VyQ29uZGl0aW9uUHJvZmlsZSxcbiAgICB0aGVyYXBpc3Q6IFRoZXJhcGlzdCxcbiAgKTogbnVtYmVyIHtcbiAgICBsZXQgc2NvcmUgPSAwO1xuICAgIGNvbnN0IGV4cGVydGlzZSA9IHRoZXJhcGlzdC5leHBlcnRpc2UgfHwgW107XG4gICAgY29uc3Qgc3BlY2lhbGl6YXRpb25zID0gdGhlcmFwaXN0LmlsbG5lc3NTcGVjaWFsaXphdGlvbnMgfHwgW107XG4gICAgY29uc3QgYWxsVGhlcmFwaXN0Q29uZGl0aW9ucyA9IFsuLi5leHBlcnRpc2UsIC4uLnNwZWNpYWxpemF0aW9uc107XG5cbiAgICAvLyBQcmltYXJ5IGNvbmRpdGlvbnMgc2NvcmluZzogbW9zdCBjcml0aWNhbCBjb25kaXRpb25zIGdldCBoaWdoZXN0IHdlaWdodFxuICAgIC8vIEJhc2Ugc2NvcmUgb2YgMzAgcG9pbnRzLCBtdWx0aXBsaWVkIGJ5IHNldmVyaXR5IHJhdGlvICh3ZWlnaHQvNSlcbiAgICAvLyBFeGFtcGxlOiBTZXZlcmUgZGVwcmVzc2lvbiAod2VpZ2h0PTUpID0gMzAgKiAoNS81KSA9IDMwIHBvaW50c1xuICAgIC8vIEV4YW1wbGU6IE1vZGVyYXRlIGFueGlldHkgKHdlaWdodD0zKSA9IDMwICogKDMvNSkgPSAxOCBwb2ludHNcbiAgICB1c2VyUHJvZmlsZS5wcmltYXJ5Q29uZGl0aW9ucy5mb3JFYWNoKCh7IGNvbmRpdGlvbiwgd2VpZ2h0IH0pID0+IHtcbiAgICAgIGlmIChhbGxUaGVyYXBpc3RDb25kaXRpb25zLmluY2x1ZGVzKGNvbmRpdGlvbikpIHtcbiAgICAgICAgc2NvcmUgKz0gMzAgKiAod2VpZ2h0IC8gNSk7IC8vIFNjYWxlIGJ5IHNldmVyaXR5ICgxLTUgcmFuZ2UpXG4gICAgICB9XG4gICAgfSk7XG5cbiAgICAvLyBTZWNvbmRhcnkgY29uZGl0aW9ucyBzY29yaW5nOiBsZXNzIGNyaXRpY2FsIGJ1dCBzdGlsbCBpbXBvcnRhbnRcbiAgICAvLyBCYXNlIHNjb3JlIG9mIDE1IHBvaW50cywgYWxzbyBzY2FsZWQgYnkgc2V2ZXJpdHlcbiAgICB1c2VyUHJvZmlsZS5zZWNvbmRhcnlDb25kaXRpb25zLmZvckVhY2goKHsgY29uZGl0aW9uLCB3ZWlnaHQgfSkgPT4ge1xuICAgICAgaWYgKGFsbFRoZXJhcGlzdENvbmRpdGlvbnMuaW5jbHVkZXMoY29uZGl0aW9uKSkge1xuICAgICAgICBzY29yZSArPSAxNSAqICh3ZWlnaHQgLyA1KTsgLy8gU2NhbGUgYnkgc2V2ZXJpdHkgKDEtNSByYW5nZSlcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIC8vIEV4cGVydGlzZSBkZXB0aCBib251czogcmV3YXJkIHRoZXJhcGlzdHMgd2hvIG1hdGNoIG11bHRpcGxlIGNvbmRpdGlvbnNcbiAgICAvLyBUaGlzIGluZGljYXRlcyBicm9hZGVyIGNvbXBldGVuY3kgaW4gdGhlIGNsaWVudCdzIHByb2JsZW0gYXJlYXNcbiAgICBjb25zdCBtYXRjaGVkQ29uZGl0aW9ucyA9IFtcbiAgICAgIC4uLnVzZXJQcm9maWxlLnByaW1hcnlDb25kaXRpb25zLm1hcCgoYykgPT4gYy5jb25kaXRpb24pLFxuICAgICAgLi4udXNlclByb2ZpbGUuc2Vjb25kYXJ5Q29uZGl0aW9ucy5tYXAoKGMpID0+IGMuY29uZGl0aW9uKSxcbiAgICBdLmZpbHRlcigoY29uZGl0aW9uKSA9PiBhbGxUaGVyYXBpc3RDb25kaXRpb25zLmluY2x1ZGVzKGNvbmRpdGlvbikpO1xuXG4gICAgLy8gNSBwb2ludHMgcGVyIG1hdGNoZWQgY29uZGl0aW9uLCBjYXBwZWQgYXQgMjAgdG8gcHJldmVudCBvdmVyd2VpZ2h0aW5nXG4gICAgY29uc3QgZXhwZXJ0aXNlRGVwdGhCb251cyA9IE1hdGgubWluKG1hdGNoZWRDb25kaXRpb25zLmxlbmd0aCAqIDUsIDIwKTtcbiAgICBzY29yZSArPSBleHBlcnRpc2VEZXB0aEJvbnVzO1xuXG4gICAgLy8gQ2FwIGZpbmFsIHNjb3JlIGF0IDEwMCB0byBtYWludGFpbiBjb25zaXN0ZW50IHNjb3Jpbmcgc2NhbGVcbiAgICByZXR1cm4gTWF0aC5taW4oc2NvcmUsIDEwMCk7XG4gIH1cblxuICBwcml2YXRlIGNhbGN1bGF0ZUFwcHJvYWNoQ29tcGF0aWJpbGl0eVNjb3JlKFxuICAgIHVzZXJQcm9maWxlOiBVc2VyQ29uZGl0aW9uUHJvZmlsZSxcbiAgICB0aGVyYXBpc3Q6IFRoZXJhcGlzdCxcbiAgKTogbnVtYmVyIHtcbiAgICBsZXQgc2NvcmUgPSAwO1xuICAgIGNvbnN0IHRoZXJhcGlzdEFwcHJvYWNoZXMgPSB0aGVyYXBpc3QuYXBwcm9hY2hlcyB8fCBbXTtcbiAgICBjb25zdCB0aGVyYXBpc3RBcHByb2FjaGVzTGlzdCA9XG4gICAgICB0aGVyYXBpc3QudGhlcmFwZXV0aWNBcHByb2FjaGVzVXNlZExpc3QgfHwgW107XG4gICAgY29uc3QgYWxsQXBwcm9hY2hlcyA9IFsuLi50aGVyYXBpc3RBcHByb2FjaGVzLCAuLi50aGVyYXBpc3RBcHByb2FjaGVzTGlzdF07XG5cbiAgICAvLyBJZiB1c2VyIGhhcyBwcmVmZXJyZWQgYXBwcm9hY2hlcywgbWF0Y2ggdGhlbVxuICAgIGlmICh1c2VyUHJvZmlsZS5wcmVmZXJyZWRBcHByb2FjaGVzLmxlbmd0aCA+IDApIHtcbiAgICAgIGNvbnN0IG1hdGNoZWRBcHByb2FjaGVzID0gdXNlclByb2ZpbGUucHJlZmVycmVkQXBwcm9hY2hlcy5maWx0ZXIoXG4gICAgICAgIChhcHByb2FjaCkgPT4gYWxsQXBwcm9hY2hlcy5pbmNsdWRlcyhhcHByb2FjaCksXG4gICAgICApO1xuXG4gICAgICBzY29yZSA9XG4gICAgICAgIChtYXRjaGVkQXBwcm9hY2hlcy5sZW5ndGggLyB1c2VyUHJvZmlsZS5wcmVmZXJyZWRBcHByb2FjaGVzLmxlbmd0aCkgKlxuICAgICAgICAxMDA7XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIElmIG5vIHByZWZlcmVuY2Ugc3BlY2lmaWVkLCBnaXZlIHBvaW50cyBmb3IgZXZpZGVuY2UtYmFzZWQgYXBwcm9hY2hlc1xuICAgICAgY29uc3QgZXZpZGVuY2VCYXNlZEFwcHJvYWNoZXMgPSBbXG4gICAgICAgICdDb2duaXRpdmUgQmVoYXZpb3JhbCBUaGVyYXB5IChDQlQpJyxcbiAgICAgICAgJ0RpYWxlY3RpY2FsIEJlaGF2aW9yIFRoZXJhcHkgKERCVCknLFxuICAgICAgICAnQWNjZXB0YW5jZSBhbmQgQ29tbWl0bWVudCBUaGVyYXB5IChBQ1QpJyxcbiAgICAgICAgJ0V5ZSBNb3ZlbWVudCBEZXNlbnNpdGl6YXRpb24gYW5kIFJlcHJvY2Vzc2luZyAoRU1EUiknLFxuICAgICAgICAnTWluZGZ1bG5lc3MtQmFzZWQgQ29nbml0aXZlIFRoZXJhcHkgKE1CQ1QpJyxcbiAgICAgIF07XG5cbiAgICAgIGNvbnN0IGV2aWRlbmNlQmFzZWRDb3VudCA9IGFsbEFwcHJvYWNoZXMuZmlsdGVyKChhcHByb2FjaCkgPT5cbiAgICAgICAgZXZpZGVuY2VCYXNlZEFwcHJvYWNoZXMuaW5jbHVkZXMoYXBwcm9hY2gpLFxuICAgICAgKS5sZW5ndGg7XG5cbiAgICAgIHNjb3JlID0gTWF0aC5taW4oZXZpZGVuY2VCYXNlZENvdW50ICogMjAsIDgwKTsgLy8gTWF4IDgwIGZvciBnZW5lcmFsIGV2aWRlbmNlLWJhc2VkXG4gICAgfVxuXG4gICAgLy8gQm9udXMgZm9yIGNvbXByZWhlbnNpdmUgYXBwcm9hY2ggZGl2ZXJzaXR5XG4gICAgY29uc3QgZGl2ZXJzaXR5Qm9udXMgPSBNYXRoLm1pbihhbGxBcHByb2FjaGVzLmxlbmd0aCAqIDIsIDIwKTtcbiAgICBzY29yZSArPSBkaXZlcnNpdHlCb251cztcblxuICAgIHJldHVybiBNYXRoLm1pbihzY29yZSwgMTAwKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDYWxjdWxhdGVzIHRoZXJhcGlzdCBleHBlcmllbmNlIGFuZCBzdWNjZXNzIHJhdGUgc2NvcmUgdXNpbmcgYSBkaW1pbmlzaGluZyByZXR1cm5zIGN1cnZlLlxuICAgKlxuICAgKiBFeHBlcmllbmNlIFNjb3JpbmcgKDcwLTkwIHBvaW50cyk6XG4gICAqIC0gWWVhcnMgMC01OiA4IHBvaW50cyBwZXIgeWVhciAoMC00MCBwb2ludHMpIC0gbmV3IHRoZXJhcGlzdCBsZWFybmluZyBjdXJ2ZVxuICAgKiAtIFllYXJzIDUtMTA6IDYgcG9pbnRzIHBlciB5ZWFyICg0MC03MCBwb2ludHMpIC0gZXhwZXJpZW5jZWQgYnV0IHN0aWxsIGdyb3dpbmdcbiAgICogLSBZZWFycyAxMCs6IDIgcG9pbnRzIHBlciB5ZWFyICg3MC05MCBwb2ludHMsIG1heCAyMCBib251cykgLSBkaW1pbmlzaGluZyByZXR1cm5zXG4gICAqXG4gICAqIFN1Y2Nlc3MgUmF0ZSBCb251cyAoMC0yMCBwb2ludHMpOlxuICAgKiAtIEJhc2VkIG9uIHRoZXJhcGlzdCdzIGRvY3VtZW50ZWQgc3VjY2VzcyByYXRlcyBmb3IgY2xpZW50J3Mgc3BlY2lmaWMgY29uZGl0aW9uc1xuICAgKiAtIEF2ZXJhZ2VzIHN1Y2Nlc3MgcmF0ZXMgYWNyb3NzIGFsbCByZWxldmFudCBjb25kaXRpb25zXG4gICAqIC0gU2NhbGVzIGxpbmVhcmx5OiA4MCUgc3VjY2VzcyByYXRlID0gMTYgYm9udXMgcG9pbnRzXG4gICAqXG4gICAqIEBwYXJhbSB1c2VyUHJvZmlsZSBDbGllbnQncyBjb25kaXRpb24gcHJvZmlsZVxuICAgKiBAcGFyYW0gdGhlcmFwaXN0IFRoZXJhcGlzdCB3aXRoIGV4cGVyaWVuY2UgYW5kIHN1Y2Nlc3MgcmF0ZSBkYXRhXG4gICAqIEByZXR1cm5zIFNjb3JlIGZyb20gMC0xMDAgaW5kaWNhdGluZyBleHBlcmllbmNlIHF1YWxpdHlcbiAgICovXG4gIHByaXZhdGUgY2FsY3VsYXRlRXhwZXJpZW5jZUFuZFN1Y2Nlc3NTY29yZShcbiAgICB1c2VyUHJvZmlsZTogVXNlckNvbmRpdGlvblByb2ZpbGUsXG4gICAgdGhlcmFwaXN0OiBUaGVyYXBpc3QsXG4gICk6IG51bWJlciB7XG4gICAgbGV0IHNjb3JlID0gMDtcblxuICAgIC8vIENhbGN1bGF0ZSB0b3RhbCB5ZWFycyBvZiBleHBlcmllbmNlIGZyb20gbXVsdGlwbGUgc291cmNlc1xuICAgIGNvbnN0IHllYXJzRXhwZXJpZW5jZSA9IHRoaXMuY2FsY3VsYXRlWWVhcnNPZkV4cGVyaWVuY2UoXG4gICAgICB0aGVyYXBpc3QucHJhY3RpY2VTdGFydERhdGUsXG4gICAgKTtcbiAgICBjb25zdCBhZGRpdGlvbmFsWWVhcnMgPSB0aGVyYXBpc3QueWVhcnNPZkV4cGVyaWVuY2UgfHwgMDtcbiAgICBjb25zdCB0b3RhbFllYXJzID0gTWF0aC5tYXgoeWVhcnNFeHBlcmllbmNlLCBhZGRpdGlvbmFsWWVhcnMpO1xuXG4gICAgLy8gRXhwZXJpZW5jZSBzY29yaW5nIHdpdGggZGltaW5pc2hpbmcgcmV0dXJucyBjdXJ2ZVxuICAgIC8vIFJlZmxlY3RzIHRoYXQgZXhwZXJpZW5jZSBnYWlucyBhcmUgbW9zdCB2YWx1YWJsZSBlYXJseSBpbiBjYXJlZXJcbiAgICBpZiAodG90YWxZZWFycyA8PSA1KSB7XG4gICAgICAvLyBOZXcgdGhlcmFwaXN0czogaGlnaCBsZWFybmluZyBjdXJ2ZSwgc2lnbmlmaWNhbnQgaW1wcm92ZW1lbnQgcGVyIHllYXJcbiAgICAgIHNjb3JlICs9IHRvdGFsWWVhcnMgKiA4OyAvLyAwLTQwIHBvaW50cyBmb3IgMC01IHllYXJzXG4gICAgfSBlbHNlIGlmICh0b3RhbFllYXJzIDw9IDEwKSB7XG4gICAgICAvLyBFeHBlcmllbmNlZCB0aGVyYXBpc3RzOiBzdGlsbCBnYWluaW5nIHNraWxscyBidXQgYXQgc2xvd2VyIHJhdGVcbiAgICAgIHNjb3JlICs9IDQwICsgKHRvdGFsWWVhcnMgLSA1KSAqIDY7IC8vIDQwLTcwIHBvaW50cyBmb3IgNS0xMCB5ZWFyc1xuICAgIH0gZWxzZSB7XG4gICAgICAvLyBTZW5pb3IgdGhlcmFwaXN0czogZGltaW5pc2hpbmcgcmV0dXJucywgbWF4IHByYWN0aWNhbCBiZW5lZml0IGFyb3VuZCAxNS0yMCB5ZWFyc1xuICAgICAgc2NvcmUgKz0gNzAgKyBNYXRoLm1pbigodG90YWxZZWFycyAtIDEwKSAqIDIsIDIwKTsgLy8gNzAtOTAgcG9pbnRzIGZvciAxMCsgeWVhcnNcbiAgICB9XG5cbiAgICAvLyBUcmVhdG1lbnQgc3VjY2VzcyByYXRlcyBib251czogcmV3YXJkIGRvY3VtZW50ZWQgZWZmZWN0aXZlbmVzc1xuICAgIC8vIE9ubHkgY29uc2lkZXJzIHN1Y2Nlc3MgcmF0ZXMgZm9yIGNvbmRpdGlvbnMgcmVsZXZhbnQgdG8gdGhpcyBzcGVjaWZpYyBjbGllbnRcbiAgICBjb25zdCBzdWNjZXNzUmF0ZXMgPVxuICAgICAgKHRoZXJhcGlzdC50cmVhdG1lbnRTdWNjZXNzUmF0ZXMgYXMgUmVjb3JkPHN0cmluZywgbnVtYmVyPikgfHwge307XG4gICAgY29uc3QgcmVsZXZhbnRDb25kaXRpb25zID0gW1xuICAgICAgLi4udXNlclByb2ZpbGUucHJpbWFyeUNvbmRpdGlvbnMubWFwKChjKSA9PiBjLmNvbmRpdGlvbiksXG4gICAgICAuLi51c2VyUHJvZmlsZS5zZWNvbmRhcnlDb25kaXRpb25zLm1hcCgoYykgPT4gYy5jb25kaXRpb24pLFxuICAgIF07XG5cbiAgICBsZXQgc3VjY2Vzc1JhdGVCb251cyA9IDA7XG4gICAgbGV0IGFwcGxpY2FibGVSYXRlcyA9IDA7XG5cbiAgICAvLyBDYWxjdWxhdGUgYXZlcmFnZSBzdWNjZXNzIHJhdGUgYWNyb3NzIGFsbCByZWxldmFudCBjb25kaXRpb25zXG4gICAgcmVsZXZhbnRDb25kaXRpb25zLmZvckVhY2goKGNvbmRpdGlvbikgPT4ge1xuICAgICAgaWYgKHN1Y2Nlc3NSYXRlc1tjb25kaXRpb25dICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgc3VjY2Vzc1JhdGVCb251cyArPSBzdWNjZXNzUmF0ZXNbY29uZGl0aW9uXTtcbiAgICAgICAgYXBwbGljYWJsZVJhdGVzKys7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICBpZiAoYXBwbGljYWJsZVJhdGVzID4gMCkge1xuICAgICAgY29uc3QgYXZlcmFnZVN1Y2Nlc3NSYXRlID0gc3VjY2Vzc1JhdGVCb251cyAvIGFwcGxpY2FibGVSYXRlcztcbiAgICAgIC8vIENvbnZlcnQgcGVyY2VudGFnZSB0byBwb2ludHM6IDEwMCUgc3VjY2VzcyA9IDIwIHBvaW50cywgNTAlID0gMTAgcG9pbnRzXG4gICAgICBzY29yZSArPSAoYXZlcmFnZVN1Y2Nlc3NSYXRlIC8gMTAwKSAqIDIwOyAvLyBVcCB0byAyMCBib251cyBwb2ludHNcbiAgICB9XG5cbiAgICByZXR1cm4gTWF0aC5taW4oc2NvcmUsIDEwMCk7XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGNhbGN1bGF0ZVJldmlld1Njb3JlKFxuICAgIHRoZXJhcGlzdDogVGhlcmFwaXN0Rm9yTWF0Y2hpbmcsXG4gICk6IFByb21pc2U8bnVtYmVyPiB7XG4gICAgaWYgKCF0aGVyYXBpc3QucmV2aWV3cyB8fCB0aGVyYXBpc3QucmV2aWV3cy5sZW5ndGggPT09IDApIHtcbiAgICAgIHJldHVybiA1MDsgLy8gTmV1dHJhbCBzY29yZSBmb3IgbmV3IHRoZXJhcGlzdHNcbiAgICB9XG5cbiAgICBjb25zdCBhcHByb3ZlZFJldmlld3MgPSB0aGVyYXBpc3QucmV2aWV3cy5maWx0ZXIoXG4gICAgICAocmV2aWV3KSA9PiByZXZpZXcuc3RhdHVzID09PSAnQVBQUk9WRUQnLFxuICAgICk7XG5cbiAgICBpZiAoYXBwcm92ZWRSZXZpZXdzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgcmV0dXJuIDUwO1xuICAgIH1cblxuICAgIC8vIENhbGN1bGF0ZSBhdmVyYWdlIHJhdGluZ1xuICAgIGNvbnN0IHRvdGFsUmF0aW5nID0gYXBwcm92ZWRSZXZpZXdzLnJlZHVjZShcbiAgICAgIChzdW0sIHJldmlldykgPT4gc3VtICsgcmV2aWV3LnJhdGluZyxcbiAgICAgIDAsXG4gICAgKTtcbiAgICBjb25zdCBhdmVyYWdlUmF0aW5nID0gdG90YWxSYXRpbmcgLyBhcHByb3ZlZFJldmlld3MubGVuZ3RoO1xuXG4gICAgLy8gQ29udmVydCAxLTUgcmF0aW5nIHRvIDAtMTAwIHNjb3JlXG4gICAgbGV0IHNjb3JlID0gKChhdmVyYWdlUmF0aW5nIC0gMSkgLyA0KSAqIDEwMDtcblxuICAgIC8vIEJvbnVzIGZvciB2b2x1bWUgb2YgcmV2aWV3cyAoY3JlZGliaWxpdHkgZmFjdG9yKVxuICAgIGNvbnN0IHZvbHVtZUJvbnVzID0gTWF0aC5taW4oYXBwcm92ZWRSZXZpZXdzLmxlbmd0aCAqIDIsIDIwKTtcbiAgICBzY29yZSArPSB2b2x1bWVCb251cztcblxuICAgIC8vIFBlbmFsdHkgZm9yIHZlcnkgZmV3IHJldmlld3NcbiAgICBpZiAoYXBwcm92ZWRSZXZpZXdzLmxlbmd0aCA8IDMpIHtcbiAgICAgIHNjb3JlICo9IDAuODsgLy8gMjAlIHBlbmFsdHkgZm9yIGxvdyByZXZpZXcgY291bnRcbiAgICB9XG5cbiAgICByZXR1cm4gTWF0aC5taW4oc2NvcmUsIDEwMCk7XG4gIH1cblxuICBwcml2YXRlIGNhbGN1bGF0ZUxvZ2lzdGljc1Njb3JlKFxuICAgIHVzZXJQcm9maWxlOiBVc2VyQ29uZGl0aW9uUHJvZmlsZSxcbiAgICB0aGVyYXBpc3Q6IFRoZXJhcGlzdCxcbiAgKTogbnVtYmVyIHtcbiAgICBsZXQgc2NvcmUgPSAxMDA7IC8vIFN0YXJ0IHdpdGggcGVyZmVjdCBzY29yZSwgZGVkdWN0IGZvciBtaXNtYXRjaGVzXG5cbiAgICAvLyBMb2NhdGlvbiBtYXRjaGluZ1xuICAgIGlmIChcbiAgICAgIHVzZXJQcm9maWxlLmxvZ2lzdGljcy5wcm92aW5jZSAmJlxuICAgICAgdGhlcmFwaXN0LnByb3ZpbmNlICE9PSB1c2VyUHJvZmlsZS5sb2dpc3RpY3MucHJvdmluY2VcbiAgICApIHtcbiAgICAgIHNjb3JlIC09IDMwOyAvLyBTaWduaWZpY2FudCBwZW5hbHR5IGZvciBsb2NhdGlvbiBtaXNtYXRjaFxuICAgIH1cblxuICAgIC8vIEJ1ZGdldCBjb21wYXRpYmlsaXR5XG4gICAgaWYgKFxuICAgICAgdXNlclByb2ZpbGUubG9naXN0aWNzLm1heEhvdXJseVJhdGUgJiZcbiAgICAgIE51bWJlcih0aGVyYXBpc3QuaG91cmx5UmF0ZSkgPiB1c2VyUHJvZmlsZS5sb2dpc3RpY3MubWF4SG91cmx5UmF0ZVxuICAgICkge1xuICAgICAgc2NvcmUgLT0gNDA7IC8vIE1ham9yIHBlbmFsdHkgZm9yIGJ1ZGdldCBvdmVycnVuXG4gICAgfVxuXG4gICAgLy8gSW5zdXJhbmNlIGNvbXBhdGliaWxpdHlcbiAgICBpZiAoXG4gICAgICB1c2VyUHJvZmlsZS5sb2dpc3RpY3MuaW5zdXJhbmNlVHlwZXMgJiZcbiAgICAgIHVzZXJQcm9maWxlLmxvZ2lzdGljcy5pbnN1cmFuY2VUeXBlcy5sZW5ndGggPiAwXG4gICAgKSB7XG4gICAgICBjb25zdCBhY2NlcHRlZFR5cGVzID0gdGhlcmFwaXN0LmFjY2VwdGVkSW5zdXJhbmNlVHlwZXMgfHwgW107XG4gICAgICBjb25zdCBoYXNJbnN1cmFuY2VNYXRjaCA9IHVzZXJQcm9maWxlLmxvZ2lzdGljcy5pbnN1cmFuY2VUeXBlcy5zb21lKFxuICAgICAgICAodHlwZSkgPT4gYWNjZXB0ZWRUeXBlcy5pbmNsdWRlcyh0eXBlKSxcbiAgICAgICk7XG5cbiAgICAgIGlmICghaGFzSW5zdXJhbmNlTWF0Y2ggJiYgdGhlcmFwaXN0LmFjY2VwdHNJbnN1cmFuY2UpIHtcbiAgICAgICAgc2NvcmUgLT0gMjA7IC8vIFBlbmFsdHkgZm9yIGluc3VyYW5jZSBtaXNtYXRjaFxuICAgICAgfVxuICAgIH1cblxuICAgIC8vIExhbmd1YWdlIGNvbXBhdGliaWxpdHlcbiAgICBjb25zdCB0aGVyYXBpc3RMYW5ndWFnZXMgPSB0aGVyYXBpc3QubGFuZ3VhZ2VzT2ZmZXJlZCB8fCBbJ0VuZ2xpc2gnXTtcbiAgICBjb25zdCBoYXNMYW5ndWFnZU1hdGNoID0gdXNlclByb2ZpbGUuZGVtb2dyYXBoaWNzLmxhbmd1YWdlUHJlZmVyZW5jZS5zb21lKFxuICAgICAgKGxhbmcpID0+IHRoZXJhcGlzdExhbmd1YWdlcy5pbmNsdWRlcyhsYW5nKSxcbiAgICApO1xuXG4gICAgaWYgKCFoYXNMYW5ndWFnZU1hdGNoKSB7XG4gICAgICBzY29yZSAtPSAyNTsgLy8gUGVuYWx0eSBmb3IgbGFuZ3VhZ2UgYmFycmllclxuICAgIH1cblxuICAgIHJldHVybiBNYXRoLm1heChzY29yZSwgMCk7XG4gIH1cblxuICBwcml2YXRlIGJ1aWxkTWF0Y2hFeHBsYW5hdGlvbihcbiAgICB1c2VyUHJvZmlsZTogVXNlckNvbmRpdGlvblByb2ZpbGUsXG4gICAgdGhlcmFwaXN0OiBUaGVyYXBpc3RGb3JNYXRjaGluZyxcbiAgICBjb25kaXRpb25TY29yZTogbnVtYmVyLFxuICAgIGFwcHJvYWNoU2NvcmU6IG51bWJlcixcbiAgICBleHBlcmllbmNlU2NvcmU6IG51bWJlcixcbiAgICByZXZpZXdTY29yZTogbnVtYmVyLFxuICApOiBUaGVyYXBpc3RTY29yZVsnbWF0Y2hFeHBsYW5hdGlvbiddIHtcbiAgICBjb25zdCBleHBlcnRpc2UgPSB0aGVyYXBpc3QuZXhwZXJ0aXNlIHx8IFtdO1xuICAgIGNvbnN0IHNwZWNpYWxpemF0aW9ucyA9IHRoZXJhcGlzdC5pbGxuZXNzU3BlY2lhbGl6YXRpb25zIHx8IFtdO1xuICAgIGNvbnN0IGFwcHJvYWNoZXMgPSBbXG4gICAgICAuLi4odGhlcmFwaXN0LmFwcHJvYWNoZXMgfHwgW10pLFxuICAgICAgLi4uKHRoZXJhcGlzdC50aGVyYXBldXRpY0FwcHJvYWNoZXNVc2VkTGlzdCB8fCBbXSksXG4gICAgXTtcblxuICAgIGNvbnN0IHByaW1hcnlNYXRjaGVzID0gdXNlclByb2ZpbGUucHJpbWFyeUNvbmRpdGlvbnNcbiAgICAgIC5tYXAoKGMpID0+IGMuY29uZGl0aW9uKVxuICAgICAgLmZpbHRlcigoY29uZGl0aW9uKSA9PlxuICAgICAgICBbLi4uZXhwZXJ0aXNlLCAuLi5zcGVjaWFsaXphdGlvbnNdLmluY2x1ZGVzKGNvbmRpdGlvbiksXG4gICAgICApO1xuXG4gICAgY29uc3Qgc2Vjb25kYXJ5TWF0Y2hlcyA9IHVzZXJQcm9maWxlLnNlY29uZGFyeUNvbmRpdGlvbnNcbiAgICAgIC5tYXAoKGMpID0+IGMuY29uZGl0aW9uKVxuICAgICAgLmZpbHRlcigoY29uZGl0aW9uKSA9PlxuICAgICAgICBbLi4uZXhwZXJ0aXNlLCAuLi5zcGVjaWFsaXphdGlvbnNdLmluY2x1ZGVzKGNvbmRpdGlvbiksXG4gICAgICApO1xuXG4gICAgY29uc3QgYXBwcm9hY2hNYXRjaGVzID0gdXNlclByb2ZpbGUucHJlZmVycmVkQXBwcm9hY2hlcy5maWx0ZXIoKGFwcHJvYWNoKSA9PlxuICAgICAgYXBwcm9hY2hlcy5pbmNsdWRlcyhhcHByb2FjaCksXG4gICAgKTtcblxuICAgIGNvbnN0IGV4cGVyaWVuY2VZZWFycyA9IHRoaXMuY2FsY3VsYXRlWWVhcnNPZkV4cGVyaWVuY2UoXG4gICAgICB0aGVyYXBpc3QucHJhY3RpY2VTdGFydERhdGUsXG4gICAgKTtcblxuICAgIGNvbnN0IGFwcHJvdmVkUmV2aWV3cyA9XG4gICAgICB0aGVyYXBpc3QucmV2aWV3cz8uZmlsdGVyKChyKSA9PiByLnN0YXR1cyA9PT0gJ0FQUFJPVkVEJykgfHwgW107XG4gICAgY29uc3QgYXZlcmFnZVJhdGluZyA9XG4gICAgICBhcHByb3ZlZFJldmlld3MubGVuZ3RoID4gMFxuICAgICAgICA/IGFwcHJvdmVkUmV2aWV3cy5yZWR1Y2UoKHN1bSwgcikgPT4gc3VtICsgci5yYXRpbmcsIDApIC9cbiAgICAgICAgICBhcHByb3ZlZFJldmlld3MubGVuZ3RoXG4gICAgICAgIDogMDtcblxuICAgIGNvbnN0IHN1Y2Nlc3NSYXRlcyA9XG4gICAgICAodGhlcmFwaXN0LnRyZWF0bWVudFN1Y2Nlc3NSYXRlcyBhcyBSZWNvcmQ8c3RyaW5nLCBudW1iZXI+KSB8fCB7fTtcblxuICAgIHJldHVybiB7XG4gICAgICBwcmltYXJ5TWF0Y2hlcyxcbiAgICAgIHNlY29uZGFyeU1hdGNoZXMsXG4gICAgICBhcHByb2FjaE1hdGNoZXMsXG4gICAgICBleHBlcmllbmNlWWVhcnM6IE1hdGgubWF4KFxuICAgICAgICBleHBlcmllbmNlWWVhcnMsXG4gICAgICAgIHRoZXJhcGlzdC55ZWFyc09mRXhwZXJpZW5jZSB8fCAwLFxuICAgICAgKSxcbiAgICAgIGF2ZXJhZ2VSYXRpbmc6IE1hdGgucm91bmQoYXZlcmFnZVJhdGluZyAqIDEwKSAvIDEwLFxuICAgICAgdG90YWxSZXZpZXdzOiBhcHByb3ZlZFJldmlld3MubGVuZ3RoLFxuICAgICAgc3VjY2Vzc1JhdGVzLFxuICAgIH07XG4gIH1cblxuICBwcml2YXRlIHBhcnNlQ2xpZW50UHJlZmVyZW5jZXMoXG4gICAgcHJlZmVyZW5jZXM6IENsaWVudFByZWZlcmVuY2VbXSxcbiAgKTogUmVjb3JkPHN0cmluZywgdW5rbm93bj4ge1xuICAgIGNvbnN0IHBhcnNlZDogUmVjb3JkPHN0cmluZywgdW5rbm93bj4gPSB7fTtcblxuICAgIHByZWZlcmVuY2VzLmZvckVhY2goKHByZWYpID0+IHtcbiAgICAgIHRyeSB7XG4gICAgICAgIC8vIEhhbmRsZSBKU09OIHN0cmluZyB2YWx1ZXNcbiAgICAgICAgaWYgKHR5cGVvZiBwcmVmLnZhbHVlID09PSAnc3RyaW5nJyAmJiBwcmVmLnZhbHVlLnN0YXJ0c1dpdGgoJ1snKSkge1xuICAgICAgICAgIHBhcnNlZFtwcmVmLmtleV0gPSBKU09OLnBhcnNlKHByZWYudmFsdWUpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHBhcnNlZFtwcmVmLmtleV0gPSBwcmVmLnZhbHVlO1xuICAgICAgICB9XG4gICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAvLyBMb2cgcGFyc2luZyBlcnJvcnMgZm9yIGRlYnVnZ2luZyBidXQgY29udGludWUgd2l0aCBmYWxsYmFja1xuICAgICAgICBjb25zb2xlLndhcm4oYEZhaWxlZCB0byBwYXJzZSBjbGllbnQgcHJlZmVyZW5jZSAke3ByZWYua2V5fTpgLCBlcnJvcik7XG4gICAgICAgIHBhcnNlZFtwcmVmLmtleV0gPSBwcmVmLnZhbHVlOyAvLyBGYWxsYmFjayB0byByYXcgdmFsdWVcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIHJldHVybiBwYXJzZWQ7XG4gIH1cblxuICBwcml2YXRlIGNhbGN1bGF0ZVllYXJzT2ZFeHBlcmllbmNlKHN0YXJ0RGF0ZTogRGF0ZSk6IG51bWJlciB7XG4gICAgY29uc3Qgbm93ID0gbmV3IERhdGUoKTtcbiAgICBsZXQgeWVhcnMgPSBub3cuZ2V0RnVsbFllYXIoKSAtIHN0YXJ0RGF0ZS5nZXRGdWxsWWVhcigpO1xuXG4gICAgaWYgKFxuICAgICAgbm93LmdldE1vbnRoKCkgPCBzdGFydERhdGUuZ2V0TW9udGgoKSB8fFxuICAgICAgKG5vdy5nZXRNb250aCgpID09PSBzdGFydERhdGUuZ2V0TW9udGgoKSAmJlxuICAgICAgICBub3cuZ2V0RGF0ZSgpIDwgc3RhcnREYXRlLmdldERhdGUoKSlcbiAgICApIHtcbiAgICAgIHllYXJzLS07XG4gICAgfVxuXG4gICAgcmV0dXJuIE1hdGgubWF4KHllYXJzLCAwKTtcbiAgfVxufVxuIl0sInZlcnNpb24iOjN9