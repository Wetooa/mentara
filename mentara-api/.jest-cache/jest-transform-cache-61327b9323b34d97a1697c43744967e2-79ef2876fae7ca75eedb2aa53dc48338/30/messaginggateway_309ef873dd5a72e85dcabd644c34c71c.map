{"file":"/home/wetooa/Documents/code/projects/mentara/mentara-api/src/messaging/messaging.gateway.ts","mappings":"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","names":[],"sources":["/home/wetooa/Documents/code/projects/mentara/mentara-api/src/messaging/messaging.gateway.ts"],"sourcesContent":["import {\n  WebSocketGateway,\n  WebSocketServer,\n  SubscribeMessage,\n  OnGatewayConnection,\n  OnGatewayDisconnect,\n  ConnectedSocket,\n  MessageBody,\n} from '@nestjs/websockets';\nimport { Server, Socket } from 'socket.io';\nimport { Logger } from '@nestjs/common';\nimport { PrismaService } from '../providers/prisma-client.provider';\nimport { WebSocketAuthService } from './services/websocket-auth.service';\nimport type {\n  JoinConversationDto,\n  LeaveConversationDto,\n  TypingIndicatorDto,\n} from './types';\n\ninterface AuthenticatedSocket extends Socket {\n  userId?: string;\n  userRole?: string;\n  isAuthenticated?: boolean;\n}\n\n@WebSocketGateway({\n  cors: {\n    origin: [\n      process.env.FRONTEND_URL || 'http://localhost:3000',\n      'http://localhost:3000',  // Explicit fallback\n      'http://127.0.0.1:3000',  // Alternative localhost\n    ],\n    methods: ['GET', 'POST'],\n    credentials: true,\n    allowedHeaders: ['authorization', 'content-type'],\n  },\n  namespace: '/messaging',\n})\nexport class MessagingGateway\n  implements OnGatewayConnection, OnGatewayDisconnect\n{\n  @WebSocketServer()\n  server!: Server;\n\n  private readonly logger = new Logger(MessagingGateway.name);\n  private userSockets = new Map<string, Set<string>>(); // userId -> Set of socket IDs\n  private conversationParticipants = new Map<string, Set<string>>(); // conversationId -> Set of user IDs\n\n  constructor(\n    private readonly prisma: PrismaService,\n    private readonly webSocketAuth: WebSocketAuthService,\n  ) {}\n\n  async handleConnection(client: AuthenticatedSocket) {\n    try {\n      this.logger.log(`ðŸ”Œ [MessagingGateway] New WebSocket connection attempt: ${client.id}`);\n      this.logger.log(`ðŸ” [MessagingGateway] Connection details:`, {\n        ip: client.handshake.address,\n        userAgent: client.handshake.headers['user-agent'] || 'unknown',\n        origin: client.handshake.headers.origin || 'unknown',\n        referer: client.handshake.headers.referer || 'unknown'\n      });\n      this.logger.debug(`ðŸ” [MessagingGateway] Client handshake:`, {\n        headers: Object.keys(client.handshake.headers),\n        auth: client.handshake.auth ? 'present' : 'missing',\n        authToken: client.handshake.auth?.token ? 'present' : 'missing',\n        query: client.handshake.query,\n        url: client.handshake.url,\n        hasAuthHeader: !!client.handshake.headers.authorization,\n        transport: client.conn.transport.name\n      });\n\n      // Authenticate the socket connection using the new auth service\n      const authResult = await this.webSocketAuth.authenticateSocket(client);\n\n      if (!authResult) {\n        this.logger.warn(`âŒ [MessagingGateway] Client ${client.id} authentication failed`);\n        this.logger.warn(`ðŸ” [MessagingGateway] Auth failure details:`, {\n          hasToken: !!client.handshake.auth?.token,\n          hasAuthHeader: !!client.handshake.headers.authorization,\n          origin: client.handshake.headers.origin,\n          transport: client.conn.transport.name,\n          ip: client.handshake.address\n        });\n        client.emit('auth_error', {\n          message: 'Authentication failed. Please provide a valid token.',\n          code: 'AUTH_FAILED',\n          timestamp: new Date().toISOString(),\n        });\n        client.disconnect(true);\n        return;\n      }\n\n      this.logger.log(`âœ… [MessagingGateway] Client ${client.id} authenticated as user ${authResult.userId}`);\n\n      // Attach authenticated user info to socket\n      client.userId = authResult.userId;\n      client.userRole = authResult.role;\n      client.isAuthenticated = true;\n\n      // Verify user exists in database and is active\n      const user = await this.prisma.user.findUnique({\n        where: {\n          id: authResult.userId,\n          isActive: true, // Only allow active users\n        },\n        select: { id: true, role: true, isActive: true },\n      });\n\n      if (!user) {\n        this.logger.warn(`User ${authResult.userId} not found or inactive`);\n        client.emit('auth_error', {\n          message: 'User account not found or inactive',\n          code: 'USER_NOT_FOUND',\n        });\n        client.disconnect(true);\n        return;\n      }\n\n      // Add socket to user's socket set\n      if (!this.userSockets.has(authResult.userId)) {\n        this.userSockets.set(authResult.userId, new Set());\n      }\n      this.userSockets.get(authResult.userId)!.add(client.id);\n\n      // Join user to their conversation rooms\n      await this.joinUserConversations(client, authResult.userId);\n\n      // Subscribe user to their personal notification room\n      await this.subscribeUserToPersonalRoom(client, authResult.userId);\n\n      // Notify successful connection\n      client.emit('authenticated', {\n        userId: authResult.userId,\n        role: user.role,\n        message: 'Successfully authenticated and connected',\n        timestamp: new Date().toISOString(),\n      });\n\n      // Emit user online status to their contacts\n      await this.broadcastUserStatus(authResult.userId, 'online');\n\n      this.logger.log(\n        `User ${authResult.userId} successfully authenticated and connected with socket ${client.id}`,\n      );\n    } catch (error) {\n      this.logger.error(`Connection error for client ${client.id}:`, error);\n      client.emit('connection_error', {\n        message: 'Internal server error during connection',\n        code: 'INTERNAL_ERROR',\n      });\n      client.disconnect(true);\n    }\n  }\n\n  async handleDisconnect(client: AuthenticatedSocket) {\n    try {\n      if (client.userId) {\n        const userSockets = this.userSockets.get(client.userId);\n        if (userSockets) {\n          userSockets.delete(client.id);\n\n          // If no more sockets for this user, remove from tracking\n          if (userSockets.size === 0) {\n            this.userSockets.delete(client.userId);\n\n            // Clean up conversation participants tracking\n            for (const [\n              conversationId,\n              participants,\n            ] of this.conversationParticipants.entries()) {\n              participants.delete(client.userId);\n              // Remove empty conversation sets\n              if (participants.size === 0) {\n                this.conversationParticipants.delete(conversationId);\n              }\n            }\n\n            // Broadcast user offline status to their contacts\n            await this.broadcastUserStatus(client.userId, 'offline');\n          }\n        }\n\n        this.logger.log(\n          `User ${client.userId} disconnected socket ${client.id}`,\n        );\n      }\n\n      // Clean up authentication tracking\n      this.webSocketAuth.cleanupConnection(client.id);\n    } catch (error) {\n      this.logger.error(\n        `Error during disconnect cleanup for socket ${client.id}:`,\n        error,\n      );\n    }\n  }\n\n  @SubscribeMessage('join_conversation')\n  async handleJoinConversation(\n    @ConnectedSocket() client: AuthenticatedSocket,\n    @MessageBody() data: JoinConversationDto,\n  ) {\n    // Authentication guard\n    if (!this.isAuthenticated(client)) {\n      return;\n    }\n\n    try {\n      const { conversationId } = data;\n      const userId = client.userId!;\n\n      // Verify user is a participant in this conversation\n      const participation = await this.prisma.conversationParticipant.findFirst(\n        {\n          where: {\n            conversationId,\n            userId,\n            isActive: true,\n          },\n        },\n      );\n\n      if (!participation) {\n        client.emit('error', { message: 'Access denied to this conversation' });\n        return;\n      }\n\n      // Join socket to conversation room\n      void client.join(conversationId);\n\n      // Add user to conversation participants tracking\n      if (!this.conversationParticipants.has(conversationId)) {\n        this.conversationParticipants.set(conversationId, new Set());\n      }\n      this.conversationParticipants.get(conversationId)!.add(userId);\n\n      // Notify other participants that user joined\n      client.to(conversationId).emit('user_joined_conversation', {\n        conversationId,\n        userId,\n      });\n\n      client.emit('conversation_joined', { conversationId });\n      this.logger.log(`User ${userId} joined conversation ${conversationId}`);\n    } catch (error) {\n      this.logger.error('Error joining conversation:', error);\n      client.emit('error', { message: 'Failed to join conversation' });\n    }\n  }\n\n  @SubscribeMessage('leave_conversation')\n  handleLeaveConversation(\n    @ConnectedSocket() client: AuthenticatedSocket,\n    @MessageBody() data: LeaveConversationDto,\n  ) {\n    // Authentication guard\n    if (!this.isAuthenticated(client)) {\n      return;\n    }\n\n    const { conversationId } = data;\n    const userId = client.userId!;\n\n    void client.leave(conversationId);\n\n    // Remove user from conversation participants tracking\n    const participants = this.conversationParticipants.get(conversationId);\n    if (participants) {\n      participants.delete(userId);\n      if (participants.size === 0) {\n        this.conversationParticipants.delete(conversationId);\n      }\n    }\n\n    // Notify other participants that user left\n    client.to(conversationId).emit('user_left_conversation', {\n      conversationId,\n      userId,\n    });\n\n    client.emit('conversation_left', { conversationId });\n    this.logger.log(`User ${userId} left conversation ${conversationId}`);\n  }\n\n  @SubscribeMessage('typing_indicator')\n  async handleTypingIndicator(\n    @ConnectedSocket() client: AuthenticatedSocket,\n    @MessageBody() data: TypingIndicatorDto,\n  ) {\n    // Authentication guard\n    if (!this.isAuthenticated(client)) {\n      return;\n    }\n\n    const { conversationId, isTyping = true } = data;\n    const userId = client.userId!;\n\n    // Update typing indicator in database for persistence\n    if (isTyping) {\n      await this.prisma.typingIndicator.upsert({\n        where: {\n          conversationId_userId: {\n            conversationId,\n            userId,\n          },\n        },\n        create: {\n          conversationId,\n          userId,\n          lastTypingAt: new Date(),\n        },\n        update: {\n          lastTypingAt: new Date(),\n        },\n      });\n    } else {\n      // Remove typing indicator when user stops typing\n      await this.prisma.typingIndicator.deleteMany({\n        where: {\n          conversationId,\n          userId,\n        },\n      });\n    }\n\n    // Broadcast typing indicator to other participants in the conversation\n    client.to(conversationId).emit('typing_indicator', {\n      conversationId,\n      userId,\n      isTyping,\n    });\n  }\n\n  // Broadcast new message to conversation participants\n  broadcastMessage(conversationId: string, message: any) {\n    this.server.to(conversationId).emit('new_message', message);\n\n    // Send push notification to offline users (implement as needed)\n    this.sendPushNotifications(conversationId, message);\n  }\n\n  // Broadcast message update (edit/delete)\n  broadcastMessageUpdate(\n    conversationId: string,\n    messageId: string,\n    update: any,\n  ) {\n    this.server.to(conversationId).emit('message_updated', {\n      messageId,\n      ...update,\n    });\n  }\n\n  // Broadcast read receipt\n  broadcastReadReceipt(\n    conversationId: string,\n    messageId: string,\n    userId: string,\n  ) {\n    this.server.to(conversationId).emit('message_read', {\n      messageId,\n      userId,\n      readAt: new Date(),\n    });\n  }\n\n  // Broadcast message reaction\n  broadcastReaction(conversationId: string, messageId: string, reaction: any) {\n    this.server.to(conversationId).emit('message_reaction', {\n      messageId,\n      reaction,\n    });\n  }\n\n  // Private helper methods\n  // Authentication guard for message handlers\n  private isAuthenticated(client: AuthenticatedSocket): boolean {\n    if (!client.isAuthenticated || !client.userId) {\n      this.logger.warn(\n        `Unauthenticated client ${client.id} attempted to perform action`,\n      );\n      client.emit('auth_error', {\n        message: 'Authentication required for this action',\n        code: 'AUTH_REQUIRED',\n      });\n      return false;\n    }\n    return true;\n  }\n\n  private async joinUserConversations(\n    client: AuthenticatedSocket,\n    userId: string,\n  ) {\n    try {\n      // Get all active conversations for the user\n      const conversations = await this.prisma.conversation.findMany({\n        where: {\n          participants: {\n            some: {\n              userId,\n              isActive: true,\n            },\n          },\n          isActive: true,\n        },\n        select: {\n          id: true,\n        },\n      });\n\n      // Join all conversation rooms\n      for (const conversation of conversations) {\n        void client.join(conversation.id);\n\n        // Add to tracking\n        if (!this.conversationParticipants.has(conversation.id)) {\n          this.conversationParticipants.set(conversation.id, new Set());\n        }\n        this.conversationParticipants.get(conversation.id)!.add(userId);\n      }\n\n      this.logger.log(\n        `User ${userId} joined ${conversations.length} conversation rooms`,\n      );\n    } catch (error) {\n      this.logger.error('Error joining user conversations:', error);\n    }\n  }\n\n  private async broadcastUserStatus(\n    userId: string,\n    status: 'online' | 'offline',\n  ) {\n    // Get all conversations this user participates in\n    const conversations = await this.prisma.conversation.findMany({\n      where: {\n        participants: {\n          some: {\n            userId,\n            isActive: true,\n          },\n        },\n      },\n      select: {\n        id: true,\n      },\n    });\n\n    // Broadcast status to all conversation rooms\n    for (const conversation of conversations) {\n      this.server.to(conversation.id).emit('user_status_changed', {\n        userId,\n        status,\n        timestamp: new Date(),\n      });\n    }\n  }\n\n  private async sendPushNotifications(conversationId: string, message: any) {\n    try {\n      // Get all participants in the conversation except the sender\n      const conversation = await this.prisma.conversation.findUnique({\n        where: { id: conversationId },\n        include: {\n          participants: {\n            include: {\n              user: true,\n            },\n          },\n        },\n      });\n\n      if (!conversation) {\n        this.logger.warn(\n          `Conversation ${conversationId} not found for push notifications`,\n        );\n        return;\n      }\n\n      // Filter participants who should receive push notifications\n      const eligibleParticipants = conversation.participants.filter(\n        (participant) => {\n          // Don't send to message sender\n          if (participant.userId === message.senderId) {\n            return false;\n          }\n\n          // Use default notification settings since notificationSettings model doesn't exist\n          // Default to true for push notifications for new messages\n          const defaultPushNewMessages = true;\n          if (!defaultPushNewMessages) {\n            return false;\n          }\n\n          // Note: No device token filtering available (no DeviceToken model)\n          // All participants are considered eligible for alternative notifications\n          return true;\n        },\n      );\n\n      if (eligibleParticipants.length === 0) {\n        this.logger.log(\n          `No eligible participants for push notifications in conversation ${conversationId}`,\n        );\n        return;\n      }\n\n      // Prepare notification payload\n      const notificationPayload = {\n        title: 'New Message',\n        body:\n          message.content.length > 50\n            ? `${message.content.substring(0, 50)}...`\n            : message.content,\n        icon: '/icon-192x192.png',\n        badge: '/badge-72x72.png',\n        data: {\n          conversationId: conversationId,\n          messageId: message.id,\n          senderId: message.senderId,\n          url: `/user/messages?conversation=${conversationId}`,\n        },\n      };\n\n      // Alternative notification approach (no device tokens available)\n      const pushPromises = eligibleParticipants.map(async (participant) => {\n        try {\n          // Log notification attempt (alternative to push notifications)\n          this.logger.log(\n            `Would send push notification to user ${participant.userId} for message ${message.id} (no DeviceToken model available)`,\n          );\n          \n          // Here you could implement WebSocket-based real-time notifications\n          // or other alternative notification methods\n          \n        } catch (error) {\n          const errorMessage =\n            error instanceof Error ? error.message : 'Unknown error';\n          this.logger.error(\n            `Failed to process notification for user ${participant.userId}: ${errorMessage}`,\n          );\n        }\n      });\n\n      await Promise.allSettled(pushPromises);\n\n      this.logger.log(\n        `Push notification processing completed for conversation ${conversationId}`,\n      );\n    } catch (error) {\n      this.logger.error(\n        `Failed to send push notifications for conversation ${conversationId}:`,\n        error,\n      );\n    }\n  }\n\n  // Clean up old typing indicators (call this periodically)\n  async cleanupTypingIndicators() {\n    const fiveMinutesAgo = new Date(Date.now() - 5 * 60 * 1000);\n\n    await this.prisma.typingIndicator.deleteMany({\n      where: {\n        lastTypingAt: {\n          lt: fiveMinutesAgo,\n        },\n      },\n    });\n  }\n\n  // Personal room subscription methods for real-time notifications\n  async subscribeUserToPersonalRoom(\n    client: AuthenticatedSocket,\n    userId: string,\n  ) {\n    const userRoom = `user:${userId}`;\n    await client.join(userRoom);\n    this.logger.debug(\n      `User ${userId} subscribed to personal room: ${userRoom}`,\n    );\n  }\n\n  async unsubscribeUserFromPersonalRoom(\n    client: AuthenticatedSocket,\n    userId: string,\n  ) {\n    const userRoom = `user:${userId}`;\n    await client.leave(userRoom);\n    this.logger.debug(\n      `User ${userId} unsubscribed from personal room: ${userRoom}`,\n    );\n  }\n\n  // Community and post room subscriptions for social features\n  @SubscribeMessage('join_community')\n  async handleJoinCommunity(\n    @ConnectedSocket() client: AuthenticatedSocket,\n    @MessageBody() data: { communityId: string },\n  ) {\n    if (!this.isAuthenticated(client)) {\n      return;\n    }\n\n    const { communityId } = data;\n    const userId = client.userId!;\n\n    try {\n      // Verify user is a member of this community\n      const membership = await this.prisma.membership.findFirst({\n        where: {\n          communityId,\n          userId,\n        },\n      });\n\n      if (!membership) {\n        client.emit('error', { message: 'Access denied to this community' });\n        return;\n      }\n\n      const communityRoom = `community_${communityId}`;\n      await client.join(communityRoom);\n\n      client.emit('community_joined', { communityId });\n      this.logger.log(`User ${userId} joined community room ${communityId}`);\n    } catch (error) {\n      this.logger.error('Error joining community:', error);\n      client.emit('error', { message: 'Failed to join community' });\n    }\n  }\n\n  @SubscribeMessage('leave_community')\n  async handleLeaveCommunity(\n    @ConnectedSocket() client: AuthenticatedSocket,\n    @MessageBody() data: { communityId: string },\n  ) {\n    if (!this.isAuthenticated(client)) {\n      return;\n    }\n\n    const { communityId } = data;\n    const userId = client.userId!;\n\n    const communityRoom = `community_${communityId}`;\n    await client.leave(communityRoom);\n\n    client.emit('community_left', { communityId });\n    this.logger.log(`User ${userId} left community room ${communityId}`);\n  }\n\n  @SubscribeMessage('join_post')\n  async handleJoinPost(\n    @ConnectedSocket() client: AuthenticatedSocket,\n    @MessageBody() data: { postId: string },\n  ) {\n    if (!this.isAuthenticated(client)) {\n      return;\n    }\n\n    const { postId } = data;\n    const userId = client.userId!;\n\n    try {\n      // Verify post exists and user has access\n      const post = await this.prisma.post.findFirst({\n        where: {\n          id: postId,\n          room: {\n            roomGroup: {\n              community: {\n                memberships: {\n                  some: {\n                    userId,\n                  },\n                },\n              },\n            },\n          },\n        },\n      });\n\n      if (!post) {\n        client.emit('error', { message: 'Access denied to this post' });\n        return;\n      }\n\n      const postRoom = `post_${postId}`;\n      await client.join(postRoom);\n\n      client.emit('post_joined', { postId });\n      this.logger.log(`User ${userId} joined post room ${postId}`);\n    } catch (error) {\n      this.logger.error('Error joining post:', error);\n      client.emit('error', { message: 'Failed to join post' });\n    }\n  }\n\n  @SubscribeMessage('leave_post')\n  async handleLeavePost(\n    @ConnectedSocket() client: AuthenticatedSocket,\n    @MessageBody() data: { postId: string },\n  ) {\n    if (!this.isAuthenticated(client)) {\n      return;\n    }\n\n    const { postId } = data;\n    const userId = client.userId!;\n\n    const postRoom = `post_${postId}`;\n    await client.leave(postRoom);\n\n    client.emit('post_left', { postId });\n    this.logger.log(`User ${userId} left post room ${postId}`);\n  }\n\n  // Utility method to get server instance for event broadcasting\n  getServer(): Server {\n    return this.server;\n  }\n}\n"],"version":3}