fa0b92f5d8ba6f02d1bc5d868b18efbc
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var __param = (this && this.__param) || function (paramIndex, decorator) {
    return function (target, key) { decorator(target, key, paramIndex); }
};
var MessagingGateway_1;
var _a, _b, _c;
Object.defineProperty(exports, "__esModule", { value: true });
exports.MessagingGateway = void 0;
const websockets_1 = require("@nestjs/websockets");
const socket_io_1 = require("socket.io");
const common_1 = require("@nestjs/common");
const prisma_client_provider_1 = require("../providers/prisma-client.provider");
const websocket_auth_service_1 = require("./services/websocket-auth.service");
let MessagingGateway = MessagingGateway_1 = class MessagingGateway {
    prisma;
    webSocketAuth;
    server;
    logger = new common_1.Logger(MessagingGateway_1.name);
    userSockets = new Map(); // userId -> Set of socket IDs
    conversationParticipants = new Map(); // conversationId -> Set of user IDs
    constructor(prisma, webSocketAuth) {
        this.prisma = prisma;
        this.webSocketAuth = webSocketAuth;
    }
    async handleConnection(client) {
        try {
            this.logger.log(`ðŸ”Œ [MessagingGateway] New WebSocket connection attempt: ${client.id}`);
            this.logger.debug(`ðŸ” [MessagingGateway] Client handshake:`, {
                headers: Object.keys(client.handshake.headers),
                auth: client.handshake.auth,
                query: client.handshake.query,
                url: client.handshake.url,
            });
            // Authenticate the socket connection using the new auth service
            const authResult = await this.webSocketAuth.authenticateSocket(client);
            if (!authResult) {
                this.logger.warn(`âŒ [MessagingGateway] Client ${client.id} authentication failed`);
                client.emit('auth_error', {
                    message: 'Authentication failed. Please provide a valid token.',
                    code: 'AUTH_FAILED',
                });
                client.disconnect(true);
                return;
            }
            this.logger.log(`âœ… [MessagingGateway] Client ${client.id} authenticated as user ${authResult.userId}`);
            // Attach authenticated user info to socket
            client.userId = authResult.userId;
            client.userRole = authResult.role;
            client.isAuthenticated = true;
            // Verify user exists in database and is active
            const user = await this.prisma.user.findUnique({
                where: {
                    id: authResult.userId,
                    isActive: true, // Only allow active users
                },
                select: { id: true, role: true, isActive: true },
            });
            if (!user) {
                this.logger.warn(`User ${authResult.userId} not found or inactive`);
                client.emit('auth_error', {
                    message: 'User account not found or inactive',
                    code: 'USER_NOT_FOUND',
                });
                client.disconnect(true);
                return;
            }
            // Add socket to user's socket set
            if (!this.userSockets.has(authResult.userId)) {
                this.userSockets.set(authResult.userId, new Set());
            }
            this.userSockets.get(authResult.userId).add(client.id);
            // Join user to their conversation rooms
            await this.joinUserConversations(client, authResult.userId);
            // Subscribe user to their personal notification room
            await this.subscribeUserToPersonalRoom(client, authResult.userId);
            // Notify successful connection
            client.emit('authenticated', {
                userId: authResult.userId,
                role: user.role,
                message: 'Successfully authenticated and connected',
                timestamp: new Date().toISOString(),
            });
            // Emit user online status to their contacts
            await this.broadcastUserStatus(authResult.userId, 'online');
            this.logger.log(`User ${authResult.userId} successfully authenticated and connected with socket ${client.id}`);
        }
        catch (error) {
            this.logger.error(`Connection error for client ${client.id}:`, error);
            client.emit('connection_error', {
                message: 'Internal server error during connection',
                code: 'INTERNAL_ERROR',
            });
            client.disconnect(true);
        }
    }
    async handleDisconnect(client) {
        try {
            if (client.userId) {
                const userSockets = this.userSockets.get(client.userId);
                if (userSockets) {
                    userSockets.delete(client.id);
                    // If no more sockets for this user, remove from tracking
                    if (userSockets.size === 0) {
                        this.userSockets.delete(client.userId);
                        // Clean up conversation participants tracking
                        for (const [conversationId, participants,] of this.conversationParticipants.entries()) {
                            participants.delete(client.userId);
                            // Remove empty conversation sets
                            if (participants.size === 0) {
                                this.conversationParticipants.delete(conversationId);
                            }
                        }
                        // Broadcast user offline status to their contacts
                        await this.broadcastUserStatus(client.userId, 'offline');
                    }
                }
                this.logger.log(`User ${client.userId} disconnected socket ${client.id}`);
            }
            // Clean up authentication tracking
            this.webSocketAuth.cleanupConnection(client.id);
        }
        catch (error) {
            this.logger.error(`Error during disconnect cleanup for socket ${client.id}:`, error);
        }
    }
    async handleJoinConversation(client, data) {
        // Authentication guard
        if (!this.isAuthenticated(client)) {
            return;
        }
        try {
            const { conversationId } = data;
            const userId = client.userId;
            // Verify user is a participant in this conversation
            const participation = await this.prisma.conversationParticipant.findFirst({
                where: {
                    conversationId,
                    userId,
                    isActive: true,
                },
            });
            if (!participation) {
                client.emit('error', { message: 'Access denied to this conversation' });
                return;
            }
            // Join socket to conversation room
            void client.join(conversationId);
            // Add user to conversation participants tracking
            if (!this.conversationParticipants.has(conversationId)) {
                this.conversationParticipants.set(conversationId, new Set());
            }
            this.conversationParticipants.get(conversationId).add(userId);
            // Notify other participants that user joined
            client.to(conversationId).emit('user_joined_conversation', {
                conversationId,
                userId,
            });
            client.emit('conversation_joined', { conversationId });
            this.logger.log(`User ${userId} joined conversation ${conversationId}`);
        }
        catch (error) {
            this.logger.error('Error joining conversation:', error);
            client.emit('error', { message: 'Failed to join conversation' });
        }
    }
    handleLeaveConversation(client, data) {
        // Authentication guard
        if (!this.isAuthenticated(client)) {
            return;
        }
        const { conversationId } = data;
        const userId = client.userId;
        void client.leave(conversationId);
        // Remove user from conversation participants tracking
        const participants = this.conversationParticipants.get(conversationId);
        if (participants) {
            participants.delete(userId);
            if (participants.size === 0) {
                this.conversationParticipants.delete(conversationId);
            }
        }
        // Notify other participants that user left
        client.to(conversationId).emit('user_left_conversation', {
            conversationId,
            userId,
        });
        client.emit('conversation_left', { conversationId });
        this.logger.log(`User ${userId} left conversation ${conversationId}`);
    }
    async handleTypingIndicator(client, data) {
        // Authentication guard
        if (!this.isAuthenticated(client)) {
            return;
        }
        const { conversationId, isTyping = true } = data;
        const userId = client.userId;
        // Update typing indicator in database for persistence
        if (isTyping) {
            await this.prisma.typingIndicator.upsert({
                where: {
                    conversationId_userId: {
                        conversationId,
                        userId,
                    },
                },
                create: {
                    conversationId,
                    userId,
                    lastTypingAt: new Date(),
                },
                update: {
                    lastTypingAt: new Date(),
                },
            });
        }
        else {
            // Remove typing indicator when user stops typing
            await this.prisma.typingIndicator.deleteMany({
                where: {
                    conversationId,
                    userId,
                },
            });
        }
        // Broadcast typing indicator to other participants in the conversation
        client.to(conversationId).emit('typing_indicator', {
            conversationId,
            userId,
            isTyping,
        });
    }
    // Broadcast new message to conversation participants
    broadcastMessage(conversationId, message) {
        this.server.to(conversationId).emit('new_message', message);
        // Send push notification to offline users (implement as needed)
        this.sendPushNotifications(conversationId, message);
    }
    // Broadcast message update (edit/delete)
    broadcastMessageUpdate(conversationId, messageId, update) {
        this.server.to(conversationId).emit('message_updated', {
            messageId,
            ...update,
        });
    }
    // Broadcast read receipt
    broadcastReadReceipt(conversationId, messageId, userId) {
        this.server.to(conversationId).emit('message_read', {
            messageId,
            userId,
            readAt: new Date(),
        });
    }
    // Broadcast message reaction
    broadcastReaction(conversationId, messageId, reaction) {
        this.server.to(conversationId).emit('message_reaction', {
            messageId,
            reaction,
        });
    }
    // Private helper methods
    // Authentication guard for message handlers
    isAuthenticated(client) {
        if (!client.isAuthenticated || !client.userId) {
            this.logger.warn(`Unauthenticated client ${client.id} attempted to perform action`);
            client.emit('auth_error', {
                message: 'Authentication required for this action',
                code: 'AUTH_REQUIRED',
            });
            return false;
        }
        return true;
    }
    async joinUserConversations(client, userId) {
        try {
            // Get all active conversations for the user
            const conversations = await this.prisma.conversation.findMany({
                where: {
                    participants: {
                        some: {
                            userId,
                            isActive: true,
                        },
                    },
                    isActive: true,
                },
                select: {
                    id: true,
                },
            });
            // Join all conversation rooms
            for (const conversation of conversations) {
                void client.join(conversation.id);
                // Add to tracking
                if (!this.conversationParticipants.has(conversation.id)) {
                    this.conversationParticipants.set(conversation.id, new Set());
                }
                this.conversationParticipants.get(conversation.id).add(userId);
            }
            this.logger.log(`User ${userId} joined ${conversations.length} conversation rooms`);
        }
        catch (error) {
            this.logger.error('Error joining user conversations:', error);
        }
    }
    async broadcastUserStatus(userId, status) {
        // Get all conversations this user participates in
        const conversations = await this.prisma.conversation.findMany({
            where: {
                participants: {
                    some: {
                        userId,
                        isActive: true,
                    },
                },
            },
            select: {
                id: true,
            },
        });
        // Broadcast status to all conversation rooms
        for (const conversation of conversations) {
            this.server.to(conversation.id).emit('user_status_changed', {
                userId,
                status,
                timestamp: new Date(),
            });
        }
    }
    async sendPushNotifications(conversationId, message) {
        try {
            // Get all participants in the conversation except the sender
            const conversation = await this.prisma.conversation.findUnique({
                where: { id: conversationId },
                include: {
                    participants: {
                        include: {
                            user: true,
                        },
                    },
                },
            });
            if (!conversation) {
                this.logger.warn(`Conversation ${conversationId} not found for push notifications`);
                return;
            }
            // Filter participants who should receive push notifications
            const eligibleParticipants = conversation.participants.filter((participant) => {
                // Don't send to message sender
                if (participant.userId === message.senderId) {
                    return false;
                }
                // Use default notification settings since notificationSettings model doesn't exist
                // Default to true for push notifications for new messages
                const defaultPushNewMessages = true;
                if (!defaultPushNewMessages) {
                    return false;
                }
                // Note: No device token filtering available (no DeviceToken model)
                // All participants are considered eligible for alternative notifications
                return true;
            });
            if (eligibleParticipants.length === 0) {
                this.logger.log(`No eligible participants for push notifications in conversation ${conversationId}`);
                return;
            }
            // Prepare notification payload
            const notificationPayload = {
                title: 'New Message',
                body: message.content.length > 50
                    ? `${message.content.substring(0, 50)}...`
                    : message.content,
                icon: '/icon-192x192.png',
                badge: '/badge-72x72.png',
                data: {
                    conversationId: conversationId,
                    messageId: message.id,
                    senderId: message.senderId,
                    url: `/user/messages?conversation=${conversationId}`,
                },
            };
            // Alternative notification approach (no device tokens available)
            const pushPromises = eligibleParticipants.map(async (participant) => {
                try {
                    // Log notification attempt (alternative to push notifications)
                    this.logger.log(`Would send push notification to user ${participant.userId} for message ${message.id} (no DeviceToken model available)`);
                    // Here you could implement WebSocket-based real-time notifications
                    // or other alternative notification methods
                }
                catch (error) {
                    const errorMessage = error instanceof Error ? error.message : 'Unknown error';
                    this.logger.error(`Failed to process notification for user ${participant.userId}: ${errorMessage}`);
                }
            });
            await Promise.allSettled(pushPromises);
            this.logger.log(`Push notification processing completed for conversation ${conversationId}`);
        }
        catch (error) {
            this.logger.error(`Failed to send push notifications for conversation ${conversationId}:`, error);
        }
    }
    // Clean up old typing indicators (call this periodically)
    async cleanupTypingIndicators() {
        const fiveMinutesAgo = new Date(Date.now() - 5 * 60 * 1000);
        await this.prisma.typingIndicator.deleteMany({
            where: {
                lastTypingAt: {
                    lt: fiveMinutesAgo,
                },
            },
        });
    }
    // Personal room subscription methods for real-time notifications
    async subscribeUserToPersonalRoom(client, userId) {
        const userRoom = `user:${userId}`;
        await client.join(userRoom);
        this.logger.debug(`User ${userId} subscribed to personal room: ${userRoom}`);
    }
    async unsubscribeUserFromPersonalRoom(client, userId) {
        const userRoom = `user:${userId}`;
        await client.leave(userRoom);
        this.logger.debug(`User ${userId} unsubscribed from personal room: ${userRoom}`);
    }
    // Community and post room subscriptions for social features
    async handleJoinCommunity(client, data) {
        if (!this.isAuthenticated(client)) {
            return;
        }
        const { communityId } = data;
        const userId = client.userId;
        try {
            // Verify user is a member of this community
            const membership = await this.prisma.membership.findFirst({
                where: {
                    communityId,
                    userId,
                },
            });
            if (!membership) {
                client.emit('error', { message: 'Access denied to this community' });
                return;
            }
            const communityRoom = `community_${communityId}`;
            await client.join(communityRoom);
            client.emit('community_joined', { communityId });
            this.logger.log(`User ${userId} joined community room ${communityId}`);
        }
        catch (error) {
            this.logger.error('Error joining community:', error);
            client.emit('error', { message: 'Failed to join community' });
        }
    }
    async handleLeaveCommunity(client, data) {
        if (!this.isAuthenticated(client)) {
            return;
        }
        const { communityId } = data;
        const userId = client.userId;
        const communityRoom = `community_${communityId}`;
        await client.leave(communityRoom);
        client.emit('community_left', { communityId });
        this.logger.log(`User ${userId} left community room ${communityId}`);
    }
    async handleJoinPost(client, data) {
        if (!this.isAuthenticated(client)) {
            return;
        }
        const { postId } = data;
        const userId = client.userId;
        try {
            // Verify post exists and user has access
            const post = await this.prisma.post.findFirst({
                where: {
                    id: postId,
                    room: {
                        roomGroup: {
                            community: {
                                memberships: {
                                    some: {
                                        userId,
                                    },
                                },
                            },
                        },
                    },
                },
            });
            if (!post) {
                client.emit('error', { message: 'Access denied to this post' });
                return;
            }
            const postRoom = `post_${postId}`;
            await client.join(postRoom);
            client.emit('post_joined', { postId });
            this.logger.log(`User ${userId} joined post room ${postId}`);
        }
        catch (error) {
            this.logger.error('Error joining post:', error);
            client.emit('error', { message: 'Failed to join post' });
        }
    }
    async handleLeavePost(client, data) {
        if (!this.isAuthenticated(client)) {
            return;
        }
        const { postId } = data;
        const userId = client.userId;
        const postRoom = `post_${postId}`;
        await client.leave(postRoom);
        client.emit('post_left', { postId });
        this.logger.log(`User ${userId} left post room ${postId}`);
    }
    // Utility method to get server instance for event broadcasting
    getServer() {
        return this.server;
    }
};
exports.MessagingGateway = MessagingGateway;
__decorate([
    (0, websockets_1.WebSocketServer)(),
    __metadata("design:type", typeof (_c = typeof socket_io_1.Server !== "undefined" && socket_io_1.Server) === "function" ? _c : Object)
], MessagingGateway.prototype, "server", void 0);
__decorate([
    (0, websockets_1.SubscribeMessage)('join_conversation'),
    __param(0, (0, websockets_1.ConnectedSocket)()),
    __param(1, (0, websockets_1.MessageBody)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Object, Object]),
    __metadata("design:returntype", Promise)
], MessagingGateway.prototype, "handleJoinConversation", null);
__decorate([
    (0, websockets_1.SubscribeMessage)('leave_conversation'),
    __param(0, (0, websockets_1.ConnectedSocket)()),
    __param(1, (0, websockets_1.MessageBody)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Object, Object]),
    __metadata("design:returntype", void 0)
], MessagingGateway.prototype, "handleLeaveConversation", null);
__decorate([
    (0, websockets_1.SubscribeMessage)('typing_indicator'),
    __param(0, (0, websockets_1.ConnectedSocket)()),
    __param(1, (0, websockets_1.MessageBody)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Object, Object]),
    __metadata("design:returntype", Promise)
], MessagingGateway.prototype, "handleTypingIndicator", null);
__decorate([
    (0, websockets_1.SubscribeMessage)('join_community'),
    __param(0, (0, websockets_1.ConnectedSocket)()),
    __param(1, (0, websockets_1.MessageBody)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Object, Object]),
    __metadata("design:returntype", Promise)
], MessagingGateway.prototype, "handleJoinCommunity", null);
__decorate([
    (0, websockets_1.SubscribeMessage)('leave_community'),
    __param(0, (0, websockets_1.ConnectedSocket)()),
    __param(1, (0, websockets_1.MessageBody)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Object, Object]),
    __metadata("design:returntype", Promise)
], MessagingGateway.prototype, "handleLeaveCommunity", null);
__decorate([
    (0, websockets_1.SubscribeMessage)('join_post'),
    __param(0, (0, websockets_1.ConnectedSocket)()),
    __param(1, (0, websockets_1.MessageBody)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Object, Object]),
    __metadata("design:returntype", Promise)
], MessagingGateway.prototype, "handleJoinPost", null);
__decorate([
    (0, websockets_1.SubscribeMessage)('leave_post'),
    __param(0, (0, websockets_1.ConnectedSocket)()),
    __param(1, (0, websockets_1.MessageBody)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Object, Object]),
    __metadata("design:returntype", Promise)
], MessagingGateway.prototype, "handleLeavePost", null);
exports.MessagingGateway = MessagingGateway = MessagingGateway_1 = __decorate([
    (0, websockets_1.WebSocketGateway)({
        cors: {
            origin: [
                process.env.FRONTEND_URL || 'http://localhost:3000',
                'http://localhost:3000', // Explicit fallback
                'http://127.0.0.1:3000', // Alternative localhost
            ],
            methods: ['GET', 'POST'],
            credentials: true,
            allowedHeaders: ['authorization', 'content-type'],
        },
        namespace: '/messaging',
    }),
    __metadata("design:paramtypes", [typeof (_a = typeof prisma_client_provider_1.PrismaService !== "undefined" && prisma_client_provider_1.PrismaService) === "function" ? _a : Object, typeof (_b = typeof websocket_auth_service_1.WebSocketAuthService !== "undefined" && websocket_auth_service_1.WebSocketAuthService) === "function" ? _b : Object])
], MessagingGateway);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL21lc3NhZ2luZy9tZXNzYWdpbmcuZ2F0ZXdheS50cyIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLG1EQVE0QjtBQUM1Qix5Q0FBMkM7QUFDM0MsMkNBQXdDO0FBQ3hDLGdGQUFvRTtBQUNwRSw4RUFBeUU7QUEwQmxFLElBQU0sZ0JBQWdCLHdCQUF0QixNQUFNLGdCQUFnQjtJQVdSO0lBQ0E7SUFSbkIsTUFBTSxDQUFVO0lBRUMsTUFBTSxHQUFHLElBQUksZUFBTSxDQUFDLGtCQUFnQixDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ3BELFdBQVcsR0FBRyxJQUFJLEdBQUcsRUFBdUIsQ0FBQyxDQUFDLDhCQUE4QjtJQUM1RSx3QkFBd0IsR0FBRyxJQUFJLEdBQUcsRUFBdUIsQ0FBQyxDQUFDLG9DQUFvQztJQUV2RyxZQUNtQixNQUFxQixFQUNyQixhQUFtQztRQURuQyxXQUFNLEdBQU4sTUFBTSxDQUFlO1FBQ3JCLGtCQUFhLEdBQWIsYUFBYSxDQUFzQjtJQUNuRCxDQUFDO0lBRUosS0FBSyxDQUFDLGdCQUFnQixDQUFDLE1BQTJCO1FBQ2hELElBQUksQ0FBQztZQUNILElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLDJEQUEyRCxNQUFNLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQztZQUN4RixJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyx5Q0FBeUMsRUFBRTtnQkFDM0QsT0FBTyxFQUFFLE1BQU0sQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUM7Z0JBQzlDLElBQUksRUFBRSxNQUFNLENBQUMsU0FBUyxDQUFDLElBQUk7Z0JBQzNCLEtBQUssRUFBRSxNQUFNLENBQUMsU0FBUyxDQUFDLEtBQUs7Z0JBQzdCLEdBQUcsRUFBRSxNQUFNLENBQUMsU0FBUyxDQUFDLEdBQUc7YUFDMUIsQ0FBQyxDQUFDO1lBRUgsZ0VBQWdFO1lBQ2hFLE1BQU0sVUFBVSxHQUFHLE1BQU0sSUFBSSxDQUFDLGFBQWEsQ0FBQyxrQkFBa0IsQ0FBQyxNQUFNLENBQUMsQ0FBQztZQUV2RSxJQUFJLENBQUMsVUFBVSxFQUFFLENBQUM7Z0JBQ2hCLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLCtCQUErQixNQUFNLENBQUMsRUFBRSx3QkFBd0IsQ0FBQyxDQUFDO2dCQUNuRixNQUFNLENBQUMsSUFBSSxDQUFDLFlBQVksRUFBRTtvQkFDeEIsT0FBTyxFQUFFLHNEQUFzRDtvQkFDL0QsSUFBSSxFQUFFLGFBQWE7aUJBQ3BCLENBQUMsQ0FBQztnQkFDSCxNQUFNLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxDQUFDO2dCQUN4QixPQUFPO1lBQ1QsQ0FBQztZQUVELElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLCtCQUErQixNQUFNLENBQUMsRUFBRSwwQkFBMEIsVUFBVSxDQUFDLE1BQU0sRUFBRSxDQUFDLENBQUM7WUFFdkcsMkNBQTJDO1lBQzNDLE1BQU0sQ0FBQyxNQUFNLEdBQUcsVUFBVSxDQUFDLE1BQU0sQ0FBQztZQUNsQyxNQUFNLENBQUMsUUFBUSxHQUFHLFVBQVUsQ0FBQyxJQUFJLENBQUM7WUFDbEMsTUFBTSxDQUFDLGVBQWUsR0FBRyxJQUFJLENBQUM7WUFFOUIsK0NBQStDO1lBQy9DLE1BQU0sSUFBSSxHQUFHLE1BQU0sSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDO2dCQUM3QyxLQUFLLEVBQUU7b0JBQ0wsRUFBRSxFQUFFLFVBQVUsQ0FBQyxNQUFNO29CQUNyQixRQUFRLEVBQUUsSUFBSSxFQUFFLDBCQUEwQjtpQkFDM0M7Z0JBQ0QsTUFBTSxFQUFFLEVBQUUsRUFBRSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLFFBQVEsRUFBRSxJQUFJLEVBQUU7YUFDakQsQ0FBQyxDQUFDO1lBRUgsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDO2dCQUNWLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLFFBQVEsVUFBVSxDQUFDLE1BQU0sd0JBQXdCLENBQUMsQ0FBQztnQkFDcEUsTUFBTSxDQUFDLElBQUksQ0FBQyxZQUFZLEVBQUU7b0JBQ3hCLE9BQU8sRUFBRSxvQ0FBb0M7b0JBQzdDLElBQUksRUFBRSxnQkFBZ0I7aUJBQ3ZCLENBQUMsQ0FBQztnQkFDSCxNQUFNLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxDQUFDO2dCQUN4QixPQUFPO1lBQ1QsQ0FBQztZQUVELGtDQUFrQztZQUNsQyxJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUM7Z0JBQzdDLElBQUksQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLFVBQVUsQ0FBQyxNQUFNLEVBQUUsSUFBSSxHQUFHLEVBQUUsQ0FBQyxDQUFDO1lBQ3JELENBQUM7WUFDRCxJQUFJLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsTUFBTSxDQUFFLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsQ0FBQztZQUV4RCx3Q0FBd0M7WUFDeEMsTUFBTSxJQUFJLENBQUMscUJBQXFCLENBQUMsTUFBTSxFQUFFLFVBQVUsQ0FBQyxNQUFNLENBQUMsQ0FBQztZQUU1RCxxREFBcUQ7WUFDckQsTUFBTSxJQUFJLENBQUMsMkJBQTJCLENBQUMsTUFBTSxFQUFFLFVBQVUsQ0FBQyxNQUFNLENBQUMsQ0FBQztZQUVsRSwrQkFBK0I7WUFDL0IsTUFBTSxDQUFDLElBQUksQ0FBQyxlQUFlLEVBQUU7Z0JBQzNCLE1BQU0sRUFBRSxVQUFVLENBQUMsTUFBTTtnQkFDekIsSUFBSSxFQUFFLElBQUksQ0FBQyxJQUFJO2dCQUNmLE9BQU8sRUFBRSwwQ0FBMEM7Z0JBQ25ELFNBQVMsRUFBRSxJQUFJLElBQUksRUFBRSxDQUFDLFdBQVcsRUFBRTthQUNwQyxDQUFDLENBQUM7WUFFSCw0Q0FBNEM7WUFDNUMsTUFBTSxJQUFJLENBQUMsbUJBQW1CLENBQUMsVUFBVSxDQUFDLE1BQU0sRUFBRSxRQUFRLENBQUMsQ0FBQztZQUU1RCxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FDYixRQUFRLFVBQVUsQ0FBQyxNQUFNLHlEQUF5RCxNQUFNLENBQUMsRUFBRSxFQUFFLENBQzlGLENBQUM7UUFDSixDQUFDO1FBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztZQUNmLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLCtCQUErQixNQUFNLENBQUMsRUFBRSxHQUFHLEVBQUUsS0FBSyxDQUFDLENBQUM7WUFDdEUsTUFBTSxDQUFDLElBQUksQ0FBQyxrQkFBa0IsRUFBRTtnQkFDOUIsT0FBTyxFQUFFLHlDQUF5QztnQkFDbEQsSUFBSSxFQUFFLGdCQUFnQjthQUN2QixDQUFDLENBQUM7WUFDSCxNQUFNLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQzFCLENBQUM7SUFDSCxDQUFDO0lBRUQsS0FBSyxDQUFDLGdCQUFnQixDQUFDLE1BQTJCO1FBQ2hELElBQUksQ0FBQztZQUNILElBQUksTUFBTSxDQUFDLE1BQU0sRUFBRSxDQUFDO2dCQUNsQixNQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUM7Z0JBQ3hELElBQUksV0FBVyxFQUFFLENBQUM7b0JBQ2hCLFdBQVcsQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxDQUFDO29CQUU5Qix5REFBeUQ7b0JBQ3pELElBQUksV0FBVyxDQUFDLElBQUksS0FBSyxDQUFDLEVBQUUsQ0FBQzt3QkFDM0IsSUFBSSxDQUFDLFdBQVcsQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDO3dCQUV2Qyw4Q0FBOEM7d0JBQzlDLEtBQUssTUFBTSxDQUNULGNBQWMsRUFDZCxZQUFZLEVBQ2IsSUFBSSxJQUFJLENBQUMsd0JBQXdCLENBQUMsT0FBTyxFQUFFLEVBQUUsQ0FBQzs0QkFDN0MsWUFBWSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUM7NEJBQ25DLGlDQUFpQzs0QkFDakMsSUFBSSxZQUFZLENBQUMsSUFBSSxLQUFLLENBQUMsRUFBRSxDQUFDO2dDQUM1QixJQUFJLENBQUMsd0JBQXdCLENBQUMsTUFBTSxDQUFDLGNBQWMsQ0FBQyxDQUFDOzRCQUN2RCxDQUFDO3dCQUNILENBQUM7d0JBRUQsa0RBQWtEO3dCQUNsRCxNQUFNLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxNQUFNLENBQUMsTUFBTSxFQUFFLFNBQVMsQ0FBQyxDQUFDO29CQUMzRCxDQUFDO2dCQUNILENBQUM7Z0JBRUQsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQ2IsUUFBUSxNQUFNLENBQUMsTUFBTSx3QkFBd0IsTUFBTSxDQUFDLEVBQUUsRUFBRSxDQUN6RCxDQUFDO1lBQ0osQ0FBQztZQUVELG1DQUFtQztZQUNuQyxJQUFJLENBQUMsYUFBYSxDQUFDLGlCQUFpQixDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUNsRCxDQUFDO1FBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztZQUNmLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUNmLDhDQUE4QyxNQUFNLENBQUMsRUFBRSxHQUFHLEVBQzFELEtBQUssQ0FDTixDQUFDO1FBQ0osQ0FBQztJQUNILENBQUM7SUFHSyxBQUFOLEtBQUssQ0FBQyxzQkFBc0IsQ0FDUCxNQUEyQixFQUMvQixJQUF5QjtRQUV4Qyx1QkFBdUI7UUFDdkIsSUFBSSxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQztZQUNsQyxPQUFPO1FBQ1QsQ0FBQztRQUVELElBQUksQ0FBQztZQUNILE1BQU0sRUFBRSxjQUFjLEVBQUUsR0FBRyxJQUFJLENBQUM7WUFDaEMsTUFBTSxNQUFNLEdBQUcsTUFBTSxDQUFDLE1BQU8sQ0FBQztZQUU5QixvREFBb0Q7WUFDcEQsTUFBTSxhQUFhLEdBQUcsTUFBTSxJQUFJLENBQUMsTUFBTSxDQUFDLHVCQUF1QixDQUFDLFNBQVMsQ0FDdkU7Z0JBQ0UsS0FBSyxFQUFFO29CQUNMLGNBQWM7b0JBQ2QsTUFBTTtvQkFDTixRQUFRLEVBQUUsSUFBSTtpQkFDZjthQUNGLENBQ0YsQ0FBQztZQUVGLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztnQkFDbkIsTUFBTSxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUUsRUFBRSxPQUFPLEVBQUUsb0NBQW9DLEVBQUUsQ0FBQyxDQUFDO2dCQUN4RSxPQUFPO1lBQ1QsQ0FBQztZQUVELG1DQUFtQztZQUNuQyxLQUFLLE1BQU0sQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDLENBQUM7WUFFakMsaURBQWlEO1lBQ2pELElBQUksQ0FBQyxJQUFJLENBQUMsd0JBQXdCLENBQUMsR0FBRyxDQUFDLGNBQWMsQ0FBQyxFQUFFLENBQUM7Z0JBQ3ZELElBQUksQ0FBQyx3QkFBd0IsQ0FBQyxHQUFHLENBQUMsY0FBYyxFQUFFLElBQUksR0FBRyxFQUFFLENBQUMsQ0FBQztZQUMvRCxDQUFDO1lBQ0QsSUFBSSxDQUFDLHdCQUF3QixDQUFDLEdBQUcsQ0FBQyxjQUFjLENBQUUsQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUM7WUFFL0QsNkNBQTZDO1lBQzdDLE1BQU0sQ0FBQyxFQUFFLENBQUMsY0FBYyxDQUFDLENBQUMsSUFBSSxDQUFDLDBCQUEwQixFQUFFO2dCQUN6RCxjQUFjO2dCQUNkLE1BQU07YUFDUCxDQUFDLENBQUM7WUFFSCxNQUFNLENBQUMsSUFBSSxDQUFDLHFCQUFxQixFQUFFLEVBQUUsY0FBYyxFQUFFLENBQUMsQ0FBQztZQUN2RCxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxRQUFRLE1BQU0sd0JBQXdCLGNBQWMsRUFBRSxDQUFDLENBQUM7UUFDMUUsQ0FBQztRQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7WUFDZixJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyw2QkFBNkIsRUFBRSxLQUFLLENBQUMsQ0FBQztZQUN4RCxNQUFNLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxFQUFFLE9BQU8sRUFBRSw2QkFBNkIsRUFBRSxDQUFDLENBQUM7UUFDbkUsQ0FBQztJQUNILENBQUM7SUFHRCx1QkFBdUIsQ0FDRixNQUEyQixFQUMvQixJQUEwQjtRQUV6Qyx1QkFBdUI7UUFDdkIsSUFBSSxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQztZQUNsQyxPQUFPO1FBQ1QsQ0FBQztRQUVELE1BQU0sRUFBRSxjQUFjLEVBQUUsR0FBRyxJQUFJLENBQUM7UUFDaEMsTUFBTSxNQUFNLEdBQUcsTUFBTSxDQUFDLE1BQU8sQ0FBQztRQUU5QixLQUFLLE1BQU0sQ0FBQyxLQUFLLENBQUMsY0FBYyxDQUFDLENBQUM7UUFFbEMsc0RBQXNEO1FBQ3RELE1BQU0sWUFBWSxHQUFHLElBQUksQ0FBQyx3QkFBd0IsQ0FBQyxHQUFHLENBQUMsY0FBYyxDQUFDLENBQUM7UUFDdkUsSUFBSSxZQUFZLEVBQUUsQ0FBQztZQUNqQixZQUFZLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1lBQzVCLElBQUksWUFBWSxDQUFDLElBQUksS0FBSyxDQUFDLEVBQUUsQ0FBQztnQkFDNUIsSUFBSSxDQUFDLHdCQUF3QixDQUFDLE1BQU0sQ0FBQyxjQUFjLENBQUMsQ0FBQztZQUN2RCxDQUFDO1FBQ0gsQ0FBQztRQUVELDJDQUEyQztRQUMzQyxNQUFNLENBQUMsRUFBRSxDQUFDLGNBQWMsQ0FBQyxDQUFDLElBQUksQ0FBQyx3QkFBd0IsRUFBRTtZQUN2RCxjQUFjO1lBQ2QsTUFBTTtTQUNQLENBQUMsQ0FBQztRQUVILE1BQU0sQ0FBQyxJQUFJLENBQUMsbUJBQW1CLEVBQUUsRUFBRSxjQUFjLEVBQUUsQ0FBQyxDQUFDO1FBQ3JELElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLFFBQVEsTUFBTSxzQkFBc0IsY0FBYyxFQUFFLENBQUMsQ0FBQztJQUN4RSxDQUFDO0lBR0ssQUFBTixLQUFLLENBQUMscUJBQXFCLENBQ04sTUFBMkIsRUFDL0IsSUFBd0I7UUFFdkMsdUJBQXVCO1FBQ3ZCLElBQUksQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUM7WUFDbEMsT0FBTztRQUNULENBQUM7UUFFRCxNQUFNLEVBQUUsY0FBYyxFQUFFLFFBQVEsR0FBRyxJQUFJLEVBQUUsR0FBRyxJQUFJLENBQUM7UUFDakQsTUFBTSxNQUFNLEdBQUcsTUFBTSxDQUFDLE1BQU8sQ0FBQztRQUU5QixzREFBc0Q7UUFDdEQsSUFBSSxRQUFRLEVBQUUsQ0FBQztZQUNiLE1BQU0sSUFBSSxDQUFDLE1BQU0sQ0FBQyxlQUFlLENBQUMsTUFBTSxDQUFDO2dCQUN2QyxLQUFLLEVBQUU7b0JBQ0wscUJBQXFCLEVBQUU7d0JBQ3JCLGNBQWM7d0JBQ2QsTUFBTTtxQkFDUDtpQkFDRjtnQkFDRCxNQUFNLEVBQUU7b0JBQ04sY0FBYztvQkFDZCxNQUFNO29CQUNOLFlBQVksRUFBRSxJQUFJLElBQUksRUFBRTtpQkFDekI7Z0JBQ0QsTUFBTSxFQUFFO29CQUNOLFlBQVksRUFBRSxJQUFJLElBQUksRUFBRTtpQkFDekI7YUFDRixDQUFDLENBQUM7UUFDTCxDQUFDO2FBQU0sQ0FBQztZQUNOLGlEQUFpRDtZQUNqRCxNQUFNLElBQUksQ0FBQyxNQUFNLENBQUMsZUFBZSxDQUFDLFVBQVUsQ0FBQztnQkFDM0MsS0FBSyxFQUFFO29CQUNMLGNBQWM7b0JBQ2QsTUFBTTtpQkFDUDthQUNGLENBQUMsQ0FBQztRQUNMLENBQUM7UUFFRCx1RUFBdUU7UUFDdkUsTUFBTSxDQUFDLEVBQUUsQ0FBQyxjQUFjLENBQUMsQ0FBQyxJQUFJLENBQUMsa0JBQWtCLEVBQUU7WUFDakQsY0FBYztZQUNkLE1BQU07WUFDTixRQUFRO1NBQ1QsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVELHFEQUFxRDtJQUNyRCxnQkFBZ0IsQ0FBQyxjQUFzQixFQUFFLE9BQVk7UUFDbkQsSUFBSSxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsY0FBYyxDQUFDLENBQUMsSUFBSSxDQUFDLGFBQWEsRUFBRSxPQUFPLENBQUMsQ0FBQztRQUU1RCxnRUFBZ0U7UUFDaEUsSUFBSSxDQUFDLHFCQUFxQixDQUFDLGNBQWMsRUFBRSxPQUFPLENBQUMsQ0FBQztJQUN0RCxDQUFDO0lBRUQseUNBQXlDO0lBQ3pDLHNCQUFzQixDQUNwQixjQUFzQixFQUN0QixTQUFpQixFQUNqQixNQUFXO1FBRVgsSUFBSSxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsY0FBYyxDQUFDLENBQUMsSUFBSSxDQUFDLGlCQUFpQixFQUFFO1lBQ3JELFNBQVM7WUFDVCxHQUFHLE1BQU07U0FDVixDQUFDLENBQUM7SUFDTCxDQUFDO0lBRUQseUJBQXlCO0lBQ3pCLG9CQUFvQixDQUNsQixjQUFzQixFQUN0QixTQUFpQixFQUNqQixNQUFjO1FBRWQsSUFBSSxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsY0FBYyxDQUFDLENBQUMsSUFBSSxDQUFDLGNBQWMsRUFBRTtZQUNsRCxTQUFTO1lBQ1QsTUFBTTtZQUNOLE1BQU0sRUFBRSxJQUFJLElBQUksRUFBRTtTQUNuQixDQUFDLENBQUM7SUFDTCxDQUFDO0lBRUQsNkJBQTZCO0lBQzdCLGlCQUFpQixDQUFDLGNBQXNCLEVBQUUsU0FBaUIsRUFBRSxRQUFhO1FBQ3hFLElBQUksQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLGNBQWMsQ0FBQyxDQUFDLElBQUksQ0FBQyxrQkFBa0IsRUFBRTtZQUN0RCxTQUFTO1lBQ1QsUUFBUTtTQUNULENBQUMsQ0FBQztJQUNMLENBQUM7SUFFRCx5QkFBeUI7SUFDekIsNENBQTRDO0lBQ3BDLGVBQWUsQ0FBQyxNQUEyQjtRQUNqRCxJQUFJLENBQUMsTUFBTSxDQUFDLGVBQWUsSUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLEVBQUUsQ0FBQztZQUM5QyxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FDZCwwQkFBMEIsTUFBTSxDQUFDLEVBQUUsOEJBQThCLENBQ2xFLENBQUM7WUFDRixNQUFNLENBQUMsSUFBSSxDQUFDLFlBQVksRUFBRTtnQkFDeEIsT0FBTyxFQUFFLHlDQUF5QztnQkFDbEQsSUFBSSxFQUFFLGVBQWU7YUFDdEIsQ0FBQyxDQUFDO1lBQ0gsT0FBTyxLQUFLLENBQUM7UUFDZixDQUFDO1FBQ0QsT0FBTyxJQUFJLENBQUM7SUFDZCxDQUFDO0lBRU8sS0FBSyxDQUFDLHFCQUFxQixDQUNqQyxNQUEyQixFQUMzQixNQUFjO1FBRWQsSUFBSSxDQUFDO1lBQ0gsNENBQTRDO1lBQzVDLE1BQU0sYUFBYSxHQUFHLE1BQU0sSUFBSSxDQUFDLE1BQU0sQ0FBQyxZQUFZLENBQUMsUUFBUSxDQUFDO2dCQUM1RCxLQUFLLEVBQUU7b0JBQ0wsWUFBWSxFQUFFO3dCQUNaLElBQUksRUFBRTs0QkFDSixNQUFNOzRCQUNOLFFBQVEsRUFBRSxJQUFJO3lCQUNmO3FCQUNGO29CQUNELFFBQVEsRUFBRSxJQUFJO2lCQUNmO2dCQUNELE1BQU0sRUFBRTtvQkFDTixFQUFFLEVBQUUsSUFBSTtpQkFDVDthQUNGLENBQUMsQ0FBQztZQUVILDhCQUE4QjtZQUM5QixLQUFLLE1BQU0sWUFBWSxJQUFJLGFBQWEsRUFBRSxDQUFDO2dCQUN6QyxLQUFLLE1BQU0sQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLEVBQUUsQ0FBQyxDQUFDO2dCQUVsQyxrQkFBa0I7Z0JBQ2xCLElBQUksQ0FBQyxJQUFJLENBQUMsd0JBQXdCLENBQUMsR0FBRyxDQUFDLFlBQVksQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDO29CQUN4RCxJQUFJLENBQUMsd0JBQXdCLENBQUMsR0FBRyxDQUFDLFlBQVksQ0FBQyxFQUFFLEVBQUUsSUFBSSxHQUFHLEVBQUUsQ0FBQyxDQUFDO2dCQUNoRSxDQUFDO2dCQUNELElBQUksQ0FBQyx3QkFBd0IsQ0FBQyxHQUFHLENBQUMsWUFBWSxDQUFDLEVBQUUsQ0FBRSxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsQ0FBQztZQUNsRSxDQUFDO1lBRUQsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQ2IsUUFBUSxNQUFNLFdBQVcsYUFBYSxDQUFDLE1BQU0scUJBQXFCLENBQ25FLENBQUM7UUFDSixDQUFDO1FBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztZQUNmLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLG1DQUFtQyxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQ2hFLENBQUM7SUFDSCxDQUFDO0lBRU8sS0FBSyxDQUFDLG1CQUFtQixDQUMvQixNQUFjLEVBQ2QsTUFBNEI7UUFFNUIsa0RBQWtEO1FBQ2xELE1BQU0sYUFBYSxHQUFHLE1BQU0sSUFBSSxDQUFDLE1BQU0sQ0FBQyxZQUFZLENBQUMsUUFBUSxDQUFDO1lBQzVELEtBQUssRUFBRTtnQkFDTCxZQUFZLEVBQUU7b0JBQ1osSUFBSSxFQUFFO3dCQUNKLE1BQU07d0JBQ04sUUFBUSxFQUFFLElBQUk7cUJBQ2Y7aUJBQ0Y7YUFDRjtZQUNELE1BQU0sRUFBRTtnQkFDTixFQUFFLEVBQUUsSUFBSTthQUNUO1NBQ0YsQ0FBQyxDQUFDO1FBRUgsNkNBQTZDO1FBQzdDLEtBQUssTUFBTSxZQUFZLElBQUksYUFBYSxFQUFFLENBQUM7WUFDekMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsWUFBWSxDQUFDLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxxQkFBcUIsRUFBRTtnQkFDMUQsTUFBTTtnQkFDTixNQUFNO2dCQUNOLFNBQVMsRUFBRSxJQUFJLElBQUksRUFBRTthQUN0QixDQUFDLENBQUM7UUFDTCxDQUFDO0lBQ0gsQ0FBQztJQUVPLEtBQUssQ0FBQyxxQkFBcUIsQ0FBQyxjQUFzQixFQUFFLE9BQVk7UUFDdEUsSUFBSSxDQUFDO1lBQ0gsNkRBQTZEO1lBQzdELE1BQU0sWUFBWSxHQUFHLE1BQU0sSUFBSSxDQUFDLE1BQU0sQ0FBQyxZQUFZLENBQUMsVUFBVSxDQUFDO2dCQUM3RCxLQUFLLEVBQUUsRUFBRSxFQUFFLEVBQUUsY0FBYyxFQUFFO2dCQUM3QixPQUFPLEVBQUU7b0JBQ1AsWUFBWSxFQUFFO3dCQUNaLE9BQU8sRUFBRTs0QkFDUCxJQUFJLEVBQUUsSUFBSTt5QkFDWDtxQkFDRjtpQkFDRjthQUNGLENBQUMsQ0FBQztZQUVILElBQUksQ0FBQyxZQUFZLEVBQUUsQ0FBQztnQkFDbEIsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQ2QsZ0JBQWdCLGNBQWMsbUNBQW1DLENBQ2xFLENBQUM7Z0JBQ0YsT0FBTztZQUNULENBQUM7WUFFRCw0REFBNEQ7WUFDNUQsTUFBTSxvQkFBb0IsR0FBRyxZQUFZLENBQUMsWUFBWSxDQUFDLE1BQU0sQ0FDM0QsQ0FBQyxXQUFXLEVBQUUsRUFBRTtnQkFDZCwrQkFBK0I7Z0JBQy9CLElBQUksV0FBVyxDQUFDLE1BQU0sS0FBSyxPQUFPLENBQUMsUUFBUSxFQUFFLENBQUM7b0JBQzVDLE9BQU8sS0FBSyxDQUFDO2dCQUNmLENBQUM7Z0JBRUQsbUZBQW1GO2dCQUNuRiwwREFBMEQ7Z0JBQzFELE1BQU0sc0JBQXNCLEdBQUcsSUFBSSxDQUFDO2dCQUNwQyxJQUFJLENBQUMsc0JBQXNCLEVBQUUsQ0FBQztvQkFDNUIsT0FBTyxLQUFLLENBQUM7Z0JBQ2YsQ0FBQztnQkFFRCxtRUFBbUU7Z0JBQ25FLHlFQUF5RTtnQkFDekUsT0FBTyxJQUFJLENBQUM7WUFDZCxDQUFDLENBQ0YsQ0FBQztZQUVGLElBQUksb0JBQW9CLENBQUMsTUFBTSxLQUFLLENBQUMsRUFBRSxDQUFDO2dCQUN0QyxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FDYixtRUFBbUUsY0FBYyxFQUFFLENBQ3BGLENBQUM7Z0JBQ0YsT0FBTztZQUNULENBQUM7WUFFRCwrQkFBK0I7WUFDL0IsTUFBTSxtQkFBbUIsR0FBRztnQkFDMUIsS0FBSyxFQUFFLGFBQWE7Z0JBQ3BCLElBQUksRUFDRixPQUFPLENBQUMsT0FBTyxDQUFDLE1BQU0sR0FBRyxFQUFFO29CQUN6QixDQUFDLENBQUMsR0FBRyxPQUFPLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLEtBQUs7b0JBQzFDLENBQUMsQ0FBQyxPQUFPLENBQUMsT0FBTztnQkFDckIsSUFBSSxFQUFFLG1CQUFtQjtnQkFDekIsS0FBSyxFQUFFLGtCQUFrQjtnQkFDekIsSUFBSSxFQUFFO29CQUNKLGNBQWMsRUFBRSxjQUFjO29CQUM5QixTQUFTLEVBQUUsT0FBTyxDQUFDLEVBQUU7b0JBQ3JCLFFBQVEsRUFBRSxPQUFPLENBQUMsUUFBUTtvQkFDMUIsR0FBRyxFQUFFLCtCQUErQixjQUFjLEVBQUU7aUJBQ3JEO2FBQ0YsQ0FBQztZQUVGLGlFQUFpRTtZQUNqRSxNQUFNLFlBQVksR0FBRyxvQkFBb0IsQ0FBQyxHQUFHLENBQUMsS0FBSyxFQUFFLFdBQVcsRUFBRSxFQUFFO2dCQUNsRSxJQUFJLENBQUM7b0JBQ0gsK0RBQStEO29CQUMvRCxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FDYix3Q0FBd0MsV0FBVyxDQUFDLE1BQU0sZ0JBQWdCLE9BQU8sQ0FBQyxFQUFFLG1DQUFtQyxDQUN4SCxDQUFDO29CQUVGLG1FQUFtRTtvQkFDbkUsNENBQTRDO2dCQUU5QyxDQUFDO2dCQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7b0JBQ2YsTUFBTSxZQUFZLEdBQ2hCLEtBQUssWUFBWSxLQUFLLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLGVBQWUsQ0FBQztvQkFDM0QsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQ2YsMkNBQTJDLFdBQVcsQ0FBQyxNQUFNLEtBQUssWUFBWSxFQUFFLENBQ2pGLENBQUM7Z0JBQ0osQ0FBQztZQUNILENBQUMsQ0FBQyxDQUFDO1lBRUgsTUFBTSxPQUFPLENBQUMsVUFBVSxDQUFDLFlBQVksQ0FBQyxDQUFDO1lBRXZDLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUNiLDJEQUEyRCxjQUFjLEVBQUUsQ0FDNUUsQ0FBQztRQUNKLENBQUM7UUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1lBQ2YsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQ2Ysc0RBQXNELGNBQWMsR0FBRyxFQUN2RSxLQUFLLENBQ04sQ0FBQztRQUNKLENBQUM7SUFDSCxDQUFDO0lBRUQsMERBQTBEO0lBQzFELEtBQUssQ0FBQyx1QkFBdUI7UUFDM0IsTUFBTSxjQUFjLEdBQUcsSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRSxHQUFHLENBQUMsR0FBRyxFQUFFLEdBQUcsSUFBSSxDQUFDLENBQUM7UUFFNUQsTUFBTSxJQUFJLENBQUMsTUFBTSxDQUFDLGVBQWUsQ0FBQyxVQUFVLENBQUM7WUFDM0MsS0FBSyxFQUFFO2dCQUNMLFlBQVksRUFBRTtvQkFDWixFQUFFLEVBQUUsY0FBYztpQkFDbkI7YUFDRjtTQUNGLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFRCxpRUFBaUU7SUFDakUsS0FBSyxDQUFDLDJCQUEyQixDQUMvQixNQUEyQixFQUMzQixNQUFjO1FBRWQsTUFBTSxRQUFRLEdBQUcsUUFBUSxNQUFNLEVBQUUsQ0FBQztRQUNsQyxNQUFNLE1BQU0sQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDNUIsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQ2YsUUFBUSxNQUFNLGlDQUFpQyxRQUFRLEVBQUUsQ0FDMUQsQ0FBQztJQUNKLENBQUM7SUFFRCxLQUFLLENBQUMsK0JBQStCLENBQ25DLE1BQTJCLEVBQzNCLE1BQWM7UUFFZCxNQUFNLFFBQVEsR0FBRyxRQUFRLE1BQU0sRUFBRSxDQUFDO1FBQ2xDLE1BQU0sTUFBTSxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUM3QixJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FDZixRQUFRLE1BQU0scUNBQXFDLFFBQVEsRUFBRSxDQUM5RCxDQUFDO0lBQ0osQ0FBQztJQUVELDREQUE0RDtJQUV0RCxBQUFOLEtBQUssQ0FBQyxtQkFBbUIsQ0FDSixNQUEyQixFQUMvQixJQUE2QjtRQUU1QyxJQUFJLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDO1lBQ2xDLE9BQU87UUFDVCxDQUFDO1FBRUQsTUFBTSxFQUFFLFdBQVcsRUFBRSxHQUFHLElBQUksQ0FBQztRQUM3QixNQUFNLE1BQU0sR0FBRyxNQUFNLENBQUMsTUFBTyxDQUFDO1FBRTlCLElBQUksQ0FBQztZQUNILDRDQUE0QztZQUM1QyxNQUFNLFVBQVUsR0FBRyxNQUFNLElBQUksQ0FBQyxNQUFNLENBQUMsVUFBVSxDQUFDLFNBQVMsQ0FBQztnQkFDeEQsS0FBSyxFQUFFO29CQUNMLFdBQVc7b0JBQ1gsTUFBTTtpQkFDUDthQUNGLENBQUMsQ0FBQztZQUVILElBQUksQ0FBQyxVQUFVLEVBQUUsQ0FBQztnQkFDaEIsTUFBTSxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUUsRUFBRSxPQUFPLEVBQUUsaUNBQWlDLEVBQUUsQ0FBQyxDQUFDO2dCQUNyRSxPQUFPO1lBQ1QsQ0FBQztZQUVELE1BQU0sYUFBYSxHQUFHLGFBQWEsV0FBVyxFQUFFLENBQUM7WUFDakQsTUFBTSxNQUFNLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxDQUFDO1lBRWpDLE1BQU0sQ0FBQyxJQUFJLENBQUMsa0JBQWtCLEVBQUUsRUFBRSxXQUFXLEVBQUUsQ0FBQyxDQUFDO1lBQ2pELElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLFFBQVEsTUFBTSwwQkFBMEIsV0FBVyxFQUFFLENBQUMsQ0FBQztRQUN6RSxDQUFDO1FBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztZQUNmLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLDBCQUEwQixFQUFFLEtBQUssQ0FBQyxDQUFDO1lBQ3JELE1BQU0sQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLEVBQUUsT0FBTyxFQUFFLDBCQUEwQixFQUFFLENBQUMsQ0FBQztRQUNoRSxDQUFDO0lBQ0gsQ0FBQztJQUdLLEFBQU4sS0FBSyxDQUFDLG9CQUFvQixDQUNMLE1BQTJCLEVBQy9CLElBQTZCO1FBRTVDLElBQUksQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUM7WUFDbEMsT0FBTztRQUNULENBQUM7UUFFRCxNQUFNLEVBQUUsV0FBVyxFQUFFLEdBQUcsSUFBSSxDQUFDO1FBQzdCLE1BQU0sTUFBTSxHQUFHLE1BQU0sQ0FBQyxNQUFPLENBQUM7UUFFOUIsTUFBTSxhQUFhLEdBQUcsYUFBYSxXQUFXLEVBQUUsQ0FBQztRQUNqRCxNQUFNLE1BQU0sQ0FBQyxLQUFLLENBQUMsYUFBYSxDQUFDLENBQUM7UUFFbEMsTUFBTSxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsRUFBRSxFQUFFLFdBQVcsRUFBRSxDQUFDLENBQUM7UUFDL0MsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsUUFBUSxNQUFNLHdCQUF3QixXQUFXLEVBQUUsQ0FBQyxDQUFDO0lBQ3ZFLENBQUM7SUFHSyxBQUFOLEtBQUssQ0FBQyxjQUFjLENBQ0MsTUFBMkIsRUFDL0IsSUFBd0I7UUFFdkMsSUFBSSxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQztZQUNsQyxPQUFPO1FBQ1QsQ0FBQztRQUVELE1BQU0sRUFBRSxNQUFNLEVBQUUsR0FBRyxJQUFJLENBQUM7UUFDeEIsTUFBTSxNQUFNLEdBQUcsTUFBTSxDQUFDLE1BQU8sQ0FBQztRQUU5QixJQUFJLENBQUM7WUFDSCx5Q0FBeUM7WUFDekMsTUFBTSxJQUFJLEdBQUcsTUFBTSxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUM7Z0JBQzVDLEtBQUssRUFBRTtvQkFDTCxFQUFFLEVBQUUsTUFBTTtvQkFDVixJQUFJLEVBQUU7d0JBQ0osU0FBUyxFQUFFOzRCQUNULFNBQVMsRUFBRTtnQ0FDVCxXQUFXLEVBQUU7b0NBQ1gsSUFBSSxFQUFFO3dDQUNKLE1BQU07cUNBQ1A7aUNBQ0Y7NkJBQ0Y7eUJBQ0Y7cUJBQ0Y7aUJBQ0Y7YUFDRixDQUFDLENBQUM7WUFFSCxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUM7Z0JBQ1YsTUFBTSxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUUsRUFBRSxPQUFPLEVBQUUsNEJBQTRCLEVBQUUsQ0FBQyxDQUFDO2dCQUNoRSxPQUFPO1lBQ1QsQ0FBQztZQUVELE1BQU0sUUFBUSxHQUFHLFFBQVEsTUFBTSxFQUFFLENBQUM7WUFDbEMsTUFBTSxNQUFNLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBRTVCLE1BQU0sQ0FBQyxJQUFJLENBQUMsYUFBYSxFQUFFLEVBQUUsTUFBTSxFQUFFLENBQUMsQ0FBQztZQUN2QyxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxRQUFRLE1BQU0scUJBQXFCLE1BQU0sRUFBRSxDQUFDLENBQUM7UUFDL0QsQ0FBQztRQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7WUFDZixJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxxQkFBcUIsRUFBRSxLQUFLLENBQUMsQ0FBQztZQUNoRCxNQUFNLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxFQUFFLE9BQU8sRUFBRSxxQkFBcUIsRUFBRSxDQUFDLENBQUM7UUFDM0QsQ0FBQztJQUNILENBQUM7SUFHSyxBQUFOLEtBQUssQ0FBQyxlQUFlLENBQ0EsTUFBMkIsRUFDL0IsSUFBd0I7UUFFdkMsSUFBSSxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQztZQUNsQyxPQUFPO1FBQ1QsQ0FBQztRQUVELE1BQU0sRUFBRSxNQUFNLEVBQUUsR0FBRyxJQUFJLENBQUM7UUFDeEIsTUFBTSxNQUFNLEdBQUcsTUFBTSxDQUFDLE1BQU8sQ0FBQztRQUU5QixNQUFNLFFBQVEsR0FBRyxRQUFRLE1BQU0sRUFBRSxDQUFDO1FBQ2xDLE1BQU0sTUFBTSxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUU3QixNQUFNLENBQUMsSUFBSSxDQUFDLFdBQVcsRUFBRSxFQUFFLE1BQU0sRUFBRSxDQUFDLENBQUM7UUFDckMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsUUFBUSxNQUFNLG1CQUFtQixNQUFNLEVBQUUsQ0FBQyxDQUFDO0lBQzdELENBQUM7SUFFRCwrREFBK0Q7SUFDL0QsU0FBUztRQUNQLE9BQU8sSUFBSSxDQUFDLE1BQU0sQ0FBQztJQUNyQixDQUFDO0NBQ0YsQ0FBQTtBQTNwQlksNENBQWdCO0FBSTNCO0lBREMsSUFBQSw0QkFBZSxHQUFFO2tEQUNULGtCQUFNLG9CQUFOLGtCQUFNO2dEQUFDO0FBNElWO0lBREwsSUFBQSw2QkFBZ0IsRUFBQyxtQkFBbUIsQ0FBQztJQUVuQyxXQUFBLElBQUEsNEJBQWUsR0FBRSxDQUFBO0lBQ2pCLFdBQUEsSUFBQSx3QkFBVyxHQUFFLENBQUE7Ozs7OERBZ0RmO0FBR0Q7SUFEQyxJQUFBLDZCQUFnQixFQUFDLG9CQUFvQixDQUFDO0lBRXBDLFdBQUEsSUFBQSw0QkFBZSxHQUFFLENBQUE7SUFDakIsV0FBQSxJQUFBLHdCQUFXLEdBQUUsQ0FBQTs7OzsrREE2QmY7QUFHSztJQURMLElBQUEsNkJBQWdCLEVBQUMsa0JBQWtCLENBQUM7SUFFbEMsV0FBQSxJQUFBLDRCQUFlLEdBQUUsQ0FBQTtJQUNqQixXQUFBLElBQUEsd0JBQVcsR0FBRSxDQUFBOzs7OzZEQTRDZjtBQXlRSztJQURMLElBQUEsNkJBQWdCLEVBQUMsZ0JBQWdCLENBQUM7SUFFaEMsV0FBQSxJQUFBLDRCQUFlLEdBQUUsQ0FBQTtJQUNqQixXQUFBLElBQUEsd0JBQVcsR0FBRSxDQUFBOzs7OzJEQWdDZjtBQUdLO0lBREwsSUFBQSw2QkFBZ0IsRUFBQyxpQkFBaUIsQ0FBQztJQUVqQyxXQUFBLElBQUEsNEJBQWUsR0FBRSxDQUFBO0lBQ2pCLFdBQUEsSUFBQSx3QkFBVyxHQUFFLENBQUE7Ozs7NERBY2Y7QUFHSztJQURMLElBQUEsNkJBQWdCLEVBQUMsV0FBVyxDQUFDO0lBRTNCLFdBQUEsSUFBQSw0QkFBZSxHQUFFLENBQUE7SUFDakIsV0FBQSxJQUFBLHdCQUFXLEdBQUUsQ0FBQTs7OztzREEwQ2Y7QUFHSztJQURMLElBQUEsNkJBQWdCLEVBQUMsWUFBWSxDQUFDO0lBRTVCLFdBQUEsSUFBQSw0QkFBZSxHQUFFLENBQUE7SUFDakIsV0FBQSxJQUFBLHdCQUFXLEdBQUUsQ0FBQTs7Ozt1REFjZjsyQkFycEJVLGdCQUFnQjtJQWI1QixJQUFBLDZCQUFnQixFQUFDO1FBQ2hCLElBQUksRUFBRTtZQUNKLE1BQU0sRUFBRTtnQkFDTixPQUFPLENBQUMsR0FBRyxDQUFDLFlBQVksSUFBSSx1QkFBdUI7Z0JBQ25ELHVCQUF1QixFQUFHLG9CQUFvQjtnQkFDOUMsdUJBQXVCLEVBQUcsd0JBQXdCO2FBQ25EO1lBQ0QsT0FBTyxFQUFFLENBQUMsS0FBSyxFQUFFLE1BQU0sQ0FBQztZQUN4QixXQUFXLEVBQUUsSUFBSTtZQUNqQixjQUFjLEVBQUUsQ0FBQyxlQUFlLEVBQUUsY0FBYyxDQUFDO1NBQ2xEO1FBQ0QsU0FBUyxFQUFFLFlBQVk7S0FDeEIsQ0FBQzt5REFZMkIsc0NBQWEsb0JBQWIsc0NBQWEsb0RBQ04sNkNBQW9CLG9CQUFwQiw2Q0FBb0I7R0FaM0MsZ0JBQWdCLENBMnBCNUIiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL21lc3NhZ2luZy9tZXNzYWdpbmcuZ2F0ZXdheS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBXZWJTb2NrZXRHYXRld2F5LFxuICBXZWJTb2NrZXRTZXJ2ZXIsXG4gIFN1YnNjcmliZU1lc3NhZ2UsXG4gIE9uR2F0ZXdheUNvbm5lY3Rpb24sXG4gIE9uR2F0ZXdheURpc2Nvbm5lY3QsXG4gIENvbm5lY3RlZFNvY2tldCxcbiAgTWVzc2FnZUJvZHksXG59IGZyb20gJ0BuZXN0anMvd2Vic29ja2V0cyc7XG5pbXBvcnQgeyBTZXJ2ZXIsIFNvY2tldCB9IGZyb20gJ3NvY2tldC5pbyc7XG5pbXBvcnQgeyBMb2dnZXIgfSBmcm9tICdAbmVzdGpzL2NvbW1vbic7XG5pbXBvcnQgeyBQcmlzbWFTZXJ2aWNlIH0gZnJvbSAnLi4vcHJvdmlkZXJzL3ByaXNtYS1jbGllbnQucHJvdmlkZXInO1xuaW1wb3J0IHsgV2ViU29ja2V0QXV0aFNlcnZpY2UgfSBmcm9tICcuL3NlcnZpY2VzL3dlYnNvY2tldC1hdXRoLnNlcnZpY2UnO1xuaW1wb3J0IHR5cGUge1xuICBKb2luQ29udmVyc2F0aW9uRHRvLFxuICBMZWF2ZUNvbnZlcnNhdGlvbkR0byxcbiAgVHlwaW5nSW5kaWNhdG9yRHRvLFxufSBmcm9tICcuL3R5cGVzJztcblxuaW50ZXJmYWNlIEF1dGhlbnRpY2F0ZWRTb2NrZXQgZXh0ZW5kcyBTb2NrZXQge1xuICB1c2VySWQ/OiBzdHJpbmc7XG4gIHVzZXJSb2xlPzogc3RyaW5nO1xuICBpc0F1dGhlbnRpY2F0ZWQ/OiBib29sZWFuO1xufVxuXG5AV2ViU29ja2V0R2F0ZXdheSh7XG4gIGNvcnM6IHtcbiAgICBvcmlnaW46IFtcbiAgICAgIHByb2Nlc3MuZW52LkZST05URU5EX1VSTCB8fCAnaHR0cDovL2xvY2FsaG9zdDozMDAwJyxcbiAgICAgICdodHRwOi8vbG9jYWxob3N0OjMwMDAnLCAgLy8gRXhwbGljaXQgZmFsbGJhY2tcbiAgICAgICdodHRwOi8vMTI3LjAuMC4xOjMwMDAnLCAgLy8gQWx0ZXJuYXRpdmUgbG9jYWxob3N0XG4gICAgXSxcbiAgICBtZXRob2RzOiBbJ0dFVCcsICdQT1NUJ10sXG4gICAgY3JlZGVudGlhbHM6IHRydWUsXG4gICAgYWxsb3dlZEhlYWRlcnM6IFsnYXV0aG9yaXphdGlvbicsICdjb250ZW50LXR5cGUnXSxcbiAgfSxcbiAgbmFtZXNwYWNlOiAnL21lc3NhZ2luZycsXG59KVxuZXhwb3J0IGNsYXNzIE1lc3NhZ2luZ0dhdGV3YXlcbiAgaW1wbGVtZW50cyBPbkdhdGV3YXlDb25uZWN0aW9uLCBPbkdhdGV3YXlEaXNjb25uZWN0XG57XG4gIEBXZWJTb2NrZXRTZXJ2ZXIoKVxuICBzZXJ2ZXIhOiBTZXJ2ZXI7XG5cbiAgcHJpdmF0ZSByZWFkb25seSBsb2dnZXIgPSBuZXcgTG9nZ2VyKE1lc3NhZ2luZ0dhdGV3YXkubmFtZSk7XG4gIHByaXZhdGUgdXNlclNvY2tldHMgPSBuZXcgTWFwPHN0cmluZywgU2V0PHN0cmluZz4+KCk7IC8vIHVzZXJJZCAtPiBTZXQgb2Ygc29ja2V0IElEc1xuICBwcml2YXRlIGNvbnZlcnNhdGlvblBhcnRpY2lwYW50cyA9IG5ldyBNYXA8c3RyaW5nLCBTZXQ8c3RyaW5nPj4oKTsgLy8gY29udmVyc2F0aW9uSWQgLT4gU2V0IG9mIHVzZXIgSURzXG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSByZWFkb25seSBwcmlzbWE6IFByaXNtYVNlcnZpY2UsXG4gICAgcHJpdmF0ZSByZWFkb25seSB3ZWJTb2NrZXRBdXRoOiBXZWJTb2NrZXRBdXRoU2VydmljZSxcbiAgKSB7fVxuXG4gIGFzeW5jIGhhbmRsZUNvbm5lY3Rpb24oY2xpZW50OiBBdXRoZW50aWNhdGVkU29ja2V0KSB7XG4gICAgdHJ5IHtcbiAgICAgIHRoaXMubG9nZ2VyLmxvZyhg8J+UjCBbTWVzc2FnaW5nR2F0ZXdheV0gTmV3IFdlYlNvY2tldCBjb25uZWN0aW9uIGF0dGVtcHQ6ICR7Y2xpZW50LmlkfWApO1xuICAgICAgdGhpcy5sb2dnZXIuZGVidWcoYPCflI0gW01lc3NhZ2luZ0dhdGV3YXldIENsaWVudCBoYW5kc2hha2U6YCwge1xuICAgICAgICBoZWFkZXJzOiBPYmplY3Qua2V5cyhjbGllbnQuaGFuZHNoYWtlLmhlYWRlcnMpLFxuICAgICAgICBhdXRoOiBjbGllbnQuaGFuZHNoYWtlLmF1dGgsXG4gICAgICAgIHF1ZXJ5OiBjbGllbnQuaGFuZHNoYWtlLnF1ZXJ5LFxuICAgICAgICB1cmw6IGNsaWVudC5oYW5kc2hha2UudXJsLFxuICAgICAgfSk7XG5cbiAgICAgIC8vIEF1dGhlbnRpY2F0ZSB0aGUgc29ja2V0IGNvbm5lY3Rpb24gdXNpbmcgdGhlIG5ldyBhdXRoIHNlcnZpY2VcbiAgICAgIGNvbnN0IGF1dGhSZXN1bHQgPSBhd2FpdCB0aGlzLndlYlNvY2tldEF1dGguYXV0aGVudGljYXRlU29ja2V0KGNsaWVudCk7XG5cbiAgICAgIGlmICghYXV0aFJlc3VsdCkge1xuICAgICAgICB0aGlzLmxvZ2dlci53YXJuKGDinYwgW01lc3NhZ2luZ0dhdGV3YXldIENsaWVudCAke2NsaWVudC5pZH0gYXV0aGVudGljYXRpb24gZmFpbGVkYCk7XG4gICAgICAgIGNsaWVudC5lbWl0KCdhdXRoX2Vycm9yJywge1xuICAgICAgICAgIG1lc3NhZ2U6ICdBdXRoZW50aWNhdGlvbiBmYWlsZWQuIFBsZWFzZSBwcm92aWRlIGEgdmFsaWQgdG9rZW4uJyxcbiAgICAgICAgICBjb2RlOiAnQVVUSF9GQUlMRUQnLFxuICAgICAgICB9KTtcbiAgICAgICAgY2xpZW50LmRpc2Nvbm5lY3QodHJ1ZSk7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cblxuICAgICAgdGhpcy5sb2dnZXIubG9nKGDinIUgW01lc3NhZ2luZ0dhdGV3YXldIENsaWVudCAke2NsaWVudC5pZH0gYXV0aGVudGljYXRlZCBhcyB1c2VyICR7YXV0aFJlc3VsdC51c2VySWR9YCk7XG5cbiAgICAgIC8vIEF0dGFjaCBhdXRoZW50aWNhdGVkIHVzZXIgaW5mbyB0byBzb2NrZXRcbiAgICAgIGNsaWVudC51c2VySWQgPSBhdXRoUmVzdWx0LnVzZXJJZDtcbiAgICAgIGNsaWVudC51c2VyUm9sZSA9IGF1dGhSZXN1bHQucm9sZTtcbiAgICAgIGNsaWVudC5pc0F1dGhlbnRpY2F0ZWQgPSB0cnVlO1xuXG4gICAgICAvLyBWZXJpZnkgdXNlciBleGlzdHMgaW4gZGF0YWJhc2UgYW5kIGlzIGFjdGl2ZVxuICAgICAgY29uc3QgdXNlciA9IGF3YWl0IHRoaXMucHJpc21hLnVzZXIuZmluZFVuaXF1ZSh7XG4gICAgICAgIHdoZXJlOiB7XG4gICAgICAgICAgaWQ6IGF1dGhSZXN1bHQudXNlcklkLFxuICAgICAgICAgIGlzQWN0aXZlOiB0cnVlLCAvLyBPbmx5IGFsbG93IGFjdGl2ZSB1c2Vyc1xuICAgICAgICB9LFxuICAgICAgICBzZWxlY3Q6IHsgaWQ6IHRydWUsIHJvbGU6IHRydWUsIGlzQWN0aXZlOiB0cnVlIH0sXG4gICAgICB9KTtcblxuICAgICAgaWYgKCF1c2VyKSB7XG4gICAgICAgIHRoaXMubG9nZ2VyLndhcm4oYFVzZXIgJHthdXRoUmVzdWx0LnVzZXJJZH0gbm90IGZvdW5kIG9yIGluYWN0aXZlYCk7XG4gICAgICAgIGNsaWVudC5lbWl0KCdhdXRoX2Vycm9yJywge1xuICAgICAgICAgIG1lc3NhZ2U6ICdVc2VyIGFjY291bnQgbm90IGZvdW5kIG9yIGluYWN0aXZlJyxcbiAgICAgICAgICBjb2RlOiAnVVNFUl9OT1RfRk9VTkQnLFxuICAgICAgICB9KTtcbiAgICAgICAgY2xpZW50LmRpc2Nvbm5lY3QodHJ1ZSk7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cblxuICAgICAgLy8gQWRkIHNvY2tldCB0byB1c2VyJ3Mgc29ja2V0IHNldFxuICAgICAgaWYgKCF0aGlzLnVzZXJTb2NrZXRzLmhhcyhhdXRoUmVzdWx0LnVzZXJJZCkpIHtcbiAgICAgICAgdGhpcy51c2VyU29ja2V0cy5zZXQoYXV0aFJlc3VsdC51c2VySWQsIG5ldyBTZXQoKSk7XG4gICAgICB9XG4gICAgICB0aGlzLnVzZXJTb2NrZXRzLmdldChhdXRoUmVzdWx0LnVzZXJJZCkhLmFkZChjbGllbnQuaWQpO1xuXG4gICAgICAvLyBKb2luIHVzZXIgdG8gdGhlaXIgY29udmVyc2F0aW9uIHJvb21zXG4gICAgICBhd2FpdCB0aGlzLmpvaW5Vc2VyQ29udmVyc2F0aW9ucyhjbGllbnQsIGF1dGhSZXN1bHQudXNlcklkKTtcblxuICAgICAgLy8gU3Vic2NyaWJlIHVzZXIgdG8gdGhlaXIgcGVyc29uYWwgbm90aWZpY2F0aW9uIHJvb21cbiAgICAgIGF3YWl0IHRoaXMuc3Vic2NyaWJlVXNlclRvUGVyc29uYWxSb29tKGNsaWVudCwgYXV0aFJlc3VsdC51c2VySWQpO1xuXG4gICAgICAvLyBOb3RpZnkgc3VjY2Vzc2Z1bCBjb25uZWN0aW9uXG4gICAgICBjbGllbnQuZW1pdCgnYXV0aGVudGljYXRlZCcsIHtcbiAgICAgICAgdXNlcklkOiBhdXRoUmVzdWx0LnVzZXJJZCxcbiAgICAgICAgcm9sZTogdXNlci5yb2xlLFxuICAgICAgICBtZXNzYWdlOiAnU3VjY2Vzc2Z1bGx5IGF1dGhlbnRpY2F0ZWQgYW5kIGNvbm5lY3RlZCcsXG4gICAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLFxuICAgICAgfSk7XG5cbiAgICAgIC8vIEVtaXQgdXNlciBvbmxpbmUgc3RhdHVzIHRvIHRoZWlyIGNvbnRhY3RzXG4gICAgICBhd2FpdCB0aGlzLmJyb2FkY2FzdFVzZXJTdGF0dXMoYXV0aFJlc3VsdC51c2VySWQsICdvbmxpbmUnKTtcblxuICAgICAgdGhpcy5sb2dnZXIubG9nKFxuICAgICAgICBgVXNlciAke2F1dGhSZXN1bHQudXNlcklkfSBzdWNjZXNzZnVsbHkgYXV0aGVudGljYXRlZCBhbmQgY29ubmVjdGVkIHdpdGggc29ja2V0ICR7Y2xpZW50LmlkfWAsXG4gICAgICApO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aGlzLmxvZ2dlci5lcnJvcihgQ29ubmVjdGlvbiBlcnJvciBmb3IgY2xpZW50ICR7Y2xpZW50LmlkfTpgLCBlcnJvcik7XG4gICAgICBjbGllbnQuZW1pdCgnY29ubmVjdGlvbl9lcnJvcicsIHtcbiAgICAgICAgbWVzc2FnZTogJ0ludGVybmFsIHNlcnZlciBlcnJvciBkdXJpbmcgY29ubmVjdGlvbicsXG4gICAgICAgIGNvZGU6ICdJTlRFUk5BTF9FUlJPUicsXG4gICAgICB9KTtcbiAgICAgIGNsaWVudC5kaXNjb25uZWN0KHRydWUpO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGhhbmRsZURpc2Nvbm5lY3QoY2xpZW50OiBBdXRoZW50aWNhdGVkU29ja2V0KSB7XG4gICAgdHJ5IHtcbiAgICAgIGlmIChjbGllbnQudXNlcklkKSB7XG4gICAgICAgIGNvbnN0IHVzZXJTb2NrZXRzID0gdGhpcy51c2VyU29ja2V0cy5nZXQoY2xpZW50LnVzZXJJZCk7XG4gICAgICAgIGlmICh1c2VyU29ja2V0cykge1xuICAgICAgICAgIHVzZXJTb2NrZXRzLmRlbGV0ZShjbGllbnQuaWQpO1xuXG4gICAgICAgICAgLy8gSWYgbm8gbW9yZSBzb2NrZXRzIGZvciB0aGlzIHVzZXIsIHJlbW92ZSBmcm9tIHRyYWNraW5nXG4gICAgICAgICAgaWYgKHVzZXJTb2NrZXRzLnNpemUgPT09IDApIHtcbiAgICAgICAgICAgIHRoaXMudXNlclNvY2tldHMuZGVsZXRlKGNsaWVudC51c2VySWQpO1xuXG4gICAgICAgICAgICAvLyBDbGVhbiB1cCBjb252ZXJzYXRpb24gcGFydGljaXBhbnRzIHRyYWNraW5nXG4gICAgICAgICAgICBmb3IgKGNvbnN0IFtcbiAgICAgICAgICAgICAgY29udmVyc2F0aW9uSWQsXG4gICAgICAgICAgICAgIHBhcnRpY2lwYW50cyxcbiAgICAgICAgICAgIF0gb2YgdGhpcy5jb252ZXJzYXRpb25QYXJ0aWNpcGFudHMuZW50cmllcygpKSB7XG4gICAgICAgICAgICAgIHBhcnRpY2lwYW50cy5kZWxldGUoY2xpZW50LnVzZXJJZCk7XG4gICAgICAgICAgICAgIC8vIFJlbW92ZSBlbXB0eSBjb252ZXJzYXRpb24gc2V0c1xuICAgICAgICAgICAgICBpZiAocGFydGljaXBhbnRzLnNpemUgPT09IDApIHtcbiAgICAgICAgICAgICAgICB0aGlzLmNvbnZlcnNhdGlvblBhcnRpY2lwYW50cy5kZWxldGUoY29udmVyc2F0aW9uSWQpO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIC8vIEJyb2FkY2FzdCB1c2VyIG9mZmxpbmUgc3RhdHVzIHRvIHRoZWlyIGNvbnRhY3RzXG4gICAgICAgICAgICBhd2FpdCB0aGlzLmJyb2FkY2FzdFVzZXJTdGF0dXMoY2xpZW50LnVzZXJJZCwgJ29mZmxpbmUnKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLmxvZ2dlci5sb2coXG4gICAgICAgICAgYFVzZXIgJHtjbGllbnQudXNlcklkfSBkaXNjb25uZWN0ZWQgc29ja2V0ICR7Y2xpZW50LmlkfWAsXG4gICAgICAgICk7XG4gICAgICB9XG5cbiAgICAgIC8vIENsZWFuIHVwIGF1dGhlbnRpY2F0aW9uIHRyYWNraW5nXG4gICAgICB0aGlzLndlYlNvY2tldEF1dGguY2xlYW51cENvbm5lY3Rpb24oY2xpZW50LmlkKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoXG4gICAgICAgIGBFcnJvciBkdXJpbmcgZGlzY29ubmVjdCBjbGVhbnVwIGZvciBzb2NrZXQgJHtjbGllbnQuaWR9OmAsXG4gICAgICAgIGVycm9yLFxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICBAU3Vic2NyaWJlTWVzc2FnZSgnam9pbl9jb252ZXJzYXRpb24nKVxuICBhc3luYyBoYW5kbGVKb2luQ29udmVyc2F0aW9uKFxuICAgIEBDb25uZWN0ZWRTb2NrZXQoKSBjbGllbnQ6IEF1dGhlbnRpY2F0ZWRTb2NrZXQsXG4gICAgQE1lc3NhZ2VCb2R5KCkgZGF0YTogSm9pbkNvbnZlcnNhdGlvbkR0byxcbiAgKSB7XG4gICAgLy8gQXV0aGVudGljYXRpb24gZ3VhcmRcbiAgICBpZiAoIXRoaXMuaXNBdXRoZW50aWNhdGVkKGNsaWVudCkpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICB0cnkge1xuICAgICAgY29uc3QgeyBjb252ZXJzYXRpb25JZCB9ID0gZGF0YTtcbiAgICAgIGNvbnN0IHVzZXJJZCA9IGNsaWVudC51c2VySWQhO1xuXG4gICAgICAvLyBWZXJpZnkgdXNlciBpcyBhIHBhcnRpY2lwYW50IGluIHRoaXMgY29udmVyc2F0aW9uXG4gICAgICBjb25zdCBwYXJ0aWNpcGF0aW9uID0gYXdhaXQgdGhpcy5wcmlzbWEuY29udmVyc2F0aW9uUGFydGljaXBhbnQuZmluZEZpcnN0KFxuICAgICAgICB7XG4gICAgICAgICAgd2hlcmU6IHtcbiAgICAgICAgICAgIGNvbnZlcnNhdGlvbklkLFxuICAgICAgICAgICAgdXNlcklkLFxuICAgICAgICAgICAgaXNBY3RpdmU6IHRydWUsXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgICk7XG5cbiAgICAgIGlmICghcGFydGljaXBhdGlvbikge1xuICAgICAgICBjbGllbnQuZW1pdCgnZXJyb3InLCB7IG1lc3NhZ2U6ICdBY2Nlc3MgZGVuaWVkIHRvIHRoaXMgY29udmVyc2F0aW9uJyB9KTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuXG4gICAgICAvLyBKb2luIHNvY2tldCB0byBjb252ZXJzYXRpb24gcm9vbVxuICAgICAgdm9pZCBjbGllbnQuam9pbihjb252ZXJzYXRpb25JZCk7XG5cbiAgICAgIC8vIEFkZCB1c2VyIHRvIGNvbnZlcnNhdGlvbiBwYXJ0aWNpcGFudHMgdHJhY2tpbmdcbiAgICAgIGlmICghdGhpcy5jb252ZXJzYXRpb25QYXJ0aWNpcGFudHMuaGFzKGNvbnZlcnNhdGlvbklkKSkge1xuICAgICAgICB0aGlzLmNvbnZlcnNhdGlvblBhcnRpY2lwYW50cy5zZXQoY29udmVyc2F0aW9uSWQsIG5ldyBTZXQoKSk7XG4gICAgICB9XG4gICAgICB0aGlzLmNvbnZlcnNhdGlvblBhcnRpY2lwYW50cy5nZXQoY29udmVyc2F0aW9uSWQpIS5hZGQodXNlcklkKTtcblxuICAgICAgLy8gTm90aWZ5IG90aGVyIHBhcnRpY2lwYW50cyB0aGF0IHVzZXIgam9pbmVkXG4gICAgICBjbGllbnQudG8oY29udmVyc2F0aW9uSWQpLmVtaXQoJ3VzZXJfam9pbmVkX2NvbnZlcnNhdGlvbicsIHtcbiAgICAgICAgY29udmVyc2F0aW9uSWQsXG4gICAgICAgIHVzZXJJZCxcbiAgICAgIH0pO1xuXG4gICAgICBjbGllbnQuZW1pdCgnY29udmVyc2F0aW9uX2pvaW5lZCcsIHsgY29udmVyc2F0aW9uSWQgfSk7XG4gICAgICB0aGlzLmxvZ2dlci5sb2coYFVzZXIgJHt1c2VySWR9IGpvaW5lZCBjb252ZXJzYXRpb24gJHtjb252ZXJzYXRpb25JZH1gKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoJ0Vycm9yIGpvaW5pbmcgY29udmVyc2F0aW9uOicsIGVycm9yKTtcbiAgICAgIGNsaWVudC5lbWl0KCdlcnJvcicsIHsgbWVzc2FnZTogJ0ZhaWxlZCB0byBqb2luIGNvbnZlcnNhdGlvbicgfSk7XG4gICAgfVxuICB9XG5cbiAgQFN1YnNjcmliZU1lc3NhZ2UoJ2xlYXZlX2NvbnZlcnNhdGlvbicpXG4gIGhhbmRsZUxlYXZlQ29udmVyc2F0aW9uKFxuICAgIEBDb25uZWN0ZWRTb2NrZXQoKSBjbGllbnQ6IEF1dGhlbnRpY2F0ZWRTb2NrZXQsXG4gICAgQE1lc3NhZ2VCb2R5KCkgZGF0YTogTGVhdmVDb252ZXJzYXRpb25EdG8sXG4gICkge1xuICAgIC8vIEF1dGhlbnRpY2F0aW9uIGd1YXJkXG4gICAgaWYgKCF0aGlzLmlzQXV0aGVudGljYXRlZChjbGllbnQpKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgeyBjb252ZXJzYXRpb25JZCB9ID0gZGF0YTtcbiAgICBjb25zdCB1c2VySWQgPSBjbGllbnQudXNlcklkITtcblxuICAgIHZvaWQgY2xpZW50LmxlYXZlKGNvbnZlcnNhdGlvbklkKTtcblxuICAgIC8vIFJlbW92ZSB1c2VyIGZyb20gY29udmVyc2F0aW9uIHBhcnRpY2lwYW50cyB0cmFja2luZ1xuICAgIGNvbnN0IHBhcnRpY2lwYW50cyA9IHRoaXMuY29udmVyc2F0aW9uUGFydGljaXBhbnRzLmdldChjb252ZXJzYXRpb25JZCk7XG4gICAgaWYgKHBhcnRpY2lwYW50cykge1xuICAgICAgcGFydGljaXBhbnRzLmRlbGV0ZSh1c2VySWQpO1xuICAgICAgaWYgKHBhcnRpY2lwYW50cy5zaXplID09PSAwKSB7XG4gICAgICAgIHRoaXMuY29udmVyc2F0aW9uUGFydGljaXBhbnRzLmRlbGV0ZShjb252ZXJzYXRpb25JZCk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gTm90aWZ5IG90aGVyIHBhcnRpY2lwYW50cyB0aGF0IHVzZXIgbGVmdFxuICAgIGNsaWVudC50byhjb252ZXJzYXRpb25JZCkuZW1pdCgndXNlcl9sZWZ0X2NvbnZlcnNhdGlvbicsIHtcbiAgICAgIGNvbnZlcnNhdGlvbklkLFxuICAgICAgdXNlcklkLFxuICAgIH0pO1xuXG4gICAgY2xpZW50LmVtaXQoJ2NvbnZlcnNhdGlvbl9sZWZ0JywgeyBjb252ZXJzYXRpb25JZCB9KTtcbiAgICB0aGlzLmxvZ2dlci5sb2coYFVzZXIgJHt1c2VySWR9IGxlZnQgY29udmVyc2F0aW9uICR7Y29udmVyc2F0aW9uSWR9YCk7XG4gIH1cblxuICBAU3Vic2NyaWJlTWVzc2FnZSgndHlwaW5nX2luZGljYXRvcicpXG4gIGFzeW5jIGhhbmRsZVR5cGluZ0luZGljYXRvcihcbiAgICBAQ29ubmVjdGVkU29ja2V0KCkgY2xpZW50OiBBdXRoZW50aWNhdGVkU29ja2V0LFxuICAgIEBNZXNzYWdlQm9keSgpIGRhdGE6IFR5cGluZ0luZGljYXRvckR0byxcbiAgKSB7XG4gICAgLy8gQXV0aGVudGljYXRpb24gZ3VhcmRcbiAgICBpZiAoIXRoaXMuaXNBdXRoZW50aWNhdGVkKGNsaWVudCkpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjb25zdCB7IGNvbnZlcnNhdGlvbklkLCBpc1R5cGluZyA9IHRydWUgfSA9IGRhdGE7XG4gICAgY29uc3QgdXNlcklkID0gY2xpZW50LnVzZXJJZCE7XG5cbiAgICAvLyBVcGRhdGUgdHlwaW5nIGluZGljYXRvciBpbiBkYXRhYmFzZSBmb3IgcGVyc2lzdGVuY2VcbiAgICBpZiAoaXNUeXBpbmcpIHtcbiAgICAgIGF3YWl0IHRoaXMucHJpc21hLnR5cGluZ0luZGljYXRvci51cHNlcnQoe1xuICAgICAgICB3aGVyZToge1xuICAgICAgICAgIGNvbnZlcnNhdGlvbklkX3VzZXJJZDoge1xuICAgICAgICAgICAgY29udmVyc2F0aW9uSWQsXG4gICAgICAgICAgICB1c2VySWQsXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgICAgY3JlYXRlOiB7XG4gICAgICAgICAgY29udmVyc2F0aW9uSWQsXG4gICAgICAgICAgdXNlcklkLFxuICAgICAgICAgIGxhc3RUeXBpbmdBdDogbmV3IERhdGUoKSxcbiAgICAgICAgfSxcbiAgICAgICAgdXBkYXRlOiB7XG4gICAgICAgICAgbGFzdFR5cGluZ0F0OiBuZXcgRGF0ZSgpLFxuICAgICAgICB9LFxuICAgICAgfSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIFJlbW92ZSB0eXBpbmcgaW5kaWNhdG9yIHdoZW4gdXNlciBzdG9wcyB0eXBpbmdcbiAgICAgIGF3YWl0IHRoaXMucHJpc21hLnR5cGluZ0luZGljYXRvci5kZWxldGVNYW55KHtcbiAgICAgICAgd2hlcmU6IHtcbiAgICAgICAgICBjb252ZXJzYXRpb25JZCxcbiAgICAgICAgICB1c2VySWQsXG4gICAgICAgIH0sXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICAvLyBCcm9hZGNhc3QgdHlwaW5nIGluZGljYXRvciB0byBvdGhlciBwYXJ0aWNpcGFudHMgaW4gdGhlIGNvbnZlcnNhdGlvblxuICAgIGNsaWVudC50byhjb252ZXJzYXRpb25JZCkuZW1pdCgndHlwaW5nX2luZGljYXRvcicsIHtcbiAgICAgIGNvbnZlcnNhdGlvbklkLFxuICAgICAgdXNlcklkLFxuICAgICAgaXNUeXBpbmcsXG4gICAgfSk7XG4gIH1cblxuICAvLyBCcm9hZGNhc3QgbmV3IG1lc3NhZ2UgdG8gY29udmVyc2F0aW9uIHBhcnRpY2lwYW50c1xuICBicm9hZGNhc3RNZXNzYWdlKGNvbnZlcnNhdGlvbklkOiBzdHJpbmcsIG1lc3NhZ2U6IGFueSkge1xuICAgIHRoaXMuc2VydmVyLnRvKGNvbnZlcnNhdGlvbklkKS5lbWl0KCduZXdfbWVzc2FnZScsIG1lc3NhZ2UpO1xuXG4gICAgLy8gU2VuZCBwdXNoIG5vdGlmaWNhdGlvbiB0byBvZmZsaW5lIHVzZXJzIChpbXBsZW1lbnQgYXMgbmVlZGVkKVxuICAgIHRoaXMuc2VuZFB1c2hOb3RpZmljYXRpb25zKGNvbnZlcnNhdGlvbklkLCBtZXNzYWdlKTtcbiAgfVxuXG4gIC8vIEJyb2FkY2FzdCBtZXNzYWdlIHVwZGF0ZSAoZWRpdC9kZWxldGUpXG4gIGJyb2FkY2FzdE1lc3NhZ2VVcGRhdGUoXG4gICAgY29udmVyc2F0aW9uSWQ6IHN0cmluZyxcbiAgICBtZXNzYWdlSWQ6IHN0cmluZyxcbiAgICB1cGRhdGU6IGFueSxcbiAgKSB7XG4gICAgdGhpcy5zZXJ2ZXIudG8oY29udmVyc2F0aW9uSWQpLmVtaXQoJ21lc3NhZ2VfdXBkYXRlZCcsIHtcbiAgICAgIG1lc3NhZ2VJZCxcbiAgICAgIC4uLnVwZGF0ZSxcbiAgICB9KTtcbiAgfVxuXG4gIC8vIEJyb2FkY2FzdCByZWFkIHJlY2VpcHRcbiAgYnJvYWRjYXN0UmVhZFJlY2VpcHQoXG4gICAgY29udmVyc2F0aW9uSWQ6IHN0cmluZyxcbiAgICBtZXNzYWdlSWQ6IHN0cmluZyxcbiAgICB1c2VySWQ6IHN0cmluZyxcbiAgKSB7XG4gICAgdGhpcy5zZXJ2ZXIudG8oY29udmVyc2F0aW9uSWQpLmVtaXQoJ21lc3NhZ2VfcmVhZCcsIHtcbiAgICAgIG1lc3NhZ2VJZCxcbiAgICAgIHVzZXJJZCxcbiAgICAgIHJlYWRBdDogbmV3IERhdGUoKSxcbiAgICB9KTtcbiAgfVxuXG4gIC8vIEJyb2FkY2FzdCBtZXNzYWdlIHJlYWN0aW9uXG4gIGJyb2FkY2FzdFJlYWN0aW9uKGNvbnZlcnNhdGlvbklkOiBzdHJpbmcsIG1lc3NhZ2VJZDogc3RyaW5nLCByZWFjdGlvbjogYW55KSB7XG4gICAgdGhpcy5zZXJ2ZXIudG8oY29udmVyc2F0aW9uSWQpLmVtaXQoJ21lc3NhZ2VfcmVhY3Rpb24nLCB7XG4gICAgICBtZXNzYWdlSWQsXG4gICAgICByZWFjdGlvbixcbiAgICB9KTtcbiAgfVxuXG4gIC8vIFByaXZhdGUgaGVscGVyIG1ldGhvZHNcbiAgLy8gQXV0aGVudGljYXRpb24gZ3VhcmQgZm9yIG1lc3NhZ2UgaGFuZGxlcnNcbiAgcHJpdmF0ZSBpc0F1dGhlbnRpY2F0ZWQoY2xpZW50OiBBdXRoZW50aWNhdGVkU29ja2V0KTogYm9vbGVhbiB7XG4gICAgaWYgKCFjbGllbnQuaXNBdXRoZW50aWNhdGVkIHx8ICFjbGllbnQudXNlcklkKSB7XG4gICAgICB0aGlzLmxvZ2dlci53YXJuKFxuICAgICAgICBgVW5hdXRoZW50aWNhdGVkIGNsaWVudCAke2NsaWVudC5pZH0gYXR0ZW1wdGVkIHRvIHBlcmZvcm0gYWN0aW9uYCxcbiAgICAgICk7XG4gICAgICBjbGllbnQuZW1pdCgnYXV0aF9lcnJvcicsIHtcbiAgICAgICAgbWVzc2FnZTogJ0F1dGhlbnRpY2F0aW9uIHJlcXVpcmVkIGZvciB0aGlzIGFjdGlvbicsXG4gICAgICAgIGNvZGU6ICdBVVRIX1JFUVVJUkVEJyxcbiAgICAgIH0pO1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgam9pblVzZXJDb252ZXJzYXRpb25zKFxuICAgIGNsaWVudDogQXV0aGVudGljYXRlZFNvY2tldCxcbiAgICB1c2VySWQ6IHN0cmluZyxcbiAgKSB7XG4gICAgdHJ5IHtcbiAgICAgIC8vIEdldCBhbGwgYWN0aXZlIGNvbnZlcnNhdGlvbnMgZm9yIHRoZSB1c2VyXG4gICAgICBjb25zdCBjb252ZXJzYXRpb25zID0gYXdhaXQgdGhpcy5wcmlzbWEuY29udmVyc2F0aW9uLmZpbmRNYW55KHtcbiAgICAgICAgd2hlcmU6IHtcbiAgICAgICAgICBwYXJ0aWNpcGFudHM6IHtcbiAgICAgICAgICAgIHNvbWU6IHtcbiAgICAgICAgICAgICAgdXNlcklkLFxuICAgICAgICAgICAgICBpc0FjdGl2ZTogdHJ1ZSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgICBpc0FjdGl2ZTogdHJ1ZSxcbiAgICAgICAgfSxcbiAgICAgICAgc2VsZWN0OiB7XG4gICAgICAgICAgaWQ6IHRydWUsXG4gICAgICAgIH0sXG4gICAgICB9KTtcblxuICAgICAgLy8gSm9pbiBhbGwgY29udmVyc2F0aW9uIHJvb21zXG4gICAgICBmb3IgKGNvbnN0IGNvbnZlcnNhdGlvbiBvZiBjb252ZXJzYXRpb25zKSB7XG4gICAgICAgIHZvaWQgY2xpZW50LmpvaW4oY29udmVyc2F0aW9uLmlkKTtcblxuICAgICAgICAvLyBBZGQgdG8gdHJhY2tpbmdcbiAgICAgICAgaWYgKCF0aGlzLmNvbnZlcnNhdGlvblBhcnRpY2lwYW50cy5oYXMoY29udmVyc2F0aW9uLmlkKSkge1xuICAgICAgICAgIHRoaXMuY29udmVyc2F0aW9uUGFydGljaXBhbnRzLnNldChjb252ZXJzYXRpb24uaWQsIG5ldyBTZXQoKSk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5jb252ZXJzYXRpb25QYXJ0aWNpcGFudHMuZ2V0KGNvbnZlcnNhdGlvbi5pZCkhLmFkZCh1c2VySWQpO1xuICAgICAgfVxuXG4gICAgICB0aGlzLmxvZ2dlci5sb2coXG4gICAgICAgIGBVc2VyICR7dXNlcklkfSBqb2luZWQgJHtjb252ZXJzYXRpb25zLmxlbmd0aH0gY29udmVyc2F0aW9uIHJvb21zYCxcbiAgICAgICk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRoaXMubG9nZ2VyLmVycm9yKCdFcnJvciBqb2luaW5nIHVzZXIgY29udmVyc2F0aW9uczonLCBlcnJvcik7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBicm9hZGNhc3RVc2VyU3RhdHVzKFxuICAgIHVzZXJJZDogc3RyaW5nLFxuICAgIHN0YXR1czogJ29ubGluZScgfCAnb2ZmbGluZScsXG4gICkge1xuICAgIC8vIEdldCBhbGwgY29udmVyc2F0aW9ucyB0aGlzIHVzZXIgcGFydGljaXBhdGVzIGluXG4gICAgY29uc3QgY29udmVyc2F0aW9ucyA9IGF3YWl0IHRoaXMucHJpc21hLmNvbnZlcnNhdGlvbi5maW5kTWFueSh7XG4gICAgICB3aGVyZToge1xuICAgICAgICBwYXJ0aWNpcGFudHM6IHtcbiAgICAgICAgICBzb21lOiB7XG4gICAgICAgICAgICB1c2VySWQsXG4gICAgICAgICAgICBpc0FjdGl2ZTogdHJ1ZSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgfSxcbiAgICAgIHNlbGVjdDoge1xuICAgICAgICBpZDogdHJ1ZSxcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICAvLyBCcm9hZGNhc3Qgc3RhdHVzIHRvIGFsbCBjb252ZXJzYXRpb24gcm9vbXNcbiAgICBmb3IgKGNvbnN0IGNvbnZlcnNhdGlvbiBvZiBjb252ZXJzYXRpb25zKSB7XG4gICAgICB0aGlzLnNlcnZlci50byhjb252ZXJzYXRpb24uaWQpLmVtaXQoJ3VzZXJfc3RhdHVzX2NoYW5nZWQnLCB7XG4gICAgICAgIHVzZXJJZCxcbiAgICAgICAgc3RhdHVzLFxuICAgICAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKCksXG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIHNlbmRQdXNoTm90aWZpY2F0aW9ucyhjb252ZXJzYXRpb25JZDogc3RyaW5nLCBtZXNzYWdlOiBhbnkpIHtcbiAgICB0cnkge1xuICAgICAgLy8gR2V0IGFsbCBwYXJ0aWNpcGFudHMgaW4gdGhlIGNvbnZlcnNhdGlvbiBleGNlcHQgdGhlIHNlbmRlclxuICAgICAgY29uc3QgY29udmVyc2F0aW9uID0gYXdhaXQgdGhpcy5wcmlzbWEuY29udmVyc2F0aW9uLmZpbmRVbmlxdWUoe1xuICAgICAgICB3aGVyZTogeyBpZDogY29udmVyc2F0aW9uSWQgfSxcbiAgICAgICAgaW5jbHVkZToge1xuICAgICAgICAgIHBhcnRpY2lwYW50czoge1xuICAgICAgICAgICAgaW5jbHVkZToge1xuICAgICAgICAgICAgICB1c2VyOiB0cnVlLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgfSk7XG5cbiAgICAgIGlmICghY29udmVyc2F0aW9uKSB7XG4gICAgICAgIHRoaXMubG9nZ2VyLndhcm4oXG4gICAgICAgICAgYENvbnZlcnNhdGlvbiAke2NvbnZlcnNhdGlvbklkfSBub3QgZm91bmQgZm9yIHB1c2ggbm90aWZpY2F0aW9uc2AsXG4gICAgICAgICk7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cblxuICAgICAgLy8gRmlsdGVyIHBhcnRpY2lwYW50cyB3aG8gc2hvdWxkIHJlY2VpdmUgcHVzaCBub3RpZmljYXRpb25zXG4gICAgICBjb25zdCBlbGlnaWJsZVBhcnRpY2lwYW50cyA9IGNvbnZlcnNhdGlvbi5wYXJ0aWNpcGFudHMuZmlsdGVyKFxuICAgICAgICAocGFydGljaXBhbnQpID0+IHtcbiAgICAgICAgICAvLyBEb24ndCBzZW5kIHRvIG1lc3NhZ2Ugc2VuZGVyXG4gICAgICAgICAgaWYgKHBhcnRpY2lwYW50LnVzZXJJZCA9PT0gbWVzc2FnZS5zZW5kZXJJZCkge1xuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIC8vIFVzZSBkZWZhdWx0IG5vdGlmaWNhdGlvbiBzZXR0aW5ncyBzaW5jZSBub3RpZmljYXRpb25TZXR0aW5ncyBtb2RlbCBkb2Vzbid0IGV4aXN0XG4gICAgICAgICAgLy8gRGVmYXVsdCB0byB0cnVlIGZvciBwdXNoIG5vdGlmaWNhdGlvbnMgZm9yIG5ldyBtZXNzYWdlc1xuICAgICAgICAgIGNvbnN0IGRlZmF1bHRQdXNoTmV3TWVzc2FnZXMgPSB0cnVlO1xuICAgICAgICAgIGlmICghZGVmYXVsdFB1c2hOZXdNZXNzYWdlcykge1xuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIC8vIE5vdGU6IE5vIGRldmljZSB0b2tlbiBmaWx0ZXJpbmcgYXZhaWxhYmxlIChubyBEZXZpY2VUb2tlbiBtb2RlbClcbiAgICAgICAgICAvLyBBbGwgcGFydGljaXBhbnRzIGFyZSBjb25zaWRlcmVkIGVsaWdpYmxlIGZvciBhbHRlcm5hdGl2ZSBub3RpZmljYXRpb25zXG4gICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH0sXG4gICAgICApO1xuXG4gICAgICBpZiAoZWxpZ2libGVQYXJ0aWNpcGFudHMubGVuZ3RoID09PSAwKSB7XG4gICAgICAgIHRoaXMubG9nZ2VyLmxvZyhcbiAgICAgICAgICBgTm8gZWxpZ2libGUgcGFydGljaXBhbnRzIGZvciBwdXNoIG5vdGlmaWNhdGlvbnMgaW4gY29udmVyc2F0aW9uICR7Y29udmVyc2F0aW9uSWR9YCxcbiAgICAgICAgKTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuXG4gICAgICAvLyBQcmVwYXJlIG5vdGlmaWNhdGlvbiBwYXlsb2FkXG4gICAgICBjb25zdCBub3RpZmljYXRpb25QYXlsb2FkID0ge1xuICAgICAgICB0aXRsZTogJ05ldyBNZXNzYWdlJyxcbiAgICAgICAgYm9keTpcbiAgICAgICAgICBtZXNzYWdlLmNvbnRlbnQubGVuZ3RoID4gNTBcbiAgICAgICAgICAgID8gYCR7bWVzc2FnZS5jb250ZW50LnN1YnN0cmluZygwLCA1MCl9Li4uYFxuICAgICAgICAgICAgOiBtZXNzYWdlLmNvbnRlbnQsXG4gICAgICAgIGljb246ICcvaWNvbi0xOTJ4MTkyLnBuZycsXG4gICAgICAgIGJhZGdlOiAnL2JhZGdlLTcyeDcyLnBuZycsXG4gICAgICAgIGRhdGE6IHtcbiAgICAgICAgICBjb252ZXJzYXRpb25JZDogY29udmVyc2F0aW9uSWQsXG4gICAgICAgICAgbWVzc2FnZUlkOiBtZXNzYWdlLmlkLFxuICAgICAgICAgIHNlbmRlcklkOiBtZXNzYWdlLnNlbmRlcklkLFxuICAgICAgICAgIHVybDogYC91c2VyL21lc3NhZ2VzP2NvbnZlcnNhdGlvbj0ke2NvbnZlcnNhdGlvbklkfWAsXG4gICAgICAgIH0sXG4gICAgICB9O1xuXG4gICAgICAvLyBBbHRlcm5hdGl2ZSBub3RpZmljYXRpb24gYXBwcm9hY2ggKG5vIGRldmljZSB0b2tlbnMgYXZhaWxhYmxlKVxuICAgICAgY29uc3QgcHVzaFByb21pc2VzID0gZWxpZ2libGVQYXJ0aWNpcGFudHMubWFwKGFzeW5jIChwYXJ0aWNpcGFudCkgPT4ge1xuICAgICAgICB0cnkge1xuICAgICAgICAgIC8vIExvZyBub3RpZmljYXRpb24gYXR0ZW1wdCAoYWx0ZXJuYXRpdmUgdG8gcHVzaCBub3RpZmljYXRpb25zKVxuICAgICAgICAgIHRoaXMubG9nZ2VyLmxvZyhcbiAgICAgICAgICAgIGBXb3VsZCBzZW5kIHB1c2ggbm90aWZpY2F0aW9uIHRvIHVzZXIgJHtwYXJ0aWNpcGFudC51c2VySWR9IGZvciBtZXNzYWdlICR7bWVzc2FnZS5pZH0gKG5vIERldmljZVRva2VuIG1vZGVsIGF2YWlsYWJsZSlgLFxuICAgICAgICAgICk7XG4gICAgICAgICAgXG4gICAgICAgICAgLy8gSGVyZSB5b3UgY291bGQgaW1wbGVtZW50IFdlYlNvY2tldC1iYXNlZCByZWFsLXRpbWUgbm90aWZpY2F0aW9uc1xuICAgICAgICAgIC8vIG9yIG90aGVyIGFsdGVybmF0aXZlIG5vdGlmaWNhdGlvbiBtZXRob2RzXG4gICAgICAgICAgXG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgY29uc3QgZXJyb3JNZXNzYWdlID1cbiAgICAgICAgICAgIGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogJ1Vua25vd24gZXJyb3InO1xuICAgICAgICAgIHRoaXMubG9nZ2VyLmVycm9yKFxuICAgICAgICAgICAgYEZhaWxlZCB0byBwcm9jZXNzIG5vdGlmaWNhdGlvbiBmb3IgdXNlciAke3BhcnRpY2lwYW50LnVzZXJJZH06ICR7ZXJyb3JNZXNzYWdlfWAsXG4gICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG5cbiAgICAgIGF3YWl0IFByb21pc2UuYWxsU2V0dGxlZChwdXNoUHJvbWlzZXMpO1xuXG4gICAgICB0aGlzLmxvZ2dlci5sb2coXG4gICAgICAgIGBQdXNoIG5vdGlmaWNhdGlvbiBwcm9jZXNzaW5nIGNvbXBsZXRlZCBmb3IgY29udmVyc2F0aW9uICR7Y29udmVyc2F0aW9uSWR9YCxcbiAgICAgICk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRoaXMubG9nZ2VyLmVycm9yKFxuICAgICAgICBgRmFpbGVkIHRvIHNlbmQgcHVzaCBub3RpZmljYXRpb25zIGZvciBjb252ZXJzYXRpb24gJHtjb252ZXJzYXRpb25JZH06YCxcbiAgICAgICAgZXJyb3IsXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIC8vIENsZWFuIHVwIG9sZCB0eXBpbmcgaW5kaWNhdG9ycyAoY2FsbCB0aGlzIHBlcmlvZGljYWxseSlcbiAgYXN5bmMgY2xlYW51cFR5cGluZ0luZGljYXRvcnMoKSB7XG4gICAgY29uc3QgZml2ZU1pbnV0ZXNBZ28gPSBuZXcgRGF0ZShEYXRlLm5vdygpIC0gNSAqIDYwICogMTAwMCk7XG5cbiAgICBhd2FpdCB0aGlzLnByaXNtYS50eXBpbmdJbmRpY2F0b3IuZGVsZXRlTWFueSh7XG4gICAgICB3aGVyZToge1xuICAgICAgICBsYXN0VHlwaW5nQXQ6IHtcbiAgICAgICAgICBsdDogZml2ZU1pbnV0ZXNBZ28sXG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgIH0pO1xuICB9XG5cbiAgLy8gUGVyc29uYWwgcm9vbSBzdWJzY3JpcHRpb24gbWV0aG9kcyBmb3IgcmVhbC10aW1lIG5vdGlmaWNhdGlvbnNcbiAgYXN5bmMgc3Vic2NyaWJlVXNlclRvUGVyc29uYWxSb29tKFxuICAgIGNsaWVudDogQXV0aGVudGljYXRlZFNvY2tldCxcbiAgICB1c2VySWQ6IHN0cmluZyxcbiAgKSB7XG4gICAgY29uc3QgdXNlclJvb20gPSBgdXNlcjoke3VzZXJJZH1gO1xuICAgIGF3YWl0IGNsaWVudC5qb2luKHVzZXJSb29tKTtcbiAgICB0aGlzLmxvZ2dlci5kZWJ1ZyhcbiAgICAgIGBVc2VyICR7dXNlcklkfSBzdWJzY3JpYmVkIHRvIHBlcnNvbmFsIHJvb206ICR7dXNlclJvb219YCxcbiAgICApO1xuICB9XG5cbiAgYXN5bmMgdW5zdWJzY3JpYmVVc2VyRnJvbVBlcnNvbmFsUm9vbShcbiAgICBjbGllbnQ6IEF1dGhlbnRpY2F0ZWRTb2NrZXQsXG4gICAgdXNlcklkOiBzdHJpbmcsXG4gICkge1xuICAgIGNvbnN0IHVzZXJSb29tID0gYHVzZXI6JHt1c2VySWR9YDtcbiAgICBhd2FpdCBjbGllbnQubGVhdmUodXNlclJvb20pO1xuICAgIHRoaXMubG9nZ2VyLmRlYnVnKFxuICAgICAgYFVzZXIgJHt1c2VySWR9IHVuc3Vic2NyaWJlZCBmcm9tIHBlcnNvbmFsIHJvb206ICR7dXNlclJvb219YCxcbiAgICApO1xuICB9XG5cbiAgLy8gQ29tbXVuaXR5IGFuZCBwb3N0IHJvb20gc3Vic2NyaXB0aW9ucyBmb3Igc29jaWFsIGZlYXR1cmVzXG4gIEBTdWJzY3JpYmVNZXNzYWdlKCdqb2luX2NvbW11bml0eScpXG4gIGFzeW5jIGhhbmRsZUpvaW5Db21tdW5pdHkoXG4gICAgQENvbm5lY3RlZFNvY2tldCgpIGNsaWVudDogQXV0aGVudGljYXRlZFNvY2tldCxcbiAgICBATWVzc2FnZUJvZHkoKSBkYXRhOiB7IGNvbW11bml0eUlkOiBzdHJpbmcgfSxcbiAgKSB7XG4gICAgaWYgKCF0aGlzLmlzQXV0aGVudGljYXRlZChjbGllbnQpKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgeyBjb21tdW5pdHlJZCB9ID0gZGF0YTtcbiAgICBjb25zdCB1c2VySWQgPSBjbGllbnQudXNlcklkITtcblxuICAgIHRyeSB7XG4gICAgICAvLyBWZXJpZnkgdXNlciBpcyBhIG1lbWJlciBvZiB0aGlzIGNvbW11bml0eVxuICAgICAgY29uc3QgbWVtYmVyc2hpcCA9IGF3YWl0IHRoaXMucHJpc21hLm1lbWJlcnNoaXAuZmluZEZpcnN0KHtcbiAgICAgICAgd2hlcmU6IHtcbiAgICAgICAgICBjb21tdW5pdHlJZCxcbiAgICAgICAgICB1c2VySWQsXG4gICAgICAgIH0sXG4gICAgICB9KTtcblxuICAgICAgaWYgKCFtZW1iZXJzaGlwKSB7XG4gICAgICAgIGNsaWVudC5lbWl0KCdlcnJvcicsIHsgbWVzc2FnZTogJ0FjY2VzcyBkZW5pZWQgdG8gdGhpcyBjb21tdW5pdHknIH0pO1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IGNvbW11bml0eVJvb20gPSBgY29tbXVuaXR5XyR7Y29tbXVuaXR5SWR9YDtcbiAgICAgIGF3YWl0IGNsaWVudC5qb2luKGNvbW11bml0eVJvb20pO1xuXG4gICAgICBjbGllbnQuZW1pdCgnY29tbXVuaXR5X2pvaW5lZCcsIHsgY29tbXVuaXR5SWQgfSk7XG4gICAgICB0aGlzLmxvZ2dlci5sb2coYFVzZXIgJHt1c2VySWR9IGpvaW5lZCBjb21tdW5pdHkgcm9vbSAke2NvbW11bml0eUlkfWApO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aGlzLmxvZ2dlci5lcnJvcignRXJyb3Igam9pbmluZyBjb21tdW5pdHk6JywgZXJyb3IpO1xuICAgICAgY2xpZW50LmVtaXQoJ2Vycm9yJywgeyBtZXNzYWdlOiAnRmFpbGVkIHRvIGpvaW4gY29tbXVuaXR5JyB9KTtcbiAgICB9XG4gIH1cblxuICBAU3Vic2NyaWJlTWVzc2FnZSgnbGVhdmVfY29tbXVuaXR5JylcbiAgYXN5bmMgaGFuZGxlTGVhdmVDb21tdW5pdHkoXG4gICAgQENvbm5lY3RlZFNvY2tldCgpIGNsaWVudDogQXV0aGVudGljYXRlZFNvY2tldCxcbiAgICBATWVzc2FnZUJvZHkoKSBkYXRhOiB7IGNvbW11bml0eUlkOiBzdHJpbmcgfSxcbiAgKSB7XG4gICAgaWYgKCF0aGlzLmlzQXV0aGVudGljYXRlZChjbGllbnQpKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgeyBjb21tdW5pdHlJZCB9ID0gZGF0YTtcbiAgICBjb25zdCB1c2VySWQgPSBjbGllbnQudXNlcklkITtcblxuICAgIGNvbnN0IGNvbW11bml0eVJvb20gPSBgY29tbXVuaXR5XyR7Y29tbXVuaXR5SWR9YDtcbiAgICBhd2FpdCBjbGllbnQubGVhdmUoY29tbXVuaXR5Um9vbSk7XG5cbiAgICBjbGllbnQuZW1pdCgnY29tbXVuaXR5X2xlZnQnLCB7IGNvbW11bml0eUlkIH0pO1xuICAgIHRoaXMubG9nZ2VyLmxvZyhgVXNlciAke3VzZXJJZH0gbGVmdCBjb21tdW5pdHkgcm9vbSAke2NvbW11bml0eUlkfWApO1xuICB9XG5cbiAgQFN1YnNjcmliZU1lc3NhZ2UoJ2pvaW5fcG9zdCcpXG4gIGFzeW5jIGhhbmRsZUpvaW5Qb3N0KFxuICAgIEBDb25uZWN0ZWRTb2NrZXQoKSBjbGllbnQ6IEF1dGhlbnRpY2F0ZWRTb2NrZXQsXG4gICAgQE1lc3NhZ2VCb2R5KCkgZGF0YTogeyBwb3N0SWQ6IHN0cmluZyB9LFxuICApIHtcbiAgICBpZiAoIXRoaXMuaXNBdXRoZW50aWNhdGVkKGNsaWVudCkpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjb25zdCB7IHBvc3RJZCB9ID0gZGF0YTtcbiAgICBjb25zdCB1c2VySWQgPSBjbGllbnQudXNlcklkITtcblxuICAgIHRyeSB7XG4gICAgICAvLyBWZXJpZnkgcG9zdCBleGlzdHMgYW5kIHVzZXIgaGFzIGFjY2Vzc1xuICAgICAgY29uc3QgcG9zdCA9IGF3YWl0IHRoaXMucHJpc21hLnBvc3QuZmluZEZpcnN0KHtcbiAgICAgICAgd2hlcmU6IHtcbiAgICAgICAgICBpZDogcG9zdElkLFxuICAgICAgICAgIHJvb206IHtcbiAgICAgICAgICAgIHJvb21Hcm91cDoge1xuICAgICAgICAgICAgICBjb21tdW5pdHk6IHtcbiAgICAgICAgICAgICAgICBtZW1iZXJzaGlwczoge1xuICAgICAgICAgICAgICAgICAgc29tZToge1xuICAgICAgICAgICAgICAgICAgICB1c2VySWQsXG4gICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICB9KTtcblxuICAgICAgaWYgKCFwb3N0KSB7XG4gICAgICAgIGNsaWVudC5lbWl0KCdlcnJvcicsIHsgbWVzc2FnZTogJ0FjY2VzcyBkZW5pZWQgdG8gdGhpcyBwb3N0JyB9KTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBwb3N0Um9vbSA9IGBwb3N0XyR7cG9zdElkfWA7XG4gICAgICBhd2FpdCBjbGllbnQuam9pbihwb3N0Um9vbSk7XG5cbiAgICAgIGNsaWVudC5lbWl0KCdwb3N0X2pvaW5lZCcsIHsgcG9zdElkIH0pO1xuICAgICAgdGhpcy5sb2dnZXIubG9nKGBVc2VyICR7dXNlcklkfSBqb2luZWQgcG9zdCByb29tICR7cG9zdElkfWApO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aGlzLmxvZ2dlci5lcnJvcignRXJyb3Igam9pbmluZyBwb3N0OicsIGVycm9yKTtcbiAgICAgIGNsaWVudC5lbWl0KCdlcnJvcicsIHsgbWVzc2FnZTogJ0ZhaWxlZCB0byBqb2luIHBvc3QnIH0pO1xuICAgIH1cbiAgfVxuXG4gIEBTdWJzY3JpYmVNZXNzYWdlKCdsZWF2ZV9wb3N0JylcbiAgYXN5bmMgaGFuZGxlTGVhdmVQb3N0KFxuICAgIEBDb25uZWN0ZWRTb2NrZXQoKSBjbGllbnQ6IEF1dGhlbnRpY2F0ZWRTb2NrZXQsXG4gICAgQE1lc3NhZ2VCb2R5KCkgZGF0YTogeyBwb3N0SWQ6IHN0cmluZyB9LFxuICApIHtcbiAgICBpZiAoIXRoaXMuaXNBdXRoZW50aWNhdGVkKGNsaWVudCkpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjb25zdCB7IHBvc3RJZCB9ID0gZGF0YTtcbiAgICBjb25zdCB1c2VySWQgPSBjbGllbnQudXNlcklkITtcblxuICAgIGNvbnN0IHBvc3RSb29tID0gYHBvc3RfJHtwb3N0SWR9YDtcbiAgICBhd2FpdCBjbGllbnQubGVhdmUocG9zdFJvb20pO1xuXG4gICAgY2xpZW50LmVtaXQoJ3Bvc3RfbGVmdCcsIHsgcG9zdElkIH0pO1xuICAgIHRoaXMubG9nZ2VyLmxvZyhgVXNlciAke3VzZXJJZH0gbGVmdCBwb3N0IHJvb20gJHtwb3N0SWR9YCk7XG4gIH1cblxuICAvLyBVdGlsaXR5IG1ldGhvZCB0byBnZXQgc2VydmVyIGluc3RhbmNlIGZvciBldmVudCBicm9hZGNhc3RpbmdcbiAgZ2V0U2VydmVyKCk6IFNlcnZlciB7XG4gICAgcmV0dXJuIHRoaXMuc2VydmVyO1xuICB9XG59XG4iXSwidmVyc2lvbiI6M30=