49fdf619a3cf1a44f05a320c2ff4fbfe
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var __param = (this && this.__param) || function (paramIndex, decorator) {
    return function (target, key) { decorator(target, key, paramIndex); }
};
var _a, _b, _c, _d, _e;
Object.defineProperty(exports, "__esModule", { value: true });
exports.ReviewsController = void 0;
const common_1 = require("@nestjs/common");
const reviews_service_1 = require("./reviews.service");
const jwt_auth_guard_1 = require("../auth/guards/jwt-auth.guard");
const current_user_id_decorator_1 = require("../auth/decorators/current-user-id.decorator");
const current_user_role_decorator_1 = require("../auth/decorators/current-user-role.decorator");
const zod_validation_pipe_1 = require("../common/pipes/zod-validation.pipe");
const validation_1 = require("./validation");
let ReviewsController = class ReviewsController {
    reviewsService;
    constructor(reviewsService) {
        this.reviewsService = reviewsService;
    }
    async createReview(meetingId, clientId, therapistId, createReviewDto) {
        return this.reviewsService.createReview(meetingId, clientId, therapistId, createReviewDto);
    }
    async updateReview(reviewId, clientId, updateReviewDto) {
        return this.reviewsService.updateReview(reviewId, clientId, updateReviewDto);
    }
    async deleteReview(reviewId, clientId) {
        return this.reviewsService.deleteReview(reviewId, clientId);
    }
    async getReviews(query) {
        return this.reviewsService.getReviews(query);
    }
    async getTherapistReviews(therapistId, query) {
        return this.reviewsService.getTherapistReviews(therapistId, query);
    }
    async getTherapistReviewStats(therapistId) {
        return this.reviewsService.getReviewStats(therapistId);
    }
    async markReviewHelpful(reviewId, userId) {
        return this.reviewsService.markReviewHelpful(reviewId, userId);
    }
    // Admin/Moderator endpoints
    async moderateReview(reviewId, moderatorId, userRole, moderateReviewDto) {
        // Only allow moderators and admins to moderate reviews
        if (!['moderator', 'admin'].includes(userRole)) {
            throw new common_1.ForbiddenException('Insufficient permissions');
        }
        return this.reviewsService.moderateReview(reviewId, moderatorId, moderateReviewDto);
    }
    async getPendingReviews(userRole, query) {
        // Only allow moderators and admins to view pending reviews
        if (!['moderator', 'admin'].includes(userRole)) {
            throw new common_1.ForbiddenException('Insufficient permissions');
        }
        return this.reviewsService.getReviews({
            ...query,
            status: 'pending',
        });
    }
};
exports.ReviewsController = ReviewsController;
__decorate([
    (0, common_1.Post)(':meetingId/:therapistId'),
    (0, common_1.HttpCode)(common_1.HttpStatus.CREATED),
    __param(0, (0, common_1.Param)('meetingId')),
    __param(1, (0, current_user_id_decorator_1.CurrentUserId)()),
    __param(2, (0, common_1.Param)('therapistId')),
    __param(3, (0, common_1.Body)(new zod_validation_pipe_1.ZodValidationPipe(validation_1.CreateReviewDtoSchema))),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [String, String, String, Object]),
    __metadata("design:returntype", Promise)
], ReviewsController.prototype, "createReview", null);
__decorate([
    (0, common_1.Put)(':id'),
    __param(0, (0, common_1.Param)('id')),
    __param(1, (0, current_user_id_decorator_1.CurrentUserId)()),
    __param(2, (0, common_1.Body)(new zod_validation_pipe_1.ZodValidationPipe(validation_1.UpdateReviewDtoSchema))),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [String, String, Object]),
    __metadata("design:returntype", Promise)
], ReviewsController.prototype, "updateReview", null);
__decorate([
    (0, common_1.Delete)(':id'),
    (0, common_1.HttpCode)(common_1.HttpStatus.NO_CONTENT),
    __param(0, (0, common_1.Param)('id')),
    __param(1, (0, current_user_id_decorator_1.CurrentUserId)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [String, String]),
    __metadata("design:returntype", Promise)
], ReviewsController.prototype, "deleteReview", null);
__decorate([
    (0, common_1.Get)(),
    __param(0, (0, common_1.Query)(new zod_validation_pipe_1.ZodValidationPipe(validation_1.GetReviewsDtoSchema))),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Object]),
    __metadata("design:returntype", typeof (_b = typeof Promise !== "undefined" && Promise) === "function" ? _b : Object)
], ReviewsController.prototype, "getReviews", null);
__decorate([
    (0, common_1.Get)('therapist/:therapistId'),
    __param(0, (0, common_1.Param)('therapistId')),
    __param(1, (0, common_1.Query)(new zod_validation_pipe_1.ZodValidationPipe(validation_1.GetReviewsDtoSchema))),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [String, typeof (_c = typeof Omit !== "undefined" && Omit) === "function" ? _c : Object]),
    __metadata("design:returntype", typeof (_d = typeof Promise !== "undefined" && Promise) === "function" ? _d : Object)
], ReviewsController.prototype, "getTherapistReviews", null);
__decorate([
    (0, common_1.Get)('therapist/:therapistId/stats'),
    __param(0, (0, common_1.Param)('therapistId')),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [String]),
    __metadata("design:returntype", Promise)
], ReviewsController.prototype, "getTherapistReviewStats", null);
__decorate([
    (0, common_1.Post)(':id/helpful'),
    (0, common_1.HttpCode)(common_1.HttpStatus.OK),
    __param(0, (0, common_1.Param)('id', new zod_validation_pipe_1.ZodValidationPipe(validation_1.ReviewIdParamSchema))),
    __param(1, (0, current_user_id_decorator_1.CurrentUserId)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [String, String]),
    __metadata("design:returntype", Promise)
], ReviewsController.prototype, "markReviewHelpful", null);
__decorate([
    (0, common_1.Post)(':id/moderate'),
    (0, common_1.HttpCode)(common_1.HttpStatus.OK),
    __param(0, (0, common_1.Param)('id', new zod_validation_pipe_1.ZodValidationPipe(validation_1.ReviewIdParamSchema))),
    __param(1, (0, current_user_id_decorator_1.CurrentUserId)()),
    __param(2, (0, current_user_role_decorator_1.CurrentUserRole)()),
    __param(3, (0, common_1.Body)(new zod_validation_pipe_1.ZodValidationPipe(validation_1.ModerateReviewDtoSchema))),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [String, String, String, Object]),
    __metadata("design:returntype", Promise)
], ReviewsController.prototype, "moderateReview", null);
__decorate([
    (0, common_1.Get)('pending'),
    __param(0, (0, current_user_role_decorator_1.CurrentUserRole)()),
    __param(1, (0, common_1.Query)(new zod_validation_pipe_1.ZodValidationPipe(validation_1.GetReviewsDtoSchema))),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [String, Object]),
    __metadata("design:returntype", typeof (_e = typeof Promise !== "undefined" && Promise) === "function" ? _e : Object)
], ReviewsController.prototype, "getPendingReviews", null);
exports.ReviewsController = ReviewsController = __decorate([
    (0, common_1.Controller)('reviews'),
    (0, common_1.UseGuards)(jwt_auth_guard_1.JwtAuthGuard),
    __metadata("design:paramtypes", [typeof (_a = typeof reviews_service_1.ReviewsService !== "undefined" && reviews_service_1.ReviewsService) === "function" ? _a : Object])
], ReviewsController);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL3Jldmlld3MvcmV2aWV3cy5jb250cm9sbGVyLnRzIiwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQSwyQ0Fhd0I7QUFDeEIsdURBQW1EO0FBQ25ELGtFQUE2RDtBQUM3RCw0RkFBNkU7QUFDN0UsZ0dBQWlGO0FBQ2pGLDZFQUF3RTtBQUN4RSw2Q0FNc0I7QUFZZixJQUFNLGlCQUFpQixHQUF2QixNQUFNLGlCQUFpQjtJQUNDO0lBQTdCLFlBQTZCLGNBQThCO1FBQTlCLG1CQUFjLEdBQWQsY0FBYyxDQUFnQjtJQUFHLENBQUM7SUFJekQsQUFBTixLQUFLLENBQUMsWUFBWSxDQUNJLFNBQWlCLEVBQ3BCLFFBQWdCLEVBQ1gsV0FBbUIsRUFFekMsZUFBZ0M7UUFFaEMsT0FBTyxJQUFJLENBQUMsY0FBYyxDQUFDLFlBQVksQ0FDckMsU0FBUyxFQUNULFFBQVEsRUFDUixXQUFXLEVBQ1gsZUFBZSxDQUNoQixDQUFDO0lBQ0osQ0FBQztJQUdLLEFBQU4sS0FBSyxDQUFDLFlBQVksQ0FDSCxRQUFnQixFQUNaLFFBQWdCLEVBRWpDLGVBQWdDO1FBRWhDLE9BQU8sSUFBSSxDQUFDLGNBQWMsQ0FBQyxZQUFZLENBQ3JDLFFBQVEsRUFDUixRQUFRLEVBQ1IsZUFBZSxDQUNoQixDQUFDO0lBQ0osQ0FBQztJQUlLLEFBQU4sS0FBSyxDQUFDLFlBQVksQ0FDSCxRQUFnQixFQUNaLFFBQWdCO1FBRWpDLE9BQU8sSUFBSSxDQUFDLGNBQWMsQ0FBQyxZQUFZLENBQUMsUUFBUSxFQUFFLFFBQVEsQ0FBQyxDQUFDO0lBQzlELENBQUM7SUFHSyxBQUFOLEtBQUssQ0FBQyxVQUFVLENBQ3FDLEtBQW9CO1FBRXZFLE9BQU8sSUFBSSxDQUFDLGNBQWMsQ0FBQyxVQUFVLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDL0MsQ0FBQztJQUdLLEFBQU4sS0FBSyxDQUFDLG1CQUFtQixDQUNELFdBQW1CLEVB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Qzt5REFFdUIsZ0NBQWMsb0JBQWQsZ0NBQWM7R0FEaEQsaUJBQWlCLENBOEc3QiIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvaG9tZS93ZXRvb2EvRG9jdW1lbnRzL2NvZGUvcHJvamVjdHMvbWVudGFyYS9tZW50YXJhLWFwaS9zcmMvcmV2aWV3cy9yZXZpZXdzLmNvbnRyb2xsZXIudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgQ29udHJvbGxlcixcbiAgR2V0LFxuICBQb3N0LFxuICBQdXQsXG4gIERlbGV0ZSxcbiAgQm9keSxcbiAgUGFyYW0sXG4gIFF1ZXJ5LFxuICBVc2VHdWFyZHMsXG4gIEh0dHBDb2RlLFxuICBIdHRwU3RhdHVzLFxuICBGb3JiaWRkZW5FeGNlcHRpb24sXG59IGZyb20gJ0BuZXN0anMvY29tbW9uJztcbmltcG9ydCB7IFJldmlld3NTZXJ2aWNlIH0gZnJvbSAnLi9yZXZpZXdzLnNlcnZpY2UnO1xuaW1wb3J0IHsgSnd0QXV0aEd1YXJkIH0gZnJvbSAnLi4vYXV0aC9ndWFyZHMvand0LWF1dGguZ3VhcmQnO1xuaW1wb3J0IHsgQ3VycmVudFVzZXJJZCB9IGZyb20gJy4uL2F1dGgvZGVjb3JhdG9ycy9jdXJyZW50LXVzZXItaWQuZGVjb3JhdG9yJztcbmltcG9ydCB7IEN1cnJlbnRVc2VyUm9sZSB9IGZyb20gJy4uL2F1dGgvZGVjb3JhdG9ycy9jdXJyZW50LXVzZXItcm9sZS5kZWNvcmF0b3InO1xuaW1wb3J0IHsgWm9kVmFsaWRhdGlvblBpcGUgfSBmcm9tICcuLi9jb21tb24vcGlwZXMvem9kLXZhbGlkYXRpb24ucGlwZSc7XG5pbXBvcnQge1xuICBDcmVhdGVSZXZpZXdEdG9TY2hlbWEsXG4gIFVwZGF0ZVJldmlld0R0b1NjaGVtYSxcbiAgTW9kZXJhdGVSZXZpZXdEdG9TY2hlbWEsXG4gIEdldFJldmlld3NEdG9TY2hlbWEsXG4gIFJldmlld0lkUGFyYW1TY2hlbWEsXG59IGZyb20gJy4vdmFsaWRhdGlvbic7XG5pbXBvcnQgdHlwZSB7XG4gIENyZWF0ZVJldmlld0R0byxcbiAgVXBkYXRlUmV2aWV3RHRvLFxuICBNb2RlcmF0ZVJldmlld0R0byxcbiAgR2V0UmV2aWV3c0R0byxcbiAgUmV2aWV3SWRQYXJhbSxcbiAgUmV2aWV3TGlzdFJlc3BvbnNlLFxufSBmcm9tICcuL3R5cGVzJztcblxuQENvbnRyb2xsZXIoJ3Jldmlld3MnKVxuQFVzZUd1YXJkcyhKd3RBdXRoR3VhcmQpXG5leHBvcnQgY2xhc3MgUmV2aWV3c0NvbnRyb2xsZXIge1xuICBjb25zdHJ1Y3Rvcihwcml2YXRlIHJlYWRvbmx5IHJldmlld3NTZXJ2aWNlOiBSZXZpZXdzU2VydmljZSkge31cblxuICBAUG9zdCgnOm1lZXRpbmdJZC86dGhlcmFwaXN0SWQnKVxuICBASHR0cENvZGUoSHR0cFN0YXR1cy5DUkVBVEVEKVxuICBhc3luYyBjcmVhdGVSZXZpZXcoXG4gICAgQFBhcmFtKCdtZWV0aW5nSWQnKSBtZWV0aW5nSWQ6IHN0cmluZyxcbiAgICBAQ3VycmVudFVzZXJJZCgpIGNsaWVudElkOiBzdHJpbmcsXG4gICAgQFBhcmFtKCd0aGVyYXBpc3RJZCcpIHRoZXJhcGlzdElkOiBzdHJpbmcsXG4gICAgQEJvZHkobmV3IFpvZFZhbGlkYXRpb25QaXBlKENyZWF0ZVJldmlld0R0b1NjaGVtYSkpXG4gICAgY3JlYXRlUmV2aWV3RHRvOiBDcmVhdGVSZXZpZXdEdG8sXG4gICkge1xuICAgIHJldHVybiB0aGlzLnJldmlld3NTZXJ2aWNlLmNyZWF0ZVJldmlldyhcbiAgICAgIG1lZXRpbmdJZCxcbiAgICAgIGNsaWVudElkLFxuICAgICAgdGhlcmFwaXN0SWQsXG4gICAgICBjcmVhdGVSZXZpZXdEdG8sXG4gICAgKTtcbiAgfVxuXG4gIEBQdXQoJzppZCcpXG4gIGFzeW5jIHVwZGF0ZVJldmlldyhcbiAgICBAUGFyYW0oJ2lkJykgcmV2aWV3SWQ6IHN0cmluZyxcbiAgICBAQ3VycmVudFVzZXJJZCgpIGNsaWVudElkOiBzdHJpbmcsXG4gICAgQEJvZHkobmV3IFpvZFZhbGlkYXRpb25QaXBlKFVwZGF0ZVJldmlld0R0b1NjaGVtYSkpXG4gICAgdXBkYXRlUmV2aWV3RHRvOiBVcGRhdGVSZXZpZXdEdG8sXG4gICkge1xuICAgIHJldHVybiB0aGlzLnJldmlld3NTZXJ2aWNlLnVwZGF0ZVJldmlldyhcbiAgICAgIHJldmlld0lkLFxuICAgICAgY2xpZW50SWQsXG4gICAgICB1cGRhdGVSZXZpZXdEdG8sXG4gICAgKTtcbiAgfVxuXG4gIEBEZWxldGUoJzppZCcpXG4gIEBIdHRwQ29kZShIdHRwU3RhdHVzLk5PX0NPTlRFTlQpXG4gIGFzeW5jIGRlbGV0ZVJldmlldyhcbiAgICBAUGFyYW0oJ2lkJykgcmV2aWV3SWQ6IHN0cmluZyxcbiAgICBAQ3VycmVudFVzZXJJZCgpIGNsaWVudElkOiBzdHJpbmcsXG4gICkge1xuICAgIHJldHVybiB0aGlzLnJldmlld3NTZXJ2aWNlLmRlbGV0ZVJldmlldyhyZXZpZXdJZCwgY2xpZW50SWQpO1xuICB9XG5cbiAgQEdldCgpXG4gIGFzeW5jIGdldFJldmlld3MoXG4gICAgQFF1ZXJ5KG5ldyBab2RWYWxpZGF0aW9uUGlwZShHZXRSZXZpZXdzRHRvU2NoZW1hKSkgcXVlcnk6IEdldFJldmlld3NEdG8sXG4gICk6IFByb21pc2U8UmV2aWV3TGlzdFJlc3BvbnNlPiB7XG4gICAgcmV0dXJuIHRoaXMucmV2aWV3c1NlcnZpY2UuZ2V0UmV2aWV3cyhxdWVyeSk7XG4gIH1cblxuICBAR2V0KCd0aGVyYXBpc3QvOnRoZXJhcGlzdElkJylcbiAgYXN5bmMgZ2V0VGhlcmFwaXN0UmV2aWV3cyhcbiAgICBAUGFyYW0oJ3RoZXJhcGlzdElkJykgdGhlcmFwaXN0SWQ6IHN0cmluZyxcbiAgICBAUXVlcnkobmV3IFpvZFZhbGlkYXRpb25QaXBlKEdldFJldmlld3NEdG9TY2hlbWEpKVxuICAgIHF1ZXJ5OiBPbWl0PEdldFJldmlld3NEdG8sICd0aGVyYXBpc3RJZCc+LFxuICApOiBQcm9taXNlPFJldmlld0xpc3RSZXNwb25zZT4ge1xuICAgIHJldHVybiB0aGlzLnJldmlld3NTZXJ2aWNlLmdldFRoZXJhcGlzdFJldmlld3ModGhlcmFwaXN0SWQsIHF1ZXJ5KTtcbiAgfVxuXG4gIEBHZXQoJ3RoZXJhcGlzdC86dGhlcmFwaXN0SWQvc3RhdHMnKVxuICBhc3luYyBnZXRUaGVyYXBpc3RSZXZpZXdTdGF0cyhAUGFyYW0oJ3RoZXJhcGlzdElkJykgdGhlcmFwaXN0SWQ6IHN0cmluZykge1xuICAgIHJldHVybiB0aGlzLnJldmlld3NTZXJ2aWNlLmdldFJldmlld1N0YXRzKHRoZXJhcGlzdElkKTtcbiAgfVxuXG4gIEBQb3N0KCc6aWQvaGVscGZ1bCcpXG4gIEBIdHRwQ29kZShIdHRwU3RhdHVzLk9LKVxuICBhc3luYyBtYXJrUmV2aWV3SGVscGZ1bChcbiAgICBAUGFyYW0oJ2lkJywgbmV3IFpvZFZhbGlkYXRpb25QaXBlKFJldmlld0lkUGFyYW1TY2hlbWEpKSByZXZpZXdJZDogc3RyaW5nLFxuICAgIEBDdXJyZW50VXNlcklkKCkgdXNlcklkOiBzdHJpbmcsXG4gICkge1xuICAgIHJldHVybiB0aGlzLnJldmlld3NTZXJ2aWNlLm1hcmtSZXZpZXdIZWxwZnVsKHJldmlld0lkLCB1c2VySWQpO1xuICB9XG5cbiAgLy8gQWRtaW4vTW9kZXJhdG9yIGVuZHBvaW50c1xuICBAUG9zdCgnOmlkL21vZGVyYXRlJylcbiAgQEh0dHBDb2RlKEh0dHBTdGF0dXMuT0spXG4gIGFzeW5jIG1vZGVyYXRlUmV2aWV3KFxuICAgIEBQYXJhbSgnaWQnLCBuZXcgWm9kVmFsaWRhdGlvblBpcGUoUmV2aWV3SWRQYXJhbVNjaGVtYSkpIHJldmlld0lkOiBzdHJpbmcsXG4gICAgQEN1cnJlbnRVc2VySWQoKSBtb2RlcmF0b3JJZDogc3RyaW5nLFxuICAgIEBDdXJyZW50VXNlclJvbGUoKSB1c2VyUm9sZTogc3RyaW5nLFxuICAgIEBCb2R5KG5ldyBab2RWYWxpZGF0aW9uUGlwZShNb2RlcmF0ZVJldmlld0R0b1NjaGVtYSkpXG4gICAgbW9kZXJhdGVSZXZpZXdEdG86IE1vZGVyYXRlUmV2aWV3RHRvLFxuICApIHtcbiAgICAvLyBPbmx5IGFsbG93IG1vZGVyYXRvcnMgYW5kIGFkbWlucyB0byBtb2RlcmF0ZSByZXZpZXdzXG4gICAgaWYgKCFbJ21vZGVyYXRvcicsICdhZG1pbiddLmluY2x1ZGVzKHVzZXJSb2xlKSkge1xuICAgICAgdGhyb3cgbmV3IEZvcmJpZGRlbkV4Y2VwdGlvbignSW5zdWZmaWNpZW50IHBlcm1pc3Npb25zJyk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXMucmV2aWV3c1NlcnZpY2UubW9kZXJhdGVSZXZpZXcoXG4gICAgICByZXZpZXdJZCxcbiAgICAgIG1vZGVyYXRvcklkLFxuICAgICAgbW9kZXJhdGVSZXZpZXdEdG8sXG4gICAgKTtcbiAgfVxuXG4gIEBHZXQoJ3BlbmRpbmcnKVxuICBhc3luYyBnZXRQZW5kaW5nUmV2aWV3cyhcbiAgICBAQ3VycmVudFVzZXJSb2xlKCkgdXNlclJvbGU6IHN0cmluZyxcbiAgICBAUXVlcnkobmV3IFpvZFZhbGlkYXRpb25QaXBlKEdldFJldmlld3NEdG9TY2hlbWEpKSBxdWVyeTogR2V0UmV2aWV3c0R0byxcbiAgKTogUHJvbWlzZTxSZXZpZXdMaXN0UmVzcG9uc2U+IHtcbiAgICAvLyBPbmx5IGFsbG93IG1vZGVyYXRvcnMgYW5kIGFkbWlucyB0byB2aWV3IHBlbmRpbmcgcmV2aWV3c1xuICAgIGlmICghWydtb2RlcmF0b3InLCAnYWRtaW4nXS5pbmNsdWRlcyh1c2VyUm9sZSkpIHtcbiAgICAgIHRocm93IG5ldyBGb3JiaWRkZW5FeGNlcHRpb24oJ0luc3VmZmljaWVudCBwZXJtaXNzaW9ucycpO1xuICAgIH1cblxuICAgIHJldHVybiB0aGlzLnJldmlld3NTZXJ2aWNlLmdldFJldmlld3Moe1xuICAgICAgLi4ucXVlcnksXG4gICAgICBzdGF0dXM6ICdwZW5kaW5nJyxcbiAgICB9KTtcbiAgfVxufVxuIl0sInZlcnNpb24iOjN9