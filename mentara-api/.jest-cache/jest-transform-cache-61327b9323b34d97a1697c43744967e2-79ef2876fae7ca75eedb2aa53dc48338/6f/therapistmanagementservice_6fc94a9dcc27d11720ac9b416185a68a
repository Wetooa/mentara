774cb572e4b89db18d62e1bb942c20ed
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
exports.TherapistManagementService = void 0;
const common_1 = require("@nestjs/common");
const prisma_client_provider_1 = require("../providers/prisma-client.provider");
const library_1 = require("@prisma/client/runtime/library");
let TherapistManagementService = class TherapistManagementService {
    prisma;
    constructor(prisma) {
        this.prisma = prisma;
    }
    calculateYearsOfExperience(startDate) {
        const now = new Date();
        let years = now.getFullYear() - startDate.getFullYear();
        if (now.getMonth() < startDate.getMonth() ||
            (now.getMonth() === startDate.getMonth() &&
                now.getDate() < startDate.getDate())) {
            years--;
        }
        return years;
    }
    async getTherapistProfile(userId) {
        try {
            const therapist = await this.prisma.therapist.findUniqueOrThrow({
                where: { userId },
                include: {
                    user: true,
                    therapistAvailabilities: true,
                    worksheets: true,
                    meetings: true,
                    assignedClients: true,
                },
            });
            return {
                ...therapist,
                treatmentSuccessRates: therapist.treatmentSuccessRates || {},
                hourlyRate: therapist.hourlyRate,
            };
        }
        catch (error) {
            console.error('Error retrieving therapist profile:', error instanceof Error ? error.message : error);
            throw new common_1.InternalServerErrorException('Failed to retrieve therapist profile');
        }
    }
    async updateTherapistProfile(userId, data) {
        try {
            // Update therapist profile data
            const therapistData = {};
            if (data.mobile !== undefined)
                therapistData.mobile = data.mobile;
            if (data.province !== undefined)
                therapistData.province = data.province;
            if (data.providerType !== undefined)
                therapistData.providerType = data.providerType;
            if (data.professionalLicenseType !== undefined)
                therapistData.professionalLicenseType = data.professionalLicenseType;
            if (data.isPRCLicensed !== undefined)
                therapistData.isPRCLicensed = data.isPRCLicensed;
            if (data.prcLicenseNumber !== undefined)
                therapistData.prcLicenseNumber = data.prcLicenseNumber;
            if (data.expirationDateOfLicense !== undefined)
                therapistData.expirationDateOfLicense = data.expirationDateOfLicense;
            if (data.practiceStartDate !== undefined)
                therapistData.practiceStartDate = data.practiceStartDate;
            if (data.areasOfExpertise !== undefined)
                therapistData.areasOfExpertise = data.areasOfExpertise;
            if (data.assessmentTools !== undefined)
                therapistData.assessmentTools = data.assessmentTools;
            if (data.therapeuticApproachesUsedList !== undefined)
                therapistData.therapeuticApproachesUsedList =
                    data.therapeuticApproachesUsedList;
            if (data.languagesOffered !== undefined)
                therapistData.languagesOffered = data.languagesOffered;
            if (data.providedOnlineTherapyBefore !== undefined)
                therapistData.providedOnlineTherapyBefore =
                    data.providedOnlineTherapyBefore;
            if (data.comfortableUsingVideoConferencing !== undefined)
                therapistData.comfortableUsingVideoConferencing =
                    data.comfortableUsingVideoConferencing;
            if (data.preferredSessionLength !== undefined)
                therapistData.preferredSessionLength = data.preferredSessionLength;
            if (data.privateConfidentialSpace !== undefined)
                therapistData.privateConfidentialSpace = data.privateConfidentialSpace;
            if (data.compliesWithDataPrivacyAct !== undefined)
                therapistData.compliesWithDataPrivacyAct =
                    data.compliesWithDataPrivacyAct;
            if (data.professionalLiabilityInsurance !== undefined)
                therapistData.professionalLiabilityInsurance =
                    data.professionalLiabilityInsurance;
            if (data.complaintsOrDisciplinaryActions !== undefined)
                therapistData.complaintsOrDisciplinaryActions =
                    data.complaintsOrDisciplinaryActions;
            if (data.willingToAbideByPlatformGuidelines !== undefined)
                therapistData.willingToAbideByPlatformGuidelines =
                    data.willingToAbideByPlatformGuidelines;
            if (data.expertise !== undefined)
                therapistData.expertise = data.expertise;
            if (data.approaches !== undefined)
                therapistData.approaches = data.approaches;
            if (data.languages !== undefined)
                therapistData.languages = data.languages;
            if (data.illnessSpecializations !== undefined)
                therapistData.illnessSpecializations = data.illnessSpecializations;
            if (data.acceptTypes !== undefined)
                therapistData.acceptTypes = data.acceptTypes;
            if (data.treatmentSuccessRates !== undefined)
                therapistData.treatmentSuccessRates = data.treatmentSuccessRates;
            if (data.sessionLength !== undefined)
                therapistData.sessionLength = data.sessionLength;
            if (data.hourlyRate !== undefined)
                therapistData.hourlyRate = new library_1.Decimal(data.hourlyRate);
            const updatedTherapist = await this.prisma.therapist.update({
                where: { userId },
                data: therapistData,
                include: {
                    user: true,
                },
            });
            return {
                ...updatedTherapist,
                treatmentSuccessRates: updatedTherapist.treatmentSuccessRates || {},
                hourlyRate: updatedTherapist.hourlyRate,
            };
        }
        catch (error) {
            console.error('Error updating therapist profile:', error instanceof Error ? error.message : error);
            throw new common_1.InternalServerErrorException('Failed to update therapist profile');
        }
    }
    async getAssignedPatients(therapistId) {
        try {
            const therapist = await this.prisma.therapist.findUniqueOrThrow({
                where: { userId: therapistId },
            });
            // Find all clients assigned to this therapist
            const assignedClients = await this.prisma.clientTherapist.findMany({
                where: { therapistId: therapist.userId, status: 'active' },
                include: { client: { include: { user: true } } },
            });
            return assignedClients.map((ct) => ({
                ...ct.client,
                user: ct.client.user,
            }));
        }
        catch (error) {
            console.error('Error retrieving assigned patients:', error instanceof Error ? error.message : error);
            throw new common_1.InternalServerErrorException('Failed to retrieve assigned patients');
        }
    }
    async getAllClients(therapistId) {
        try {
            // Find all clients assigned to this therapist
            const assignedClients = await this.prisma.clientTherapist.findMany({
                where: { therapistId: therapistId, status: 'active' },
                include: { client: { include: { user: true } } },
            });
            return assignedClients.map((ct) => ({
                ...ct.client,
            }));
        }
        catch (error) {
            console.error('Error retrieving all clients:', error instanceof Error ? error.message : error);
            throw new common_1.InternalServerErrorException('Failed to retrieve all clients');
        }
    }
    async getClientById(therapistId, clientId) {
        try {
            // Find the specific client assigned to this therapist
            const assignedClient = await this.prisma.clientTherapist.findFirst({
                where: { therapistId: therapistId, clientId: clientId },
                include: { client: { include: { user: true } } },
            });
            if (!assignedClient) {
                throw new common_1.NotFoundException('Client not found');
            }
            return assignedClient.client;
        }
        catch (error) {
            console.error('Error retrieving client by ID:', error instanceof Error ? error.message : error);
            throw new common_1.InternalServerErrorException('Failed to retrieve client by ID');
        }
    }
    async getProfile(therapistId) {
        try {
            const therapist = await this.prisma.therapist.findUniqueOrThrow({
                where: { userId: therapistId },
                include: {
                    user: true,
                },
            });
            return {
                ...therapist,
                treatmentSuccessRates: therapist.treatmentSuccessRates || {},
                hourlyRate: therapist.hourlyRate,
            };
        }
        catch (error) {
            console.error('Error retrieving therapist profile:', error instanceof Error ? error.message : error);
            throw new common_1.InternalServerErrorException('Failed to retrieve therapist profile');
        }
    }
    async updateProfile(therapistId, data) {
        try {
            const updatedTherapist = await this.prisma.therapist.update({
                where: { userId: therapistId },
                data,
                include: {
                    user: true,
                },
            });
            return {
                ...updatedTherapist,
                treatmentSuccessRates: updatedTherapist.treatmentSuccessRates || {},
                hourlyRate: updatedTherapist.hourlyRate,
            };
        }
        catch (error) {
            console.error('Error updating therapist profile:', error instanceof Error ? error.message : error);
            throw new common_1.InternalServerErrorException('Failed to update therapist profile');
        }
    }
};
exports.TherapistManagementService = TherapistManagementService;
exports.TherapistManagementService = TherapistManagementService = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [typeof (_a = typeof prisma_client_provider_1.PrismaService !== "undefined" && prisma_client_provider_1.PrismaService) === "function" ? _a : Object])
], TherapistManagementService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL3RoZXJhcGlzdC90aGVyYXBpc3QtbWFuYWdlbWVudC5zZXJ2aWNlLnRzIiwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7QUFBQSwyQ0FJd0I7QUFDeEIsZ0ZBQW9FO0FBRXBFLDREQUF5RDtBQThCbEQsSUFBTSwwQkFBMEIsR0FBaEMsTUFBTSwwQkFBMEI7SUFDUjtJQUE3QixZQUE2QixNQUFxQjtRQUFyQixXQUFNLEdBQU4sTUFBTSxDQUFlO0lBQUcsQ0FBQztJQUU5QywwQkFBMEIsQ0FBQyxTQUFlO1FBQ2hELE1BQU0sR0FBRyxHQUFHLElBQUksSUFBSSxFQUFFLENBQUM7UUFDdkIsSUFBSSxLQUFLLEdBQUcsR0FBRyxDQUFDLFdBQVcsRUFBRSxHQUFHLFNBQVMsQ0FBQyxXQUFXLEVBQUUsQ0FBQztRQUN4RCxJQUNFLEdBQUcsQ0FBQyxRQUFRLEVBQUUsR0FBRyxTQUFTLENBQUMsUUFBUSxFQUFFO1lBQ3JDLENBQUMsR0FBRyxDQUFDLFFBQVEsRUFBRSxLQUFLLFNBQVMsQ0FBQyxRQUFRLEVBQUU7Z0JBQ3RDLEdBQUcsQ0FBQyxPQUFPLEVBQUUsR0FBRyxTQUFTLENBQUMsT0FBTyxFQUFFLENBQUMsRUFDdEMsQ0FBQztZQUNELEtBQUssRUFBRSxDQUFDO1FBQ1YsQ0FBQztRQUNELE9BQU8sS0FBSyxDQUFDO0lBQ2YsQ0FBQztJQUVELEtBQUssQ0FBQyxtQkFBbUIsQ0FBQyxNQUFjO1FBQ3RDLElBQUksQ0FBQztZQUNILE1BQU0sU0FBUyxHQUFHLE1BQU0sSUFBSSxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUMsaUJBQWlCLENBQUM7Z0JBQzlELEtBQUssRUFBRSxFQUFFLE1BQU0sRUFBRTtnQkFDakIsT0FBTyxFQUFFO29CQUNQLElBQUksRUFBRSxJQUFJO29CQUNWLHVCQUF1QixFQUFFLElBQUk7b0JBQzdCLFVBQVUsRUFBRSxJQUFJO29CQUNoQixRQUFRLEVBQUUsSUFBSTtv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Q2xCLGdCQUFnQixDQUFDLHFCQUE2QyxJQUFJLEVBQUU7Z0JBQ3ZFLFVBQVUsRUFBRSxnQkFBZ0IsQ0FBQyxVQUFVO2FBQ3hDLENBQUM7UUFDSixDQUFDO1FBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztZQUNmLE9BQU8sQ0FBQyxLQUFLLENBQ1gsbUNBQW1DLEVBQ25DLEtBQUssWUFBWSxLQUFLLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FDL0MsQ0FBQztZQUNGLE1BQU0sSUFBSSxxQ0FBNEIsQ0FDcEMsb0NBQW9DLENBQ3JDLENBQUM7UUFDSixDQUFDO0lBQ0gsQ0FBQztDQUNGLENBQUE7QUFwUVksZ0VBQTBCO3FDQUExQiwwQkFBMEI7SUFEdEMsSUFBQSxtQkFBVSxHQUFFO3lEQUUwQixzQ0FBYSxvQkFBYixzQ0FBYTtHQUR2QywwQkFBMEIsQ0FvUXRDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9ob21lL3dldG9vYS9Eb2N1bWVudHMvY29kZS9wcm9qZWN0cy9tZW50YXJhL21lbnRhcmEtYXBpL3NyYy90aGVyYXBpc3QvdGhlcmFwaXN0LW1hbmFnZW1lbnQuc2VydmljZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBJbmplY3RhYmxlLFxuICBOb3RGb3VuZEV4Y2VwdGlvbixcbiAgSW50ZXJuYWxTZXJ2ZXJFcnJvckV4Y2VwdGlvbixcbn0gZnJvbSAnQG5lc3Rqcy9jb21tb24nO1xuaW1wb3J0IHsgUHJpc21hU2VydmljZSB9IGZyb20gJy4uL3Byb3ZpZGVycy9wcmlzbWEtY2xpZW50LnByb3ZpZGVyJztcbmltcG9ydCB7IFByaXNtYSB9IGZyb20gJ0BwcmlzbWEvY2xpZW50JztcbmltcG9ydCB7IERlY2ltYWwgfSBmcm9tICdAcHJpc21hL2NsaWVudC9ydW50aW1lL2xpYnJhcnknO1xuLy8gUmVtb3ZlZCBpbXBvcnQgLSB1c2luZyBsb2NhbCB0eXBlcyBpbnN0ZWFkXG5pbnRlcmZhY2UgVGhlcmFwaXN0UmVzcG9uc2Uge1xuICBpZDogc3RyaW5nO1xuICBmaXJzdE5hbWU6IHN0cmluZztcbiAgbGFzdE5hbWU6IHN0cmluZztcbiAgc3BlY2lhbHRpZXM6IHN0cmluZ1tdO1xuICBpc0FjdGl2ZTogYm9vbGVhbjtcbn1cblxuaW50ZXJmYWNlIENsaWVudFJlc3BvbnNlIHtcbiAgaWQ6IHN0cmluZztcbiAgZmlyc3ROYW1lOiBzdHJpbmc7XG4gIGxhc3ROYW1lOiBzdHJpbmc7XG59XG5cbmludGVyZmFjZSBUaGVyYXBpc3RVcGRhdGVEdG8ge1xuICBzcGVjaWFsdGllcz86IHN0cmluZ1tdO1xuICBpc0FjdGl2ZT86IGJvb2xlYW47XG4gIG1vYmlsZT86IHN0cmluZztcbiAgcHJvdmluY2U/OiBzdHJpbmc7XG4gIGhvdXJseVJhdGU/OiBhbnk7XG4gIGFyZWFzT2ZFeHBlcnRpc2U/OiBzdHJpbmdbXTtcbiAgbGFuZ3VhZ2VzT2ZmZXJlZD86IHN0cmluZ1tdO1xuICBwcmVmZXJyZWRTZXNzaW9uTGVuZ3RoPzogbnVtYmVyW107XG4gIC8vIEFsbG93IGFueSBvdGhlciBwcm9wZXJ0aWVzXG4gIFtrZXk6IHN0cmluZ106IGFueTtcbn1cblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIFRoZXJhcGlzdE1hbmFnZW1lbnRTZXJ2aWNlIHtcbiAgY29uc3RydWN0b3IocHJpdmF0ZSByZWFkb25seSBwcmlzbWE6IFByaXNtYVNlcnZpY2UpIHt9XG5cbiAgcHJpdmF0ZSBjYWxjdWxhdGVZZWFyc09mRXhwZXJpZW5jZShzdGFydERhdGU6IERhdGUpOiBudW1iZXIge1xuICAgIGNvbnN0IG5vdyA9IG5ldyBEYXRlKCk7XG4gICAgbGV0IHllYXJzID0gbm93LmdldEZ1bGxZZWFyKCkgLSBzdGFydERhdGUuZ2V0RnVsbFllYXIoKTtcbiAgICBpZiAoXG4gICAgICBub3cuZ2V0TW9udGgoKSA8IHN0YXJ0RGF0ZS5nZXRNb250aCgpIHx8XG4gICAgICAobm93LmdldE1vbnRoKCkgPT09IHN0YXJ0RGF0ZS5nZXRNb250aCgpICYmXG4gICAgICAgIG5vdy5nZXREYXRlKCkgPCBzdGFydERhdGUuZ2V0RGF0ZSgpKVxuICAgICkge1xuICAgICAgeWVhcnMtLTtcbiAgICB9XG4gICAgcmV0dXJuIHllYXJzO1xuICB9XG5cbiAgYXN5bmMgZ2V0VGhlcmFwaXN0UHJvZmlsZSh1c2VySWQ6IHN0cmluZyk6IFByb21pc2U8YW55PiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHRoZXJhcGlzdCA9IGF3YWl0IHRoaXMucHJpc21hLnRoZXJhcGlzdC5maW5kVW5pcXVlT3JUaHJvdyh7XG4gICAgICAgIHdoZXJlOiB7IHVzZXJJZCB9LFxuICAgICAgICBpbmNsdWRlOiB7XG4gICAgICAgICAgdXNlcjogdHJ1ZSxcbiAgICAgICAgICB0aGVyYXBpc3RBdmFpbGFiaWxpdGllczogdHJ1ZSxcbiAgICAgICAgICB3b3Jrc2hlZXRzOiB0cnVlLFxuICAgICAgICAgIG1lZXRpbmdzOiB0cnVlLFxuICAgICAgICAgIGFzc2lnbmVkQ2xpZW50czogdHJ1ZSxcbiAgICAgICAgfSxcbiAgICAgIH0pO1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgLi4udGhlcmFwaXN0LFxuICAgICAgICB0cmVhdG1lbnRTdWNjZXNzUmF0ZXM6XG4gICAgICAgICAgKHRoZXJhcGlzdC50cmVhdG1lbnRTdWNjZXNzUmF0ZXMgYXMgUmVjb3JkPHN0cmluZywgYW55PikgfHwge30sXG4gICAgICAgIGhvdXJseVJhdGU6IHRoZXJhcGlzdC5ob3VybHlSYXRlLFxuICAgICAgfTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc29sZS5lcnJvcihcbiAgICAgICAgJ0Vycm9yIHJldHJpZXZpbmcgdGhlcmFwaXN0IHByb2ZpbGU6JyxcbiAgICAgICAgZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiBlcnJvcixcbiAgICAgICk7XG4gICAgICB0aHJvdyBuZXcgSW50ZXJuYWxTZXJ2ZXJFcnJvckV4Y2VwdGlvbihcbiAgICAgICAgJ0ZhaWxlZCB0byByZXRyaWV2ZSB0aGVyYXBpc3QgcHJvZmlsZScsXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIHVwZGF0ZVRoZXJhcGlzdFByb2ZpbGUoXG4gICAgdXNlcklkOiBzdHJpbmcsXG4gICAgZGF0YTogVGhlcmFwaXN0VXBkYXRlRHRvLFxuICApOiBQcm9taXNlPGFueT4ge1xuICAgIHRyeSB7XG4gICAgICAvLyBVcGRhdGUgdGhlcmFwaXN0IHByb2ZpbGUgZGF0YVxuICAgICAgY29uc3QgdGhlcmFwaXN0RGF0YTogYW55ID0ge307XG4gICAgICBpZiAoZGF0YS5tb2JpbGUgIT09IHVuZGVmaW5lZCkgdGhlcmFwaXN0RGF0YS5tb2JpbGUgPSBkYXRhLm1vYmlsZTtcbiAgICAgIGlmIChkYXRhLnByb3ZpbmNlICE9PSB1bmRlZmluZWQpIHRoZXJhcGlzdERhdGEucHJvdmluY2UgPSBkYXRhLnByb3ZpbmNlO1xuICAgICAgaWYgKGRhdGEucHJvdmlkZXJUeXBlICE9PSB1bmRlZmluZWQpXG4gICAgICAgIHRoZXJhcGlzdERhdGEucHJvdmlkZXJUeXBlID0gZGF0YS5wcm92aWRlclR5cGU7XG4gICAgICBpZiAoZGF0YS5wcm9mZXNzaW9uYWxMaWNlbnNlVHlwZSAhPT0gdW5kZWZpbmVkKVxuICAgICAgICB0aGVyYXBpc3REYXRhLnByb2Zlc3Npb25hbExpY2Vuc2VUeXBlID0gZGF0YS5wcm9mZXNzaW9uYWxMaWNlbnNlVHlwZTtcbiAgICAgIGlmIChkYXRhLmlzUFJDTGljZW5zZWQgIT09IHVuZGVmaW5lZClcbiAgICAgICAgdGhlcmFwaXN0RGF0YS5pc1BSQ0xpY2Vuc2VkID0gZGF0YS5pc1BSQ0xpY2Vuc2VkO1xuICAgICAgaWYgKGRhdGEucHJjTGljZW5zZU51bWJlciAhPT0gdW5kZWZpbmVkKVxuICAgICAgICB0aGVyYXBpc3REYXRhLnByY0xpY2Vuc2VOdW1iZXIgPSBkYXRhLnByY0xpY2Vuc2VOdW1iZXI7XG4gICAgICBpZiAoZGF0YS5leHBpcmF0aW9uRGF0ZU9mTGljZW5zZSAhPT0gdW5kZWZpbmVkKVxuICAgICAgICB0aGVyYXBpc3REYXRhLmV4cGlyYXRpb25EYXRlT2ZMaWNlbnNlID0gZGF0YS5leHBpcmF0aW9uRGF0ZU9mTGljZW5zZTtcbiAgICAgIGlmIChkYXRhLnByYWN0aWNlU3RhcnREYXRlICE9PSB1bmRlZmluZWQpXG4gICAgICAgIHRoZXJhcGlzdERhdGEucHJhY3RpY2VTdGFydERhdGUgPSBkYXRhLnByYWN0aWNlU3RhcnREYXRlO1xuICAgICAgaWYgKGRhdGEuYXJlYXNPZkV4cGVydGlzZSAhPT0gdW5kZWZpbmVkKVxuICAgICAgICB0aGVyYXBpc3REYXRhLmFyZWFzT2ZFeHBlcnRpc2UgPSBkYXRhLmFyZWFzT2ZFeHBlcnRpc2U7XG4gICAgICBpZiAoZGF0YS5hc3Nlc3NtZW50VG9vbHMgIT09IHVuZGVmaW5lZClcbiAgICAgICAgdGhlcmFwaXN0RGF0YS5hc3Nlc3NtZW50VG9vbHMgPSBkYXRhLmFzc2Vzc21lbnRUb29scztcbiAgICAgIGlmIChkYXRhLnRoZXJhcGV1dGljQXBwcm9hY2hlc1VzZWRMaXN0ICE9PSB1bmRlZmluZWQpXG4gICAgICAgIHRoZXJhcGlzdERhdGEudGhlcmFwZXV0aWNBcHByb2FjaGVzVXNlZExpc3QgPVxuICAgICAgICAgIGRhdGEudGhlcmFwZXV0aWNBcHByb2FjaGVzVXNlZExpc3Q7XG4gICAgICBpZiAoZGF0YS5sYW5ndWFnZXNPZmZlcmVkICE9PSB1bmRlZmluZWQpXG4gICAgICAgIHRoZXJhcGlzdERhdGEubGFuZ3VhZ2VzT2ZmZXJlZCA9IGRhdGEubGFuZ3VhZ2VzT2ZmZXJlZDtcbiAgICAgIGlmIChkYXRhLnByb3ZpZGVkT25saW5lVGhlcmFweUJlZm9yZSAhPT0gdW5kZWZpbmVkKVxuICAgICAgICB0aGVyYXBpc3REYXRhLnByb3ZpZGVkT25saW5lVGhlcmFweUJlZm9yZSA9XG4gICAgICAgICAgZGF0YS5wcm92aWRlZE9ubGluZVRoZXJhcHlCZWZvcmU7XG4gICAgICBpZiAoZGF0YS5jb21mb3J0YWJsZVVzaW5nVmlkZW9Db25mZXJlbmNpbmcgIT09IHVuZGVmaW5lZClcbiAgICAgICAgdGhlcmFwaXN0RGF0YS5jb21mb3J0YWJsZVVzaW5nVmlkZW9Db25mZXJlbmNpbmcgPVxuICAgICAgICAgIGRhdGEuY29tZm9ydGFibGVVc2luZ1ZpZGVvQ29uZmVyZW5jaW5nO1xuICAgICAgaWYgKGRhdGEucHJlZmVycmVkU2Vzc2lvbkxlbmd0aCAhPT0gdW5kZWZpbmVkKVxuICAgICAgICB0aGVyYXBpc3REYXRhLnByZWZlcnJlZFNlc3Npb25MZW5ndGggPSBkYXRhLnByZWZlcnJlZFNlc3Npb25MZW5ndGg7XG4gICAgICBpZiAoZGF0YS5wcml2YXRlQ29uZmlkZW50aWFsU3BhY2UgIT09IHVuZGVmaW5lZClcbiAgICAgICAgdGhlcmFwaXN0RGF0YS5wcml2YXRlQ29uZmlkZW50aWFsU3BhY2UgPSBkYXRhLnByaXZhdGVDb25maWRlbnRpYWxTcGFjZTtcbiAgICAgIGlmIChkYXRhLmNvbXBsaWVzV2l0aERhdGFQcml2YWN5QWN0ICE9PSB1bmRlZmluZWQpXG4gICAgICAgIHRoZXJhcGlzdERhdGEuY29tcGxpZXNXaXRoRGF0YVByaXZhY3lBY3QgPVxuICAgICAgICAgIGRhdGEuY29tcGxpZXNXaXRoRGF0YVByaXZhY3lBY3Q7XG4gICAgICBpZiAoZGF0YS5wcm9mZXNzaW9uYWxMaWFiaWxpdHlJbnN1cmFuY2UgIT09IHVuZGVmaW5lZClcbiAgICAgICAgdGhlcmFwaXN0RGF0YS5wcm9mZXNzaW9uYWxMaWFiaWxpdHlJbnN1cmFuY2UgPVxuICAgICAgICAgIGRhdGEucHJvZmVzc2lvbmFsTGlhYmlsaXR5SW5zdXJhbmNlO1xuICAgICAgaWYgKGRhdGEuY29tcGxhaW50c09yRGlzY2lwbGluYXJ5QWN0aW9ucyAhPT0gdW5kZWZpbmVkKVxuICAgICAgICB0aGVyYXBpc3REYXRhLmNvbXBsYWludHNPckRpc2NpcGxpbmFyeUFjdGlvbnMgPVxuICAgICAgICAgIGRhdGEuY29tcGxhaW50c09yRGlzY2lwbGluYXJ5QWN0aW9ucztcbiAgICAgIGlmIChkYXRhLndpbGxpbmdUb0FiaWRlQnlQbGF0Zm9ybUd1aWRlbGluZXMgIT09IHVuZGVmaW5lZClcbiAgICAgICAgdGhlcmFwaXN0RGF0YS53aWxsaW5nVG9BYmlkZUJ5UGxhdGZvcm1HdWlkZWxpbmVzID1cbiAgICAgICAgICBkYXRhLndpbGxpbmdUb0FiaWRlQnlQbGF0Zm9ybUd1aWRlbGluZXM7XG4gICAgICBpZiAoZGF0YS5leHBlcnRpc2UgIT09IHVuZGVmaW5lZClcbiAgICAgICAgdGhlcmFwaXN0RGF0YS5leHBlcnRpc2UgPSBkYXRhLmV4cGVydGlzZTtcbiAgICAgIGlmIChkYXRhLmFwcHJvYWNoZXMgIT09IHVuZGVmaW5lZClcbiAgICAgICAgdGhlcmFwaXN0RGF0YS5hcHByb2FjaGVzID0gZGF0YS5hcHByb2FjaGVzO1xuICAgICAgaWYgKGRhdGEubGFuZ3VhZ2VzICE9PSB1bmRlZmluZWQpXG4gICAgICAgIHRoZXJhcGlzdERhdGEubGFuZ3VhZ2VzID0gZGF0YS5sYW5ndWFnZXM7XG4gICAgICBpZiAoZGF0YS5pbGxuZXNzU3BlY2lhbGl6YXRpb25zICE9PSB1bmRlZmluZWQpXG4gICAgICAgIHRoZXJhcGlzdERhdGEuaWxsbmVzc1NwZWNpYWxpemF0aW9ucyA9IGRhdGEuaWxsbmVzc1NwZWNpYWxpemF0aW9ucztcbiAgICAgIGlmIChkYXRhLmFjY2VwdFR5cGVzICE9PSB1bmRlZmluZWQpXG4gICAgICAgIHRoZXJhcGlzdERhdGEuYWNjZXB0VHlwZXMgPSBkYXRhLmFjY2VwdFR5cGVzO1xuICAgICAgaWYgKGRhdGEudHJlYXRtZW50U3VjY2Vzc1JhdGVzICE9PSB1bmRlZmluZWQpXG4gICAgICAgIHRoZXJhcGlzdERhdGEudHJlYXRtZW50U3VjY2Vzc1JhdGVzID0gZGF0YS50cmVhdG1lbnRTdWNjZXNzUmF0ZXM7XG4gICAgICBpZiAoZGF0YS5zZXNzaW9uTGVuZ3RoICE9PSB1bmRlZmluZWQpXG4gICAgICAgIHRoZXJhcGlzdERhdGEuc2Vzc2lvbkxlbmd0aCA9IGRhdGEuc2Vzc2lvbkxlbmd0aDtcbiAgICAgIGlmIChkYXRhLmhvdXJseVJhdGUgIT09IHVuZGVmaW5lZClcbiAgICAgICAgdGhlcmFwaXN0RGF0YS5ob3VybHlSYXRlID0gbmV3IERlY2ltYWwoZGF0YS5ob3VybHlSYXRlKTtcblxuICAgICAgY29uc3QgdXBkYXRlZFRoZXJhcGlzdCA9IGF3YWl0IHRoaXMucHJpc21hLnRoZXJhcGlzdC51cGRhdGUoe1xuICAgICAgICB3aGVyZTogeyB1c2VySWQgfSxcbiAgICAgICAgZGF0YTogdGhlcmFwaXN0RGF0YSxcbiAgICAgICAgaW5jbHVkZToge1xuICAgICAgICAgIHVzZXI6IHRydWUsXG4gICAgICAgIH0sXG4gICAgICB9KTtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIC4uLnVwZGF0ZWRUaGVyYXBpc3QsXG4gICAgICAgIHRyZWF0bWVudFN1Y2Nlc3NSYXRlczpcbiAgICAgICAgICAodXBkYXRlZFRoZXJhcGlzdC50cmVhdG1lbnRTdWNjZXNzUmF0ZXMgYXMgUmVjb3JkPHN0cmluZywgYW55PikgfHwge30sXG4gICAgICAgIGhvdXJseVJhdGU6IHVwZGF0ZWRUaGVyYXBpc3QuaG91cmx5UmF0ZSxcbiAgICAgIH07XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoXG4gICAgICAgICdFcnJvciB1cGRhdGluZyB0aGVyYXBpc3QgcHJvZmlsZTonLFxuICAgICAgICBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6IGVycm9yLFxuICAgICAgKTtcbiAgICAgIHRocm93IG5ldyBJbnRlcm5hbFNlcnZlckVycm9yRXhjZXB0aW9uKFxuICAgICAgICAnRmFpbGVkIHRvIHVwZGF0ZSB0aGVyYXBpc3QgcHJvZmlsZScsXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGdldEFzc2lnbmVkUGF0aWVudHModGhlcmFwaXN0SWQ6IHN0cmluZyk6IFByb21pc2U8YW55W10+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgdGhlcmFwaXN0ID0gYXdhaXQgdGhpcy5wcmlzbWEudGhlcmFwaXN0LmZpbmRVbmlxdWVPclRocm93KHtcbiAgICAgICAgd2hlcmU6IHsgdXNlcklkOiB0aGVyYXBpc3RJZCB9LFxuICAgICAgfSk7XG5cbiAgICAgIC8vIEZpbmQgYWxsIGNsaWVudHMgYXNzaWduZWQgdG8gdGhpcyB0aGVyYXBpc3RcbiAgICAgIGNvbnN0IGFzc2lnbmVkQ2xpZW50cyA9IGF3YWl0IHRoaXMucHJpc21hLmNsaWVudFRoZXJhcGlzdC5maW5kTWFueSh7XG4gICAgICAgIHdoZXJlOiB7IHRoZXJhcGlzdElkOiB0aGVyYXBpc3QudXNlcklkLCBzdGF0dXM6ICdhY3RpdmUnIH0sXG4gICAgICAgIGluY2x1ZGU6IHsgY2xpZW50OiB7IGluY2x1ZGU6IHsgdXNlcjogdHJ1ZSB9IH0gfSxcbiAgICAgIH0pO1xuXG4gICAgICByZXR1cm4gYXNzaWduZWRDbGllbnRzLm1hcCgoY3QpID0+ICh7XG4gICAgICAgIC4uLmN0LmNsaWVudCxcbiAgICAgICAgdXNlcjogY3QuY2xpZW50LnVzZXIsXG4gICAgICB9KSk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoXG4gICAgICAgICdFcnJvciByZXRyaWV2aW5nIGFzc2lnbmVkIHBhdGllbnRzOicsXG4gICAgICAgIGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogZXJyb3IsXG4gICAgICApO1xuXG4gICAgICB0aHJvdyBuZXcgSW50ZXJuYWxTZXJ2ZXJFcnJvckV4Y2VwdGlvbihcbiAgICAgICAgJ0ZhaWxlZCB0byByZXRyaWV2ZSBhc3NpZ25lZCBwYXRpZW50cycsXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGdldEFsbENsaWVudHModGhlcmFwaXN0SWQ6IHN0cmluZyk6IFByb21pc2U8YW55W10+IHtcbiAgICB0cnkge1xuICAgICAgLy8gRmluZCBhbGwgY2xpZW50cyBhc3NpZ25lZCB0byB0aGlzIHRoZXJhcGlzdFxuICAgICAgY29uc3QgYXNzaWduZWRDbGllbnRzID0gYXdhaXQgdGhpcy5wcmlzbWEuY2xpZW50VGhlcmFwaXN0LmZpbmRNYW55KHtcbiAgICAgICAgd2hlcmU6IHsgdGhlcmFwaXN0SWQ6IHRoZXJhcGlzdElkLCBzdGF0dXM6ICdhY3RpdmUnIH0sXG4gICAgICAgIGluY2x1ZGU6IHsgY2xpZW50OiB7IGluY2x1ZGU6IHsgdXNlcjogdHJ1ZSB9IH0gfSxcbiAgICAgIH0pO1xuXG4gICAgICByZXR1cm4gYXNzaWduZWRDbGllbnRzLm1hcCgoY3QpID0+ICh7XG4gICAgICAgIC4uLmN0LmNsaWVudCxcbiAgICAgIH0pKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc29sZS5lcnJvcihcbiAgICAgICAgJ0Vycm9yIHJldHJpZXZpbmcgYWxsIGNsaWVudHM6JyxcbiAgICAgICAgZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiBlcnJvcixcbiAgICAgICk7XG4gICAgICB0aHJvdyBuZXcgSW50ZXJuYWxTZXJ2ZXJFcnJvckV4Y2VwdGlvbignRmFpbGVkIHRvIHJldHJpZXZlIGFsbCBjbGllbnRzJyk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgZ2V0Q2xpZW50QnlJZCh0aGVyYXBpc3RJZDogc3RyaW5nLCBjbGllbnRJZDogc3RyaW5nKTogUHJvbWlzZTxhbnk+IHtcbiAgICB0cnkge1xuICAgICAgLy8gRmluZCB0aGUgc3BlY2lmaWMgY2xpZW50IGFzc2lnbmVkIHRvIHRoaXMgdGhlcmFwaXN0XG4gICAgICBjb25zdCBhc3NpZ25lZENsaWVudCA9IGF3YWl0IHRoaXMucHJpc21hLmNsaWVudFRoZXJhcGlzdC5maW5kRmlyc3Qoe1xuICAgICAgICB3aGVyZTogeyB0aGVyYXBpc3RJZDogdGhlcmFwaXN0SWQsIGNsaWVudElkOiBjbGllbnRJZCB9LFxuICAgICAgICBpbmNsdWRlOiB7IGNsaWVudDogeyBpbmNsdWRlOiB7IHVzZXI6IHRydWUgfSB9IH0sXG4gICAgICB9KTtcbiAgICAgIGlmICghYXNzaWduZWRDbGllbnQpIHtcbiAgICAgICAgdGhyb3cgbmV3IE5vdEZvdW5kRXhjZXB0aW9uKCdDbGllbnQgbm90IGZvdW5kJyk7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiBhc3NpZ25lZENsaWVudC5jbGllbnQ7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoXG4gICAgICAgICdFcnJvciByZXRyaWV2aW5nIGNsaWVudCBieSBJRDonLFxuICAgICAgICBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6IGVycm9yLFxuICAgICAgKTtcbiAgICAgIHRocm93IG5ldyBJbnRlcm5hbFNlcnZlckVycm9yRXhjZXB0aW9uKCdGYWlsZWQgdG8gcmV0cmlldmUgY2xpZW50IGJ5IElEJyk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgZ2V0UHJvZmlsZSh0aGVyYXBpc3RJZDogc3RyaW5nKTogUHJvbWlzZTxhbnk+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgdGhlcmFwaXN0ID0gYXdhaXQgdGhpcy5wcmlzbWEudGhlcmFwaXN0LmZpbmRVbmlxdWVPclRocm93KHtcbiAgICAgICAgd2hlcmU6IHsgdXNlcklkOiB0aGVyYXBpc3RJZCB9LFxuICAgICAgICBpbmNsdWRlOiB7XG4gICAgICAgICAgdXNlcjogdHJ1ZSxcbiAgICAgICAgfSxcbiAgICAgIH0pO1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgLi4udGhlcmFwaXN0LFxuICAgICAgICB0cmVhdG1lbnRTdWNjZXNzUmF0ZXM6XG4gICAgICAgICAgKHRoZXJhcGlzdC50cmVhdG1lbnRTdWNjZXNzUmF0ZXMgYXMgUmVjb3JkPHN0cmluZywgYW55PikgfHwge30sXG4gICAgICAgIGhvdXJseVJhdGU6IHRoZXJhcGlzdC5ob3VybHlSYXRlLFxuICAgICAgfTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc29sZS5lcnJvcihcbiAgICAgICAgJ0Vycm9yIHJldHJpZXZpbmcgdGhlcmFwaXN0IHByb2ZpbGU6JyxcbiAgICAgICAgZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiBlcnJvcixcbiAgICAgICk7XG4gICAgICB0aHJvdyBuZXcgSW50ZXJuYWxTZXJ2ZXJFcnJvckV4Y2VwdGlvbihcbiAgICAgICAgJ0ZhaWxlZCB0byByZXRyaWV2ZSB0aGVyYXBpc3QgcHJvZmlsZScsXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIHVwZGF0ZVByb2ZpbGUoXG4gICAgdGhlcmFwaXN0SWQ6IHN0cmluZyxcbiAgICBkYXRhOiBQcmlzbWEuVGhlcmFwaXN0VXBkYXRlSW5wdXQsXG4gICk6IFByb21pc2U8YW55PiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHVwZGF0ZWRUaGVyYXBpc3QgPSBhd2FpdCB0aGlzLnByaXNtYS50aGVyYXBpc3QudXBkYXRlKHtcbiAgICAgICAgd2hlcmU6IHsgdXNlcklkOiB0aGVyYXBpc3RJZCB9LFxuICAgICAgICBkYXRhLFxuICAgICAgICBpbmNsdWRlOiB7XG4gICAgICAgICAgdXNlcjogdHJ1ZSxcbiAgICAgICAgfSxcbiAgICAgIH0pO1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgLi4udXBkYXRlZFRoZXJhcGlzdCxcbiAgICAgICAgdHJlYXRtZW50U3VjY2Vzc1JhdGVzOlxuICAgICAgICAgICh1cGRhdGVkVGhlcmFwaXN0LnRyZWF0bWVudFN1Y2Nlc3NSYXRlcyBhcyBSZWNvcmQ8c3RyaW5nLCBhbnk+KSB8fCB7fSxcbiAgICAgICAgaG91cmx5UmF0ZTogdXBkYXRlZFRoZXJhcGlzdC5ob3VybHlSYXRlLFxuICAgICAgfTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc29sZS5lcnJvcihcbiAgICAgICAgJ0Vycm9yIHVwZGF0aW5nIHRoZXJhcGlzdCBwcm9maWxlOicsXG4gICAgICAgIGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogZXJyb3IsXG4gICAgICApO1xuICAgICAgdGhyb3cgbmV3IEludGVybmFsU2VydmVyRXJyb3JFeGNlcHRpb24oXG4gICAgICAgICdGYWlsZWQgdG8gdXBkYXRlIHRoZXJhcGlzdCBwcm9maWxlJyxcbiAgICAgICk7XG4gICAgfVxuICB9XG59XG4iXSwidmVyc2lvbiI6M30=