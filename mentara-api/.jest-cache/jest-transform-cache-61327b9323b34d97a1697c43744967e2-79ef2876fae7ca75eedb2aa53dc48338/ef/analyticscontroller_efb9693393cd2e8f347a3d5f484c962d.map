{"file":"/home/wetooa/Documents/code/projects/mentara/mentara-api/src/analytics/analytics.controller.ts","mappings":"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","names":[],"sources":["/home/wetooa/Documents/code/projects/mentara/mentara-api/src/analytics/analytics.controller.ts"],"sourcesContent":["import {\n  Controller,\n  Get,\n  Query,\n  UseGuards,\n  ForbiddenException,\n} from '@nestjs/common';\nimport { AnalyticsService } from './analytics.service';\nimport { JwtAuthGuard } from '../auth/guards/jwt-auth.guard';\nimport { CurrentUserId } from '../auth/decorators/current-user-id.decorator';\nimport { CurrentUserRole } from '../auth/decorators/current-user-role.decorator';\nimport { ZodValidationPipe } from '../common/pipes/zod-validation.pipe';\nimport {\n  ApiTags,\n  ApiOperation,\n  ApiResponse,\n  ApiBody,\n  ApiBearerAuth,\n  ApiParam,\n  ApiQuery,\n} from '@nestjs/swagger';\nimport {\n  PlatformAnalyticsQueryDtoSchema,\n  TherapistAnalyticsQueryDtoSchema,\n  ClientAnalyticsQueryDtoSchema,\n  type PlatformAnalyticsQueryDto,\n  type TherapistAnalyticsQueryDto,\n  type ClientAnalyticsQueryDto,\n} from 'mentara-commons';\n\n@ApiTags('analytics')\n@ApiBearerAuth('JWT-auth')\n@Controller('analytics')\n@UseGuards(JwtAuthGuard)\nexport class AnalyticsController {\n  constructor(private readonly analyticsService: AnalyticsService) {}\n\n  @Get('platform')\n  @ApiOperation({\n    summary: 'Get platform analytics',\n    description:\n      'Retrieve comprehensive platform analytics data. Admin access required.',\n  })\n  @ApiQuery({\n    name: 'dateFrom',\n    required: false,\n    description: 'Start date for analytics (ISO string)',\n  })\n  @ApiQuery({\n    name: 'dateTo',\n    required: false,\n    description: 'End date for analytics (ISO string)',\n  })\n  @ApiResponse({\n    status: 200,\n    description: 'Platform analytics retrieved successfully',\n    schema: {\n      type: 'object',\n      properties: {\n        userStats: {\n          type: 'object',\n          properties: {\n            totalUsers: { type: 'number' },\n            newUsers: { type: 'number' },\n            activeUsers: { type: 'number' },\n            userGrowthRate: { type: 'number' },\n          },\n        },\n        sessionStats: {\n          type: 'object',\n          properties: {\n            totalSessions: { type: 'number' },\n            averageSessionDuration: { type: 'number' },\n            sessionCompletionRate: { type: 'number' },\n          },\n        },\n        therapistStats: {\n          type: 'object',\n          properties: {\n            totalTherapists: { type: 'number' },\n            activeTherapists: { type: 'number' },\n            averageRating: { type: 'number' },\n          },\n        },\n        revenue: {\n          type: 'object',\n          properties: {\n            totalRevenue: { type: 'number' },\n            monthlyRevenue: { type: 'number' },\n            revenueGrowth: { type: 'number' },\n          },\n        },\n      },\n    },\n  })\n  @ApiResponse({ status: 401, description: 'Unauthorized' })\n  @ApiResponse({\n    status: 403,\n    description: 'Access denied: Admin role required',\n  })\n  getPlatformAnalytics(\n    @CurrentUserRole() role: string,\n    @Query(new ZodValidationPipe(PlatformAnalyticsQueryDtoSchema))\n    query: PlatformAnalyticsQueryDto,\n  ) {\n    if (role !== 'admin') {\n      throw new ForbiddenException('Access denied: Admin role required');\n    }\n\n    const start = query.dateFrom ? new Date(query.dateFrom) : undefined;\n    const end = query.dateTo ? new Date(query.dateTo) : undefined;\n\n    return this.analyticsService.getPlatformAnalytics(start, end);\n  }\n\n  @Get('therapist')\n  @ApiOperation({\n    summary: 'Get therapist analytics',\n    description:\n      'Retrieve analytics for a specific therapist. Therapists can view their own analytics, admins can view any.',\n  })\n  @ApiQuery({\n    name: 'therapistId',\n    required: false,\n    description: 'Therapist ID (defaults to current user for therapists)',\n  })\n  @ApiQuery({\n    name: 'dateFrom',\n    required: false,\n    description: 'Start date for analytics (ISO string)',\n  })\n  @ApiQuery({\n    name: 'dateTo',\n    required: false,\n    description: 'End date for analytics (ISO string)',\n  })\n  @ApiResponse({\n    status: 200,\n    description: 'Therapist analytics retrieved successfully',\n    schema: {\n      type: 'object',\n      properties: {\n        therapistInfo: {\n          type: 'object',\n          properties: {\n            id: { type: 'string' },\n            name: { type: 'string' },\n            specializations: { type: 'array', items: { type: 'string' } },\n          },\n        },\n        clientStats: {\n          type: 'object',\n          properties: {\n            totalClients: { type: 'number' },\n            activeClients: { type: 'number' },\n            newClients: { type: 'number' },\n            clientRetentionRate: { type: 'number' },\n          },\n        },\n        sessionMetrics: {\n          type: 'object',\n          properties: {\n            totalSessions: { type: 'number' },\n            averageSessionDuration: { type: 'number' },\n            sessionRating: { type: 'number' },\n            completionRate: { type: 'number' },\n          },\n        },\n        performanceMetrics: {\n          type: 'object',\n          properties: {\n            responseTime: { type: 'number' },\n            clientSatisfaction: { type: 'number' },\n            treatmentEffectiveness: { type: 'number' },\n          },\n        },\n      },\n    },\n  })\n  @ApiResponse({ status: 401, description: 'Unauthorized' })\n  @ApiResponse({\n    status: 403,\n    description:\n      'Access denied: Can only view your own analytics or admin access required',\n  })\n  getTherapistAnalytics(\n    @CurrentUserId() userId: string,\n    @CurrentUserRole() role: string,\n    @Query(new ZodValidationPipe(TherapistAnalyticsQueryDtoSchema))\n    query: TherapistAnalyticsQueryDto,\n  ) {\n    // Allow therapists to view their own analytics or admins to view any\n    const targetTherapistId = query.therapistId || userId;\n\n    if (role === 'therapist' && targetTherapistId !== userId) {\n      throw new ForbiddenException(\n        'Access denied: Can only view your own analytics',\n      );\n    }\n\n    if (role !== 'therapist' && role !== 'admin') {\n      throw new ForbiddenException(\n        'Access denied: Therapist or Admin role required',\n      );\n    }\n\n    const start = query.dateFrom ? new Date(query.dateFrom) : undefined;\n    const end = query.dateTo ? new Date(query.dateTo) : undefined;\n\n    return this.analyticsService.getTherapistAnalytics(\n      targetTherapistId,\n      start,\n      end,\n    );\n  }\n\n  @Get('client')\n  @ApiOperation({\n    summary: 'Get client analytics',\n    description:\n      'Retrieve analytics for a specific client. Clients can view their own analytics, therapists/admins can view assigned clients.',\n  })\n  @ApiQuery({\n    name: 'clientId',\n    required: false,\n    description: 'Client ID (defaults to current user for clients)',\n  })\n  @ApiQuery({\n    name: 'dateFrom',\n    required: false,\n    description: 'Start date for analytics (ISO string)',\n  })\n  @ApiQuery({\n    name: 'dateTo',\n    required: false,\n    description: 'End date for analytics (ISO string)',\n  })\n  @ApiResponse({\n    status: 200,\n    description: 'Client analytics retrieved successfully',\n    schema: {\n      type: 'object',\n      properties: {\n        clientInfo: {\n          type: 'object',\n          properties: {\n            id: { type: 'string' },\n            name: { type: 'string' },\n            joinDate: { type: 'string', format: 'date-time' },\n          },\n        },\n        sessionHistory: {\n          type: 'object',\n          properties: {\n            totalSessions: { type: 'number' },\n            completedSessions: { type: 'number' },\n            cancelledSessions: { type: 'number' },\n            averageSessionRating: { type: 'number' },\n          },\n        },\n        progressMetrics: {\n          type: 'object',\n          properties: {\n            moodTrend: { type: 'array', items: { type: 'number' } },\n            goalAchievements: { type: 'number' },\n            improvementScore: { type: 'number' },\n            worksheetsCompleted: { type: 'number' },\n          },\n        },\n        engagementStats: {\n          type: 'object',\n          properties: {\n            loginFrequency: { type: 'number' },\n            messagesSent: { type: 'number' },\n            averageResponseTime: { type: 'number' },\n          },\n        },\n      },\n    },\n  })\n  @ApiResponse({ status: 401, description: 'Unauthorized' })\n  @ApiResponse({\n    status: 403,\n    description:\n      'Access denied: Can only view your own analytics or authorized access required',\n  })\n  getClientAnalytics(\n    @CurrentUserId() userId: string,\n    @CurrentUserRole() role: string,\n    @Query(new ZodValidationPipe(ClientAnalyticsQueryDtoSchema))\n    query: ClientAnalyticsQueryDto,\n  ) {\n    // Allow clients to view their own analytics or admins/therapists to view assigned clients\n    const targetClientId = query.clientId || userId;\n\n    if (role === 'user' && targetClientId !== userId) {\n      throw new ForbiddenException(\n        'Access denied: Can only view your own analytics',\n      );\n    }\n\n    if (role !== 'user' && role !== 'therapist' && role !== 'admin') {\n      throw new ForbiddenException('Access denied: Invalid role');\n    }\n\n    const start = query.dateFrom ? new Date(query.dateFrom) : undefined;\n    const end = query.dateTo ? new Date(query.dateTo) : undefined;\n\n    return this.analyticsService.getClientAnalytics(targetClientId, start, end);\n  }\n}\n"],"version":3}