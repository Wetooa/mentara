{"file":"/home/wetooa/Documents/code/projects/mentara/mentara-api/src/users/profile.service.ts","mappings":"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","names":[],"sources":["/home/wetooa/Documents/code/projects/mentara/mentara-api/src/users/profile.service.ts"],"sourcesContent":["import { Injectable, NotFoundException } from '@nestjs/common';\nimport { PrismaService } from 'src/providers/prisma-client.provider';\n\nexport interface PublicProfileResponse {\n  user: {\n    id: string;\n    firstName?: string;\n    middleName?: string;\n    lastName?: string;\n    bio?: string;\n    avatarUrl?: string;\n    coverImageUrl?: string;\n    role: string;\n    createdAt: string;\n  };\n  therapist?: {\n    specializations?: string[];\n    yearsOfExperience?: number;\n    sessionLength?: string;\n    hourlyRate?: number;\n    areasOfExpertise?: string[];\n    languages?: string[];\n  };\n  mutualCommunities: Array<{\n    id: string;\n    name: string;\n    slug: string;\n    imageUrl?: string;\n  }>;\n  recentActivity: Array<{\n    id: string;\n    type: 'post' | 'comment';\n    title?: string; // for posts\n    content: string;\n    createdAt: string;\n    community: {\n      name: string;\n      slug: string;\n    };\n    isFromSharedCommunity: boolean;\n  }>;\n  stats: {\n    postsCount: number;\n    commentsCount: number;\n    communitiesCount: number;\n    sharedCommunitiesCount: number;\n  };\n}\n\n@Injectable()\nexport class ProfileService {\n  constructor(private readonly prisma: PrismaService) {}\n\n  async getPublicProfile(profileUserId: string, currentUserId: string): Promise<PublicProfileResponse> {\n    // Get the target user with their relationships\n    const user = await this.prisma.user.findUnique({\n      where: { \n        id: profileUserId,\n        isActive: true // Only show active users\n      },\n      include: {\n        therapist: true,\n        memberships: {\n          include: {\n            community: true\n          }\n        },\n        posts: {\n          include: {\n            room: {\n              include: {\n                roomGroup: {\n                  include: {\n                    community: true\n                  }\n                }\n              }\n            }\n          },\n          orderBy: {\n            createdAt: 'desc'\n          },\n          take: 10 // Recent posts only\n        },\n        comments: {\n          include: {\n            post: {\n              include: {\n                room: {\n                  include: {\n                    roomGroup: {\n                      include: {\n                        community: true\n                      }\n                    }\n                  }\n                }\n              }\n            }\n          },\n          orderBy: {\n            createdAt: 'desc'\n          },\n          take: 10 // Recent comments only\n        }\n      }\n    });\n\n    if (!user) {\n      throw new NotFoundException('User profile not found');\n    }\n\n    // Get current user's communities for filtering\n    const currentUserCommunities = await this.prisma.membership.findMany({\n      where: { userId: currentUserId },\n      select: { communityId: true }\n    });\n    \n    const currentUserCommunityIds = new Set(\n      currentUserCommunities.map(m => m.communityId)\n    );\n\n    // Get mutual communities\n    const mutualCommunities = user.memberships\n      .filter(membership => currentUserCommunityIds.has(membership.communityId))\n      .map(membership => ({\n        id: membership.community.id,\n        name: membership.community.name,\n        slug: membership.community.slug,\n        imageUrl: membership.community.imageUrl\n      }));\n\n    // Filter and transform posts and comments\n    const recentActivity: PublicProfileResponse['recentActivity'] = [];\n\n    // Add posts to activity\n    user.posts.forEach(post => {\n      if (post.room?.roomGroup?.community) {\n        const isFromSharedCommunity = currentUserCommunityIds.has(\n          post.room.roomGroup.community.id\n        );\n        \n        recentActivity.push({\n          id: post.id,\n          type: 'post',\n          title: post.title,\n          content: isFromSharedCommunity ? post.content : 'Content from different community',\n          createdAt: post.createdAt.toISOString(),\n          community: {\n            name: post.room.roomGroup.community.name,\n            slug: post.room.roomGroup.community.slug\n          },\n          isFromSharedCommunity\n        });\n      }\n    });\n\n    // Add comments to activity\n    user.comments.forEach(comment => {\n      if (comment.post.room?.roomGroup?.community) {\n        const isFromSharedCommunity = currentUserCommunityIds.has(\n          comment.post.room.roomGroup.community.id\n        );\n        \n        recentActivity.push({\n          id: comment.id,\n          type: 'comment',\n          content: isFromSharedCommunity ? comment.content : 'Comment from different community',\n          createdAt: comment.createdAt.toISOString(),\n          community: {\n            name: comment.post.room.roomGroup.community.name,\n            slug: comment.post.room.roomGroup.community.slug\n          },\n          isFromSharedCommunity\n        });\n      }\n    });\n\n    // Sort activity by date and limit to 20 items\n    recentActivity.sort((a, b) => new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime());\n    const limitedActivity = recentActivity.slice(0, 20);\n\n    // Calculate stats\n    const stats = {\n      postsCount: user.posts.length,\n      commentsCount: user.comments.length,\n      communitiesCount: user.memberships.length,\n      sharedCommunitiesCount: mutualCommunities.length\n    };\n\n    // Build response\n    const response: PublicProfileResponse = {\n      user: {\n        id: user.id,\n        firstName: user.firstName,\n        middleName: user.middleName ?? undefined,\n        lastName: user.lastName,\n        bio: user.bio ?? undefined,\n        avatarUrl: user.avatarUrl ?? undefined,\n        coverImageUrl: user.coverImageUrl ?? undefined,\n        role: user.role,\n        createdAt: user.createdAt.toISOString()\n      },\n      mutualCommunities,\n      recentActivity: limitedActivity,\n      stats\n    };\n\n    // Add therapist info if applicable\n    if (user.role === 'therapist' && user.therapist) {\n      response.therapist = {\n        specializations: user.therapist.areasOfExpertise,\n        yearsOfExperience: user.therapist.yearsOfExperience ?? undefined,\n        sessionLength: user.therapist.sessionLength,\n        hourlyRate: user.therapist.hourlyRate ? Number(user.therapist.hourlyRate) : undefined,\n        areasOfExpertise: user.therapist.areasOfExpertise,\n        languages: user.therapist.languagesOffered\n      };\n    }\n\n    return response;\n  }\n\n  async updateProfile(userId: string, profileData: any) {\n    // Only allow updating certain fields for security\n    const allowedFields = {\n      firstName: profileData.firstName,\n      middleName: profileData.middleName,\n      lastName: profileData.lastName,\n      bio: profileData.bio,\n      avatarUrl: profileData.avatarUrl,\n      coverImageUrl: profileData.coverImageUrl\n    };\n\n    // Remove undefined values\n    const updateData = Object.fromEntries(\n      Object.entries(allowedFields).filter(([_, value]) => value !== undefined)\n    );\n\n    const updatedUser = await this.prisma.user.update({\n      where: { id: userId },\n      data: updateData,\n      include: {\n        therapist: true,\n        memberships: {\n          include: {\n            community: true\n          }\n        }\n      }\n    });\n\n    return {\n      user: {\n        id: updatedUser.id,\n        firstName: updatedUser.firstName,\n        middleName: updatedUser.middleName ?? undefined,\n        lastName: updatedUser.lastName,\n        bio: updatedUser.bio ?? undefined,\n        avatarUrl: updatedUser.avatarUrl ?? undefined,\n        coverImageUrl: updatedUser.coverImageUrl ?? undefined,\n        role: updatedUser.role,\n        createdAt: updatedUser.createdAt.toISOString(),\n        updatedAt: updatedUser.updatedAt.toISOString()\n      }\n    };\n  }\n}"],"version":3}