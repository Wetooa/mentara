8e2218f54eead86dd9ded17c928e6ae5
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var MessagingService_1;
var _a, _b, _c;
Object.defineProperty(exports, "__esModule", { value: true });
exports.MessagingService = void 0;
const common_1 = require("@nestjs/common");
const prisma_client_provider_1 = require("../providers/prisma-client.provider");
const client_1 = require("@prisma/client");
const event_bus_service_1 = require("../common/events/event-bus.service");
const messaging_events_1 = require("../common/events/messaging-events");
const message_encryption_service_1 = require("./services/message-encryption.service");
let MessagingService = MessagingService_1 = class MessagingService {
    prisma;
    eventBus;
    messageEncryption;
    logger = new common_1.Logger(MessagingService_1.name);
    constructor(prisma, eventBus, messageEncryption) {
        this.prisma = prisma;
        this.eventBus = eventBus;
        this.messageEncryption = messageEncryption;
    }
    // Conversation Management
    async createConversation(userId, createConversationDto) {
        const { participantIds, type = client_1.ConversationType.DIRECT, title, } = createConversationDto;
        // Validate conversation type and participants
        if (type === client_1.ConversationType.DIRECT && participantIds.length !== 1) {
            throw new common_1.BadRequestException('Direct conversations must have exactly one other participant');
        }
        // Check if direct conversation already exists
        if (type === client_1.ConversationType.DIRECT) {
            const existingConversation = await this.findDirectConversation(userId, participantIds[0]);
            if (existingConversation) {
                return existingConversation;
            }
        }
        // Create conversation with participants
        const conversation = await this.prisma.conversation.create({
            data: {
                type,
                title,
                participants: {
                    create: [
                        { userId, role: client_1.ParticipantRole.ADMIN },
                        ...participantIds.map((participantId) => ({
                            userId: participantId,
                            role: client_1.ParticipantRole.MEMBER,
                        })),
                    ],
                },
            },
            include: {
                participants: {
                    include: {
                        user: {
                            select: {
                                id: true,
                                firstName: true,
                                lastName: true,
                                avatarUrl: true,
                                role: true,
                            },
                        },
                    },
                },
                messages: {
                    take: 1,
                    orderBy: { createdAt: 'desc' },
                    include: {
                        sender: {
                            select: {
                                id: true,
                                firstName: true,
                                lastName: true,
                                avatarUrl: true,
                            },
                        },
                    },
                },
            },
        });
        // Publish conversation created event
        await this.eventBus.emit(new messaging_events_1.ConversationCreatedEvent({
            conversationId: conversation.id,
            createdBy: userId,
            participantIds: [userId, ...participantIds],
            conversationType: type.toLowerCase(),
            title: title || undefined,
            isPrivate: type === client_1.ConversationType.DIRECT,
        }));
        return conversation;
    }
    async getUserConversations(userId, page = 1, limit = 20) {
        const skip = (page - 1) * limit;
        const conversations = await this.prisma.conversation.findMany({
            where: {
                participants: {
                    some: {
                        userId,
                        isActive: true,
                    },
                },
                isActive: true,
            },
            include: {
                participants: {
                    where: { isActive: true },
                    include: {
                        user: {
                            select: {
                                id: true,
                                firstName: true,
                                lastName: true,
                                avatarUrl: true,
                                role: true,
                            },
                        },
                    },
                },
                messages: {
                    take: 1,
                    orderBy: { createdAt: 'desc' },
                    where: { isDeleted: false },
                    include: {
                        sender: {
                            select: {
                                id: true,
                                firstName: true,
                                lastName: true,
                                avatarUrl: true,
                            },
                        },
                    },
                },
                _count: {
                    select: {
                        messages: {
                            where: {
                                isDeleted: false,
                                readReceipts: {
                                    none: { userId },
                                },
                            },
                        },
                    },
                },
            },
            orderBy: { lastMessageAt: 'desc' },
            skip,
            take: limit,
        });
        return conversations;
    }
    // Message Management
    async sendMessage(userId, conversationId, sendMessageDto, attachmentUrls = [], attachmentNames = [], attachmentSizes = []) {
        // Verify user is participant in conversation
        await this.verifyParticipant(userId, conversationId);
        const { content, messageType = client_1.MessageType.TEXT, replyToId, attachmentUrl, attachmentName, attachmentSize, } = sendMessageDto;
        // Get conversation details to determine encryption type
        const conversation = await this.prisma.conversation.findUnique({
            where: { id: conversationId },
            include: {
                participants: {
                    include: {
                        user: {
                            select: { role: true },
                        },
                    },
                },
            },
        });
        if (!conversation) {
            throw new common_1.NotFoundException('Conversation not found');
        }
        // Determine encryption type based on conversation participants
        const conversationType = this.messageEncryption.getConversationType(conversation.participants.map((p) => ({ role: p.user.role })));
        // Encrypt message content for sensitive conversations
        let finalContent = content;
        let encryptionData = null;
        if (messageType === client_1.MessageType.TEXT && content.trim().length > 0) {
            try {
                encryptionData = await this.messageEncryption.encryptMessage(content, conversationType);
                finalContent = encryptionData.encryptedContent; // Store encrypted content
            }
            catch (error) {
                this.logger.error('Message encryption failed, storing plaintext:', error);
                // Fallback to plaintext if encryption fails (log this for security audit)
            }
        }
        const message = await this.prisma.message.create({
            data: {
                conversationId,
                senderId: userId,
                content: finalContent, // Store encrypted content
                messageType,
                replyToId,
                // Keep backward compatibility with single attachment fields
                attachmentUrl: attachmentUrls[0] || attachmentUrl,
                attachmentName: attachmentNames[0] || attachmentName,
                attachmentSize: attachmentSizes[0] || attachmentSize,
                // Add new multiple attachment fields
                attachmentUrls,
                attachmentNames,
                attachmentSizes,
                // Store encryption metadata
                encryptionIv: encryptionData?.iv,
                encryptionAuthTag: encryptionData?.authTag,
                encryptionKeyId: encryptionData?.keyId,
                isEncrypted: !!encryptionData,
            },
            include: {
                sender: {
                    select: {
                        id: true,
                        firstName: true,
                        lastName: true,
                        avatarUrl: true,
                    },
                },
                replyTo: {
                    include: {
                        sender: {
                            select: {
                                id: true,
                                firstName: true,
                                lastName: true,
                            },
                        },
                    },
                },
                reactions: {
                    include: {
                        user: {
                            select: {
                                id: true,
                                firstName: true,
                                lastName: true,
                            },
                        },
                    },
                },
            },
        });
        // Update conversation lastMessageAt
        await this.prisma.conversation.update({
            where: { id: conversationId },
            data: { lastMessageAt: new Date() },
        });
        // For encrypted messages, we need to decrypt for event emission
        let eventContent = content; // Original plaintext for events
        if (message.isEncrypted && encryptionData) {
            // Events should contain plaintext for processing
            eventContent = content;
        }
        const recipientIds = conversation?.participants
            .map((p) => p.userId)
            .filter((id) => id !== userId) || [];
        // Publish message sent event
        await this.eventBus.emit(new messaging_events_1.MessageSentEvent({
            messageId: message.id,
            conversationId,
            senderId: userId,
            content: eventContent, // Use original plaintext for events
            messageType: message.messageType.toLowerCase(),
            sentAt: message.createdAt,
            recipientIds,
            replyToMessageId: message.replyToId || undefined,
            fileAttachments: attachmentUrls.length > 0
                ? attachmentUrls
                : message.attachmentUrl
                    ? [message.attachmentUrl]
                    : undefined,
            isEncrypted: message.isEncrypted,
        }));
        // Return message with decrypted content for immediate display
        return {
            ...message,
            content: eventContent, // Return plaintext content
        };
    }
    async getConversationMessages(userId, conversationId, page = 1, limit = 50) {
        // Verify user is participant in conversation
        await this.verifyParticipant(userId, conversationId);
        const skip = (page - 1) * limit;
        const messages = await this.prisma.message.findMany({
            where: {
                conversationId,
                isDeleted: false,
            },
            include: {
                sender: {
                    select: {
                        id: true,
                        firstName: true,
                        lastName: true,
                        avatarUrl: true,
                    },
                },
                replyTo: {
                    include: {
                        sender: {
                            select: {
                                id: true,
                                firstName: true,
                                lastName: true,
                            },
                        },
                    },
                },
                reactions: {
                    include: {
                        user: {
                            select: {
                                id: true,
                                firstName: true,
                                lastName: true,
                            },
                        },
                    },
                },
                readReceipts: {
                    include: {
                        user: {
                            select: {
                                id: true,
                                firstName: true,
                                lastName: true,
                            },
                        },
                    },
                },
            },
            orderBy: { createdAt: 'desc' },
            skip,
            take: limit,
        });
        // Decrypt messages if they are encrypted
        const decryptedMessages = await Promise.all(messages.map(async (message) => {
            if (message.isEncrypted &&
                message.encryptionIv &&
                message.encryptionAuthTag &&
                message.encryptionKeyId) {
                try {
                    const encryptedMessage = {
                        encryptedContent: message.content,
                        iv: message.encryptionIv,
                        authTag: message.encryptionAuthTag,
                        keyId: message.encryptionKeyId,
                    };
                    const decrypted = await this.messageEncryption.decryptMessage(encryptedMessage);
                    return {
                        ...message,
                        content: decrypted.content,
                    };
                }
                catch (error) {
                    this.logger.error(`Failed to decrypt message ${message.id}:`, error);
                    return {
                        ...message,
                        content: '[Message could not be decrypted]',
                    };
                }
            }
            return message;
        }));
        return decryptedMessages.reverse(); // Return in chronological order
    }
    async updateMessage(userId, messageId, updateMessageDto) {
        const message = await this.prisma.message.findUnique({
            where: { id: messageId },
        });
        if (!message) {
            throw new common_1.NotFoundException('Message not found');
        }
        if (message.senderId !== userId) {
            throw new common_1.ForbiddenException('You can only edit your own messages');
        }
        if (message.isDeleted) {
            throw new common_1.BadRequestException('Cannot edit deleted message');
        }
        const updatedMessage = await this.prisma.message.update({
            where: { id: messageId },
            data: {
                content: updateMessageDto.content,
                isEdited: true,
                editedAt: new Date(),
            },
            include: {
                sender: {
                    select: {
                        id: true,
                        firstName: true,
                        lastName: true,
                        avatarUrl: true,
                    },
                },
                reactions: {
                    include: {
                        user: {
                            select: {
                                id: true,
                                firstName: true,
                                lastName: true,
                            },
                        },
                    },
                },
            },
        });
        return updatedMessage;
    }
    async deleteMessage(userId, messageId) {
        const message = await this.prisma.message.findUnique({
            where: { id: messageId },
        });
        if (!message) {
            throw new common_1.NotFoundException('Message not found');
        }
        if (message.senderId !== userId) {
            throw new common_1.ForbiddenException('You can only delete your own messages');
        }
        await this.prisma.message.update({
            where: { id: messageId },
            data: { isDeleted: true },
        });
        return { success: true };
    }
    // Read Receipts
    async markMessageAsRead(userId, messageId) {
        const message = await this.prisma.message.findUnique({
            where: { id: messageId },
        });
        if (!message) {
            throw new common_1.NotFoundException('Message not found');
        }
        // Don't create read receipt for own messages
        if (message.senderId === userId) {
            return;
        }
        // Verify user is participant in conversation
        await this.verifyParticipant(userId, message.conversationId);
        await this.prisma.messageReadReceipt.upsert({
            where: {
                messageId_userId: {
                    messageId,
                    userId,
                },
            },
            create: {
                messageId,
                userId,
            },
            update: {
                readAt: new Date(),
            },
        });
        // Update participant's lastReadAt
        await this.prisma.conversationParticipant.updateMany({
            where: {
                conversationId: message.conversationId,
                userId,
            },
            data: {
                lastReadAt: new Date(),
            },
        });
        // Publish message read event
        await this.eventBus.emit(new messaging_events_1.MessageReadEvent({
            messageId,
            readBy: userId,
            readAt: new Date(),
            conversationId: message.conversationId,
            messagesSinceLastRead: 1, // Could be enhanced to calculate actual count
        }));
    }
    // Message Reactions
    async addMessageReaction(userId, messageId, emoji) {
        const message = await this.prisma.message.findUnique({
            where: { id: messageId },
        });
        if (!message) {
            throw new common_1.NotFoundException('Message not found');
        }
        // Verify user is participant in conversation
        await this.verifyParticipant(userId, message.conversationId);
        const reaction = await this.prisma.messageReaction.upsert({
            where: {
                messageId_userId_emoji: {
                    messageId,
                    userId,
                    emoji,
                },
            },
            create: {
                messageId,
                userId,
                emoji,
            },
            update: {
                emoji,
            },
            include: {
                user: {
                    select: {
                        id: true,
                        firstName: true,
                        lastName: true,
                    },
                },
            },
        });
        return reaction;
    }
    async removeMessageReaction(userId, messageId, emoji) {
        await this.prisma.messageReaction.deleteMany({
            where: {
                messageId,
                userId,
                emoji,
            },
        });
        return { success: true };
    }
    // User Blocking
    async blockUser(blockerId, blockedId, reason) {
        if (blockerId === blockedId) {
            throw new common_1.BadRequestException('Cannot block yourself');
        }
        await this.prisma.userBlock.upsert({
            where: {
                blockerId_blockedId: {
                    blockerId,
                    blockedId,
                },
            },
            create: {
                blockerId,
                blockedId,
                reason,
            },
            update: {
                reason,
            },
        });
        return { success: true };
    }
    async unblockUser(blockerId, blockedId) {
        await this.prisma.userBlock.deleteMany({
            where: {
                blockerId,
                blockedId,
            },
        });
        return { success: true };
    }
    // Helper Methods
    async findDirectConversation(user1Id, user2Id) {
        return this.prisma.conversation.findFirst({
            where: {
                type: client_1.ConversationType.DIRECT,
                participants: {
                    every: {
                        userId: { in: [user1Id, user2Id] },
                    },
                },
            },
            include: {
                participants: {
                    include: {
                        user: {
                            select: {
                                id: true,
                                firstName: true,
                                lastName: true,
                                avatarUrl: true,
                                role: true,
                            },
                        },
                    },
                },
            },
        });
    }
    async verifyParticipant(userId, conversationId) {
        const participant = await this.prisma.conversationParticipant.findUnique({
            where: {
                conversationId_userId: {
                    conversationId,
                    userId,
                },
            },
        });
        if (!participant || !participant.isActive) {
            throw new common_1.ForbiddenException('You are not a participant in this conversation');
        }
        return participant;
    }
    // Search Messages
    async searchMessages(userId, query, conversationId, page = 1, limit = 20) {
        const skip = (page - 1) * limit;
        const whereClause = {
            content: {
                contains: query,
                mode: 'insensitive',
            },
            isDeleted: false,
            conversation: {
                participants: {
                    some: {
                        userId,
                        isActive: true,
                    },
                },
            },
        };
        if (conversationId) {
            whereClause.conversationId = conversationId;
        }
        const messages = await this.prisma.message.findMany({
            where: whereClause,
            include: {
                sender: {
                    select: {
                        id: true,
                        firstName: true,
                        lastName: true,
                        avatarUrl: true,
                    },
                },
                conversation: {
                    select: {
                        id: true,
                        type: true,
                        title: true,
                    },
                },
            },
            orderBy: { createdAt: 'desc' },
            skip,
            take: limit,
        });
        return messages;
    }
};
exports.MessagingService = MessagingService;
exports.MessagingService = MessagingService = MessagingService_1 = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [typeof (_a = typeof prisma_client_provider_1.PrismaService !== "undefined" && prisma_client_provider_1.PrismaService) === "function" ? _a : Object, typeof (_b = typeof event_bus_service_1.EventBusService !== "undefined" && event_bus_service_1.EventBusService) === "function" ? _b : Object, typeof (_c = typeof message_encryption_service_1.MessageEncryptionService !== "undefined" && message_encryption_service_1.MessageEncryptionService) === "function" ? _c : Object])
], MessagingService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL21lc3NhZ2luZy9tZXNzYWdpbmcuc2VydmljZS50cyIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7OztBQUFBLDJDQU13QjtBQUN4QixnRkFBb0U7QUFNcEUsMkNBQWdGO0FBQ2hGLDBFQUFxRTtBQUNyRSx3RUFJMkM7QUFDM0Msc0ZBRytDO0FBR3hDLElBQU0sZ0JBQWdCLHdCQUF0QixNQUFNLGdCQUFnQjtJQUlSO0lBQ0E7SUFDQTtJQUxGLE1BQU0sR0FBRyxJQUFJLGVBQU0sQ0FBQyxrQkFBZ0IsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUU1RCxZQUNtQixNQUFxQixFQUNyQixRQUF5QixFQUN6QixpQkFBMkM7UUFGM0MsV0FBTSxHQUFOLE1BQU0sQ0FBZTtRQUNyQixhQUFRLEdBQVIsUUFBUSxDQUFpQjtRQUN6QixzQkFBaUIsR0FBakIsaUJBQWlCLENBQTBCO0lBQzNELENBQUM7SUFFSiwwQkFBMEI7SUFDMUIsS0FBSyxDQUFDLGtCQUFrQixDQUN0QixNQUFjLEVBQ2QscUJBQTRDO1FBRTVDLE1BQU0sRUFDSixjQUFjLEVBQ2QsSUFBSSxHQUFHLHlCQUFnQixDQUFDLE1BQU0sRUFDOUIsS0FBSyxHQUNOLEdBQUcscUJBQXFCLENBQUM7UUFFMUIsOENBQThDO1FBQzlDLElBQUksSUFBSSxLQUFLLHlCQUFnQixDQUFDLE1BQU0sSUFBSSxjQUFjLENBQUMsTUFBTSxLQUFLLENBQUMsRUFBRSxDQUFDO1lBQ3BFLE1BQU0sSUFBSSw0QkFBbUIsQ0FDM0IsOERBQThELENBQy9ELENBQUM7UUFDSixDQUFDO1FBRUQsOENBQThDO1FBQzlDLElBQUksSUFBSSxLQUFLLHlCQUFnQixDQUFDLE1BQU0sRUFBRSxDQUFDO1lBQ3JDLE1BQU0sb0JBQW9CLEdBQUcsTUFBTSxJQUFJLENBQUMsc0JBQXNCLENBQzVELE1BQU0sRUFDTixjQUFjLENBQUMsQ0FBQyxDQUFDLENBQ2xCLENBQUM7WUFD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LEVBQUUsU0FBUyxFQUFFLE1BQU0sRUFBRTtZQUM5QixJQUFJO1lBQ0osSUFBSSxFQUFFLEtBQUs7U0FDWixDQUFDLENBQUM7UUFFSCxPQUFPLFFBQVEsQ0FBQztJQUNsQixDQUFDO0NBQ0YsQ0FBQTtBQXZ3QlksNENBQWdCOzJCQUFoQixnQkFBZ0I7SUFENUIsSUFBQSxtQkFBVSxHQUFFO3lEQUtnQixzQ0FBYSxvQkFBYixzQ0FBYSxvREFDWCxtQ0FBZSxvQkFBZixtQ0FBZSxvREFDTixxREFBd0Isb0JBQXhCLHFEQUF3QjtHQU5uRCxnQkFBZ0IsQ0F1d0I1QiIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvaG9tZS93ZXRvb2EvRG9jdW1lbnRzL2NvZGUvcHJvamVjdHMvbWVudGFyYS9tZW50YXJhLWFwaS9zcmMvbWVzc2FnaW5nL21lc3NhZ2luZy5zZXJ2aWNlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIEluamVjdGFibGUsXG4gIExvZ2dlcixcbiAgTm90Rm91bmRFeGNlcHRpb24sXG4gIEZvcmJpZGRlbkV4Y2VwdGlvbixcbiAgQmFkUmVxdWVzdEV4Y2VwdGlvbixcbn0gZnJvbSAnQG5lc3Rqcy9jb21tb24nO1xuaW1wb3J0IHsgUHJpc21hU2VydmljZSB9IGZyb20gJy4uL3Byb3ZpZGVycy9wcmlzbWEtY2xpZW50LnByb3ZpZGVyJztcbmltcG9ydCB7XG4gIENyZWF0ZUNvbnZlcnNhdGlvbkR0byxcbiAgU2VuZE1lc3NhZ2VEdG8sXG4gIFVwZGF0ZU1lc3NhZ2VEdG8sXG59IGZyb20gJ21lbnRhcmEtY29tbW9ucyc7XG5pbXBvcnQgeyBDb252ZXJzYXRpb25UeXBlLCBNZXNzYWdlVHlwZSwgUGFydGljaXBhbnRSb2xlIH0gZnJvbSAnQHByaXNtYS9jbGllbnQnO1xuaW1wb3J0IHsgRXZlbnRCdXNTZXJ2aWNlIH0gZnJvbSAnLi4vY29tbW9uL2V2ZW50cy9ldmVudC1idXMuc2VydmljZSc7XG5pbXBvcnQge1xuICBNZXNzYWdlU2VudEV2ZW50LFxuICBNZXNzYWdlUmVhZEV2ZW50LFxuICBDb252ZXJzYXRpb25DcmVhdGVkRXZlbnQsXG59IGZyb20gJy4uL2NvbW1vbi9ldmVudHMvbWVzc2FnaW5nLWV2ZW50cyc7XG5pbXBvcnQge1xuICBNZXNzYWdlRW5jcnlwdGlvblNlcnZpY2UsXG4gIEVuY3J5cHRlZE1lc3NhZ2UsXG59IGZyb20gJy4vc2VydmljZXMvbWVzc2FnZS1lbmNyeXB0aW9uLnNlcnZpY2UnO1xuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgTWVzc2FnaW5nU2VydmljZSB7XG4gIHByaXZhdGUgcmVhZG9ubHkgbG9nZ2VyID0gbmV3IExvZ2dlcihNZXNzYWdpbmdTZXJ2aWNlLm5hbWUpO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgcmVhZG9ubHkgcHJpc21hOiBQcmlzbWFTZXJ2aWNlLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgZXZlbnRCdXM6IEV2ZW50QnVzU2VydmljZSxcbiAgICBwcml2YXRlIHJlYWRvbmx5IG1lc3NhZ2VFbmNyeXB0aW9uOiBNZXNzYWdlRW5jcnlwdGlvblNlcnZpY2UsXG4gICkge31cblxuICAvLyBDb252ZXJzYXRpb24gTWFuYWdlbWVudFxuICBhc3luYyBjcmVhdGVDb252ZXJzYXRpb24oXG4gICAgdXNlcklkOiBzdHJpbmcsXG4gICAgY3JlYXRlQ29udmVyc2F0aW9uRHRvOiBDcmVhdGVDb252ZXJzYXRpb25EdG8sXG4gICkge1xuICAgIGNvbnN0IHtcbiAgICAgIHBhcnRpY2lwYW50SWRzLFxuICAgICAgdHlwZSA9IENvbnZlcnNhdGlvblR5cGUuRElSRUNULFxuICAgICAgdGl0bGUsXG4gICAgfSA9IGNyZWF0ZUNvbnZlcnNhdGlvbkR0bztcblxuICAgIC8vIFZhbGlkYXRlIGNvbnZlcnNhdGlvbiB0eXBlIGFuZCBwYXJ0aWNpcGFudHNcbiAgICBpZiAodHlwZSA9PT0gQ29udmVyc2F0aW9uVHlwZS5ESVJFQ1QgJiYgcGFydGljaXBhbnRJZHMubGVuZ3RoICE9PSAxKSB7XG4gICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdEV4Y2VwdGlvbihcbiAgICAgICAgJ0RpcmVjdCBjb252ZXJzYXRpb25zIG11c3QgaGF2ZSBleGFjdGx5IG9uZSBvdGhlciBwYXJ0aWNpcGFudCcsXG4gICAgICApO1xuICAgIH1cblxuICAgIC8vIENoZWNrIGlmIGRpcmVjdCBjb252ZXJzYXRpb24gYWxyZWFkeSBleGlzdHNcbiAgICBpZiAodHlwZSA9PT0gQ29udmVyc2F0aW9uVHlwZS5ESVJFQ1QpIHtcbiAgICAgIGNvbnN0IGV4aXN0aW5nQ29udmVyc2F0aW9uID0gYXdhaXQgdGhpcy5maW5kRGlyZWN0Q29udmVyc2F0aW9uKFxuICAgICAgICB1c2VySWQsXG4gICAgICAgIHBhcnRpY2lwYW50SWRzWzBdLFxuICAgICAgKTtcbiAgICAgIGlmIChleGlzdGluZ0NvbnZlcnNhdGlvbikge1xuICAgICAgICByZXR1cm4gZXhpc3RpbmdDb252ZXJzYXRpb247XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gQ3JlYXRlIGNvbnZlcnNhdGlvbiB3aXRoIHBhcnRpY2lwYW50c1xuICAgIGNvbnN0IGNvbnZlcnNhdGlvbiA9IGF3YWl0IHRoaXMucHJpc21hLmNvbnZlcnNhdGlvbi5jcmVhdGUoe1xuICAgICAgZGF0YToge1xuICAgICAgICB0eXBlLFxuICAgICAgICB0aXRsZSxcbiAgICAgICAgcGFydGljaXBhbnRzOiB7XG4gICAgICAgICAgY3JlYXRlOiBbXG4gICAgICAgICAgICB7IHVzZXJJZCwgcm9sZTogUGFydGljaXBhbnRSb2xlLkFETUlOIH0sXG4gICAgICAgICAgICAuLi5wYXJ0aWNpcGFudElkcy5tYXAoKHBhcnRpY2lwYW50SWQpID0+ICh7XG4gICAgICAgICAgICAgIHVzZXJJZDogcGFydGljaXBhbnRJZCxcbiAgICAgICAgICAgICAgcm9sZTogUGFydGljaXBhbnRSb2xlLk1FTUJFUixcbiAgICAgICAgICAgIH0pKSxcbiAgICAgICAgICBdLFxuICAgICAgICB9LFxuICAgICAgfSxcbiAgICAgIGluY2x1ZGU6IHtcbiAgICAgICAgcGFydGljaXBhbnRzOiB7XG4gICAgICAgICAgaW5jbHVkZToge1xuICAgICAgICAgICAgdXNlcjoge1xuICAgICAgICAgICAgICBzZWxlY3Q6IHtcbiAgICAgICAgICAgICAgICBpZDogdHJ1ZSxcbiAgICAgICAgICAgICAgICBmaXJzdE5hbWU6IHRydWUsXG4gICAgICAgICAgICAgICAgbGFzdE5hbWU6IHRydWUsXG4gICAgICAgICAgICAgICAgYXZhdGFyVXJsOiB0cnVlLFxuICAgICAgICAgICAgICAgIHJvbGU6IHRydWUsXG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICAgIG1lc3NhZ2VzOiB7XG4gICAgICAgICAgdGFrZTogMSxcbiAgICAgICAgICBvcmRlckJ5OiB7IGNyZWF0ZWRBdDogJ2Rlc2MnIH0sXG4gICAgICAgICAgaW5jbHVkZToge1xuICAgICAgICAgICAgc2VuZGVyOiB7XG4gICAgICAgICAgICAgIHNlbGVjdDoge1xuICAgICAgICAgICAgICAgIGlkOiB0cnVlLFxuICAgICAgICAgICAgICAgIGZpcnN0TmFtZTogdHJ1ZSxcbiAgICAgICAgICAgICAgICBsYXN0TmFtZTogdHJ1ZSxcbiAgICAgICAgICAgICAgICBhdmF0YXJVcmw6IHRydWUsXG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgLy8gUHVibGlzaCBjb252ZXJzYXRpb24gY3JlYXRlZCBldmVudFxuICAgIGF3YWl0IHRoaXMuZXZlbnRCdXMuZW1pdChcbiAgICAgIG5ldyBDb252ZXJzYXRpb25DcmVhdGVkRXZlbnQoe1xuICAgICAgICBjb252ZXJzYXRpb25JZDogY29udmVyc2F0aW9uLmlkLFxuICAgICAgICBjcmVhdGVkQnk6IHVzZXJJZCxcbiAgICAgICAgcGFydGljaXBhbnRJZHM6IFt1c2VySWQsIC4uLnBhcnRpY2lwYW50SWRzXSxcbiAgICAgICAgY29udmVyc2F0aW9uVHlwZTogdHlwZS50b0xvd2VyQ2FzZSgpIGFzXG4gICAgICAgICAgfCAnZGlyZWN0J1xuICAgICAgICAgIHwgJ2dyb3VwJ1xuICAgICAgICAgIHwgJ3N1cHBvcnQnXG4gICAgICAgICAgfCAndGhlcmFweScsXG4gICAgICAgIHRpdGxlOiB0aXRsZSB8fCB1bmRlZmluZWQsXG4gICAgICAgIGlzUHJpdmF0ZTogdHlwZSA9PT0gQ29udmVyc2F0aW9uVHlwZS5ESVJFQ1QsXG4gICAgICB9KSxcbiAgICApO1xuXG4gICAgcmV0dXJuIGNvbnZlcnNhdGlvbjtcbiAgfVxuXG4gIGFzeW5jIGdldFVzZXJDb252ZXJzYXRpb25zKHVzZXJJZDogc3RyaW5nLCBwYWdlID0gMSwgbGltaXQgPSAyMCkge1xuICAgIGNvbnN0IHNraXAgPSAocGFnZSAtIDEpICogbGltaXQ7XG5cbiAgICBjb25zdCBjb252ZXJzYXRpb25zID0gYXdhaXQgdGhpcy5wcmlzbWEuY29udmVyc2F0aW9uLmZpbmRNYW55KHtcbiAgICAgIHdoZXJlOiB7XG4gICAgICAgIHBhcnRpY2lwYW50czoge1xuICAgICAgICAgIHNvbWU6IHtcbiAgICAgICAgICAgIHVzZXJJZCxcbiAgICAgICAgICAgIGlzQWN0aXZlOiB0cnVlLFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICAgIGlzQWN0aXZlOiB0cnVlLFxuICAgICAgfSxcbiAgICAgIGluY2x1ZGU6IHtcbiAgICAgICAgcGFydGljaXBhbnRzOiB7XG4gICAgICAgICAgd2hlcmU6IHsgaXNBY3RpdmU6IHRydWUgfSxcbiAgICAgICAgICBpbmNsdWRlOiB7XG4gICAgICAgICAgICB1c2VyOiB7XG4gICAgICAgICAgICAgIHNlbGVjdDoge1xuICAgICAgICAgICAgICAgIGlkOiB0cnVlLFxuICAgICAgICAgICAgICAgIGZpcnN0TmFtZTogdHJ1ZSxcbiAgICAgICAgICAgICAgICBsYXN0TmFtZTogdHJ1ZSxcbiAgICAgICAgICAgICAgICBhdmF0YXJVcmw6IHRydWUsXG4gICAgICAgICAgICAgICAgcm9sZTogdHJ1ZSxcbiAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgICAgbWVzc2FnZXM6IHtcbiAgICAgICAgICB0YWtlOiAxLFxuICAgICAgICAgIG9yZGVyQnk6IHsgY3JlYXRlZEF0OiAnZGVzYycgfSxcbiAgICAgICAgICB3aGVyZTogeyBpc0RlbGV0ZWQ6IGZhbHNlIH0sXG4gICAgICAgICAgaW5jbHVkZToge1xuICAgICAgICAgICAgc2VuZGVyOiB7XG4gICAgICAgICAgICAgIHNlbGVjdDoge1xuICAgICAgICAgICAgICAgIGlkOiB0cnVlLFxuICAgICAgICAgICAgICAgIGZpcnN0TmFtZTogdHJ1ZSxcbiAgICAgICAgICAgICAgICBsYXN0TmFtZTogdHJ1ZSxcbiAgICAgICAgICAgICAgICBhdmF0YXJVcmw6IHRydWUsXG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICAgIF9jb3VudDoge1xuICAgICAgICAgIHNlbGVjdDoge1xuICAgICAgICAgICAgbWVzc2FnZXM6IHtcbiAgICAgICAgICAgICAgd2hlcmU6IHtcbiAgICAgICAgICAgICAgICBpc0RlbGV0ZWQ6IGZhbHNlLFxuICAgICAgICAgICAgICAgIHJlYWRSZWNlaXB0czoge1xuICAgICAgICAgICAgICAgICAgbm9uZTogeyB1c2VySWQgfSxcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgfSxcbiAgICAgIG9yZGVyQnk6IHsgbGFzdE1lc3NhZ2VBdDogJ2Rlc2MnIH0sXG4gICAgICBza2lwLFxuICAgICAgdGFrZTogbGltaXQsXG4gICAgfSk7XG5cbiAgICByZXR1cm4gY29udmVyc2F0aW9ucztcbiAgfVxuXG4gIC8vIE1lc3NhZ2UgTWFuYWdlbWVudFxuICBhc3luYyBzZW5kTWVzc2FnZShcbiAgICB1c2VySWQ6IHN0cmluZyxcbiAgICBjb252ZXJzYXRpb25JZDogc3RyaW5nLFxuICAgIHNlbmRNZXNzYWdlRHRvOiBTZW5kTWVzc2FnZUR0byxcbiAgICBhdHRhY2htZW50VXJsczogc3RyaW5nW10gPSBbXSxcbiAgICBhdHRhY2htZW50TmFtZXM6IHN0cmluZ1tdID0gW10sXG4gICAgYXR0YWNobWVudFNpemVzOiBudW1iZXJbXSA9IFtdLFxuICApIHtcbiAgICAvLyBWZXJpZnkgdXNlciBpcyBwYXJ0aWNpcGFudCBpbiBjb252ZXJzYXRpb25cbiAgICBhd2FpdCB0aGlzLnZlcmlmeVBhcnRpY2lwYW50KHVzZXJJZCwgY29udmVyc2F0aW9uSWQpO1xuXG4gICAgY29uc3Qge1xuICAgICAgY29udGVudCxcbiAgICAgIG1lc3NhZ2VUeXBlID0gTWVzc2FnZVR5cGUuVEVYVCxcbiAgICAgIHJlcGx5VG9JZCxcbiAgICAgIGF0dGFjaG1lbnRVcmwsXG4gICAgICBhdHRhY2htZW50TmFtZSxcbiAgICAgIGF0dGFjaG1lbnRTaXplLFxuICAgIH0gPSBzZW5kTWVzc2FnZUR0bztcblxuICAgIC8vIEdldCBjb252ZXJzYXRpb24gZGV0YWlscyB0byBkZXRlcm1pbmUgZW5jcnlwdGlvbiB0eXBlXG4gICAgY29uc3QgY29udmVyc2F0aW9uID0gYXdhaXQgdGhpcy5wcmlzbWEuY29udmVyc2F0aW9uLmZpbmRVbmlxdWUoe1xuICAgICAgd2hlcmU6IHsgaWQ6IGNvbnZlcnNhdGlvbklkIH0sXG4gICAgICBpbmNsdWRlOiB7XG4gICAgICAgIHBhcnRpY2lwYW50czoge1xuICAgICAgICAgIGluY2x1ZGU6IHtcbiAgICAgICAgICAgIHVzZXI6IHtcbiAgICAgICAgICAgICAgc2VsZWN0OiB7IHJvbGU6IHRydWUgfSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICBpZiAoIWNvbnZlcnNhdGlvbikge1xuICAgICAgdGhyb3cgbmV3IE5vdEZvdW5kRXhjZXB0aW9uKCdDb252ZXJzYXRpb24gbm90IGZvdW5kJyk7XG4gICAgfVxuXG4gICAgLy8gRGV0ZXJtaW5lIGVuY3J5cHRpb24gdHlwZSBiYXNlZCBvbiBjb252ZXJzYXRpb24gcGFydGljaXBhbnRzXG4gICAgY29uc3QgY29udmVyc2F0aW9uVHlwZSA9IHRoaXMubWVzc2FnZUVuY3J5cHRpb24uZ2V0Q29udmVyc2F0aW9uVHlwZShcbiAgICAgIGNvbnZlcnNhdGlvbi5wYXJ0aWNpcGFudHMubWFwKChwKSA9PiAoeyByb2xlOiBwLnVzZXIucm9sZSB9KSksXG4gICAgKTtcblxuICAgIC8vIEVuY3J5cHQgbWVzc2FnZSBjb250ZW50IGZvciBzZW5zaXRpdmUgY29udmVyc2F0aW9uc1xuICAgIGxldCBmaW5hbENvbnRlbnQgPSBjb250ZW50O1xuICAgIGxldCBlbmNyeXB0aW9uRGF0YTogRW5jcnlwdGVkTWVzc2FnZSB8IG51bGwgPSBudWxsO1xuXG4gICAgaWYgKG1lc3NhZ2VUeXBlID09PSBNZXNzYWdlVHlwZS5URVhUICYmIGNvbnRlbnQudHJpbSgpLmxlbmd0aCA+IDApIHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGVuY3J5cHRpb25EYXRhID0gYXdhaXQgdGhpcy5tZXNzYWdlRW5jcnlwdGlvbi5lbmNyeXB0TWVzc2FnZShcbiAgICAgICAgICBjb250ZW50LFxuICAgICAgICAgIGNvbnZlcnNhdGlvblR5cGUsXG4gICAgICAgICk7XG4gICAgICAgIGZpbmFsQ29udGVudCA9IGVuY3J5cHRpb25EYXRhLmVuY3J5cHRlZENvbnRlbnQ7IC8vIFN0b3JlIGVuY3J5cHRlZCBjb250ZW50XG4gICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICB0aGlzLmxvZ2dlci5lcnJvcihcbiAgICAgICAgICAnTWVzc2FnZSBlbmNyeXB0aW9uIGZhaWxlZCwgc3RvcmluZyBwbGFpbnRleHQ6JyxcbiAgICAgICAgICBlcnJvcixcbiAgICAgICAgKTtcbiAgICAgICAgLy8gRmFsbGJhY2sgdG8gcGxhaW50ZXh0IGlmIGVuY3J5cHRpb24gZmFpbHMgKGxvZyB0aGlzIGZvciBzZWN1cml0eSBhdWRpdClcbiAgICAgIH1cbiAgICB9XG5cbiAgICBjb25zdCBtZXNzYWdlID0gYXdhaXQgdGhpcy5wcmlzbWEubWVzc2FnZS5jcmVhdGUoe1xuICAgICAgZGF0YToge1xuICAgICAgICBjb252ZXJzYXRpb25JZCxcbiAgICAgICAgc2VuZGVySWQ6IHVzZXJJZCxcbiAgICAgICAgY29udGVudDogZmluYWxDb250ZW50LCAvLyBTdG9yZSBlbmNyeXB0ZWQgY29udGVudFxuICAgICAgICBtZXNzYWdlVHlwZSxcbiAgICAgICAgcmVwbHlUb0lkLFxuICAgICAgICAvLyBLZWVwIGJhY2t3YXJkIGNvbXBhdGliaWxpdHkgd2l0aCBzaW5nbGUgYXR0YWNobWVudCBmaWVsZHNcbiAgICAgICAgYXR0YWNobWVudFVybDogYXR0YWNobWVudFVybHNbMF0gfHwgYXR0YWNobWVudFVybCxcbiAgICAgICAgYXR0YWNobWVudE5hbWU6IGF0dGFjaG1lbnROYW1lc1swXSB8fCBhdHRhY2htZW50TmFtZSxcbiAgICAgICAgYXR0YWNobWVudFNpemU6IGF0dGFjaG1lbnRTaXplc1swXSB8fCBhdHRhY2htZW50U2l6ZSxcbiAgICAgICAgLy8gQWRkIG5ldyBtdWx0aXBsZSBhdHRhY2htZW50IGZpZWxkc1xuICAgICAgICBhdHRhY2htZW50VXJscyxcbiAgICAgICAgYXR0YWNobWVudE5hbWVzLFxuICAgICAgICBhdHRhY2htZW50U2l6ZXMsXG4gICAgICAgIC8vIFN0b3JlIGVuY3J5cHRpb24gbWV0YWRhdGFcbiAgICAgICAgZW5jcnlwdGlvbkl2OiBlbmNyeXB0aW9uRGF0YT8uaXYsXG4gICAgICAgIGVuY3J5cHRpb25BdXRoVGFnOiBlbmNyeXB0aW9uRGF0YT8uYXV0aFRhZyxcbiAgICAgICAgZW5jcnlwdGlvbktleUlkOiBlbmNyeXB0aW9uRGF0YT8ua2V5SWQsXG4gICAgICAgIGlzRW5jcnlwdGVkOiAhIWVuY3J5cHRpb25EYXRhLFxuICAgICAgfSxcbiAgICAgIGluY2x1ZGU6IHtcbiAgICAgICAgc2VuZGVyOiB7XG4gICAgICAgICAgc2VsZWN0OiB7XG4gICAgICAgICAgICBpZDogdHJ1ZSxcbiAgICAgICAgICAgIGZpcnN0TmFtZTogdHJ1ZSxcbiAgICAgICAgICAgIGxhc3ROYW1lOiB0cnVlLFxuICAgICAgICAgICAgYXZhdGFyVXJsOiB0cnVlLFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICAgIHJlcGx5VG86IHtcbiAgICAgICAgICBpbmNsdWRlOiB7XG4gICAgICAgICAgICBzZW5kZXI6IHtcbiAgICAgICAgICAgICAgc2VsZWN0OiB7XG4gICAgICAgICAgICAgICAgaWQ6IHRydWUsXG4gICAgICAgICAgICAgICAgZmlyc3ROYW1lOiB0cnVlLFxuICAgICAgICAgICAgICAgIGxhc3ROYW1lOiB0cnVlLFxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgICByZWFjdGlvbnM6IHtcbiAgICAgICAgICBpbmNsdWRlOiB7XG4gICAgICAgICAgICB1c2VyOiB7XG4gICAgICAgICAgICAgIHNlbGVjdDoge1xuICAgICAgICAgICAgICAgIGlkOiB0cnVlLFxuICAgICAgICAgICAgICAgIGZpcnN0TmFtZTogdHJ1ZSxcbiAgICAgICAgICAgICAgICBsYXN0TmFtZTogdHJ1ZSxcbiAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICAvLyBVcGRhdGUgY29udmVyc2F0aW9uIGxhc3RNZXNzYWdlQXRcbiAgICBhd2FpdCB0aGlzLnByaXNtYS5jb252ZXJzYXRpb24udXBkYXRlKHtcbiAgICAgIHdoZXJlOiB7IGlkOiBjb252ZXJzYXRpb25JZCB9LFxuICAgICAgZGF0YTogeyBsYXN0TWVzc2FnZUF0OiBuZXcgRGF0ZSgpIH0sXG4gICAgfSk7XG5cbiAgICAvLyBGb3IgZW5jcnlwdGVkIG1lc3NhZ2VzLCB3ZSBuZWVkIHRvIGRlY3J5cHQgZm9yIGV2ZW50IGVtaXNzaW9uXG4gICAgbGV0IGV2ZW50Q29udGVudCA9IGNvbnRlbnQ7IC8vIE9yaWdpbmFsIHBsYWludGV4dCBmb3IgZXZlbnRzXG4gICAgaWYgKG1lc3NhZ2UuaXNFbmNyeXB0ZWQgJiYgZW5jcnlwdGlvbkRhdGEpIHtcbiAgICAgIC8vIEV2ZW50cyBzaG91bGQgY29udGFpbiBwbGFpbnRleHQgZm9yIHByb2Nlc3NpbmdcbiAgICAgIGV2ZW50Q29udGVudCA9IGNvbnRlbnQ7XG4gICAgfVxuXG4gICAgY29uc3QgcmVjaXBpZW50SWRzID1cbiAgICAgIGNvbnZlcnNhdGlvbj8ucGFydGljaXBhbnRzXG4gICAgICAgIC5tYXAoKHApID0+IHAudXNlcklkKVxuICAgICAgICAuZmlsdGVyKChpZCkgPT4gaWQgIT09IHVzZXJJZCkgfHwgW107XG5cbiAgICAvLyBQdWJsaXNoIG1lc3NhZ2Ugc2VudCBldmVudFxuICAgIGF3YWl0IHRoaXMuZXZlbnRCdXMuZW1pdChcbiAgICAgIG5ldyBNZXNzYWdlU2VudEV2ZW50KHtcbiAgICAgICAgbWVzc2FnZUlkOiBtZXNzYWdlLmlkLFxuICAgICAgICBjb252ZXJzYXRpb25JZCxcbiAgICAgICAgc2VuZGVySWQ6IHVzZXJJZCxcbiAgICAgICAgY29udGVudDogZXZlbnRDb250ZW50LCAvLyBVc2Ugb3JpZ2luYWwgcGxhaW50ZXh0IGZvciBldmVudHNcbiAgICAgICAgbWVzc2FnZVR5cGU6IG1lc3NhZ2UubWVzc2FnZVR5cGUudG9Mb3dlckNhc2UoKSBhc1xuICAgICAgICAgIHwgJ3RleHQnXG4gICAgICAgICAgfCAnaW1hZ2UnXG4gICAgICAgICAgfCAnZmlsZSdcbiAgICAgICAgICB8ICdhdWRpbydcbiAgICAgICAgICB8ICd2aWRlbydcbiAgICAgICAgICB8ICdzeXN0ZW0nLFxuICAgICAgICBzZW50QXQ6IG1lc3NhZ2UuY3JlYXRlZEF0LFxuICAgICAgICByZWNpcGllbnRJZHMsXG4gICAgICAgIHJlcGx5VG9NZXNzYWdlSWQ6IG1lc3NhZ2UucmVwbHlUb0lkIHx8IHVuZGVmaW5lZCxcbiAgICAgICAgZmlsZUF0dGFjaG1lbnRzOlxuICAgICAgICAgIGF0dGFjaG1lbnRVcmxzLmxlbmd0aCA+IDBcbiAgICAgICAgICAgID8gYXR0YWNobWVudFVybHNcbiAgICAgICAgICAgIDogbWVzc2FnZS5hdHRhY2htZW50VXJsXG4gICAgICAgICAgICAgID8gW21lc3NhZ2UuYXR0YWNobWVudFVybF1cbiAgICAgICAgICAgICAgOiB1bmRlZmluZWQsXG4gICAgICAgIGlzRW5jcnlwdGVkOiBtZXNzYWdlLmlzRW5jcnlwdGVkLFxuICAgICAgfSksXG4gICAgKTtcblxuICAgIC8vIFJldHVybiBtZXNzYWdlIHdpdGggZGVjcnlwdGVkIGNvbnRlbnQgZm9yIGltbWVkaWF0ZSBkaXNwbGF5XG4gICAgcmV0dXJuIHtcbiAgICAgIC4uLm1lc3NhZ2UsXG4gICAgICBjb250ZW50OiBldmVudENvbnRlbnQsIC8vIFJldHVybiBwbGFpbnRleHQgY29udGVudFxuICAgIH07XG4gIH1cblxuICBhc3luYyBnZXRDb252ZXJzYXRpb25NZXNzYWdlcyhcbiAgICB1c2VySWQ6IHN0cmluZyxcbiAgICBjb252ZXJzYXRpb25JZDogc3RyaW5nLFxuICAgIHBhZ2UgPSAxLFxuICAgIGxpbWl0ID0gNTAsXG4gICkge1xuICAgIC8vIFZlcmlmeSB1c2VyIGlzIHBhcnRpY2lwYW50IGluIGNvbnZlcnNhdGlvblxuICAgIGF3YWl0IHRoaXMudmVyaWZ5UGFydGljaXBhbnQodXNlcklkLCBjb252ZXJzYXRpb25JZCk7XG5cbiAgICBjb25zdCBza2lwID0gKHBhZ2UgLSAxKSAqIGxpbWl0O1xuXG4gICAgY29uc3QgbWVzc2FnZXMgPSBhd2FpdCB0aGlzLnByaXNtYS5tZXNzYWdlLmZpbmRNYW55KHtcbiAgICAgIHdoZXJlOiB7XG4gICAgICAgIGNvbnZlcnNhdGlvbklkLFxuICAgICAgICBpc0RlbGV0ZWQ6IGZhbHNlLFxuICAgICAgfSxcbiAgICAgIGluY2x1ZGU6IHtcbiAgICAgICAgc2VuZGVyOiB7XG4gICAgICAgICAgc2VsZWN0OiB7XG4gICAgICAgICAgICBpZDogdHJ1ZSxcbiAgICAgICAgICAgIGZpcnN0TmFtZTogdHJ1ZSxcbiAgICAgICAgICAgIGxhc3ROYW1lOiB0cnVlLFxuICAgICAgICAgICAgYXZhdGFyVXJsOiB0cnVlLFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICAgIHJlcGx5VG86IHtcbiAgICAgICAgICBpbmNsdWRlOiB7XG4gICAgICAgICAgICBzZW5kZXI6IHtcbiAgICAgICAgICAgICAgc2VsZWN0OiB7XG4gICAgICAgICAgICAgICAgaWQ6IHRydWUsXG4gICAgICAgICAgICAgICAgZmlyc3ROYW1lOiB0cnVlLFxuICAgICAgICAgICAgICAgIGxhc3ROYW1lOiB0cnVlLFxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgICByZWFjdGlvbnM6IHtcbiAgICAgICAgICBpbmNsdWRlOiB7XG4gICAgICAgICAgICB1c2VyOiB7XG4gICAgICAgICAgICAgIHNlbGVjdDoge1xuICAgICAgICAgICAgICAgIGlkOiB0cnVlLFxuICAgICAgICAgICAgICAgIGZpcnN0TmFtZTogdHJ1ZSxcbiAgICAgICAgICAgICAgICBsYXN0TmFtZTogdHJ1ZSxcbiAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgICAgcmVhZFJlY2VpcHRzOiB7XG4gICAgICAgICAgaW5jbHVkZToge1xuICAgICAgICAgICAgdXNlcjoge1xuICAgICAgICAgICAgICBzZWxlY3Q6IHtcbiAgICAgICAgICAgICAgICBpZDogdHJ1ZSxcbiAgICAgICAgICAgICAgICBmaXJzdE5hbWU6IHRydWUsXG4gICAgICAgICAgICAgICAgbGFzdE5hbWU6IHRydWUsXG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgICAgb3JkZXJCeTogeyBjcmVhdGVkQXQ6ICdkZXNjJyB9LFxuICAgICAgc2tpcCxcbiAgICAgIHRha2U6IGxpbWl0LFxuICAgIH0pO1xuXG4gICAgLy8gRGVjcnlwdCBtZXNzYWdlcyBpZiB0aGV5IGFyZSBlbmNyeXB0ZWRcbiAgICBjb25zdCBkZWNyeXB0ZWRNZXNzYWdlcyA9IGF3YWl0IFByb21pc2UuYWxsKFxuICAgICAgbWVzc2FnZXMubWFwKGFzeW5jIChtZXNzYWdlKSA9PiB7XG4gICAgICAgIGlmIChcbiAgICAgICAgICBtZXNzYWdlLmlzRW5jcnlwdGVkICYmXG4gICAgICAgICAgbWVzc2FnZS5lbmNyeXB0aW9uSXYgJiZcbiAgICAgICAgICBtZXNzYWdlLmVuY3J5cHRpb25BdXRoVGFnICYmXG4gICAgICAgICAgbWVzc2FnZS5lbmNyeXB0aW9uS2V5SWRcbiAgICAgICAgKSB7XG4gICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGNvbnN0IGVuY3J5cHRlZE1lc3NhZ2UgPSB7XG4gICAgICAgICAgICAgIGVuY3J5cHRlZENvbnRlbnQ6IG1lc3NhZ2UuY29udGVudCxcbiAgICAgICAgICAgICAgaXY6IG1lc3NhZ2UuZW5jcnlwdGlvbkl2LFxuICAgICAgICAgICAgICBhdXRoVGFnOiBtZXNzYWdlLmVuY3J5cHRpb25BdXRoVGFnLFxuICAgICAgICAgICAgICBrZXlJZDogbWVzc2FnZS5lbmNyeXB0aW9uS2V5SWQsXG4gICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICBjb25zdCBkZWNyeXB0ZWQgPVxuICAgICAgICAgICAgICBhd2FpdCB0aGlzLm1lc3NhZ2VFbmNyeXB0aW9uLmRlY3J5cHRNZXNzYWdlKGVuY3J5cHRlZE1lc3NhZ2UpO1xuICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgLi4ubWVzc2FnZSxcbiAgICAgICAgICAgICAgY29udGVudDogZGVjcnlwdGVkLmNvbnRlbnQsXG4gICAgICAgICAgICB9O1xuICAgICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICB0aGlzLmxvZ2dlci5lcnJvcihcbiAgICAgICAgICAgICAgYEZhaWxlZCB0byBkZWNyeXB0IG1lc3NhZ2UgJHttZXNzYWdlLmlkfTpgLFxuICAgICAgICAgICAgICBlcnJvcixcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAuLi5tZXNzYWdlLFxuICAgICAgICAgICAgICBjb250ZW50OiAnW01lc3NhZ2UgY291bGQgbm90IGJlIGRlY3J5cHRlZF0nLFxuICAgICAgICAgICAgfTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIG1lc3NhZ2U7XG4gICAgICB9KSxcbiAgICApO1xuXG4gICAgcmV0dXJuIGRlY3J5cHRlZE1lc3NhZ2VzLnJldmVyc2UoKTsgLy8gUmV0dXJuIGluIGNocm9ub2xvZ2ljYWwgb3JkZXJcbiAgfVxuXG4gIGFzeW5jIHVwZGF0ZU1lc3NhZ2UoXG4gICAgdXNlcklkOiBzdHJpbmcsXG4gICAgbWVzc2FnZUlkOiBzdHJpbmcsXG4gICAgdXBkYXRlTWVzc2FnZUR0bzogVXBkYXRlTWVzc2FnZUR0byxcbiAgKSB7XG4gICAgY29uc3QgbWVzc2FnZSA9IGF3YWl0IHRoaXMucHJpc21hLm1lc3NhZ2UuZmluZFVuaXF1ZSh7XG4gICAgICB3aGVyZTogeyBpZDogbWVzc2FnZUlkIH0sXG4gICAgfSk7XG5cbiAgICBpZiAoIW1lc3NhZ2UpIHtcbiAgICAgIHRocm93IG5ldyBOb3RGb3VuZEV4Y2VwdGlvbignTWVzc2FnZSBub3QgZm91bmQnKTtcbiAgICB9XG5cbiAgICBpZiAobWVzc2FnZS5zZW5kZXJJZCAhPT0gdXNlcklkKSB7XG4gICAgICB0aHJvdyBuZXcgRm9yYmlkZGVuRXhjZXB0aW9uKCdZb3UgY2FuIG9ubHkgZWRpdCB5b3VyIG93biBtZXNzYWdlcycpO1xuICAgIH1cblxuICAgIGlmIChtZXNzYWdlLmlzRGVsZXRlZCkge1xuICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFeGNlcHRpb24oJ0Nhbm5vdCBlZGl0IGRlbGV0ZWQgbWVzc2FnZScpO1xuICAgIH1cblxuICAgIGNvbnN0IHVwZGF0ZWRNZXNzYWdlID0gYXdhaXQgdGhpcy5wcmlzbWEubWVzc2FnZS51cGRhdGUoe1xuICAgICAgd2hlcmU6IHsgaWQ6IG1lc3NhZ2VJZCB9LFxuICAgICAgZGF0YToge1xuICAgICAgICBjb250ZW50OiB1cGRhdGVNZXNzYWdlRHRvLmNvbnRlbnQsXG4gICAgICAgIGlzRWRpdGVkOiB0cnVlLFxuICAgICAgICBlZGl0ZWRBdDogbmV3IERhdGUoKSxcbiAgICAgIH0sXG4gICAgICBpbmNsdWRlOiB7XG4gICAgICAgIHNlbmRlcjoge1xuICAgICAgICAgIHNlbGVjdDoge1xuICAgICAgICAgICAgaWQ6IHRydWUsXG4gICAgICAgICAgICBmaXJzdE5hbWU6IHRydWUsXG4gICAgICAgICAgICBsYXN0TmFtZTogdHJ1ZSxcbiAgICAgICAgICAgIGF2YXRhclVybDogdHJ1ZSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgICByZWFjdGlvbnM6IHtcbiAgICAgICAgICBpbmNsdWRlOiB7XG4gICAgICAgICAgICB1c2VyOiB7XG4gICAgICAgICAgICAgIHNlbGVjdDoge1xuICAgICAgICAgICAgICAgIGlkOiB0cnVlLFxuICAgICAgICAgICAgICAgIGZpcnN0TmFtZTogdHJ1ZSxcbiAgICAgICAgICAgICAgICBsYXN0TmFtZTogdHJ1ZSxcbiAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICByZXR1cm4gdXBkYXRlZE1lc3NhZ2U7XG4gIH1cblxuICBhc3luYyBkZWxldGVNZXNzYWdlKHVzZXJJZDogc3RyaW5nLCBtZXNzYWdlSWQ6IHN0cmluZykge1xuICAgIGNvbnN0IG1lc3NhZ2UgPSBhd2FpdCB0aGlzLnByaXNtYS5tZXNzYWdlLmZpbmRVbmlxdWUoe1xuICAgICAgd2hlcmU6IHsgaWQ6IG1lc3NhZ2VJZCB9LFxuICAgIH0pO1xuXG4gICAgaWYgKCFtZXNzYWdlKSB7XG4gICAgICB0aHJvdyBuZXcgTm90Rm91bmRFeGNlcHRpb24oJ01lc3NhZ2Ugbm90IGZvdW5kJyk7XG4gICAgfVxuXG4gICAgaWYgKG1lc3NhZ2Uuc2VuZGVySWQgIT09IHVzZXJJZCkge1xuICAgICAgdGhyb3cgbmV3IEZvcmJpZGRlbkV4Y2VwdGlvbignWW91IGNhbiBvbmx5IGRlbGV0ZSB5b3VyIG93biBtZXNzYWdlcycpO1xuICAgIH1cblxuICAgIGF3YWl0IHRoaXMucHJpc21hLm1lc3NhZ2UudXBkYXRlKHtcbiAgICAgIHdoZXJlOiB7IGlkOiBtZXNzYWdlSWQgfSxcbiAgICAgIGRhdGE6IHsgaXNEZWxldGVkOiB0cnVlIH0sXG4gICAgfSk7XG5cbiAgICByZXR1cm4geyBzdWNjZXNzOiB0cnVlIH07XG4gIH1cblxuICAvLyBSZWFkIFJlY2VpcHRzXG4gIGFzeW5jIG1hcmtNZXNzYWdlQXNSZWFkKHVzZXJJZDogc3RyaW5nLCBtZXNzYWdlSWQ6IHN0cmluZykge1xuICAgIGNvbnN0IG1lc3NhZ2UgPSBhd2FpdCB0aGlzLnByaXNtYS5tZXNzYWdlLmZpbmRVbmlxdWUoe1xuICAgICAgd2hlcmU6IHsgaWQ6IG1lc3NhZ2VJZCB9LFxuICAgIH0pO1xuXG4gICAgaWYgKCFtZXNzYWdlKSB7XG4gICAgICB0aHJvdyBuZXcgTm90Rm91bmRFeGNlcHRpb24oJ01lc3NhZ2Ugbm90IGZvdW5kJyk7XG4gICAgfVxuXG4gICAgLy8gRG9uJ3QgY3JlYXRlIHJlYWQgcmVjZWlwdCBmb3Igb3duIG1lc3NhZ2VzXG4gICAgaWYgKG1lc3NhZ2Uuc2VuZGVySWQgPT09IHVzZXJJZCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIC8vIFZlcmlmeSB1c2VyIGlzIHBhcnRpY2lwYW50IGluIGNvbnZlcnNhdGlvblxuICAgIGF3YWl0IHRoaXMudmVyaWZ5UGFydGljaXBhbnQodXNlcklkLCBtZXNzYWdlLmNvbnZlcnNhdGlvbklkKTtcblxuICAgIGF3YWl0IHRoaXMucHJpc21hLm1lc3NhZ2VSZWFkUmVjZWlwdC51cHNlcnQoe1xuICAgICAgd2hlcmU6IHtcbiAgICAgICAgbWVzc2FnZUlkX3VzZXJJZDoge1xuICAgICAgICAgIG1lc3NhZ2VJZCxcbiAgICAgICAgICB1c2VySWQsXG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgICAgY3JlYXRlOiB7XG4gICAgICAgIG1lc3NhZ2VJZCxcbiAgICAgICAgdXNlcklkLFxuICAgICAgfSxcbiAgICAgIHVwZGF0ZToge1xuICAgICAgICByZWFkQXQ6IG5ldyBEYXRlKCksXG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgLy8gVXBkYXRlIHBhcnRpY2lwYW50J3MgbGFzdFJlYWRBdFxuICAgIGF3YWl0IHRoaXMucHJpc21hLmNvbnZlcnNhdGlvblBhcnRpY2lwYW50LnVwZGF0ZU1hbnkoe1xuICAgICAgd2hlcmU6IHtcbiAgICAgICAgY29udmVyc2F0aW9uSWQ6IG1lc3NhZ2UuY29udmVyc2F0aW9uSWQsXG4gICAgICAgIHVzZXJJZCxcbiAgICAgIH0sXG4gICAgICBkYXRhOiB7XG4gICAgICAgIGxhc3RSZWFkQXQ6IG5ldyBEYXRlKCksXG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgLy8gUHVibGlzaCBtZXNzYWdlIHJlYWQgZXZlbnRcbiAgICBhd2FpdCB0aGlzLmV2ZW50QnVzLmVtaXQoXG4gICAgICBuZXcgTWVzc2FnZVJlYWRFdmVudCh7XG4gICAgICAgIG1lc3NhZ2VJZCxcbiAgICAgICAgcmVhZEJ5OiB1c2VySWQsXG4gICAgICAgIHJlYWRBdDogbmV3IERhdGUoKSxcbiAgICAgICAgY29udmVyc2F0aW9uSWQ6IG1lc3NhZ2UuY29udmVyc2F0aW9uSWQsXG4gICAgICAgIG1lc3NhZ2VzU2luY2VMYXN0UmVhZDogMSwgLy8gQ291bGQgYmUgZW5oYW5jZWQgdG8gY2FsY3VsYXRlIGFjdHVhbCBjb3VudFxuICAgICAgfSksXG4gICAgKTtcbiAgfVxuXG4gIC8vIE1lc3NhZ2UgUmVhY3Rpb25zXG4gIGFzeW5jIGFkZE1lc3NhZ2VSZWFjdGlvbih1c2VySWQ6IHN0cmluZywgbWVzc2FnZUlkOiBzdHJpbmcsIGVtb2ppOiBzdHJpbmcpIHtcbiAgICBjb25zdCBtZXNzYWdlID0gYXdhaXQgdGhpcy5wcmlzbWEubWVzc2FnZS5maW5kVW5pcXVlKHtcbiAgICAgIHdoZXJlOiB7IGlkOiBtZXNzYWdlSWQgfSxcbiAgICB9KTtcblxuICAgIGlmICghbWVzc2FnZSkge1xuICAgICAgdGhyb3cgbmV3IE5vdEZvdW5kRXhjZXB0aW9uKCdNZXNzYWdlIG5vdCBmb3VuZCcpO1xuICAgIH1cblxuICAgIC8vIFZlcmlmeSB1c2VyIGlzIHBhcnRpY2lwYW50IGluIGNvbnZlcnNhdGlvblxuICAgIGF3YWl0IHRoaXMudmVyaWZ5UGFydGljaXBhbnQodXNlcklkLCBtZXNzYWdlLmNvbnZlcnNhdGlvbklkKTtcblxuICAgIGNvbnN0IHJlYWN0aW9uID0gYXdhaXQgdGhpcy5wcmlzbWEubWVzc2FnZVJlYWN0aW9uLnVwc2VydCh7XG4gICAgICB3aGVyZToge1xuICAgICAgICBtZXNzYWdlSWRfdXNlcklkX2Vtb2ppOiB7XG4gICAgICAgICAgbWVzc2FnZUlkLFxuICAgICAgICAgIHVzZXJJZCxcbiAgICAgICAgICBlbW9qaSxcbiAgICAgICAgfSxcbiAgICAgIH0sXG4gICAgICBjcmVhdGU6IHtcbiAgICAgICAgbWVzc2FnZUlkLFxuICAgICAgICB1c2VySWQsXG4gICAgICAgIGVtb2ppLFxuICAgICAgfSxcbiAgICAgIHVwZGF0ZToge1xuICAgICAgICBlbW9qaSxcbiAgICAgIH0sXG4gICAgICBpbmNsdWRlOiB7XG4gICAgICAgIHVzZXI6IHtcbiAgICAgICAgICBzZWxlY3Q6IHtcbiAgICAgICAgICAgIGlkOiB0cnVlLFxuICAgICAgICAgICAgZmlyc3ROYW1lOiB0cnVlLFxuICAgICAgICAgICAgbGFzdE5hbWU6IHRydWUsXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICByZXR1cm4gcmVhY3Rpb247XG4gIH1cblxuICBhc3luYyByZW1vdmVNZXNzYWdlUmVhY3Rpb24oXG4gICAgdXNlcklkOiBzdHJpbmcsXG4gICAgbWVzc2FnZUlkOiBzdHJpbmcsXG4gICAgZW1vamk6IHN0cmluZyxcbiAgKSB7XG4gICAgYXdhaXQgdGhpcy5wcmlzbWEubWVzc2FnZVJlYWN0aW9uLmRlbGV0ZU1hbnkoe1xuICAgICAgd2hlcmU6IHtcbiAgICAgICAgbWVzc2FnZUlkLFxuICAgICAgICB1c2VySWQsXG4gICAgICAgIGVtb2ppLFxuICAgICAgfSxcbiAgICB9KTtcblxuICAgIHJldHVybiB7IHN1Y2Nlc3M6IHRydWUgfTtcbiAgfVxuXG4gIC8vIFVzZXIgQmxvY2tpbmdcbiAgYXN5bmMgYmxvY2tVc2VyKGJsb2NrZXJJZDogc3RyaW5nLCBibG9ja2VkSWQ6IHN0cmluZywgcmVhc29uPzogc3RyaW5nKSB7XG4gICAgaWYgKGJsb2NrZXJJZCA9PT0gYmxvY2tlZElkKSB7XG4gICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdEV4Y2VwdGlvbignQ2Fubm90IGJsb2NrIHlvdXJzZWxmJyk7XG4gICAgfVxuXG4gICAgYXdhaXQgdGhpcy5wcmlzbWEudXNlckJsb2NrLnVwc2VydCh7XG4gICAgICB3aGVyZToge1xuICAgICAgICBibG9ja2VySWRfYmxvY2tlZElkOiB7XG4gICAgICAgICAgYmxvY2tlcklkLFxuICAgICAgICAgIGJsb2NrZWRJZCxcbiAgICAgICAgfSxcbiAgICAgIH0sXG4gICAgICBjcmVhdGU6IHtcbiAgICAgICAgYmxvY2tlcklkLFxuICAgICAgICBibG9ja2VkSWQsXG4gICAgICAgIHJlYXNvbixcbiAgICAgIH0sXG4gICAgICB1cGRhdGU6IHtcbiAgICAgICAgcmVhc29uLFxuICAgICAgfSxcbiAgICB9KTtcblxuICAgIHJldHVybiB7IHN1Y2Nlc3M6IHRydWUgfTtcbiAgfVxuXG4gIGFzeW5jIHVuYmxvY2tVc2VyKGJsb2NrZXJJZDogc3RyaW5nLCBibG9ja2VkSWQ6IHN0cmluZykge1xuICAgIGF3YWl0IHRoaXMucHJpc21hLnVzZXJCbG9jay5kZWxldGVNYW55KHtcbiAgICAgIHdoZXJlOiB7XG4gICAgICAgIGJsb2NrZXJJZCxcbiAgICAgICAgYmxvY2tlZElkLFxuICAgICAgfSxcbiAgICB9KTtcblxuICAgIHJldHVybiB7IHN1Y2Nlc3M6IHRydWUgfTtcbiAgfVxuXG4gIC8vIEhlbHBlciBNZXRob2RzXG4gIHByaXZhdGUgYXN5bmMgZmluZERpcmVjdENvbnZlcnNhdGlvbih1c2VyMUlkOiBzdHJpbmcsIHVzZXIySWQ6IHN0cmluZykge1xuICAgIHJldHVybiB0aGlzLnByaXNtYS5jb252ZXJzYXRpb24uZmluZEZpcnN0KHtcbiAgICAgIHdoZXJlOiB7XG4gICAgICAgIHR5cGU6IENvbnZlcnNhdGlvblR5cGUuRElSRUNULFxuICAgICAgICBwYXJ0aWNpcGFudHM6IHtcbiAgICAgICAgICBldmVyeToge1xuICAgICAgICAgICAgdXNlcklkOiB7IGluOiBbdXNlcjFJZCwgdXNlcjJJZF0gfSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgfSxcbiAgICAgIGluY2x1ZGU6IHtcbiAgICAgICAgcGFydGljaXBhbnRzOiB7XG4gICAgICAgICAgaW5jbHVkZToge1xuICAgICAgICAgICAgdXNlcjoge1xuICAgICAgICAgICAgICBzZWxlY3Q6IHtcbiAgICAgICAgICAgICAgICBpZDogdHJ1ZSxcbiAgICAgICAgICAgICAgICBmaXJzdE5hbWU6IHRydWUsXG4gICAgICAgICAgICAgICAgbGFzdE5hbWU6IHRydWUsXG4gICAgICAgICAgICAgICAgYXZhdGFyVXJsOiB0cnVlLFxuICAgICAgICAgICAgICAgIHJvbGU6IHRydWUsXG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyB2ZXJpZnlQYXJ0aWNpcGFudCh1c2VySWQ6IHN0cmluZywgY29udmVyc2F0aW9uSWQ6IHN0cmluZykge1xuICAgIGNvbnN0IHBhcnRpY2lwYW50ID0gYXdhaXQgdGhpcy5wcmlzbWEuY29udmVyc2F0aW9uUGFydGljaXBhbnQuZmluZFVuaXF1ZSh7XG4gICAgICB3aGVyZToge1xuICAgICAgICBjb252ZXJzYXRpb25JZF91c2VySWQ6IHtcbiAgICAgICAgICBjb252ZXJzYXRpb25JZCxcbiAgICAgICAgICB1c2VySWQsXG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgaWYgKCFwYXJ0aWNpcGFudCB8fCAhcGFydGljaXBhbnQuaXNBY3RpdmUpIHtcbiAgICAgIHRocm93IG5ldyBGb3JiaWRkZW5FeGNlcHRpb24oXG4gICAgICAgICdZb3UgYXJlIG5vdCBhIHBhcnRpY2lwYW50IGluIHRoaXMgY29udmVyc2F0aW9uJyxcbiAgICAgICk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHBhcnRpY2lwYW50O1xuICB9XG5cbiAgLy8gU2VhcmNoIE1lc3NhZ2VzXG4gIGFzeW5jIHNlYXJjaE1lc3NhZ2VzKFxuICAgIHVzZXJJZDogc3RyaW5nLFxuICAgIHF1ZXJ5OiBzdHJpbmcsXG4gICAgY29udmVyc2F0aW9uSWQ/OiBzdHJpbmcsXG4gICAgcGFnZSA9IDEsXG4gICAgbGltaXQgPSAyMCxcbiAgKSB7XG4gICAgY29uc3Qgc2tpcCA9IChwYWdlIC0gMSkgKiBsaW1pdDtcblxuICAgIGNvbnN0IHdoZXJlQ2xhdXNlOiBhbnkgPSB7XG4gICAgICBjb250ZW50OiB7XG4gICAgICAgIGNvbnRhaW5zOiBxdWVyeSxcbiAgICAgICAgbW9kZTogJ2luc2Vuc2l0aXZlJyxcbiAgICAgIH0sXG4gICAgICBpc0RlbGV0ZWQ6IGZhbHNlLFxuICAgICAgY29udmVyc2F0aW9uOiB7XG4gICAgICAgIHBhcnRpY2lwYW50czoge1xuICAgICAgICAgIHNvbWU6IHtcbiAgICAgICAgICAgIHVzZXJJZCxcbiAgICAgICAgICAgIGlzQWN0aXZlOiB0cnVlLFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgIH07XG5cbiAgICBpZiAoY29udmVyc2F0aW9uSWQpIHtcbiAgICAgIHdoZXJlQ2xhdXNlLmNvbnZlcnNhdGlvbklkID0gY29udmVyc2F0aW9uSWQ7XG4gICAgfVxuXG4gICAgY29uc3QgbWVzc2FnZXMgPSBhd2FpdCB0aGlzLnByaXNtYS5tZXNzYWdlLmZpbmRNYW55KHtcbiAgICAgIHdoZXJlOiB3aGVyZUNsYXVzZSxcbiAgICAgIGluY2x1ZGU6IHtcbiAgICAgICAgc2VuZGVyOiB7XG4gICAgICAgICAgc2VsZWN0OiB7XG4gICAgICAgICAgICBpZDogdHJ1ZSxcbiAgICAgICAgICAgIGZpcnN0TmFtZTogdHJ1ZSxcbiAgICAgICAgICAgIGxhc3ROYW1lOiB0cnVlLFxuICAgICAgICAgICAgYXZhdGFyVXJsOiB0cnVlLFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICAgIGNvbnZlcnNhdGlvbjoge1xuICAgICAgICAgIHNlbGVjdDoge1xuICAgICAgICAgICAgaWQ6IHRydWUsXG4gICAgICAgICAgICB0eXBlOiB0cnVlLFxuICAgICAgICAgICAgdGl0bGU6IHRydWUsXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgIH0sXG4gICAgICBvcmRlckJ5OiB7IGNyZWF0ZWRBdDogJ2Rlc2MnIH0sXG4gICAgICBza2lwLFxuICAgICAgdGFrZTogbGltaXQsXG4gICAgfSk7XG5cbiAgICByZXR1cm4gbWVzc2FnZXM7XG4gIH1cbn1cbiJdLCJ2ZXJzaW9uIjozfQ==