{"file":"/home/wetooa/Documents/code/projects/mentara/mentara-api/src/users/users.controller.ts","mappings":"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","names":[],"sources":["/home/wetooa/Documents/code/projects/mentara/mentara-api/src/users/users.controller.ts"],"sourcesContent":["import {\n  Body,\n  Controller,\n  Delete,\n  Get,\n  HttpException,\n  HttpStatus,\n  Param,\n  Put,\n  Post,\n  UseGuards,\n  UseInterceptors,\n  UploadedFiles,\n  Logger,\n  ForbiddenException,\n} from '@nestjs/common';\nimport { FileFieldsInterceptor } from '@nestjs/platform-express';\nimport { JwtAuthGuard } from 'src/auth/guards/jwt-auth.guard';\nimport { CurrentUserId } from 'src/auth/decorators/current-user-id.decorator';\nimport { CurrentUserRole } from 'src/auth/decorators/current-user-role.decorator';\nimport { ZodValidationPipe } from 'src/common/pipes/zod-validation.pipe';\nimport {\n  UserIdParamSchema,\n  DeactivateUserDtoSchema,\n  UpdateUserRequestSchema,\n} from './validation';\nimport type {\n  UserIdParam,\n  DeactivateUserDto,\n  UpdateUserRequest,\n  UserDto,\n} from './types';\nimport { UsersService } from './users.service';\nimport { SupabaseStorageService } from 'src/common/services/supabase-storage.service';\nimport { RoleUtils } from 'src/utils/role-utils';\nimport { UserResponseDto, SuccessMessageDto } from 'src/common/dto';\n\n@Controller('users')\n@UseGuards(JwtAuthGuard)\nexport class UsersController {\n  private readonly logger = new Logger(UsersController.name);\n\n  constructor(\n    private readonly usersService: UsersService,\n    private readonly supabaseStorageService: SupabaseStorageService,\n    private readonly roleUtils: RoleUtils,\n  ) {}\n\n  @Get()\n  async findAll(\n    @CurrentUserId() currentUserId: string,\n    @CurrentUserRole() role: string,\n  ): Promise<UserDto[]> {\n    if (role !== 'admin') {\n      throw new ForbiddenException('Admin access required');\n    }\n    try {\n      this.logger.log(`Admin ${currentUserId} retrieving all users`);\n      const users = await this.usersService.findAll();\n      return UserResponseDto.fromPrismaUsers(users);\n    } catch (error) {\n      this.logger.error('Failed to fetch users:', error);\n      throw new HttpException(\n        `Failed to fetch users: ${error instanceof Error ? error.message : 'Unknown error'}`,\n        HttpStatus.INTERNAL_SERVER_ERROR,\n      );\n    }\n  }\n\n  @Get('all-including-inactive')\n  async findAllIncludeInactive(\n    @CurrentUserId() currentUserId: string,\n    @CurrentUserRole() role: string,\n  ): Promise<UserDto[]> {\n    if (role !== 'admin') {\n      throw new ForbiddenException('Admin access required');\n    }\n    try {\n      this.logger.log(\n        `Admin ${currentUserId} retrieving all users including inactive`,\n      );\n      const users = await this.usersService.findAllIncludeInactive();\n      return UserResponseDto.fromPrismaUsers(users);\n    } catch (error) {\n      this.logger.error('Failed to fetch all users:', error);\n      throw new HttpException(\n        `Failed to fetch users: ${error instanceof Error ? error.message : 'Unknown error'}`,\n        HttpStatus.INTERNAL_SERVER_ERROR,\n      );\n    }\n  }\n\n  @Get(':id')\n  async findOne(\n    @Param(new ZodValidationPipe(UserIdParamSchema)) params: UserIdParam,\n    @CurrentUserId() currentUserId: string,\n  ): Promise<UserDto> {\n    try {\n      // Users can only view their own profile unless they're admin\n      const isAdmin = await this.roleUtils.isUserAdmin(currentUserId);\n\n      if (!isAdmin && params.id !== currentUserId) {\n        throw new ForbiddenException('You can only access your own profile');\n      }\n\n      const user = isAdmin\n        ? await this.usersService.findOneIncludeInactive(params.id)\n        : await this.usersService.findOne(params.id);\n\n      if (!user) {\n        throw new HttpException('User not found', HttpStatus.NOT_FOUND);\n      }\n      return UserResponseDto.fromPrismaUser(user);\n    } catch (error) {\n      if (\n        error instanceof ForbiddenException ||\n        error instanceof HttpException\n      ) {\n        throw error;\n      }\n      this.logger.error('Failed to fetch user:', error);\n      throw new HttpException(\n        `Failed to fetch user: ${error instanceof Error ? error.message : 'Unknown error'}`,\n        HttpStatus.INTERNAL_SERVER_ERROR,\n      );\n    }\n  }\n\n  @Put(':id')\n  @UseInterceptors(\n    FileFieldsInterceptor([\n      { name: 'avatar', maxCount: 1 },\n      { name: 'cover', maxCount: 1 },\n    ]),\n  )\n  async update(\n    @Param(new ZodValidationPipe(UserIdParamSchema)) params: UserIdParam,\n    @Body(new ZodValidationPipe(UpdateUserRequestSchema))\n    userData: UpdateUserRequest,\n    @CurrentUserId() currentUserId: string,\n    @UploadedFiles()\n    files?: { avatar?: Express.Multer.File[]; cover?: Express.Multer.File[] },\n  ): Promise<UserDto> {\n    try {\n      // Users can only update their own profile unless they're admin\n      const isAdmin = await this.roleUtils.isUserAdmin(currentUserId);\n\n      if (!isAdmin && params.id !== currentUserId) {\n        throw new ForbiddenException('You can only update your own profile');\n      }\n\n      // Handle file uploads if provided\n      let avatarUrl: string | undefined;\n      let coverImageUrl: string | undefined;\n\n      if (files?.avatar?.[0]) {\n        const validation = this.supabaseStorageService.validateFile(\n          files.avatar[0],\n        );\n        if (!validation.isValid) {\n          throw new HttpException(\n            `Avatar validation failed: ${validation.error}`,\n            HttpStatus.BAD_REQUEST,\n          );\n        }\n        const uploadResult = await this.supabaseStorageService.uploadFile(\n          files.avatar[0],\n          SupabaseStorageService.getSupportedBuckets().USER_PROFILES,\n        );\n        avatarUrl = uploadResult.url;\n      }\n\n      if (files?.cover?.[0]) {\n        const validation = this.supabaseStorageService.validateFile(\n          files.cover[0],\n        );\n        if (!validation.isValid) {\n          throw new HttpException(\n            `Cover image validation failed: ${validation.error}`,\n            HttpStatus.BAD_REQUEST,\n          );\n        }\n        const uploadResult = await this.supabaseStorageService.uploadFile(\n          files.cover[0],\n          SupabaseStorageService.getSupportedBuckets().USER_PROFILES,\n        );\n        coverImageUrl = uploadResult.url;\n      }\n\n      // Prevent non-admins from changing sensitive fields\n      if (!isAdmin) {\n        const allowedFields = [\n          'firstName',\n          'middleName',\n          'lastName',\n          'birthDate',\n          'address',\n          'bio',\n          'avatarUrl',\n          'coverImageUrl',\n          'phoneNumber',\n          'timezone',\n          'language',\n          'theme',\n        ];\n        const sanitizedData: Partial<UpdateUserRequest> = {};\n\n        for (const field of allowedFields) {\n          if (userData[field as keyof UpdateUserRequest] !== undefined) {\n            (sanitizedData as any)[field] =\n              userData[field as keyof UpdateUserRequest];\n          }\n        }\n        userData = sanitizedData as UpdateUserRequest;\n      }\n\n      // Add uploaded file URLs to userData\n      if (avatarUrl) userData.avatarUrl = avatarUrl;\n      if (coverImageUrl) userData.coverImageUrl = coverImageUrl;\n\n      const updatedUser = await this.usersService.update(params.id, userData);\n      return UserResponseDto.fromPrismaUser(updatedUser);\n    } catch (error) {\n      if (error instanceof ForbiddenException) {\n        throw error;\n      }\n      this.logger.error('Failed to update user:', error);\n      throw new HttpException(\n        `Failed to update user: ${error instanceof Error ? error.message : 'Unknown error'}`,\n        HttpStatus.INTERNAL_SERVER_ERROR,\n      );\n    }\n  }\n\n  @Delete(':id')\n  async remove(\n    @Param(new ZodValidationPipe(UserIdParamSchema)) params: UserIdParam,\n    @CurrentUserId() currentUserId: string,\n  ): Promise<SuccessMessageDto> {\n    try {\n      // Users can only deactivate their own account unless they're admin\n      const isAdmin = await this.roleUtils.isUserAdmin(currentUserId);\n\n      if (!isAdmin && params.id !== currentUserId) {\n        throw new ForbiddenException(\n          'You can only deactivate your own account',\n        );\n      }\n\n      this.logger.log(\n        `User/Admin ${currentUserId} deactivating user ${params.id}`,\n      );\n      await this.usersService.remove(params.id);\n\n      return new SuccessMessageDto('User account deactivated successfully');\n    } catch (error) {\n      if (error instanceof ForbiddenException) {\n        throw error;\n      }\n      this.logger.error('Failed to deactivate user:', error);\n      throw new HttpException(\n        `Failed to deactivate user: ${error instanceof Error ? error.message : 'Unknown error'}`,\n        HttpStatus.INTERNAL_SERVER_ERROR,\n      );\n    }\n  }\n\n  @Post(':id/deactivate')\n  async deactivateUser(\n    @Param(new ZodValidationPipe(UserIdParamSchema)) params: UserIdParam,\n    @Body(new ZodValidationPipe(DeactivateUserDtoSchema))\n    body: DeactivateUserDto,\n    @CurrentUserId() currentUserId: string,\n    @CurrentUserRole() role: string,\n  ): Promise<SuccessMessageDto> {\n    if (role !== 'admin') {\n      throw new ForbiddenException('Admin access required');\n    }\n    try {\n      this.logger.log(\n        `Admin ${currentUserId} deactivating user ${params.id} with reason: ${body.reason}`,\n      );\n      await this.usersService.deactivate(params.id, body.reason, currentUserId);\n\n      return new SuccessMessageDto('User account deactivated by administrator');\n    } catch (error) {\n      this.logger.error('Failed to deactivate user:', error);\n      throw new HttpException(\n        `Failed to deactivate user: ${error instanceof Error ? error.message : 'Unknown error'}`,\n        HttpStatus.INTERNAL_SERVER_ERROR,\n      );\n    }\n  }\n\n  @Post(':id/reactivate')\n  async reactivateUser(\n    @Param(new ZodValidationPipe(UserIdParamSchema)) params: UserIdParam,\n    @CurrentUserId() currentUserId: string,\n    @CurrentUserRole() role: string,\n  ): Promise<SuccessMessageDto> {\n    if (role !== 'admin') {\n      throw new ForbiddenException('Admin access required');\n    }\n    try {\n      this.logger.log(`Admin ${currentUserId} reactivating user ${params.id}`);\n      await this.usersService.reactivate(params.id);\n\n      return new SuccessMessageDto('User account reactivated successfully');\n    } catch (error) {\n      this.logger.error('Failed to reactivate user:', error);\n      throw new HttpException(\n        `Failed to reactivate user: ${error instanceof Error ? error.message : 'Unknown error'}`,\n        HttpStatus.INTERNAL_SERVER_ERROR,\n      );\n    }\n  }\n}\n"],"version":3}