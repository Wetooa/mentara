e73b83568e27f5160e86c29f663b0a95
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var __param = (this && this.__param) || function (paramIndex, decorator) {
    return function (target, key) { decorator(target, key, paramIndex); }
};
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
exports.PushNotificationController = void 0;
const common_1 = require("@nestjs/common");
const swagger_1 = require("@nestjs/swagger");
const jwt_auth_guard_1 = require("../../auth/guards/jwt-auth.guard");
const role_based_access_guard_1 = require("../../auth/guards/role-based-access.guard");
const roles_decorator_1 = require("../../auth/decorators/roles.decorator");
const get_user_decorator_1 = require("../../decorators/get-user.decorator");
const push_notification_service_1 = require("../services/push-notification.service");
let PushNotificationController = class PushNotificationController {
    pushNotificationService;
    constructor(pushNotificationService) {
        this.pushNotificationService = pushNotificationService;
    }
    async registerDeviceToken(user, dto) {
        try {
            await this.pushNotificationService.registerDeviceToken(user.id, dto.token, dto.platform, dto.deviceInfo);
            return {
                success: true,
                message: 'Device token registered successfully',
            };
        }
        catch (error) {
            throw error;
        }
    }
    async unregisterDeviceToken(user, dto) {
        try {
            await this.pushNotificationService.unregisterDeviceToken(dto.token);
            return {
                success: true,
                message: 'Device token unregistered successfully',
            };
        }
        catch (error) {
            throw error;
        }
    }
    async getStatistics(user) {
        try {
            const statistics = await this.pushNotificationService.getStatistics(user.id);
            return {
                success: true,
                data: statistics,
                message: 'Statistics retrieved successfully',
            };
        }
        catch (error) {
            throw error;
        }
    }
    async getGlobalStatistics() {
        try {
            const statistics = await this.pushNotificationService.getStatistics();
            return {
                success: true,
                data: statistics,
                message: 'Global statistics retrieved successfully',
            };
        }
        catch (error) {
            throw error;
        }
    }
    async sendTestNotification(user, dto) {
        try {
            const targetUserId = dto.targetUserId || user.id;
            await this.pushNotificationService.sendTestNotification(targetUserId, dto.message);
            return {
                success: true,
                message: 'Test notification sent successfully',
            };
        }
        catch (error) {
            throw error;
        }
    }
    async processScheduledNotifications() {
        try {
            await this.pushNotificationService.processScheduledNotifications();
            return {
                success: true,
                message: 'Scheduled notifications processed successfully',
            };
        }
        catch (error) {
            throw error;
        }
    }
};
exports.PushNotificationController = PushNotificationController;
__decorate([
    (0, common_1.Post)('register'),
    (0, roles_decorator_1.Roles)('client', 'therapist', 'moderator', 'admin'),
    (0, common_1.HttpCode)(common_1.HttpStatus.OK),
    (0, swagger_1.ApiOperation)({
        summary: 'Register device token for push notifications',
        description: 'Registers a device token to receive push notifications for the current user',
    }),
    (0, swagger_1.ApiResponse)({
        status: 200,
        description: 'Device token registered successfully',
        schema: {
            type: 'object',
            properties: {
                success: { type: 'boolean' },
                message: { type: 'string' },
            },
        },
    }),
    (0, swagger_1.ApiResponse)({
        status: 400,
        description: 'Invalid device token or platform',
    }),
    __param(0, (0, get_user_decorator_1.GetUser)()),
    __param(1, (0, common_1.Body)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Object, Object]),
    __metadata("design:returntype", Promise)
], PushNotificationController.prototype, "registerDeviceToken", null);
__decorate([
    (0, common_1.Delete)('unregister'),
    (0, roles_decorator_1.Roles)('client', 'therapist', 'moderator', 'admin'),
    (0, common_1.HttpCode)(common_1.HttpStatus.OK),
    (0, swagger_1.ApiOperation)({
        summary: 'Unregister device token',
        description: 'Unregisters a device token to stop receiving push notifications',
    }),
    (0, swagger_1.ApiResponse)({
        status: 200,
        description: 'Device token unregistered successfully',
    }),
    (0, swagger_1.ApiResponse)({
        status: 404,
        description: 'Device token not found',
    }),
    __param(0, (0, get_user_decorator_1.GetUser)()),
    __param(1, (0, common_1.Body)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Object, Object]),
    __metadata("design:returntype", Promise)
], PushNotificationController.prototype, "unregisterDeviceToken", null);
__decorate([
    (0, common_1.Get)('statistics'),
    (0, roles_decorator_1.Roles)('client', 'therapist', 'moderator', 'admin'),
    (0, swagger_1.ApiOperation)({
        summary: 'Get push notification statistics',
        description: 'Retrieves push notification statistics for the current user',
    }),
    (0, swagger_1.ApiResponse)({
        status: 200,
        description: 'Statistics retrieved successfully',
        schema: {
            type: 'object',
            properties: {
                success: { type: 'boolean' },
                data: {
                    type: 'object',
                    properties: {
                        totalTokens: { type: 'number' },
                        activeTokens: { type: 'number' },
                        platformBreakdown: {
                            type: 'array',
                            items: {
                                type: 'object',
                                properties: {
                                    platform: { type: 'string' },
                                    count: { type: 'number' },
                                },
                            },
                        },
                        recentActivity: { type: 'number' },
                    },
                },
            },
        },
    }),
    __param(0, (0, get_user_decorator_1.GetUser)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Object]),
    __metadata("design:returntype", Promise)
], PushNotificationController.prototype, "getStatistics", null);
__decorate([
    (0, common_1.Get)('statistics/global'),
    (0, roles_decorator_1.Roles)('admin', 'moderator'),
    (0, swagger_1.ApiOperation)({
        summary: 'Get global push notification statistics',
        description: 'Retrieves platform-wide push notification statistics (admin/moderator only)',
    }),
    (0, swagger_1.ApiResponse)({
        status: 200,
        description: 'Global statistics retrieved successfully',
    }),
    (0, swagger_1.ApiResponse)({
        status: 403,
        description: 'Insufficient permissions',
    }),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", []),
    __metadata("design:returntype", Promise)
], PushNotificationController.prototype, "getGlobalStatistics", null);
__decorate([
    (0, common_1.Post)('test'),
    (0, roles_decorator_1.Roles)('admin', 'moderator'),
    (0, common_1.HttpCode)(common_1.HttpStatus.OK),
    (0, swagger_1.ApiOperation)({
        summary: 'Send test push notification',
        description: 'Sends a test push notification (admin/moderator only)',
    }),
    (0, swagger_1.ApiResponse)({
        status: 200,
        description: 'Test notification sent successfully',
    }),
    (0, swagger_1.ApiResponse)({
        status: 403,
        description: 'Insufficient permissions',
    }),
    (0, swagger_1.ApiResponse)({
        status: 400,
        description: 'Push notification service not configured',
    }),
    __param(0, (0, get_user_decorator_1.GetUser)()),
    __param(1, (0, common_1.Body)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Object, Object]),
    __metadata("design:returntype", Promise)
], PushNotificationController.prototype, "sendTestNotification", null);
__decorate([
    (0, common_1.Post)('process-scheduled'),
    (0, roles_decorator_1.Roles)('admin'),
    (0, common_1.HttpCode)(common_1.HttpStatus.OK),
    (0, swagger_1.ApiOperation)({
        summary: 'Process scheduled push notifications',
        description: 'Manually triggers processing of scheduled push notifications (admin only)',
    }),
    (0, swagger_1.ApiResponse)({
        status: 200,
        description: 'Scheduled notifications processed successfully',
    }),
    (0, swagger_1.ApiResponse)({
        status: 403,
        description: 'Insufficient permissions',
    }),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", []),
    __metadata("design:returntype", Promise)
], PushNotificationController.prototype, "processScheduledNotifications", null);
exports.PushNotificationController = PushNotificationController = __decorate([
    (0, swagger_1.ApiTags)('Push Notifications'),
    (0, swagger_1.ApiTags)('push-notification'),
    (0, swagger_1.ApiBearerAuth)('JWT-auth'),
    (0, common_1.Controller)('notifications/push'),
    (0, common_1.UseGuards)(jwt_auth_guard_1.JwtAuthGuard, role_based_access_guard_1.RoleBasedAccessGuard),
    (0, swagger_1.ApiBearerAuth)(),
    (0, common_1.UsePipes)(new common_1.ValidationPipe({ transform: true })),
    __metadata("design:paramtypes", [typeof (_a = typeof push_notification_service_1.PushNotificationService !== "undefined" && push_notification_service_1.PushNotificationService) === "function" ? _a : Object])
], PushNotificationController);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL25vdGlmaWNhdGlvbnMvY29udHJvbGxlcnMvcHVzaC1ub3RpZmljYXRpb24uY29udHJvbGxlci50cyIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsMkNBYXdCO0FBQ3hCLDZDQU15QjtBQUN6QixxRUFBZ0U7QUFDaEUsdUZBQWlGO0FBQ2pGLDJFQUE4RDtBQUM5RCw0RUFBOEQ7QUFDOUQscUZBQWdGO0FBNkJ6RSxJQUFNLDBCQUEwQixHQUFoQyxNQUFNLDBCQUEwQjtJQUVsQjtJQURuQixZQUNtQix1QkFBZ0Q7UUFBaEQsNEJBQXVCLEdBQXZCLHVCQUF1QixDQUF5QjtJQUNoRSxDQUFDO0lBeUJFLEFBQU4sS0FBSyxDQUFDLG1CQUFtQixDQUNaLElBQVMsRUFDWixHQUEyQjtRQUVuQyxJQUFJLENBQUM7WUFDSCxNQUFNLElBQUksQ0FBQyx1QkFBdUIsQ0FBQyxtQkFBbUIsQ0FDcEQsSUFBSSxDQUFDLEVBQUUsRUFDUCxHQUFHLENBQUMsS0FBSyxFQUNULEdBQUcsQ0FBQyxRQUFRLEVBQ1osR0FBRyxDQUFDLFVBQVUsQ0FDZixDQUFDO1lBRUYsT0FBTztnQkFDTCxPQUFPLEVBQUUsSUFBSTtnQkFDYixPQUFPLEVBQUUsc0NBQXNDO2FBQ2hELENBQUM7UUFDSixDQUFDO1FBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztZQUNmLE1BQU0sS0FBSyxDQUFDO1FBQ2QsQ0FBQztJQUNILENBQUM7SUFrQkssQUFBTixLQUFLLENBQUMscUJBQXFCLENBQ2QsSUFBUyxFQUNaLEdBQTZCO1FBRXJDLElBQUksQ0FBQztZQUNILE1BQU0sSUFBSSxDQUFDLHVCQUF1QixDQUFDLHFCQUFxQixDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUVwRSxPQUFPO2dCQUNMLE9BQU8sRUFBRSxJQUFJO2dCQUNiLE9BQU8sRUFBRSx3Q0FBd0M7YUFDbEQsQ0FBQztRQUNKLENBQUM7UUFB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dUI7R0FGeEQsMEJBQTBCLENBb090QyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvaG9tZS93ZXRvb2EvRG9jdW1lbnRzL2NvZGUvcHJvamVjdHMvbWVudGFyYS9tZW50YXJhLWFwaS9zcmMvbm90aWZpY2F0aW9ucy9jb250cm9sbGVycy9wdXNoLW5vdGlmaWNhdGlvbi5jb250cm9sbGVyLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIENvbnRyb2xsZXIsXG4gIFBvc3QsXG4gIERlbGV0ZSxcbiAgR2V0LFxuICBCb2R5LFxuICBQYXJhbSxcbiAgVXNlR3VhcmRzLFxuICBIdHRwQ29kZSxcbiAgSHR0cFN0YXR1cyxcbiAgUGFyc2VVVUlEUGlwZSxcbiAgVmFsaWRhdGlvblBpcGUsXG4gIFVzZVBpcGVzLFxufSBmcm9tICdAbmVzdGpzL2NvbW1vbic7XG5pbXBvcnQge1xuICBBcGlUYWdzLFxuICBBcGlPcGVyYXRpb24sXG4gIEFwaVJlc3BvbnNlLFxuICBBcGlQYXJhbSxcbiAgQXBpQmVhcmVyQXV0aCxcbn0gZnJvbSAnQG5lc3Rqcy9zd2FnZ2VyJztcbmltcG9ydCB7IEp3dEF1dGhHdWFyZCB9IGZyb20gJy4uLy4uL2F1dGgvZ3VhcmRzL2p3dC1hdXRoLmd1YXJkJztcbmltcG9ydCB7IFJvbGVCYXNlZEFjY2Vzc0d1YXJkIH0gZnJvbSAnLi4vLi4vYXV0aC9ndWFyZHMvcm9sZS1iYXNlZC1hY2Nlc3MuZ3VhcmQnO1xuaW1wb3J0IHsgUm9sZXMgfSBmcm9tICcuLi8uLi9hdXRoL2RlY29yYXRvcnMvcm9sZXMuZGVjb3JhdG9yJztcbmltcG9ydCB7IEdldFVzZXIgfSBmcm9tICcuLi8uLi9kZWNvcmF0b3JzL2dldC11c2VyLmRlY29yYXRvcic7XG5pbXBvcnQgeyBQdXNoTm90aWZpY2F0aW9uU2VydmljZSB9IGZyb20gJy4uL3NlcnZpY2VzL3B1c2gtbm90aWZpY2F0aW9uLnNlcnZpY2UnO1xuLy8gVXNpbmcgaW50ZXJmYWNlcyBmb3IgRFRPcyB0byBhdm9pZCBjbGFzcyBpbml0aWFsaXphdGlvbiBlcnJvcnNcbmludGVyZmFjZSBSZWdpc3RlckRldmljZVRva2VuRHRvIHtcbiAgdG9rZW46IHN0cmluZztcbiAgcGxhdGZvcm06ICdpb3MnIHwgJ2FuZHJvaWQnIHwgJ3dlYic7XG4gIGRldmljZUluZm8/OiB7XG4gICAgbW9kZWw/OiBzdHJpbmc7XG4gICAgb3M/OiBzdHJpbmc7XG4gICAgYXBwVmVyc2lvbj86IHN0cmluZztcbiAgICBwdXNoRW5hYmxlZD86IGJvb2xlYW47XG4gIH07XG59XG5cbmludGVyZmFjZSBVbnJlZ2lzdGVyRGV2aWNlVG9rZW5EdG8ge1xuICB0b2tlbjogc3RyaW5nO1xufVxuXG5pbnRlcmZhY2UgVGVzdE5vdGlmaWNhdGlvbkR0byB7XG4gIG1lc3NhZ2U6IHN0cmluZztcbiAgdGFyZ2V0VXNlcklkPzogc3RyaW5nO1xufVxuXG5AQXBpVGFncygnUHVzaCBOb3RpZmljYXRpb25zJylcbkBBcGlUYWdzKCdwdXNoLW5vdGlmaWNhdGlvbicpXG5AQXBpQmVhcmVyQXV0aCgnSldULWF1dGgnKVxuQENvbnRyb2xsZXIoJ25vdGlmaWNhdGlvbnMvcHVzaCcpXG5AVXNlR3VhcmRzKEp3dEF1dGhHdWFyZCwgUm9sZUJhc2VkQWNjZXNzR3VhcmQpXG5AQXBpQmVhcmVyQXV0aCgpXG5AVXNlUGlwZXMobmV3IFZhbGlkYXRpb25QaXBlKHsgdHJhbnNmb3JtOiB0cnVlIH0pKVxuZXhwb3J0IGNsYXNzIFB1c2hOb3RpZmljYXRpb25Db250cm9sbGVyIHtcbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSByZWFkb25seSBwdXNoTm90aWZpY2F0aW9uU2VydmljZTogUHVzaE5vdGlmaWNhdGlvblNlcnZpY2UsXG4gICkge31cblxuICBAUG9zdCgncmVnaXN0ZXInKVxuICBAUm9sZXMoJ2NsaWVudCcsICd0aGVyYXBpc3QnLCAnbW9kZXJhdG9yJywgJ2FkbWluJylcbiAgQEh0dHBDb2RlKEh0dHBTdGF0dXMuT0spXG4gIEBBcGlPcGVyYXRpb24oe1xuICAgIHN1bW1hcnk6ICdSZWdpc3RlciBkZXZpY2UgdG9rZW4gZm9yIHB1c2ggbm90aWZpY2F0aW9ucycsXG4gICAgZGVzY3JpcHRpb246XG4gICAgICAnUmVnaXN0ZXJzIGEgZGV2aWNlIHRva2VuIHRvIHJlY2VpdmUgcHVzaCBub3RpZmljYXRpb25zIGZvciB0aGUgY3VycmVudCB1c2VyJyxcbiAgfSlcbiAgQEFwaVJlc3BvbnNlKHtcbiAgICBzdGF0dXM6IDIwMCxcbiAgICBkZXNjcmlwdGlvbjogJ0RldmljZSB0b2tlbiByZWdpc3RlcmVkIHN1Y2Nlc3NmdWxseScsXG4gICAgc2NoZW1hOiB7XG4gICAgICB0eXBlOiAnb2JqZWN0JyxcbiAgICAgIHByb3BlcnRpZXM6IHtcbiAgICAgICAgc3VjY2VzczogeyB0eXBlOiAnYm9vbGVhbicgfSxcbiAgICAgICAgbWVzc2FnZTogeyB0eXBlOiAnc3RyaW5nJyB9LFxuICAgICAgfSxcbiAgICB9LFxuICB9KVxuICBAQXBpUmVzcG9uc2Uoe1xuICAgIHN0YXR1czogNDAwLFxuICAgIGRlc2NyaXB0aW9uOiAnSW52YWxpZCBkZXZpY2UgdG9rZW4gb3IgcGxhdGZvcm0nLFxuICB9KVxuICBhc3luYyByZWdpc3RlckRldmljZVRva2VuKFxuICAgIEBHZXRVc2VyKCkgdXNlcjogYW55LFxuICAgIEBCb2R5KCkgZHRvOiBSZWdpc3RlckRldmljZVRva2VuRHRvLFxuICApIHtcbiAgICB0cnkge1xuICAgICAgYXdhaXQgdGhpcy5wdXNoTm90aWZpY2F0aW9uU2VydmljZS5yZWdpc3RlckRldmljZVRva2VuKFxuICAgICAgICB1c2VyLmlkLFxuICAgICAgICBkdG8udG9rZW4sXG4gICAgICAgIGR0by5wbGF0Zm9ybSxcbiAgICAgICAgZHRvLmRldmljZUluZm8sXG4gICAgICApO1xuXG4gICAgICByZXR1cm4ge1xuICAgICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgICBtZXNzYWdlOiAnRGV2aWNlIHRva2VuIHJlZ2lzdGVyZWQgc3VjY2Vzc2Z1bGx5JyxcbiAgICAgIH07XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRocm93IGVycm9yO1xuICAgIH1cbiAgfVxuXG4gIEBEZWxldGUoJ3VucmVnaXN0ZXInKVxuICBAUm9sZXMoJ2NsaWVudCcsICd0aGVyYXBpc3QnLCAnbW9kZXJhdG9yJywgJ2FkbWluJylcbiAgQEh0dHBDb2RlKEh0dHBTdGF0dXMuT0spXG4gIEBBcGlPcGVyYXRpb24oe1xuICAgIHN1bW1hcnk6ICdVbnJlZ2lzdGVyIGRldmljZSB0b2tlbicsXG4gICAgZGVzY3JpcHRpb246XG4gICAgICAnVW5yZWdpc3RlcnMgYSBkZXZpY2UgdG9rZW4gdG8gc3RvcCByZWNlaXZpbmcgcHVzaCBub3RpZmljYXRpb25zJyxcbiAgfSlcbiAgQEFwaVJlc3BvbnNlKHtcbiAgICBzdGF0dXM6IDIwMCxcbiAgICBkZXNjcmlwdGlvbjogJ0RldmljZSB0b2tlbiB1bnJlZ2lzdGVyZWQgc3VjY2Vzc2Z1bGx5JyxcbiAgfSlcbiAgQEFwaVJlc3BvbnNlKHtcbiAgICBzdGF0dXM6IDQwNCxcbiAgICBkZXNjcmlwdGlvbjogJ0RldmljZSB0b2tlbiBub3QgZm91bmQnLFxuICB9KVxuICBhc3luYyB1bnJlZ2lzdGVyRGV2aWNlVG9rZW4oXG4gICAgQEdldFVzZXIoKSB1c2VyOiBhbnksXG4gICAgQEJvZHkoKSBkdG86IFVucmVnaXN0ZXJEZXZpY2VUb2tlbkR0byxcbiAgKSB7XG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IHRoaXMucHVzaE5vdGlmaWNhdGlvblNlcnZpY2UudW5yZWdpc3RlckRldmljZVRva2VuKGR0by50b2tlbik7XG5cbiAgICAgIHJldHVybiB7XG4gICAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICAgIG1lc3NhZ2U6ICdEZXZpY2UgdG9rZW4gdW5yZWdpc3RlcmVkIHN1Y2Nlc3NmdWxseScsXG4gICAgICB9O1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aHJvdyBlcnJvcjtcbiAgICB9XG4gIH1cblxuICBAR2V0KCdzdGF0aXN0aWNzJylcbiAgQFJvbGVzKCdjbGllbnQnLCAndGhlcmFwaXN0JywgJ21vZGVyYXRvcicsICdhZG1pbicpXG4gIEBBcGlPcGVyYXRpb24oe1xuICAgIHN1bW1hcnk6ICdHZXQgcHVzaCBub3RpZmljYXRpb24gc3RhdGlzdGljcycsXG4gICAgZGVzY3JpcHRpb246ICdSZXRyaWV2ZXMgcHVzaCBub3RpZmljYXRpb24gc3RhdGlzdGljcyBmb3IgdGhlIGN1cnJlbnQgdXNlcicsXG4gIH0pXG4gIEBBcGlSZXNwb25zZSh7XG4gICAgc3RhdHVzOiAyMDAsXG4gICAgZGVzY3JpcHRpb246ICdTdGF0aXN0aWNzIHJldHJpZXZlZCBzdWNjZXNzZnVsbHknLFxuICAgIHNjaGVtYToge1xuICAgICAgdHlwZTogJ29iamVjdCcsXG4gICAgICBwcm9wZXJ0aWVzOiB7XG4gICAgICAgIHN1Y2Nlc3M6IHsgdHlwZTogJ2Jvb2xlYW4nIH0sXG4gICAgICAgIGRhdGE6IHtcbiAgICAgICAgICB0eXBlOiAnb2JqZWN0JyxcbiAgICAgICAgICBwcm9wZXJ0aWVzOiB7XG4gICAgICAgICAgICB0b3RhbFRva2VuczogeyB0eXBlOiAnbnVtYmVyJyB9LFxuICAgICAgICAgICAgYWN0aXZlVG9rZW5zOiB7IHR5cGU6ICdudW1iZXInIH0sXG4gICAgICAgICAgICBwbGF0Zm9ybUJyZWFrZG93bjoge1xuICAgICAgICAgICAgICB0eXBlOiAnYXJyYXknLFxuICAgICAgICAgICAgICBpdGVtczoge1xuICAgICAgICAgICAgICAgIHR5cGU6ICdvYmplY3QnLFxuICAgICAgICAgICAgICAgIHByb3BlcnRpZXM6IHtcbiAgICAgICAgICAgICAgICAgIHBsYXRmb3JtOiB7IHR5cGU6ICdzdHJpbmcnIH0sXG4gICAgICAgICAgICAgICAgICBjb3VudDogeyB0eXBlOiAnbnVtYmVyJyB9LFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgcmVjZW50QWN0aXZpdHk6IHsgdHlwZTogJ251bWJlcicgfSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgfSxcbiAgICB9LFxuICB9KVxuICBhc3luYyBnZXRTdGF0aXN0aWNzKEBHZXRVc2VyKCkgdXNlcjogYW55KSB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHN0YXRpc3RpY3MgPSBhd2FpdCB0aGlzLnB1c2hOb3RpZmljYXRpb25TZXJ2aWNlLmdldFN0YXRpc3RpY3MoXG4gICAgICAgIHVzZXIuaWQsXG4gICAgICApO1xuXG4gICAgICByZXR1cm4ge1xuICAgICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgICBkYXRhOiBzdGF0aXN0aWNzLFxuICAgICAgICBtZXNzYWdlOiAnU3RhdGlzdGljcyByZXRyaWV2ZWQgc3VjY2Vzc2Z1bGx5JyxcbiAgICAgIH07XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRocm93IGVycm9yO1xuICAgIH1cbiAgfVxuXG4gIEBHZXQoJ3N0YXRpc3RpY3MvZ2xvYmFsJylcbiAgQFJvbGVzKCdhZG1pbicsICdtb2RlcmF0b3InKVxuICBAQXBpT3BlcmF0aW9uKHtcbiAgICBzdW1tYXJ5OiAnR2V0IGdsb2JhbCBwdXNoIG5vdGlmaWNhdGlvbiBzdGF0aXN0aWNzJyxcbiAgICBkZXNjcmlwdGlvbjpcbiAgICAgICdSZXRyaWV2ZXMgcGxhdGZvcm0td2lkZSBwdXNoIG5vdGlmaWNhdGlvbiBzdGF0aXN0aWNzIChhZG1pbi9tb2RlcmF0b3Igb25seSknLFxuICB9KVxuICBAQXBpUmVzcG9uc2Uoe1xuICAgIHN0YXR1czogMjAwLFxuICAgIGRlc2NyaXB0aW9uOiAnR2xvYmFsIHN0YXRpc3RpY3MgcmV0cmlldmVkIHN1Y2Nlc3NmdWxseScsXG4gIH0pXG4gIEBBcGlSZXNwb25zZSh7XG4gICAgc3RhdHVzOiA0MDMsXG4gICAgZGVzY3JpcHRpb246ICdJbnN1ZmZpY2llbnQgcGVybWlzc2lvbnMnLFxuICB9KVxuICBhc3luYyBnZXRHbG9iYWxTdGF0aXN0aWNzKCkge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBzdGF0aXN0aWNzID0gYXdhaXQgdGhpcy5wdXNoTm90aWZpY2F0aW9uU2VydmljZS5nZXRTdGF0aXN0aWNzKCk7XG5cbiAgICAgIHJldHVybiB7XG4gICAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICAgIGRhdGE6IHN0YXRpc3RpY3MsXG4gICAgICAgIG1lc3NhZ2U6ICdHbG9iYWwgc3RhdGlzdGljcyByZXRyaWV2ZWQgc3VjY2Vzc2Z1bGx5JyxcbiAgICAgIH07XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRocm93IGVycm9yO1xuICAgIH1cbiAgfVxuXG4gIEBQb3N0KCd0ZXN0JylcbiAgQFJvbGVzKCdhZG1pbicsICdtb2RlcmF0b3InKVxuICBASHR0cENvZGUoSHR0cFN0YXR1cy5PSylcbiAgQEFwaU9wZXJhdGlvbih7XG4gICAgc3VtbWFyeTogJ1NlbmQgdGVzdCBwdXNoIG5vdGlmaWNhdGlvbicsXG4gICAgZGVzY3JpcHRpb246ICdTZW5kcyBhIHRlc3QgcHVzaCBub3RpZmljYXRpb24gKGFkbWluL21vZGVyYXRvciBvbmx5KScsXG4gIH0pXG4gIEBBcGlSZXNwb25zZSh7XG4gICAgc3RhdHVzOiAyMDAsXG4gICAgZGVzY3JpcHRpb246ICdUZXN0IG5vdGlmaWNhdGlvbiBzZW50IHN1Y2Nlc3NmdWxseScsXG4gIH0pXG4gIEBBcGlSZXNwb25zZSh7XG4gICAgc3RhdHVzOiA0MDMsXG4gICAgZGVzY3JpcHRpb246ICdJbnN1ZmZpY2llbnQgcGVybWlzc2lvbnMnLFxuICB9KVxuICBAQXBpUmVzcG9uc2Uoe1xuICAgIHN0YXR1czogNDAwLFxuICAgIGRlc2NyaXB0aW9uOiAnUHVzaCBub3RpZmljYXRpb24gc2VydmljZSBub3QgY29uZmlndXJlZCcsXG4gIH0pXG4gIGFzeW5jIHNlbmRUZXN0Tm90aWZpY2F0aW9uKFxuICAgIEBHZXRVc2VyKCkgdXNlcjogYW55LFxuICAgIEBCb2R5KCkgZHRvOiBUZXN0Tm90aWZpY2F0aW9uRHRvLFxuICApIHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgdGFyZ2V0VXNlcklkID0gZHRvLnRhcmdldFVzZXJJZCB8fCB1c2VyLmlkO1xuXG4gICAgICBhd2FpdCB0aGlzLnB1c2hOb3RpZmljYXRpb25TZXJ2aWNlLnNlbmRUZXN0Tm90aWZpY2F0aW9uKFxuICAgICAgICB0YXJnZXRVc2VySWQsXG4gICAgICAgIGR0by5tZXNzYWdlLFxuICAgICAgKTtcblxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgc3VjY2VzczogdHJ1ZSxcbiAgICAgICAgbWVzc2FnZTogJ1Rlc3Qgbm90aWZpY2F0aW9uIHNlbnQgc3VjY2Vzc2Z1bGx5JyxcbiAgICAgIH07XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRocm93IGVycm9yO1xuICAgIH1cbiAgfVxuXG4gIEBQb3N0KCdwcm9jZXNzLXNjaGVkdWxlZCcpXG4gIEBSb2xlcygnYWRtaW4nKVxuICBASHR0cENvZGUoSHR0cFN0YXR1cy5PSylcbiAgQEFwaU9wZXJhdGlvbih7XG4gICAgc3VtbWFyeTogJ1Byb2Nlc3Mgc2NoZWR1bGVkIHB1c2ggbm90aWZpY2F0aW9ucycsXG4gICAgZGVzY3JpcHRpb246XG4gICAgICAnTWFudWFsbHkgdHJpZ2dlcnMgcHJvY2Vzc2luZyBvZiBzY2hlZHVsZWQgcHVzaCBub3RpZmljYXRpb25zIChhZG1pbiBvbmx5KScsXG4gIH0pXG4gIEBBcGlSZXNwb25zZSh7XG4gICAgc3RhdHVzOiAyMDAsXG4gICAgZGVzY3JpcHRpb246ICdTY2hlZHVsZWQgbm90aWZpY2F0aW9ucyBwcm9jZXNzZWQgc3VjY2Vzc2Z1bGx5JyxcbiAgfSlcbiAgQEFwaVJlc3BvbnNlKHtcbiAgICBzdGF0dXM6IDQwMyxcbiAgICBkZXNjcmlwdGlvbjogJ0luc3VmZmljaWVudCBwZXJtaXNzaW9ucycsXG4gIH0pXG4gIGFzeW5jIHByb2Nlc3NTY2hlZHVsZWROb3RpZmljYXRpb25zKCkge1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCB0aGlzLnB1c2hOb3RpZmljYXRpb25TZXJ2aWNlLnByb2Nlc3NTY2hlZHVsZWROb3RpZmljYXRpb25zKCk7XG5cbiAgICAgIHJldHVybiB7XG4gICAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICAgIG1lc3NhZ2U6ICdTY2hlZHVsZWQgbm90aWZpY2F0aW9ucyBwcm9jZXNzZWQgc3VjY2Vzc2Z1bGx5JyxcbiAgICAgIH07XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRocm93IGVycm9yO1xuICAgIH1cbiAgfVxufVxuIl0sInZlcnNpb24iOjN9