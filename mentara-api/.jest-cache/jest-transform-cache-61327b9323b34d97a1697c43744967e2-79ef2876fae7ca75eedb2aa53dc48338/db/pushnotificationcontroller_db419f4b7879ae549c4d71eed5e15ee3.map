{"file":"/home/wetooa/Documents/code/projects/mentara/mentara-api/src/notifications/controllers/push-notification.controller.ts","mappings":"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","names":[],"sources":["/home/wetooa/Documents/code/projects/mentara/mentara-api/src/notifications/controllers/push-notification.controller.ts"],"sourcesContent":["import {\n  Controller,\n  Post,\n  Delete,\n  Get,\n  Body,\n  Param,\n  UseGuards,\n  HttpCode,\n  HttpStatus,\n  ParseUUIDPipe,\n  ValidationPipe,\n  UsePipes,\n} from '@nestjs/common';\nimport {\n  ApiTags,\n  ApiOperation,\n  ApiResponse,\n  ApiParam,\n  ApiBearerAuth,\n} from '@nestjs/swagger';\nimport { JwtAuthGuard } from '../../auth/guards/jwt-auth.guard';\nimport { RoleBasedAccessGuard } from '../../auth/guards/role-based-access.guard';\nimport { Roles } from '../../auth/decorators/roles.decorator';\nimport { GetUser } from '../../decorators/get-user.decorator';\nimport { PushNotificationService } from '../services/push-notification.service';\n// Using interfaces for DTOs to avoid class initialization errors\ninterface RegisterDeviceTokenDto {\n  token: string;\n  platform: 'ios' | 'android' | 'web';\n  deviceInfo?: {\n    model?: string;\n    os?: string;\n    appVersion?: string;\n    pushEnabled?: boolean;\n  };\n}\n\ninterface UnregisterDeviceTokenDto {\n  token: string;\n}\n\ninterface TestNotificationDto {\n  message: string;\n  targetUserId?: string;\n}\n\n@ApiTags('Push Notifications')\n@ApiTags('push-notification')\n@ApiBearerAuth('JWT-auth')\n@Controller('notifications/push')\n@UseGuards(JwtAuthGuard, RoleBasedAccessGuard)\n@ApiBearerAuth()\n@UsePipes(new ValidationPipe({ transform: true }))\nexport class PushNotificationController {\n  constructor(\n    private readonly pushNotificationService: PushNotificationService,\n  ) {}\n\n  @Post('register')\n  @Roles('client', 'therapist', 'moderator', 'admin')\n  @HttpCode(HttpStatus.OK)\n  @ApiOperation({\n    summary: 'Register device token for push notifications',\n    description:\n      'Registers a device token to receive push notifications for the current user',\n  })\n  @ApiResponse({\n    status: 200,\n    description: 'Device token registered successfully',\n    schema: {\n      type: 'object',\n      properties: {\n        success: { type: 'boolean' },\n        message: { type: 'string' },\n      },\n    },\n  })\n  @ApiResponse({\n    status: 400,\n    description: 'Invalid device token or platform',\n  })\n  async registerDeviceToken(\n    @GetUser() user: any,\n    @Body() dto: RegisterDeviceTokenDto,\n  ) {\n    try {\n      await this.pushNotificationService.registerDeviceToken(\n        user.id,\n        dto.token,\n        dto.platform,\n        dto.deviceInfo,\n      );\n\n      return {\n        success: true,\n        message: 'Device token registered successfully',\n      };\n    } catch (error) {\n      throw error;\n    }\n  }\n\n  @Delete('unregister')\n  @Roles('client', 'therapist', 'moderator', 'admin')\n  @HttpCode(HttpStatus.OK)\n  @ApiOperation({\n    summary: 'Unregister device token',\n    description:\n      'Unregisters a device token to stop receiving push notifications',\n  })\n  @ApiResponse({\n    status: 200,\n    description: 'Device token unregistered successfully',\n  })\n  @ApiResponse({\n    status: 404,\n    description: 'Device token not found',\n  })\n  async unregisterDeviceToken(\n    @GetUser() user: any,\n    @Body() dto: UnregisterDeviceTokenDto,\n  ) {\n    try {\n      await this.pushNotificationService.unregisterDeviceToken(dto.token);\n\n      return {\n        success: true,\n        message: 'Device token unregistered successfully',\n      };\n    } catch (error) {\n      throw error;\n    }\n  }\n\n  @Get('statistics')\n  @Roles('client', 'therapist', 'moderator', 'admin')\n  @ApiOperation({\n    summary: 'Get push notification statistics',\n    description: 'Retrieves push notification statistics for the current user',\n  })\n  @ApiResponse({\n    status: 200,\n    description: 'Statistics retrieved successfully',\n    schema: {\n      type: 'object',\n      properties: {\n        success: { type: 'boolean' },\n        data: {\n          type: 'object',\n          properties: {\n            totalTokens: { type: 'number' },\n            activeTokens: { type: 'number' },\n            platformBreakdown: {\n              type: 'array',\n              items: {\n                type: 'object',\n                properties: {\n                  platform: { type: 'string' },\n                  count: { type: 'number' },\n                },\n              },\n            },\n            recentActivity: { type: 'number' },\n          },\n        },\n      },\n    },\n  })\n  async getStatistics(@GetUser() user: any) {\n    try {\n      const statistics = await this.pushNotificationService.getStatistics(\n        user.id,\n      );\n\n      return {\n        success: true,\n        data: statistics,\n        message: 'Statistics retrieved successfully',\n      };\n    } catch (error) {\n      throw error;\n    }\n  }\n\n  @Get('statistics/global')\n  @Roles('admin', 'moderator')\n  @ApiOperation({\n    summary: 'Get global push notification statistics',\n    description:\n      'Retrieves platform-wide push notification statistics (admin/moderator only)',\n  })\n  @ApiResponse({\n    status: 200,\n    description: 'Global statistics retrieved successfully',\n  })\n  @ApiResponse({\n    status: 403,\n    description: 'Insufficient permissions',\n  })\n  async getGlobalStatistics() {\n    try {\n      const statistics = await this.pushNotificationService.getStatistics();\n\n      return {\n        success: true,\n        data: statistics,\n        message: 'Global statistics retrieved successfully',\n      };\n    } catch (error) {\n      throw error;\n    }\n  }\n\n  @Post('test')\n  @Roles('admin', 'moderator')\n  @HttpCode(HttpStatus.OK)\n  @ApiOperation({\n    summary: 'Send test push notification',\n    description: 'Sends a test push notification (admin/moderator only)',\n  })\n  @ApiResponse({\n    status: 200,\n    description: 'Test notification sent successfully',\n  })\n  @ApiResponse({\n    status: 403,\n    description: 'Insufficient permissions',\n  })\n  @ApiResponse({\n    status: 400,\n    description: 'Push notification service not configured',\n  })\n  async sendTestNotification(\n    @GetUser() user: any,\n    @Body() dto: TestNotificationDto,\n  ) {\n    try {\n      const targetUserId = dto.targetUserId || user.id;\n\n      await this.pushNotificationService.sendTestNotification(\n        targetUserId,\n        dto.message,\n      );\n\n      return {\n        success: true,\n        message: 'Test notification sent successfully',\n      };\n    } catch (error) {\n      throw error;\n    }\n  }\n\n  @Post('process-scheduled')\n  @Roles('admin')\n  @HttpCode(HttpStatus.OK)\n  @ApiOperation({\n    summary: 'Process scheduled push notifications',\n    description:\n      'Manually triggers processing of scheduled push notifications (admin only)',\n  })\n  @ApiResponse({\n    status: 200,\n    description: 'Scheduled notifications processed successfully',\n  })\n  @ApiResponse({\n    status: 403,\n    description: 'Insufficient permissions',\n  })\n  async processScheduledNotifications() {\n    try {\n      await this.pushNotificationService.processScheduledNotifications();\n\n      return {\n        success: true,\n        message: 'Scheduled notifications processed successfully',\n      };\n    } catch (error) {\n      throw error;\n    }\n  }\n}\n"],"version":3}