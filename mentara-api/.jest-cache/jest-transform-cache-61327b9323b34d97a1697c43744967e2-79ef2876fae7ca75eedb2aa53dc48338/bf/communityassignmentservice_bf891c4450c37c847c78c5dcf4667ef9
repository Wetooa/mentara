59cf3ad0dfb54340c34c2359d7d2d3d3
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
exports.CommunityAssignmentService = void 0;
const common_1 = require("@nestjs/common");
const prisma_client_provider_1 = require("src/providers/prisma-client.provider");
const community_configs_1 = require("../config/community-configs");
let CommunityAssignmentService = class CommunityAssignmentService {
    prisma;
    constructor(prisma) {
        this.prisma = prisma;
    }
    /**
     * Maps questionnaire types to community slugs based on mental health conditions
     */
    QUESTIONNAIRE_TO_COMMUNITY_MAP = {
        // Depression-related assessments
        'phq-9': 'depression-support',
        'mood-disorder': 'depression-support',
        // Anxiety-related assessments
        'gad-7-anxiety': 'anxiety-warriors',
        'social-phobia': 'social-anxiety-support',
        'panic-disorder': 'anxiety-warriors',
        phobia: 'phobia-support',
        // Stress-related assessments
        'perceived-stress-scale': 'stress-support',
        burnout: 'burnout-recovery',
        // Sleep-related assessments
        insomnia: 'insomnia-support',
        // Trauma-related assessments
        ptsd: 'ptsd-support',
        // OCD-related assessments
        'obsessional-compulsive': 'ocd-support',
        // ADHD-related assessments
        adhd: 'adhd-support',
        // Eating disorder assessments
        'binge-eating': 'eating-disorder-recovery',
        // Substance use assessments
        alcohol: 'substance-recovery-support',
        'drug-abuse': 'substance-recovery-support',
    };
    /**
     * Severity thresholds for community assignment
     * Only assign to communities if severity is moderate or higher
     */
    SEVERITY_THRESHOLD = {
        minimal: false,
        mild: false,
        moderate: true,
        severe: true,
        'very-severe': true,
    };
    /**
     * Auto-assign communities to a user based on their pre-assessment results
     */
    async assignCommunitiesToUser(userId) {
        console.log(`ðŸ”„ Auto-assigning communities for user: ${userId}`);
        // Get user's pre-assessment data
        const userAssessment = await this.prisma.preAssessment.findFirst({
            where: { clientId: userId },
        });
        if (!userAssessment) {
            console.log(`âš ï¸  No pre-assessment found for user: ${userId}`);
            return [];
        }
        const scores = userAssessment.scores;
        const severityLevels = userAssessment.severityLevels;
        const assignedCommunities = [];
        // Iterate through questionnaire results and assign communities
        for (const [questionnaire] of Object.entries(scores)) {
            const severity = severityLevels[questionnaire];
            const communitySlug = this.QUESTIONNAIRE_TO_COMMUNITY_MAP[questionnaire];
            // Skip if no community mapping or severity is too low
            if (!communitySlug || !this.SEVERITY_THRESHOLD[severity?.toLowerCase()]) {
                continue;
            }
            // Find the community
            const community = await this.prisma.community.findUnique({
                where: { slug: communitySlug },
            });
            if (!community) {
                console.log(`âš ï¸  Community not found for slug: ${communitySlug}`);
                continue;
            }
            // Check if user is already a member
            const existingMembership = await this.prisma.membership.findUnique({
                where: {
                    userId_communityId: {
                        userId: userId,
                        communityId: community.id,
                    },
                },
            });
            if (existingMembership) {
                console.log(`â­ï¸  User already member of: ${community.name}`);
                continue;
            }
            // Create membership
            try {
                await this.prisma.membership.create({
                    data: {
                        userId: userId,
                        communityId: community.id,
                        role: 'member',
                        joinedAt: new Date(),
                    },
                });
                assignedCommunities.push(community.name);
                console.log(`âœ… Assigned user to community: ${community.name} (${severity} ${questionnaire})`);
            }
            catch (error) {
                console.error(`âŒ Failed to assign community ${community.name}:`, error);
            }
        }
        // Always assign to general support communities
        await this.assignGeneralSupportCommunities(userId);
        console.log(`ðŸŽ¯ Auto-assignment complete. Assigned ${assignedCommunities.length} communities.`);
        return assignedCommunities;
    }
    /**
     * Assign user to general support communities regardless of assessment results
     */
    async assignGeneralSupportCommunities(userId) {
        const generalCommunities = ['Support Circle', 'Mindfulness & Meditation'];
        for (const communityName of generalCommunities) {
            const community = await this.prisma.community.findFirst({
                where: { name: communityName },
            });
            if (!community)
                continue;
            // Check if user is already a member
            const existingMembership = await this.prisma.membership.findUnique({
                where: {
                    userId_communityId: {
                        userId: userId,
                        communityId: community.id,
                    },
                },
            });
            if (existingMembership)
                continue;
            try {
                await this.prisma.membership.create({
                    data: {
                        userId: userId,
                        communityId: community.id,
                        role: 'member',
                        joinedAt: new Date(),
                    },
                });
                console.log(`âœ… Assigned user to general community: ${community.name}`);
            }
            catch (error) {
                console.error(`âŒ Failed to assign general community ${community.name}:`, error);
            }
        }
    }
    /**
     * Get communities a user should be assigned to based on their assessment (preview mode)
     */
    async getRecommendedCommunities(userId) {
        const userAssessment = await this.prisma.preAssessment.findFirst({
            where: { clientId: userId },
        });
        if (!userAssessment) {
            return [];
        }
        const scores = userAssessment.scores;
        const severityLevels = userAssessment.severityLevels;
        const recommendedCommunities = [];
        for (const [questionnaire] of Object.entries(scores)) {
            const severity = severityLevels[questionnaire];
            const communitySlug = this.QUESTIONNAIRE_TO_COMMUNITY_MAP[questionnaire];
            if (communitySlug && this.SEVERITY_THRESHOLD[severity?.toLowerCase()]) {
                const community = community_configs_1.ILLNESS_COMMUNITIES.find((c) => c.slug === communitySlug);
                if (community) {
                    recommendedCommunities.push(community.name);
                }
            }
        }
        return recommendedCommunities;
    }
    /**
     * Bulk assign communities to multiple users (useful for existing users)
     */
    async bulkAssignCommunities(userIds) {
        const results = {};
        for (const userId of userIds) {
            try {
                results[userId] = await this.assignCommunitiesToUser(userId);
            }
            catch (error) {
                console.error(`Error assigning communities to user ${userId}:`, error);
                results[userId] = [];
            }
        }
        return results;
    }
};
exports.CommunityAssignmentService = CommunityAssignmentService;
exports.CommunityAssignmentService = CommunityAssignmentService = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [typeof (_a = typeof prisma_client_provider_1.PrismaService !== "undefined" && prisma_client_provider_1.PrismaService) === "function" ? _a : Object])
], CommunityAssignmentService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL2NvbW11bml0aWVzL2NvbW11bml0eS1hc3NpZ25tZW50LnNlcnZpY2UudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7OztBQUFBLDJDQUE0QztBQUM1QyxpRkFBcUU7QUFDckUsbUVBQWtFO0FBVzNELElBQU0sMEJBQTBCLEdBQWhDLE1BQU0sMEJBQTBCO0lBQ1I7SUFBN0IsWUFBNkIsTUFBcUI7UUFBckIsV0FBTSxHQUFOLE1BQU0sQ0FBZTtJQUFHLENBQUM7SUFFdEQ7O09BRUc7SUFDYyw4QkFBOEIsR0FBRztRQUNoRCxpQ0FBaUM7UUFDakMsT0FBTyxFQUFFLG9CQUFvQjtRQUM3QixlQUFlLEVBQUUsb0JBQW9CO1FBRXJDLDhCQUE4QjtRQUM5QixlQUFlLEVBQUUsa0JBQWtCO1FBQ25DLGVBQWUsRUFBRSx3QkFBd0I7UUFDekMsZ0JBQWdCLEVBQUUsa0JBQWtCO1FBQ3BDLE1BQU0sRUFBRSxnQkFBZ0I7UUFFeEIsNkJBQTZCO1FBQzdCLHdCQUF3QixFQUFFLGdCQUFnQjtRQUMxQyxPQUFPLEVBQUUsa0JBQWtCO1FBRTNCLDRCQUE0QjtRQUM1QixRQUFRLEVBQUUsa0JBQWtCO1FBRTVCLDZCQUE2QjtRQUM3QixJQUFJLEVBQUUsY0FBYztRQUVwQiwwQkFBMEI7UUFDMUIsd0JBQXdCLEVBQUUsYUFBYTtRQUV2QywyQkFBMkI7UUFDM0IsSUFBSSxFQUFFLGNBQWM7UUFFcEIsOEJBQThCO1FBQzlCLGNBQWMsRUFBRSwwQkFBMEI7UUFFMUMsNEJBQTRCO1FBQzVCLE9BQU8sRUFBRSw0QkFBNEI7UUFDckMsWUFBWSxFQUFFLDRCQUE0QjtLQUMzQyxDQUFDO0lBRUY7OztPQUdHO0lBQ2Msa0JBQWtCLEdBQUc7UUFDcEMsT0FBTyxFQUFFLEtBQUs7UUFDZCxJQUFJLEVBQUUsS0FBSztRQUNYLFFBQVEsRUFBRSxJQUFJO1FBQ2QsTUFBTSxFQUFFLElBQUk7UUFDWixhQUFhLEVBQUUs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QUMsQ0FBQyxDQUFDLElBQUksS0FBSyxhQUFhLENBQ2hDLENBQUM7Z0JBQ0YsSUFBSSxTQUFTLEVBQUUsQ0FBQztvQkFDZCxzQkFBc0IsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxDQUFDO2dCQUM5QyxDQUFDO1lBQ0gsQ0FBQztRQUNILENBQUM7UUFFRCxPQUFPLHNCQUFzQixDQUFDO0lBQ2hDLENBQUM7SUFFRDs7T0FFRztJQUNILEtBQUssQ0FBQyxxQkFBcUIsQ0FDekIsT0FBaUI7UUFFakIsTUFBTSxPQUFPLEdBQW1DLEVBQUUsQ0FBQztRQUVuRCxLQUFLLE1BQU0sTUFBTSxJQUFJLE9BQU8sRUFBRSxDQUFDO1lBQzdCLElBQUksQ0FBQztnQkFDSCxPQUFPLENBQUMsTUFBTSxDQUFDLEdBQUcsTUFBTSxJQUFJLENBQUMsdUJBQXVCLENBQUMsTUFBTSxDQUFDLENBQUM7WUFDL0QsQ0FBQztZQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7Z0JBQ2YsT0FBTyxDQUFDLEtBQUssQ0FBQyx1Q0FBdUMsTUFBTSxHQUFHLEVBQUUsS0FBSyxDQUFDLENBQUM7Z0JBQ3ZFLE9BQU8sQ0FBQyxNQUFNLENBQUMsR0FBRyxFQUFFLENBQUM7WUFDdkIsQ0FBQztRQUNILENBQUM7UUFFRCxPQUFPLE9BQU8sQ0FBQztJQUNqQixDQUFDO0NBQ0YsQ0FBQTtBQTVPWSxnRUFBMEI7cUNBQTFCLDBCQUEwQjtJQUR0QyxJQUFBLG1CQUFVLEdBQUU7eURBRTBCLHNDQUFhLG9CQUFiLHNDQUFhO0dBRHZDLDBCQUEwQixDQTRPdEMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL2NvbW11bml0aWVzL2NvbW11bml0eS1hc3NpZ25tZW50LnNlcnZpY2UudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0BuZXN0anMvY29tbW9uJztcbmltcG9ydCB7IFByaXNtYVNlcnZpY2UgfSBmcm9tICdzcmMvcHJvdmlkZXJzL3ByaXNtYS1jbGllbnQucHJvdmlkZXInO1xuaW1wb3J0IHsgSUxMTkVTU19DT01NVU5JVElFUyB9IGZyb20gJy4uL2NvbmZpZy9jb21tdW5pdHktY29uZmlncyc7XG5cbmludGVyZmFjZSBQcmVBc3Nlc3NtZW50U2NvcmVzIHtcbiAgW2tleTogc3RyaW5nXTogbnVtYmVyO1xufVxuXG5pbnRlcmZhY2UgU2V2ZXJpdHlMZXZlbHMge1xuICBba2V5OiBzdHJpbmddOiBzdHJpbmc7XG59XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBDb21tdW5pdHlBc3NpZ25tZW50U2VydmljZSB7XG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgcmVhZG9ubHkgcHJpc21hOiBQcmlzbWFTZXJ2aWNlKSB7fVxuXG4gIC8qKlxuICAgKiBNYXBzIHF1ZXN0aW9ubmFpcmUgdHlwZXMgdG8gY29tbXVuaXR5IHNsdWdzIGJhc2VkIG9uIG1lbnRhbCBoZWFsdGggY29uZGl0aW9uc1xuICAgKi9cbiAgcHJpdmF0ZSByZWFkb25seSBRVUVTVElPTk5BSVJFX1RPX0NPTU1VTklUWV9NQVAgPSB7XG4gICAgLy8gRGVwcmVzc2lvbi1yZWxhdGVkIGFzc2Vzc21lbnRzXG4gICAgJ3BocS05JzogJ2RlcHJlc3Npb24tc3VwcG9ydCcsXG4gICAgJ21vb2QtZGlzb3JkZXInOiAnZGVwcmVzc2lvbi1zdXBwb3J0JyxcblxuICAgIC8vIEFueGlldHktcmVsYXRlZCBhc3Nlc3NtZW50c1xuICAgICdnYWQtNy1hbnhpZXR5JzogJ2FueGlldHktd2FycmlvcnMnLFxuICAgICdzb2NpYWwtcGhvYmlhJzogJ3NvY2lhbC1hbnhpZXR5LXN1cHBvcnQnLFxuICAgICdwYW5pYy1kaXNvcmRlcic6ICdhbnhpZXR5LXdhcnJpb3JzJyxcbiAgICBwaG9iaWE6ICdwaG9iaWEtc3VwcG9ydCcsXG5cbiAgICAvLyBTdHJlc3MtcmVsYXRlZCBhc3Nlc3NtZW50c1xuICAgICdwZXJjZWl2ZWQtc3RyZXNzLXNjYWxlJzogJ3N0cmVzcy1zdXBwb3J0JyxcbiAgICBidXJub3V0OiAnYnVybm91dC1yZWNvdmVyeScsXG5cbiAgICAvLyBTbGVlcC1yZWxhdGVkIGFzc2Vzc21lbnRzXG4gICAgaW5zb21uaWE6ICdpbnNvbW5pYS1zdXBwb3J0JyxcblxuICAgIC8vIFRyYXVtYS1yZWxhdGVkIGFzc2Vzc21lbnRzXG4gICAgcHRzZDogJ3B0c2Qtc3VwcG9ydCcsXG5cbiAgICAvLyBPQ0QtcmVsYXRlZCBhc3Nlc3NtZW50c1xuICAgICdvYnNlc3Npb25hbC1jb21wdWxzaXZlJzogJ29jZC1zdXBwb3J0JyxcblxuICAgIC8vIEFESEQtcmVsYXRlZCBhc3Nlc3NtZW50c1xuICAgIGFkaGQ6ICdhZGhkLXN1cHBvcnQnLFxuXG4gICAgLy8gRWF0aW5nIGRpc29yZGVyIGFzc2Vzc21lbnRzXG4gICAgJ2JpbmdlLWVhdGluZyc6ICdlYXRpbmctZGlzb3JkZXItcmVjb3ZlcnknLFxuXG4gICAgLy8gU3Vic3RhbmNlIHVzZSBhc3Nlc3NtZW50c1xuICAgIGFsY29ob2w6ICdzdWJzdGFuY2UtcmVjb3Zlcnktc3VwcG9ydCcsXG4gICAgJ2RydWctYWJ1c2UnOiAnc3Vic3RhbmNlLXJlY292ZXJ5LXN1cHBvcnQnLFxuICB9O1xuXG4gIC8qKlxuICAgKiBTZXZlcml0eSB0aHJlc2hvbGRzIGZvciBjb21tdW5pdHkgYXNzaWdubWVudFxuICAgKiBPbmx5IGFzc2lnbiB0byBjb21tdW5pdGllcyBpZiBzZXZlcml0eSBpcyBtb2RlcmF0ZSBvciBoaWdoZXJcbiAgICovXG4gIHByaXZhdGUgcmVhZG9ubHkgU0VWRVJJVFlfVEhSRVNIT0xEID0ge1xuICAgIG1pbmltYWw6IGZhbHNlLFxuICAgIG1pbGQ6IGZhbHNlLFxuICAgIG1vZGVyYXRlOiB0cnVlLFxuICAgIHNldmVyZTogdHJ1ZSxcbiAgICAndmVyeS1zZXZlcmUnOiB0cnVlLFxuICB9O1xuXG4gIC8qKlxuICAgKiBBdXRvLWFzc2lnbiBjb21tdW5pdGllcyB0byBhIHVzZXIgYmFzZWQgb24gdGhlaXIgcHJlLWFzc2Vzc21lbnQgcmVzdWx0c1xuICAgKi9cbiAgYXN5bmMgYXNzaWduQ29tbXVuaXRpZXNUb1VzZXIodXNlcklkOiBzdHJpbmcpOiBQcm9taXNlPHN0cmluZ1tdPiB7XG4gICAgY29uc29sZS5sb2coYPCflIQgQXV0by1hc3NpZ25pbmcgY29tbXVuaXRpZXMgZm9yIHVzZXI6ICR7dXNlcklkfWApO1xuXG4gICAgLy8gR2V0IHVzZXIncyBwcmUtYXNzZXNzbWVudCBkYXRhXG4gICAgY29uc3QgdXNlckFzc2Vzc21lbnQgPSBhd2FpdCB0aGlzLnByaXNtYS5wcmVBc3Nlc3NtZW50LmZpbmRGaXJzdCh7XG4gICAgICB3aGVyZTogeyBjbGllbnRJZDogdXNlcklkIH0sXG4gICAgfSk7XG5cbiAgICBpZiAoIXVzZXJBc3Nlc3NtZW50KSB7XG4gICAgICBjb25zb2xlLmxvZyhg4pqg77iPICBObyBwcmUtYXNzZXNzbWVudCBmb3VuZCBmb3IgdXNlcjogJHt1c2VySWR9YCk7XG4gICAgICByZXR1cm4gW107XG4gICAgfVxuXG4gICAgY29uc3Qgc2NvcmVzID0gdXNlckFzc2Vzc21lbnQuc2NvcmVzIGFzIFByZUFzc2Vzc21lbnRTY29yZXM7XG4gICAgY29uc3Qgc2V2ZXJpdHlMZXZlbHMgPSB1c2VyQXNzZXNzbWVudC5zZXZlcml0eUxldmVscyBhcyBTZXZlcml0eUxldmVscztcbiAgICBjb25zdCBhc3NpZ25lZENvbW11bml0aWVzOiBzdHJpbmdbXSA9IFtdO1xuXG4gICAgLy8gSXRlcmF0ZSB0aHJvdWdoIHF1ZXN0aW9ubmFpcmUgcmVzdWx0cyBhbmQgYXNzaWduIGNvbW11bml0aWVzXG4gICAgZm9yIChjb25zdCBbcXVlc3Rpb25uYWlyZV0gb2YgT2JqZWN0LmVudHJpZXMoc2NvcmVzKSkge1xuICAgICAgY29uc3Qgc2V2ZXJpdHkgPSBzZXZlcml0eUxldmVsc1txdWVzdGlvbm5haXJlXTtcbiAgICAgIGNvbnN0IGNvbW11bml0eVNsdWcgPSB0aGlzLlFVRVNUSU9OTkFJUkVfVE9fQ09NTVVOSVRZX01BUFtxdWVzdGlvbm5haXJlXTtcblxuICAgICAgLy8gU2tpcCBpZiBubyBjb21tdW5pdHkgbWFwcGluZyBvciBzZXZlcml0eSBpcyB0b28gbG93XG4gICAgICBpZiAoIWNvbW11bml0eVNsdWcgfHwgIXRoaXMuU0VWRVJJVFlfVEhSRVNIT0xEW3NldmVyaXR5Py50b0xvd2VyQ2FzZSgpXSkge1xuICAgICAgICBjb250aW51ZTtcbiAgICAgIH1cblxuICAgICAgLy8gRmluZCB0aGUgY29tbXVuaXR5XG4gICAgICBjb25zdCBjb21tdW5pdHkgPSBhd2FpdCB0aGlzLnByaXNtYS5jb21tdW5pdHkuZmluZFVuaXF1ZSh7XG4gICAgICAgIHdoZXJlOiB7IHNsdWc6IGNvbW11bml0eVNsdWcgfSxcbiAgICAgIH0pO1xuXG4gICAgICBpZiAoIWNvbW11bml0eSkge1xuICAgICAgICBjb25zb2xlLmxvZyhg4pqg77iPICBDb21tdW5pdHkgbm90IGZvdW5kIGZvciBzbHVnOiAke2NvbW11bml0eVNsdWd9YCk7XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfVxuXG4gICAgICAvLyBDaGVjayBpZiB1c2VyIGlzIGFscmVhZHkgYSBtZW1iZXJcbiAgICAgIGNvbnN0IGV4aXN0aW5nTWVtYmVyc2hpcCA9IGF3YWl0IHRoaXMucHJpc21hLm1lbWJlcnNoaXAuZmluZFVuaXF1ZSh7XG4gICAgICAgIHdoZXJlOiB7XG4gICAgICAgICAgdXNlcklkX2NvbW11bml0eUlkOiB7XG4gICAgICAgICAgICB1c2VySWQ6IHVzZXJJZCxcbiAgICAgICAgICAgIGNvbW11bml0eUlkOiBjb21tdW5pdHkuaWQsXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgIH0pO1xuXG4gICAgICBpZiAoZXhpc3RpbmdNZW1iZXJzaGlwKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKGDij63vuI8gIFVzZXIgYWxyZWFkeSBtZW1iZXIgb2Y6ICR7Y29tbXVuaXR5Lm5hbWV9YCk7XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfVxuXG4gICAgICAvLyBDcmVhdGUgbWVtYmVyc2hpcFxuICAgICAgdHJ5IHtcbiAgICAgICAgYXdhaXQgdGhpcy5wcmlzbWEubWVtYmVyc2hpcC5jcmVhdGUoe1xuICAgICAgICAgIGRhdGE6IHtcbiAgICAgICAgICAgIHVzZXJJZDogdXNlcklkLFxuICAgICAgICAgICAgY29tbXVuaXR5SWQ6IGNvbW11bml0eS5pZCxcbiAgICAgICAgICAgIHJvbGU6ICdtZW1iZXInLFxuICAgICAgICAgICAgam9pbmVkQXQ6IG5ldyBEYXRlKCksXG4gICAgICAgICAgfSxcbiAgICAgICAgfSk7XG5cbiAgICAgICAgYXNzaWduZWRDb21tdW5pdGllcy5wdXNoKGNvbW11bml0eS5uYW1lKTtcbiAgICAgICAgY29uc29sZS5sb2coXG4gICAgICAgICAgYOKchSBBc3NpZ25lZCB1c2VyIHRvIGNvbW11bml0eTogJHtjb21tdW5pdHkubmFtZX0gKCR7c2V2ZXJpdHl9ICR7cXVlc3Rpb25uYWlyZX0pYCxcbiAgICAgICAgKTtcbiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoXG4gICAgICAgICAgYOKdjCBGYWlsZWQgdG8gYXNzaWduIGNvbW11bml0eSAke2NvbW11bml0eS5uYW1lfTpgLFxuICAgICAgICAgIGVycm9yLFxuICAgICAgICApO1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vIEFsd2F5cyBhc3NpZ24gdG8gZ2VuZXJhbCBzdXBwb3J0IGNvbW11bml0aWVzXG4gICAgYXdhaXQgdGhpcy5hc3NpZ25HZW5lcmFsU3VwcG9ydENvbW11bml0aWVzKHVzZXJJZCk7XG5cbiAgICBjb25zb2xlLmxvZyhcbiAgICAgIGDwn46vIEF1dG8tYXNzaWdubWVudCBjb21wbGV0ZS4gQXNzaWduZWQgJHthc3NpZ25lZENvbW11bml0aWVzLmxlbmd0aH0gY29tbXVuaXRpZXMuYCxcbiAgICApO1xuICAgIHJldHVybiBhc3NpZ25lZENvbW11bml0aWVzO1xuICB9XG5cbiAgLyoqXG4gICAqIEFzc2lnbiB1c2VyIHRvIGdlbmVyYWwgc3VwcG9ydCBjb21tdW5pdGllcyByZWdhcmRsZXNzIG9mIGFzc2Vzc21lbnQgcmVzdWx0c1xuICAgKi9cbiAgcHJpdmF0ZSBhc3luYyBhc3NpZ25HZW5lcmFsU3VwcG9ydENvbW11bml0aWVzKHVzZXJJZDogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgY29uc3QgZ2VuZXJhbENvbW11bml0aWVzID0gWydTdXBwb3J0IENpcmNsZScsICdNaW5kZnVsbmVzcyAmIE1lZGl0YXRpb24nXTtcblxuICAgIGZvciAoY29uc3QgY29tbXVuaXR5TmFtZSBvZiBnZW5lcmFsQ29tbXVuaXRpZXMpIHtcbiAgICAgIGNvbnN0IGNvbW11bml0eSA9IGF3YWl0IHRoaXMucHJpc21hLmNvbW11bml0eS5maW5kRmlyc3Qoe1xuICAgICAgICB3aGVyZTogeyBuYW1lOiBjb21tdW5pdHlOYW1lIH0sXG4gICAgICB9KTtcblxuICAgICAgaWYgKCFjb21tdW5pdHkpIGNvbnRpbnVlO1xuXG4gICAgICAvLyBDaGVjayBpZiB1c2VyIGlzIGFscmVhZHkgYSBtZW1iZXJcbiAgICAgIGNvbnN0IGV4aXN0aW5nTWVtYmVyc2hpcCA9IGF3YWl0IHRoaXMucHJpc21hLm1lbWJlcnNoaXAuZmluZFVuaXF1ZSh7XG4gICAgICAgIHdoZXJlOiB7XG4gICAgICAgICAgdXNlcklkX2NvbW11bml0eUlkOiB7XG4gICAgICAgICAgICB1c2VySWQ6IHVzZXJJZCxcbiAgICAgICAgICAgIGNvbW11bml0eUlkOiBjb21tdW5pdHkuaWQsXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgIH0pO1xuXG4gICAgICBpZiAoZXhpc3RpbmdNZW1iZXJzaGlwKSBjb250aW51ZTtcblxuICAgICAgdHJ5IHtcbiAgICAgICAgYXdhaXQgdGhpcy5wcmlzbWEubWVtYmVyc2hpcC5jcmVhdGUoe1xuICAgICAgICAgIGRhdGE6IHtcbiAgICAgICAgICAgIHVzZXJJZDogdXNlcklkLFxuICAgICAgICAgICAgY29tbXVuaXR5SWQ6IGNvbW11bml0eS5pZCxcbiAgICAgICAgICAgIHJvbGU6ICdtZW1iZXInLFxuICAgICAgICAgICAgam9pbmVkQXQ6IG5ldyBEYXRlKCksXG4gICAgICAgICAgfSxcbiAgICAgICAgfSk7XG4gICAgICAgIGNvbnNvbGUubG9nKGDinIUgQXNzaWduZWQgdXNlciB0byBnZW5lcmFsIGNvbW11bml0eTogJHtjb21tdW5pdHkubmFtZX1gKTtcbiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoXG4gICAgICAgICAgYOKdjCBGYWlsZWQgdG8gYXNzaWduIGdlbmVyYWwgY29tbXVuaXR5ICR7Y29tbXVuaXR5Lm5hbWV9OmAsXG4gICAgICAgICAgZXJyb3IsXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEdldCBjb21tdW5pdGllcyBhIHVzZXIgc2hvdWxkIGJlIGFzc2lnbmVkIHRvIGJhc2VkIG9uIHRoZWlyIGFzc2Vzc21lbnQgKHByZXZpZXcgbW9kZSlcbiAgICovXG4gIGFzeW5jIGdldFJlY29tbWVuZGVkQ29tbXVuaXRpZXModXNlcklkOiBzdHJpbmcpOiBQcm9taXNlPHN0cmluZ1tdPiB7XG4gICAgY29uc3QgdXNlckFzc2Vzc21lbnQgPSBhd2FpdCB0aGlzLnByaXNtYS5wcmVBc3Nlc3NtZW50LmZpbmRGaXJzdCh7XG4gICAgICB3aGVyZTogeyBjbGllbnRJZDogdXNlcklkIH0sXG4gICAgfSk7XG5cbiAgICBpZiAoIXVzZXJBc3Nlc3NtZW50KSB7XG4gICAgICByZXR1cm4gW107XG4gICAgfVxuXG4gICAgY29uc3Qgc2NvcmVzID0gdXNlckFzc2Vzc21lbnQuc2NvcmVzIGFzIFByZUFzc2Vzc21lbnRTY29yZXM7XG4gICAgY29uc3Qgc2V2ZXJpdHlMZXZlbHMgPSB1c2VyQXNzZXNzbWVudC5zZXZlcml0eUxldmVscyBhcyBTZXZlcml0eUxldmVscztcbiAgICBjb25zdCByZWNvbW1lbmRlZENvbW11bml0aWVzOiBzdHJpbmdbXSA9IFtdO1xuXG4gICAgZm9yIChjb25zdCBbcXVlc3Rpb25uYWlyZV0gb2YgT2JqZWN0LmVudHJpZXMoc2NvcmVzKSkge1xuICAgICAgY29uc3Qgc2V2ZXJpdHkgPSBzZXZlcml0eUxldmVsc1txdWVzdGlvbm5haXJlXTtcbiAgICAgIGNvbnN0IGNvbW11bml0eVNsdWcgPSB0aGlzLlFVRVNUSU9OTkFJUkVfVE9fQ09NTVVOSVRZX01BUFtxdWVzdGlvbm5haXJlXTtcblxuICAgICAgaWYgKGNvbW11bml0eVNsdWcgJiYgdGhpcy5TRVZFUklUWV9USFJFU0hPTERbc2V2ZXJpdHk/LnRvTG93ZXJDYXNlKCldKSB7XG4gICAgICAgIGNvbnN0IGNvbW11bml0eSA9IElMTE5FU1NfQ09NTVVOSVRJRVMuZmluZChcbiAgICAgICAgICAoYykgPT4gYy5zbHVnID09PSBjb21tdW5pdHlTbHVnLFxuICAgICAgICApO1xuICAgICAgICBpZiAoY29tbXVuaXR5KSB7XG4gICAgICAgICAgcmVjb21tZW5kZWRDb21tdW5pdGllcy5wdXNoKGNvbW11bml0eS5uYW1lKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiByZWNvbW1lbmRlZENvbW11bml0aWVzO1xuICB9XG5cbiAgLyoqXG4gICAqIEJ1bGsgYXNzaWduIGNvbW11bml0aWVzIHRvIG11bHRpcGxlIHVzZXJzICh1c2VmdWwgZm9yIGV4aXN0aW5nIHVzZXJzKVxuICAgKi9cbiAgYXN5bmMgYnVsa0Fzc2lnbkNvbW11bml0aWVzKFxuICAgIHVzZXJJZHM6IHN0cmluZ1tdLFxuICApOiBQcm9taXNlPHsgW3VzZXJJZDogc3RyaW5nXTogc3RyaW5nW10gfT4ge1xuICAgIGNvbnN0IHJlc3VsdHM6IHsgW3VzZXJJZDogc3RyaW5nXTogc3RyaW5nW10gfSA9IHt9O1xuXG4gICAgZm9yIChjb25zdCB1c2VySWQgb2YgdXNlcklkcykge1xuICAgICAgdHJ5IHtcbiAgICAgICAgcmVzdWx0c1t1c2VySWRdID0gYXdhaXQgdGhpcy5hc3NpZ25Db21tdW5pdGllc1RvVXNlcih1c2VySWQpO1xuICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgY29uc29sZS5lcnJvcihgRXJyb3IgYXNzaWduaW5nIGNvbW11bml0aWVzIHRvIHVzZXIgJHt1c2VySWR9OmAsIGVycm9yKTtcbiAgICAgICAgcmVzdWx0c1t1c2VySWRdID0gW107XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIHJlc3VsdHM7XG4gIH1cbn1cbiJdLCJ2ZXJzaW9uIjozfQ==