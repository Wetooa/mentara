e0c7c2176b512abb0b3a4151c070c89d
"use strict";
/**
 * Enhanced Test Helpers for Mentara Backend Testing
 * Provides advanced utilities for comprehensive testing
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.IntegrationTestHelpers = exports.DatabaseTestUtils = exports.PerformanceTestUtils = exports.TestAssertions = exports.TestDataGenerator = exports.MockBuilder = void 0;
const testing_1 = require("@nestjs/testing");
const prisma_client_provider_1 = require("../providers/prisma-client.provider");
const index_1 = require("./index");
// Enhanced Mock Builders
class MockBuilder {
    /**
     * Creates a comprehensive NestJS testing module with all common mocks
     */
    static async createTestingModule(providers = []) {
        return testing_1.Test.createTestingModule({
            providers: [
                ...providers,
                {
                    provide: prisma_client_provider_1.PrismaService,
                    useValue: (0, index_1.createMockPrismaService)(),
                },
                {
                    provide: 'EventBusService',
                    useValue: {
                        emit: jest.fn(),
                        subscribe: jest.fn(),
                    },
                },
                {
                    provide: 'EmailService',
                    useValue: {
                        sendEmail: jest.fn(),
                        sendTemplateEmail: jest.fn(),
                    },
                },
            ],
        }).compile();
    }
    /**
     * Creates mock authentication context
     */
    static createAuthContext(role = 'client', userId) {
        return {
            userId: userId || index_1.TEST_USER_IDS[role.toUpperCase()],
            role,
            email: index_1.TEST_EMAILS[role.toUpperCase()],
            isActive: true,
            isVerified: true,
        };
    }
    /**
     * Creates mock request object with authentication
     */
    static createMockRequest(role = 'client', userId) {
        const authContext = this.createAuthContext(role, userId);
        return {
            user: authContext,
            headers: {
                authorization: `Bearer mock-jwt-token-${role}`,
                'user-agent': 'test-agent',
            },
            ip: '127.0.0.1',
            method: 'GET',
            url: '/test',
        };
    }
}
exports.MockBuilder = MockBuilder;
// Test Data Generators
class TestDataGenerator {
    /**
     * Generates realistic test user data
     */
    static createUser(overrides = {}) {
        return {
            id: `user-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
            email: `test-${Date.now()}@example.com`,
            firstName: 'Test',
            lastName: 'User',
            role: 'client',
            isActive: true,
            isVerified: false,
            createdAt: new Date(),
            updatedAt: new Date(),
            ...overrides,
        };
    }
    /**
     * Generates therapist application data
     */
    static createTherapistApplication(overrides = {}) {
        return {
            userId: index_1.TEST_USER_IDS.THERAPIST,
            email: index_1.TEST_EMAILS.THERAPIST,
            firstName: 'Dr. Test',
            lastName: 'Therapist',
            mobile: '+1234567890',
            province: 'Test Province',
            providerType: 'Licensed Clinical Psychologist',
            professionalLicenseType: 'LCP',
            isPRCLicensed: 'yes',
            prcLicenseNumber: 'LCP-12345',
            practiceStartDate: new Date('2020-01-01'),
            areasOfExpertise: ['anxiety', 'depression'],
            therapeuticApproachesUsedList: ['CBT', 'DBT'],
            languagesOffered: ['English'],
            assessmentTools: ['GAD-7', 'PHQ-9'],
            providedOnlineTherapyBefore: true,
            comfortableUsingVideoConferencing: true,
            weeklyAvailability: '20-30 hours',
            preferredSessionLength: '60',
            hourlyRate: 150.00,
            ...overrides,
        };
    }
    /**
     * Generates meeting/session data
     */
    static createMeeting(overrides = {}) {
        const now = new Date();
        const futureDate = new Date(now.getTime() + 24 * 60 * 60 * 1000); // Tomorrow
        return {
            id: `meeting-${Date.now()}`,
            title: 'Test Therapy Session',
            startTime: futureDate,
            duration: 60,
            status: 'SCHEDULED',
            meetingType: 'video',
            clientId: index_1.TEST_USER_IDS.CLIENT,
            therapistId: index_1.TEST_USER_IDS.THERAPIST,
            createdAt: now,
            updatedAt: now,
            ...overrides,
        };
    }
    /**
     * Generates message data for testing
     */
    static createMessage(overrides = {}) {
        return {
            id: `message-${Date.now()}`,
            conversationId: `conversation-${Date.now()}`,
            senderId: index_1.TEST_USER_IDS.CLIENT,
            content: 'Test message content',
            messageType: 'TEXT',
            isEdited: false,
            isDeleted: false,
            createdAt: new Date(),
            updatedAt: new Date(),
            ...overrides,
        };
    }
    /**
     * Generates assessment data
     */
    static createPreAssessment(overrides = {}) {
        // Generate 201 random answers (1-5 scale)
        const answers = Array.from({ length: 201 }, () => Math.floor(Math.random() * 5) + 1);
        return {
            id: `assessment-${Date.now()}`,
            userId: index_1.TEST_USER_IDS.CLIENT,
            responses: answers,
            completedAt: new Date(),
            scores: {
                anxiety: 65,
                depression: 45,
                stress: 55,
            },
            createdAt: new Date(),
            updatedAt: new Date(),
            ...overrides,
        };
    }
}
exports.TestDataGenerator = TestDataGenerator;
// Test Assertion Helpers
class TestAssertions {
    /**
     * Asserts that a function throws a specific NestJS exception
     */
    static async expectToThrowNestException(asyncFn, exceptionType, expectedMessage) {
        let thrownError = null;
        try {
            await asyncFn();
        }
        catch (error) {
            thrownError = error;
        }
        expect(thrownError).toBeInstanceOf(exceptionType);
        if (expectedMessage) {
            expect(thrownError.message).toContain(expectedMessage);
        }
    }
    /**
     * Asserts proper DTO validation
     */
    static expectValidDto(dto, expectedFields) {
        expectedFields.forEach(field => {
            expect(dto).toHaveProperty(field);
            expect(dto[field]).toBeDefined();
        });
    }
    /**
     * Asserts proper database entity structure
     */
    static expectValidEntity(entity, requiredFields) {
        expect(entity).toBeDefined();
        expect(entity).not.toBeNull();
        requiredFields.forEach(field => {
            expect(entity).toHaveProperty(field);
        });
        // Common entity fields
        expect(entity).toHaveProperty('id');
        expect(entity).toHaveProperty('createdAt');
        expect(entity).toHaveProperty('updatedAt');
    }
    /**
     * Asserts proper API response structure
     */
    static expectValidApiResponse(response, expectedData) {
        expect(response).toBeDefined();
        if (expectedData) {
            expect(response).toMatchObject(expectedData);
        }
    }
}
exports.TestAssertions = TestAssertions;
// Performance Testing Utilities
class PerformanceTestUtils {
    /**
     * Measures function execution time
     */
    static async measureExecutionTime(fn) {
        const start = process.hrtime.bigint();
        const result = await fn();
        const end = process.hrtime.bigint();
        const duration = Number(end - start) / 1_000_000; // Convert to milliseconds
        return { result, duration };
    }
    /**
     * Asserts that a function executes within a time limit
     */
    static async expectToExecuteWithin(fn, maxDurationMs) {
        const { result, duration } = await this.measureExecutionTime(fn);
        expect(duration).toBeLessThan(maxDurationMs);
        return result;
    }
    /**
     * Runs a function multiple times and measures average performance
     */
    static async benchmarkFunction(fn, iterations = 10) {
        const durations = [];
        for (let i = 0; i < iterations; i++) {
            const { duration } = await this.measureExecutionTime(fn);
            durations.push(duration);
        }
        return {
            averageDuration: durations.reduce((sum, d) => sum + d, 0) / durations.length,
            minDuration: Math.min(...durations),
            maxDuration: Math.max(...durations),
        };
    }
}
exports.PerformanceTestUtils = PerformanceTestUtils;
// Database Testing Utilities
class DatabaseTestUtils {
    /**
     * Creates a transaction-wrapped test for database operations
     */
    static withTransaction(testFn) {
        return async () => {
            const mockPrisma = (0, index_1.createMockPrismaService)();
            // Mock transaction behavior
            mockPrisma.$transaction = jest.fn(async (callback) => {
                return callback(mockPrisma);
            });
            await testFn(mockPrisma);
        };
    }
    /**
     * Validates that proper database constraints are checked
     */
    static expectDatabaseConstraintError(error, constraintType) {
        expect(error).toBeDefined();
        expect(error.message).toContain(constraintType);
    }
}
exports.DatabaseTestUtils = DatabaseTestUtils;
// Integration Testing Helpers
class IntegrationTestHelpers {
    /**
     * Creates a full request context for integration tests
     */
    static createFullRequestContext(role = 'client') {
        return {
            user: MockBuilder.createAuthContext(role),
            request: MockBuilder.createMockRequest(role),
            response: {
                status: jest.fn().mockReturnThis(),
                json: jest.fn().mockReturnThis(),
                send: jest.fn().mockReturnThis(),
            },
        };
    }
    /**
     * Simulates a complete authentication flow
     */
    static async simulateAuthFlow(role = 'client') {
        const authContext = MockBuilder.createAuthContext(role);
        // Mock the authentication process
        const mockClerkUser = {
            id: authContext.userId,
            emailAddresses: [{ emailAddress: authContext.email }],
            firstName: 'Test',
            lastName: 'User',
        };
        return { authContext, mockClerkUser };
    }
}
exports.IntegrationTestHelpers = IntegrationTestHelpers;
// All utilities are already exported above via class declarations
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL3Rlc3QtdXRpbHMvZW5oYW5jZWQtdGVzdC1oZWxwZXJzLnRzIiwibWFwcGluZ3MiOiI7QUFBQTs7O0dBR0c7OztBQUVILDZDQUFzRDtBQUN0RCxnRkFBb0U7QUFDcEUsbUNBQThFO0FBRTlFLHlCQUF5QjtBQUN6QixNQUFhLFdBQVc7SUFDdEI7O09BRUc7SUFDSCxNQUFNLENBQUMsS0FBSyxDQUFDLG1CQUFtQixDQUFDLFlBQW1CLEVBQUU7UUFDcEQsT0FBTyxjQUFJLENBQUMsbUJBQW1CLENBQUM7WUFDOUIsU0FBUyxFQUFFO2dCQUNULEdBQUcsU0FBUztnQkFDWjtvQkFDRSxPQUFPLEVBQUUsc0NBQWE7b0JBQ3RCLFFBQVEsRUFBRSxJQUFBLCtCQUF1QixHQUFFO2lCQUNwQztnQkFDRDtvQkFDRSxPQUFPLEVBQUUsaUJBQWlCO29CQUMxQixRQUFRLEVBQUU7d0JBQ1IsSUFBSSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7d0JBQ2YsU0FBUyxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7cUJBQ3JCO2lCQUNGO2dCQUNEO29CQUNFLE9BQU8sRUFBRSxjQUFjO29CQUN2QixRQUFRLEVBQUU7d0JBQ1IsU0FBUyxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7d0JBQ3BCLGlCQUFpQixFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7cUJBQzdCO2lCQUNGO2FBQ0Y7U0FDRixDQUFDLENBQUMsT0FBTyxFQUFFLENBQUM7SUFDZixDQUFDO0lBRUQ7O09BRUc7SUFDSCxNQUFNLENBQUMsaUJBQWlCLENBQUMsT0FBZSxRQUFRLEVBQUUsTUFBZTtRQUMvRCxPQUFPO1lBQ0wsTUFBTSxFQUFFLE1BQU0sSUFBSSxxQkFBYSxDQUFDLElBQUksQ0FBQyxXQUFXLEVBQWdDLENBQUM7WUFDakYsSUFBSTtZQUNKLEtBQUssRUFBRSxtQkFBVyxDQUFDLElBQUksQ0FBQyxXQUFXLEVBQThCLENBQUM7WUFD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QyxjQUFjLEVBQUU7Z0JBQ2hDLElBQUksRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsY0FBYyxFQUFFO2FBQ2pDO1NBQ0YsQ0FBQztJQUNKLENBQUM7SUFFRDs7T0FFRztJQUNILE1BQU0sQ0FBQyxLQUFLLENBQUMsZ0JBQWdCLENBQUMsT0FBZSxRQUFRO1FBQ25ELE1BQU0sV0FBVyxHQUFHLFdBQVcsQ0FBQyxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUV4RCxrQ0FBa0M7UUFDbEMsTUFBTSxhQUFhLEdBQUc7WUFDcEIsRUFBRSxFQUFFLFdBQVcsQ0FBQyxNQUFNO1lBQ3RCLGNBQWMsRUFBRSxDQUFDLEVBQUUsWUFBWSxFQUFFLFdBQVcsQ0FBQyxLQUFLLEVBQUUsQ0FBQztZQUNyRCxTQUFTLEVBQUUsTUFBTTtZQUNqQixRQUFRLEVBQUUsTUFBTTtTQUNqQixDQUFDO1FBRUYsT0FBTyxFQUFFLFdBQVcsRUFBRSxhQUFhLEVBQUUsQ0FBQztJQUN4QyxDQUFDO0NBQ0Y7QUFoQ0Qsd0RBZ0NDO0FBRUQsa0VBQWtFIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9ob21lL3dldG9vYS9Eb2N1bWVudHMvY29kZS9wcm9qZWN0cy9tZW50YXJhL21lbnRhcmEtYXBpL3NyYy90ZXN0LXV0aWxzL2VuaGFuY2VkLXRlc3QtaGVscGVycy50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIEVuaGFuY2VkIFRlc3QgSGVscGVycyBmb3IgTWVudGFyYSBCYWNrZW5kIFRlc3RpbmdcbiAqIFByb3ZpZGVzIGFkdmFuY2VkIHV0aWxpdGllcyBmb3IgY29tcHJlaGVuc2l2ZSB0ZXN0aW5nXG4gKi9cblxuaW1wb3J0IHsgVGVzdCwgVGVzdGluZ01vZHVsZSB9IGZyb20gJ0BuZXN0anMvdGVzdGluZyc7XG5pbXBvcnQgeyBQcmlzbWFTZXJ2aWNlIH0gZnJvbSAnLi4vcHJvdmlkZXJzL3ByaXNtYS1jbGllbnQucHJvdmlkZXInO1xuaW1wb3J0IHsgY3JlYXRlTW9ja1ByaXNtYVNlcnZpY2UsIFRFU1RfVVNFUl9JRFMsIFRFU1RfRU1BSUxTIH0gZnJvbSAnLi9pbmRleCc7XG5cbi8vIEVuaGFuY2VkIE1vY2sgQnVpbGRlcnNcbmV4cG9ydCBjbGFzcyBNb2NrQnVpbGRlciB7XG4gIC8qKlxuICAgKiBDcmVhdGVzIGEgY29tcHJlaGVuc2l2ZSBOZXN0SlMgdGVzdGluZyBtb2R1bGUgd2l0aCBhbGwgY29tbW9uIG1vY2tzXG4gICAqL1xuICBzdGF0aWMgYXN5bmMgY3JlYXRlVGVzdGluZ01vZHVsZShwcm92aWRlcnM6IGFueVtdID0gW10pOiBQcm9taXNlPFRlc3RpbmdNb2R1bGU+IHtcbiAgICByZXR1cm4gVGVzdC5jcmVhdGVUZXN0aW5nTW9kdWxlKHtcbiAgICAgIHByb3ZpZGVyczogW1xuICAgICAgICAuLi5wcm92aWRlcnMsXG4gICAgICAgIHtcbiAgICAgICAgICBwcm92aWRlOiBQcmlzbWFTZXJ2aWNlLFxuICAgICAgICAgIHVzZVZhbHVlOiBjcmVhdGVNb2NrUHJpc21hU2VydmljZSgpLFxuICAgICAgICB9LFxuICAgICAgICB7XG4gICAgICAgICAgcHJvdmlkZTogJ0V2ZW50QnVzU2VydmljZScsXG4gICAgICAgICAgdXNlVmFsdWU6IHtcbiAgICAgICAgICAgIGVtaXQ6IGplc3QuZm4oKSxcbiAgICAgICAgICAgIHN1YnNjcmliZTogamVzdC5mbigpLFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICAgIHtcbiAgICAgICAgICBwcm92aWRlOiAnRW1haWxTZXJ2aWNlJyxcbiAgICAgICAgICB1c2VWYWx1ZToge1xuICAgICAgICAgICAgc2VuZEVtYWlsOiBqZXN0LmZuKCksXG4gICAgICAgICAgICBzZW5kVGVtcGxhdGVFbWFpbDogamVzdC5mbigpLFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICBdLFxuICAgIH0pLmNvbXBpbGUoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDcmVhdGVzIG1vY2sgYXV0aGVudGljYXRpb24gY29udGV4dFxuICAgKi9cbiAgc3RhdGljIGNyZWF0ZUF1dGhDb250ZXh0KHJvbGU6IHN0cmluZyA9ICdjbGllbnQnLCB1c2VySWQ/OiBzdHJpbmcpIHtcbiAgICByZXR1cm4ge1xuICAgICAgdXNlcklkOiB1c2VySWQgfHwgVEVTVF9VU0VSX0lEU1tyb2xlLnRvVXBwZXJDYXNlKCkgYXMga2V5b2YgdHlwZW9mIFRFU1RfVVNFUl9JRFNdLFxuICAgICAgcm9sZSxcbiAgICAgIGVtYWlsOiBURVNUX0VNQUlMU1tyb2xlLnRvVXBwZXJDYXNlKCkgYXMga2V5b2YgdHlwZW9mIFRFU1RfRU1BSUxTXSxcbiAgICAgIGlzQWN0aXZlOiB0cnVlLFxuICAgICAgaXNWZXJpZmllZDogdHJ1ZSxcbiAgICB9O1xuICB9XG5cbiAgLyoqXG4gICAqIENyZWF0ZXMgbW9jayByZXF1ZXN0IG9iamVjdCB3aXRoIGF1dGhlbnRpY2F0aW9uXG4gICAqL1xuICBzdGF0aWMgY3JlYXRlTW9ja1JlcXVlc3Qocm9sZTogc3RyaW5nID0gJ2NsaWVudCcsIHVzZXJJZD86IHN0cmluZykge1xuICAgIGNvbnN0IGF1dGhDb250ZXh0ID0gdGhpcy5jcmVhdGVBdXRoQ29udGV4dChyb2xlLCB1c2VySWQpO1xuICAgIHJldHVybiB7XG4gICAgICB1c2VyOiBhdXRoQ29udGV4dCxcbiAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgYXV0aG9yaXphdGlvbjogYEJlYXJlciBtb2NrLWp3dC10b2tlbi0ke3JvbGV9YCxcbiAgICAgICAgJ3VzZXItYWdlbnQnOiAndGVzdC1hZ2VudCcsXG4gICAgICB9LFxuICAgICAgaXA6ICcxMjcuMC4wLjEnLFxuICAgICAgbWV0aG9kOiAnR0VUJyxcbiAgICAgIHVybDogJy90ZXN0JyxcbiAgICB9O1xuICB9XG59XG5cbi8vIFRlc3QgRGF0YSBHZW5lcmF0b3JzXG5leHBvcnQgY2xhc3MgVGVzdERhdGFHZW5lcmF0b3Ige1xuICAvKipcbiAgICogR2VuZXJhdGVzIHJlYWxpc3RpYyB0ZXN0IHVzZXIgZGF0YVxuICAgKi9cbiAgc3RhdGljIGNyZWF0ZVVzZXIob3ZlcnJpZGVzOiBQYXJ0aWFsPGFueT4gPSB7fSkge1xuICAgIHJldHVybiB7XG4gICAgICBpZDogYHVzZXItJHtEYXRlLm5vdygpfS0ke01hdGgucmFuZG9tKCkudG9TdHJpbmcoMzYpLnN1YnN0cigyLCA5KX1gLFxuICAgICAgZW1haWw6IGB0ZXN0LSR7RGF0ZS5ub3coKX1AZXhhbXBsZS5jb21gLFxuICAgICAgZmlyc3ROYW1lOiAnVGVzdCcsXG4gICAgICBsYXN0TmFtZTogJ1VzZXInLFxuICAgICAgcm9sZTogJ2NsaWVudCcsXG4gICAgICBpc0FjdGl2ZTogdHJ1ZSxcbiAgICAgIGlzVmVyaWZpZWQ6IGZhbHNlLFxuICAgICAgY3JlYXRlZEF0OiBuZXcgRGF0ZSgpLFxuICAgICAgdXBkYXRlZEF0OiBuZXcgRGF0ZSgpLFxuICAgICAgLi4ub3ZlcnJpZGVzLFxuICAgIH07XG4gIH1cblxuICAvKipcbiAgICogR2VuZXJhdGVzIHRoZXJhcGlzdCBhcHBsaWNhdGlvbiBkYXRhXG4gICAqL1xuICBzdGF0aWMgY3JlYXRlVGhlcmFwaXN0QXBwbGljYXRpb24ob3ZlcnJpZGVzOiBQYXJ0aWFsPGFueT4gPSB7fSkge1xuICAgIHJldHVybiB7XG4gICAgICB1c2VySWQ6IFRFU1RfVVNFUl9JRFMuVEhFUkFQSVNULFxuICAgICAgZW1haWw6IFRFU1RfRU1BSUxTLlRIRVJBUElTVCxcbiAgICAgIGZpcnN0TmFtZTogJ0RyLiBUZXN0JyxcbiAgICAgIGxhc3ROYW1lOiAnVGhlcmFwaXN0JyxcbiAgICAgIG1vYmlsZTogJysxMjM0NTY3ODkwJyxcbiAgICAgIHByb3ZpbmNlOiAnVGVzdCBQcm92aW5jZScsXG4gICAgICBwcm92aWRlclR5cGU6ICdMaWNlbnNlZCBDbGluaWNhbCBQc3ljaG9sb2dpc3QnLFxuICAgICAgcHJvZmVzc2lvbmFsTGljZW5zZVR5cGU6ICdMQ1AnLFxuICAgICAgaXNQUkNMaWNlbnNlZDogJ3llcycsXG4gICAgICBwcmNMaWNlbnNlTnVtYmVyOiAnTENQLTEyMzQ1JyxcbiAgICAgIHByYWN0aWNlU3RhcnREYXRlOiBuZXcgRGF0ZSgnMjAyMC0wMS0wMScpLFxuICAgICAgYXJlYXNPZkV4cGVydGlzZTogWydhbnhpZXR5JywgJ2RlcHJlc3Npb24nXSxcbiAgICAgIHRoZXJhcGV1dGljQXBwcm9hY2hlc1VzZWRMaXN0OiBbJ0NCVCcsICdEQlQnXSxcbiAgICAgIGxhbmd1YWdlc09mZmVyZWQ6IFsnRW5nbGlzaCddLFxuICAgICAgYXNzZXNzbWVudFRvb2xzOiBbJ0dBRC03JywgJ1BIUS05J10sXG4gICAgICBwcm92aWRlZE9ubGluZVRoZXJhcHlCZWZvcmU6IHRydWUsXG4gICAgICBjb21mb3J0YWJsZVVzaW5nVmlkZW9Db25mZXJlbmNpbmc6IHRydWUsXG4gICAgICB3ZWVrbHlBdmFpbGFiaWxpdHk6ICcyMC0zMCBob3VycycsXG4gICAgICBwcmVmZXJyZWRTZXNzaW9uTGVuZ3RoOiAnNjAnLFxuICAgICAgaG91cmx5UmF0ZTogMTUwLjAwLFxuICAgICAgLi4ub3ZlcnJpZGVzLFxuICAgIH07XG4gIH1cblxuICAvKipcbiAgICogR2VuZXJhdGVzIG1lZXRpbmcvc2Vzc2lvbiBkYXRhXG4gICAqL1xuICBzdGF0aWMgY3JlYXRlTWVldGluZyhvdmVycmlkZXM6IFBhcnRpYWw8YW55PiA9IHt9KSB7XG4gICAgY29uc3Qgbm93ID0gbmV3IERhdGUoKTtcbiAgICBjb25zdCBmdXR1cmVEYXRlID0gbmV3IERhdGUobm93LmdldFRpbWUoKSArIDI0ICogNjAgKiA2MCAqIDEwMDApOyAvLyBUb21vcnJvd1xuICAgIFxuICAgIHJldHVybiB7XG4gICAgICBpZDogYG1lZXRpbmctJHtEYXRlLm5vdygpfWAsXG4gICAgICB0aXRsZTogJ1Rlc3QgVGhlcmFweSBTZXNzaW9uJyxcbiAgICAgIHN0YXJ0VGltZTogZnV0dXJlRGF0ZSxcbiAgICAgIGR1cmF0aW9uOiA2MCxcbiAgICAgIHN0YXR1czogJ1NDSEVEVUxFRCcsXG4gICAgICBtZWV0aW5nVHlwZTogJ3ZpZGVvJyxcbiAgICAgIGNsaWVudElkOiBURVNUX1VTRVJfSURTLkNMSUVOVCxcbiAgICAgIHRoZXJhcGlzdElkOiBURVNUX1VTRVJfSURTLlRIRVJBUElTVCxcbiAgICAgIGNyZWF0ZWRBdDogbm93LFxuICAgICAgdXBkYXRlZEF0OiBub3csXG4gICAgICAuLi5vdmVycmlkZXMsXG4gICAgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZW5lcmF0ZXMgbWVzc2FnZSBkYXRhIGZvciB0ZXN0aW5nXG4gICAqL1xuICBzdGF0aWMgY3JlYXRlTWVzc2FnZShvdmVycmlkZXM6IFBhcnRpYWw8YW55PiA9IHt9KSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIGlkOiBgbWVzc2FnZS0ke0RhdGUubm93KCl9YCxcbiAgICAgIGNvbnZlcnNhdGlvbklkOiBgY29udmVyc2F0aW9uLSR7RGF0ZS5ub3coKX1gLFxuICAgICAgc2VuZGVySWQ6IFRFU1RfVVNFUl9JRFMuQ0xJRU5ULFxuICAgICAgY29udGVudDogJ1Rlc3QgbWVzc2FnZSBjb250ZW50JyxcbiAgICAgIG1lc3NhZ2VUeXBlOiAnVEVYVCcsXG4gICAgICBpc0VkaXRlZDogZmFsc2UsXG4gICAgICBpc0RlbGV0ZWQ6IGZhbHNlLFxuICAgICAgY3JlYXRlZEF0OiBuZXcgRGF0ZSgpLFxuICAgICAgdXBkYXRlZEF0OiBuZXcgRGF0ZSgpLFxuICAgICAgLi4ub3ZlcnJpZGVzLFxuICAgIH07XG4gIH1cblxuICAvKipcbiAgICogR2VuZXJhdGVzIGFzc2Vzc21lbnQgZGF0YVxuICAgKi9cbiAgc3RhdGljIGNyZWF0ZVByZUFzc2Vzc21lbnQob3ZlcnJpZGVzOiBQYXJ0aWFsPGFueT4gPSB7fSkge1xuICAgIC8vIEdlbmVyYXRlIDIwMSByYW5kb20gYW5zd2VycyAoMS01IHNjYWxlKVxuICAgIGNvbnN0IGFuc3dlcnMgPSBBcnJheS5mcm9tKHsgbGVuZ3RoOiAyMDEgfSwgKCkgPT4gTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogNSkgKyAxKTtcbiAgICBcbiAgICByZXR1cm4ge1xuICAgICAgaWQ6IGBhc3Nlc3NtZW50LSR7RGF0ZS5ub3coKX1gLFxuICAgICAgdXNlcklkOiBURVNUX1VTRVJfSURTLkNMSUVOVCxcbiAgICAgIHJlc3BvbnNlczogYW5zd2VycyxcbiAgICAgIGNvbXBsZXRlZEF0OiBuZXcgRGF0ZSgpLFxuICAgICAgc2NvcmVzOiB7XG4gICAgICAgIGFueGlldHk6IDY1LFxuICAgICAgICBkZXByZXNzaW9uOiA0NSxcbiAgICAgICAgc3RyZXNzOiA1NSxcbiAgICAgIH0sXG4gICAgICBjcmVhdGVkQXQ6IG5ldyBEYXRlKCksXG4gICAgICB1cGRhdGVkQXQ6IG5ldyBEYXRlKCksXG4gICAgICAuLi5vdmVycmlkZXMsXG4gICAgfTtcbiAgfVxufVxuXG4vLyBUZXN0IEFzc2VydGlvbiBIZWxwZXJzXG5leHBvcnQgY2xhc3MgVGVzdEFzc2VydGlvbnMge1xuICAvKipcbiAgICogQXNzZXJ0cyB0aGF0IGEgZnVuY3Rpb24gdGhyb3dzIGEgc3BlY2lmaWMgTmVzdEpTIGV4Y2VwdGlvblxuICAgKi9cbiAgc3RhdGljIGFzeW5jIGV4cGVjdFRvVGhyb3dOZXN0RXhjZXB0aW9uKFxuICAgIGFzeW5jRm46ICgpID0+IFByb21pc2U8YW55PixcbiAgICBleGNlcHRpb25UeXBlOiBhbnksXG4gICAgZXhwZWN0ZWRNZXNzYWdlPzogc3RyaW5nLFxuICApIHtcbiAgICBsZXQgdGhyb3duRXJyb3I6IGFueSA9IG51bGw7XG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IGFzeW5jRm4oKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhyb3duRXJyb3IgPSBlcnJvcjtcbiAgICB9XG5cbiAgICBleHBlY3QodGhyb3duRXJyb3IpLnRvQmVJbnN0YW5jZU9mKGV4Y2VwdGlvblR5cGUpO1xuICAgIGlmIChleHBlY3RlZE1lc3NhZ2UpIHtcbiAgICAgIGV4cGVjdCh0aHJvd25FcnJvci5tZXNzYWdlKS50b0NvbnRhaW4oZXhwZWN0ZWRNZXNzYWdlKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogQXNzZXJ0cyBwcm9wZXIgRFRPIHZhbGlkYXRpb25cbiAgICovXG4gIHN0YXRpYyBleHBlY3RWYWxpZER0byhkdG86IGFueSwgZXhwZWN0ZWRGaWVsZHM6IHN0cmluZ1tdKSB7XG4gICAgZXhwZWN0ZWRGaWVsZHMuZm9yRWFjaChmaWVsZCA9PiB7XG4gICAgICBleHBlY3QoZHRvKS50b0hhdmVQcm9wZXJ0eShmaWVsZCk7XG4gICAgICBleHBlY3QoZHRvW2ZpZWxkXSkudG9CZURlZmluZWQoKTtcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBBc3NlcnRzIHByb3BlciBkYXRhYmFzZSBlbnRpdHkgc3RydWN0dXJlXG4gICAqL1xuICBzdGF0aWMgZXhwZWN0VmFsaWRFbnRpdHkoZW50aXR5OiBhbnksIHJlcXVpcmVkRmllbGRzOiBzdHJpbmdbXSkge1xuICAgIGV4cGVjdChlbnRpdHkpLnRvQmVEZWZpbmVkKCk7XG4gICAgZXhwZWN0KGVudGl0eSkubm90LnRvQmVOdWxsKCk7XG4gICAgXG4gICAgcmVxdWlyZWRGaWVsZHMuZm9yRWFjaChmaWVsZCA9PiB7XG4gICAgICBleHBlY3QoZW50aXR5KS50b0hhdmVQcm9wZXJ0eShmaWVsZCk7XG4gICAgfSk7XG5cbiAgICAvLyBDb21tb24gZW50aXR5IGZpZWxkc1xuICAgIGV4cGVjdChlbnRpdHkpLnRvSGF2ZVByb3BlcnR5KCdpZCcpO1xuICAgIGV4cGVjdChlbnRpdHkpLnRvSGF2ZVByb3BlcnR5KCdjcmVhdGVkQXQnKTtcbiAgICBleHBlY3QoZW50aXR5KS50b0hhdmVQcm9wZXJ0eSgndXBkYXRlZEF0Jyk7XG4gIH1cblxuICAvKipcbiAgICogQXNzZXJ0cyBwcm9wZXIgQVBJIHJlc3BvbnNlIHN0cnVjdHVyZVxuICAgKi9cbiAgc3RhdGljIGV4cGVjdFZhbGlkQXBpUmVzcG9uc2UocmVzcG9uc2U6IGFueSwgZXhwZWN0ZWREYXRhPzogYW55KSB7XG4gICAgZXhwZWN0KHJlc3BvbnNlKS50b0JlRGVmaW5lZCgpO1xuICAgIFxuICAgIGlmIChleHBlY3RlZERhdGEpIHtcbiAgICAgIGV4cGVjdChyZXNwb25zZSkudG9NYXRjaE9iamVjdChleHBlY3RlZERhdGEpO1xuICAgIH1cbiAgfVxufVxuXG4vLyBQZXJmb3JtYW5jZSBUZXN0aW5nIFV0aWxpdGllc1xuZXhwb3J0IGNsYXNzIFBlcmZvcm1hbmNlVGVzdFV0aWxzIHtcbiAgLyoqXG4gICAqIE1lYXN1cmVzIGZ1bmN0aW9uIGV4ZWN1dGlvbiB0aW1lXG4gICAqL1xuICBzdGF0aWMgYXN5bmMgbWVhc3VyZUV4ZWN1dGlvblRpbWU8VD4oZm46ICgpID0+IFByb21pc2U8VD4pOiBQcm9taXNlPHsgcmVzdWx0OiBUOyBkdXJhdGlvbjogbnVtYmVyIH0+IHtcbiAgICBjb25zdCBzdGFydCA9IHByb2Nlc3MuaHJ0aW1lLmJpZ2ludCgpO1xuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGZuKCk7XG4gICAgY29uc3QgZW5kID0gcHJvY2Vzcy5ocnRpbWUuYmlnaW50KCk7XG4gICAgY29uc3QgZHVyYXRpb24gPSBOdW1iZXIoZW5kIC0gc3RhcnQpIC8gMV8wMDBfMDAwOyAvLyBDb252ZXJ0IHRvIG1pbGxpc2Vjb25kc1xuICAgIFxuICAgIHJldHVybiB7IHJlc3VsdCwgZHVyYXRpb24gfTtcbiAgfVxuXG4gIC8qKlxuICAgKiBBc3NlcnRzIHRoYXQgYSBmdW5jdGlvbiBleGVjdXRlcyB3aXRoaW4gYSB0aW1lIGxpbWl0XG4gICAqL1xuICBzdGF0aWMgYXN5bmMgZXhwZWN0VG9FeGVjdXRlV2l0aGluPFQ+KFxuICAgIGZuOiAoKSA9PiBQcm9taXNlPFQ+LFxuICAgIG1heER1cmF0aW9uTXM6IG51bWJlcixcbiAgKTogUHJvbWlzZTxUPiB7XG4gICAgY29uc3QgeyByZXN1bHQsIGR1cmF0aW9uIH0gPSBhd2FpdCB0aGlzLm1lYXN1cmVFeGVjdXRpb25UaW1lKGZuKTtcbiAgICBcbiAgICBleHBlY3QoZHVyYXRpb24pLnRvQmVMZXNzVGhhbihtYXhEdXJhdGlvbk1zKTtcbiAgICBcbiAgICByZXR1cm4gcmVzdWx0O1xuICB9XG5cbiAgLyoqXG4gICAqIFJ1bnMgYSBmdW5jdGlvbiBtdWx0aXBsZSB0aW1lcyBhbmQgbWVhc3VyZXMgYXZlcmFnZSBwZXJmb3JtYW5jZVxuICAgKi9cbiAgc3RhdGljIGFzeW5jIGJlbmNobWFya0Z1bmN0aW9uPFQ+KFxuICAgIGZuOiAoKSA9PiBQcm9taXNlPFQ+LFxuICAgIGl0ZXJhdGlvbnM6IG51bWJlciA9IDEwLFxuICApOiBQcm9taXNlPHsgYXZlcmFnZUR1cmF0aW9uOiBudW1iZXI7IG1pbkR1cmF0aW9uOiBudW1iZXI7IG1heER1cmF0aW9uOiBudW1iZXIgfT4ge1xuICAgIGNvbnN0IGR1cmF0aW9uczogbnVtYmVyW10gPSBbXTtcbiAgICBcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGl0ZXJhdGlvbnM7IGkrKykge1xuICAgICAgY29uc3QgeyBkdXJhdGlvbiB9ID0gYXdhaXQgdGhpcy5tZWFzdXJlRXhlY3V0aW9uVGltZShmbik7XG4gICAgICBkdXJhdGlvbnMucHVzaChkdXJhdGlvbik7XG4gICAgfVxuICAgIFxuICAgIHJldHVybiB7XG4gICAgICBhdmVyYWdlRHVyYXRpb246IGR1cmF0aW9ucy5yZWR1Y2UoKHN1bSwgZCkgPT4gc3VtICsgZCwgMCkgLyBkdXJhdGlvbnMubGVuZ3RoLFxuICAgICAgbWluRHVyYXRpb246IE1hdGgubWluKC4uLmR1cmF0aW9ucyksXG4gICAgICBtYXhEdXJhdGlvbjogTWF0aC5tYXgoLi4uZHVyYXRpb25zKSxcbiAgICB9O1xuICB9XG59XG5cbi8vIERhdGFiYXNlIFRlc3RpbmcgVXRpbGl0aWVzXG5leHBvcnQgY2xhc3MgRGF0YWJhc2VUZXN0VXRpbHMge1xuICAvKipcbiAgICogQ3JlYXRlcyBhIHRyYW5zYWN0aW9uLXdyYXBwZWQgdGVzdCBmb3IgZGF0YWJhc2Ugb3BlcmF0aW9uc1xuICAgKi9cbiAgc3RhdGljIHdpdGhUcmFuc2FjdGlvbih0ZXN0Rm46IChwcmlzbWE6IGFueSkgPT4gUHJvbWlzZTx2b2lkPikge1xuICAgIHJldHVybiBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBtb2NrUHJpc21hID0gY3JlYXRlTW9ja1ByaXNtYVNlcnZpY2UoKTtcbiAgICAgIFxuICAgICAgLy8gTW9jayB0cmFuc2FjdGlvbiBiZWhhdmlvclxuICAgICAgbW9ja1ByaXNtYS4kdHJhbnNhY3Rpb24gPSBqZXN0LmZuKGFzeW5jIChjYWxsYmFjaykgPT4ge1xuICAgICAgICByZXR1cm4gY2FsbGJhY2sobW9ja1ByaXNtYSk7XG4gICAgICB9KTtcbiAgICAgIFxuICAgICAgYXdhaXQgdGVzdEZuKG1vY2tQcmlzbWEpO1xuICAgIH07XG4gIH1cblxuICAvKipcbiAgICogVmFsaWRhdGVzIHRoYXQgcHJvcGVyIGRhdGFiYXNlIGNvbnN0cmFpbnRzIGFyZSBjaGVja2VkXG4gICAqL1xuICBzdGF0aWMgZXhwZWN0RGF0YWJhc2VDb25zdHJhaW50RXJyb3IoZXJyb3I6IGFueSwgY29uc3RyYWludFR5cGU6IHN0cmluZykge1xuICAgIGV4cGVjdChlcnJvcikudG9CZURlZmluZWQoKTtcbiAgICBleHBlY3QoZXJyb3IubWVzc2FnZSkudG9Db250YWluKGNvbnN0cmFpbnRUeXBlKTtcbiAgfVxufVxuXG4vLyBJbnRlZ3JhdGlvbiBUZXN0aW5nIEhlbHBlcnNcbmV4cG9ydCBjbGFzcyBJbnRlZ3JhdGlvblRlc3RIZWxwZXJzIHtcbiAgLyoqXG4gICAqIENyZWF0ZXMgYSBmdWxsIHJlcXVlc3QgY29udGV4dCBmb3IgaW50ZWdyYXRpb24gdGVzdHNcbiAgICovXG4gIHN0YXRpYyBjcmVhdGVGdWxsUmVxdWVzdENvbnRleHQocm9sZTogc3RyaW5nID0gJ2NsaWVudCcpIHtcbiAgICByZXR1cm4ge1xuICAgICAgdXNlcjogTW9ja0J1aWxkZXIuY3JlYXRlQXV0aENvbnRleHQocm9sZSksXG4gICAgICByZXF1ZXN0OiBNb2NrQnVpbGRlci5jcmVhdGVNb2NrUmVxdWVzdChyb2xlKSxcbiAgICAgIHJlc3BvbnNlOiB7XG4gICAgICAgIHN0YXR1czogamVzdC5mbigpLm1vY2tSZXR1cm5UaGlzKCksXG4gICAgICAgIGpzb246IGplc3QuZm4oKS5tb2NrUmV0dXJuVGhpcygpLFxuICAgICAgICBzZW5kOiBqZXN0LmZuKCkubW9ja1JldHVyblRoaXMoKSxcbiAgICAgIH0sXG4gICAgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiBTaW11bGF0ZXMgYSBjb21wbGV0ZSBhdXRoZW50aWNhdGlvbiBmbG93XG4gICAqL1xuICBzdGF0aWMgYXN5bmMgc2ltdWxhdGVBdXRoRmxvdyhyb2xlOiBzdHJpbmcgPSAnY2xpZW50Jykge1xuICAgIGNvbnN0IGF1dGhDb250ZXh0ID0gTW9ja0J1aWxkZXIuY3JlYXRlQXV0aENvbnRleHQocm9sZSk7XG4gICAgXG4gICAgLy8gTW9jayB0aGUgYXV0aGVudGljYXRpb24gcHJvY2Vzc1xuICAgIGNvbnN0IG1vY2tDbGVya1VzZXIgPSB7XG4gICAgICBpZDogYXV0aENvbnRleHQudXNlcklkLFxuICAgICAgZW1haWxBZGRyZXNzZXM6IFt7IGVtYWlsQWRkcmVzczogYXV0aENvbnRleHQuZW1haWwgfV0sXG4gICAgICBmaXJzdE5hbWU6ICdUZXN0JyxcbiAgICAgIGxhc3ROYW1lOiAnVXNlcicsXG4gICAgfTtcbiAgICBcbiAgICByZXR1cm4geyBhdXRoQ29udGV4dCwgbW9ja0NsZXJrVXNlciB9O1xuICB9XG59XG5cbi8vIEFsbCB1dGlsaXRpZXMgYXJlIGFscmVhZHkgZXhwb3J0ZWQgYWJvdmUgdmlhIGNsYXNzIGRlY2xhcmF0aW9ucyJdLCJ2ZXJzaW9uIjozfQ==