{"file":"/home/wetooa/Documents/code/projects/mentara/mentara-api/src/therapist/therapist-match.controller.ts","mappings":";;;;;;;;;;;;;;;;AAAA,2CASwB;AACxB,gFAAoE;AACpE,kEAA6D;AAC7D,4FAA6E;AAC7E,6CAMyB;AAwBlB,IAAM,wBAAwB,GAA9B,MAAM,wBAAwB;IACN;IAA7B,YAA6B,MAAqB;QAArB,WAAM,GAAN,MAAM,CAAe;IAAG,CAAC;IA2BhD,AAAN,KAAK,CAAC,aAAa,CACA,QAAgB,EACzB,gBAAkC;QAE1C,IAAI,CAAC;YACH,MAAM,EAAE,YAAY,EAAE,GAAG,gBAAgB,CAAC;YAE1C,IAAI,CAAC,YAAY,IAAI,YAAY,CAAC,MAAM,KAAK,CAAC,EAAE,CAAC;gBAC/C,MAAM,IAAI,4BAAmB,CAAC,uCAAuC,CAAC,CAAC;YACzE,CAAC;YAED,IAAI,YAAY,CAAC,MAAM,GAAG,EAAE,EAAE,CAAC;gBAC7B,MAAM,IAAI,4BAAmB,CAAC,+CAA+C,CAAC,CAAC;YACjF,CAAC;YAED,gDAAgD;YAChD,MAAM,MAAM,GAAG,MAAM,IAAI,CAAC,MAAM,CAAC,MAAM,CAAC,UAAU,CAAC;gBACjD,KAAK,EAAE,EAAE,MAAM,EAAE,QAAQ,EAAE;aAC5B,CAAC,CAAC;YAEH,IAAI,CAAC,MAAM,EAAE,CAAC;gBACZ,MAAM,IAAI,4BAAmB,CAAC,0BAA0B,CAAC,CAAC;YAC5D,CAAC;YAED,+CAA+C;YAC/C,MAAM,UAAU,GAAG,MAAM,IAAI,CAAC,MAAM,CAAC,SAAS,CAAC,QAAQ,CAAC;gBACtD,KAAK,EAAE;oBACL,MAAM,EAAE,EAAE,EAAE,EAAE,YAAY,EAAE;oBAC5B,MAAM,EAAE,UAAU;iBACnB;gBACD,MAAM,EAAE;oBACN,MAAM,EAAE,IAAI;iBACb;aACF,CAAC,CAAC;YAEH,MAAM,iBAAiB,GAAG,UAAU,CAAC,GAAG,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,MAAM,CAAC,CAAC;YACxD,MAAM,oBAAoB,GAAG,YAAY,CAAC,MAAM,CAAC,EAAE,CAAC,EAAE,CAAC,CAAC,iBAAiB,CAAC,QAAQ,CAAC,EAAE,CAAC,CAAC,CAAC;YAExF,MAAM,OAAO,GAIR,EAAE,CAAC;YAER,IAAI,iBAAiB,GAAG,CAAC,CAAC;YAC1B,IAAI,aAAa,GAAG,CAAC,CAAC;YAEtB,8BAA8B;YAC9B,oBAAoB,CAAC,OAAO,CAAC,WAAW,CAAC,EAAE;gBACzC,OAAO,CAAC,IAAI,CAAC;oBACX,WAAW;oBACX,MAAM,EAAE,QAAQ;oBAChB,MAAM,EAAE,qCAAqC;iBAC9C,CAAC,CAAC;gBACH,aAAa,EAAE,CAAC;YAClB,CAAC,CAAC,CAAC;YAEH,sCAAsC;YACtC,KAAK,MAAM,WAAW,IAAI,iBAAiB,EAAE,CAAC;gBAC5C,IAAI,CAAC;oBACH,gCAAgC;oBAChC,MAAM,aAAa,GAAG,MAAM,IAAI,CAAC,MAAM,CAAC,eAAe,CAAC,UAAU,CAAC;wBACjE,KAAK,EAAE;4BACL,oBAAoB,EAAE;gCACpB,QAAQ;gCACR,WAAW;6BACZ;yBACF;qBACF,CAAC,CAAC;oBAEH,IAAI,aAAa,EAAE,CAAC;wBAClB,OAAO,CAAC,IAAI,CAAC;4BACX,WAAW;4BACX,MAAM,EAAE,QAAQ;4BAChB,MAAM,EAAE,sBAAsB;yBAC/B,CAAC,CAAC;wBACH,aAAa,EAAE,CAAC;wBAChB,SAAS;oBACX,CAAC;oBAED,mBAAmB;oBACnB,MAAM,IAAI,CAAC,MAAM,CAAC,eAAe,CAAC,MAAM,CAAC;wBACvC,IAAI,EAAE;4BACJ,QAAQ;4BACR,WAAW;4BACX,MAAM,EAAE,QAAQ;yBACjB;qBACF,CAAC,CAAC;oBAEH,OAAO,CAAC,IAAI,CAAC;wBACX,WAAW;wBACX,MAAM,EAAE,SAAS;qBAClB,CAAC,CAAC;oBACH,iBAAiB,EAAE,CAAC;gBACtB,CAAC;gBAAC,OAAO,KAAK,EAAE,CAAC;oBACf,OAAO,CAAC,IAAI,CAAC;wBACX,WAAW;wBACX,MAAM,EAAE,QAAQ;wBAChB,MAAM,EAAE,+BAA+B;qBACxC,CAAC,CAAC;oBACH,aAAa,EAAE,CAAC;gBAClB,CAAC;YACH,CAAC;YAED,OAAO;gBACL,OAAO,EAAE,iBAAiB,GAAG,CAAC;gBAC9B,OAAO,EAAE,iBAAiB,GAAG,CAAC;oBAC5B,CAAC,CAAC,wBAAwB,iBAAiB,oBAAoB;oBAC/D,CAAC,CAAC,yBAAyB;gBAC7B,IAAI,EAAE;oBACJ,iBAAiB;oBACjB,aAAa;oBACb,OAAO;iBACR;aACF,CAAC;QACJ,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YACf,IAAI,KAAK,YAAY,4BAAmB,EAAE,CAAC;gBACzC,MAAM,KAAK,CAAC;YACd,CAAC;YACD,MAAM,IAAI,qCAA4B,CACpC,KAAK,YAAY,KAAK,CAAC,CAAC,CAAC,KAAK,CAAC,OAAO,CAAC,CAAC,CAAC,oCAAoC,CAC9E,CAAC;QACJ,CAAC;IACH,CAAC;CACF,CAAA;AAxJY,4DAAwB;AA4B7B;IAzBL,IAAA,aAAI,EAAC,SAAS,CAAC;IACf,IAAA,sBAAY,EAAC;QACZ,OAAO,EAAE,0BAA0B;QACnC,WAAW,EAAE,+DAA+D;KAC7E,CAAC;IACD,IAAA,iBAAO,EAAC;QACP,MAAM,EAAE;YACN,IAAI,EAAE,QAAQ;YACd,UAAU,EAAE;gBACV,YAAY,EAAE;oBACZ,IAAI,EAAE,OAAO;oBACb,KAAK,EAAE,EAAE,IAAI,EAAE,QAAQ,EAAE;oBACzB,WAAW,EAAE,2CAA2C;iBACzD;aACF;YACD,QAAQ,EAAE,CAAC,cAAc,CAAC;SAC3B;KACF,CAAC;IACD,IAAA,qBAAW,EAAC;QACX,MAAM,EAAE,GAAG;QACX,WAAW,EAAE,8BAA8B;KAC5C,CAAC;IACD,IAAA,qBAAW,EAAC,EAAE,MAAM,EAAE,GAAG,EAAE,WAAW,EAAE,aAAa,EAAE,CAAC;IACxD,IAAA,qBAAW,EAAC,EAAE,MAAM,EAAE,GAAG,EAAE,WAAW,EAAE,cAAc,EAAE,CAAC;IACzD,IAAA,iBAAQ,EAAC,mBAAU,CAAC,EAAE,CAAC;IAErB,WAAA,IAAA,yCAAa,GAAE,CAAA;IACf,WAAA,IAAA,aAAI,GAAE,CAAA;;;wDACN,OAAO,oBAAP,OAAO;6DAwHT;mCAvJU,wBAAwB;IAJpC,IAAA,iBAAO,EAAC,oBAAoB,CAAC;IAC7B,IAAA,uBAAa,EAAC,UAAU,CAAC;IACzB,IAAA,mBAAU,EAAC,WAAW,CAAC;IACvB,IAAA,kBAAS,EAAC,6BAAY,CAAC;yDAEe,sCAAa,oBAAb,sCAAa;GADvC,wBAAwB,CAwJpC","names":[],"sources":["/home/wetooa/Documents/code/projects/mentara/mentara-api/src/therapist/therapist-match.controller.ts"],"sourcesContent":["import {\n  Controller,\n  Post,\n  Body,\n  UseGuards,\n  HttpCode,\n  HttpStatus,\n  InternalServerErrorException,\n  BadRequestException,\n} from '@nestjs/common';\nimport { PrismaService } from '../providers/prisma-client.provider';\nimport { JwtAuthGuard } from '../auth/guards/jwt-auth.guard';\nimport { CurrentUserId } from '../auth/decorators/current-user-id.decorator';\nimport {\n  ApiTags,\n  ApiOperation,\n  ApiResponse,\n  ApiBearerAuth,\n  ApiBody,\n} from '@nestjs/swagger';\n\ninterface CreateMatchesDto {\n  therapistIds: string[];\n}\n\ninterface CreateMatchesResponse {\n  success: boolean;\n  message: string;\n  data?: {\n    successfulMatches: number;\n    failedMatches: number;\n    details: Array<{\n      therapistId: string;\n      status: 'success' | 'failed';\n      reason?: string;\n    }>;\n  };\n}\n\n@ApiTags('therapist-matching')\n@ApiBearerAuth('JWT-auth')\n@Controller('therapist')\n@UseGuards(JwtAuthGuard)\nexport class TherapistMatchController {\n  constructor(private readonly prisma: PrismaService) {}\n\n  @Post('matches')\n  @ApiOperation({\n    summary: 'Create therapist matches',\n    description: 'Create client-therapist relationships for selected therapists',\n  })\n  @ApiBody({\n    schema: {\n      type: 'object',\n      properties: {\n        therapistIds: {\n          type: 'array',\n          items: { type: 'string' },\n          description: 'Array of therapist user IDs to match with',\n        },\n      },\n      required: ['therapistIds'],\n    },\n  })\n  @ApiResponse({\n    status: 200,\n    description: 'Matches created successfully',\n  })\n  @ApiResponse({ status: 400, description: 'Bad request' })\n  @ApiResponse({ status: 401, description: 'Unauthorized' })\n  @HttpCode(HttpStatus.OK)\n  async createMatches(\n    @CurrentUserId() clientId: string,\n    @Body() createMatchesDto: CreateMatchesDto,\n  ): Promise<CreateMatchesResponse> {\n    try {\n      const { therapistIds } = createMatchesDto;\n\n      if (!therapistIds || therapistIds.length === 0) {\n        throw new BadRequestException('At least one therapist ID is required');\n      }\n\n      if (therapistIds.length > 10) {\n        throw new BadRequestException('Cannot select more than 10 therapists at once');\n      }\n\n      // Verify client exists and is actually a client\n      const client = await this.prisma.client.findUnique({\n        where: { userId: clientId },\n      });\n\n      if (!client) {\n        throw new BadRequestException('Client profile not found');\n      }\n\n      // Verify all therapists exist and are approved\n      const therapists = await this.prisma.therapist.findMany({\n        where: {\n          userId: { in: therapistIds },\n          status: 'APPROVED',\n        },\n        select: {\n          userId: true,\n        },\n      });\n\n      const foundTherapistIds = therapists.map(t => t.userId);\n      const notFoundTherapistIds = therapistIds.filter(id => !foundTherapistIds.includes(id));\n\n      const details: Array<{\n        therapistId: string;\n        status: 'success' | 'failed';\n        reason?: string;\n      }> = [];\n\n      let successfulMatches = 0;\n      let failedMatches = 0;\n\n      // Handle not found therapists\n      notFoundTherapistIds.forEach(therapistId => {\n        details.push({\n          therapistId,\n          status: 'failed',\n          reason: 'Therapist not found or not approved',\n        });\n        failedMatches++;\n      });\n\n      // Create matches for found therapists\n      for (const therapistId of foundTherapistIds) {\n        try {\n          // Check if match already exists\n          const existingMatch = await this.prisma.clientTherapist.findUnique({\n            where: {\n              clientId_therapistId: {\n                clientId,\n                therapistId,\n              },\n            },\n          });\n\n          if (existingMatch) {\n            details.push({\n              therapistId,\n              status: 'failed',\n              reason: 'Match already exists',\n            });\n            failedMatches++;\n            continue;\n          }\n\n          // Create new match\n          await this.prisma.clientTherapist.create({\n            data: {\n              clientId,\n              therapistId,\n              status: 'active',\n            },\n          });\n\n          details.push({\n            therapistId,\n            status: 'success',\n          });\n          successfulMatches++;\n        } catch (error) {\n          details.push({\n            therapistId,\n            status: 'failed',\n            reason: 'Database error creating match',\n          });\n          failedMatches++;\n        }\n      }\n\n      return {\n        success: successfulMatches > 0,\n        message: successfulMatches > 0 \n          ? `Successfully created ${successfulMatches} therapist matches`\n          : 'No matches were created',\n        data: {\n          successfulMatches,\n          failedMatches,\n          details,\n        },\n      };\n    } catch (error) {\n      if (error instanceof BadRequestException) {\n        throw error;\n      }\n      throw new InternalServerErrorException(\n        error instanceof Error ? error.message : 'Failed to create therapist matches',\n      );\n    }\n  }\n}"],"version":3}