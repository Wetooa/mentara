{"file":"/home/wetooa/Documents/code/projects/mentara/mentara-api/src/therapist/therapist-recommendation.service.ts","mappings":"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","names":[],"sources":["/home/wetooa/Documents/code/projects/mentara/mentara-api/src/therapist/therapist-recommendation.service.ts"],"sourcesContent":["import {\n  Injectable,\n  NotFoundException,\n  InternalServerErrorException,\n  Logger,\n  BadRequestException,\n} from '@nestjs/common';\nimport { PrismaService } from '../providers/prisma-client.provider';\nimport { PreAssessment } from '@prisma/client';\nimport {\n  TherapistRecommendationRequest,\n  TherapistRecommendationResponse,\n} from 'mentara-commons';\nimport {\n  AdvancedMatchingService,\n  TherapistScore,\n  ClientForMatching,\n  TherapistForMatching,\n} from './services/advanced-matching.service';\nimport { CompatibilityAnalysisService } from './services/compatibility-analysis.service';\nimport { MatchingAnalyticsService } from './services/matching-analytics.service';\nimport { PreAssessmentService } from '../pre-assessment/pre-assessment.service';\n\n@Injectable()\nexport class TherapistRecommendationService {\n  private readonly logger = new Logger(TherapistRecommendationService.name);\n\n  constructor(\n    private readonly prisma: PrismaService,\n    private readonly advancedMatching: AdvancedMatchingService,\n    private readonly compatibilityAnalysis: CompatibilityAnalysisService,\n    private readonly matchingAnalytics: MatchingAnalyticsService,\n    private readonly preAssessmentService: PreAssessmentService,\n  ) {}\n\n  private calculateYearsOfExperience(startDate: Date): number {\n    const now = new Date();\n    let years = now.getFullYear() - startDate.getFullYear();\n    if (\n      now.getMonth() < startDate.getMonth() ||\n      (now.getMonth() === startDate.getMonth() &&\n        now.getDate() < startDate.getDate())\n    ) {\n      years--;\n    }\n    return years;\n  }\n\n  async getRecommendedTherapists(\n    request: TherapistRecommendationRequest,\n  ): Promise<any> {\n    // Input validation\n    if (!request?.userId) {\n      throw new BadRequestException('User ID is required');\n    }\n\n    if (request.limit && (request.limit < 1 || request.limit > 100)) {\n      throw new BadRequestException('Limit must be between 1 and 100');\n    }\n\n    this.logger.log(\n      `Getting enhanced recommendations for user ${request.userId} with limit ${request.limit || 10}`,\n    );\n\n    try {\n      // Get user's comprehensive data including preferences\n      const user = await this.prisma.client.findUnique({\n        where: { userId: request.userId },\n        include: {\n          preAssessment: true,\n          clientPreferences: true,\n          user: true,\n        },\n      });\n\n      if (!user) {\n        this.logger.warn(`User not found: ${request.userId}`);\n        throw new NotFoundException('User not found');\n      }\n\n      if (!user.preAssessment) {\n        this.logger.warn(`No pre-assessment found for user: ${request.userId}`);\n        throw new NotFoundException('No pre-assessment found for user');\n      }\n\n      // Get comprehensive clinical analysis for enhanced matching\n      let clinicalAnalysis;\n      try {\n        clinicalAnalysis =\n          await this.preAssessmentService.getComprehensiveClinicalAnalysis(\n            request.userId,\n          );\n        this.logger.log(\n          `Enhanced clinical insights available: ${clinicalAnalysis.clinicalProfile.primaryConditions.length} primary conditions`,\n        );\n      } catch (analysisError) {\n        this.logger.warn(\n          'Advanced clinical analysis unavailable, using basic assessment:',\n          analysisError,\n        );\n        clinicalAnalysis = null;\n      }\n\n      // Extract user conditions and severity levels\n      const userConditions = this.extractUserConditions(user.preAssessment);\n      const severityLevels = user.preAssessment.severityLevels as Record<\n        string,\n        string\n      >;\n\n      // Enhanced therapist filtering based on clinical insights\n      const therapistWhere: any = {\n        status: 'approved',\n        ...(request.province && { province: request.province }),\n        ...(request.maxHourlyRate && {\n          hourlyRate: { lte: request.maxHourlyRate },\n        }),\n      };\n\n      // Apply enhanced filtering based on clinical analysis\n      if (clinicalAnalysis?.treatmentPlan?.therapistCriteria) {\n        const criteria = clinicalAnalysis.treatmentPlan.therapistCriteria;\n\n        // Filter by required specializations\n        if (criteria.requiredSpecializations.length > 0) {\n          therapistWhere.OR = criteria.requiredSpecializations.map((spec) => ({\n            expertise: { has: spec },\n          }));\n        }\n\n        // Filter by experience level\n        if (criteria.experienceLevel !== 'any') {\n          const minYears =\n            {\n              intermediate: 3,\n              senior: 7,\n              expert: 12,\n            }[criteria.experienceLevel] || 0;\n\n          therapistWhere.yearsOfExperience = { gte: minYears };\n        }\n      }\n\n      // Fetch therapists with comprehensive data\n      const therapists = await this.prisma.therapist.findMany({\n        where: therapistWhere,\n        orderBy: { createdAt: 'desc' },\n        take: Math.min(request.limit ?? 10, 50), // Increase limit for better filtering\n        include: {\n          user: true,\n          reviews: {\n            where: { status: 'APPROVED' },\n            select: {\n              rating: true,\n              status: true,\n            },\n          },\n        },\n      });\n\n      // Use advanced matching algorithm with proper error handling and logging\n      const therapistScores: TherapistScore[] = [];\n      let advancedMatchingFailures = 0;\n\n      for (const therapist of therapists) {\n        try {\n          // Cast user to proper type now that we've validated all required fields exist\n          const clientForMatching: ClientForMatching = {\n            ...user,\n            preAssessment: user.preAssessment,\n            clientPreferences: user.clientPreferences || [],\n            user: user.user,\n          };\n\n          const therapistForMatching: TherapistForMatching = {\n            ...therapist,\n            user: therapist.user,\n            reviews: therapist.reviews || [],\n          };\n\n          const score = await this.advancedMatching.calculateAdvancedMatch(\n            clientForMatching,\n            therapistForMatching,\n          );\n\n          therapistScores.push(score);\n        } catch (error) {\n          advancedMatchingFailures++;\n\n          // Log detailed error information for debugging\n          this.logger.error(\n            `Advanced matching failed for therapist ${therapist.userId}`,\n            {\n              error: error instanceof Error ? error.message : String(error),\n              stack: error instanceof Error ? error.stack : undefined,\n              therapistId: therapist.userId,\n              userId: request.userId,\n            },\n          );\n\n          // Fallback to basic scoring with clear indication this is a fallback\n          try {\n            const basicScore = this.calculateMatchScore(\n              therapist,\n              userConditions,\n            );\n\n            const therapistForMatching: TherapistForMatching = {\n              ...therapist,\n              user: therapist.user,\n              reviews: therapist.reviews || [],\n            };\n\n            therapistScores.push({\n              therapist: therapistForMatching,\n              totalScore: basicScore,\n              breakdown: {\n                conditionScore: Math.round(basicScore * 0.6),\n                approachScore: 0,\n                experienceScore: Math.round(basicScore * 0.4),\n                reviewScore: 0,\n                logisticsScore: 0,\n              },\n              matchExplanation: {\n                primaryMatches: this.getPrimaryConditions(userConditions),\n                secondaryMatches: this.getSecondaryConditions(userConditions),\n                approachMatches: [],\n                experienceYears: this.calculateYearsOfExperience(\n                  therapist.practiceStartDate,\n                ),\n                averageRating: 0,\n                totalReviews: 0,\n                successRates: {},\n              },\n            });\n\n            this.logger.warn(\n              `Using basic scoring fallback for therapist ${therapist.userId} due to advanced matching failure`,\n            );\n          } catch (basicScoringError) {\n            // If even basic scoring fails, log and skip this therapist\n            this.logger.error(\n              `Both advanced and basic scoring failed for therapist ${therapist.userId}`,\n              {\n                advancedError:\n                  error instanceof Error ? error.message : String(error),\n                basicError:\n                  basicScoringError instanceof Error\n                    ? basicScoringError.message\n                    : String(basicScoringError),\n                therapistId: therapist.userId,\n                userId: request.userId,\n              },\n            );\n            // Skip this therapist entirely\n            continue;\n          }\n        }\n      }\n\n      // Log summary of matching performance\n      this.logger.log(\n        `Matching completed for user ${request.userId}: ${therapistScores.length} successful matches, ${advancedMatchingFailures} fallbacks`,\n      );\n\n      // Sort by total score descending\n      const sortedTherapistScores = therapistScores.sort(\n        (a, b) => b.totalScore - a.totalScore,\n      );\n\n      // Take only the requested number of results\n      const finalResults = sortedTherapistScores.slice(0, request.limit ?? 10);\n\n      // Track recommendation analytics\n      await this.matchingAnalytics.trackRecommendation(\n        request.userId,\n        finalResults,\n        'advanced_v1.0',\n      );\n\n      // Transform to expected format with enhanced insights\n      const therapistsWithScores = finalResults.map((score) => {\n        const therapistData: any = {\n          ...score.therapist,\n          matchScore: score.totalScore,\n          scoreBreakdown: score.breakdown,\n          matchExplanation: score.matchExplanation,\n        };\n\n        // Add clinical insights if available\n        if (clinicalAnalysis) {\n          therapistData.clinicalMatch = {\n            urgencyAlignment: this.assessUrgencyAlignment(\n              score.therapist,\n              clinicalAnalysis,\n            ),\n            specializationMatch: this.assessSpecializationMatch(\n              score.therapist,\n              clinicalAnalysis,\n            ),\n            experienceAdequacy: this.assessExperienceAdequacy(\n              score.therapist,\n              clinicalAnalysis,\n            ),\n            approachCompatibility: this.assessApproachCompatibility(\n              score.therapist,\n              clinicalAnalysis,\n            ),\n          };\n        }\n\n        return therapistData;\n      });\n\n      // Determine primary and secondary conditions (enhanced if clinical analysis available)\n      const primaryConditions = clinicalAnalysis\n        ? clinicalAnalysis.clinicalProfile.primaryConditions.map(\n            (pc) => pc.condition,\n          )\n        : this.getPrimaryConditions(userConditions);\n\n      const secondaryConditions = clinicalAnalysis\n        ? clinicalAnalysis.clinicalProfile.secondaryConditions.map(\n            (sc) => sc.condition,\n          )\n        : this.getSecondaryConditions(userConditions);\n\n      return {\n        totalCount: therapistsWithScores.length,\n        userConditions: Object.keys(userConditions),\n        therapists: therapistsWithScores,\n        matchCriteria: {\n          primaryConditions,\n          secondaryConditions,\n          severityLevels,\n          ...(clinicalAnalysis && {\n            riskLevel: clinicalAnalysis.riskAssessment.overallRisk,\n            urgencyLevel:\n              clinicalAnalysis.treatmentPlan.therapistCriteria.urgencyLevel,\n            requiredSpecializations:\n              clinicalAnalysis.treatmentPlan.therapistCriteria\n                .requiredSpecializations,\n            preferredApproaches:\n              clinicalAnalysis.treatmentPlan.therapistCriteria\n                .preferredApproaches,\n          }),\n        },\n        clinicalInsights: clinicalAnalysis\n          ? {\n              overallRiskLevel:\n                clinicalAnalysis.clinicalProfile.overallRiskLevel,\n              primaryConditionsCount:\n                clinicalAnalysis.clinicalProfile.primaryConditions.length,\n              therapeuticPriorities:\n                clinicalAnalysis.clinicalProfile.therapeuticPriorities.slice(\n                  0,\n                  3,\n                ),\n              recommendedSessionFrequency:\n                clinicalAnalysis.treatmentPlan.therapistCriteria\n                  .sessionFrequency,\n            }\n          : null,\n        page: 1,\n        pageSize: request.limit ?? 10,\n      };\n    } catch (error) {\n      // Handle specific error types with appropriate logging and responses\n      if (\n        error instanceof NotFoundException ||\n        error instanceof BadRequestException\n      ) {\n        // Re-throw validation and not found errors as-is\n        throw error;\n      }\n\n      // Log unexpected errors with full context\n      this.logger.error(\n        `Unexpected error in getRecommendedTherapists for user ${request.userId}`,\n        {\n          error: error instanceof Error ? error.message : String(error),\n          stack: error instanceof Error ? error.stack : undefined,\n          userId: request.userId,\n          requestParams: {\n            limit: request.limit,\n            province: request.province,\n            maxHourlyRate: request.maxHourlyRate,\n          },\n        },\n      );\n\n      // Provide generic error message to client while logging specifics\n      throw new InternalServerErrorException(\n        'Failed to get therapist recommendations. Please try again later.',\n      );\n    }\n  }\n\n  /**\n   * Get detailed compatibility analysis between a client and therapist\n   */\n  async getCompatibilityAnalysis(clientId: string, therapistId: string) {\n    const client = await this.prisma.client.findUnique({\n      where: { userId: clientId },\n      include: {\n        preAssessment: true,\n        clientPreferences: true,\n        user: true,\n      },\n    });\n\n    const therapist = await this.prisma.therapist.findUnique({\n      where: { userId: therapistId },\n      include: {\n        user: true,\n        reviews: {\n          where: { status: 'APPROVED' },\n        },\n      },\n    });\n\n    if (!client || !therapist) {\n      throw new NotFoundException('Client or therapist not found');\n    }\n\n    if (!client.preAssessment) {\n      throw new NotFoundException('No pre-assessment found for client');\n    }\n\n    const compatibility = await this.compatibilityAnalysis.analyzeCompatibility(\n      client as any, // Safe because we verified preAssessment exists above\n      therapist,\n    );\n\n    // Track compatibility analysis\n    await this.matchingAnalytics.trackCompatibilityAnalysis(\n      clientId,\n      therapistId,\n      compatibility,\n      '1.0',\n    );\n\n    return compatibility;\n  }\n\n  private extractUserConditions(\n    preAssessment: PreAssessment,\n  ): Record<string, string> {\n    const conditions: Record<string, string> = {};\n    const severityLevels = preAssessment.severityLevels as Record<\n      string,\n      string\n    >;\n    const questionnaires = preAssessment.questionnaires as string[];\n    questionnaires.forEach((q) => {\n      if (severityLevels[q]) {\n        conditions[q] = severityLevels[q];\n      }\n    });\n    return conditions;\n  }\n\n  private calculateMatchScore(\n    therapist: any,\n    userConditions: Record<string, string>,\n  ): number {\n    let score = 0;\n    const expertise = (therapist.expertise as string[]) || [];\n    Object.keys(userConditions).forEach((condition) => {\n      if (expertise.includes(condition)) score += 20;\n    });\n    score += Math.min(\n      this.calculateYearsOfExperience(therapist.practiceStartDate) * 2,\n      20,\n    );\n    // Add base score for experience\n    score += therapist.yearsOfExperience ? therapist.yearsOfExperience * 2 : 0;\n    return score;\n  }\n\n  private getPrimaryConditions(\n    userConditions: Record<string, string>,\n  ): string[] {\n    return Object.entries(userConditions)\n      .filter(([, severity]) => this.getSeverityWeight(severity) >= 4)\n      .map(([condition]) => condition);\n  }\n\n  private getSecondaryConditions(\n    userConditions: Record<string, string>,\n  ): string[] {\n    return Object.entries(userConditions)\n      .filter(([, severity]) => {\n        const weight = this.getSeverityWeight(severity);\n        return weight >= 2 && weight < 4;\n      })\n      .map(([condition]) => condition);\n  }\n\n  private getSeverityWeight(severity: string): number {\n    const severityWeights: Record<string, number> = {\n      Minimal: 1,\n      Mild: 2,\n      Moderate: 3,\n      'Moderately Severe': 4,\n      Severe: 5,\n      'Very Severe': 5,\n      Extreme: 5,\n      Low: 1,\n      High: 4,\n      Substantial: 4,\n      Subclinical: 1,\n      Clinical: 4,\n      None: 0,\n      Subthreshold: 2,\n      Positive: 4,\n      Negative: 0,\n    };\n    return severityWeights[severity] || 1;\n  }\n\n  /**\n   * Assess how well therapist's availability aligns with client's urgency needs\n   */\n  private assessUrgencyAlignment(\n    therapist: any,\n    clinicalAnalysis: any,\n  ): {\n    score: number;\n    reasoning: string;\n  } {\n    const urgencyLevel =\n      clinicalAnalysis.treatmentPlan.therapistCriteria.urgencyLevel;\n    const riskLevel = clinicalAnalysis.riskAssessment.overallRisk;\n\n    let score = 70; // Base score\n    let reasoning = 'Standard availability alignment';\n\n    // Check if therapist can handle urgent cases\n    if (urgencyLevel === 'immediate' || riskLevel === 'critical') {\n      if (\n        therapist.acceptsEmergencyAppointments ||\n        therapist.hasImmediateAvailability\n      ) {\n        score = 95;\n        reasoning =\n          'Excellent for crisis intervention - immediate availability';\n      } else {\n        score = 30;\n        reasoning = 'May not be suitable for immediate intervention needs';\n      }\n    } else if (urgencyLevel === 'high') {\n      if (therapist.weeklyAvailability || therapist.flexibleScheduling) {\n        score = 85;\n        reasoning = 'Good availability for urgent therapeutic needs';\n      }\n    }\n\n    return { score, reasoning };\n  }\n\n  /**\n   * Assess therapist's specialization match with client's conditions\n   */\n  private assessSpecializationMatch(\n    therapist: any,\n    clinicalAnalysis: any,\n  ): {\n    score: number;\n    matchedSpecializations: string[];\n    reasoning: string;\n  } {\n    const requiredSpecs =\n      clinicalAnalysis.treatmentPlan.therapistCriteria.requiredSpecializations;\n    const therapistSpecs = [\n      ...(therapist.expertise || []),\n      ...(therapist.illnessSpecializations || []),\n    ];\n\n    const matchedSpecs = requiredSpecs.filter((req) =>\n      therapistSpecs.some(\n        (spec) =>\n          spec.toLowerCase().includes(req.toLowerCase()) ||\n          req.toLowerCase().includes(spec.toLowerCase()),\n      ),\n    );\n\n    const matchRatio =\n      requiredSpecs.length > 0 ? matchedSpecs.length / requiredSpecs.length : 1;\n    const score = Math.round(matchRatio * 100);\n\n    let reasoning = `Matches ${matchedSpecs.length}/${requiredSpecs.length} required specializations`;\n    if (score >= 80) reasoning = 'Excellent specialization match';\n    else if (score >= 60) reasoning = 'Good specialization alignment';\n    else if (score >= 40) reasoning = 'Partial specialization match';\n    else reasoning = 'Limited specialization match';\n\n    return {\n      score,\n      matchedSpecializations: matchedSpecs,\n      reasoning,\n    };\n  }\n\n  /**\n   * Assess if therapist has adequate experience for client's needs\n   */\n  private assessExperienceAdequacy(\n    therapist: any,\n    clinicalAnalysis: any,\n  ): {\n    score: number;\n    reasoning: string;\n  } {\n    const requiredLevel =\n      clinicalAnalysis.treatmentPlan.therapistCriteria.experienceLevel;\n    const therapistYears =\n      therapist.yearsOfExperience ||\n      this.calculateYearsOfExperience(therapist.practiceStartDate);\n\n    const requiredYears =\n      {\n        any: 0,\n        intermediate: 3,\n        senior: 7,\n        expert: 12,\n      }[requiredLevel] || 0;\n\n    if (therapistYears >= requiredYears) {\n      const score = Math.min(100, 70 + (therapistYears - requiredYears) * 3);\n      return {\n        score,\n        reasoning: `${therapistYears} years experience meets ${requiredLevel} level requirement`,\n      };\n    } else {\n      const score = Math.max(20, (therapistYears / requiredYears) * 60);\n      return {\n        score,\n        reasoning: `${therapistYears} years experience below ${requiredLevel} level (${requiredYears}+ years)`,\n      };\n    }\n  }\n\n  /**\n   * Assess therapist's therapeutic approach compatibility\n   */\n  private assessApproachCompatibility(\n    therapist: any,\n    clinicalAnalysis: any,\n  ): {\n    score: number;\n    matchedApproaches: string[];\n    reasoning: string;\n  } {\n    const preferredApproaches =\n      clinicalAnalysis.treatmentPlan.therapistCriteria.preferredApproaches;\n    const therapistApproaches = [\n      ...(therapist.approaches || []),\n      ...(therapist.therapeuticApproachesUsedList || []),\n    ];\n\n    const matchedApproaches = preferredApproaches.filter((pref) =>\n      therapistApproaches.some(\n        (approach) =>\n          approach.toLowerCase().includes(pref.toLowerCase()) ||\n          pref.toLowerCase().includes(approach.toLowerCase()),\n      ),\n    );\n\n    const matchRatio =\n      preferredApproaches.length > 0\n        ? matchedApproaches.length / preferredApproaches.length\n        : 0.7;\n    const score = Math.round(matchRatio * 100);\n\n    let reasoning = `Matches ${matchedApproaches.length}/${preferredApproaches.length} preferred approaches`;\n    if (score >= 80) reasoning = 'Excellent therapeutic approach match';\n    else if (score >= 60) reasoning = 'Good approach compatibility';\n    else if (score >= 40) reasoning = 'Some approach alignment';\n    else reasoning = 'Limited approach match - may still be effective';\n\n    return {\n      score,\n      matchedApproaches,\n      reasoning,\n    };\n  }\n}\n"],"version":3}