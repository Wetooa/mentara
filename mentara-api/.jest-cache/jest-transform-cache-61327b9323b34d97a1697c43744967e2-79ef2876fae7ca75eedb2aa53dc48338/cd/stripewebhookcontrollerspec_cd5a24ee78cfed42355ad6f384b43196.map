{"file":"/home/wetooa/Documents/code/projects/mentara/mentara-api/src/billing/controllers/stripe-webhook.controller.spec.ts","mappings":"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","names":[],"sources":["/home/wetooa/Documents/code/projects/mentara/mentara-api/src/billing/controllers/stripe-webhook.controller.spec.ts"],"sourcesContent":["/**\n * Comprehensive Test Suite for StripeWebhookController\n * Tests webhook event processing, idempotency, error handling, and statistics\n */\n\nimport { Test, TestingModule } from '@nestjs/testing';\nimport { BadRequestException, InternalServerErrorException } from '@nestjs/common';\nimport { EventEmitter2 } from '@nestjs/event-emitter';\nimport { StripeWebhookController } from './stripe-webhook.controller';\nimport { StripeService } from '../services/stripe.service';\nimport { PrismaService } from '../../providers/prisma-client.provider';\nimport { SecurityGuardTestUtils, RoleBasedTestUtils } from '../../test-utils/auth-testing-helpers';\nimport { MockBuilder, TestDataGenerator, TestAssertions } from '../../test-utils/enhanced-test-helpers';\nimport { TEST_USER_IDS, TEST_EMAILS } from '../../test-utils/index';\n\ndescribe('StripeWebhookController', () => {\n  let controller: StripeWebhookController;\n  let stripeService: StripeService;\n  let prismaService: PrismaService;\n  let eventEmitter: EventEmitter2;\n  let module: TestingModule;\n\n  // Mock services\n  const mockStripeService = {\n    constructWebhookEvent: jest.fn(),\n    handleWebhookEvent: jest.fn(),\n  };\n\n  const mockPrismaService = {\n    stripeWebhookEvent: {\n      findUnique: jest.fn(),\n      create: jest.fn(),\n      update: jest.fn(),\n      count: jest.fn(),\n      groupBy: jest.fn(),\n      findMany: jest.fn(),\n    },\n  };\n\n  const mockEventEmitter = {\n    emit: jest.fn(),\n  };\n\n  // Test data\n  const mockStripeEvent = {\n    id: 'evt_1234567890',\n    type: 'invoice.payment_succeeded',\n    data: {\n      object: {\n        id: 'in_1234567890',\n        amount_paid: 2999,\n        currency: 'usd',\n        customer: 'cus_1234567890',\n        subscription: 'sub_1234567890',\n      },\n    },\n    created: Math.floor(Date.now() / 1000),\n    livemode: false,\n    api_version: '2022-11-15',\n  };\n\n  const mockWebhookEventRecord = {\n    id: 'webhook_123',\n    eventId: 'evt_1234567890',\n    eventType: 'invoice.payment_succeeded',\n    eventData: mockStripeEvent.data,\n    livemode: false,\n    apiVersion: '2022-11-15',\n    created: new Date(),\n    processed: false,\n    processedAt: null,\n    success: null,\n    errorMessage: null,\n  };\n\n  const mockRequest = {\n    rawBody: Buffer.from(JSON.stringify(mockStripeEvent)),\n    body: mockStripeEvent,\n    params: {},\n  };\n\n  beforeEach(async () => {\n    module = await Test.createTestingModule({\n      controllers: [StripeWebhookController],\n      providers: [\n        {\n          provide: StripeService,\n          useValue: mockStripeService,\n        },\n        {\n          provide: PrismaService,\n          useValue: mockPrismaService,\n        },\n        {\n          provide: EventEmitter2,\n          useValue: mockEventEmitter,\n        },\n      ],\n    }).compile();\n\n    controller = module.get<StripeWebhookController>(StripeWebhookController);\n    stripeService = module.get<StripeService>(StripeService);\n    prismaService = module.get<PrismaService>(PrismaService);\n    eventEmitter = module.get<EventEmitter2>(EventEmitter2);\n  });\n\n  afterEach(() => {\n    jest.clearAllMocks();\n  });\n\n  describe('Controller Initialization', () => {\n    it('should be defined', () => {\n      expect(controller).toBeDefined();\n    });\n\n    it('should have all services injected', () => {\n      expect(stripeService).toBeDefined();\n      expect(prismaService).toBeDefined();\n      expect(eventEmitter).toBeDefined();\n    });\n  });\n\n  describe('POST /billing/stripe/webhooks', () => {\n    const validSignature = 't=1234567890,v1=abcdef1234567890';\n\n    beforeEach(() => {\n      mockStripeService.constructWebhookEvent.mockReturnValue(mockStripeEvent);\n      mockStripeService.handleWebhookEvent.mockResolvedValue(undefined);\n      mockPrismaService.stripeWebhookEvent.findUnique.mockResolvedValue(null);\n      mockPrismaService.stripeWebhookEvent.create.mockResolvedValue(mockWebhookEventRecord);\n      mockPrismaService.stripeWebhookEvent.update.mockResolvedValue({\n        ...mockWebhookEventRecord,\n        processed: true,\n        success: true,\n      });\n    });\n\n    it('should process webhook successfully', async () => {\n      const result = await controller.handleWebhook(\n        mockRequest as any,\n        mockStripeEvent,\n        validSignature\n      );\n\n      expect(result).toEqual({\n        received: true,\n        eventId: mockStripeEvent.id,\n        eventType: mockStripeEvent.type,\n        processingTime: expect.any(Number),\n      });\n\n      expect(stripeService.constructWebhookEvent).toHaveBeenCalledWith(\n        mockRequest.rawBody,\n        validSignature\n      );\n      expect(stripeService.handleWebhookEvent).toHaveBeenCalledWith(mockStripeEvent);\n      expect(eventEmitter.emit).toHaveBeenCalledWith('stripe.webhook.processed', {\n        eventId: mockStripeEvent.id,\n        eventType: mockStripeEvent.type,\n        processingTime: expect.any(Number),\n        success: true,\n      });\n    });\n\n    it('should handle missing signature', async () => {\n      await expect(\n        controller.handleWebhook(mockRequest as any, mockStripeEvent, '')\n      ).rejects.toThrow(BadRequestException);\n\n      expect(stripeService.constructWebhookEvent).not.toHaveBeenCalled();\n    });\n\n    it('should handle missing raw body', async () => {\n      const requestWithoutRawBody = {\n        ...mockRequest,\n        rawBody: undefined,\n      };\n\n      await expect(\n        controller.handleWebhook(requestWithoutRawBody as any, mockStripeEvent, validSignature)\n      ).rejects.toThrow(BadRequestException);\n\n      expect(stripeService.constructWebhookEvent).not.toHaveBeenCalled();\n    });\n\n    it('should handle idempotent events', async () => {\n      // Mock existing event found\n      mockPrismaService.stripeWebhookEvent.findUnique.mockResolvedValue(mockWebhookEventRecord);\n\n      const result = await controller.handleWebhook(\n        mockRequest as any,\n        mockStripeEvent,\n        validSignature\n      );\n\n      expect(result).toEqual({\n        received: true,\n        eventId: mockStripeEvent.id,\n        eventType: mockStripeEvent.type,\n        message: 'Event already processed',\n      });\n\n      // Should not process the event again\n      expect(stripeService.handleWebhookEvent).not.toHaveBeenCalled();\n    });\n\n    it('should handle webhook construction errors', async () => {\n      const constructionError = new Error('Invalid signature');\n      mockStripeService.constructWebhookEvent.mockImplementation(() => {\n        throw constructionError;\n      });\n\n      await expect(\n        controller.handleWebhook(mockRequest as any, mockStripeEvent, validSignature)\n      ).rejects.toThrow(InternalServerErrorException);\n\n      expect(eventEmitter.emit).toHaveBeenCalledWith('stripe.webhook.error', {\n        eventId: mockStripeEvent.id,\n        eventType: mockStripeEvent.type,\n        processingTime: expect.any(Number),\n        error: constructionError.message,\n        success: false,\n      });\n    });\n\n    it('should handle webhook processing errors', async () => {\n      const processingError = new Error('Payment processing failed');\n      mockStripeService.handleWebhookEvent.mockRejectedValue(processingError);\n\n      await expect(\n        controller.handleWebhook(mockRequest as any, mockStripeEvent, validSignature)\n      ).rejects.toThrow(InternalServerErrorException);\n\n      expect(mockPrismaService.stripeWebhookEvent.update).toHaveBeenCalledWith({\n        where: { eventId: mockStripeEvent.id },\n        data: {\n          processed: true,\n          processedAt: expect.any(Date),\n          success: false,\n          errorMessage: processingError.message,\n        },\n      });\n    });\n\n    it('should handle database recording errors gracefully', async () => {\n      const dbError = new Error('Database connection failed');\n      mockPrismaService.stripeWebhookEvent.create.mockRejectedValue(dbError);\n\n      // Should still process the webhook despite database error\n      const result = await controller.handleWebhook(\n        mockRequest as any,\n        mockStripeEvent,\n        validSignature\n      );\n\n      expect(result.received).toBe(true);\n      expect(stripeService.handleWebhookEvent).toHaveBeenCalled();\n    });\n\n    it('should handle malformed request body', async () => {\n      const malformedRequest = {\n        rawBody: mockRequest.rawBody,\n        body: 'invalid json',\n      };\n\n      const constructionError = new Error('Invalid webhook payload');\n      mockStripeService.constructWebhookEvent.mockImplementation(() => {\n        throw constructionError;\n      });\n\n      await expect(\n        controller.handleWebhook(malformedRequest as any, 'invalid', validSignature)\n      ).rejects.toThrow(InternalServerErrorException);\n\n      expect(eventEmitter.emit).toHaveBeenCalledWith('stripe.webhook.error', {\n        eventId: 'unknown',\n        eventType: 'unknown',\n        processingTime: expect.any(Number),\n        error: constructionError.message,\n        success: false,\n      });\n    });\n\n    it('should handle different event types', async () => {\n      const customerCreatedEvent = {\n        ...mockStripeEvent,\n        id: 'evt_customer_created',\n        type: 'customer.created',\n      };\n\n      mockStripeService.constructWebhookEvent.mockReturnValue(customerCreatedEvent);\n\n      const result = await controller.handleWebhook(\n        mockRequest as any,\n        customerCreatedEvent,\n        validSignature\n      );\n\n      expect(result.eventType).toBe('customer.created');\n      expect(stripeService.handleWebhookEvent).toHaveBeenCalledWith(customerCreatedEvent);\n    });\n  });\n\n  describe('POST /billing/stripe/webhooks/test', () => {\n    it('should handle test webhook successfully', async () => {\n      const testPayload = { test: 'data', timestamp: new Date().toISOString() };\n\n      const result = await controller.testWebhook(testPayload);\n\n      expect(result).toEqual({\n        received: true,\n        timestamp: expect.any(String),\n        message: 'Test webhook processed successfully',\n        body: testPayload,\n      });\n    });\n\n    it('should handle test webhook errors', async () => {\n      // Mock logger error to simulate internal error\n      const originalLoggerError = controller['logger'].log;\n      controller['logger'].log = jest.fn().mockImplementation(() => {\n        throw new Error('Logger error');\n      });\n\n      await expect(controller.testWebhook({ test: 'data' })).rejects.toThrow(\n        InternalServerErrorException\n      );\n\n      // Restore original logger\n      controller['logger'].log = originalLoggerError;\n    });\n  });\n\n  describe('POST /billing/stripe/webhooks/stats', () => {\n    it('should return webhook statistics successfully', async () => {\n      const mockStats = {\n        totalEvents: 100,\n        processedEvents: 95,\n        failedEvents: 5,\n        recentEvents: 20,\n        eventsByType: [\n          { eventType: 'invoice.payment_succeeded', _count: { eventType: 30 } },\n          { eventType: 'customer.created', _count: { eventType: 25 } },\n          { eventType: 'subscription.created', _count: { eventType: 15 } },\n        ],\n      };\n\n      mockPrismaService.stripeWebhookEvent.count\n        .mockResolvedValueOnce(mockStats.totalEvents)\n        .mockResolvedValueOnce(mockStats.processedEvents)\n        .mockResolvedValueOnce(mockStats.failedEvents)\n        .mockResolvedValueOnce(mockStats.recentEvents);\n\n      mockPrismaService.stripeWebhookEvent.groupBy.mockResolvedValue(mockStats.eventsByType);\n\n      const result = await controller.getWebhookStats();\n\n      expect(result).toEqual({\n        totalEvents: 100,\n        processedEvents: 95,\n        failedEvents: 5,\n        recentEvents: 20,\n        successRate: 95,\n        eventsByType: [\n          { eventType: 'invoice.payment_succeeded', count: 30 },\n          { eventType: 'customer.created', count: 25 },\n          { eventType: 'subscription.created', count: 15 },\n        ],\n      });\n    });\n\n    it('should handle zero events gracefully', async () => {\n      mockPrismaService.stripeWebhookEvent.count.mockResolvedValue(0);\n      mockPrismaService.stripeWebhookEvent.groupBy.mockResolvedValue([]);\n\n      const result = await controller.getWebhookStats();\n\n      expect(result.successRate).toBe(0);\n      expect(result.eventsByType).toEqual([]);\n    });\n\n    it('should handle database errors', async () => {\n      const dbError = new Error('Database connection failed');\n      mockPrismaService.stripeWebhookEvent.count.mockRejectedValue(dbError);\n\n      await expect(controller.getWebhookStats()).rejects.toThrow(InternalServerErrorException);\n    });\n  });\n\n  describe('POST /billing/stripe/webhooks/recent', () => {\n    it('should return recent webhook events successfully', async () => {\n      const mockRecentEvents = [\n        {\n          eventId: 'evt_recent_1',\n          eventType: 'invoice.payment_succeeded',\n          created: new Date(),\n          processed: true,\n          processedAt: new Date(),\n          success: true,\n          errorMessage: null,\n        },\n        {\n          eventId: 'evt_recent_2',\n          eventType: 'customer.created',\n          created: new Date(),\n          processed: true,\n          processedAt: new Date(),\n          success: false,\n          errorMessage: 'Processing failed',\n        },\n      ];\n\n      mockPrismaService.stripeWebhookEvent.findMany.mockResolvedValue(mockRecentEvents);\n\n      const result = await controller.getRecentEvents();\n\n      expect(result).toEqual({\n        events: mockRecentEvents,\n        count: mockRecentEvents.length,\n      });\n\n      expect(mockPrismaService.stripeWebhookEvent.findMany).toHaveBeenCalledWith({\n        select: {\n          eventId: true,\n          eventType: true,\n          created: true,\n          processed: true,\n          processedAt: true,\n          success: true,\n          errorMessage: true,\n        },\n        orderBy: { created: 'desc' },\n        take: 50,\n      });\n    });\n\n    it('should handle database errors', async () => {\n      const dbError = new Error('Database query failed');\n      mockPrismaService.stripeWebhookEvent.findMany.mockRejectedValue(dbError);\n\n      await expect(controller.getRecentEvents()).rejects.toThrow(InternalServerErrorException);\n    });\n  });\n\n  describe('POST /billing/stripe/webhooks/retry/:eventId', () => {\n    const failedEventId = 'evt_failed_123';\n    const failedWebhookEvent = {\n      ...mockWebhookEventRecord,\n      eventId: failedEventId,\n      processed: true,\n      success: false,\n      errorMessage: 'Original processing failed',\n    };\n\n    beforeEach(() => {\n      mockRequest.params = { eventId: failedEventId };\n    });\n\n    it('should retry failed webhook event successfully', async () => {\n      mockPrismaService.stripeWebhookEvent.findUnique.mockResolvedValue(failedWebhookEvent);\n      mockStripeService.handleWebhookEvent.mockResolvedValue(undefined);\n      mockPrismaService.stripeWebhookEvent.update.mockResolvedValue({\n        ...failedWebhookEvent,\n        success: true,\n        errorMessage: null,\n      });\n\n      const result = await controller.retryFailedEvent(mockRequest as any);\n\n      expect(result).toEqual({\n        success: true,\n        eventId: failedEventId,\n        message: 'Webhook event retried successfully',\n      });\n\n      expect(stripeService.handleWebhookEvent).toHaveBeenCalledWith({\n        id: failedWebhookEvent.eventId,\n        type: failedWebhookEvent.eventType,\n        data: failedWebhookEvent.eventData,\n        created: expect.any(Number),\n        livemode: failedWebhookEvent.livemode,\n        api_version: failedWebhookEvent.apiVersion,\n      });\n    });\n\n    it('should handle event not found', async () => {\n      mockPrismaService.stripeWebhookEvent.findUnique.mockResolvedValue(null);\n\n      await expect(controller.retryFailedEvent(mockRequest as any)).rejects.toThrow(\n        BadRequestException\n      );\n    });\n\n    it('should handle already successful event', async () => {\n      const successfulEvent = {\n        ...failedWebhookEvent,\n        success: true,\n      };\n      mockPrismaService.stripeWebhookEvent.findUnique.mockResolvedValue(successfulEvent);\n\n      await expect(controller.retryFailedEvent(mockRequest as any)).rejects.toThrow(\n        BadRequestException\n      );\n    });\n\n    it('should handle retry processing errors', async () => {\n      mockPrismaService.stripeWebhookEvent.findUnique.mockResolvedValue(failedWebhookEvent);\n      const retryError = new Error('Retry processing failed');\n      mockStripeService.handleWebhookEvent.mockRejectedValue(retryError);\n\n      await expect(controller.retryFailedEvent(mockRequest as any)).rejects.toThrow(\n        InternalServerErrorException\n      );\n    });\n\n    it('should handle database errors during retry', async () => {\n      const dbError = new Error('Database error during retry');\n      mockPrismaService.stripeWebhookEvent.findUnique.mockRejectedValue(dbError);\n\n      await expect(controller.retryFailedEvent(mockRequest as any)).rejects.toThrow(\n        InternalServerErrorException\n      );\n    });\n  });\n\n  describe('Private Methods', () => {\n    describe('checkEventIdempotency', () => {\n      it('should return true for existing event', async () => {\n        mockPrismaService.stripeWebhookEvent.findUnique.mockResolvedValue(mockWebhookEventRecord);\n\n        const result = await controller['checkEventIdempotency']('evt_existing');\n\n        expect(result).toBe(true);\n      });\n\n      it('should return false for non-existing event', async () => {\n        mockPrismaService.stripeWebhookEvent.findUnique.mockResolvedValue(null);\n\n        const result = await controller['checkEventIdempotency']('evt_new');\n\n        expect(result).toBe(false);\n      });\n\n      it('should return false on database error', async () => {\n        mockPrismaService.stripeWebhookEvent.findUnique.mockRejectedValue(\n          new Error('Database error')\n        );\n\n        const result = await controller['checkEventIdempotency']('evt_error');\n\n        expect(result).toBe(false);\n      });\n    });\n\n    describe('recordWebhookEvent', () => {\n      it('should record webhook event successfully', async () => {\n        mockPrismaService.stripeWebhookEvent.create.mockResolvedValue(mockWebhookEventRecord);\n\n        await expect(\n          controller['recordWebhookEvent'](mockStripeEvent)\n        ).resolves.not.toThrow();\n\n        expect(mockPrismaService.stripeWebhookEvent.create).toHaveBeenCalledWith({\n          data: {\n            eventId: mockStripeEvent.id,\n            eventType: mockStripeEvent.type,\n            eventData: mockStripeEvent.data,\n            livemode: mockStripeEvent.livemode,\n            apiVersion: mockStripeEvent.api_version,\n            created: new Date(mockStripeEvent.created * 1000),\n            processed: false,\n          },\n        });\n      });\n\n      it('should handle database errors gracefully', async () => {\n        mockPrismaService.stripeWebhookEvent.create.mockRejectedValue(\n          new Error('Database error')\n        );\n\n        // Should not throw\n        await expect(\n          controller['recordWebhookEvent'](mockStripeEvent)\n        ).resolves.not.toThrow();\n      });\n    });\n\n    describe('markEventProcessed', () => {\n      it('should mark event as successful', async () => {\n        mockPrismaService.stripeWebhookEvent.update.mockResolvedValue({\n          ...mockWebhookEventRecord,\n          processed: true,\n          success: true,\n        });\n\n        await expect(\n          controller['markEventProcessed']('evt_123', true)\n        ).resolves.not.toThrow();\n\n        expect(mockPrismaService.stripeWebhookEvent.update).toHaveBeenCalledWith({\n          where: { eventId: 'evt_123' },\n          data: {\n            processed: true,\n            processedAt: expect.any(Date),\n            success: true,\n            errorMessage: null,\n          },\n        });\n      });\n\n      it('should mark event as failed with error message', async () => {\n        const errorMessage = 'Processing failed';\n        mockPrismaService.stripeWebhookEvent.update.mockResolvedValue({\n          ...mockWebhookEventRecord,\n          processed: true,\n          success: false,\n          errorMessage,\n        });\n\n        await expect(\n          controller['markEventProcessed']('evt_123', false, errorMessage)\n        ).resolves.not.toThrow();\n\n        expect(mockPrismaService.stripeWebhookEvent.update).toHaveBeenCalledWith({\n          where: { eventId: 'evt_123' },\n          data: {\n            processed: true,\n            processedAt: expect.any(Date),\n            success: false,\n            errorMessage,\n          },\n        });\n      });\n\n      it('should handle database errors gracefully', async () => {\n        mockPrismaService.stripeWebhookEvent.update.mockRejectedValue(\n          new Error('Database error')\n        );\n\n        // Should not throw\n        await expect(\n          controller['markEventProcessed']('evt_123', true)\n        ).resolves.not.toThrow();\n      });\n    });\n  });\n\n  describe('Event Emission', () => {\n    it('should emit success events', async () => {\n      mockStripeService.constructWebhookEvent.mockReturnValue(mockStripeEvent);\n      mockStripeService.handleWebhookEvent.mockResolvedValue(undefined);\n      mockPrismaService.stripeWebhookEvent.findUnique.mockResolvedValue(null);\n      mockPrismaService.stripeWebhookEvent.create.mockResolvedValue(mockWebhookEventRecord);\n      mockPrismaService.stripeWebhookEvent.update.mockResolvedValue({\n        ...mockWebhookEventRecord,\n        processed: true,\n        success: true,\n      });\n\n      await controller.handleWebhook(\n        mockRequest as any,\n        mockStripeEvent,\n        't=1234567890,v1=abcdef1234567890'\n      );\n\n      expect(eventEmitter.emit).toHaveBeenCalledWith('stripe.webhook.processed', {\n        eventId: mockStripeEvent.id,\n        eventType: mockStripeEvent.type,\n        processingTime: expect.any(Number),\n        success: true,\n      });\n    });\n\n    it('should emit error events', async () => {\n      const processingError = new Error('Processing failed');\n      mockStripeService.constructWebhookEvent.mockReturnValue(mockStripeEvent);\n      mockStripeService.handleWebhookEvent.mockRejectedValue(processingError);\n      mockPrismaService.stripeWebhookEvent.findUnique.mockResolvedValue(null);\n      mockPrismaService.stripeWebhookEvent.create.mockResolvedValue(mockWebhookEventRecord);\n      mockPrismaService.stripeWebhookEvent.update.mockResolvedValue({\n        ...mockWebhookEventRecord,\n        processed: true,\n        success: false,\n      });\n\n      await expect(\n        controller.handleWebhook(\n          mockRequest as any,\n          mockStripeEvent,\n          't=1234567890,v1=abcdef1234567890'\n        )\n      ).rejects.toThrow();\n\n      expect(eventEmitter.emit).toHaveBeenCalledWith('stripe.webhook.error', {\n        eventId: mockStripeEvent.id,\n        eventType: mockStripeEvent.type,\n        processingTime: expect.any(Number),\n        error: processingError.message,\n        success: false,\n      });\n    });\n  });\n\n  describe('Performance Metrics', () => {\n    it('should track processing time for successful webhooks', async () => {\n      mockStripeService.constructWebhookEvent.mockReturnValue(mockStripeEvent);\n      mockStripeService.handleWebhookEvent.mockResolvedValue(undefined);\n      mockPrismaService.stripeWebhookEvent.findUnique.mockResolvedValue(null);\n      mockPrismaService.stripeWebhookEvent.create.mockResolvedValue(mockWebhookEventRecord);\n      mockPrismaService.stripeWebhookEvent.update.mockResolvedValue({\n        ...mockWebhookEventRecord,\n        processed: true,\n        success: true,\n      });\n\n      const result = await controller.handleWebhook(\n        mockRequest as any,\n        mockStripeEvent,\n        't=1234567890,v1=abcdef1234567890'\n      );\n\n      expect(result.processingTime).toBeGreaterThanOrEqual(0);\n      expect(typeof result.processingTime).toBe('number');\n    });\n\n    it('should track processing time for failed webhooks', async () => {\n      const processingError = new Error('Processing failed');\n      mockStripeService.constructWebhookEvent.mockReturnValue(mockStripeEvent);\n      mockStripeService.handleWebhookEvent.mockRejectedValue(processingError);\n      mockPrismaService.stripeWebhookEvent.findUnique.mockResolvedValue(null);\n      mockPrismaService.stripeWebhookEvent.create.mockResolvedValue(mockWebhookEventRecord);\n      mockPrismaService.stripeWebhookEvent.update.mockResolvedValue({\n        ...mockWebhookEventRecord,\n        processed: true,\n        success: false,\n      });\n\n      await expect(\n        controller.handleWebhook(\n          mockRequest as any,\n          mockStripeEvent,\n          't=1234567890,v1=abcdef1234567890'\n        )\n      ).rejects.toThrow();\n\n      expect(eventEmitter.emit).toHaveBeenCalledWith('stripe.webhook.error', {\n        eventId: mockStripeEvent.id,\n        eventType: mockStripeEvent.type,\n        processingTime: expect.any(Number),\n        error: processingError.message,\n        success: false,\n      });\n    });\n  });\n});"],"version":3}