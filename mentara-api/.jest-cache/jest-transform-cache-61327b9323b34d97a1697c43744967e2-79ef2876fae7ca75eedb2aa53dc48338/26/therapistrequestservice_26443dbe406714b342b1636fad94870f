45a4918802a7747355a55b48118d0e09
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var TherapistRequestService_1;
var _a, _b;
Object.defineProperty(exports, "__esModule", { value: true });
exports.TherapistRequestService = void 0;
const common_1 = require("@nestjs/common");
const prisma_client_provider_1 = require("../../providers/prisma-client.provider");
const notifications_service_1 = require("../../notifications/notifications.service");
let TherapistRequestService = TherapistRequestService_1 = class TherapistRequestService {
    prisma;
    notificationsService;
    logger = new common_1.Logger(TherapistRequestService_1.name);
    constructor(prisma, notificationsService) {
        this.prisma = prisma;
        this.notificationsService = notificationsService;
    }
    // ===== RETRIEVING THERAPIST REQUESTS =====
    async getTherapistRequests(therapistId, filters) {
        try {
            const { status, priority, clientId, requestedAfter, requestedBefore, respondedAfter, respondedBefore, page = 1, limit = 20, sortBy = 'requestedAt', sortOrder = 'desc', includeExpired = false, } = filters;
            const skip = (page - 1) * limit;
            const where = {
                therapistId,
            };
            // Apply filters
            if (status)
                where.status = status;
            if (priority)
                where.priority = priority;
            if (clientId)
                where.clientId = clientId;
            if (requestedAfter)
                where.requestedAt = { gte: new Date(requestedAfter) };
            if (requestedBefore) {
                where.requestedAt = {
                    ...(typeof where.requestedAt === 'object' ? where.requestedAt : {}),
                    lte: new Date(requestedBefore),
                };
            }
            if (respondedAfter)
                where.respondedAt = { gte: new Date(respondedAfter) };
            if (respondedBefore) {
                where.respondedAt = {
                    ...(typeof where.respondedAt === 'object' ? where.respondedAt : {}),
                    lte: new Date(respondedBefore),
                };
            }
            // Exclude expired requests unless specifically requested
            if (!includeExpired) {
                where.status = { not: 'EXPIRED' };
            }
            const [requests, totalCount] = await Promise.all([
                this.prisma.clientTherapistRequest.findMany({
                    where,
                    skip,
                    take: limit,
                    orderBy: { [sortBy]: sortOrder },
                    include: {
                        client: {
                            include: {
                                user: {
                                    select: {
                                        firstName: true,
                                        lastName: true,
                                        avatarUrl: true,
                                        createdAt: true,
                                    },
                                },
                            },
                        },
                    },
                }),
                this.prisma.clientTherapistRequest.count({ where }),
            ]);
            // Get summary statistics
            const [pendingCount, highPriorityCount] = await Promise.all([
                this.prisma.clientTherapistRequest.count({
                    where: { therapistId, status: 'PENDING' },
                }),
                this.prisma.clientTherapistRequest.count({
                    where: {
                        therapistId,
                        status: 'PENDING',
                        priority: { in: ['HIGH', 'URGENT'] },
                    },
                }),
            ]);
            this.logger.log(`Retrieved ${requests.length} requests for therapist ${therapistId}`);
            return {
                requests,
                pagination: {
                    page,
                    limit,
                    totalCount,
                    totalPages: Math.ceil(totalCount / limit),
                },
                summary: {
                    pendingCount,
                    highPriorityCount,
                    filteredCount: requests.length,
                },
                filters,
            };
        }
        catch (error) {
            this.logger.error(`Failed to retrieve requests for therapist ${therapistId}:`, error);
            throw error;
        }
    }
    // ===== ACCEPTING CLIENT REQUESTS =====
    async acceptClientRequest(requestId, therapistId, responseDto) {
        try {
            return await this.prisma.$transaction(async (tx) => {
                // 1. Verify request exists and belongs to therapist
                const existingRequest = await tx.clientTherapistRequest.findUnique({
                    where: { id: requestId },
                    include: {
                        client: {
                            include: {
                                user: {
                                    select: {
                                        firstName: true,
                                        lastName: true,
                                        email: true,
                                    },
                                },
                            },
                        },
                        therapist: {
                            include: {
                                user: {
                                    select: {
                                        firstName: true,
                                        lastName: true,
                                    },
                                },
                            },
                        },
                    },
                });
                if (!existingRequest) {
                    throw new common_1.NotFoundException(`Request with ID ${requestId} not found`);
                }
                if (existingRequest.therapistId !== therapistId) {
                    throw new common_1.ForbiddenException('You can only respond to your own requests');
                }
                if (existingRequest.status !== 'PENDING') {
                    throw new common_1.BadRequestException(`Cannot accept request with status ${existingRequest.status}`);
                }
                // 2. Check if request has expired
                if (existingRequest.expiresAt &&
                    existingRequest.expiresAt < new Date()) {
                    await tx.clientTherapistRequest.update({
                        where: { id: requestId },
                        data: { status: 'EXPIRED', respondedAt: new Date() },
                    });
                    throw new common_1.BadRequestException('Request has expired and cannot be accepted');
                }
                // 3. Verify therapist is still approved and active
                const therapist = await tx.therapist.findUnique({
                    where: { userId: therapistId },
                    include: { user: true },
                });
                if (!therapist ||
                    therapist.status !== 'approved' ||
                    !therapist.user.isActive) {
                    throw new common_1.BadRequestException('Therapist is not currently approved or active');
                }
                // 4. Check for existing client-therapist relationship
                const existingRelationship = await tx.clientTherapist.findFirst({
                    where: {
                        clientId: existingRequest.clientId,
                        therapistId,
                        status: 'active',
                    },
                });
                if (existingRelationship) {
                    throw new common_1.ConflictException('Client already has an active relationship with this therapist');
                }
                // 5. Update request status to accepted
                const acceptedRequest = await tx.clientTherapistRequest.update({
                    where: { id: requestId },
                    data: {
                        status: 'ACCEPTED',
                        respondedAt: new Date(),
                        therapistResponse: responseDto.response,
                    },
                });
                // 6. Create client-therapist relationship
                const clientTherapistRelationship = await tx.clientTherapist.create({
                    data: {
                        clientId: existingRequest.clientId,
                        therapistId,
                        status: 'active',
                        assignedAt: new Date(),
                        notes: `Relationship started from accepted request. ${responseDto.schedulingMessage || ''}`,
                    },
                });
                // 7. Send acceptance notification to client
                await this.notificationsService.create({
                    userId: existingRequest.clientId,
                    title: 'Therapist Request Accepted!',
                    message: `${existingRequest.therapist.user.firstName} ${existingRequest.therapist.user.lastName} has accepted your therapy request. ${responseDto.response}`,
                    type: 'THERAPIST_REQUEST_ACCEPTED',
                    priority: 'HIGH',
                    actionUrl: `/client/therapists/${therapistId}`,
                    data: {
                        requestId,
                        therapistId,
                        relationshipId: clientTherapistRelationship.id,
                        response: responseDto.response,
                        schedulingMessage: responseDto.schedulingMessage,
                    },
                });
                // 8. Send additional scheduling notification if provided
                if (responseDto.schedulingMessage) {
                    await this.notificationsService.create({
                        userId: existingRequest.clientId,
                        title: 'Scheduling Information',
                        message: responseDto.schedulingMessage,
                        type: 'SCHEDULING_INFO',
                        priority: 'NORMAL',
                        actionUrl: `/client/therapists/${therapistId}/schedule`,
                    });
                }
                // 9. Create audit log
                await tx.auditLog.create({
                    data: {
                        userId: therapistId,
                        action: 'ACCEPT_CLIENT_REQUEST',
                        entity: 'client_therapist_request',
                        entityId: requestId,
                        metadata: {
                            requestId,
                            clientId: existingRequest.clientId,
                            relationshipId: clientTherapistRelationship.id,
                            hasSchedulingMessage: !!responseDto.schedulingMessage,
                            preferredContactMethod: responseDto.preferredContactMethod,
                            timestamp: new Date().toISOString(),
                        },
                    },
                });
                this.logger.log(`Therapist ${therapistId} accepted request ${requestId} from client ${existingRequest.clientId}`);
                return {
                    success: true,
                    request: acceptedRequest,
                    relationship: clientTherapistRelationship,
                    message: 'Client request accepted successfully',
                    nextSteps: {
                        scheduleSession: responseDto.schedulingMessage
                            ? 'Contact information provided'
                            : 'Schedule first session',
                        clientNotified: true,
                        relationshipEstablished: true,
                    },
                };
            });
        }
        catch (error) {
            this.logger.error(`Failed to accept request ${requestId} for therapist ${therapistId}:`, error);
            throw error;
        }
    }
    // ===== DECLINING CLIENT REQUESTS =====
    async declineClientRequest(requestId, therapistId, responseDto) {
        try {
            return await this.prisma.$transaction(async (tx) => {
                // 1. Verify request exists and belongs to therapist
                const existingRequest = await tx.clientTherapistRequest.findUnique({
                    where: { id: requestId },
                    include: {
                        client: {
                            include: {
                                user: {
                                    select: {
                                        firstName: true,
                                        lastName: true,
                                    },
                                },
                            },
                        },
                        therapist: {
                            include: {
                                user: {
                                    select: {
                                        firstName: true,
                                        lastName: true,
                                    },
                                },
                            },
                        },
                    },
                });
                if (!existingRequest) {
                    throw new common_1.NotFoundException(`Request with ID ${requestId} not found`);
                }
                if (existingRequest.therapistId !== therapistId) {
                    throw new common_1.ForbiddenException('You can only respond to your own requests');
                }
                if (existingRequest.status !== 'PENDING') {
                    throw new common_1.BadRequestException(`Cannot decline request with status ${existingRequest.status}`);
                }
                // 2. Update request status to declined
                const declinedRequest = await tx.clientTherapistRequest.update({
                    where: { id: requestId },
                    data: {
                        status: 'DECLINED',
                        respondedAt: new Date(),
                        therapistResponse: responseDto.response,
                    },
                });
                // 3. Send decline notification to client
                await this.notificationsService.create({
                    userId: existingRequest.clientId,
                    title: 'Therapist Request Update',
                    message: `${existingRequest.therapist.user.firstName} ${existingRequest.therapist.user.lastName} has responded to your therapy request. ${responseDto.response}`,
                    type: 'THERAPIST_REQUEST_DECLINED',
                    priority: 'NORMAL',
                    actionUrl: '/client/therapists/browse',
                    data: {
                        requestId,
                        therapistId,
                        response: responseDto.response,
                    },
                });
                // 4. Provide alternative recommendations if therapist suggests
                if (responseDto.acceptNewClients === false) {
                    await this.notificationsService.create({
                        userId: existingRequest.clientId,
                        title: 'Alternative Therapist Recommendations',
                        message: 'We can help you find other qualified therapists who may be a good fit.',
                        type: 'ALTERNATIVE_RECOMMENDATIONS',
                        priority: 'NORMAL',
                        actionUrl: '/client/therapists/recommendations',
                    });
                }
                // 5. Create audit log
                await tx.auditLog.create({
                    data: {
                        userId: therapistId,
                        action: 'DECLINE_CLIENT_REQUEST',
                        entity: 'client_therapist_request',
                        entityId: requestId,
                        metadata: {
                            requestId,
                            clientId: existingRequest.clientId,
                            acceptNewClients: responseDto.acceptNewClients,
                            preferredContactMethod: responseDto.preferredContactMethod,
                            timestamp: new Date().toISOString(),
                        },
                    },
                });
                this.logger.log(`Therapist ${therapistId} declined request ${requestId} from client ${existingRequest.clientId}`);
                return {
                    success: true,
                    request: declinedRequest,
                    message: 'Client request declined',
                    providedAlternatives: responseDto.acceptNewClients === false,
                };
            });
        }
        catch (error) {
            this.logger.error(`Failed to decline request ${requestId} for therapist ${therapistId}:`, error);
            throw error;
        }
    }
    // ===== BULK ACTIONS =====
    async performBulkAction(therapistId, actionDto) {
        try {
            const { requestIds, action, response } = actionDto;
            const results = {
                successful: [],
                failed: [],
                totalProcessed: 0,
            };
            // Process requests sequentially to avoid conflicts
            for (const requestId of requestIds) {
                try {
                    let result;
                    switch (action) {
                        case 'accept':
                            if (!response) {
                                throw new common_1.BadRequestException('Response message required for accept action');
                            }
                            result = await this.acceptClientRequest(requestId, therapistId, {
                                response,
                                acceptNewClients: true,
                                preferredContactMethod: 'platform',
                            });
                            break;
                        case 'decline':
                            if (!response) {
                                throw new common_1.BadRequestException('Response message required for decline action');
                            }
                            result = await this.declineClientRequest(requestId, therapistId, {
                                response,
                                acceptNewClients: true,
                                preferredContactMethod: 'platform',
                            });
                            break;
                        case 'mark_reviewed':
                            // Custom action to mark as reviewed without accepting/declining
                            result = await this.markRequestAsReviewed(requestId, therapistId);
                            break;
                        default:
                            throw new common_1.BadRequestException(`Invalid action: ${action}`);
                    }
                    results.successful.push({
                        requestId,
                        action,
                        status: 'completed',
                    });
                    results.totalProcessed++;
                }
                catch (error) {
                    results.failed.push({
                        requestId,
                        action,
                        error: error instanceof Error ? error.message : 'Unknown error',
                    });
                    this.logger.warn(`Failed to ${action} request ${requestId}: ${error instanceof Error ? error.message : 'Unknown error'}`);
                }
            }
            this.logger.log(`Therapist ${therapistId} performed bulk ${action}: ${results.totalProcessed} successful, ${results.failed.length} failed`);
            return {
                success: true,
                results,
                summary: {
                    totalRequested: requestIds.length,
                    totalProcessed: results.totalProcessed,
                    totalFailed: results.failed.length,
                    action,
                },
            };
        }
        catch (error) {
            this.logger.error(`Failed to perform bulk action for therapist ${therapistId}:`, error);
            throw error;
        }
    }
    // ===== STATISTICS AND ANALYTICS =====
    async getTherapistRequestStatistics(therapistId) {
        try {
            const [totalReceived, pending, accepted, declined, expired, recentRequests, activeRelationships,] = await Promise.all([
                // Total requests received
                this.prisma.clientTherapistRequest.count({
                    where: { therapistId },
                }),
                // Pending requests
                this.prisma.clientTherapistRequest.count({
                    where: { therapistId, status: 'PENDING' },
                }),
                // Accepted requests
                this.prisma.clientTherapistRequest.count({
                    where: { therapistId, status: 'ACCEPTED' },
                }),
                // Declined requests
                this.prisma.clientTherapistRequest.count({
                    where: { therapistId, status: 'DECLINED' },
                }),
                // Expired requests
                this.prisma.clientTherapistRequest.count({
                    where: { therapistId, status: 'EXPIRED' },
                }),
                // Recent requests for response time calculation
                this.prisma.clientTherapistRequest.findMany({
                    where: {
                        therapistId,
                        respondedAt: { not: null },
                    },
                    select: {
                        requestedAt: true,
                        respondedAt: true,
                    },
                    orderBy: { respondedAt: 'desc' },
                    take: 20,
                }),
                // Active client relationships
                this.prisma.clientTherapist.count({
                    where: { therapistId, status: 'active' },
                }),
            ]);
            // Calculate acceptance rate
            const totalResponded = accepted + declined;
            const acceptanceRate = totalResponded > 0 ? (accepted / totalResponded) * 100 : 0;
            // Calculate average response time
            const responseTimes = recentRequests
                .filter((req) => req.respondedAt)
                .map((req) => {
                const responseTime = req.respondedAt.getTime() - req.requestedAt.getTime();
                return responseTime / (1000 * 60 * 60); // Convert to hours
            });
            const averageResponseTime = responseTimes.length > 0
                ? responseTimes.reduce((sum, time) => sum + time, 0) /
                    responseTimes.length
                : 0;
            // Get last request and response dates
            const lastRequest = await this.prisma.clientTherapistRequest.findFirst({
                where: { therapistId },
                orderBy: { requestedAt: 'desc' },
                select: { requestedAt: true },
            });
            const lastResponse = await this.prisma.clientTherapistRequest.findFirst({
                where: { therapistId, respondedAt: { not: null } },
                orderBy: { respondedAt: 'desc' },
                select: { respondedAt: true },
            });
            this.logger.log(`Generated request statistics for therapist ${therapistId}`);
            return {
                totalReceived,
                pending,
                accepted,
                declined,
                expired,
                activeRelationships,
                acceptanceRate: Math.round(acceptanceRate * 100) / 100,
                averageResponseTime: Math.round(averageResponseTime * 100) / 100,
                lastRequestAt: lastRequest?.requestedAt || null,
                lastResponseAt: lastResponse?.respondedAt || null,
            };
        }
        catch (error) {
            this.logger.error(`Failed to generate statistics for therapist ${therapistId}:`, error);
            throw error;
        }
    }
    // ===== UTILITY METHODS =====
    async markRequestAsReviewed(requestId, therapistId) {
        // Custom method for marking requests as reviewed without formal response
        const request = await this.prisma.clientTherapistRequest.findUnique({
            where: { id: requestId },
        });
        if (!request || request.therapistId !== therapistId) {
            throw new common_1.NotFoundException(`Request ${requestId} not found or not accessible`);
        }
        // This could update a custom "reviewed" field if it existed in the schema
        // For now, we'll just log the review action
        await this.prisma.auditLog.create({
            data: {
                userId: therapistId,
                action: 'REVIEW_CLIENT_REQUEST',
                entity: 'client_therapist_request',
                entityId: requestId,
                metadata: {
                    requestId,
                    reviewedAt: new Date().toISOString(),
                },
            },
        });
        return {
            success: true,
            requestId,
            message: 'Request marked as reviewed',
        };
    }
};
exports.TherapistRequestService = TherapistRequestService;
exports.TherapistRequestService = TherapistRequestService = TherapistRequestService_1 = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [typeof (_a = typeof prisma_client_provider_1.PrismaService !== "undefined" && prisma_client_provider_1.PrismaService) === "function" ? _a : Object, typeof (_b = typeof notifications_service_1.NotificationsService !== "undefined" && notifications_service_1.NotificationsService) === "function" ? _b : Object])
], TherapistRequestService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL3RoZXJhcGlzdC9zZXJ2aWNlcy90aGVyYXBpc3QtcmVxdWVzdC5zZXJ2aWNlLnRzIiwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7O0FBQUEsMkNBT3dCO0FBQ3hCLG1GQUF1RTtBQUN2RSxxRkFBaUY7QUFTMUUsSUFBTSx1QkFBdUIsK0JBQTdCLE1BQU0sdUJBQXVCO0lBSWY7SUFDQTtJQUpGLE1BQU0sR0FBRyxJQUFJLGVBQU0sQ0FBQyx5QkFBdUIsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUVuRSxZQUNtQixNQUFxQixFQUNyQixvQkFBMEM7UUFEMUMsV0FBTSxHQUFOLE1BQU0sQ0FBZTtRQUNyQix5QkFBb0IsR0FBcEIsb0JBQW9CLENBQXNCO0lBQzFELENBQUM7SUFFSiw0Q0FBNEM7SUFFNUMsS0FBSyxDQUFDLG9CQUFvQixDQUN4QixXQUFtQixFQUNuQixPQUFtQztRQUVuQyxJQUFJLENBQUM7WUFDSCxNQUFNLEVBQ0osTUFBTSxFQUNOLFFBQVEsRUFDUixRQUFRLEVBQ1IsY0FBYyxFQUNkLGVBQWUsRUFDZixjQUFjLEVBQ2QsZUFBZSxFQUNmLElBQUksR0FBRyxDQUFDLEVBQ1IsS0FBSyxHQUFHLEVBQUUsRUFDVixNQUFNLEdBQUcsYUFBYSxFQUN0QixTQUFTLEdBQUcsTUFBTSxFQUNsQixjQUFjLEdBQUcsS0FBSyxHQUN2QixHQUFHLE9BQU8sQ0FBQztZQUVaLE1BQU0sSUFBSSxHQUFHLENBQUMsSUFBSSxHQUFHLENBQUMsQ0FBQyxHQUFHLEtBQUssQ0FBQztZQUNoQyxNQUFNLEtBQUssR0FBNEM7Z0JBQ3JELFdBQVc7YUFDWixDQUFDO1lBRUYsZ0JBQWdCO1lBQ2hCLElBQUksTUFBTTtnQkFBRSxLQUFLLENBQUMsTUFBTSxHQUFHLE1BQU0sQ0FBQztZQUNsQyxJQUFJLFFBQVE7Z0JBQUUsS0FBSyxDQUFDLFFBQVEsR0FBRyxRQUFRLENBQUM7WUFDeEMsSUFBSSxRQUFR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LEdBQUU7eURBS2dCLHNDQUFhLG9CQUFiLHNDQUFhLG9EQUNDLDRDQUFvQixvQkFBcEIsNENBQW9CO0dBTGxELHVCQUF1QixDQStxQm5DIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9ob21lL3dldG9vYS9Eb2N1bWVudHMvY29kZS9wcm9qZWN0cy9tZW50YXJhL21lbnRhcmEtYXBpL3NyYy90aGVyYXBpc3Qvc2VydmljZXMvdGhlcmFwaXN0LXJlcXVlc3Quc2VydmljZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBJbmplY3RhYmxlLFxuICBMb2dnZXIsXG4gIE5vdEZvdW5kRXhjZXB0aW9uLFxuICBDb25mbGljdEV4Y2VwdGlvbixcbiAgQmFkUmVxdWVzdEV4Y2VwdGlvbixcbiAgRm9yYmlkZGVuRXhjZXB0aW9uLFxufSBmcm9tICdAbmVzdGpzL2NvbW1vbic7XG5pbXBvcnQgeyBQcmlzbWFTZXJ2aWNlIH0gZnJvbSAnLi4vLi4vcHJvdmlkZXJzL3ByaXNtYS1jbGllbnQucHJvdmlkZXInO1xuaW1wb3J0IHsgTm90aWZpY2F0aW9uc1NlcnZpY2UgfSBmcm9tICcuLi8uLi9ub3RpZmljYXRpb25zL25vdGlmaWNhdGlvbnMuc2VydmljZSc7XG5pbXBvcnQgeyBQcmlzbWEgfSBmcm9tICdAcHJpc21hL2NsaWVudCc7XG5pbXBvcnQge1xuICB0eXBlIFRoZXJhcGlzdFJlcXVlc3RSZXNwb25zZUR0byxcbiAgdHlwZSBUaGVyYXBpc3RSZXF1ZXN0RmlsdGVyc0R0byxcbiAgdHlwZSBCdWxrVGhlcmFwaXN0QWN0aW9uRHRvLFxufSBmcm9tICdtZW50YXJhLWNvbW1vbnMnO1xuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgVGhlcmFwaXN0UmVxdWVzdFNlcnZpY2Uge1xuICBwcml2YXRlIHJlYWRvbmx5IGxvZ2dlciA9IG5ldyBMb2dnZXIoVGhlcmFwaXN0UmVxdWVzdFNlcnZpY2UubmFtZSk7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSByZWFkb25seSBwcmlzbWE6IFByaXNtYVNlcnZpY2UsXG4gICAgcHJpdmF0ZSByZWFkb25seSBub3RpZmljYXRpb25zU2VydmljZTogTm90aWZpY2F0aW9uc1NlcnZpY2UsXG4gICkge31cblxuICAvLyA9PT09PSBSRVRSSUVWSU5HIFRIRVJBUElTVCBSRVFVRVNUUyA9PT09PVxuXG4gIGFzeW5jIGdldFRoZXJhcGlzdFJlcXVlc3RzKFxuICAgIHRoZXJhcGlzdElkOiBzdHJpbmcsXG4gICAgZmlsdGVyczogVGhlcmFwaXN0UmVxdWVzdEZpbHRlcnNEdG8sXG4gICkge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCB7XG4gICAgICAgIHN0YXR1cyxcbiAgICAgICAgcHJpb3JpdHksXG4gICAgICAgIGNsaWVudElkLFxuICAgICAgICByZXF1ZXN0ZWRBZnRlcixcbiAgICAgICAgcmVxdWVzdGVkQmVmb3JlLFxuICAgICAgICByZXNwb25kZWRBZnRlcixcbiAgICAgICAgcmVzcG9uZGVkQmVmb3JlLFxuICAgICAgICBwYWdlID0gMSxcbiAgICAgICAgbGltaXQgPSAyMCxcbiAgICAgICAgc29ydEJ5ID0gJ3JlcXVlc3RlZEF0JyxcbiAgICAgICAgc29ydE9yZGVyID0gJ2Rlc2MnLFxuICAgICAgICBpbmNsdWRlRXhwaXJlZCA9IGZhbHNlLFxuICAgICAgfSA9IGZpbHRlcnM7XG5cbiAgICAgIGNvbnN0IHNraXAgPSAocGFnZSAtIDEpICogbGltaXQ7XG4gICAgICBjb25zdCB3aGVyZTogUHJpc21hLkNsaWVudFRoZXJhcGlzdFJlcXVlc3RXaGVyZUlucHV0ID0ge1xuICAgICAgICB0aGVyYXBpc3RJZCxcbiAgICAgIH07XG5cbiAgICAgIC8vIEFwcGx5IGZpbHRlcnNcbiAgICAgIGlmIChzdGF0dXMpIHdoZXJlLnN0YXR1cyA9IHN0YXR1cztcbiAgICAgIGlmIChwcmlvcml0eSkgd2hlcmUucHJpb3JpdHkgPSBwcmlvcml0eTtcbiAgICAgIGlmIChjbGllbnRJZCkgd2hlcmUuY2xpZW50SWQgPSBjbGllbnRJZDtcbiAgICAgIGlmIChyZXF1ZXN0ZWRBZnRlcikgd2hlcmUucmVxdWVzdGVkQXQgPSB7IGd0ZTogbmV3IERhdGUocmVxdWVzdGVkQWZ0ZXIpIH07XG4gICAgICBpZiAocmVxdWVzdGVkQmVmb3JlKSB7XG4gICAgICAgIHdoZXJlLnJlcXVlc3RlZEF0ID0ge1xuICAgICAgICAgIC4uLih0eXBlb2Ygd2hlcmUucmVxdWVzdGVkQXQgPT09ICdvYmplY3QnID8gd2hlcmUucmVxdWVzdGVkQXQgOiB7fSksXG4gICAgICAgICAgbHRlOiBuZXcgRGF0ZShyZXF1ZXN0ZWRCZWZvcmUpLFxuICAgICAgICB9O1xuICAgICAgfVxuICAgICAgaWYgKHJlc3BvbmRlZEFmdGVyKSB3aGVyZS5yZXNwb25kZWRBdCA9IHsgZ3RlOiBuZXcgRGF0ZShyZXNwb25kZWRBZnRlcikgfTtcbiAgICAgIGlmIChyZXNwb25kZWRCZWZvcmUpIHtcbiAgICAgICAgd2hlcmUucmVzcG9uZGVkQXQgPSB7XG4gICAgICAgICAgLi4uKHR5cGVvZiB3aGVyZS5yZXNwb25kZWRBdCA9PT0gJ29iamVjdCcgPyB3aGVyZS5yZXNwb25kZWRBdCA6IHt9KSxcbiAgICAgICAgICBsdGU6IG5ldyBEYXRlKHJlc3BvbmRlZEJlZm9yZSksXG4gICAgICAgIH07XG4gICAgICB9XG5cbiAgICAgIC8vIEV4Y2x1ZGUgZXhwaXJlZCByZXF1ZXN0cyB1bmxlc3Mgc3BlY2lmaWNhbGx5IHJlcXVlc3RlZFxuICAgICAgaWYgKCFpbmNsdWRlRXhwaXJlZCkge1xuICAgICAgICB3aGVyZS5zdGF0dXMgPSB7IG5vdDogJ0VYUElSRUQnIH07XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IFtyZXF1ZXN0cywgdG90YWxDb3VudF0gPSBhd2FpdCBQcm9taXNlLmFsbChbXG4gICAgICAgIHRoaXMucHJpc21hLmNsaWVudFRoZXJhcGlzdFJlcXVlc3QuZmluZE1hbnkoe1xuICAgICAgICAgIHdoZXJlLFxuICAgICAgICAgIHNraXAsXG4gICAgICAgICAgdGFrZTogbGltaXQsXG4gICAgICAgICAgb3JkZXJCeTogeyBbc29ydEJ5XTogc29ydE9yZGVyIH0sXG4gICAgICAgICAgaW5jbHVkZToge1xuICAgICAgICAgICAgY2xpZW50OiB7XG4gICAgICAgICAgICAgIGluY2x1ZGU6IHtcbiAgICAgICAgICAgICAgICB1c2VyOiB7XG4gICAgICAgICAgICAgICAgICBzZWxlY3Q6IHtcbiAgICAgICAgICAgICAgICAgICAgZmlyc3ROYW1lOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgICBsYXN0TmFtZTogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgICAgYXZhdGFyVXJsOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgICBjcmVhdGVkQXQ6IHRydWUsXG4gICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0sXG4gICAgICAgIH0pLFxuICAgICAgICB0aGlzLnByaXNtYS5jbGllbnRUaGVyYXBpc3RSZXF1ZXN0LmNvdW50KHsgd2hlcmUgfSksXG4gICAgICBdKTtcblxuICAgICAgLy8gR2V0IHN1bW1hcnkgc3RhdGlzdGljc1xuICAgICAgY29uc3QgW3BlbmRpbmdDb3VudCwgaGlnaFByaW9yaXR5Q291bnRdID0gYXdhaXQgUHJvbWlzZS5hbGwoW1xuICAgICAgICB0aGlzLnByaXNtYS5jbGllbnRUaGVyYXBpc3RSZXF1ZXN0LmNvdW50KHtcbiAgICAgICAgICB3aGVyZTogeyB0aGVyYXBpc3RJZCwgc3RhdHVzOiAnUEVORElORycgfSxcbiAgICAgICAgfSksXG4gICAgICAgIHRoaXMucHJpc21hLmNsaWVudFRoZXJhcGlzdFJlcXVlc3QuY291bnQoe1xuICAgICAgICAgIHdoZXJlOiB7XG4gICAgICAgICAgICB0aGVyYXBpc3RJZCxcbiAgICAgICAgICAgIHN0YXR1czogJ1BFTkRJTkcnLFxuICAgICAgICAgICAgcHJpb3JpdHk6IHsgaW46IFsnSElHSCcsICdVUkdFTlQnXSB9LFxuICAgICAgICAgIH0sXG4gICAgICAgIH0pLFxuICAgICAgXSk7XG5cbiAgICAgIHRoaXMubG9nZ2VyLmxvZyhcbiAgICAgICAgYFJldHJpZXZlZCAke3JlcXVlc3RzLmxlbmd0aH0gcmVxdWVzdHMgZm9yIHRoZXJhcGlzdCAke3RoZXJhcGlzdElkfWAsXG4gICAgICApO1xuXG4gICAgICByZXR1cm4ge1xuICAgICAgICByZXF1ZXN0cyxcbiAgICAgICAgcGFnaW5hdGlvbjoge1xuICAgICAgICAgIHBhZ2UsXG4gICAgICAgICAgbGltaXQsXG4gICAgICAgICAgdG90YWxDb3VudCxcbiAgICAgICAgICB0b3RhbFBhZ2VzOiBNYXRoLmNlaWwodG90YWxDb3VudCAvIGxpbWl0KSxcbiAgICAgICAgfSxcbiAgICAgICAgc3VtbWFyeToge1xuICAgICAgICAgIHBlbmRpbmdDb3VudCxcbiAgICAgICAgICBoaWdoUHJpb3JpdHlDb3VudCxcbiAgICAgICAgICBmaWx0ZXJlZENvdW50OiByZXF1ZXN0cy5sZW5ndGgsXG4gICAgICAgIH0sXG4gICAgICAgIGZpbHRlcnMsXG4gICAgICB9O1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aGlzLmxvZ2dlci5lcnJvcihcbiAgICAgICAgYEZhaWxlZCB0byByZXRyaWV2ZSByZXF1ZXN0cyBmb3IgdGhlcmFwaXN0ICR7dGhlcmFwaXN0SWR9OmAsXG4gICAgICAgIGVycm9yLFxuICAgICAgKTtcbiAgICAgIHRocm93IGVycm9yO1xuICAgIH1cbiAgfVxuXG4gIC8vID09PT09IEFDQ0VQVElORyBDTElFTlQgUkVRVUVTVFMgPT09PT1cblxuICBhc3luYyBhY2NlcHRDbGllbnRSZXF1ZXN0KFxuICAgIHJlcXVlc3RJZDogc3RyaW5nLFxuICAgIHRoZXJhcGlzdElkOiBzdHJpbmcsXG4gICAgcmVzcG9uc2VEdG86IFRoZXJhcGlzdFJlcXVlc3RSZXNwb25zZUR0byxcbiAgKSB7XG4gICAgdHJ5IHtcbiAgICAgIHJldHVybiBhd2FpdCB0aGlzLnByaXNtYS4kdHJhbnNhY3Rpb24oYXN5bmMgKHR4KSA9PiB7XG4gICAgICAgIC8vIDEuIFZlcmlmeSByZXF1ZXN0IGV4aXN0cyBhbmQgYmVsb25ncyB0byB0aGVyYXBpc3RcbiAgICAgICAgY29uc3QgZXhpc3RpbmdSZXF1ZXN0ID0gYXdhaXQgdHguY2xpZW50VGhlcmFwaXN0UmVxdWVzdC5maW5kVW5pcXVlKHtcbiAgICAgICAgICB3aGVyZTogeyBpZDogcmVxdWVzdElkIH0sXG4gICAgICAgICAgaW5jbHVkZToge1xuICAgICAgICAgICAgY2xpZW50OiB7XG4gICAgICAgICAgICAgIGluY2x1ZGU6IHtcbiAgICAgICAgICAgICAgICB1c2VyOiB7XG4gICAgICAgICAgICAgICAgICBzZWxlY3Q6IHtcbiAgICAgICAgICAgICAgICAgICAgZmlyc3ROYW1lOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgICBsYXN0TmFtZTogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgICAgZW1haWw6IHRydWUsXG4gICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgdGhlcmFwaXN0OiB7XG4gICAgICAgICAgICAgIGluY2x1ZGU6IHtcbiAgICAgICAgICAgICAgICB1c2VyOiB7XG4gICAgICAgICAgICAgICAgICBzZWxlY3Q6IHtcbiAgICAgICAgICAgICAgICAgICAgZmlyc3ROYW1lOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgICBsYXN0TmFtZTogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgfSk7XG5cbiAgICAgICAgaWYgKCFleGlzdGluZ1JlcXVlc3QpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgTm90Rm91bmRFeGNlcHRpb24oYFJlcXVlc3Qgd2l0aCBJRCAke3JlcXVlc3RJZH0gbm90IGZvdW5kYCk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoZXhpc3RpbmdSZXF1ZXN0LnRoZXJhcGlzdElkICE9PSB0aGVyYXBpc3RJZCkge1xuICAgICAgICAgIHRocm93IG5ldyBGb3JiaWRkZW5FeGNlcHRpb24oXG4gICAgICAgICAgICAnWW91IGNhbiBvbmx5IHJlc3BvbmQgdG8geW91ciBvd24gcmVxdWVzdHMnLFxuICAgICAgICAgICk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoZXhpc3RpbmdSZXF1ZXN0LnN0YXR1cyAhPT0gJ1BFTkRJTkcnKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFeGNlcHRpb24oXG4gICAgICAgICAgICBgQ2Fubm90IGFjY2VwdCByZXF1ZXN0IHdpdGggc3RhdHVzICR7ZXhpc3RpbmdSZXF1ZXN0LnN0YXR1c31gLFxuICAgICAgICAgICk7XG4gICAgICAgIH1cblxuICAgICAgICAvLyAyLiBDaGVjayBpZiByZXF1ZXN0IGhhcyBleHBpcmVkXG4gICAgICAgIGlmIChcbiAgICAgICAgICBleGlzdGluZ1JlcXVlc3QuZXhwaXJlc0F0ICYmXG4gICAgICAgICAgZXhpc3RpbmdSZXF1ZXN0LmV4cGlyZXNBdCA8IG5ldyBEYXRlKClcbiAgICAgICAgKSB7XG4gICAgICAgICAgYXdhaXQgdHguY2xpZW50VGhlcmFwaXN0UmVxdWVzdC51cGRhdGUoe1xuICAgICAgICAgICAgd2hlcmU6IHsgaWQ6IHJlcXVlc3RJZCB9LFxuICAgICAgICAgICAgZGF0YTogeyBzdGF0dXM6ICdFWFBJUkVEJywgcmVzcG9uZGVkQXQ6IG5ldyBEYXRlKCkgfSxcbiAgICAgICAgICB9KTtcbiAgICAgICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdEV4Y2VwdGlvbihcbiAgICAgICAgICAgICdSZXF1ZXN0IGhhcyBleHBpcmVkIGFuZCBjYW5ub3QgYmUgYWNjZXB0ZWQnLFxuICAgICAgICAgICk7XG4gICAgICAgIH1cblxuICAgICAgICAvLyAzLiBWZXJpZnkgdGhlcmFwaXN0IGlzIHN0aWxsIGFwcHJvdmVkIGFuZCBhY3RpdmVcbiAgICAgICAgY29uc3QgdGhlcmFwaXN0ID0gYXdhaXQgdHgudGhlcmFwaXN0LmZpbmRVbmlxdWUoe1xuICAgICAgICAgIHdoZXJlOiB7IHVzZXJJZDogdGhlcmFwaXN0SWQgfSxcbiAgICAgICAgICBpbmNsdWRlOiB7IHVzZXI6IHRydWUgfSxcbiAgICAgICAgfSk7XG5cbiAgICAgICAgaWYgKFxuICAgICAgICAgICF0aGVyYXBpc3QgfHxcbiAgICAgICAgICB0aGVyYXBpc3Quc3RhdHVzICE9PSAnYXBwcm92ZWQnIHx8XG4gICAgICAgICAgIXRoZXJhcGlzdC51c2VyLmlzQWN0aXZlXG4gICAgICAgICkge1xuICAgICAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0RXhjZXB0aW9uKFxuICAgICAgICAgICAgJ1RoZXJhcGlzdCBpcyBub3QgY3VycmVudGx5IGFwcHJvdmVkIG9yIGFjdGl2ZScsXG4gICAgICAgICAgKTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIDQuIENoZWNrIGZvciBleGlzdGluZyBjbGllbnQtdGhlcmFwaXN0IHJlbGF0aW9uc2hpcFxuICAgICAgICBjb25zdCBleGlzdGluZ1JlbGF0aW9uc2hpcCA9IGF3YWl0IHR4LmNsaWVudFRoZXJhcGlzdC5maW5kRmlyc3Qoe1xuICAgICAgICAgIHdoZXJlOiB7XG4gICAgICAgICAgICBjbGllbnRJZDogZXhpc3RpbmdSZXF1ZXN0LmNsaWVudElkLFxuICAgICAgICAgICAgdGhlcmFwaXN0SWQsXG4gICAgICAgICAgICBzdGF0dXM6ICdhY3RpdmUnLFxuICAgICAgICAgIH0sXG4gICAgICAgIH0pO1xuXG4gICAgICAgIGlmIChleGlzdGluZ1JlbGF0aW9uc2hpcCkge1xuICAgICAgICAgIHRocm93IG5ldyBDb25mbGljdEV4Y2VwdGlvbihcbiAgICAgICAgICAgICdDbGllbnQgYWxyZWFkeSBoYXMgYW4gYWN0aXZlIHJlbGF0aW9uc2hpcCB3aXRoIHRoaXMgdGhlcmFwaXN0JyxcbiAgICAgICAgICApO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gNS4gVXBkYXRlIHJlcXVlc3Qgc3RhdHVzIHRvIGFjY2VwdGVkXG4gICAgICAgIGNvbnN0IGFjY2VwdGVkUmVxdWVzdCA9IGF3YWl0IHR4LmNsaWVudFRoZXJhcGlzdFJlcXVlc3QudXBkYXRlKHtcbiAgICAgICAgICB3aGVyZTogeyBpZDogcmVxdWVzdElkIH0sXG4gICAgICAgICAgZGF0YToge1xuICAgICAgICAgICAgc3RhdHVzOiAnQUNDRVBURUQnLFxuICAgICAgICAgICAgcmVzcG9uZGVkQXQ6IG5ldyBEYXRlKCksXG4gICAgICAgICAgICB0aGVyYXBpc3RSZXNwb25zZTogcmVzcG9uc2VEdG8ucmVzcG9uc2UsXG4gICAgICAgICAgfSxcbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy8gNi4gQ3JlYXRlIGNsaWVudC10aGVyYXBpc3QgcmVsYXRpb25zaGlwXG4gICAgICAgIGNvbnN0IGNsaWVudFRoZXJhcGlzdFJlbGF0aW9uc2hpcCA9IGF3YWl0IHR4LmNsaWVudFRoZXJhcGlzdC5jcmVhdGUoe1xuICAgICAgICAgIGRhdGE6IHtcbiAgICAgICAgICAgIGNsaWVudElkOiBleGlzdGluZ1JlcXVlc3QuY2xpZW50SWQsXG4gICAgICAgICAgICB0aGVyYXBpc3RJZCxcbiAgICAgICAgICAgIHN0YXR1czogJ2FjdGl2ZScsXG4gICAgICAgICAgICBhc3NpZ25lZEF0OiBuZXcgRGF0ZSgpLFxuICAgICAgICAgICAgbm90ZXM6IGBSZWxhdGlvbnNoaXAgc3RhcnRlZCBmcm9tIGFjY2VwdGVkIHJlcXVlc3QuICR7cmVzcG9uc2VEdG8uc2NoZWR1bGluZ01lc3NhZ2UgfHwgJyd9YCxcbiAgICAgICAgICB9LFxuICAgICAgICB9KTtcblxuICAgICAgICAvLyA3LiBTZW5kIGFjY2VwdGFuY2Ugbm90aWZpY2F0aW9uIHRvIGNsaWVudFxuICAgICAgICBhd2FpdCB0aGlzLm5vdGlmaWNhdGlvbnNTZXJ2aWNlLmNyZWF0ZSh7XG4gICAgICAgICAgdXNlcklkOiBleGlzdGluZ1JlcXVlc3QuY2xpZW50SWQsXG4gICAgICAgICAgdGl0bGU6ICdUaGVyYXBpc3QgUmVxdWVzdCBBY2NlcHRlZCEnLFxuICAgICAgICAgIG1lc3NhZ2U6IGAke2V4aXN0aW5nUmVxdWVzdC50aGVyYXBpc3QudXNlci5maXJzdE5hbWV9ICR7ZXhpc3RpbmdSZXF1ZXN0LnRoZXJhcGlzdC51c2VyLmxhc3ROYW1lfSBoYXMgYWNjZXB0ZWQgeW91ciB0aGVyYXB5IHJlcXVlc3QuICR7cmVzcG9uc2VEdG8ucmVzcG9uc2V9YCxcbiAgICAgICAgICB0eXBlOiAnVEhFUkFQSVNUX1JFUVVFU1RfQUNDRVBURUQnLFxuICAgICAgICAgIHByaW9yaXR5OiAnSElHSCcsXG4gICAgICAgICAgYWN0aW9uVXJsOiBgL2NsaWVudC90aGVyYXBpc3RzLyR7dGhlcmFwaXN0SWR9YCxcbiAgICAgICAgICBkYXRhOiB7XG4gICAgICAgICAgICByZXF1ZXN0SWQsXG4gICAgICAgICAgICB0aGVyYXBpc3RJZCxcbiAgICAgICAgICAgIHJlbGF0aW9uc2hpcElkOiBjbGllbnRUaGVyYXBpc3RSZWxhdGlvbnNoaXAuaWQsXG4gICAgICAgICAgICByZXNwb25zZTogcmVzcG9uc2VEdG8ucmVzcG9uc2UsXG4gICAgICAgICAgICBzY2hlZHVsaW5nTWVzc2FnZTogcmVzcG9uc2VEdG8uc2NoZWR1bGluZ01lc3NhZ2UsXG4gICAgICAgICAgfSxcbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy8gOC4gU2VuZCBhZGRpdGlvbmFsIHNjaGVkdWxpbmcgbm90aWZpY2F0aW9uIGlmIHByb3ZpZGVkXG4gICAgICAgIGlmIChyZXNwb25zZUR0by5zY2hlZHVsaW5nTWVzc2FnZSkge1xuICAgICAgICAgIGF3YWl0IHRoaXMubm90aWZpY2F0aW9uc1NlcnZpY2UuY3JlYXRlKHtcbiAgICAgICAgICAgIHVzZXJJZDogZXhpc3RpbmdSZXF1ZXN0LmNsaWVudElkLFxuICAgICAgICAgICAgdGl0bGU6ICdTY2hlZHVsaW5nIEluZm9ybWF0aW9uJyxcbiAgICAgICAgICAgIG1lc3NhZ2U6IHJlc3BvbnNlRHRvLnNjaGVkdWxpbmdNZXNzYWdlLFxuICAgICAgICAgICAgdHlwZTogJ1NDSEVEVUxJTkdfSU5GTycsXG4gICAgICAgICAgICBwcmlvcml0eTogJ05PUk1BTCcsXG4gICAgICAgICAgICBhY3Rpb25Vcmw6IGAvY2xpZW50L3RoZXJhcGlzdHMvJHt0aGVyYXBpc3RJZH0vc2NoZWR1bGVgLFxuICAgICAgICAgIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gOS4gQ3JlYXRlIGF1ZGl0IGxvZ1xuICAgICAgICBhd2FpdCB0eC5hdWRpdExvZy5jcmVhdGUoe1xuICAgICAgICAgIGRhdGE6IHtcbiAgICAgICAgICAgIHVzZXJJZDogdGhlcmFwaXN0SWQsXG4gICAgICAgICAgICBhY3Rpb246ICdBQ0NFUFRfQ0xJRU5UX1JFUVVFU1QnLFxuICAgICAgICAgICAgZW50aXR5OiAnY2xpZW50X3RoZXJhcGlzdF9yZXF1ZXN0JyxcbiAgICAgICAgICAgIGVudGl0eUlkOiByZXF1ZXN0SWQsXG4gICAgICAgICAgICBtZXRhZGF0YToge1xuICAgICAgICAgICAgICByZXF1ZXN0SWQsXG4gICAgICAgICAgICAgIGNsaWVudElkOiBleGlzdGluZ1JlcXVlc3QuY2xpZW50SWQsXG4gICAgICAgICAgICAgIHJlbGF0aW9uc2hpcElkOiBjbGllbnRUaGVyYXBpc3RSZWxhdGlvbnNoaXAuaWQsXG4gICAgICAgICAgICAgIGhhc1NjaGVkdWxpbmdNZXNzYWdlOiAhIXJlc3BvbnNlRHRvLnNjaGVkdWxpbmdNZXNzYWdlLFxuICAgICAgICAgICAgICBwcmVmZXJyZWRDb250YWN0TWV0aG9kOiByZXNwb25zZUR0by5wcmVmZXJyZWRDb250YWN0TWV0aG9kLFxuICAgICAgICAgICAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy5sb2dnZXIubG9nKFxuICAgICAgICAgIGBUaGVyYXBpc3QgJHt0aGVyYXBpc3RJZH0gYWNjZXB0ZWQgcmVxdWVzdCAke3JlcXVlc3RJZH0gZnJvbSBjbGllbnQgJHtleGlzdGluZ1JlcXVlc3QuY2xpZW50SWR9YCxcbiAgICAgICAgKTtcblxuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICAgICAgcmVxdWVzdDogYWNjZXB0ZWRSZXF1ZXN0LFxuICAgICAgICAgIHJlbGF0aW9uc2hpcDogY2xpZW50VGhlcmFwaXN0UmVsYXRpb25zaGlwLFxuICAgICAgICAgIG1lc3NhZ2U6ICdDbGllbnQgcmVxdWVzdCBhY2NlcHRlZCBzdWNjZXNzZnVsbHknLFxuICAgICAgICAgIG5leHRTdGVwczoge1xuICAgICAgICAgICAgc2NoZWR1bGVTZXNzaW9uOiByZXNwb25zZUR0by5zY2hlZHVsaW5nTWVzc2FnZVxuICAgICAgICAgICAgICA/ICdDb250YWN0IGluZm9ybWF0aW9uIHByb3ZpZGVkJ1xuICAgICAgICAgICAgICA6ICdTY2hlZHVsZSBmaXJzdCBzZXNzaW9uJyxcbiAgICAgICAgICAgIGNsaWVudE5vdGlmaWVkOiB0cnVlLFxuICAgICAgICAgICAgcmVsYXRpb25zaGlwRXN0YWJsaXNoZWQ6IHRydWUsXG4gICAgICAgICAgfSxcbiAgICAgICAgfTtcbiAgICAgIH0pO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aGlzLmxvZ2dlci5lcnJvcihcbiAgICAgICAgYEZhaWxlZCB0byBhY2NlcHQgcmVxdWVzdCAke3JlcXVlc3RJZH0gZm9yIHRoZXJhcGlzdCAke3RoZXJhcGlzdElkfTpgLFxuICAgICAgICBlcnJvcixcbiAgICAgICk7XG4gICAgICB0aHJvdyBlcnJvcjtcbiAgICB9XG4gIH1cblxuICAvLyA9PT09PSBERUNMSU5JTkcgQ0xJRU5UIFJFUVVFU1RTID09PT09XG5cbiAgYXN5bmMgZGVjbGluZUNsaWVudFJlcXVlc3QoXG4gICAgcmVxdWVzdElkOiBzdHJpbmcsXG4gICAgdGhlcmFwaXN0SWQ6IHN0cmluZyxcbiAgICByZXNwb25zZUR0bzogVGhlcmFwaXN0UmVxdWVzdFJlc3BvbnNlRHRvLFxuICApIHtcbiAgICB0cnkge1xuICAgICAgcmV0dXJuIGF3YWl0IHRoaXMucHJpc21hLiR0cmFuc2FjdGlvbihhc3luYyAodHgpID0+IHtcbiAgICAgICAgLy8gMS4gVmVyaWZ5IHJlcXVlc3QgZXhpc3RzIGFuZCBiZWxvbmdzIHRvIHRoZXJhcGlzdFxuICAgICAgICBjb25zdCBleGlzdGluZ1JlcXVlc3QgPSBhd2FpdCB0eC5jbGllbnRUaGVyYXBpc3RSZXF1ZXN0LmZpbmRVbmlxdWUoe1xuICAgICAgICAgIHdoZXJlOiB7IGlkOiByZXF1ZXN0SWQgfSxcbiAgICAgICAgICBpbmNsdWRlOiB7XG4gICAgICAgICAgICBjbGllbnQ6IHtcbiAgICAgICAgICAgICAgaW5jbHVkZToge1xuICAgICAgICAgICAgICAgIHVzZXI6IHtcbiAgICAgICAgICAgICAgICAgIHNlbGVjdDoge1xuICAgICAgICAgICAgICAgICAgICBmaXJzdE5hbWU6IHRydWUsXG4gICAgICAgICAgICAgICAgICAgIGxhc3ROYW1lOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHRoZXJhcGlzdDoge1xuICAgICAgICAgICAgICBpbmNsdWRlOiB7XG4gICAgICAgICAgICAgICAgdXNlcjoge1xuICAgICAgICAgICAgICAgICAgc2VsZWN0OiB7XG4gICAgICAgICAgICAgICAgICAgIGZpcnN0TmFtZTogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgICAgbGFzdE5hbWU6IHRydWUsXG4gICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0sXG4gICAgICAgIH0pO1xuXG4gICAgICAgIGlmICghZXhpc3RpbmdSZXF1ZXN0KSB7XG4gICAgICAgICAgdGhyb3cgbmV3IE5vdEZvdW5kRXhjZXB0aW9uKGBSZXF1ZXN0IHdpdGggSUQgJHtyZXF1ZXN0SWR9IG5vdCBmb3VuZGApO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGV4aXN0aW5nUmVxdWVzdC50aGVyYXBpc3RJZCAhPT0gdGhlcmFwaXN0SWQpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRm9yYmlkZGVuRXhjZXB0aW9uKFxuICAgICAgICAgICAgJ1lvdSBjYW4gb25seSByZXNwb25kIHRvIHlvdXIgb3duIHJlcXVlc3RzJyxcbiAgICAgICAgICApO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGV4aXN0aW5nUmVxdWVzdC5zdGF0dXMgIT09ICdQRU5ESU5HJykge1xuICAgICAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0RXhjZXB0aW9uKFxuICAgICAgICAgICAgYENhbm5vdCBkZWNsaW5lIHJlcXVlc3Qgd2l0aCBzdGF0dXMgJHtleGlzdGluZ1JlcXVlc3Quc3RhdHVzfWAsXG4gICAgICAgICAgKTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIDIuIFVwZGF0ZSByZXF1ZXN0IHN0YXR1cyB0byBkZWNsaW5lZFxuICAgICAgICBjb25zdCBkZWNsaW5lZFJlcXVlc3QgPSBhd2FpdCB0eC5jbGllbnRUaGVyYXBpc3RSZXF1ZXN0LnVwZGF0ZSh7XG4gICAgICAgICAgd2hlcmU6IHsgaWQ6IHJlcXVlc3RJZCB9LFxuICAgICAgICAgIGRhdGE6IHtcbiAgICAgICAgICAgIHN0YXR1czogJ0RFQ0xJTkVEJyxcbiAgICAgICAgICAgIHJlc3BvbmRlZEF0OiBuZXcgRGF0ZSgpLFxuICAgICAgICAgICAgdGhlcmFwaXN0UmVzcG9uc2U6IHJlc3BvbnNlRHRvLnJlc3BvbnNlLFxuICAgICAgICAgIH0sXG4gICAgICAgIH0pO1xuXG4gICAgICAgIC8vIDMuIFNlbmQgZGVjbGluZSBub3RpZmljYXRpb24gdG8gY2xpZW50XG4gICAgICAgIGF3YWl0IHRoaXMubm90aWZpY2F0aW9uc1NlcnZpY2UuY3JlYXRlKHtcbiAgICAgICAgICB1c2VySWQ6IGV4aXN0aW5nUmVxdWVzdC5jbGllbnRJZCxcbiAgICAgICAgICB0aXRsZTogJ1RoZXJhcGlzdCBSZXF1ZXN0IFVwZGF0ZScsXG4gICAgICAgICAgbWVzc2FnZTogYCR7ZXhpc3RpbmdSZXF1ZXN0LnRoZXJhcGlzdC51c2VyLmZpcnN0TmFtZX0gJHtleGlzdGluZ1JlcXVlc3QudGhlcmFwaXN0LnVzZXIubGFzdE5hbWV9IGhhcyByZXNwb25kZWQgdG8geW91ciB0aGVyYXB5IHJlcXVlc3QuICR7cmVzcG9uc2VEdG8ucmVzcG9uc2V9YCxcbiAgICAgICAgICB0eXBlOiAnVEhFUkFQSVNUX1JFUVVFU1RfREVDTElORUQnLFxuICAgICAgICAgIHByaW9yaXR5OiAnTk9STUFMJyxcbiAgICAgICAgICBhY3Rpb25Vcmw6ICcvY2xpZW50L3RoZXJhcGlzdHMvYnJvd3NlJyxcbiAgICAgICAgICBkYXRhOiB7XG4gICAgICAgICAgICByZXF1ZXN0SWQsXG4gICAgICAgICAgICB0aGVyYXBpc3RJZCxcbiAgICAgICAgICAgIHJlc3BvbnNlOiByZXNwb25zZUR0by5yZXNwb25zZSxcbiAgICAgICAgICB9LFxuICAgICAgICB9KTtcblxuICAgICAgICAvLyA0LiBQcm92aWRlIGFsdGVybmF0aXZlIHJlY29tbWVuZGF0aW9ucyBpZiB0aGVyYXBpc3Qgc3VnZ2VzdHNcbiAgICAgICAgaWYgKHJlc3BvbnNlRHRvLmFjY2VwdE5ld0NsaWVudHMgPT09IGZhbHNlKSB7XG4gICAgICAgICAgYXdhaXQgdGhpcy5ub3RpZmljYXRpb25zU2VydmljZS5jcmVhdGUoe1xuICAgICAgICAgICAgdXNlcklkOiBleGlzdGluZ1JlcXVlc3QuY2xpZW50SWQsXG4gICAgICAgICAgICB0aXRsZTogJ0FsdGVybmF0aXZlIFRoZXJhcGlzdCBSZWNvbW1lbmRhdGlvbnMnLFxuICAgICAgICAgICAgbWVzc2FnZTpcbiAgICAgICAgICAgICAgJ1dlIGNhbiBoZWxwIHlvdSBmaW5kIG90aGVyIHF1YWxpZmllZCB0aGVyYXBpc3RzIHdobyBtYXkgYmUgYSBnb29kIGZpdC4nLFxuICAgICAgICAgICAgdHlwZTogJ0FMVEVSTkFUSVZFX1JFQ09NTUVOREFUSU9OUycsXG4gICAgICAgICAgICBwcmlvcml0eTogJ05PUk1BTCcsXG4gICAgICAgICAgICBhY3Rpb25Vcmw6ICcvY2xpZW50L3RoZXJhcGlzdHMvcmVjb21tZW5kYXRpb25zJyxcbiAgICAgICAgICB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIDUuIENyZWF0ZSBhdWRpdCBsb2dcbiAgICAgICAgYXdhaXQgdHguYXVkaXRMb2cuY3JlYXRlKHtcbiAgICAgICAgICBkYXRhOiB7XG4gICAgICAgICAgICB1c2VySWQ6IHRoZXJhcGlzdElkLFxuICAgICAgICAgICAgYWN0aW9uOiAnREVDTElORV9DTElFTlRfUkVRVUVTVCcsXG4gICAgICAgICAgICBlbnRpdHk6ICdjbGllbnRfdGhlcmFwaXN0X3JlcXVlc3QnLFxuICAgICAgICAgICAgZW50aXR5SWQ6IHJlcXVlc3RJZCxcbiAgICAgICAgICAgIG1ldGFkYXRhOiB7XG4gICAgICAgICAgICAgIHJlcXVlc3RJZCxcbiAgICAgICAgICAgICAgY2xpZW50SWQ6IGV4aXN0aW5nUmVxdWVzdC5jbGllbnRJZCxcbiAgICAgICAgICAgICAgYWNjZXB0TmV3Q2xpZW50czogcmVzcG9uc2VEdG8uYWNjZXB0TmV3Q2xpZW50cyxcbiAgICAgICAgICAgICAgcHJlZmVycmVkQ29udGFjdE1ldGhvZDogcmVzcG9uc2VEdG8ucHJlZmVycmVkQ29udGFjdE1ldGhvZCxcbiAgICAgICAgICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0sXG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRoaXMubG9nZ2VyLmxvZyhcbiAgICAgICAgICBgVGhlcmFwaXN0ICR7dGhlcmFwaXN0SWR9IGRlY2xpbmVkIHJlcXVlc3QgJHtyZXF1ZXN0SWR9IGZyb20gY2xpZW50ICR7ZXhpc3RpbmdSZXF1ZXN0LmNsaWVudElkfWAsXG4gICAgICAgICk7XG5cbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgICAgIHJlcXVlc3Q6IGRlY2xpbmVkUmVxdWVzdCxcbiAgICAgICAgICBtZXNzYWdlOiAnQ2xpZW50IHJlcXVlc3QgZGVjbGluZWQnLFxuICAgICAgICAgIHByb3ZpZGVkQWx0ZXJuYXRpdmVzOiByZXNwb25zZUR0by5hY2NlcHROZXdDbGllbnRzID09PSBmYWxzZSxcbiAgICAgICAgfTtcbiAgICAgIH0pO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aGlzLmxvZ2dlci5lcnJvcihcbiAgICAgICAgYEZhaWxlZCB0byBkZWNsaW5lIHJlcXVlc3QgJHtyZXF1ZXN0SWR9IGZvciB0aGVyYXBpc3QgJHt0aGVyYXBpc3RJZH06YCxcbiAgICAgICAgZXJyb3IsXG4gICAgICApO1xuICAgICAgdGhyb3cgZXJyb3I7XG4gICAgfVxuICB9XG5cbiAgLy8gPT09PT0gQlVMSyBBQ1RJT05TID09PT09XG5cbiAgYXN5bmMgcGVyZm9ybUJ1bGtBY3Rpb24oXG4gICAgdGhlcmFwaXN0SWQ6IHN0cmluZyxcbiAgICBhY3Rpb25EdG86IEJ1bGtUaGVyYXBpc3RBY3Rpb25EdG8sXG4gICkge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCB7IHJlcXVlc3RJZHMsIGFjdGlvbiwgcmVzcG9uc2UgfSA9IGFjdGlvbkR0bztcblxuICAgICAgY29uc3QgcmVzdWx0cyA9IHtcbiAgICAgICAgc3VjY2Vzc2Z1bDogW10gYXMgYW55W10sXG4gICAgICAgIGZhaWxlZDogW10gYXMgYW55W10sXG4gICAgICAgIHRvdGFsUHJvY2Vzc2VkOiAwLFxuICAgICAgfTtcblxuICAgICAgLy8gUHJvY2VzcyByZXF1ZXN0cyBzZXF1ZW50aWFsbHkgdG8gYXZvaWQgY29uZmxpY3RzXG4gICAgICBmb3IgKGNvbnN0IHJlcXVlc3RJZCBvZiByZXF1ZXN0SWRzKSB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgbGV0IHJlc3VsdDtcblxuICAgICAgICAgIHN3aXRjaCAoYWN0aW9uKSB7XG4gICAgICAgICAgICBjYXNlICdhY2NlcHQnOlxuICAgICAgICAgICAgICBpZiAoIXJlc3BvbnNlKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFeGNlcHRpb24oXG4gICAgICAgICAgICAgICAgICAnUmVzcG9uc2UgbWVzc2FnZSByZXF1aXJlZCBmb3IgYWNjZXB0IGFjdGlvbicsXG4gICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICByZXN1bHQgPSBhd2FpdCB0aGlzLmFjY2VwdENsaWVudFJlcXVlc3QocmVxdWVzdElkLCB0aGVyYXBpc3RJZCwge1xuICAgICAgICAgICAgICAgIHJlc3BvbnNlLFxuICAgICAgICAgICAgICAgIGFjY2VwdE5ld0NsaWVudHM6IHRydWUsXG4gICAgICAgICAgICAgICAgcHJlZmVycmVkQ29udGFjdE1ldGhvZDogJ3BsYXRmb3JtJyxcbiAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgIGJyZWFrO1xuXG4gICAgICAgICAgICBjYXNlICdkZWNsaW5lJzpcbiAgICAgICAgICAgICAgaWYgKCFyZXNwb25zZSkge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0RXhjZXB0aW9uKFxuICAgICAgICAgICAgICAgICAgJ1Jlc3BvbnNlIG1lc3NhZ2UgcmVxdWlyZWQgZm9yIGRlY2xpbmUgYWN0aW9uJyxcbiAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIHJlc3VsdCA9IGF3YWl0IHRoaXMuZGVjbGluZUNsaWVudFJlcXVlc3QocmVxdWVzdElkLCB0aGVyYXBpc3RJZCwge1xuICAgICAgICAgICAgICAgIHJlc3BvbnNlLFxuICAgICAgICAgICAgICAgIGFjY2VwdE5ld0NsaWVudHM6IHRydWUsXG4gICAgICAgICAgICAgICAgcHJlZmVycmVkQ29udGFjdE1ldGhvZDogJ3BsYXRmb3JtJyxcbiAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgIGJyZWFrO1xuXG4gICAgICAgICAgICBjYXNlICdtYXJrX3Jldmlld2VkJzpcbiAgICAgICAgICAgICAgLy8gQ3VzdG9tIGFjdGlvbiB0byBtYXJrIGFzIHJldmlld2VkIHdpdGhvdXQgYWNjZXB0aW5nL2RlY2xpbmluZ1xuICAgICAgICAgICAgICByZXN1bHQgPSBhd2FpdCB0aGlzLm1hcmtSZXF1ZXN0QXNSZXZpZXdlZChyZXF1ZXN0SWQsIHRoZXJhcGlzdElkKTtcbiAgICAgICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0RXhjZXB0aW9uKGBJbnZhbGlkIGFjdGlvbjogJHthY3Rpb259YCk7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgcmVzdWx0cy5zdWNjZXNzZnVsLnB1c2goe1xuICAgICAgICAgICAgcmVxdWVzdElkLFxuICAgICAgICAgICAgYWN0aW9uLFxuICAgICAgICAgICAgc3RhdHVzOiAnY29tcGxldGVkJyxcbiAgICAgICAgICB9KTtcbiAgICAgICAgICByZXN1bHRzLnRvdGFsUHJvY2Vzc2VkKys7XG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgcmVzdWx0cy5mYWlsZWQucHVzaCh7XG4gICAgICAgICAgICByZXF1ZXN0SWQsXG4gICAgICAgICAgICBhY3Rpb24sXG4gICAgICAgICAgICBlcnJvcjogZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiAnVW5rbm93biBlcnJvcicsXG4gICAgICAgICAgfSk7XG4gICAgICAgICAgdGhpcy5sb2dnZXIud2FybihcbiAgICAgICAgICAgIGBGYWlsZWQgdG8gJHthY3Rpb259IHJlcXVlc3QgJHtyZXF1ZXN0SWR9OiAke2Vycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogJ1Vua25vd24gZXJyb3InfWAsXG4gICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICB0aGlzLmxvZ2dlci5sb2coXG4gICAgICAgIGBUaGVyYXBpc3QgJHt0aGVyYXBpc3RJZH0gcGVyZm9ybWVkIGJ1bGsgJHthY3Rpb259OiAke3Jlc3VsdHMudG90YWxQcm9jZXNzZWR9IHN1Y2Nlc3NmdWwsICR7cmVzdWx0cy5mYWlsZWQubGVuZ3RofSBmYWlsZWRgLFxuICAgICAgKTtcblxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgc3VjY2VzczogdHJ1ZSxcbiAgICAgICAgcmVzdWx0cyxcbiAgICAgICAgc3VtbWFyeToge1xuICAgICAgICAgIHRvdGFsUmVxdWVzdGVkOiByZXF1ZXN0SWRzLmxlbmd0aCxcbiAgICAgICAgICB0b3RhbFByb2Nlc3NlZDogcmVzdWx0cy50b3RhbFByb2Nlc3NlZCxcbiAgICAgICAgICB0b3RhbEZhaWxlZDogcmVzdWx0cy5mYWlsZWQubGVuZ3RoLFxuICAgICAgICAgIGFjdGlvbixcbiAgICAgICAgfSxcbiAgICAgIH07XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRoaXMubG9nZ2VyLmVycm9yKFxuICAgICAgICBgRmFpbGVkIHRvIHBlcmZvcm0gYnVsayBhY3Rpb24gZm9yIHRoZXJhcGlzdCAke3RoZXJhcGlzdElkfTpgLFxuICAgICAgICBlcnJvcixcbiAgICAgICk7XG4gICAgICB0aHJvdyBlcnJvcjtcbiAgICB9XG4gIH1cblxuICAvLyA9PT09PSBTVEFUSVNUSUNTIEFORCBBTkFMWVRJQ1MgPT09PT1cblxuICBhc3luYyBnZXRUaGVyYXBpc3RSZXF1ZXN0U3RhdGlzdGljcyh0aGVyYXBpc3RJZDogc3RyaW5nKSB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IFtcbiAgICAgICAgdG90YWxSZWNlaXZlZCxcbiAgICAgICAgcGVuZGluZyxcbiAgICAgICAgYWNjZXB0ZWQsXG4gICAgICAgIGRlY2xpbmVkLFxuICAgICAgICBleHBpcmVkLFxuICAgICAgICByZWNlbnRSZXF1ZXN0cyxcbiAgICAgICAgYWN0aXZlUmVsYXRpb25zaGlwcyxcbiAgICAgIF0gPSBhd2FpdCBQcm9taXNlLmFsbChbXG4gICAgICAgIC8vIFRvdGFsIHJlcXVlc3RzIHJlY2VpdmVkXG4gICAgICAgIHRoaXMucHJpc21hLmNsaWVudFRoZXJhcGlzdFJlcXVlc3QuY291bnQoe1xuICAgICAgICAgIHdoZXJlOiB7IHRoZXJhcGlzdElkIH0sXG4gICAgICAgIH0pLFxuICAgICAgICAvLyBQZW5kaW5nIHJlcXVlc3RzXG4gICAgICAgIHRoaXMucHJpc21hLmNsaWVudFRoZXJhcGlzdFJlcXVlc3QuY291bnQoe1xuICAgICAgICAgIHdoZXJlOiB7IHRoZXJhcGlzdElkLCBzdGF0dXM6ICdQRU5ESU5HJyB9LFxuICAgICAgICB9KSxcbiAgICAgICAgLy8gQWNjZXB0ZWQgcmVxdWVzdHNcbiAgICAgICAgdGhpcy5wcmlzbWEuY2xpZW50VGhlcmFwaXN0UmVxdWVzdC5jb3VudCh7XG4gICAgICAgICAgd2hlcmU6IHsgdGhlcmFwaXN0SWQsIHN0YXR1czogJ0FDQ0VQVEVEJyB9LFxuICAgICAgICB9KSxcbiAgICAgICAgLy8gRGVjbGluZWQgcmVxdWVzdHNcbiAgICAgICAgdGhpcy5wcmlzbWEuY2xpZW50VGhlcmFwaXN0UmVxdWVzdC5jb3VudCh7XG4gICAgICAgICAgd2hlcmU6IHsgdGhlcmFwaXN0SWQsIHN0YXR1czogJ0RFQ0xJTkVEJyB9LFxuICAgICAgICB9KSxcbiAgICAgICAgLy8gRXhwaXJlZCByZXF1ZXN0c1xuICAgICAgICB0aGlzLnByaXNtYS5jbGllbnRUaGVyYXBpc3RSZXF1ZXN0LmNvdW50KHtcbiAgICAgICAgICB3aGVyZTogeyB0aGVyYXBpc3RJZCwgc3RhdHVzOiAnRVhQSVJFRCcgfSxcbiAgICAgICAgfSksXG4gICAgICAgIC8vIFJlY2VudCByZXF1ZXN0cyBmb3IgcmVzcG9uc2UgdGltZSBjYWxjdWxhdGlvblxuICAgICAgICB0aGlzLnByaXNtYS5jbGllbnRUaGVyYXBpc3RSZXF1ZXN0LmZpbmRNYW55KHtcbiAgICAgICAgICB3aGVyZToge1xuICAgICAgICAgICAgdGhlcmFwaXN0SWQsXG4gICAgICAgICAgICByZXNwb25kZWRBdDogeyBub3Q6IG51bGwgfSxcbiAgICAgICAgICB9LFxuICAgICAgICAgIHNlbGVjdDoge1xuICAgICAgICAgICAgcmVxdWVzdGVkQXQ6IHRydWUsXG4gICAgICAgICAgICByZXNwb25kZWRBdDogdHJ1ZSxcbiAgICAgICAgICB9LFxuICAgICAgICAgIG9yZGVyQnk6IHsgcmVzcG9uZGVkQXQ6ICdkZXNjJyB9LFxuICAgICAgICAgIHRha2U6IDIwLFxuICAgICAgICB9KSxcbiAgICAgICAgLy8gQWN0aXZlIGNsaWVudCByZWxhdGlvbnNoaXBzXG4gICAgICAgIHRoaXMucHJpc21hLmNsaWVudFRoZXJhcGlzdC5jb3VudCh7XG4gICAgICAgICAgd2hlcmU6IHsgdGhlcmFwaXN0SWQsIHN0YXR1czogJ2FjdGl2ZScgfSxcbiAgICAgICAgfSksXG4gICAgICBdKTtcblxuICAgICAgLy8gQ2FsY3VsYXRlIGFjY2VwdGFuY2UgcmF0ZVxuICAgICAgY29uc3QgdG90YWxSZXNwb25kZWQgPSBhY2NlcHRlZCArIGRlY2xpbmVkO1xuICAgICAgY29uc3QgYWNjZXB0YW5jZVJhdGUgPVxuICAgICAgICB0b3RhbFJlc3BvbmRlZCA+IDAgPyAoYWNjZXB0ZWQgLyB0b3RhbFJlc3BvbmRlZCkgKiAxMDAgOiAwO1xuXG4gICAgICAvLyBDYWxjdWxhdGUgYXZlcmFnZSByZXNwb25zZSB0aW1lXG4gICAgICBjb25zdCByZXNwb25zZVRpbWVzID0gcmVjZW50UmVxdWVzdHNcbiAgICAgICAgLmZpbHRlcigocmVxKSA9PiByZXEucmVzcG9uZGVkQXQpXG4gICAgICAgIC5tYXAoKHJlcSkgPT4ge1xuICAgICAgICAgIGNvbnN0IHJlc3BvbnNlVGltZSA9XG4gICAgICAgICAgICByZXEucmVzcG9uZGVkQXQhLmdldFRpbWUoKSAtIHJlcS5yZXF1ZXN0ZWRBdC5nZXRUaW1lKCk7XG4gICAgICAgICAgcmV0dXJuIHJlc3BvbnNlVGltZSAvICgxMDAwICogNjAgKiA2MCk7IC8vIENvbnZlcnQgdG8gaG91cnNcbiAgICAgICAgfSk7XG5cbiAgICAgIGNvbnN0IGF2ZXJhZ2VSZXNwb25zZVRpbWUgPVxuICAgICAgICByZXNwb25zZVRpbWVzLmxlbmd0aCA+IDBcbiAgICAgICAgICA/IHJlc3BvbnNlVGltZXMucmVkdWNlKChzdW0sIHRpbWUpID0+IHN1bSArIHRpbWUsIDApIC9cbiAgICAgICAgICAgIHJlc3BvbnNlVGltZXMubGVuZ3RoXG4gICAgICAgICAgOiAwO1xuXG4gICAgICAvLyBHZXQgbGFzdCByZXF1ZXN0IGFuZCByZXNwb25zZSBkYXRlc1xuICAgICAgY29uc3QgbGFzdFJlcXVlc3QgPSBhd2FpdCB0aGlzLnByaXNtYS5jbGllbnRUaGVyYXBpc3RSZXF1ZXN0LmZpbmRGaXJzdCh7XG4gICAgICAgIHdoZXJlOiB7IHRoZXJhcGlzdElkIH0sXG4gICAgICAgIG9yZGVyQnk6IHsgcmVxdWVzdGVkQXQ6ICdkZXNjJyB9LFxuICAgICAgICBzZWxlY3Q6IHsgcmVxdWVzdGVkQXQ6IHRydWUgfSxcbiAgICAgIH0pO1xuXG4gICAgICBjb25zdCBsYXN0UmVzcG9uc2UgPSBhd2FpdCB0aGlzLnByaXNtYS5jbGllbnRUaGVyYXBpc3RSZXF1ZXN0LmZpbmRGaXJzdCh7XG4gICAgICAgIHdoZXJlOiB7IHRoZXJhcGlzdElkLCByZXNwb25kZWRBdDogeyBub3Q6IG51bGwgfSB9LFxuICAgICAgICBvcmRlckJ5OiB7IHJlc3BvbmRlZEF0OiAnZGVzYycgfSxcbiAgICAgICAgc2VsZWN0OiB7IHJlc3BvbmRlZEF0OiB0cnVlIH0sXG4gICAgICB9KTtcblxuICAgICAgdGhpcy5sb2dnZXIubG9nKFxuICAgICAgICBgR2VuZXJhdGVkIHJlcXVlc3Qgc3RhdGlzdGljcyBmb3IgdGhlcmFwaXN0ICR7dGhlcmFwaXN0SWR9YCxcbiAgICAgICk7XG5cbiAgICAgIHJldHVybiB7XG4gICAgICAgIHRvdGFsUmVjZWl2ZWQsXG4gICAgICAgIHBlbmRpbmcsXG4gICAgICAgIGFjY2VwdGVkLFxuICAgICAgICBkZWNsaW5lZCxcbiAgICAgICAgZXhwaXJlZCxcbiAgICAgICAgYWN0aXZlUmVsYXRpb25zaGlwcyxcbiAgICAgICAgYWNjZXB0YW5jZVJhdGU6IE1hdGgucm91bmQoYWNjZXB0YW5jZVJhdGUgKiAxMDApIC8gMTAwLFxuICAgICAgICBhdmVyYWdlUmVzcG9uc2VUaW1lOiBNYXRoLnJvdW5kKGF2ZXJhZ2VSZXNwb25zZVRpbWUgKiAxMDApIC8gMTAwLFxuICAgICAgICBsYXN0UmVxdWVzdEF0OiBsYXN0UmVxdWVzdD8ucmVxdWVzdGVkQXQgfHwgbnVsbCxcbiAgICAgICAgbGFzdFJlc3BvbnNlQXQ6IGxhc3RSZXNwb25zZT8ucmVzcG9uZGVkQXQgfHwgbnVsbCxcbiAgICAgIH07XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRoaXMubG9nZ2VyLmVycm9yKFxuICAgICAgICBgRmFpbGVkIHRvIGdlbmVyYXRlIHN0YXRpc3RpY3MgZm9yIHRoZXJhcGlzdCAke3RoZXJhcGlzdElkfTpgLFxuICAgICAgICBlcnJvcixcbiAgICAgICk7XG4gICAgICB0aHJvdyBlcnJvcjtcbiAgICB9XG4gIH1cblxuICAvLyA9PT09PSBVVElMSVRZIE1FVEhPRFMgPT09PT1cblxuICBwcml2YXRlIGFzeW5jIG1hcmtSZXF1ZXN0QXNSZXZpZXdlZChyZXF1ZXN0SWQ6IHN0cmluZywgdGhlcmFwaXN0SWQ6IHN0cmluZykge1xuICAgIC8vIEN1c3RvbSBtZXRob2QgZm9yIG1hcmtpbmcgcmVxdWVzdHMgYXMgcmV2aWV3ZWQgd2l0aG91dCBmb3JtYWwgcmVzcG9uc2VcbiAgICBjb25zdCByZXF1ZXN0ID0gYXdhaXQgdGhpcy5wcmlzbWEuY2xpZW50VGhlcmFwaXN0UmVxdWVzdC5maW5kVW5pcXVlKHtcbiAgICAgIHdoZXJlOiB7IGlkOiByZXF1ZXN0SWQgfSxcbiAgICB9KTtcblxuICAgIGlmICghcmVxdWVzdCB8fCByZXF1ZXN0LnRoZXJhcGlzdElkICE9PSB0aGVyYXBpc3RJZCkge1xuICAgICAgdGhyb3cgbmV3IE5vdEZvdW5kRXhjZXB0aW9uKFxuICAgICAgICBgUmVxdWVzdCAke3JlcXVlc3RJZH0gbm90IGZvdW5kIG9yIG5vdCBhY2Nlc3NpYmxlYCxcbiAgICAgICk7XG4gICAgfVxuXG4gICAgLy8gVGhpcyBjb3VsZCB1cGRhdGUgYSBjdXN0b20gXCJyZXZpZXdlZFwiIGZpZWxkIGlmIGl0IGV4aXN0ZWQgaW4gdGhlIHNjaGVtYVxuICAgIC8vIEZvciBub3csIHdlJ2xsIGp1c3QgbG9nIHRoZSByZXZpZXcgYWN0aW9uXG4gICAgYXdhaXQgdGhpcy5wcmlzbWEuYXVkaXRMb2cuY3JlYXRlKHtcbiAgICAgIGRhdGE6IHtcbiAgICAgICAgdXNlcklkOiB0aGVyYXBpc3RJZCxcbiAgICAgICAgYWN0aW9uOiAnUkVWSUVXX0NMSUVOVF9SRVFVRVNUJyxcbiAgICAgICAgZW50aXR5OiAnY2xpZW50X3RoZXJhcGlzdF9yZXF1ZXN0JyxcbiAgICAgICAgZW50aXR5SWQ6IHJlcXVlc3RJZCxcbiAgICAgICAgbWV0YWRhdGE6IHtcbiAgICAgICAgICByZXF1ZXN0SWQsXG4gICAgICAgICAgcmV2aWV3ZWRBdDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLFxuICAgICAgICB9LFxuICAgICAgfSxcbiAgICB9KTtcblxuICAgIHJldHVybiB7XG4gICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgcmVxdWVzdElkLFxuICAgICAgbWVzc2FnZTogJ1JlcXVlc3QgbWFya2VkIGFzIHJldmlld2VkJyxcbiAgICB9O1xuICB9XG59XG4iXSwidmVyc2lvbiI6M30=