{"version":3,"names":["cov_1hye0oz9p0","actualCoverage","common_1","s","require","crypto","MessageEncryptionService","MessageEncryptionService_1","logger","Logger","name","algorithm","keyLength","ivLength","tagLength","encryptionKeys","Map","constructor","f","initializeKeys","masterKeyHex","b","process","env","MESSAGE_ENCRYPTION_KEY","randomBytes","toString","set","Buffer","from","therapyKey","deriveKey","supportKey","log","masterKey","salt","pbkdf2Sync","encryptMessage","content","conversationType","key","get","iv","cipher","createCipheriv","encrypted","update","final","authTag","getAuthTag","result","encryptedContent","keyId","debug","length","error","Error","decryptMessage","encryptedMessage","decipher","createDecipheriv","setAuthTag","decrypted","decryptedAt","Date","getConversationType","conversationParticipants","hasTherapist","some","p","role","hasClient","hasModerator","rotateKeys","warn","validateMessageIntegrity","batchEncryptMessages","messages","results","message","push","isEncryptionAvailable","size","has","getEncryptionStatus","keyCount","availableKeyTypes","Array","keys","isConfigured","exports","__decorate","Injectable"],"sources":["/home/wetooa/Documents/code/projects/mentara/mentara-api/src/messaging/services/message-encryption.service.ts"],"sourcesContent":["import { Injectable, Logger } from '@nestjs/common';\nimport * as crypto from 'crypto';\n\nexport interface EncryptedMessage {\n  encryptedContent: string;\n  iv: string;\n  authTag: string;\n  keyId: string; // For key rotation\n}\n\nexport interface DecryptedMessage {\n  content: string;\n  decryptedAt: Date;\n}\n\n@Injectable()\nexport class MessageEncryptionService {\n  private readonly logger = new Logger(MessageEncryptionService.name);\n  private readonly algorithm = 'aes-256-gcm';\n  private readonly keyLength = 32; // 256 bits\n  private readonly ivLength = 16; // 128 bits\n  private readonly tagLength = 16; // 128 bits\n\n  // In production, these should be loaded from secure key management service\n  private readonly encryptionKeys = new Map<string, Buffer>();\n\n  constructor() {\n    this.initializeKeys();\n  }\n\n  /**\n   * Initialize encryption keys for different conversation types\n   * In production, integrate with AWS KMS, HashiCorp Vault, or similar\n   */\n  private initializeKeys() {\n    // Master key from environment (should be in secure key management)\n    const masterKeyHex =\n      process.env.MESSAGE_ENCRYPTION_KEY ||\n      crypto.randomBytes(this.keyLength).toString('hex');\n\n    // Derive keys for different conversation types\n    this.encryptionKeys.set('default', Buffer.from(masterKeyHex, 'hex'));\n\n    // Therapy conversations get their own key for extra security\n    const therapyKey = this.deriveKey(masterKeyHex, 'therapy-conversations');\n    this.encryptionKeys.set('therapy', therapyKey);\n\n    // Support conversations\n    const supportKey = this.deriveKey(masterKeyHex, 'support-conversations');\n    this.encryptionKeys.set('support', supportKey);\n\n    this.logger.log('Message encryption keys initialized');\n  }\n\n  /**\n   * Derive a key from master key using PBKDF2\n   */\n  private deriveKey(masterKey: string, salt: string): Buffer {\n    return crypto.pbkdf2Sync(masterKey, salt, 100000, this.keyLength, 'sha512');\n  }\n\n  /**\n   * Encrypt a message with AES-256-GCM\n   */\n  async encryptMessage(\n    content: string,\n    conversationType: 'therapy' | 'support' | 'default' = 'default',\n  ): Promise<EncryptedMessage> {\n    try {\n      const key =\n        this.encryptionKeys.get(conversationType) ||\n        this.encryptionKeys.get('default')!;\n\n      // Generate random IV for each message\n      const iv = crypto.randomBytes(this.ivLength);\n\n      // Create cipher\n      const cipher = crypto.createCipheriv(this.algorithm, key, iv);\n\n      // Encrypt the content\n      let encrypted = cipher.update(content, 'utf8', 'hex');\n      encrypted += cipher.final('hex');\n\n      // Get authentication tag\n      const authTag = cipher.getAuthTag();\n\n      const result: EncryptedMessage = {\n        encryptedContent: encrypted,\n        iv: iv.toString('hex'),\n        authTag: authTag.toString('hex'),\n        keyId: conversationType,\n      };\n\n      this.logger.debug(\n        `Message encrypted with ${conversationType} key (length: ${content.length} chars)`,\n      );\n\n      return result;\n    } catch (error) {\n      this.logger.error('Message encryption failed:', error);\n      throw new Error('Failed to encrypt message');\n    }\n  }\n\n  /**\n   * Decrypt a message with AES-256-GCM\n   */\n  async decryptMessage(\n    encryptedMessage: EncryptedMessage,\n  ): Promise<DecryptedMessage> {\n    try {\n      const { encryptedContent, iv, authTag, keyId } = encryptedMessage;\n\n      const key =\n        this.encryptionKeys.get(keyId) || this.encryptionKeys.get('default')!;\n\n      // Create decipher\n      const decipher = crypto.createDecipheriv(\n        this.algorithm,\n        key,\n        Buffer.from(iv, 'hex'),\n      );\n\n      // Set auth tag\n      decipher.setAuthTag(Buffer.from(authTag, 'hex'));\n\n      // Decrypt the content\n      let decrypted = decipher.update(encryptedContent, 'hex', 'utf8');\n      decrypted += decipher.final('utf8');\n\n      this.logger.debug(\n        `Message decrypted with ${keyId} key (length: ${decrypted.length} chars)`,\n      );\n\n      return {\n        content: decrypted,\n        decryptedAt: new Date(),\n      };\n    } catch (error) {\n      this.logger.error('Message decryption failed:', error);\n      throw new Error('Failed to decrypt message - content may be corrupted');\n    }\n  }\n\n  /**\n   * Determine conversation type for encryption key selection\n   */\n  getConversationType(\n    conversationParticipants: { role: string }[],\n  ): 'therapy' | 'support' | 'default' {\n    const hasTherapist = conversationParticipants.some(\n      (p) => p.role === 'therapist',\n    );\n    const hasClient = conversationParticipants.some((p) => p.role === 'client');\n    const hasModerator = conversationParticipants.some(\n      (p) => p.role === 'moderator',\n    );\n\n    if (hasTherapist && hasClient) {\n      return 'therapy'; // Therapeutic conversations need highest security\n    }\n\n    if (hasModerator) {\n      return 'support'; // Support conversations\n    }\n\n    return 'default'; // Regular user conversations\n  }\n\n  /**\n   * Rotate encryption keys (for security maintenance)\n   */\n  async rotateKeys(): Promise<void> {\n    this.logger.warn(\n      'Key rotation not implemented - should integrate with secure key management service',\n    );\n    // TODO: Implement key rotation with proper key management service\n    // 1. Generate new keys\n    // 2. Re-encrypt recent messages with new keys\n    // 3. Update key references\n    // 4. Schedule old key cleanup\n  }\n\n  /**\n   * Validate encrypted message integrity\n   */\n  async validateMessageIntegrity(\n    encryptedMessage: EncryptedMessage,\n  ): Promise<boolean> {\n    try {\n      await this.decryptMessage(encryptedMessage);\n      return true;\n    } catch (error) {\n      this.logger.warn('Message integrity validation failed:', error);\n      return false;\n    }\n  }\n\n  /**\n   * Batch encrypt multiple messages (for migration or bulk operations)\n   */\n  async batchEncryptMessages(\n    messages: {\n      content: string;\n      conversationType?: 'therapy' | 'support' | 'default';\n    }[],\n  ): Promise<EncryptedMessage[]> {\n    const results: EncryptedMessage[] = [];\n\n    for (const message of messages) {\n      try {\n        const encrypted = await this.encryptMessage(\n          message.content,\n          message.conversationType || 'default',\n        );\n        results.push(encrypted);\n      } catch (error) {\n        this.logger.error('Batch encryption failed for message:', error);\n        // Continue with other messages, don't fail the entire batch\n        results.push({\n          encryptedContent: '',\n          iv: '',\n          authTag: '',\n          keyId: 'failed',\n        });\n      }\n    }\n\n    this.logger.log(`Batch encrypted ${results.length} messages`);\n    return results;\n  }\n\n  /**\n   * Check if encryption is properly configured\n   */\n  isEncryptionAvailable(): boolean {\n    return this.encryptionKeys.size > 0 && this.encryptionKeys.has('default');\n  }\n\n  /**\n   * Get encryption status for monitoring\n   */\n  getEncryptionStatus() {\n    return {\n      algorithm: this.algorithm,\n      keyCount: this.encryptionKeys.size,\n      availableKeyTypes: Array.from(this.encryptionKeys.keys()),\n      isConfigured: this.isEncryptionAvailable(),\n    };\n  }\n}\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;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","ignoreList":[]}