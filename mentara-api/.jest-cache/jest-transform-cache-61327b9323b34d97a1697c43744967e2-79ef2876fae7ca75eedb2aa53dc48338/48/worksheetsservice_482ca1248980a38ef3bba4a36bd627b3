beaf61b0d09600b9e88166c3325a2149
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
exports.WorksheetsService = void 0;
const common_1 = require("@nestjs/common");
const prisma_client_provider_1 = require("src/providers/prisma-client.provider");
let WorksheetsService = class WorksheetsService {
    prisma;
    constructor(prisma) {
        this.prisma = prisma;
    }
    async findAll(userId, therapistId, status) {
        const where = {};
        if (userId) {
            where['clientId'] = userId; // Use clientId for proper relation
        }
        if (therapistId) {
            where['therapistId'] = therapistId;
        }
        if (status) {
            where['status'] = status;
        }
        const worksheets = await this.prisma.worksheet.findMany({
            where,
            include: {
                client: {
                    include: {
                        user: {
                            select: {
                                id: true,
                                firstName: true,
                                lastName: true,
                                avatarUrl: true,
                            },
                        },
                    },
                },
                therapist: {
                    include: {
                        user: {
                            select: {
                                id: true,
                                firstName: true,
                                lastName: true,
                                avatarUrl: true,
                            },
                        },
                    },
                },
            },
            orderBy: {
                createdAt: 'desc',
            },
        });
        return worksheets;
    }
    async findById(id) {
        const worksheet = await this.prisma.worksheet.findUnique({
            where: { id },
            include: {
                client: {
                    include: {
                        user: {
                            select: {
                                id: true,
                                firstName: true,
                                lastName: true,
                                avatarUrl: true,
                            },
                        },
                    },
                },
                therapist: {
                    include: {
                        user: {
                            select: {
                                id: true,
                                firstName: true,
                                lastName: true,
                                avatarUrl: true,
                            },
                        },
                    },
                },
            },
        });
        if (!worksheet) {
            throw new common_1.NotFoundException(`Worksheet with ID ${id} not found`);
        }
        // Transform the inline arrays into the expected format for backward compatibility
        return {
            ...worksheet,
            materials: worksheet.materialUrls.map((url, index) => ({
                id: `material-${index}`,
                filename: worksheet.materialNames[index] || 'Unknown',
                url,
                fileType: 'application/octet-stream',
                fileSize: worksheet.materialSizes[index] || 0,
            })),
            submissions: worksheet.submissionUrls.map((url, index) => ({
                id: `submission-${index}`,
                filename: worksheet.submissionNames[index] || 'Unknown',
                url,
                fileType: 'application/octet-stream',
                fileSize: worksheet.submissionSizes[index] || 0,
                submittedAt: worksheet.submittedAt,
            })),
        };
    }
    async create(data, clientId, therapistId, files = []) {
        // Create the worksheet
        const worksheet = await this.prisma.worksheet.create({
            data: {
                title: data.title,
                instructions: data.instructions,
                description: data.description,
                dueDate: data.dueDate || new Date(),
                status: data.status || 'assigned',
                isCompleted: data.isCompleted || false,
                clientId,
                therapistId,
                // Files are now handled separately via upload endpoint
                // These arrays will be populated when files are uploaded
                materialUrls: [],
                materialNames: [],
                materialSizes: [],
                submissionUrls: [],
                submissionNames: [],
                submissionSizes: [],
            },
        });
        // Return the newly created worksheet
        return this.findById(worksheet.id);
    }
    async update(id, data) {
        // Check if worksheet exists
        const exists = await this.prisma.worksheet.findUnique({
            where: { id },
        });
        if (!exists) {
            throw new common_1.NotFoundException(`Worksheet with ID ${id} not found`);
        }
        // Update the worksheet
        await this.prisma.worksheet.update({
            where: { id },
            data,
        });
        // Return the updated worksheet
        return this.findById(id);
    }
    async delete(id) {
        // Check if worksheet exists
        const exists = await this.prisma.worksheet.findUnique({
            where: { id },
        });
        if (!exists) {
            throw new common_1.NotFoundException(`Worksheet with ID ${id} not found`);
        }
        // Delete the worksheet (files in Supabase Storage should be cleaned up separately if needed)
        await this.prisma.worksheet.delete({
            where: { id },
        });
        return { success: true, message: 'Worksheet deleted successfully' };
    }
    async addSubmission(data, clientId) {
        // Check if worksheet exists
        const worksheet = await this.prisma.worksheet.findUnique({
            where: { id: data.worksheetId },
            include: { client: true },
        });
        if (!worksheet) {
            throw new common_1.NotFoundException(`Worksheet with ID ${data.worksheetId} not found`);
        }
        // Note: File uploads are now handled separately via the upload endpoint
        // This method now primarily handles text-based submissions
        // The worksheet has already been updated with file attachments if any
        // Update the worksheet with submission data
        const updatedWorksheet = await this.prisma.worksheet.update({
            where: { id: data.worksheetId },
            data: {
                // Store text-based responses or notes
                feedback: data.notes || null,
                // Mark as completed if specified
                isCompleted: data.isCompleted || false,
                status: data.isCompleted ? 'completed' : 'assigned',
                submittedAt: data.isCompleted ? new Date() : null,
            },
        });
        return {
            id: updatedWorksheet.id,
            worksheetId: data.worksheetId,
            clientId,
            status: updatedWorksheet.status,
            submittedAt: updatedWorksheet.submittedAt,
        };
    }
    async submitWorksheet(id, data, clientId) {
        // Check if worksheet exists
        const worksheet = await this.prisma.worksheet.findUnique({
            where: { id },
        });
        if (!worksheet) {
            throw new common_1.NotFoundException(`Worksheet with ID ${id} not found`);
        }
        // Update worksheet with submission data and mark as completed
        const updatedWorksheet = await this.prisma.worksheet.update({
            where: { id },
            data: {
                feedback: data.notes || null,
                isCompleted: true,
                status: 'completed',
                submittedAt: new Date(),
                // File attachments are handled separately via upload endpoint
            },
        });
        return {
            worksheetId: id,
            submissionId: id, // Use worksheet ID as submission ID since they're now unified
            status: updatedWorksheet.status,
            submittedAt: updatedWorksheet.submittedAt,
            message: 'Worksheet submitted successfully',
        };
    }
    async deleteSubmission(id) {
        // Since submissions are now inline, we reset the worksheet submission status
        const worksheet = await this.prisma.worksheet.findUnique({
            where: { id },
        });
        if (!worksheet) {
            throw new common_1.NotFoundException(`Worksheet with ID ${id} not found`);
        }
        // Reset submission status
        await this.prisma.worksheet.update({
            where: { id },
            data: {
                isCompleted: false,
                status: 'assigned',
                submittedAt: null,
                feedback: null,
                // Clear submission files but keep materials
                submissionUrls: [],
                submissionNames: [],
                submissionSizes: [],
            },
        });
        return { success: true, message: 'Submission reset successfully' };
    }
};
exports.WorksheetsService = WorksheetsService;
exports.WorksheetsService = WorksheetsService = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [typeof (_a = typeof prisma_client_provider_1.PrismaService !== "undefined" && prisma_client_provider_1.PrismaService) === "function" ? _a : Object])
], WorksheetsService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL3dvcmtzaGVldHMvd29ya3NoZWV0cy5zZXJ2aWNlLnRzIiwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7QUFBQSwyQ0FBK0Q7QUFDL0QsaUZBQXFFO0FBUTlELElBQU0saUJBQWlCLEdBQXZCLE1BQU0saUJBQWlCO0lBQ0M7SUFBN0IsWUFBNkIsTUFBcUI7UUFBckIsV0FBTSxHQUFOLE1BQU0sQ0FBZTtJQUFHLENBQUM7SUFFdEQsS0FBSyxDQUFDLE9BQU8sQ0FDWCxNQUFlLEVBQ2YsV0FBb0IsRUFDcEIsTUFBZTtRQUVmLE1BQU0sS0FBSyxHQUFHLEVBQUUsQ0FBQztRQUVqQixJQUFJLE1BQU0sRUFBRSxDQUFDO1lBQ1gsS0FBSyxDQUFDLFVBQVUsQ0FBQyxHQUFHLE1BQU0sQ0FBQyxDQUFDLG1DQUFtQztRQUNqRSxDQUFDO1FBRUQsSUFBSSxXQUFXLEVBQUUsQ0FBQztZQUNoQixLQUFLLENBQUMsYUFBYSxDQUFDLEdBQUcsV0FBVyxDQUFDO1FBQ3JDLENBQUM7UUFFRCxJQUFJLE1BQU0sRUFBRSxDQUFDO1lBQ1gsS0FBSyxDQUFDLFFBQVEsQ0FBQyxHQUFHLE1BQU0sQ0FBQztRQUMzQixDQUFDO1FBRUQsTUFBTSxVQUFVLEdBQUcsTUFBTSxJQUFJLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxRQUFRLENBQUM7WUFDdEQsS0FBSztZQUNMLE9BQU8sRUFBRTtnQkFDUCxNQUFNLEVBQUU7b0JBQ04sT0FBTyxFQUFFO3dCQUNQLElBQUksRUFBRTs0QkFDSixNQUFNLEVBQUU7Z0NBQ04sRUFBRSxFQUFFLElBQUk7Z0NBQ1IsU0FBUyxFQUFFLElBQUk7Z0NBQ2YsUUFBUSxFQUFFLElBQUk7Z0NBQ2QsU0FBUyxFQUFFLElBQUk7NkJBQ2hCO3lCQUNGO3FCQUNGO2lCQUNGO2dCQUNELFNBQVMsRUFBRTtvQkFDVCxPQUFPLEVBQUU7d0JBQ1AsSUFBSSxFQUFFOzRCQUNKLE1BQU0sRUFB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R0FBRTt5REFFMEIsc0NBQWEsb0JBQWIsc0NBQWE7R0FEdkMsaUJBQWlCLENBZ1M3QiIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvaG9tZS93ZXRvb2EvRG9jdW1lbnRzL2NvZGUvcHJvamVjdHMvbWVudGFyYS9tZW50YXJhLWFwaS9zcmMvd29ya3NoZWV0cy93b3Jrc2hlZXRzLnNlcnZpY2UudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSwgTm90Rm91bmRFeGNlcHRpb24gfSBmcm9tICdAbmVzdGpzL2NvbW1vbic7XG5pbXBvcnQgeyBQcmlzbWFTZXJ2aWNlIH0gZnJvbSAnc3JjL3Byb3ZpZGVycy9wcmlzbWEtY2xpZW50LnByb3ZpZGVyJztcbmltcG9ydCB7XG4gIFdvcmtzaGVldENyZWF0ZUlucHV0RHRvLFxuICBXb3Jrc2hlZXRTdWJtaXNzaW9uQ3JlYXRlSW5wdXREdG8sXG4gIFdvcmtzaGVldFVwZGF0ZUlucHV0RHRvLFxufSBmcm9tICdtZW50YXJhLWNvbW1vbnMnO1xuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgV29ya3NoZWV0c1NlcnZpY2Uge1xuICBjb25zdHJ1Y3Rvcihwcml2YXRlIHJlYWRvbmx5IHByaXNtYTogUHJpc21hU2VydmljZSkge31cblxuICBhc3luYyBmaW5kQWxsKFxuICAgIHVzZXJJZD86IHN0cmluZyxcbiAgICB0aGVyYXBpc3RJZD86IHN0cmluZyxcbiAgICBzdGF0dXM/OiBzdHJpbmcsXG4gICk6IFByb21pc2U8YW55W10+IHtcbiAgICBjb25zdCB3aGVyZSA9IHt9O1xuXG4gICAgaWYgKHVzZXJJZCkge1xuICAgICAgd2hlcmVbJ2NsaWVudElkJ10gPSB1c2VySWQ7IC8vIFVzZSBjbGllbnRJZCBmb3IgcHJvcGVyIHJlbGF0aW9uXG4gICAgfVxuXG4gICAgaWYgKHRoZXJhcGlzdElkKSB7XG4gICAgICB3aGVyZVsndGhlcmFwaXN0SWQnXSA9IHRoZXJhcGlzdElkO1xuICAgIH1cblxuICAgIGlmIChzdGF0dXMpIHtcbiAgICAgIHdoZXJlWydzdGF0dXMnXSA9IHN0YXR1cztcbiAgICB9XG5cbiAgICBjb25zdCB3b3Jrc2hlZXRzID0gYXdhaXQgdGhpcy5wcmlzbWEud29ya3NoZWV0LmZpbmRNYW55KHtcbiAgICAgIHdoZXJlLFxuICAgICAgaW5jbHVkZToge1xuICAgICAgICBjbGllbnQ6IHtcbiAgICAgICAgICBpbmNsdWRlOiB7XG4gICAgICAgICAgICB1c2VyOiB7XG4gICAgICAgICAgICAgIHNlbGVjdDoge1xuICAgICAgICAgICAgICAgIGlkOiB0cnVlLFxuICAgICAgICAgICAgICAgIGZpcnN0TmFtZTogdHJ1ZSxcbiAgICAgICAgICAgICAgICBsYXN0TmFtZTogdHJ1ZSxcbiAgICAgICAgICAgICAgICBhdmF0YXJVcmw6IHRydWUsXG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICAgIHRoZXJhcGlzdDoge1xuICAgICAgICAgIGluY2x1ZGU6IHtcbiAgICAgICAgICAgIHVzZXI6IHtcbiAgICAgICAgICAgICAgc2VsZWN0OiB7XG4gICAgICAgICAgICAgICAgaWQ6IHRydWUsXG4gICAgICAgICAgICAgICAgZmlyc3ROYW1lOiB0cnVlLFxuICAgICAgICAgICAgICAgIGxhc3ROYW1lOiB0cnVlLFxuICAgICAgICAgICAgICAgIGF2YXRhclVybDogdHJ1ZSxcbiAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgIH0sXG4gICAgICBvcmRlckJ5OiB7XG4gICAgICAgIGNyZWF0ZWRBdDogJ2Rlc2MnLFxuICAgICAgfSxcbiAgICB9KTtcblxuICAgIHJldHVybiB3b3Jrc2hlZXRzO1xuICB9XG5cbiAgYXN5bmMgZmluZEJ5SWQoaWQ6IHN0cmluZykge1xuICAgIGNvbnN0IHdvcmtzaGVldCA9IGF3YWl0IHRoaXMucHJpc21hLndvcmtzaGVldC5maW5kVW5pcXVlKHtcbiAgICAgIHdoZXJlOiB7IGlkIH0sXG4gICAgICBpbmNsdWRlOiB7XG4gICAgICAgIGNsaWVudDoge1xuICAgICAgICAgIGluY2x1ZGU6IHtcbiAgICAgICAgICAgIHVzZXI6IHtcbiAgICAgICAgICAgICAgc2VsZWN0OiB7XG4gICAgICAgICAgICAgICAgaWQ6IHRydWUsXG4gICAgICAgICAgICAgICAgZmlyc3ROYW1lOiB0cnVlLFxuICAgICAgICAgICAgICAgIGxhc3ROYW1lOiB0cnVlLFxuICAgICAgICAgICAgICAgIGF2YXRhclVybDogdHJ1ZSxcbiAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgICAgdGhlcmFwaXN0OiB7XG4gICAgICAgICAgaW5jbHVkZToge1xuICAgICAgICAgICAgdXNlcjoge1xuICAgICAgICAgICAgICBzZWxlY3Q6IHtcbiAgICAgICAgICAgICAgICBpZDogdHJ1ZSxcbiAgICAgICAgICAgICAgICBmaXJzdE5hbWU6IHRydWUsXG4gICAgICAgICAgICAgICAgbGFzdE5hbWU6IHRydWUsXG4gICAgICAgICAgICAgICAgYXZhdGFyVXJsOiB0cnVlLFxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgfSxcbiAgICB9KTtcblxuICAgIGlmICghd29ya3NoZWV0KSB7XG4gICAgICB0aHJvdyBuZXcgTm90Rm91bmRFeGNlcHRpb24oYFdvcmtzaGVldCB3aXRoIElEICR7aWR9IG5vdCBmb3VuZGApO1xuICAgIH1cblxuICAgIC8vIFRyYW5zZm9ybSB0aGUgaW5saW5lIGFycmF5cyBpbnRvIHRoZSBleHBlY3RlZCBmb3JtYXQgZm9yIGJhY2t3YXJkIGNvbXBhdGliaWxpdHlcbiAgICByZXR1cm4ge1xuICAgICAgLi4ud29ya3NoZWV0LFxuICAgICAgbWF0ZXJpYWxzOiB3b3Jrc2hlZXQubWF0ZXJpYWxVcmxzLm1hcCgodXJsLCBpbmRleCkgPT4gKHtcbiAgICAgICAgaWQ6IGBtYXRlcmlhbC0ke2luZGV4fWAsXG4gICAgICAgIGZpbGVuYW1lOiB3b3Jrc2hlZXQubWF0ZXJpYWxOYW1lc1tpbmRleF0gfHwgJ1Vua25vd24nLFxuICAgICAgICB1cmwsXG4gICAgICAgIGZpbGVUeXBlOiAnYXBwbGljYXRpb24vb2N0ZXQtc3RyZWFtJyxcbiAgICAgICAgZmlsZVNpemU6IHdvcmtzaGVldC5tYXRlcmlhbFNpemVzW2luZGV4XSB8fCAwLFxuICAgICAgfSkpLFxuICAgICAgc3VibWlzc2lvbnM6IHdvcmtzaGVldC5zdWJtaXNzaW9uVXJscy5tYXAoKHVybCwgaW5kZXgpID0+ICh7XG4gICAgICAgIGlkOiBgc3VibWlzc2lvbi0ke2luZGV4fWAsXG4gICAgICAgIGZpbGVuYW1lOiB3b3Jrc2hlZXQuc3VibWlzc2lvbk5hbWVzW2luZGV4XSB8fCAnVW5rbm93bicsXG4gICAgICAgIHVybCxcbiAgICAgICAgZmlsZVR5cGU6ICdhcHBsaWNhdGlvbi9vY3RldC1zdHJlYW0nLFxuICAgICAgICBmaWxlU2l6ZTogd29ya3NoZWV0LnN1Ym1pc3Npb25TaXplc1tpbmRleF0gfHwgMCxcbiAgICAgICAgc3VibWl0dGVkQXQ6IHdvcmtzaGVldC5zdWJtaXR0ZWRBdCxcbiAgICAgIH0pKSxcbiAgICB9O1xuICB9XG5cbiAgYXN5bmMgY3JlYXRlKFxuICAgIGRhdGE6IFdvcmtzaGVldENyZWF0ZUlucHV0RHRvLFxuICAgIGNsaWVudElkOiBzdHJpbmcsXG4gICAgdGhlcmFwaXN0SWQ6IHN0cmluZyxcbiAgICBmaWxlczogRXhwcmVzcy5NdWx0ZXIuRmlsZVtdID0gW10sXG4gICkge1xuICAgIC8vIENyZWF0ZSB0aGUgd29ya3NoZWV0XG4gICAgY29uc3Qgd29ya3NoZWV0ID0gYXdhaXQgdGhpcy5wcmlzbWEud29ya3NoZWV0LmNyZWF0ZSh7XG4gICAgICBkYXRhOiB7XG4gICAgICAgIHRpdGxlOiBkYXRhLnRpdGxlLFxuICAgICAgICBpbnN0cnVjdGlvbnM6IGRhdGEuaW5zdHJ1Y3Rpb25zLFxuICAgICAgICBkZXNjcmlwdGlvbjogZGF0YS5kZXNjcmlwdGlvbixcbiAgICAgICAgZHVlRGF0ZTogZGF0YS5kdWVEYXRlIHx8IG5ldyBEYXRlKCksXG4gICAgICAgIHN0YXR1czogKGRhdGEgYXMgYW55KS5zdGF0dXMgfHwgJ2Fzc2lnbmVkJyxcbiAgICAgICAgaXNDb21wbGV0ZWQ6IChkYXRhIGFzIGFueSkuaXNDb21wbGV0ZWQgfHwgZmFsc2UsXG4gICAgICAgIGNsaWVudElkLFxuICAgICAgICB0aGVyYXBpc3RJZCxcbiAgICAgICAgLy8gRmlsZXMgYXJlIG5vdyBoYW5kbGVkIHNlcGFyYXRlbHkgdmlhIHVwbG9hZCBlbmRwb2ludFxuICAgICAgICAvLyBUaGVzZSBhcnJheXMgd2lsbCBiZSBwb3B1bGF0ZWQgd2hlbiBmaWxlcyBhcmUgdXBsb2FkZWRcbiAgICAgICAgbWF0ZXJpYWxVcmxzOiBbXSxcbiAgICAgICAgbWF0ZXJpYWxOYW1lczogW10sXG4gICAgICAgIG1hdGVyaWFsU2l6ZXM6IFtdLFxuICAgICAgICBzdWJtaXNzaW9uVXJsczogW10sXG4gICAgICAgIHN1Ym1pc3Npb25OYW1lczogW10sXG4gICAgICAgIHN1Ym1pc3Npb25TaXplczogW10sXG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgLy8gUmV0dXJuIHRoZSBuZXdseSBjcmVhdGVkIHdvcmtzaGVldFxuICAgIHJldHVybiB0aGlzLmZpbmRCeUlkKHdvcmtzaGVldC5pZCk7XG4gIH1cblxuICBhc3luYyB1cGRhdGUoaWQ6IHN0cmluZywgZGF0YTogV29ya3NoZWV0VXBkYXRlSW5wdXREdG8pIHtcbiAgICAvLyBDaGVjayBpZiB3b3Jrc2hlZXQgZXhpc3RzXG4gICAgY29uc3QgZXhpc3RzID0gYXdhaXQgdGhpcy5wcmlzbWEud29ya3NoZWV0LmZpbmRVbmlxdWUoe1xuICAgICAgd2hlcmU6IHsgaWQgfSxcbiAgICB9KTtcblxuICAgIGlmICghZXhpc3RzKSB7XG4gICAgICB0aHJvdyBuZXcgTm90Rm91bmRFeGNlcHRpb24oYFdvcmtzaGVldCB3aXRoIElEICR7aWR9IG5vdCBmb3VuZGApO1xuICAgIH1cblxuICAgIC8vIFVwZGF0ZSB0aGUgd29ya3NoZWV0XG4gICAgYXdhaXQgdGhpcy5wcmlzbWEud29ya3NoZWV0LnVwZGF0ZSh7XG4gICAgICB3aGVyZTogeyBpZCB9LFxuICAgICAgZGF0YSxcbiAgICB9KTtcblxuICAgIC8vIFJldHVybiB0aGUgdXBkYXRlZCB3b3Jrc2hlZXRcbiAgICByZXR1cm4gdGhpcy5maW5kQnlJZChpZCk7XG4gIH1cblxuICBhc3luYyBkZWxldGUoaWQ6IHN0cmluZykge1xuICAgIC8vIENoZWNrIGlmIHdvcmtzaGVldCBleGlzdHNcbiAgICBjb25zdCBleGlzdHMgPSBhd2FpdCB0aGlzLnByaXNtYS53b3Jrc2hlZXQuZmluZFVuaXF1ZSh7XG4gICAgICB3aGVyZTogeyBpZCB9LFxuICAgIH0pO1xuXG4gICAgaWYgKCFleGlzdHMpIHtcbiAgICAgIHRocm93IG5ldyBOb3RGb3VuZEV4Y2VwdGlvbihgV29ya3NoZWV0IHdpdGggSUQgJHtpZH0gbm90IGZvdW5kYCk7XG4gICAgfVxuXG4gICAgLy8gRGVsZXRlIHRoZSB3b3Jrc2hlZXQgKGZpbGVzIGluIFN1cGFiYXNlIFN0b3JhZ2Ugc2hvdWxkIGJlIGNsZWFuZWQgdXAgc2VwYXJhdGVseSBpZiBuZWVkZWQpXG4gICAgYXdhaXQgdGhpcy5wcmlzbWEud29ya3NoZWV0LmRlbGV0ZSh7XG4gICAgICB3aGVyZTogeyBpZCB9LFxuICAgIH0pO1xuXG4gICAgcmV0dXJuIHsgc3VjY2VzczogdHJ1ZSwgbWVzc2FnZTogJ1dvcmtzaGVldCBkZWxldGVkIHN1Y2Nlc3NmdWxseScgfTtcbiAgfVxuXG4gIGFzeW5jIGFkZFN1Ym1pc3Npb24oXG4gICAgZGF0YTogV29ya3NoZWV0U3VibWlzc2lvbkNyZWF0ZUlucHV0RHRvLFxuICAgIGNsaWVudElkOiBzdHJpbmcsXG4gICkge1xuICAgIC8vIENoZWNrIGlmIHdvcmtzaGVldCBleGlzdHNcbiAgICBjb25zdCB3b3Jrc2hlZXQgPSBhd2FpdCB0aGlzLnByaXNtYS53b3Jrc2hlZXQuZmluZFVuaXF1ZSh7XG4gICAgICB3aGVyZTogeyBpZDogZGF0YS53b3Jrc2hlZXRJZCB9LFxuICAgICAgaW5jbHVkZTogeyBjbGllbnQ6IHRydWUgfSxcbiAgICB9KTtcblxuICAgIGlmICghd29ya3NoZWV0KSB7XG4gICAgICB0aHJvdyBuZXcgTm90Rm91bmRFeGNlcHRpb24oXG4gICAgICAgIGBXb3Jrc2hlZXQgd2l0aCBJRCAke2RhdGEud29ya3NoZWV0SWR9IG5vdCBmb3VuZGAsXG4gICAgICApO1xuICAgIH1cblxuICAgIC8vIE5vdGU6IEZpbGUgdXBsb2FkcyBhcmUgbm93IGhhbmRsZWQgc2VwYXJhdGVseSB2aWEgdGhlIHVwbG9hZCBlbmRwb2ludFxuICAgIC8vIFRoaXMgbWV0aG9kIG5vdyBwcmltYXJpbHkgaGFuZGxlcyB0ZXh0LWJhc2VkIHN1Ym1pc3Npb25zXG4gICAgLy8gVGhlIHdvcmtzaGVldCBoYXMgYWxyZWFkeSBiZWVuIHVwZGF0ZWQgd2l0aCBmaWxlIGF0dGFjaG1lbnRzIGlmIGFueVxuXG4gICAgLy8gVXBkYXRlIHRoZSB3b3Jrc2hlZXQgd2l0aCBzdWJtaXNzaW9uIGRhdGFcbiAgICBjb25zdCB1cGRhdGVkV29ya3NoZWV0ID0gYXdhaXQgdGhpcy5wcmlzbWEud29ya3NoZWV0LnVwZGF0ZSh7XG4gICAgICB3aGVyZTogeyBpZDogZGF0YS53b3Jrc2hlZXRJZCB9LFxuICAgICAgZGF0YToge1xuICAgICAgICAvLyBTdG9yZSB0ZXh0LWJhc2VkIHJlc3BvbnNlcyBvciBub3Rlc1xuICAgICAgICBmZWVkYmFjazogKGRhdGEgYXMgYW55KS5ub3RlcyB8fCBudWxsLFxuICAgICAgICAvLyBNYXJrIGFzIGNvbXBsZXRlZCBpZiBzcGVjaWZpZWRcbiAgICAgICAgaXNDb21wbGV0ZWQ6IGRhdGEuaXNDb21wbGV0ZWQgfHwgZmFsc2UsXG4gICAgICAgIHN0YXR1czogZGF0YS5pc0NvbXBsZXRlZCA/ICdjb21wbGV0ZWQnIDogJ2Fzc2lnbmVkJyxcbiAgICAgICAgc3VibWl0dGVkQXQ6IGRhdGEuaXNDb21wbGV0ZWQgPyBuZXcgRGF0ZSgpIDogbnVsbCxcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICByZXR1cm4ge1xuICAgICAgaWQ6IHVwZGF0ZWRXb3Jrc2hlZXQuaWQsXG4gICAgICB3b3Jrc2hlZXRJZDogZGF0YS53b3Jrc2hlZXRJZCxcbiAgICAgIGNsaWVudElkLFxuICAgICAgc3RhdHVzOiB1cGRhdGVkV29ya3NoZWV0LnN0YXR1cyxcbiAgICAgIHN1Ym1pdHRlZEF0OiB1cGRhdGVkV29ya3NoZWV0LnN1Ym1pdHRlZEF0LFxuICAgIH07XG4gIH1cblxuICBhc3luYyBzdWJtaXRXb3Jrc2hlZXQoXG4gICAgaWQ6IHN0cmluZyxcbiAgICBkYXRhOiBXb3Jrc2hlZXRTdWJtaXNzaW9uQ3JlYXRlSW5wdXREdG8sXG4gICAgY2xpZW50SWQ6IHN0cmluZyxcbiAgKSB7XG4gICAgLy8gQ2hlY2sgaWYgd29ya3NoZWV0IGV4aXN0c1xuICAgIGNvbnN0IHdvcmtzaGVldCA9IGF3YWl0IHRoaXMucHJpc21hLndvcmtzaGVldC5maW5kVW5pcXVlKHtcbiAgICAgIHdoZXJlOiB7IGlkIH0sXG4gICAgfSk7XG5cbiAgICBpZiAoIXdvcmtzaGVldCkge1xuICAgICAgdGhyb3cgbmV3IE5vdEZvdW5kRXhjZXB0aW9uKGBXb3Jrc2hlZXQgd2l0aCBJRCAke2lkfSBub3QgZm91bmRgKTtcbiAgICB9XG5cbiAgICAvLyBVcGRhdGUgd29ya3NoZWV0IHdpdGggc3VibWlzc2lvbiBkYXRhIGFuZCBtYXJrIGFzIGNvbXBsZXRlZFxuICAgIGNvbnN0IHVwZGF0ZWRXb3Jrc2hlZXQgPSBhd2FpdCB0aGlzLnByaXNtYS53b3Jrc2hlZXQudXBkYXRlKHtcbiAgICAgIHdoZXJlOiB7IGlkIH0sXG4gICAgICBkYXRhOiB7XG4gICAgICAgIGZlZWRiYWNrOiAoZGF0YSBhcyBhbnkpLm5vdGVzIHx8IG51bGwsXG4gICAgICAgIGlzQ29tcGxldGVkOiB0cnVlLFxuICAgICAgICBzdGF0dXM6ICdjb21wbGV0ZWQnLFxuICAgICAgICBzdWJtaXR0ZWRBdDogbmV3IERhdGUoKSxcbiAgICAgICAgLy8gRmlsZSBhdHRhY2htZW50cyBhcmUgaGFuZGxlZCBzZXBhcmF0ZWx5IHZpYSB1cGxvYWQgZW5kcG9pbnRcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICByZXR1cm4ge1xuICAgICAgd29ya3NoZWV0SWQ6IGlkLFxuICAgICAgc3VibWlzc2lvbklkOiBpZCwgLy8gVXNlIHdvcmtzaGVldCBJRCBhcyBzdWJtaXNzaW9uIElEIHNpbmNlIHRoZXkncmUgbm93IHVuaWZpZWRcbiAgICAgIHN0YXR1czogdXBkYXRlZFdvcmtzaGVldC5zdGF0dXMsXG4gICAgICBzdWJtaXR0ZWRBdDogdXBkYXRlZFdvcmtzaGVldC5zdWJtaXR0ZWRBdCxcbiAgICAgIG1lc3NhZ2U6ICdXb3Jrc2hlZXQgc3VibWl0dGVkIHN1Y2Nlc3NmdWxseScsXG4gICAgfTtcbiAgfVxuXG4gIGFzeW5jIGRlbGV0ZVN1Ym1pc3Npb24oaWQ6IHN0cmluZykge1xuICAgIC8vIFNpbmNlIHN1Ym1pc3Npb25zIGFyZSBub3cgaW5saW5lLCB3ZSByZXNldCB0aGUgd29ya3NoZWV0IHN1Ym1pc3Npb24gc3RhdHVzXG4gICAgY29uc3Qgd29ya3NoZWV0ID0gYXdhaXQgdGhpcy5wcmlzbWEud29ya3NoZWV0LmZpbmRVbmlxdWUoe1xuICAgICAgd2hlcmU6IHsgaWQgfSxcbiAgICB9KTtcblxuICAgIGlmICghd29ya3NoZWV0KSB7XG4gICAgICB0aHJvdyBuZXcgTm90Rm91bmRFeGNlcHRpb24oYFdvcmtzaGVldCB3aXRoIElEICR7aWR9IG5vdCBmb3VuZGApO1xuICAgIH1cblxuICAgIC8vIFJlc2V0IHN1Ym1pc3Npb24gc3RhdHVzXG4gICAgYXdhaXQgdGhpcy5wcmlzbWEud29ya3NoZWV0LnVwZGF0ZSh7XG4gICAgICB3aGVyZTogeyBpZCB9LFxuICAgICAgZGF0YToge1xuICAgICAgICBpc0NvbXBsZXRlZDogZmFsc2UsXG4gICAgICAgIHN0YXR1czogJ2Fzc2lnbmVkJyxcbiAgICAgICAgc3VibWl0dGVkQXQ6IG51bGwsXG4gICAgICAgIGZlZWRiYWNrOiBudWxsLFxuICAgICAgICAvLyBDbGVhciBzdWJtaXNzaW9uIGZpbGVzIGJ1dCBrZWVwIG1hdGVyaWFsc1xuICAgICAgICBzdWJtaXNzaW9uVXJsczogW10sXG4gICAgICAgIHN1Ym1pc3Npb25OYW1lczogW10sXG4gICAgICAgIHN1Ym1pc3Npb25TaXplczogW10sXG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgcmV0dXJuIHsgc3VjY2VzczogdHJ1ZSwgbWVzc2FnZTogJ1N1Ym1pc3Npb24gcmVzZXQgc3VjY2Vzc2Z1bGx5JyB9O1xuICB9XG59XG4iXSwidmVyc2lvbiI6M30=