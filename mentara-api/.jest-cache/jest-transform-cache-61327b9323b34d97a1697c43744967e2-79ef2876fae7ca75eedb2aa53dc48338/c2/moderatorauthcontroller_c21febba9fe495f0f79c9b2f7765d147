f04d78b419ad46d4ca9e66efedb24268
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var __param = (this && this.__param) || function (paramIndex, decorator) {
    return function (target, key) { decorator(target, key, paramIndex); }
};
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
exports.ModeratorAuthController = void 0;
const common_1 = require("@nestjs/common");
const throttler_1 = require("@nestjs/throttler");
const jwt_auth_guard_1 = require("../guards/jwt-auth.guard");
const current_user_id_decorator_1 = require("../decorators/current-user-id.decorator");
const current_user_role_decorator_1 = require("../decorators/current-user-role.decorator");
const zod_validation_pipe_1 = require("../../common/pipes/zod-validation.pipe");
// Import validation schemas from local validation
const validation_1 = require("../validation");
const moderator_auth_service_1 = require("../services/moderator-auth.service");
let ModeratorAuthController = class ModeratorAuthController {
    moderatorAuthService;
    constructor(moderatorAuthService) {
        this.moderatorAuthService = moderatorAuthService;
    }
    async createModeratorAccount(currentUserRole, registerDto) {
        // Only admins can create moderators
        if (currentUserRole !== 'admin') {
            throw new common_1.ForbiddenException('Only admins can create moderator accounts');
        }
        const result = await this.moderatorAuthService.createModeratorAccount(registerDto.email, registerDto.password, registerDto.firstName, registerDto.lastName, registerDto.permissions || [], registerDto.assignedCommunities || []);
        return {
            user: {
                id: result.user.id,
                email: result.user.email,
                firstName: result.user.firstName,
                lastName: result.user.lastName,
                role: result.user.role,
                emailVerified: result.user.emailVerified,
            },
            message: result.message,
        };
    }
    // REMOVED: Duplicate login route - use universal /auth/login instead
    // This was redundant with AuthController.login() which handles all roles
    async getProfile(userId) {
        return this.moderatorAuthService.getModeratorProfile(userId);
    }
    async getPermissions(userId) {
        return this.moderatorAuthService.getModeratorPermissions(userId);
    }
    async getAssignedCommunities(userId) {
        return this.moderatorAuthService.getAssignedCommunities(userId);
    }
    async getDashboardStats(userId) {
        return this.moderatorAuthService.getModeratorDashboardStats(userId);
    }
};
exports.ModeratorAuthController = ModeratorAuthController;
__decorate([
    (0, common_1.Post)('create-account'),
    (0, common_1.UseGuards)(jwt_auth_guard_1.JwtAuthGuard),
    (0, throttler_1.Throttle)({ default: { limit: 5, ttl: 600000 } }) // 5 moderator creations per 10 minutes
    ,
    (0, common_1.HttpCode)(common_1.HttpStatus.CREATED),
    __param(0, (0, current_user_role_decorator_1.CurrentUserRole)()),
    __param(1, (0, common_1.Body)(new zod_validation_pipe_1.ZodValidationPipe(validation_1.RegisterModeratorDtoSchema))),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [String, Object]),
    __metadata("design:returntype", Promise)
], ModeratorAuthController.prototype, "createModeratorAccount", null);
__decorate([
    (0, common_1.UseGuards)(jwt_auth_guard_1.JwtAuthGuard),
    (0, common_1.Get)('profile'),
    __param(0, (0, current_user_id_decorator_1.CurrentUserId)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [String]),
    __metadata("design:returntype", Promise)
], ModeratorAuthController.prototype, "getProfile", null);
__decorate([
    (0, common_1.UseGuards)(jwt_auth_guard_1.JwtAuthGuard),
    (0, common_1.Get)('permissions'),
    __param(0, (0, current_user_id_decorator_1.CurrentUserId)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [String]),
    __metadata("design:returntype", Promise)
], ModeratorAuthController.prototype, "getPermissions", null);
__decorate([
    (0, common_1.UseGuards)(jwt_auth_guard_1.JwtAuthGuard),
    (0, common_1.Get)('assigned-communities'),
    __param(0, (0, current_user_id_decorator_1.CurrentUserId)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [String]),
    __metadata("design:returntype", Promise)
], ModeratorAuthController.prototype, "getAssignedCommunities", null);
__decorate([
    (0, common_1.UseGuards)(jwt_auth_guard_1.JwtAuthGuard),
    (0, common_1.Get)('dashboard-stats'),
    __param(0, (0, current_user_id_decorator_1.CurrentUserId)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [String]),
    __metadata("design:returntype", Promise)
], ModeratorAuthController.prototype, "getDashboardStats", null);
exports.ModeratorAuthController = ModeratorAuthController = __decorate([
    (0, common_1.Controller)('auth/moderator'),
    __metadata("design:paramtypes", [typeof (_a = typeof moderator_auth_service_1.ModeratorAuthService !== "undefined" && moderator_auth_service_1.ModeratorAuthService) === "function" ? _a : Object])
], ModeratorAuthController);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL2F1dGgvY29udHJvbGxlcnMvbW9kZXJhdG9yLWF1dGguY29udHJvbGxlci50cyIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsMkNBVXdCO0FBQ3hCLGlEQUE2QztBQUM3Qyw2REFBd0Q7QUFDeEQsdUZBQXdFO0FBQ3hFLDJGQUE0RTtBQUU1RSxnRkFBMkU7QUFPM0Usa0RBQWtEO0FBQ2xELDhDQUd1QjtBQUN2QiwrRUFBMEU7QUFJbkUsSUFBTSx1QkFBdUIsR0FBN0IsTUFBTSx1QkFBdUI7SUFDTDtJQUE3QixZQUE2QixvQkFBMEM7UUFBMUMseUJBQW9CLEdBQXBCLG9CQUFvQixDQUFzQjtJQUFHLENBQUM7SUFNckUsQUFBTixLQUFLLENBQUMsc0JBQXNCLENBQ1AsZUFBdUIsRUFFMUMsV0FBaUM7UUFFakMsb0NBQW9DO1FBQ3BDLElBQUksZUFBZSxLQUFLLE9BQU8sRUFBRSxDQUFDO1lBQ2hDLE1BQU0sSUFBSSwyQkFBa0IsQ0FBQywyQ0FBMkMsQ0FBQyxDQUFDO1FBQzVFLENBQUM7UUFFRCxNQUFNLE1BQU0sR0FBRyxNQUFNLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxzQkFBc0IsQ0FDbkUsV0FBVyxDQUFDLEtBQUssRUFDakIsV0FBVyxDQUFDLFFBQVEsRUFDcEIsV0FBVyxDQUFDLFNBQVMsRUFDckIsV0FBVyxDQUFDLFFBQVEsRUFDbkIsV0FBbUIsQ0FBQyxXQUFXLElBQUksRUFBRSxFQUNyQyxXQUFtQixDQUFDLG1CQUFtQixJQUFJLEVBQUUsQ0FDL0MsQ0FBQztRQUVGLE9BQU87WUFDTCxJQUFJLEVBQUU7Z0JBQ0osRUFBRSxFQUFFLE1BQU0sQ0FBQyxJQUFJLENBQUMsRUFBRTtnQkFDbEIsS0FBSyxFQUFFLE1BQU0sQ0FBQyxJQUFJLENBQUMsS0FBSztnQkFDeEIsU0FBUyxFQUFFLE1BQU0sQ0FBQyxJQUFJLENBQUMsU0FBUztnQkFDaEMsUUFBUSxFQUFFLE1BQU0sQ0FBQyxJQUFJLENBQUMsUUFBUTtnQkFDOUIsSUFBSSxFQUFFLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSTtnQkFDdEIsYUFBYSxFQUFFLE1BQU0sQ0FBQyxJQUFJLENBQUMsYUFBYTthQUN6QztZQUNELE9BQU8sRUFBRSxNQUFNLENBQUMsT0FBTztTQUN4QixDQUFDO0lBQ0osQ0FBQztJQUVELHFFQUFxRTtJQUNyRSx5RUFBeUU7SUFJbkUsQUFBTixLQUFLLENBQUMsVUFBVSxDQUFrQixNQUFjO1FBQzlDLE9BQU8sSUFBSSxDQUFDLG9CQUFvQixDQUFDLG1CQUFtQixDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQy9ELENBQUM7SUFJSyxBQUFOLEtBQUssQ0FBQyxjQUFjLENBQWtCLE1BQWM7UUFDbEQsT0FBTyxJQUFJLENBQUMsb0JBQW9CLENBQUMsdUJBQXVCLENBQUMsTUFBTSxDQUFDLENBQUM7SUFDbkUsQ0FBQztJQUlLLEFBQU4sS0FBSyxDQUFDLHNCQUFzQixDQUFrQixNQUFjO1FBQzFELE9BQU8sSUFBSSxDQUFDLG9CQUFvQixDQUFDLHNCQUFzQixDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQ2xFLENBQUM7SUFJSyxBQUFOLEtBQUssQ0FBQyxpQkFBaUIsQ0FBa0IsTUFBYztRQUNyRCxPQUFPLElBQUksQ0FBQyxvQkFBb0IsQ0FBQywwQkFBMEIsQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUN0RSxDQUFDO0NBQ0YsQ0FBQTtBQWpFWSwwREFBdUI7QUFPNUI7SUFKTCxJQUFBLGFBQUksRUFBQyxnQkFBZ0IsQ0FBQztJQUN0QixJQUFBLGtCQUFTLEVBQUMsNkJBQVksQ0FBQztJQUN2QixJQUFBLG9CQUFRLEVBQUMsRUFBRSxPQUFPLEVBQUUsRUFBRSxLQUFLLEVBQUUsQ0FBQyxFQUFFLEdBQUcsRUFBRSxNQUFNLEVBQUUsRUFBRSxDQUFDLENBQUMsdUNBQXVDOztJQUN4RixJQUFBLGlCQUFRLEVBQUMsbUJBQVUsQ0FBQyxPQUFPLENBQUM7SUFFMUIsV0FBQSxJQUFBLDZDQUFlLEdBQUUsQ0FBQTtJQUNqQixXQUFBLElBQUEsYUFBSSxFQUFDLElBQUksdUNBQWlCLENBQUMsdUNBQTBCLENBQUMsQ0FBQyxDQUFBOzs7O3FFQTRCekQ7QUFPSztJQUZMLElBQUEsa0JBQVMsRUFBQyw2QkFBWSxDQUFDO0lBQ3ZCLElBQUEsWUFBRyxFQUFDLFNBQVMsQ0FBQztJQUNHLFdBQUEsSUFBQSx5Q0FBYSxHQUFFLENBQUE7Ozs7eURBRWhDO0FBSUs7SUFGTCxJQUFBLGtCQUFTLEVBQUMsNkJBQVksQ0FBQztJQUN2QixJQUFBLFlBQUcsRUFBQyxhQUFhLENBQUM7SUFDRyxXQUFBLElBQUEseUNBQWEsR0FBRSxDQUFBOzs7OzZEQUVwQztBQUlLO0lBRkwsSUFBQSxrQkFBUyxFQUFDLDZCQUFZLENBQUM7SUFDdkIsSUFBQSxZQUFHLEVBQUMsc0JBQXNCLENBQUM7SUFDRSxXQUFBLElBQUEseUNBQWEsR0FBRSxDQUFBOzs7O3FFQUU1QztBQUlLO0lBRkwsSUFBQSxrQkFBUyxFQUFDLDZCQUFZLENBQUM7SUFDdkIsSUFBQSxZQUFHLEVBQUMsaUJBQWlCLENBQUM7SUFDRSxXQUFBLElBQUEseUNBQWEsR0FBRSxDQUFBOzs7O2dFQUV2QztrQ0FoRVUsdUJBQXVCO0lBRG5DLElBQUEsbUJBQVUsRUFBQyxnQkFBZ0IsQ0FBQzt5REFFd0IsNkNBQW9CLG9CQUFwQiw2Q0FBb0I7R0FENUQsdUJBQXVCLENBaUVuQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvaG9tZS93ZXRvb2EvRG9jdW1lbnRzL2NvZGUvcHJvamVjdHMvbWVudGFyYS9tZW50YXJhLWFwaS9zcmMvYXV0aC9jb250cm9sbGVycy9tb2RlcmF0b3ItYXV0aC5jb250cm9sbGVyLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIEJvZHksXG4gIENvbnRyb2xsZXIsXG4gIEdldCxcbiAgUG9zdCxcbiAgVXNlR3VhcmRzLFxuICBIdHRwQ29kZSxcbiAgSHR0cFN0YXR1cyxcbiAgUmVxLFxuICBGb3JiaWRkZW5FeGNlcHRpb24sXG59IGZyb20gJ0BuZXN0anMvY29tbW9uJztcbmltcG9ydCB7IFRocm90dGxlIH0gZnJvbSAnQG5lc3Rqcy90aHJvdHRsZXInO1xuaW1wb3J0IHsgSnd0QXV0aEd1YXJkIH0gZnJvbSAnLi4vZ3VhcmRzL2p3dC1hdXRoLmd1YXJkJztcbmltcG9ydCB7IEN1cnJlbnRVc2VySWQgfSBmcm9tICcuLi9kZWNvcmF0b3JzL2N1cnJlbnQtdXNlci1pZC5kZWNvcmF0b3InO1xuaW1wb3J0IHsgQ3VycmVudFVzZXJSb2xlIH0gZnJvbSAnLi4vZGVjb3JhdG9ycy9jdXJyZW50LXVzZXItcm9sZS5kZWNvcmF0b3InO1xuaW1wb3J0IHsgUHVibGljIH0gZnJvbSAnLi4vZGVjb3JhdG9ycy9wdWJsaWMuZGVjb3JhdG9yJztcbmltcG9ydCB7IFpvZFZhbGlkYXRpb25QaXBlIH0gZnJvbSAnLi4vLi4vY29tbW9uL3BpcGVzL3pvZC12YWxpZGF0aW9uLnBpcGUnO1xuLy8gSW1wb3J0IHR5cGVzIGZyb20gbG9jYWwgYXV0aCB0eXBlc1xuaW1wb3J0IHR5cGUge1xuICBSZWdpc3Rlck1vZGVyYXRvckR0byxcbiAgTG9naW5EdG8sXG59IGZyb20gJy4uL3R5cGVzJztcblxuLy8gSW1wb3J0IHZhbGlkYXRpb24gc2NoZW1hcyBmcm9tIGxvY2FsIHZhbGlkYXRpb25cbmltcG9ydCB7XG4gIFJlZ2lzdGVyTW9kZXJhdG9yRHRvU2NoZW1hLFxuICBMb2dpbkR0b1NjaGVtYSxcbn0gZnJvbSAnLi4vdmFsaWRhdGlvbic7XG5pbXBvcnQgeyBNb2RlcmF0b3JBdXRoU2VydmljZSB9IGZyb20gJy4uL3NlcnZpY2VzL21vZGVyYXRvci1hdXRoLnNlcnZpY2UnO1xuaW1wb3J0IHsgUmVxdWVzdCB9IGZyb20gJ2V4cHJlc3MnO1xuXG5AQ29udHJvbGxlcignYXV0aC9tb2RlcmF0b3InKVxuZXhwb3J0IGNsYXNzIE1vZGVyYXRvckF1dGhDb250cm9sbGVyIHtcbiAgY29uc3RydWN0b3IocHJpdmF0ZSByZWFkb25seSBtb2RlcmF0b3JBdXRoU2VydmljZTogTW9kZXJhdG9yQXV0aFNlcnZpY2UpIHt9XG5cbiAgQFBvc3QoJ2NyZWF0ZS1hY2NvdW50JylcbiAgQFVzZUd1YXJkcyhKd3RBdXRoR3VhcmQpXG4gIEBUaHJvdHRsZSh7IGRlZmF1bHQ6IHsgbGltaXQ6IDUsIHR0bDogNjAwMDAwIH0gfSkgLy8gNSBtb2RlcmF0b3IgY3JlYXRpb25zIHBlciAxMCBtaW51dGVzXG4gIEBIdHRwQ29kZShIdHRwU3RhdHVzLkNSRUFURUQpXG4gIGFzeW5jIGNyZWF0ZU1vZGVyYXRvckFjY291bnQoXG4gICAgQEN1cnJlbnRVc2VyUm9sZSgpIGN1cnJlbnRVc2VyUm9sZTogc3RyaW5nLFxuICAgIEBCb2R5KG5ldyBab2RWYWxpZGF0aW9uUGlwZShSZWdpc3Rlck1vZGVyYXRvckR0b1NjaGVtYSkpXG4gICAgcmVnaXN0ZXJEdG86IFJlZ2lzdGVyTW9kZXJhdG9yRHRvLFxuICApIHtcbiAgICAvLyBPbmx5IGFkbWlucyBjYW4gY3JlYXRlIG1vZGVyYXRvcnNcbiAgICBpZiAoY3VycmVudFVzZXJSb2xlICE9PSAnYWRtaW4nKSB7XG4gICAgICB0aHJvdyBuZXcgRm9yYmlkZGVuRXhjZXB0aW9uKCdPbmx5IGFkbWlucyBjYW4gY3JlYXRlIG1vZGVyYXRvciBhY2NvdW50cycpO1xuICAgIH1cblxuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHRoaXMubW9kZXJhdG9yQXV0aFNlcnZpY2UuY3JlYXRlTW9kZXJhdG9yQWNjb3VudChcbiAgICAgIHJlZ2lzdGVyRHRvLmVtYWlsLFxuICAgICAgcmVnaXN0ZXJEdG8ucGFzc3dvcmQsXG4gICAgICByZWdpc3RlckR0by5maXJzdE5hbWUsXG4gICAgICByZWdpc3RlckR0by5sYXN0TmFtZSxcbiAgICAgIChyZWdpc3RlckR0byBhcyBhbnkpLnBlcm1pc3Npb25zIHx8IFtdLFxuICAgICAgKHJlZ2lzdGVyRHRvIGFzIGFueSkuYXNzaWduZWRDb21tdW5pdGllcyB8fCBbXSxcbiAgICApO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIHVzZXI6IHtcbiAgICAgICAgaWQ6IHJlc3VsdC51c2VyLmlkLFxuICAgICAgICBlbWFpbDogcmVzdWx0LnVzZXIuZW1haWwsXG4gICAgICAgIGZpcnN0TmFtZTogcmVzdWx0LnVzZXIuZmlyc3ROYW1lLFxuICAgICAgICBsYXN0TmFtZTogcmVzdWx0LnVzZXIubGFzdE5hbWUsXG4gICAgICAgIHJvbGU6IHJlc3VsdC51c2VyLnJvbGUsXG4gICAgICAgIGVtYWlsVmVyaWZpZWQ6IHJlc3VsdC51c2VyLmVtYWlsVmVyaWZpZWQsXG4gICAgICB9LFxuICAgICAgbWVzc2FnZTogcmVzdWx0Lm1lc3NhZ2UsXG4gICAgfTtcbiAgfVxuXG4gIC8vIFJFTU9WRUQ6IER1cGxpY2F0ZSBsb2dpbiByb3V0ZSAtIHVzZSB1bml2ZXJzYWwgL2F1dGgvbG9naW4gaW5zdGVhZFxuICAvLyBUaGlzIHdhcyByZWR1bmRhbnQgd2l0aCBBdXRoQ29udHJvbGxlci5sb2dpbigpIHdoaWNoIGhhbmRsZXMgYWxsIHJvbGVzXG5cbiAgQFVzZUd1YXJkcyhKd3RBdXRoR3VhcmQpXG4gIEBHZXQoJ3Byb2ZpbGUnKVxuICBhc3luYyBnZXRQcm9maWxlKEBDdXJyZW50VXNlcklkKCkgdXNlcklkOiBzdHJpbmcpIHtcbiAgICByZXR1cm4gdGhpcy5tb2RlcmF0b3JBdXRoU2VydmljZS5nZXRNb2RlcmF0b3JQcm9maWxlKHVzZXJJZCk7XG4gIH1cblxuICBAVXNlR3VhcmRzKEp3dEF1dGhHdWFyZClcbiAgQEdldCgncGVybWlzc2lvbnMnKVxuICBhc3luYyBnZXRQZXJtaXNzaW9ucyhAQ3VycmVudFVzZXJJZCgpIHVzZXJJZDogc3RyaW5nKSB7XG4gICAgcmV0dXJuIHRoaXMubW9kZXJhdG9yQXV0aFNlcnZpY2UuZ2V0TW9kZXJhdG9yUGVybWlzc2lvbnModXNlcklkKTtcbiAgfVxuXG4gIEBVc2VHdWFyZHMoSnd0QXV0aEd1YXJkKVxuICBAR2V0KCdhc3NpZ25lZC1jb21tdW5pdGllcycpXG4gIGFzeW5jIGdldEFzc2lnbmVkQ29tbXVuaXRpZXMoQEN1cnJlbnRVc2VySWQoKSB1c2VySWQ6IHN0cmluZykge1xuICAgIHJldHVybiB0aGlzLm1vZGVyYXRvckF1dGhTZXJ2aWNlLmdldEFzc2lnbmVkQ29tbXVuaXRpZXModXNlcklkKTtcbiAgfVxuXG4gIEBVc2VHdWFyZHMoSnd0QXV0aEd1YXJkKVxuICBAR2V0KCdkYXNoYm9hcmQtc3RhdHMnKVxuICBhc3luYyBnZXREYXNoYm9hcmRTdGF0cyhAQ3VycmVudFVzZXJJZCgpIHVzZXJJZDogc3RyaW5nKSB7XG4gICAgcmV0dXJuIHRoaXMubW9kZXJhdG9yQXV0aFNlcnZpY2UuZ2V0TW9kZXJhdG9yRGFzaGJvYXJkU3RhdHModXNlcklkKTtcbiAgfVxufVxuIl0sInZlcnNpb24iOjN9