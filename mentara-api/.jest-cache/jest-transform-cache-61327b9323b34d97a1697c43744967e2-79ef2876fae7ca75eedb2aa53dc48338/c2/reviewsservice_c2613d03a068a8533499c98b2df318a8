5b884312b8de8a0f2c2e92006d16bd64
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
exports.ReviewsService = void 0;
const common_1 = require("@nestjs/common");
const client_1 = require("@prisma/client");
const prisma_client_provider_1 = require("../providers/prisma-client.provider");
let ReviewsService = class ReviewsService {
    prisma;
    constructor(prisma) {
        this.prisma = prisma;
    }
    async createReview(meetingId, clientId, therapistId, createReviewDto) {
        const { rating, title, content, isAnonymous } = createReviewDto;
        // Verify the client has had a completed session with this therapist
        const completedMeeting = await this.prisma.meeting.findFirst({
            where: {
                clientId,
                therapistId,
                id: meetingId,
                status: client_1.MeetingStatus.COMPLETED,
            },
        });
        if (!completedMeeting) {
            throw new common_1.BadRequestException('You can only review therapists after completing a session with them');
        }
        // Check if review already exists for this client-therapist pair
        const existingReview = await this.prisma.review.findFirst({
            where: {
                clientId,
                therapistId,
                meetingId: meetingId,
            },
        });
        if (existingReview) {
            throw new common_1.BadRequestException('You have already reviewed this therapist for this session');
        }
        // Create the review
        const review = await this.prisma.review.create({
            data: {
                rating,
                title,
                content,
                isAnonymous,
                clientId,
                therapistId,
                meetingId: meetingId,
            },
            include: {
                client: {
                    select: {
                        user: {
                            select: {
                                firstName: true,
                                lastName: true,
                                avatarUrl: true,
                            },
                        },
                    },
                },
                therapist: {
                    select: {
                        user: true,
                    },
                },
                meeting: {
                    select: {
                        startTime: true,
                        duration: true,
                    },
                },
            },
        });
        return {
            ...review,
            therapist: {
                ...review.therapist,
                id: review.therapistId,
            },
        };
    }
    async updateReview(reviewId, clientId, updateReviewDto) {
        const review = await this.prisma.review.findUnique({
            where: { id: reviewId },
        });
        if (!review) {
            throw new common_1.NotFoundException('Review not found');
        }
        if (review.clientId !== clientId) {
            throw new common_1.ForbiddenException('You can only update your own reviews');
        }
        const updatedReview = await this.prisma.review.update({
            where: { id: reviewId },
            data: {
                ...updateReviewDto,
                updatedAt: new Date(),
            },
            include: {
                client: {
                    select: {
                        user: {
                            select: {
                                firstName: true,
                                lastName: true,
                                avatarUrl: true,
                            },
                        },
                    },
                },
                therapist: {
                    select: {
                        user: {
                            select: {
                                firstName: true,
                                lastName: true,
                                avatarUrl: true,
                            },
                        },
                    },
                },
                meeting: {
                    select: {
                        startTime: true,
                        duration: true,
                    },
                },
            },
        });
        return updatedReview;
    }
    async deleteReview(reviewId, clientId) {
        const review = await this.prisma.review.findUnique({
            where: { id: reviewId },
        });
        if (!review) {
            throw new common_1.NotFoundException('Review not found');
        }
        if (review.clientId !== clientId) {
            throw new common_1.ForbiddenException('You can only delete your own reviews');
        }
        await this.prisma.review.delete({
            where: { id: reviewId },
        });
        return { message: 'Review deleted successfully' };
    }
    async getReviews(query) {
        const { page = 1, limit = 10, sortBy = 'createdAt', sortOrder = 'desc', therapistId, clientId, status, rating, } = query;
        const skip = (page - 1) * limit;
        const where = {};
        if (therapistId)
            where.therapistId = therapistId;
        if (clientId)
            where.clientId = clientId;
        if (rating)
            where.rating = rating;
        const [reviews, totalCount] = await Promise.all([
            this.prisma.review.findMany({
                where,
                skip,
                take: limit,
                orderBy: { [sortBy]: sortOrder },
                include: {
                    client: {
                        select: {
                            user: {
                                select: {
                                    firstName: true,
                                    lastName: true,
                                    avatarUrl: true,
                                },
                            },
                        },
                    },
                    therapist: {
                        select: {
                            user: {
                                select: {
                                    firstName: true,
                                    lastName: true,
                                    avatarUrl: true,
                                },
                            },
                        },
                    },
                    meeting: {
                        select: {
                            startTime: true,
                            duration: true,
                        },
                    },
                },
            }),
            this.prisma.review.count({ where }),
        ]);
        const totalPages = Math.ceil(totalCount / limit);
        // Calculate average rating for the result set
        const averageRating = reviews.length > 0
            ? reviews.reduce((sum, review) => sum + review.rating, 0) /
                reviews.length
            : 0;
        // Calculate rating distribution
        const ratingDistribution = reviews.reduce((dist, review) => {
            dist[review.rating.toString()] =
                (dist[review.rating.toString()] || 0) + 1;
            return dist;
        }, { '1': 0, '2': 0, '3': 0, '4': 0, '5': 0 });
        return {
            reviews: reviews.map((review) => ({
                id: review.id,
                rating: review.rating,
                title: review.title || undefined,
                content: review.content || undefined,
                therapistId: review.therapistId,
                clientId: review.clientId,
                meetingId: review.meetingId || undefined,
                isAnonymous: review.isAnonymous,
                status: 'approved', // Default status since Review model doesn't have this field
                categories: {
                    communication: undefined,
                    professionalism: undefined,
                    helpfulness: undefined,
                    availability: undefined,
                    overall: review.rating, // Use overall rating as fallback
                },
                tags: [], // Default empty array since tags are not in current Review model
                wouldRecommend: review.rating >= 4, // Infer recommendation from rating
                helpfulCount: 0, // Default count since Review model doesn't have this field
                createdAt: review.createdAt.toISOString(),
                updatedAt: review.updatedAt.toISOString(),
                client: review.client
                    ? {
                        id: review.clientId,
                        firstName: review.client.user?.firstName,
                        lastName: review.client.user?.lastName,
                    }
                    : undefined,
                therapist: {
                    id: review.therapistId,
                    user: {
                        firstName: review.therapist?.user?.firstName || '',
                        lastName: review.therapist?.user?.lastName || '',
                        avatarUrl: review.therapist?.user?.avatarUrl || undefined,
                    },
                },
            })),
            totalCount,
            page,
            pageSize: limit,
            totalPages,
            averageRating,
            ratingDistribution,
        };
    }
    async getTherapistReviews(therapistId, query) {
        return this.getReviews({ ...query, therapistId });
    }
    async getReviewStats(therapistId) {
        const stats = await this.prisma.review.groupBy({
            by: ['rating'],
            where: {
                therapistId,
            },
            _count: {
                rating: true,
            },
        });
        const totalReviews = stats.reduce((sum, stat) => sum + stat._count.rating, 0);
        const totalRating = stats.reduce((sum, stat) => sum + stat.rating * stat._count.rating, 0);
        const averageRating = totalReviews > 0 ? totalRating / totalReviews : 0;
        const ratingDistribution = {
            '1': 0,
            '2': 0,
            '3': 0,
            '4': 0,
            '5': 0,
        };
        stats.forEach((stat) => {
            ratingDistribution[stat.rating.toString()] = stat._count.rating;
        });
        // Get monthly reviews for the last 12 months
        const twelveMonthsAgo = new Date();
        twelveMonthsAgo.setMonth(twelveMonthsAgo.getMonth() - 12);
        const monthlyStats = await this.prisma.review.groupBy({
            by: ['createdAt'],
            where: {
                therapistId,
                createdAt: {
                    gte: twelveMonthsAgo,
                },
            },
            _count: {
                rating: true,
            },
            _avg: {
                rating: true,
            },
        });
        // Group by month
        const monthlyReviews = monthlyStats.reduce((acc, stat) => {
            const month = stat.createdAt.toISOString().substring(0, 7); // YYYY-MM format
            if (!acc[month]) {
                acc[month] = { count: 0, totalRating: 0 };
            }
            acc[month].count += stat._count.rating;
            acc[month].totalRating += (stat._avg.rating || 0) * stat._count.rating;
            return acc;
        }, {});
        const monthlyReviewsArray = Object.entries(monthlyReviews).map(([month, data]) => ({
            month,
            count: data.count,
            averageRating: data.count > 0 ? data.totalRating / data.count : 0,
        }));
        // Get recent reviews
        const recentReviews = await this.prisma.review.findMany({
            where: {
                therapistId,
            },
            orderBy: {
                createdAt: 'desc',
            },
            take: 5,
            include: {
                client: {
                    select: {
                        user: {
                            select: {
                                firstName: true,
                                lastName: true,
                            },
                        },
                    },
                },
            },
        });
        return {
            totalReviews,
            averageRating: Math.round(averageRating * 100) / 100,
            ratingDistribution,
            categoryAverages: {
                communication: undefined,
                professionalism: undefined,
                helpfulness: undefined,
                availability: undefined,
                overall: averageRating,
            },
            recommendationRate: totalReviews > 0 ?
                (stats.filter(s => s.rating >= 4).reduce((sum, s) => sum + s._count.rating, 0) / totalReviews) * 100 : 0,
            totalHelpfulVotes: 0, // Default since Review model doesn't have helpful votes
            recentReviews: recentReviews.map((review) => ({
                id: review.id,
                rating: review.rating,
                title: review.title || undefined,
                content: review.content || undefined,
                therapistId: review.therapistId,
                clientId: review.clientId,
                meetingId: review.meetingId || undefined,
                isAnonymous: review.isAnonymous,
                status: 'approved', // Default status since Review model doesn't have this field
                categories: {
                    communication: undefined,
                    professionalism: undefined,
                    helpfulness: undefined,
                    availability: undefined,
                    overall: review.rating, // Use overall rating as fallback
                },
                tags: [], // Default empty array since tags are not in current Review model
                wouldRecommend: review.rating >= 4, // Infer recommendation from rating
                helpfulCount: 0, // Default count since Review model doesn't have this field
                createdAt: review.createdAt.toISOString(),
                updatedAt: review.updatedAt.toISOString(),
                client: review.client
                    ? {
                        id: review.clientId,
                        firstName: review.client.user?.firstName,
                        lastName: review.client.user?.lastName,
                    }
                    : undefined,
                therapist: {
                    id: review.therapistId,
                    user: {
                        firstName: '',
                        lastName: '',
                        avatarUrl: undefined,
                    },
                },
            })),
        };
    }
    async markReviewHelpful(reviewId, userId) {
        // Verify review exists
        const review = await this.prisma.review.findUnique({
            where: { id: reviewId },
        });
        if (!review) {
            throw new common_1.NotFoundException('Review not found');
        }
        // For now, return a simple response since the Review model doesn't have helpfulCount
        // This method would typically track users who marked reviews as helpful
        return {
            message: 'Review marked as helpful',
            reviewId,
            helpfulCount: 1, // Placeholder value
        };
    }
    async moderateReview(reviewId, moderatorId, moderateReviewDto) {
        // Verify review exists
        const review = await this.prisma.review.findUnique({
            where: { id: reviewId },
        });
        if (!review) {
            throw new common_1.NotFoundException('Review not found');
        }
        // For now, return a simple response since the Review model doesn't have moderation fields
        // This method would typically update review status and add moderation notes
        return {
            message: 'Review moderated successfully',
            reviewId,
            moderatedBy: moderatorId,
            status: moderateReviewDto.status || 'APPROVED',
            moderationNote: moderateReviewDto.moderatorNotes,
        };
    }
};
exports.ReviewsService = ReviewsService;
exports.ReviewsService = ReviewsService = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [typeof (_a = typeof prisma_client_provider_1.PrismaService !== "undefined" && prisma_client_provider_1.PrismaService) === "function" ? _a : Object])
], ReviewsService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL3Jldmlld3MvcmV2aWV3cy5zZXJ2aWNlLnRzIiwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7QUFBQSwyQ0FLd0I7QUFDeEIsMkNBQStDO0FBQy9DLGdGQUFvRTtBQVc3RCxJQUFNLGNBQWMsR0FBcEIsTUFBTSxjQUFjO0lBQ0k7SUFBN0IsWUFBNkIsTUFBcUI7UUFBckIsV0FBTSxHQUFOLE1BQU0sQ0FBZTtJQUFHLENBQUM7SUFFdEQsS0FBSyxDQUFDLFlBQVksQ0FDaEIsU0FBaUIsRUFDakIsUUFBZ0IsRUFDaEIsV0FBbUIsRUFDbkIsZUFBZ0M7UUFFaEMsTUFBTSxFQUFFLE1BQU0sRUFBRSxLQUFLLEVBQUUsT0FBTyxFQUFFLFdBQVcsRUFBRSxHQUFHLGVBQWUsQ0FBQztRQUVoRSxvRUFBb0U7UUFDcEUsTUFBTSxnQkFBZ0IsR0FBRyxNQUFNLElBQUksQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQztZQUMzRCxLQUFLLEVBQUU7Z0JBQ0wsUUFBUTtnQkFDUixXQUFXO2dCQUNYLEVBQUUsRUFBRSxTQUFTO2dCQUNiLE1BQU0sRUFBRSxzQkFBYSxDQUFDLFNBQVM7YUFDaEM7U0FDRixDQUFDLENBQUM7UUFFSCxJQUFJLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztZQUN0QixNQUFNLElBQUksNEJBQW1CLENBQzNCLHFFQUFxRSxDQUN0RSxDQUFDO1FBQ0osQ0FBQztRQUVELGdFQUFnRTtRQUNoRSxNQUFNLGNBQWMsR0FBRyxNQUFNLElBQUksQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQztZQUN4RCxLQUFLLEVBQUU7Z0JBQ0wsUUFBUTtnQkFDUixXQUFXO2dCQUNYLFNBQVMsRUFBRSxTQUFTO2FBQ3JCO1NBQ0YsQ0FBQyxDQUFDO1FBRUgsSUFBSSxjQUFjLEVBQUUsQ0FBQztZQUNuQixNQUFNLElBQUksNEJBQW1CLENBQzNCLDJEQUEyRCxDQUM1RCxD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LDBCQUEwQjtZQUNuQyxRQUFRO1lBQ1IsWUFBWSxFQUFFLENBQUMsRUFBRSxvQkFBb0I7U0FDdEMsQ0FBQztJQUNKLENBQUM7SUFFRCxLQUFLLENBQUMsY0FBYyxDQUNsQixRQUFnQixFQUNoQixXQUFtQixFQUNuQixpQkFBb0M7UUFFcEMsdUJBQXVCO1FBQ3ZCLE1BQU0sTUFBTSxHQUFHLE1BQU0sSUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsVUFBVSxDQUFDO1lBQ2pELEtBQUssRUFBRSxFQUFFLEVBQUUsRUFBRSxRQUFRLEVBQUU7U0FDeEIsQ0FBQyxDQUFDO1FBRUgsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDO1lBQ1osTUFBTSxJQUFJLDBCQUFpQixDQUFDLGtCQUFrQixDQUFDLENBQUM7UUFDbEQsQ0FBQztRQUVELDBGQUEwRjtRQUMxRiw0RUFBNEU7UUFDNUUsT0FBTztZQUNMLE9BQU8sRUFBRSwrQkFBK0I7WUFDeEMsUUFBUTtZQUNSLFdBQVcsRUFBRSxXQUFXO1lBQ3hCLE1BQU0sRUFBRSxpQkFBaUIsQ0FBQyxNQUFNLElBQUksVUFBVTtZQUM5QyxjQUFjLEVBQUUsaUJBQWlCLENBQUMsY0FBYztTQUNqRCxDQUFDO0lBQ0osQ0FBQztDQUNGLENBQUE7QUFoZlksd0NBQWM7eUJBQWQsY0FBYztJQUQxQixJQUFBLG1CQUFVLEdBQUU7eURBRTBCLHNDQUFhLG9CQUFiLHNDQUFhO0dBRHZDLGNBQWMsQ0FnZjFCIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9ob21lL3dldG9vYS9Eb2N1bWVudHMvY29kZS9wcm9qZWN0cy9tZW50YXJhL21lbnRhcmEtYXBpL3NyYy9yZXZpZXdzL3Jldmlld3Muc2VydmljZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBJbmplY3RhYmxlLFxuICBGb3JiaWRkZW5FeGNlcHRpb24sXG4gIE5vdEZvdW5kRXhjZXB0aW9uLFxuICBCYWRSZXF1ZXN0RXhjZXB0aW9uLFxufSBmcm9tICdAbmVzdGpzL2NvbW1vbic7XG5pbXBvcnQgeyBNZWV0aW5nU3RhdHVzIH0gZnJvbSAnQHByaXNtYS9jbGllbnQnO1xuaW1wb3J0IHsgUHJpc21hU2VydmljZSB9IGZyb20gJy4uL3Byb3ZpZGVycy9wcmlzbWEtY2xpZW50LnByb3ZpZGVyJztcbmltcG9ydCB0eXBlIHtcbiAgQ3JlYXRlUmV2aWV3RHRvLFxuICBVcGRhdGVSZXZpZXdEdG8sXG4gIEdldFJldmlld3NEdG8sXG4gIE1vZGVyYXRlUmV2aWV3RHRvLFxuICBSZXZpZXdMaXN0UmVzcG9uc2UsXG4gIFJldmlld1N0YXRzRHRvLFxufSBmcm9tICcuL3R5cGVzJztcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIFJldmlld3NTZXJ2aWNlIHtcbiAgY29uc3RydWN0b3IocHJpdmF0ZSByZWFkb25seSBwcmlzbWE6IFByaXNtYVNlcnZpY2UpIHt9XG5cbiAgYXN5bmMgY3JlYXRlUmV2aWV3KFxuICAgIG1lZXRpbmdJZDogc3RyaW5nLFxuICAgIGNsaWVudElkOiBzdHJpbmcsXG4gICAgdGhlcmFwaXN0SWQ6IHN0cmluZyxcbiAgICBjcmVhdGVSZXZpZXdEdG86IENyZWF0ZVJldmlld0R0byxcbiAgKSB7XG4gICAgY29uc3QgeyByYXRpbmcsIHRpdGxlLCBjb250ZW50LCBpc0Fub255bW91cyB9ID0gY3JlYXRlUmV2aWV3RHRvO1xuXG4gICAgLy8gVmVyaWZ5IHRoZSBjbGllbnQgaGFzIGhhZCBhIGNvbXBsZXRlZCBzZXNzaW9uIHdpdGggdGhpcyB0aGVyYXBpc3RcbiAgICBjb25zdCBjb21wbGV0ZWRNZWV0aW5nID0gYXdhaXQgdGhpcy5wcmlzbWEubWVldGluZy5maW5kRmlyc3Qoe1xuICAgICAgd2hlcmU6IHtcbiAgICAgICAgY2xpZW50SWQsXG4gICAgICAgIHRoZXJhcGlzdElkLFxuICAgICAgICBpZDogbWVldGluZ0lkLFxuICAgICAgICBzdGF0dXM6IE1lZXRpbmdTdGF0dXMuQ09NUExFVEVELFxuICAgICAgfSxcbiAgICB9KTtcblxuICAgIGlmICghY29tcGxldGVkTWVldGluZykge1xuICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFeGNlcHRpb24oXG4gICAgICAgICdZb3UgY2FuIG9ubHkgcmV2aWV3IHRoZXJhcGlzdHMgYWZ0ZXIgY29tcGxldGluZyBhIHNlc3Npb24gd2l0aCB0aGVtJyxcbiAgICAgICk7XG4gICAgfVxuXG4gICAgLy8gQ2hlY2sgaWYgcmV2aWV3IGFscmVhZHkgZXhpc3RzIGZvciB0aGlzIGNsaWVudC10aGVyYXBpc3QgcGFpclxuICAgIGNvbnN0IGV4aXN0aW5nUmV2aWV3ID0gYXdhaXQgdGhpcy5wcmlzbWEucmV2aWV3LmZpbmRGaXJzdCh7XG4gICAgICB3aGVyZToge1xuICAgICAgICBjbGllbnRJZCxcbiAgICAgICAgdGhlcmFwaXN0SWQsXG4gICAgICAgIG1lZXRpbmdJZDogbWVldGluZ0lkLFxuICAgICAgfSxcbiAgICB9KTtcblxuICAgIGlmIChleGlzdGluZ1Jldmlldykge1xuICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFeGNlcHRpb24oXG4gICAgICAgICdZb3UgaGF2ZSBhbHJlYWR5IHJldmlld2VkIHRoaXMgdGhlcmFwaXN0IGZvciB0aGlzIHNlc3Npb24nLFxuICAgICAgKTtcbiAgICB9XG5cbiAgICAvLyBDcmVhdGUgdGhlIHJldmlld1xuICAgIGNvbnN0IHJldmlldyA9IGF3YWl0IHRoaXMucHJpc21hLnJldmlldy5jcmVhdGUoe1xuICAgICAgZGF0YToge1xuICAgICAgICByYXRpbmcsXG4gICAgICAgIHRpdGxlLFxuICAgICAgICBjb250ZW50LFxuICAgICAgICBpc0Fub255bW91cyxcbiAgICAgICAgY2xpZW50SWQsXG4gICAgICAgIHRoZXJhcGlzdElkLFxuICAgICAgICBtZWV0aW5nSWQ6IG1lZXRpbmdJZCxcbiAgICAgIH0sXG4gICAgICBpbmNsdWRlOiB7XG4gICAgICAgIGNsaWVudDoge1xuICAgICAgICAgIHNlbGVjdDoge1xuICAgICAgICAgICAgdXNlcjoge1xuICAgICAgICAgICAgICBzZWxlY3Q6IHtcbiAgICAgICAgICAgICAgICBmaXJzdE5hbWU6IHRydWUsXG4gICAgICAgICAgICAgICAgbGFzdE5hbWU6IHRydWUsXG4gICAgICAgICAgICAgICAgYXZhdGFyVXJsOiB0cnVlLFxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgICB0aGVyYXBpc3Q6IHtcbiAgICAgICAgICBzZWxlY3Q6IHtcbiAgICAgICAgICAgIHVzZXI6IHRydWUsXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgICAgbWVldGluZzoge1xuICAgICAgICAgIHNlbGVjdDoge1xuICAgICAgICAgICAgc3RhcnRUaW1lOiB0cnVlLFxuICAgICAgICAgICAgZHVyYXRpb246IHRydWUsXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICByZXR1cm4ge1xuICAgICAgLi4ucmV2aWV3LFxuICAgICAgdGhlcmFwaXN0OiB7XG4gICAgICAgIC4uLnJldmlldy50aGVyYXBpc3QsXG4gICAgICAgIGlkOiByZXZpZXcudGhlcmFwaXN0SWQsXG4gICAgICB9LFxuICAgIH07XG4gIH1cblxuICBhc3luYyB1cGRhdGVSZXZpZXcoXG4gICAgcmV2aWV3SWQ6IHN0cmluZyxcbiAgICBjbGllbnRJZDogc3RyaW5nLFxuICAgIHVwZGF0ZVJldmlld0R0bzogVXBkYXRlUmV2aWV3RHRvLFxuICApIHtcbiAgICBjb25zdCByZXZpZXcgPSBhd2FpdCB0aGlzLnByaXNtYS5yZXZpZXcuZmluZFVuaXF1ZSh7XG4gICAgICB3aGVyZTogeyBpZDogcmV2aWV3SWQgfSxcbiAgICB9KTtcblxuICAgIGlmICghcmV2aWV3KSB7XG4gICAgICB0aHJvdyBuZXcgTm90Rm91bmRFeGNlcHRpb24oJ1JldmlldyBub3QgZm91bmQnKTtcbiAgICB9XG5cbiAgICBpZiAocmV2aWV3LmNsaWVudElkICE9PSBjbGllbnRJZCkge1xuICAgICAgdGhyb3cgbmV3IEZvcmJpZGRlbkV4Y2VwdGlvbignWW91IGNhbiBvbmx5IHVwZGF0ZSB5b3VyIG93biByZXZpZXdzJyk7XG4gICAgfVxuXG4gICAgY29uc3QgdXBkYXRlZFJldmlldyA9IGF3YWl0IHRoaXMucHJpc21hLnJldmlldy51cGRhdGUoe1xuICAgICAgd2hlcmU6IHsgaWQ6IHJldmlld0lkIH0sXG4gICAgICBkYXRhOiB7XG4gICAgICAgIC4uLnVwZGF0ZVJldmlld0R0byxcbiAgICAgICAgdXBkYXRlZEF0OiBuZXcgRGF0ZSgpLFxuICAgICAgfSxcbiAgICAgIGluY2x1ZGU6IHtcbiAgICAgICAgY2xpZW50OiB7XG4gICAgICAgICAgc2VsZWN0OiB7XG4gICAgICAgICAgICB1c2VyOiB7XG4gICAgICAgICAgICAgIHNlbGVjdDoge1xuICAgICAgICAgICAgICAgIGZpcnN0TmFtZTogdHJ1ZSxcbiAgICAgICAgICAgICAgICBsYXN0TmFtZTogdHJ1ZSxcbiAgICAgICAgICAgICAgICBhdmF0YXJVcmw6IHRydWUsXG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICAgIHRoZXJhcGlzdDoge1xuICAgICAgICAgIHNlbGVjdDoge1xuICAgICAgICAgICAgdXNlcjoge1xuICAgICAgICAgICAgICBzZWxlY3Q6IHtcbiAgICAgICAgICAgICAgICBmaXJzdE5hbWU6IHRydWUsXG4gICAgICAgICAgICAgICAgbGFzdE5hbWU6IHRydWUsXG4gICAgICAgICAgICAgICAgYXZhdGFyVXJsOiB0cnVlLFxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgICBtZWV0aW5nOiB7XG4gICAgICAgICAgc2VsZWN0OiB7XG4gICAgICAgICAgICBzdGFydFRpbWU6IHRydWUsXG4gICAgICAgICAgICBkdXJhdGlvbjogdHJ1ZSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgfSxcbiAgICB9KTtcblxuICAgIHJldHVybiB1cGRhdGVkUmV2aWV3O1xuICB9XG5cbiAgYXN5bmMgZGVsZXRlUmV2aWV3KHJldmlld0lkOiBzdHJpbmcsIGNsaWVudElkOiBzdHJpbmcpIHtcbiAgICBjb25zdCByZXZpZXcgPSBhd2FpdCB0aGlzLnByaXNtYS5yZXZpZXcuZmluZFVuaXF1ZSh7XG4gICAgICB3aGVyZTogeyBpZDogcmV2aWV3SWQgfSxcbiAgICB9KTtcblxuICAgIGlmICghcmV2aWV3KSB7XG4gICAgICB0aHJvdyBuZXcgTm90Rm91bmRFeGNlcHRpb24oJ1JldmlldyBub3QgZm91bmQnKTtcbiAgICB9XG5cbiAgICBpZiAocmV2aWV3LmNsaWVudElkICE9PSBjbGllbnRJZCkge1xuICAgICAgdGhyb3cgbmV3IEZvcmJpZGRlbkV4Y2VwdGlvbignWW91IGNhbiBvbmx5IGRlbGV0ZSB5b3VyIG93biByZXZpZXdzJyk7XG4gICAgfVxuXG4gICAgYXdhaXQgdGhpcy5wcmlzbWEucmV2aWV3LmRlbGV0ZSh7XG4gICAgICB3aGVyZTogeyBpZDogcmV2aWV3SWQgfSxcbiAgICB9KTtcblxuICAgIHJldHVybiB7IG1lc3NhZ2U6ICdSZXZpZXcgZGVsZXRlZCBzdWNjZXNzZnVsbHknIH07XG4gIH1cblxuICBhc3luYyBnZXRSZXZpZXdzKHF1ZXJ5OiBHZXRSZXZpZXdzRHRvKTogUHJvbWlzZTxSZXZpZXdMaXN0UmVzcG9uc2U+IHtcbiAgICBjb25zdCB7XG4gICAgICBwYWdlID0gMSxcbiAgICAgIGxpbWl0ID0gMTAsXG4gICAgICBzb3J0QnkgPSAnY3JlYXRlZEF0JyxcbiAgICAgIHNvcnRPcmRlciA9ICdkZXNjJyxcbiAgICAgIHRoZXJhcGlzdElkLFxuICAgICAgY2xpZW50SWQsXG4gICAgICBzdGF0dXMsXG4gICAgICByYXRpbmcsXG4gICAgfSA9IHF1ZXJ5O1xuXG4gICAgY29uc3Qgc2tpcCA9IChwYWdlIC0gMSkgKiBsaW1pdDtcblxuICAgIGNvbnN0IHdoZXJlOiBhbnkgPSB7fTtcblxuICAgIGlmICh0aGVyYXBpc3RJZCkgd2hlcmUudGhlcmFwaXN0SWQgPSB0aGVyYXBpc3RJZDtcbiAgICBpZiAoY2xpZW50SWQpIHdoZXJlLmNsaWVudElkID0gY2xpZW50SWQ7XG4gICAgaWYgKHJhdGluZykgd2hlcmUucmF0aW5nID0gcmF0aW5nO1xuXG4gICAgY29uc3QgW3Jldmlld3MsIHRvdGFsQ291bnRdID0gYXdhaXQgUHJvbWlzZS5hbGwoW1xuICAgICAgdGhpcy5wcmlzbWEucmV2aWV3LmZpbmRNYW55KHtcbiAgICAgICAgd2hlcmUsXG4gICAgICAgIHNraXAsXG4gICAgICAgIHRha2U6IGxpbWl0LFxuICAgICAgICBvcmRlckJ5OiB7IFtzb3J0QnldOiBzb3J0T3JkZXIgfSxcbiAgICAgICAgaW5jbHVkZToge1xuICAgICAgICAgIGNsaWVudDoge1xuICAgICAgICAgICAgc2VsZWN0OiB7XG4gICAgICAgICAgICAgIHVzZXI6IHtcbiAgICAgICAgICAgICAgICBzZWxlY3Q6IHtcbiAgICAgICAgICAgICAgICAgIGZpcnN0TmFtZTogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgIGxhc3ROYW1lOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgYXZhdGFyVXJsOiB0cnVlLFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0sXG4gICAgICAgICAgdGhlcmFwaXN0OiB7XG4gICAgICAgICAgICBzZWxlY3Q6IHtcbiAgICAgICAgICAgICAgdXNlcjoge1xuICAgICAgICAgICAgICAgIHNlbGVjdDoge1xuICAgICAgICAgICAgICAgICAgZmlyc3ROYW1lOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgbGFzdE5hbWU6IHRydWUsXG4gICAgICAgICAgICAgICAgICBhdmF0YXJVcmw6IHRydWUsXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgICBtZWV0aW5nOiB7XG4gICAgICAgICAgICBzZWxlY3Q6IHtcbiAgICAgICAgICAgICAgc3RhcnRUaW1lOiB0cnVlLFxuICAgICAgICAgICAgICBkdXJhdGlvbjogdHJ1ZSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgIH0pLFxuICAgICAgdGhpcy5wcmlzbWEucmV2aWV3LmNvdW50KHsgd2hlcmUgfSksXG4gICAgXSk7XG5cbiAgICBjb25zdCB0b3RhbFBhZ2VzID0gTWF0aC5jZWlsKHRvdGFsQ291bnQgLyBsaW1pdCk7XG5cbiAgICAvLyBDYWxjdWxhdGUgYXZlcmFnZSByYXRpbmcgZm9yIHRoZSByZXN1bHQgc2V0XG4gICAgY29uc3QgYXZlcmFnZVJhdGluZyA9XG4gICAgICByZXZpZXdzLmxlbmd0aCA+IDBcbiAgICAgICAgPyByZXZpZXdzLnJlZHVjZSgoc3VtLCByZXZpZXcpID0+IHN1bSArIHJldmlldy5yYXRpbmcsIDApIC9cbiAgICAgICAgICByZXZpZXdzLmxlbmd0aFxuICAgICAgICA6IDA7XG5cbiAgICAvLyBDYWxjdWxhdGUgcmF0aW5nIGRpc3RyaWJ1dGlvblxuICAgIGNvbnN0IHJhdGluZ0Rpc3RyaWJ1dGlvbiA9IHJldmlld3MucmVkdWNlKFxuICAgICAgKGRpc3QsIHJldmlldykgPT4ge1xuICAgICAgICBkaXN0W3Jldmlldy5yYXRpbmcudG9TdHJpbmcoKV0gPVxuICAgICAgICAgIChkaXN0W3Jldmlldy5yYXRpbmcudG9TdHJpbmcoKV0gfHwgMCkgKyAxO1xuICAgICAgICByZXR1cm4gZGlzdDtcbiAgICAgIH0sXG4gICAgICB7ICcxJzogMCwgJzInOiAwLCAnMyc6IDAsICc0JzogMCwgJzUnOiAwIH0sXG4gICAgKTtcblxuICAgIHJldHVybiB7XG4gICAgICByZXZpZXdzOiByZXZpZXdzLm1hcCgocmV2aWV3KSA9PiAoe1xuICAgICAgICBpZDogcmV2aWV3LmlkLFxuICAgICAgICByYXRpbmc6IHJldmlldy5yYXRpbmcsXG4gICAgICAgIHRpdGxlOiByZXZpZXcudGl0bGUgfHwgdW5kZWZpbmVkLFxuICAgICAgICBjb250ZW50OiByZXZpZXcuY29udGVudCB8fCB1bmRlZmluZWQsXG4gICAgICAgIHRoZXJhcGlzdElkOiByZXZpZXcudGhlcmFwaXN0SWQsXG4gICAgICAgIGNsaWVudElkOiByZXZpZXcuY2xpZW50SWQsXG4gICAgICAgIG1lZXRpbmdJZDogcmV2aWV3Lm1lZXRpbmdJZCB8fCB1bmRlZmluZWQsXG4gICAgICAgIGlzQW5vbnltb3VzOiByZXZpZXcuaXNBbm9ueW1vdXMsXG4gICAgICAgIHN0YXR1czogJ2FwcHJvdmVkJyBhcyBjb25zdCwgLy8gRGVmYXVsdCBzdGF0dXMgc2luY2UgUmV2aWV3IG1vZGVsIGRvZXNuJ3QgaGF2ZSB0aGlzIGZpZWxkXG4gICAgICAgIGNhdGVnb3JpZXM6IHtcbiAgICAgICAgICBjb21tdW5pY2F0aW9uOiB1bmRlZmluZWQsXG4gICAgICAgICAgcHJvZmVzc2lvbmFsaXNtOiB1bmRlZmluZWQsXG4gICAgICAgICAgaGVscGZ1bG5lc3M6IHVuZGVmaW5lZCxcbiAgICAgICAgICBhdmFpbGFiaWxpdHk6IHVuZGVmaW5lZCxcbiAgICAgICAgICBvdmVyYWxsOiByZXZpZXcucmF0aW5nLCAvLyBVc2Ugb3ZlcmFsbCByYXRpbmcgYXMgZmFsbGJhY2tcbiAgICAgICAgfSxcbiAgICAgICAgdGFnczogW10sIC8vIERlZmF1bHQgZW1wdHkgYXJyYXkgc2luY2UgdGFncyBhcmUgbm90IGluIGN1cnJlbnQgUmV2aWV3IG1vZGVsXG4gICAgICAgIHdvdWxkUmVjb21tZW5kOiByZXZpZXcucmF0aW5nID49IDQsIC8vIEluZmVyIHJlY29tbWVuZGF0aW9uIGZyb20gcmF0aW5nXG4gICAgICAgIGhlbHBmdWxDb3VudDogMCwgLy8gRGVmYXVsdCBjb3VudCBzaW5jZSBSZXZpZXcgbW9kZWwgZG9lc24ndCBoYXZlIHRoaXMgZmllbGRcbiAgICAgICAgY3JlYXRlZEF0OiByZXZpZXcuY3JlYXRlZEF0LnRvSVNPU3RyaW5nKCksXG4gICAgICAgIHVwZGF0ZWRBdDogcmV2aWV3LnVwZGF0ZWRBdC50b0lTT1N0cmluZygpLFxuICAgICAgICBjbGllbnQ6IHJldmlldy5jbGllbnRcbiAgICAgICAgICA/IHtcbiAgICAgICAgICAgICAgaWQ6IHJldmlldy5jbGllbnRJZCxcbiAgICAgICAgICAgICAgZmlyc3ROYW1lOiByZXZpZXcuY2xpZW50LnVzZXI/LmZpcnN0TmFtZSxcbiAgICAgICAgICAgICAgbGFzdE5hbWU6IHJldmlldy5jbGllbnQudXNlcj8ubGFzdE5hbWUsXG4gICAgICAgICAgICB9XG4gICAgICAgICAgOiB1bmRlZmluZWQsXG4gICAgICAgIHRoZXJhcGlzdDoge1xuICAgICAgICAgIGlkOiByZXZpZXcudGhlcmFwaXN0SWQsXG4gICAgICAgICAgdXNlcjoge1xuICAgICAgICAgICAgZmlyc3ROYW1lOiByZXZpZXcudGhlcmFwaXN0Py51c2VyPy5maXJzdE5hbWUgfHwgJycsXG4gICAgICAgICAgICBsYXN0TmFtZTogcmV2aWV3LnRoZXJhcGlzdD8udXNlcj8ubGFzdE5hbWUgfHwgJycsXG4gICAgICAgICAgICBhdmF0YXJVcmw6IHJldmlldy50aGVyYXBpc3Q/LnVzZXI/LmF2YXRhclVybCB8fCB1bmRlZmluZWQsXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgIH0pKSxcbiAgICAgIHRvdGFsQ291bnQsXG4gICAgICBwYWdlLFxuICAgICAgcGFnZVNpemU6IGxpbWl0LFxuICAgICAgdG90YWxQYWdlcyxcbiAgICAgIGF2ZXJhZ2VSYXRpbmcsXG4gICAgICByYXRpbmdEaXN0cmlidXRpb24sXG4gICAgfTtcbiAgfVxuXG4gIGFzeW5jIGdldFRoZXJhcGlzdFJldmlld3MoXG4gICAgdGhlcmFwaXN0SWQ6IHN0cmluZyxcbiAgICBxdWVyeTogT21pdDxHZXRSZXZpZXdzRHRvLCAndGhlcmFwaXN0SWQnPixcbiAgKTogUHJvbWlzZTxSZXZpZXdMaXN0UmVzcG9uc2U+IHtcbiAgICByZXR1cm4gdGhpcy5nZXRSZXZpZXdzKHsgLi4ucXVlcnksIHRoZXJhcGlzdElkIH0pO1xuICB9XG5cbiAgYXN5bmMgZ2V0UmV2aWV3U3RhdHModGhlcmFwaXN0SWQ6IHN0cmluZyk6IFByb21pc2U8UmV2aWV3U3RhdHNEdG8+IHtcbiAgICBjb25zdCBzdGF0cyA9IGF3YWl0IHRoaXMucHJpc21hLnJldmlldy5ncm91cEJ5KHtcbiAgICAgIGJ5OiBbJ3JhdGluZyddLFxuICAgICAgd2hlcmU6IHtcbiAgICAgICAgdGhlcmFwaXN0SWQsXG4gICAgICB9LFxuICAgICAgX2NvdW50OiB7XG4gICAgICAgIHJhdGluZzogdHJ1ZSxcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICBjb25zdCB0b3RhbFJldmlld3MgPSBzdGF0cy5yZWR1Y2UoXG4gICAgICAoc3VtLCBzdGF0KSA9PiBzdW0gKyBzdGF0Ll9jb3VudC5yYXRpbmcsXG4gICAgICAwLFxuICAgICk7XG4gICAgY29uc3QgdG90YWxSYXRpbmcgPSBzdGF0cy5yZWR1Y2UoXG4gICAgICAoc3VtLCBzdGF0KSA9PiBzdW0gKyBzdGF0LnJhdGluZyAqIHN0YXQuX2NvdW50LnJhdGluZyxcbiAgICAgIDAsXG4gICAgKTtcbiAgICBjb25zdCBhdmVyYWdlUmF0aW5nID0gdG90YWxSZXZpZXdzID4gMCA/IHRvdGFsUmF0aW5nIC8gdG90YWxSZXZpZXdzIDogMDtcblxuICAgIGNvbnN0IHJhdGluZ0Rpc3RyaWJ1dGlvbiA9IHtcbiAgICAgICcxJzogMCxcbiAgICAgICcyJzogMCxcbiAgICAgICczJzogMCxcbiAgICAgICc0JzogMCxcbiAgICAgICc1JzogMCxcbiAgICB9O1xuXG4gICAgc3RhdHMuZm9yRWFjaCgoc3RhdCkgPT4ge1xuICAgICAgcmF0aW5nRGlzdHJpYnV0aW9uW3N0YXQucmF0aW5nLnRvU3RyaW5nKCldID0gc3RhdC5fY291bnQucmF0aW5nO1xuICAgIH0pO1xuXG4gICAgLy8gR2V0IG1vbnRobHkgcmV2aWV3cyBmb3IgdGhlIGxhc3QgMTIgbW9udGhzXG4gICAgY29uc3QgdHdlbHZlTW9udGhzQWdvID0gbmV3IERhdGUoKTtcbiAgICB0d2VsdmVNb250aHNBZ28uc2V0TW9udGgodHdlbHZlTW9udGhzQWdvLmdldE1vbnRoKCkgLSAxMik7XG5cbiAgICBjb25zdCBtb250aGx5U3RhdHMgPSBhd2FpdCB0aGlzLnByaXNtYS5yZXZpZXcuZ3JvdXBCeSh7XG4gICAgICBieTogWydjcmVhdGVkQXQnXSxcbiAgICAgIHdoZXJlOiB7XG4gICAgICAgIHRoZXJhcGlzdElkLFxuICAgICAgICBjcmVhdGVkQXQ6IHtcbiAgICAgICAgICBndGU6IHR3ZWx2ZU1vbnRoc0FnbyxcbiAgICAgICAgfSxcbiAgICAgIH0sXG4gICAgICBfY291bnQ6IHtcbiAgICAgICAgcmF0aW5nOiB0cnVlLFxuICAgICAgfSxcbiAgICAgIF9hdmc6IHtcbiAgICAgICAgcmF0aW5nOiB0cnVlLFxuICAgICAgfSxcbiAgICB9KTtcblxuICAgIC8vIEdyb3VwIGJ5IG1vbnRoXG4gICAgY29uc3QgbW9udGhseVJldmlld3MgPSBtb250aGx5U3RhdHMucmVkdWNlKFxuICAgICAgKGFjYywgc3RhdCkgPT4ge1xuICAgICAgICBjb25zdCBtb250aCA9IHN0YXQuY3JlYXRlZEF0LnRvSVNPU3RyaW5nKCkuc3Vic3RyaW5nKDAsIDcpOyAvLyBZWVlZLU1NIGZvcm1hdFxuICAgICAgICBpZiAoIWFjY1ttb250aF0pIHtcbiAgICAgICAgICBhY2NbbW9udGhdID0geyBjb3VudDogMCwgdG90YWxSYXRpbmc6IDAgfTtcbiAgICAgICAgfVxuICAgICAgICBhY2NbbW9udGhdLmNvdW50ICs9IHN0YXQuX2NvdW50LnJhdGluZztcbiAgICAgICAgYWNjW21vbnRoXS50b3RhbFJhdGluZyArPSAoc3RhdC5fYXZnLnJhdGluZyB8fCAwKSAqIHN0YXQuX2NvdW50LnJhdGluZztcbiAgICAgICAgcmV0dXJuIGFjYztcbiAgICAgIH0sXG4gICAgICB7fSBhcyBSZWNvcmQ8c3RyaW5nLCB7IGNvdW50OiBudW1iZXI7IHRvdGFsUmF0aW5nOiBudW1iZXIgfT4sXG4gICAgKTtcblxuICAgIGNvbnN0IG1vbnRobHlSZXZpZXdzQXJyYXkgPSBPYmplY3QuZW50cmllcyhtb250aGx5UmV2aWV3cykubWFwKFxuICAgICAgKFttb250aCwgZGF0YV0pID0+ICh7XG4gICAgICAgIG1vbnRoLFxuICAgICAgICBjb3VudDogZGF0YS5jb3VudCxcbiAgICAgICAgYXZlcmFnZVJhdGluZzogZGF0YS5jb3VudCA+IDAgPyBkYXRhLnRvdGFsUmF0aW5nIC8gZGF0YS5jb3VudCA6IDAsXG4gICAgICB9KSxcbiAgICApO1xuXG4gICAgLy8gR2V0IHJlY2VudCByZXZpZXdzXG4gICAgY29uc3QgcmVjZW50UmV2aWV3cyA9IGF3YWl0IHRoaXMucHJpc21hLnJldmlldy5maW5kTWFueSh7XG4gICAgICB3aGVyZToge1xuICAgICAgICB0aGVyYXBpc3RJZCxcbiAgICAgIH0sXG4gICAgICBvcmRlckJ5OiB7XG4gICAgICAgIGNyZWF0ZWRBdDogJ2Rlc2MnLFxuICAgICAgfSxcbiAgICAgIHRha2U6IDUsXG4gICAgICBpbmNsdWRlOiB7XG4gICAgICAgIGNsaWVudDoge1xuICAgICAgICAgIHNlbGVjdDoge1xuICAgICAgICAgICAgdXNlcjoge1xuICAgICAgICAgICAgICBzZWxlY3Q6IHtcbiAgICAgICAgICAgICAgICBmaXJzdE5hbWU6IHRydWUsXG4gICAgICAgICAgICAgICAgbGFzdE5hbWU6IHRydWUsXG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIHRvdGFsUmV2aWV3cyxcbiAgICAgIGF2ZXJhZ2VSYXRpbmc6IE1hdGgucm91bmQoYXZlcmFnZVJhdGluZyAqIDEwMCkgLyAxMDAsXG4gICAgICByYXRpbmdEaXN0cmlidXRpb24sXG4gICAgICBjYXRlZ29yeUF2ZXJhZ2VzOiB7XG4gICAgICAgIGNvbW11bmljYXRpb246IHVuZGVmaW5lZCxcbiAgICAgICAgcHJvZmVzc2lvbmFsaXNtOiB1bmRlZmluZWQsXG4gICAgICAgIGhlbHBmdWxuZXNzOiB1bmRlZmluZWQsXG4gICAgICAgIGF2YWlsYWJpbGl0eTogdW5kZWZpbmVkLFxuICAgICAgICBvdmVyYWxsOiBhdmVyYWdlUmF0aW5nLFxuICAgICAgfSxcbiAgICAgIHJlY29tbWVuZGF0aW9uUmF0ZTogdG90YWxSZXZpZXdzID4gMCA/IFxuICAgICAgICAoc3RhdHMuZmlsdGVyKHMgPT4gcy5yYXRpbmcgPj0gNCkucmVkdWNlKChzdW0sIHMpID0+IHN1bSArIHMuX2NvdW50LnJhdGluZywgMCkgLyB0b3RhbFJldmlld3MpICogMTAwIDogMCxcbiAgICAgIHRvdGFsSGVscGZ1bFZvdGVzOiAwLCAvLyBEZWZhdWx0IHNpbmNlIFJldmlldyBtb2RlbCBkb2Vzbid0IGhhdmUgaGVscGZ1bCB2b3Rlc1xuICAgICAgcmVjZW50UmV2aWV3czogcmVjZW50UmV2aWV3cy5tYXAoKHJldmlldykgPT4gKHtcbiAgICAgICAgaWQ6IHJldmlldy5pZCxcbiAgICAgICAgcmF0aW5nOiByZXZpZXcucmF0aW5nLFxuICAgICAgICB0aXRsZTogcmV2aWV3LnRpdGxlIHx8IHVuZGVmaW5lZCxcbiAgICAgICAgY29udGVudDogcmV2aWV3LmNvbnRlbnQgfHwgdW5kZWZpbmVkLFxuICAgICAgICB0aGVyYXBpc3RJZDogcmV2aWV3LnRoZXJhcGlzdElkLFxuICAgICAgICBjbGllbnRJZDogcmV2aWV3LmNsaWVudElkLFxuICAgICAgICBtZWV0aW5nSWQ6IHJldmlldy5tZWV0aW5nSWQgfHwgdW5kZWZpbmVkLFxuICAgICAgICBpc0Fub255bW91czogcmV2aWV3LmlzQW5vbnltb3VzLFxuICAgICAgICBzdGF0dXM6ICdhcHByb3ZlZCcgYXMgY29uc3QsIC8vIERlZmF1bHQgc3RhdHVzIHNpbmNlIFJldmlldyBtb2RlbCBkb2Vzbid0IGhhdmUgdGhpcyBmaWVsZFxuICAgICAgICBjYXRlZ29yaWVzOiB7XG4gICAgICAgICAgY29tbXVuaWNhdGlvbjogdW5kZWZpbmVkLFxuICAgICAgICAgIHByb2Zlc3Npb25hbGlzbTogdW5kZWZpbmVkLFxuICAgICAgICAgIGhlbHBmdWxuZXNzOiB1bmRlZmluZWQsXG4gICAgICAgICAgYXZhaWxhYmlsaXR5OiB1bmRlZmluZWQsXG4gICAgICAgICAgb3ZlcmFsbDogcmV2aWV3LnJhdGluZywgLy8gVXNlIG92ZXJhbGwgcmF0aW5nIGFzIGZhbGxiYWNrXG4gICAgICAgIH0sXG4gICAgICAgIHRhZ3M6IFtdLCAvLyBEZWZhdWx0IGVtcHR5IGFycmF5IHNpbmNlIHRhZ3MgYXJlIG5vdCBpbiBjdXJyZW50IFJldmlldyBtb2RlbFxuICAgICAgICB3b3VsZFJlY29tbWVuZDogcmV2aWV3LnJhdGluZyA+PSA0LCAvLyBJbmZlciByZWNvbW1lbmRhdGlvbiBmcm9tIHJhdGluZ1xuICAgICAgICBoZWxwZnVsQ291bnQ6IDAsIC8vIERlZmF1bHQgY291bnQgc2luY2UgUmV2aWV3IG1vZGVsIGRvZXNuJ3QgaGF2ZSB0aGlzIGZpZWxkXG4gICAgICAgIGNyZWF0ZWRBdDogcmV2aWV3LmNyZWF0ZWRBdC50b0lTT1N0cmluZygpLFxuICAgICAgICB1cGRhdGVkQXQ6IHJldmlldy51cGRhdGVkQXQudG9JU09TdHJpbmcoKSxcbiAgICAgICAgY2xpZW50OiByZXZpZXcuY2xpZW50XG4gICAgICAgICAgPyB7XG4gICAgICAgICAgICAgIGlkOiByZXZpZXcuY2xpZW50SWQsXG4gICAgICAgICAgICAgIGZpcnN0TmFtZTogcmV2aWV3LmNsaWVudC51c2VyPy5maXJzdE5hbWUsXG4gICAgICAgICAgICAgIGxhc3ROYW1lOiByZXZpZXcuY2xpZW50LnVzZXI/Lmxhc3ROYW1lLFxuICAgICAgICAgICAgfVxuICAgICAgICAgIDogdW5kZWZpbmVkLFxuICAgICAgICB0aGVyYXBpc3Q6IHtcbiAgICAgICAgICBpZDogcmV2aWV3LnRoZXJhcGlzdElkLFxuICAgICAgICAgIHVzZXI6IHtcbiAgICAgICAgICAgIGZpcnN0TmFtZTogJycsXG4gICAgICAgICAgICBsYXN0TmFtZTogJycsXG4gICAgICAgICAgICBhdmF0YXJVcmw6IHVuZGVmaW5lZCxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgfSkpLFxuICAgIH07XG4gIH1cblxuICBhc3luYyBtYXJrUmV2aWV3SGVscGZ1bChyZXZpZXdJZDogc3RyaW5nLCB1c2VySWQ6IHN0cmluZykge1xuICAgIC8vIFZlcmlmeSByZXZpZXcgZXhpc3RzXG4gICAgY29uc3QgcmV2aWV3ID0gYXdhaXQgdGhpcy5wcmlzbWEucmV2aWV3LmZpbmRVbmlxdWUoe1xuICAgICAgd2hlcmU6IHsgaWQ6IHJldmlld0lkIH0sXG4gICAgfSk7XG5cbiAgICBpZiAoIXJldmlldykge1xuICAgICAgdGhyb3cgbmV3IE5vdEZvdW5kRXhjZXB0aW9uKCdSZXZpZXcgbm90IGZvdW5kJyk7XG4gICAgfVxuXG4gICAgLy8gRm9yIG5vdywgcmV0dXJuIGEgc2ltcGxlIHJlc3BvbnNlIHNpbmNlIHRoZSBSZXZpZXcgbW9kZWwgZG9lc24ndCBoYXZlIGhlbHBmdWxDb3VudFxuICAgIC8vIFRoaXMgbWV0aG9kIHdvdWxkIHR5cGljYWxseSB0cmFjayB1c2VycyB3aG8gbWFya2VkIHJldmlld3MgYXMgaGVscGZ1bFxuICAgIHJldHVybiB7XG4gICAgICBtZXNzYWdlOiAnUmV2aWV3IG1hcmtlZCBhcyBoZWxwZnVsJyxcbiAgICAgIHJldmlld0lkLFxuICAgICAgaGVscGZ1bENvdW50OiAxLCAvLyBQbGFjZWhvbGRlciB2YWx1ZVxuICAgIH07XG4gIH1cblxuICBhc3luYyBtb2RlcmF0ZVJldmlldyhcbiAgICByZXZpZXdJZDogc3RyaW5nLFxuICAgIG1vZGVyYXRvcklkOiBzdHJpbmcsXG4gICAgbW9kZXJhdGVSZXZpZXdEdG86IE1vZGVyYXRlUmV2aWV3RHRvLFxuICApIHtcbiAgICAvLyBWZXJpZnkgcmV2aWV3IGV4aXN0c1xuICAgIGNvbnN0IHJldmlldyA9IGF3YWl0IHRoaXMucHJpc21hLnJldmlldy5maW5kVW5pcXVlKHtcbiAgICAgIHdoZXJlOiB7IGlkOiByZXZpZXdJZCB9LFxuICAgIH0pO1xuXG4gICAgaWYgKCFyZXZpZXcpIHtcbiAgICAgIHRocm93IG5ldyBOb3RGb3VuZEV4Y2VwdGlvbignUmV2aWV3IG5vdCBmb3VuZCcpO1xuICAgIH1cblxuICAgIC8vIEZvciBub3csIHJldHVybiBhIHNpbXBsZSByZXNwb25zZSBzaW5jZSB0aGUgUmV2aWV3IG1vZGVsIGRvZXNuJ3QgaGF2ZSBtb2RlcmF0aW9uIGZpZWxkc1xuICAgIC8vIFRoaXMgbWV0aG9kIHdvdWxkIHR5cGljYWxseSB1cGRhdGUgcmV2aWV3IHN0YXR1cyBhbmQgYWRkIG1vZGVyYXRpb24gbm90ZXNcbiAgICByZXR1cm4ge1xuICAgICAgbWVzc2FnZTogJ1JldmlldyBtb2RlcmF0ZWQgc3VjY2Vzc2Z1bGx5JyxcbiAgICAgIHJldmlld0lkLFxuICAgICAgbW9kZXJhdGVkQnk6IG1vZGVyYXRvcklkLFxuICAgICAgc3RhdHVzOiBtb2RlcmF0ZVJldmlld0R0by5zdGF0dXMgfHwgJ0FQUFJPVkVEJyxcbiAgICAgIG1vZGVyYXRpb25Ob3RlOiBtb2RlcmF0ZVJldmlld0R0by5tb2RlcmF0b3JOb3RlcyxcbiAgICB9O1xuICB9XG59XG4iXSwidmVyc2lvbiI6M30=