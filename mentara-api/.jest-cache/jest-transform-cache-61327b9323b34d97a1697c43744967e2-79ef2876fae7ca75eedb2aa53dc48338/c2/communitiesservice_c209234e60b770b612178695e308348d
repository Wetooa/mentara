d4ebd72826b5d88f59b66122d7910c58
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
exports.CommunitiesService = void 0;
const common_1 = require("@nestjs/common");
const prisma_client_provider_1 = require("src/providers/prisma-client.provider");
let CommunitiesService = class CommunitiesService {
    prisma;
    constructor(prisma) {
        this.prisma = prisma;
    }
    async findAllWithStructure() {
        return await this.prisma.community.findMany({
            orderBy: { createdAt: 'desc' },
            include: {
                roomGroups: {
                    include: {
                        rooms: true,
                    },
                },
            },
        });
    }
    async findOneWithStructure(id) {
        return await this.prisma.community.findUniqueOrThrow({
            where: { id },
            include: {
                roomGroups: {
                    include: {
                        rooms: true,
                    },
                },
            },
        });
    }
    async createRoomGroup(communityId, name, order) {
        try {
            return await this.prisma.roomGroup.create({
                data: {
                    name,
                    order,
                    community: {
                        connect: {
                            id: communityId,
                        },
                    },
                },
            });
        }
        catch (error) {
            throw new common_1.ConflictException(error instanceof Error ? error.message : String(error));
        }
    }
    async createRoom(roomGroupId, name, order) {
        return await this.prisma.room.create({
            data: {
                name,
                order,
                roomGroupId,
            },
        });
    }
    async findRoomsByGroup(roomGroupId) {
        return await this.prisma.room.findMany({
            where: { roomGroupId },
            orderBy: { order: 'asc' },
        });
    }
    async findAll() {
        const communities = await this.prisma.community.findMany({
            orderBy: { createdAt: 'desc' },
        });
        return communities.map((community) => community);
    }
    async findOne(id) {
        const community = await this.prisma.community.findUnique({
            where: { id },
        });
        if (!community)
            return null;
        return community;
    }
    async findBySlug(slug) {
        const community = await this.prisma.community.findUnique({
            where: { slug },
        });
        if (!community)
            return null;
        return community;
    }
    async createCommunity(data) {
        const community = await this.prisma.community.create({
            data: {
                name: data.name,
                slug: data.slug ||
                    data.name?.toLowerCase().replace(/\s+/g, '-') ||
                    'untitled',
                description: data.description,
                imageUrl: data.imageUrl || null,
            },
        });
        return community;
    }
    async update(id, data) {
        const community = await this.prisma.community.update({
            where: { id },
            data: {
                name: data.name,
                slug: data.slug ||
                    data.name?.toLowerCase().replace(/\s+/g, '-') ||
                    'untitled',
                description: data.description,
                imageUrl: data.imageUrl || null,
            },
        });
        return community;
    }
    async remove(id) {
        const community = await this.prisma.community.delete({
            where: { id },
        });
        return community;
    }
    async findByUserId(userId) {
        const memberships = await this.prisma.membership.findMany({
            where: { userId },
            include: {
                community: true,
            },
        });
        return memberships.map((membership) => membership.community);
    }
    async joinCommunity(communityId, userId, role = 'MEMBER') {
        const existingMembership = await this.prisma.membership.findFirst({
            where: {
                communityId,
                userId,
            },
        });
        if (existingMembership) {
            throw new common_1.ConflictException('User is already a member of this community');
        }
        await this.prisma.membership.create({
            data: {
                userId,
                communityId,
            },
        });
    }
    async leaveCommunity(communityId, userId) {
        const membership = await this.prisma.membership.findFirstOrThrow({
            where: {
                communityId,
                userId,
            },
        });
        await this.prisma.membership.delete({
            where: { id: membership.id },
        });
    }
    async getMembers(communityId, limit = 50, offset = 0) {
        const community = await this.prisma.community.findUnique({
            where: { id: communityId },
            include: {
                memberships: {
                    skip: offset,
                    take: limit,
                    include: {
                        user: {
                            select: {
                                id: true,
                                firstName: true,
                                lastName: true,
                                avatarUrl: true,
                            },
                        },
                    },
                    orderBy: { joinedAt: 'desc' },
                },
            },
        });
        if (!community) {
            throw new common_1.NotFoundException('Community not found');
        }
        return {
            ...community,
            members: community.memberships
                .filter((membership) => membership.userId !== null && membership.user !== null)
                .map((membership) => ({
                ...membership,
                userId: membership.userId,
                user: membership.user,
            })),
        };
    }
    async getStats() {
        const [totalMembers, totalPosts, activeCommunities] = await Promise.all([
            this.prisma.membership.count(),
            this.prisma.post.count(),
            this.prisma.community.count(),
        ]);
        return {
            totalMembers,
            totalPosts,
            activeCommunities,
            illnessCommunities: [],
        };
    }
    // New methods for community posts and content management
    async getMyMemberships(userId) {
        return await this.prisma.membership.findMany({
            where: { userId },
            include: {
                community: {
                    select: {
                        id: true,
                        name: true,
                        slug: true,
                        description: true,
                        imageUrl: true,
                    },
                },
            },
            orderBy: { joinedAt: 'desc' },
        });
    }
    async getPostsByRoom(roomId, page = 1, limit = 20) {
        const skip = (page - 1) * limit;
        const [posts, total] = await Promise.all([
            this.prisma.post.findMany({
                where: { roomId },
                include: {
                    user: {
                        select: {
                            id: true,
                            firstName: true,
                            lastName: true,
                            avatarUrl: true,
                        },
                    },
                    hearts: {
                        select: {
                            id: true,
                            userId: true,
                            postId: true,
                        },
                    },
                    _count: {
                        select: {
                            hearts: true,
                            comments: true,
                        },
                    },
                },
                orderBy: { createdAt: 'desc' },
                skip,
                take: limit,
            }),
            this.prisma.post.count({ where: { roomId } }),
        ]);
        return {
            posts,
            pagination: {
                total,
                page,
                limit,
            },
        };
    }
    async createPost(title, content, roomId, userId, attachmentUrls = [], attachmentNames = [], attachmentSizes = []) {
        // First verify the room exists and user has access
        const room = await this.prisma.room.findUniqueOrThrow({
            where: { id: roomId },
            include: {
                roomGroup: {
                    include: {
                        community: {
                            include: {
                                memberships: {
                                    where: { userId },
                                },
                            },
                        },
                    },
                },
            },
        });
        // Check if user is a member of the community
        if (room.roomGroup.community.memberships.length === 0) {
            throw new common_1.ConflictException('User is not a member of this community');
        }
        // Check posting permissions based on room posting role
        const user = await this.prisma.user.findUniqueOrThrow({
            where: { id: userId },
            select: { role: true },
        });
        const canPost = this.checkPostingPermission(room.postingRole, user.role);
        if (!canPost) {
            throw new common_1.ConflictException('User does not have permission to post in this room');
        }
        return await this.prisma.post.create({
            data: {
                title,
                content,
                roomId,
                userId,
                attachmentUrls,
                attachmentNames,
                attachmentSizes,
            },
            include: {
                user: {
                    select: {
                        id: true,
                        firstName: true,
                        lastName: true,
                        avatarUrl: true,
                    },
                },
                hearts: {
                    select: {
                        id: true,
                        userId: true,
                        postId: true,
                    },
                },
                _count: {
                    select: {
                        hearts: true,
                        comments: true,
                    },
                },
            },
        });
    }
    checkPostingPermission(roomPostingRole, userRole) {
        const roleHierarchy = {
            'client': 0,
            'therapist': 1,
            'moderator': 2,
            'admin': 3,
        };
        const userRoleLevel = roleHierarchy[userRole] ?? 0;
        switch (roomPostingRole) {
            case 'member':
                return userRoleLevel >= 0;
            case 'therapist':
                return userRoleLevel >= 1;
            case 'moderator':
                return userRoleLevel >= 2;
            case 'admin':
                return userRoleLevel >= 3;
            default:
                return userRoleLevel >= 0;
        }
    }
    async heartPost(postId, userId) {
        // Check if heart already exists
        const existingHeart = await this.prisma.postHeart.findUnique({
            where: {
                postId_userId: {
                    postId,
                    userId,
                },
            },
        });
        if (existingHeart) {
            throw new common_1.ConflictException('Post already hearted by this user');
        }
        return await this.prisma.postHeart.create({
            data: {
                postId,
                userId,
            },
        });
    }
    async unheartPost(postId, userId) {
        const heart = await this.prisma.postHeart.findUnique({
            where: {
                postId_userId: {
                    postId,
                    userId,
                },
            },
        });
        if (!heart) {
            throw new common_1.NotFoundException('Heart not found');
        }
        return await this.prisma.postHeart.delete({
            where: {
                postId_userId: {
                    postId,
                    userId,
                },
            },
        });
    }
    async getJoinedCommunities(userId) {
        const memberships = await this.prisma.membership.findMany({
            where: { userId },
            include: {
                community: {
                    include: {
                        roomGroups: {
                            include: {
                                rooms: true,
                            },
                            orderBy: { order: 'asc' },
                        },
                    },
                },
            },
            orderBy: { joinedAt: 'desc' },
        });
        return memberships.map(membership => membership.community);
    }
    async getRecommendedCommunities(userId) {
        // For now, return communities the user is not yet a member of
        // This can be enhanced with actual recommendation logic later
        const userCommunityIds = await this.prisma.membership.findMany({
            where: { userId },
            select: { communityId: true },
        });
        const excludeIds = userCommunityIds.map(m => m.communityId);
        return await this.prisma.community.findMany({
            where: {
                id: {
                    notIn: excludeIds,
                },
            },
            include: {
                roomGroups: {
                    include: {
                        rooms: true,
                    },
                    orderBy: { order: 'asc' },
                },
            },
            take: 5,
            orderBy: { createdAt: 'desc' },
        });
    }
    async getRecentActivity(userId) {
        // Get recent posts from communities the user is a member of
        const userCommunityIds = await this.prisma.membership.findMany({
            where: { userId },
            select: { communityId: true },
        });
        const communityIds = userCommunityIds.map(m => m.communityId);
        const recentPosts = await this.prisma.post.findMany({
            where: {
                room: {
                    roomGroup: {
                        communityId: {
                            in: communityIds,
                        },
                    },
                },
            },
            include: {
                user: {
                    select: {
                        id: true,
                        firstName: true,
                        lastName: true,
                        avatarUrl: true,
                    },
                },
                room: {
                    include: {
                        roomGroup: {
                            include: {
                                community: {
                                    select: {
                                        id: true,
                                        name: true,
                                    },
                                },
                            },
                        },
                    },
                },
                _count: {
                    select: {
                        hearts: true,
                        comments: true,
                    },
                },
            },
            orderBy: { createdAt: 'desc' },
            take: 10,
        });
        return recentPosts
            .filter(post => post.room) // Filter out posts without rooms
            .map(post => ({
            type: 'post',
            id: post.id,
            title: post.title,
            content: post.content,
            createdAt: post.createdAt,
            user: post.user,
            community: post.room.roomGroup.community,
            _count: post._count,
        }));
    }
};
exports.CommunitiesService = CommunitiesService;
exports.CommunitiesService = CommunitiesService = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [typeof (_a = typeof prisma_client_provider_1.PrismaService !== "undefined" && prisma_client_provider_1.PrismaService) === "function" ? _a : Object])
], CommunitiesService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL2NvbW11bml0aWVzL2NvbW11bml0aWVzLnNlcnZpY2UudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7OztBQUFBLDJDQUl3QjtBQUN4QixpRkFBcUU7QUErQjlELElBQU0sa0JBQWtCLEdBQXhCLE1BQU0sa0JBQWtCO0lBQ0E7SUFBN0IsWUFBNkIsTUFBcUI7UUFBckIsV0FBTSxHQUFOLE1BQU0sQ0FBZTtJQUFHLENBQUM7SUFFdEQsS0FBSyxDQUFDLG9CQUFvQjtRQUN4QixPQUFPLE1BQU0sSUFBSSxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDO1lBQzFDLE9BQU8sRUFBRSxFQUFFLFNBQVMsRUFBRSxNQUFNLEVBQUU7WUFDOUIsT0FBTyxFQUFFO2dCQUNQLFVBQVUsRUFBRTtvQkFDVixPQUFPLEVBQUU7d0JBQ1AsS0FBSyxFQUFFLElBQUk7cUJBQ1o7aUJBQ0Y7YUFDRjtTQUNGLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFRCxLQUFLLENBQUMsb0JBQW9CLENBQ3hCLEVBQVU7UUFFVixPQUFPLE1BQU0sSUFBSSxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUMsaUJBQWlCLENBQUM7WUFDbkQsS0FBSyxFQUFFLEVBQUUsRUFBRSxFQUFFO1lBQ2IsT0FBTyxFQUFFO2dCQUNQLFVBQVUsRUFBRTtvQkFDVixPQUFPLEVBQUU7d0JBQ1AsS0FBSyxFQUFFLElBQUk7cUJBQ1o7aUJBQ0Y7YUFDRjtTQUNGLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFRCxLQUFLLENBQUMsZUFBZSxDQUNuQixXQUFtQixFQUNuQixJQUFZLEVBQ1osS0FBYTtRQUViLElBQUksQ0FBQztZQUNILE9BQU8sTUFBTSxJQUFJLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUM7Z0JBQ3hDLElBQUksRUFBRTtvQkFDSixJQUFJO29CQUNKLEtBQUs7b0JBQ0wsU0FBUyxFQUFFO3dCQUNULE9B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Q0FBQyxDQUFDO0lBQ1IsQ0FBQztDQUNGLENBQUE7QUFua0JZLGdEQUFrQjs2QkFBbEIsa0JBQWtCO0lBRDlCLElBQUEsbUJBQVUsR0FBRTt5REFFMEIsc0NBQWEsb0JBQWIsc0NBQWE7R0FEdkMsa0JBQWtCLENBbWtCOUIiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL2NvbW11bml0aWVzL2NvbW11bml0aWVzLnNlcnZpY2UudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgSW5qZWN0YWJsZSxcbiAgQ29uZmxpY3RFeGNlcHRpb24sXG4gIE5vdEZvdW5kRXhjZXB0aW9uLFxufSBmcm9tICdAbmVzdGpzL2NvbW1vbic7XG5pbXBvcnQgeyBQcmlzbWFTZXJ2aWNlIH0gZnJvbSAnc3JjL3Byb3ZpZGVycy9wcmlzbWEtY2xpZW50LnByb3ZpZGVyJztcbmltcG9ydCB7IFJvb21Hcm91cCwgUm9vbSB9IGZyb20gJ0BwcmlzbWEvY2xpZW50JztcbmltcG9ydCB0eXBlIHtcbiAgQ29tbXVuaXR5Q3JlYXRlSW5wdXREdG8sXG4gIENvbW11bml0eVVwZGF0ZUlucHV0RHRvLFxuICBDb21tdW5pdHlSZXNwb25zZSxcbiAgQ29tbXVuaXR5U3RhdHNSZXNwb25zZSxcbn0gZnJvbSAnLi90eXBlcyc7XG5cbi8vIEV4dGVuZGVkIHJlc3BvbnNlIGludGVyZmFjZXMgZm9yIGNvbXBsZXggb3BlcmF0aW9uc1xuZXhwb3J0IGludGVyZmFjZSBDb21tdW5pdHlXaXRoTWVtYmVyc1Jlc3BvbnNlIGV4dGVuZHMgQ29tbXVuaXR5UmVzcG9uc2Uge1xuICBtZW1iZXJzOiBhbnlbXTtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBDb21tdW5pdHlXaXRoUm9vbUdyb3Vwc1Jlc3BvbnNlIGV4dGVuZHMgQ29tbXVuaXR5UmVzcG9uc2Uge1xuICByb29tR3JvdXBzOiBBcnJheTx7XG4gICAgaWQ6IHN0cmluZztcbiAgICBuYW1lOiBzdHJpbmc7XG4gICAgb3JkZXI6IG51bWJlcjtcbiAgICBjb21tdW5pdHlJZDogc3RyaW5nO1xuICAgIHJvb21zOiBBcnJheTx7XG4gICAgICBpZDogc3RyaW5nO1xuICAgICAgbmFtZTogc3RyaW5nO1xuICAgICAgb3JkZXI6IG51bWJlcjtcbiAgICAgIHBvc3RpbmdSb2xlOiBzdHJpbmc7XG4gICAgICByb29tR3JvdXBJZDogc3RyaW5nO1xuICAgIH0+O1xuICB9Pjtcbn1cblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIENvbW11bml0aWVzU2VydmljZSB7XG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgcmVhZG9ubHkgcHJpc21hOiBQcmlzbWFTZXJ2aWNlKSB7fVxuXG4gIGFzeW5jIGZpbmRBbGxXaXRoU3RydWN0dXJlKCk6IFByb21pc2U8Q29tbXVuaXR5V2l0aFJvb21Hcm91cHNSZXNwb25zZVtdPiB7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMucHJpc21hLmNvbW11bml0eS5maW5kTWFueSh7XG4gICAgICBvcmRlckJ5OiB7IGNyZWF0ZWRBdDogJ2Rlc2MnIH0sXG4gICAgICBpbmNsdWRlOiB7XG4gICAgICAgIHJvb21Hcm91cHM6IHtcbiAgICAgICAgICBpbmNsdWRlOiB7XG4gICAgICAgICAgICByb29tczogdHJ1ZSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgfSxcbiAgICB9KTtcbiAgfVxuXG4gIGFzeW5jIGZpbmRPbmVXaXRoU3RydWN0dXJlKFxuICAgIGlkOiBzdHJpbmcsXG4gICk6IFByb21pc2U8Q29tbXVuaXR5V2l0aFJvb21Hcm91cHNSZXNwb25zZSB8IG51bGw+IHtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5wcmlzbWEuY29tbXVuaXR5LmZpbmRVbmlxdWVPclRocm93KHtcbiAgICAgIHdoZXJlOiB7IGlkIH0sXG4gICAgICBpbmNsdWRlOiB7XG4gICAgICAgIHJvb21Hcm91cHM6IHtcbiAgICAgICAgICBpbmNsdWRlOiB7XG4gICAgICAgICAgICByb29tczogdHJ1ZSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgfSxcbiAgICB9KTtcbiAgfVxuXG4gIGFzeW5jIGNyZWF0ZVJvb21Hcm91cChcbiAgICBjb21tdW5pdHlJZDogc3RyaW5nLFxuICAgIG5hbWU6IHN0cmluZyxcbiAgICBvcmRlcjogbnVtYmVyLFxuICApOiBQcm9taXNlPFJvb21Hcm91cD4ge1xuICAgIHRyeSB7XG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy5wcmlzbWEucm9vbUdyb3VwLmNyZWF0ZSh7XG4gICAgICAgIGRhdGE6IHtcbiAgICAgICAgICBuYW1lLFxuICAgICAgICAgIG9yZGVyLFxuICAgICAgICAgIGNvbW11bml0eToge1xuICAgICAgICAgICAgY29ubmVjdDoge1xuICAgICAgICAgICAgICBpZDogY29tbXVuaXR5SWQsXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICB9KTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhyb3cgbmV3IENvbmZsaWN0RXhjZXB0aW9uKFxuICAgICAgICBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6IFN0cmluZyhlcnJvciksXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGNyZWF0ZVJvb20oXG4gICAgcm9vbUdyb3VwSWQ6IHN0cmluZyxcbiAgICBuYW1lOiBzdHJpbmcsXG4gICAgb3JkZXI6IG51bWJlcixcbiAgKTogUHJvbWlzZTxSb29tPiB7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMucHJpc21hLnJvb20uY3JlYXRlKHtcbiAgICAgIGRhdGE6IHtcbiAgICAgICAgbmFtZSxcbiAgICAgICAgb3JkZXIsXG4gICAgICAgIHJvb21Hcm91cElkLFxuICAgICAgfSxcbiAgICB9KTtcbiAgfVxuXG4gIGFzeW5jIGZpbmRSb29tc0J5R3JvdXAocm9vbUdyb3VwSWQ6IHN0cmluZyk6IFByb21pc2U8Um9vbVtdPiB7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMucHJpc21hLnJvb20uZmluZE1hbnkoe1xuICAgICAgd2hlcmU6IHsgcm9vbUdyb3VwSWQgfSxcbiAgICAgIG9yZGVyQnk6IHsgb3JkZXI6ICdhc2MnIH0sXG4gICAgfSk7XG4gIH1cblxuICBhc3luYyBmaW5kQWxsKCk6IFByb21pc2U8Q29tbXVuaXR5UmVzcG9uc2VbXT4ge1xuICAgIGNvbnN0IGNvbW11bml0aWVzID0gYXdhaXQgdGhpcy5wcmlzbWEuY29tbXVuaXR5LmZpbmRNYW55KHtcbiAgICAgIG9yZGVyQnk6IHsgY3JlYXRlZEF0OiAnZGVzYycgfSxcbiAgICB9KTtcblxuICAgIHJldHVybiBjb21tdW5pdGllcy5tYXAoKGNvbW11bml0eSkgPT4gY29tbXVuaXR5KTtcbiAgfVxuXG4gIGFzeW5jIGZpbmRPbmUoaWQ6IHN0cmluZyk6IFByb21pc2U8Q29tbXVuaXR5UmVzcG9uc2UgfCBudWxsPiB7XG4gICAgY29uc3QgY29tbXVuaXR5ID0gYXdhaXQgdGhpcy5wcmlzbWEuY29tbXVuaXR5LmZpbmRVbmlxdWUoe1xuICAgICAgd2hlcmU6IHsgaWQgfSxcbiAgICB9KTtcbiAgICBpZiAoIWNvbW11bml0eSkgcmV0dXJuIG51bGw7XG4gICAgcmV0dXJuIGNvbW11bml0eTtcbiAgfVxuXG4gIGFzeW5jIGZpbmRCeVNsdWcoc2x1Zzogc3RyaW5nKTogUHJvbWlzZTxDb21tdW5pdHlSZXNwb25zZSB8IG51bGw+IHtcbiAgICBjb25zdCBjb21tdW5pdHkgPSBhd2FpdCB0aGlzLnByaXNtYS5jb21tdW5pdHkuZmluZFVuaXF1ZSh7XG4gICAgICB3aGVyZTogeyBzbHVnIH0sXG4gICAgfSk7XG4gICAgaWYgKCFjb21tdW5pdHkpIHJldHVybiBudWxsO1xuICAgIHJldHVybiBjb21tdW5pdHk7XG4gIH1cblxuICBhc3luYyBjcmVhdGVDb21tdW5pdHkoXG4gICAgZGF0YTogQ29tbXVuaXR5Q3JlYXRlSW5wdXREdG8sXG4gICk6IFByb21pc2U8Q29tbXVuaXR5UmVzcG9uc2U+IHtcbiAgICBjb25zdCBjb21tdW5pdHkgPSBhd2FpdCB0aGlzLnByaXNtYS5jb21tdW5pdHkuY3JlYXRlKHtcbiAgICAgIGRhdGE6IHtcbiAgICAgICAgbmFtZTogZGF0YS5uYW1lLFxuICAgICAgICBzbHVnOlxuICAgICAgICAgIChkYXRhIGFzIGFueSkuc2x1ZyB8fFxuICAgICAgICAgIGRhdGEubmFtZT8udG9Mb3dlckNhc2UoKS5yZXBsYWNlKC9cXHMrL2csICctJykgfHxcbiAgICAgICAgICAndW50aXRsZWQnLFxuICAgICAgICBkZXNjcmlwdGlvbjogZGF0YS5kZXNjcmlwdGlvbixcbiAgICAgICAgaW1hZ2VVcmw6IChkYXRhIGFzIGFueSkuaW1hZ2VVcmwgfHwgbnVsbCxcbiAgICAgIH0sXG4gICAgfSk7XG4gICAgcmV0dXJuIGNvbW11bml0eTtcbiAgfVxuXG4gIGFzeW5jIHVwZGF0ZShcbiAgICBpZDogc3RyaW5nLFxuICAgIGRhdGE6IENvbW11bml0eVVwZGF0ZUlucHV0RHRvLFxuICApOiBQcm9taXNlPENvbW11bml0eVJlc3BvbnNlPiB7XG4gICAgY29uc3QgY29tbXVuaXR5ID0gYXdhaXQgdGhpcy5wcmlzbWEuY29tbXVuaXR5LnVwZGF0ZSh7XG4gICAgICB3aGVyZTogeyBpZCB9LFxuICAgICAgZGF0YToge1xuICAgICAgICBuYW1lOiBkYXRhLm5hbWUsXG4gICAgICAgIHNsdWc6XG4gICAgICAgICAgKGRhdGEgYXMgYW55KS5zbHVnIHx8XG4gICAgICAgICAgZGF0YS5uYW1lPy50b0xvd2VyQ2FzZSgpLnJlcGxhY2UoL1xccysvZywgJy0nKSB8fFxuICAgICAgICAgICd1bnRpdGxlZCcsXG4gICAgICAgIGRlc2NyaXB0aW9uOiBkYXRhLmRlc2NyaXB0aW9uLFxuICAgICAgICBpbWFnZVVybDogKGRhdGEgYXMgYW55KS5pbWFnZVVybCB8fCBudWxsLFxuICAgICAgfSxcbiAgICB9KTtcbiAgICByZXR1cm4gY29tbXVuaXR5O1xuICB9XG5cbiAgYXN5bmMgcmVtb3ZlKGlkOiBzdHJpbmcpOiBQcm9taXNlPENvbW11bml0eVJlc3BvbnNlPiB7XG4gICAgY29uc3QgY29tbXVuaXR5ID0gYXdhaXQgdGhpcy5wcmlzbWEuY29tbXVuaXR5LmRlbGV0ZSh7XG4gICAgICB3aGVyZTogeyBpZCB9LFxuICAgIH0pO1xuICAgIHJldHVybiBjb21tdW5pdHk7XG4gIH1cblxuICBhc3luYyBmaW5kQnlVc2VySWQodXNlcklkOiBzdHJpbmcpOiBQcm9taXNlPENvbW11bml0eVJlc3BvbnNlW10+IHtcbiAgICBjb25zdCBtZW1iZXJzaGlwcyA9IGF3YWl0IHRoaXMucHJpc21hLm1lbWJlcnNoaXAuZmluZE1hbnkoe1xuICAgICAgd2hlcmU6IHsgdXNlcklkIH0sXG4gICAgICBpbmNsdWRlOiB7XG4gICAgICAgIGNvbW11bml0eTogdHJ1ZSxcbiAgICAgIH0sXG4gICAgfSk7XG4gICAgcmV0dXJuIG1lbWJlcnNoaXBzLm1hcCgobWVtYmVyc2hpcCkgPT4gbWVtYmVyc2hpcC5jb21tdW5pdHkpO1xuICB9XG5cbiAgYXN5bmMgam9pbkNvbW11bml0eShcbiAgICBjb21tdW5pdHlJZDogc3RyaW5nLFxuICAgIHVzZXJJZDogc3RyaW5nLFxuICAgIHJvbGU6IHN0cmluZyA9ICdNRU1CRVInLFxuICApOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBjb25zdCBleGlzdGluZ01lbWJlcnNoaXAgPSBhd2FpdCB0aGlzLnByaXNtYS5tZW1iZXJzaGlwLmZpbmRGaXJzdCh7XG4gICAgICB3aGVyZToge1xuICAgICAgICBjb21tdW5pdHlJZCxcbiAgICAgICAgdXNlcklkLFxuICAgICAgfSxcbiAgICB9KTtcblxuICAgIGlmIChleGlzdGluZ01lbWJlcnNoaXApIHtcbiAgICAgIHRocm93IG5ldyBDb25mbGljdEV4Y2VwdGlvbignVXNlciBpcyBhbHJlYWR5IGEgbWVtYmVyIG9mIHRoaXMgY29tbXVuaXR5Jyk7XG4gICAgfVxuXG4gICAgYXdhaXQgdGhpcy5wcmlzbWEubWVtYmVyc2hpcC5jcmVhdGUoe1xuICAgICAgZGF0YToge1xuICAgICAgICB1c2VySWQsXG4gICAgICAgIGNvbW11bml0eUlkLFxuICAgICAgfSxcbiAgICB9KTtcbiAgfVxuXG4gIGFzeW5jIGxlYXZlQ29tbXVuaXR5KGNvbW11bml0eUlkOiBzdHJpbmcsIHVzZXJJZDogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgY29uc3QgbWVtYmVyc2hpcCA9IGF3YWl0IHRoaXMucHJpc21hLm1lbWJlcnNoaXAuZmluZEZpcnN0T3JUaHJvdyh7XG4gICAgICB3aGVyZToge1xuICAgICAgICBjb21tdW5pdHlJZCxcbiAgICAgICAgdXNlcklkLFxuICAgICAgfSxcbiAgICB9KTtcbiAgICBhd2FpdCB0aGlzLnByaXNtYS5tZW1iZXJzaGlwLmRlbGV0ZSh7XG4gICAgICB3aGVyZTogeyBpZDogbWVtYmVyc2hpcC5pZCB9LFxuICAgIH0pO1xuICB9XG5cbiAgYXN5bmMgZ2V0TWVtYmVycyhcbiAgICBjb21tdW5pdHlJZDogc3RyaW5nLFxuICAgIGxpbWl0OiBudW1iZXIgPSA1MCxcbiAgICBvZmZzZXQ6IG51bWJlciA9IDAsXG4gICk6IFByb21pc2U8Q29tbXVuaXR5V2l0aE1lbWJlcnNSZXNwb25zZT4ge1xuICAgIGNvbnN0IGNvbW11bml0eSA9IGF3YWl0IHRoaXMucHJpc21hLmNvbW11bml0eS5maW5kVW5pcXVlKHtcbiAgICAgIHdoZXJlOiB7IGlkOiBjb21tdW5pdHlJZCB9LFxuICAgICAgaW5jbHVkZToge1xuICAgICAgICBtZW1iZXJzaGlwczoge1xuICAgICAgICAgIHNraXA6IG9mZnNldCxcbiAgICAgICAgICB0YWtlOiBsaW1pdCxcbiAgICAgICAgICBpbmNsdWRlOiB7XG4gICAgICAgICAgICB1c2VyOiB7XG4gICAgICAgICAgICAgIHNlbGVjdDoge1xuICAgICAgICAgICAgICAgIGlkOiB0cnVlLFxuICAgICAgICAgICAgICAgIGZpcnN0TmFtZTogdHJ1ZSxcbiAgICAgICAgICAgICAgICBsYXN0TmFtZTogdHJ1ZSxcbiAgICAgICAgICAgICAgICBhdmF0YXJVcmw6IHRydWUsXG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0sXG4gICAgICAgICAgb3JkZXJCeTogeyBqb2luZWRBdDogJ2Rlc2MnIH0sXG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgIH0pO1xuICAgIGlmICghY29tbXVuaXR5KSB7XG4gICAgICB0aHJvdyBuZXcgTm90Rm91bmRFeGNlcHRpb24oJ0NvbW11bml0eSBub3QgZm91bmQnKTtcbiAgICB9XG4gICAgcmV0dXJuIHtcbiAgICAgIC4uLmNvbW11bml0eSxcbiAgICAgIG1lbWJlcnM6IGNvbW11bml0eS5tZW1iZXJzaGlwc1xuICAgICAgICAuZmlsdGVyKFxuICAgICAgICAgIChtZW1iZXJzaGlwKSA9PlxuICAgICAgICAgICAgbWVtYmVyc2hpcC51c2VySWQgIT09IG51bGwgJiYgbWVtYmVyc2hpcC51c2VyICE9PSBudWxsLFxuICAgICAgICApXG4gICAgICAgIC5tYXAoKG1lbWJlcnNoaXApID0+ICh7XG4gICAgICAgICAgLi4ubWVtYmVyc2hpcCxcbiAgICAgICAgICB1c2VySWQ6IG1lbWJlcnNoaXAudXNlcklkISxcbiAgICAgICAgICB1c2VyOiBtZW1iZXJzaGlwLnVzZXIhLFxuICAgICAgICB9KSksXG4gICAgfTtcbiAgfVxuXG4gIGFzeW5jIGdldFN0YXRzKCk6IFByb21pc2U8Q29tbXVuaXR5U3RhdHNSZXNwb25zZT4ge1xuICAgIGNvbnN0IFt0b3RhbE1lbWJlcnMsIHRvdGFsUG9zdHMsIGFjdGl2ZUNvbW11bml0aWVzXSA9IGF3YWl0IFByb21pc2UuYWxsKFtcbiAgICAgIHRoaXMucHJpc21hLm1lbWJlcnNoaXAuY291bnQoKSxcbiAgICAgIHRoaXMucHJpc21hLnBvc3QuY291bnQoKSxcbiAgICAgIHRoaXMucHJpc21hLmNvbW11bml0eS5jb3VudCgpLFxuICAgIF0pO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIHRvdGFsTWVtYmVycyxcbiAgICAgIHRvdGFsUG9zdHMsXG4gICAgICBhY3RpdmVDb21tdW5pdGllcyxcbiAgICAgIGlsbG5lc3NDb21tdW5pdGllczogW10sXG4gICAgfTtcbiAgfVxuXG4gIC8vIE5ldyBtZXRob2RzIGZvciBjb21tdW5pdHkgcG9zdHMgYW5kIGNvbnRlbnQgbWFuYWdlbWVudFxuXG4gIGFzeW5jIGdldE15TWVtYmVyc2hpcHModXNlcklkOiBzdHJpbmcpIHtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5wcmlzbWEubWVtYmVyc2hpcC5maW5kTWFueSh7XG4gICAgICB3aGVyZTogeyB1c2VySWQgfSxcbiAgICAgIGluY2x1ZGU6IHtcbiAgICAgICAgY29tbXVuaXR5OiB7XG4gICAgICAgICAgc2VsZWN0OiB7XG4gICAgICAgICAgICBpZDogdHJ1ZSxcbiAgICAgICAgICAgIG5hbWU6IHRydWUsXG4gICAgICAgICAgICBzbHVnOiB0cnVlLFxuICAgICAgICAgICAgZGVzY3JpcHRpb246IHRydWUsXG4gICAgICAgICAgICBpbWFnZVVybDogdHJ1ZSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgfSxcbiAgICAgIG9yZGVyQnk6IHsgam9pbmVkQXQ6ICdkZXNjJyB9LFxuICAgIH0pO1xuICB9XG5cbiAgYXN5bmMgZ2V0UG9zdHNCeVJvb20ocm9vbUlkOiBzdHJpbmcsIHBhZ2U6IG51bWJlciA9IDEsIGxpbWl0OiBudW1iZXIgPSAyMCkge1xuICAgIGNvbnN0IHNraXAgPSAocGFnZSAtIDEpICogbGltaXQ7XG4gICAgXG4gICAgY29uc3QgW3Bvc3RzLCB0b3RhbF0gPSBhd2FpdCBQcm9taXNlLmFsbChbXG4gICAgICB0aGlzLnByaXNtYS5wb3N0LmZpbmRNYW55KHtcbiAgICAgICAgd2hlcmU6IHsgcm9vbUlkIH0sXG4gICAgICAgIGluY2x1ZGU6IHtcbiAgICAgICAgICB1c2VyOiB7XG4gICAgICAgICAgICBzZWxlY3Q6IHtcbiAgICAgICAgICAgICAgaWQ6IHRydWUsXG4gICAgICAgICAgICAgIGZpcnN0TmFtZTogdHJ1ZSxcbiAgICAgICAgICAgICAgbGFzdE5hbWU6IHRydWUsXG4gICAgICAgICAgICAgIGF2YXRhclVybDogdHJ1ZSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgICBoZWFydHM6IHtcbiAgICAgICAgICAgIHNlbGVjdDoge1xuICAgICAgICAgICAgICBpZDogdHJ1ZSxcbiAgICAgICAgICAgICAgdXNlcklkOiB0cnVlLFxuICAgICAgICAgICAgICBwb3N0SWQ6IHRydWUsXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0sXG4gICAgICAgICAgX2NvdW50OiB7XG4gICAgICAgICAgICBzZWxlY3Q6IHtcbiAgICAgICAgICAgICAgaGVhcnRzOiB0cnVlLFxuICAgICAgICAgICAgICBjb21tZW50czogdHJ1ZSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgICAgb3JkZXJCeTogeyBjcmVhdGVkQXQ6ICdkZXNjJyB9LFxuICAgICAgICBza2lwLFxuICAgICAgICB0YWtlOiBsaW1pdCxcbiAgICAgIH0pLFxuICAgICAgdGhpcy5wcmlzbWEucG9zdC5jb3VudCh7IHdoZXJlOiB7IHJvb21JZCB9IH0pLFxuICAgIF0pO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIHBvc3RzLFxuICAgICAgcGFnaW5hdGlvbjoge1xuICAgICAgICB0b3RhbCxcbiAgICAgICAgcGFnZSxcbiAgICAgICAgbGltaXQsXG4gICAgICB9LFxuICAgIH07XG4gIH1cblxuICBhc3luYyBjcmVhdGVQb3N0KFxuICAgIHRpdGxlOiBzdHJpbmcsIFxuICAgIGNvbnRlbnQ6IHN0cmluZywgXG4gICAgcm9vbUlkOiBzdHJpbmcsIFxuICAgIHVzZXJJZDogc3RyaW5nLFxuICAgIGF0dGFjaG1lbnRVcmxzOiBzdHJpbmdbXSA9IFtdLFxuICAgIGF0dGFjaG1lbnROYW1lczogc3RyaW5nW10gPSBbXSxcbiAgICBhdHRhY2htZW50U2l6ZXM6IG51bWJlcltdID0gW10sXG4gICkge1xuICAgIC8vIEZpcnN0IHZlcmlmeSB0aGUgcm9vbSBleGlzdHMgYW5kIHVzZXIgaGFzIGFjY2Vzc1xuICAgIGNvbnN0IHJvb20gPSBhd2FpdCB0aGlzLnByaXNtYS5yb29tLmZpbmRVbmlxdWVPclRocm93KHtcbiAgICAgIHdoZXJlOiB7IGlkOiByb29tSWQgfSxcbiAgICAgIGluY2x1ZGU6IHtcbiAgICAgICAgcm9vbUdyb3VwOiB7XG4gICAgICAgICAgaW5jbHVkZToge1xuICAgICAgICAgICAgY29tbXVuaXR5OiB7XG4gICAgICAgICAgICAgIGluY2x1ZGU6IHtcbiAgICAgICAgICAgICAgICBtZW1iZXJzaGlwczoge1xuICAgICAgICAgICAgICAgICAgd2hlcmU6IHsgdXNlcklkIH0sXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICAvLyBDaGVjayBpZiB1c2VyIGlzIGEgbWVtYmVyIG9mIHRoZSBjb21tdW5pdHlcbiAgICBpZiAocm9vbS5yb29tR3JvdXAuY29tbXVuaXR5Lm1lbWJlcnNoaXBzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgdGhyb3cgbmV3IENvbmZsaWN0RXhjZXB0aW9uKCdVc2VyIGlzIG5vdCBhIG1lbWJlciBvZiB0aGlzIGNvbW11bml0eScpO1xuICAgIH1cblxuICAgIC8vIENoZWNrIHBvc3RpbmcgcGVybWlzc2lvbnMgYmFzZWQgb24gcm9vbSBwb3N0aW5nIHJvbGVcbiAgICBjb25zdCB1c2VyID0gYXdhaXQgdGhpcy5wcmlzbWEudXNlci5maW5kVW5pcXVlT3JUaHJvdyh7XG4gICAgICB3aGVyZTogeyBpZDogdXNlcklkIH0sXG4gICAgICBzZWxlY3Q6IHsgcm9sZTogdHJ1ZSB9LFxuICAgIH0pO1xuXG4gICAgY29uc3QgY2FuUG9zdCA9IHRoaXMuY2hlY2tQb3N0aW5nUGVybWlzc2lvbihyb29tLnBvc3RpbmdSb2xlLCB1c2VyLnJvbGUpO1xuICAgIGlmICghY2FuUG9zdCkge1xuICAgICAgdGhyb3cgbmV3IENvbmZsaWN0RXhjZXB0aW9uKCdVc2VyIGRvZXMgbm90IGhhdmUgcGVybWlzc2lvbiB0byBwb3N0IGluIHRoaXMgcm9vbScpO1xuICAgIH1cblxuICAgIHJldHVybiBhd2FpdCB0aGlzLnByaXNtYS5wb3N0LmNyZWF0ZSh7XG4gICAgICBkYXRhOiB7XG4gICAgICAgIHRpdGxlLFxuICAgICAgICBjb250ZW50LFxuICAgICAgICByb29tSWQsXG4gICAgICAgIHVzZXJJZCxcbiAgICAgICAgYXR0YWNobWVudFVybHMsXG4gICAgICAgIGF0dGFjaG1lbnROYW1lcyxcbiAgICAgICAgYXR0YWNobWVudFNpemVzLFxuICAgICAgfSxcbiAgICAgIGluY2x1ZGU6IHtcbiAgICAgICAgdXNlcjoge1xuICAgICAgICAgIHNlbGVjdDoge1xuICAgICAgICAgICAgaWQ6IHRydWUsXG4gICAgICAgICAgICBmaXJzdE5hbWU6IHRydWUsXG4gICAgICAgICAgICBsYXN0TmFtZTogdHJ1ZSxcbiAgICAgICAgICAgIGF2YXRhclVybDogdHJ1ZSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgICBoZWFydHM6IHtcbiAgICAgICAgICBzZWxlY3Q6IHtcbiAgICAgICAgICAgIGlkOiB0cnVlLFxuICAgICAgICAgICAgdXNlcklkOiB0cnVlLFxuICAgICAgICAgICAgcG9zdElkOiB0cnVlLFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICAgIF9jb3VudDoge1xuICAgICAgICAgIHNlbGVjdDoge1xuICAgICAgICAgICAgaGVhcnRzOiB0cnVlLFxuICAgICAgICAgICAgY29tbWVudHM6IHRydWUsXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgIH0sXG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIGNoZWNrUG9zdGluZ1Blcm1pc3Npb24ocm9vbVBvc3RpbmdSb2xlOiBzdHJpbmcsIHVzZXJSb2xlOiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICBjb25zdCByb2xlSGllcmFyY2h5ID0ge1xuICAgICAgJ2NsaWVudCc6IDAsXG4gICAgICAndGhlcmFwaXN0JzogMSxcbiAgICAgICdtb2RlcmF0b3InOiAyLFxuICAgICAgJ2FkbWluJzogMyxcbiAgICB9O1xuXG4gICAgY29uc3QgdXNlclJvbGVMZXZlbCA9IHJvbGVIaWVyYXJjaHlbdXNlclJvbGUgYXMga2V5b2YgdHlwZW9mIHJvbGVIaWVyYXJjaHldID8/IDA7XG5cbiAgICBzd2l0Y2ggKHJvb21Qb3N0aW5nUm9sZSkge1xuICAgICAgY2FzZSAnbWVtYmVyJzpcbiAgICAgICAgcmV0dXJuIHVzZXJSb2xlTGV2ZWwgPj0gMDtcbiAgICAgIGNhc2UgJ3RoZXJhcGlzdCc6XG4gICAgICAgIHJldHVybiB1c2VyUm9sZUxldmVsID49IDE7XG4gICAgICBjYXNlICdtb2RlcmF0b3InOlxuICAgICAgICByZXR1cm4gdXNlclJvbGVMZXZlbCA+PSAyO1xuICAgICAgY2FzZSAnYWRtaW4nOlxuICAgICAgICByZXR1cm4gdXNlclJvbGVMZXZlbCA+PSAzO1xuICAgICAgZGVmYXVsdDpcbiAgICAgICAgcmV0dXJuIHVzZXJSb2xlTGV2ZWwgPj0gMDtcbiAgICB9XG4gIH1cblxuICBhc3luYyBoZWFydFBvc3QocG9zdElkOiBzdHJpbmcsIHVzZXJJZDogc3RyaW5nKSB7XG4gICAgLy8gQ2hlY2sgaWYgaGVhcnQgYWxyZWFkeSBleGlzdHNcbiAgICBjb25zdCBleGlzdGluZ0hlYXJ0ID0gYXdhaXQgdGhpcy5wcmlzbWEucG9zdEhlYXJ0LmZpbmRVbmlxdWUoe1xuICAgICAgd2hlcmU6IHtcbiAgICAgICAgcG9zdElkX3VzZXJJZDoge1xuICAgICAgICAgIHBvc3RJZCxcbiAgICAgICAgICB1c2VySWQsXG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgaWYgKGV4aXN0aW5nSGVhcnQpIHtcbiAgICAgIHRocm93IG5ldyBDb25mbGljdEV4Y2VwdGlvbignUG9zdCBhbHJlYWR5IGhlYXJ0ZWQgYnkgdGhpcyB1c2VyJyk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGF3YWl0IHRoaXMucHJpc21hLnBvc3RIZWFydC5jcmVhdGUoe1xuICAgICAgZGF0YToge1xuICAgICAgICBwb3N0SWQsXG4gICAgICAgIHVzZXJJZCxcbiAgICAgIH0sXG4gICAgfSk7XG4gIH1cblxuICBhc3luYyB1bmhlYXJ0UG9zdChwb3N0SWQ6IHN0cmluZywgdXNlcklkOiBzdHJpbmcpIHtcbiAgICBjb25zdCBoZWFydCA9IGF3YWl0IHRoaXMucHJpc21hLnBvc3RIZWFydC5maW5kVW5pcXVlKHtcbiAgICAgIHdoZXJlOiB7XG4gICAgICAgIHBvc3RJZF91c2VySWQ6IHtcbiAgICAgICAgICBwb3N0SWQsXG4gICAgICAgICAgdXNlcklkLFxuICAgICAgICB9LFxuICAgICAgfSxcbiAgICB9KTtcblxuICAgIGlmICghaGVhcnQpIHtcbiAgICAgIHRocm93IG5ldyBOb3RGb3VuZEV4Y2VwdGlvbignSGVhcnQgbm90IGZvdW5kJyk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGF3YWl0IHRoaXMucHJpc21hLnBvc3RIZWFydC5kZWxldGUoe1xuICAgICAgd2hlcmU6IHtcbiAgICAgICAgcG9zdElkX3VzZXJJZDoge1xuICAgICAgICAgIHBvc3RJZCxcbiAgICAgICAgICB1c2VySWQsXG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgIH0pO1xuICB9XG5cbiAgYXN5bmMgZ2V0Sm9pbmVkQ29tbXVuaXRpZXModXNlcklkOiBzdHJpbmcpOiBQcm9taXNlPENvbW11bml0eVdpdGhSb29tR3JvdXBzUmVzcG9uc2VbXT4ge1xuICAgIGNvbnN0IG1lbWJlcnNoaXBzID0gYXdhaXQgdGhpcy5wcmlzbWEubWVtYmVyc2hpcC5maW5kTWFueSh7XG4gICAgICB3aGVyZTogeyB1c2VySWQgfSxcbiAgICAgIGluY2x1ZGU6IHtcbiAgICAgICAgY29tbXVuaXR5OiB7XG4gICAgICAgICAgaW5jbHVkZToge1xuICAgICAgICAgICAgcm9vbUdyb3Vwczoge1xuICAgICAgICAgICAgICBpbmNsdWRlOiB7XG4gICAgICAgICAgICAgICAgcm9vbXM6IHRydWUsXG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgIG9yZGVyQnk6IHsgb3JkZXI6ICdhc2MnIH0sXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgICAgb3JkZXJCeTogeyBqb2luZWRBdDogJ2Rlc2MnIH0sXG4gICAgfSk7XG5cbiAgICByZXR1cm4gbWVtYmVyc2hpcHMubWFwKG1lbWJlcnNoaXAgPT4gbWVtYmVyc2hpcC5jb21tdW5pdHkpO1xuICB9XG5cbiAgYXN5bmMgZ2V0UmVjb21tZW5kZWRDb21tdW5pdGllcyh1c2VySWQ6IHN0cmluZyk6IFByb21pc2U8Q29tbXVuaXR5V2l0aFJvb21Hcm91cHNSZXNwb25zZVtdPiB7XG4gICAgLy8gRm9yIG5vdywgcmV0dXJuIGNvbW11bml0aWVzIHRoZSB1c2VyIGlzIG5vdCB5ZXQgYSBtZW1iZXIgb2ZcbiAgICAvLyBUaGlzIGNhbiBiZSBlbmhhbmNlZCB3aXRoIGFjdHVhbCByZWNvbW1lbmRhdGlvbiBsb2dpYyBsYXRlclxuICAgIGNvbnN0IHVzZXJDb21tdW5pdHlJZHMgPSBhd2FpdCB0aGlzLnByaXNtYS5tZW1iZXJzaGlwLmZpbmRNYW55KHtcbiAgICAgIHdoZXJlOiB7IHVzZXJJZCB9LFxuICAgICAgc2VsZWN0OiB7IGNvbW11bml0eUlkOiB0cnVlIH0sXG4gICAgfSk7XG5cbiAgICBjb25zdCBleGNsdWRlSWRzID0gdXNlckNvbW11bml0eUlkcy5tYXAobSA9PiBtLmNvbW11bml0eUlkKTtcblxuICAgIHJldHVybiBhd2FpdCB0aGlzLnByaXNtYS5jb21tdW5pdHkuZmluZE1hbnkoe1xuICAgICAgd2hlcmU6IHtcbiAgICAgICAgaWQ6IHtcbiAgICAgICAgICBub3RJbjogZXhjbHVkZUlkcyxcbiAgICAgICAgfSxcbiAgICAgIH0sXG4gICAgICBpbmNsdWRlOiB7XG4gICAgICAgIHJvb21Hcm91cHM6IHtcbiAgICAgICAgICBpbmNsdWRlOiB7XG4gICAgICAgICAgICByb29tczogdHJ1ZSxcbiAgICAgICAgICB9LFxuICAgICAgICAgIG9yZGVyQnk6IHsgb3JkZXI6ICdhc2MnIH0sXG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgICAgdGFrZTogNSxcbiAgICAgIG9yZGVyQnk6IHsgY3JlYXRlZEF0OiAnZGVzYycgfSxcbiAgICB9KTtcbiAgfVxuXG4gIGFzeW5jIGdldFJlY2VudEFjdGl2aXR5KHVzZXJJZDogc3RyaW5nKSB7XG4gICAgLy8gR2V0IHJlY2VudCBwb3N0cyBmcm9tIGNvbW11bml0aWVzIHRoZSB1c2VyIGlzIGEgbWVtYmVyIG9mXG4gICAgY29uc3QgdXNlckNvbW11bml0eUlkcyA9IGF3YWl0IHRoaXMucHJpc21hLm1lbWJlcnNoaXAuZmluZE1hbnkoe1xuICAgICAgd2hlcmU6IHsgdXNlcklkIH0sXG4gICAgICBzZWxlY3Q6IHsgY29tbXVuaXR5SWQ6IHRydWUgfSxcbiAgICB9KTtcblxuICAgIGNvbnN0IGNvbW11bml0eUlkcyA9IHVzZXJDb21tdW5pdHlJZHMubWFwKG0gPT4gbS5jb21tdW5pdHlJZCk7XG5cbiAgICBjb25zdCByZWNlbnRQb3N0cyA9IGF3YWl0IHRoaXMucHJpc21hLnBvc3QuZmluZE1hbnkoe1xuICAgICAgd2hlcmU6IHtcbiAgICAgICAgcm9vbToge1xuICAgICAgICAgIHJvb21Hcm91cDoge1xuICAgICAgICAgICAgY29tbXVuaXR5SWQ6IHtcbiAgICAgICAgICAgICAgaW46IGNvbW11bml0eUlkcyxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgIH0sXG4gICAgICBpbmNsdWRlOiB7XG4gICAgICAgIHVzZXI6IHtcbiAgICAgICAgICBzZWxlY3Q6IHtcbiAgICAgICAgICAgIGlkOiB0cnVlLFxuICAgICAgICAgICAgZmlyc3ROYW1lOiB0cnVlLFxuICAgICAgICAgICAgbGFzdE5hbWU6IHRydWUsXG4gICAgICAgICAgICBhdmF0YXJVcmw6IHRydWUsXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgICAgcm9vbToge1xuICAgICAgICAgIGluY2x1ZGU6IHtcbiAgICAgICAgICAgIHJvb21Hcm91cDoge1xuICAgICAgICAgICAgICBpbmNsdWRlOiB7XG4gICAgICAgICAgICAgICAgY29tbXVuaXR5OiB7XG4gICAgICAgICAgICAgICAgICBzZWxlY3Q6IHtcbiAgICAgICAgICAgICAgICAgICAgaWQ6IHRydWUsXG4gICAgICAgICAgICAgICAgICAgIG5hbWU6IHRydWUsXG4gICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICAgIF9jb3VudDoge1xuICAgICAgICAgIHNlbGVjdDoge1xuICAgICAgICAgICAgaGVhcnRzOiB0cnVlLFxuICAgICAgICAgICAgY29tbWVudHM6IHRydWUsXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgIH0sXG4gICAgICBvcmRlckJ5OiB7IGNyZWF0ZWRBdDogJ2Rlc2MnIH0sXG4gICAgICB0YWtlOiAxMCxcbiAgICB9KTtcblxuICAgIHJldHVybiByZWNlbnRQb3N0c1xuICAgICAgLmZpbHRlcihwb3N0ID0+IHBvc3Qucm9vbSkgLy8gRmlsdGVyIG91dCBwb3N0cyB3aXRob3V0IHJvb21zXG4gICAgICAubWFwKHBvc3QgPT4gKHtcbiAgICAgICAgdHlwZTogJ3Bvc3QnLFxuICAgICAgICBpZDogcG9zdC5pZCxcbiAgICAgICAgdGl0bGU6IHBvc3QudGl0bGUsXG4gICAgICAgIGNvbnRlbnQ6IHBvc3QuY29udGVudCxcbiAgICAgICAgY3JlYXRlZEF0OiBwb3N0LmNyZWF0ZWRBdCxcbiAgICAgICAgdXNlcjogcG9zdC51c2VyLFxuICAgICAgICBjb21tdW5pdHk6IHBvc3Qucm9vbSEucm9vbUdyb3VwLmNvbW11bml0eSxcbiAgICAgICAgX2NvdW50OiBwb3N0Ll9jb3VudCxcbiAgICAgIH0pKTtcbiAgfVxufVxuIl0sInZlcnNpb24iOjN9