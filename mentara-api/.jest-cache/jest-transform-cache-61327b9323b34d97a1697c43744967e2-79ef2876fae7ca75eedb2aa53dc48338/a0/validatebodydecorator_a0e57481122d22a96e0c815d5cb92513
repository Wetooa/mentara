91f6a9ea7107cccdc86fc56a07a2cfdf
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ValidatedParams = exports.ValidatedQuery = exports.ValidatedBody = void 0;
const common_1 = require("@nestjs/common");
const mentara_commons_1 = require("mentara-commons");
// Body validation decorator that validates request body using Zod schemas
exports.ValidatedBody = (0, common_1.createParamDecorator)((schema, ctx) => {
    const request = ctx.switchToHttp().getRequest();
    const body = request.body;
    if (!schema) {
        throw new Error('Schema is required for ValidatedBody decorator');
    }
    const result = (0, mentara_commons_1.validateSchema)(schema, body);
    if (!result.success) {
        const errorMessage = (0, mentara_commons_1.formatValidationErrors)(result.errors);
        throw new common_1.BadRequestException(`Validation failed: ${errorMessage}`);
    }
    return result.data;
});
// Query validation decorator for query parameters
exports.ValidatedQuery = (0, common_1.createParamDecorator)((schema, ctx) => {
    const request = ctx.switchToHttp().getRequest();
    const query = request.query;
    if (!schema) {
        throw new Error('Schema is required for ValidatedQuery decorator');
    }
    // Convert query parameters to appropriate types
    const processedQuery = {};
    Object.entries(query).forEach(([key, value]) => {
        if (typeof value === 'string') {
            // Try to coerce string values
            if (value === 'true') {
                processedQuery[key] = true;
            }
            else if (value === 'false') {
                processedQuery[key] = false;
            }
            else if (value === 'null') {
                processedQuery[key] = null;
            }
            else if (value === 'undefined') {
                processedQuery[key] = undefined;
            }
            else if (!isNaN(Number(value)) && value !== '') {
                processedQuery[key] = Number(value);
            }
            else {
                processedQuery[key] = value;
            }
        }
        else {
            processedQuery[key] = value;
        }
    });
    const result = (0, mentara_commons_1.validateSchema)(schema, processedQuery);
    if (!result.success) {
        const errorMessage = (0, mentara_commons_1.formatValidationErrors)(result.errors);
        throw new common_1.BadRequestException(`Query validation failed: ${errorMessage}`);
    }
    return result.data;
});
// Params validation decorator for path parameters
exports.ValidatedParams = (0, common_1.createParamDecorator)((schema, ctx) => {
    const request = ctx.switchToHttp().getRequest();
    const params = request.params;
    if (!schema) {
        throw new Error('Schema is required for ValidatedParams decorator');
    }
    const result = (0, mentara_commons_1.validateSchema)(schema, params);
    if (!result.success) {
        const errorMessage = (0, mentara_commons_1.formatValidationErrors)(result.errors);
        throw new common_1.BadRequestException(`Path parameter validation failed: ${errorMessage}`);
    }
    return result.data;
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL2NvbW1vbi9kZWNvcmF0b3JzL3ZhbGlkYXRlLWJvZHkuZGVjb3JhdG9yLnRzIiwibWFwcGluZ3MiOiI7OztBQUFBLDJDQUl3QjtBQUV4QixxREFBeUU7QUFFekUsMEVBQTBFO0FBQzdELFFBQUEsYUFBYSxHQUFHLElBQUEsNkJBQW9CLEVBQy9DLENBQUMsTUFBVyxFQUFFLEdBQXFCLEVBQUUsRUFBRTtJQUNyQyxNQUFNLE9BQU8sR0FBRyxHQUFHLENBQUMsWUFBWSxFQUFFLENBQUMsVUFBVSxFQUFFLENBQUM7SUFDaEQsTUFBTSxJQUFJLEdBQUcsT0FBTyxDQUFDLElBQUksQ0FBQztJQUUxQixJQUFJLENBQUMsTUFBTSxFQUFFLENBQUM7UUFDWixNQUFNLElBQUksS0FBSyxDQUFDLGdEQUFnRCxDQUFDLENBQUM7SUFDcEUsQ0FBQztJQUVELE1BQU0sTUFBTSxHQUFHLElBQUEsZ0NBQWMsRUFBQyxNQUFNLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFFNUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxPQUFPLEVBQUUsQ0FBQztRQUNwQixNQUFNLFlBQVksR0FBRyxJQUFBLHdDQUFzQixFQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUMzRCxNQUFNLElBQUksNEJBQW1CLENBQUMsc0JBQXNCLFlBQVksRUFBRSxDQUFDLENBQUM7SUFDdEUsQ0FBQztJQUVELE9BQU8sTUFBTSxDQUFDLElBQUksQ0FBQztBQUNyQixDQUFDLENBQ0YsQ0FBQztBQUVGLGtEQUFrRDtBQUNyQyxRQUFBLGNBQWMsR0FBRyxJQUFBLDZCQUFvQixFQUNoRCxDQUFDLE1BQVcsRUFBRSxHQUFxQixFQUFFLEVBQUU7SUFDckMsTUFBTSxPQUFPLEdBQUcsR0FBRyxDQUFDLFlBQVksRUFBRSxDQUFDLFVBQVUsRUFBRSxDQUFDO0lBQ2hELE1BQU0sS0FBSyxHQUFHLE9BQU8sQ0FBQyxLQUFLLENBQUM7SUFFNUIsSUFB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dHMvY29kZS9wcm9qZWN0cy9tZW50YXJhL21lbnRhcmEtYXBpL3NyYy9jb21tb24vZGVjb3JhdG9ycy92YWxpZGF0ZS1ib2R5LmRlY29yYXRvci50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBjcmVhdGVQYXJhbURlY29yYXRvcixcbiAgRXhlY3V0aW9uQ29udGV4dCxcbiAgQmFkUmVxdWVzdEV4Y2VwdGlvbixcbn0gZnJvbSAnQG5lc3Rqcy9jb21tb24nO1xuaW1wb3J0IHsgeiB9IGZyb20gJ3pvZCc7XG5pbXBvcnQgeyB2YWxpZGF0ZVNjaGVtYSwgZm9ybWF0VmFsaWRhdGlvbkVycm9ycyB9IGZyb20gJ21lbnRhcmEtY29tbW9ucyc7XG5cbi8vIEJvZHkgdmFsaWRhdGlvbiBkZWNvcmF0b3IgdGhhdCB2YWxpZGF0ZXMgcmVxdWVzdCBib2R5IHVzaW5nIFpvZCBzY2hlbWFzXG5leHBvcnQgY29uc3QgVmFsaWRhdGVkQm9keSA9IGNyZWF0ZVBhcmFtRGVjb3JhdG9yKFxuICAoc2NoZW1hOiBhbnksIGN0eDogRXhlY3V0aW9uQ29udGV4dCkgPT4ge1xuICAgIGNvbnN0IHJlcXVlc3QgPSBjdHguc3dpdGNoVG9IdHRwKCkuZ2V0UmVxdWVzdCgpO1xuICAgIGNvbnN0IGJvZHkgPSByZXF1ZXN0LmJvZHk7XG5cbiAgICBpZiAoIXNjaGVtYSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdTY2hlbWEgaXMgcmVxdWlyZWQgZm9yIFZhbGlkYXRlZEJvZHkgZGVjb3JhdG9yJyk7XG4gICAgfVxuXG4gICAgY29uc3QgcmVzdWx0ID0gdmFsaWRhdGVTY2hlbWEoc2NoZW1hLCBib2R5KTtcblxuICAgIGlmICghcmVzdWx0LnN1Y2Nlc3MpIHtcbiAgICAgIGNvbnN0IGVycm9yTWVzc2FnZSA9IGZvcm1hdFZhbGlkYXRpb25FcnJvcnMocmVzdWx0LmVycm9ycyk7XG4gICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdEV4Y2VwdGlvbihgVmFsaWRhdGlvbiBmYWlsZWQ6ICR7ZXJyb3JNZXNzYWdlfWApO1xuICAgIH1cblxuICAgIHJldHVybiByZXN1bHQuZGF0YTtcbiAgfSxcbik7XG5cbi8vIFF1ZXJ5IHZhbGlkYXRpb24gZGVjb3JhdG9yIGZvciBxdWVyeSBwYXJhbWV0ZXJzXG5leHBvcnQgY29uc3QgVmFsaWRhdGVkUXVlcnkgPSBjcmVhdGVQYXJhbURlY29yYXRvcihcbiAgKHNjaGVtYTogYW55LCBjdHg6IEV4ZWN1dGlvbkNvbnRleHQpID0+IHtcbiAgICBjb25zdCByZXF1ZXN0ID0gY3R4LnN3aXRjaFRvSHR0cCgpLmdldFJlcXVlc3QoKTtcbiAgICBjb25zdCBxdWVyeSA9IHJlcXVlc3QucXVlcnk7XG5cbiAgICBpZiAoIXNjaGVtYSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdTY2hlbWEgaXMgcmVxdWlyZWQgZm9yIFZhbGlkYXRlZFF1ZXJ5IGRlY29yYXRvcicpO1xuICAgIH1cblxuICAgIC8vIENvbnZlcnQgcXVlcnkgcGFyYW1ldGVycyB0byBhcHByb3ByaWF0ZSB0eXBlc1xuICAgIGNvbnN0IHByb2Nlc3NlZFF1ZXJ5OiBSZWNvcmQ8c3RyaW5nLCBhbnk+ID0ge307XG4gICAgT2JqZWN0LmVudHJpZXMocXVlcnkpLmZvckVhY2goKFtrZXksIHZhbHVlXSkgPT4ge1xuICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgLy8gVHJ5IHRvIGNvZXJjZSBzdHJpbmcgdmFsdWVzXG4gICAgICAgIGlmICh2YWx1ZSA9PT0gJ3RydWUnKSB7XG4gICAgICAgICAgcHJvY2Vzc2VkUXVlcnlba2V5XSA9IHRydWU7XG4gICAgICAgIH0gZWxzZSBpZiAodmFsdWUgPT09ICdmYWxzZScpIHtcbiAgICAgICAgICBwcm9jZXNzZWRRdWVyeVtrZXldID0gZmFsc2U7XG4gICAgICAgIH0gZWxzZSBpZiAodmFsdWUgPT09ICdudWxsJykge1xuICAgICAgICAgIHByb2Nlc3NlZFF1ZXJ5W2tleV0gPSBudWxsO1xuICAgICAgICB9IGVsc2UgaWYgKHZhbHVlID09PSAndW5kZWZpbmVkJykge1xuICAgICAgICAgIHByb2Nlc3NlZFF1ZXJ5W2tleV0gPSB1bmRlZmluZWQ7XG4gICAgICAgIH0gZWxzZSBpZiAoIWlzTmFOKE51bWJlcih2YWx1ZSkpICYmIHZhbHVlICE9PSAnJykge1xuICAgICAgICAgIHByb2Nlc3NlZFF1ZXJ5W2tleV0gPSBOdW1iZXIodmFsdWUpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHByb2Nlc3NlZFF1ZXJ5W2tleV0gPSB2YWx1ZTtcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcHJvY2Vzc2VkUXVlcnlba2V5XSA9IHZhbHVlO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgY29uc3QgcmVzdWx0ID0gdmFsaWRhdGVTY2hlbWEoc2NoZW1hLCBwcm9jZXNzZWRRdWVyeSk7XG5cbiAgICBpZiAoIXJlc3VsdC5zdWNjZXNzKSB7XG4gICAgICBjb25zdCBlcnJvck1lc3NhZ2UgPSBmb3JtYXRWYWxpZGF0aW9uRXJyb3JzKHJlc3VsdC5lcnJvcnMpO1xuICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFeGNlcHRpb24oYFF1ZXJ5IHZhbGlkYXRpb24gZmFpbGVkOiAke2Vycm9yTWVzc2FnZX1gKTtcbiAgICB9XG5cbiAgICByZXR1cm4gcmVzdWx0LmRhdGE7XG4gIH0sXG4pO1xuXG4vLyBQYXJhbXMgdmFsaWRhdGlvbiBkZWNvcmF0b3IgZm9yIHBhdGggcGFyYW1ldGVyc1xuZXhwb3J0IGNvbnN0IFZhbGlkYXRlZFBhcmFtcyA9IGNyZWF0ZVBhcmFtRGVjb3JhdG9yKFxuICAoc2NoZW1hOiBhbnksIGN0eDogRXhlY3V0aW9uQ29udGV4dCkgPT4ge1xuICAgIGNvbnN0IHJlcXVlc3QgPSBjdHguc3dpdGNoVG9IdHRwKCkuZ2V0UmVxdWVzdCgpO1xuICAgIGNvbnN0IHBhcmFtcyA9IHJlcXVlc3QucGFyYW1zO1xuXG4gICAgaWYgKCFzY2hlbWEpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignU2NoZW1hIGlzIHJlcXVpcmVkIGZvciBWYWxpZGF0ZWRQYXJhbXMgZGVjb3JhdG9yJyk7XG4gICAgfVxuXG4gICAgY29uc3QgcmVzdWx0ID0gdmFsaWRhdGVTY2hlbWEoc2NoZW1hLCBwYXJhbXMpO1xuXG4gICAgaWYgKCFyZXN1bHQuc3VjY2Vzcykge1xuICAgICAgY29uc3QgZXJyb3JNZXNzYWdlID0gZm9ybWF0VmFsaWRhdGlvbkVycm9ycyhyZXN1bHQuZXJyb3JzKTtcbiAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0RXhjZXB0aW9uKFxuICAgICAgICBgUGF0aCBwYXJhbWV0ZXIgdmFsaWRhdGlvbiBmYWlsZWQ6ICR7ZXJyb3JNZXNzYWdlfWAsXG4gICAgICApO1xuICAgIH1cblxuICAgIHJldHVybiByZXN1bHQuZGF0YTtcbiAgfSxcbik7XG4iXSwidmVyc2lvbiI6M30=