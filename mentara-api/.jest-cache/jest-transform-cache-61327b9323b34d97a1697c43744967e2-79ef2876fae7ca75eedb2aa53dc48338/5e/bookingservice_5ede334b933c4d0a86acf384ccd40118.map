{"file":"/home/wetooa/Documents/code/projects/mentara/mentara-api/src/booking/booking.service.ts","mappings":"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","names":[],"sources":["/home/wetooa/Documents/code/projects/mentara/mentara-api/src/booking/booking.service.ts"],"sourcesContent":["import {\n  Injectable,\n  BadRequestException,\n  NotFoundException,\n  ForbiddenException,\n} from '@nestjs/common';\nimport { PrismaService } from '../providers/prisma-client.provider';\nimport { MeetingStatus } from '@prisma/client';\nimport {\n  MeetingCreateDto,\n  MeetingUpdateDto,\n  TherapistAvailabilityCreateDto,\n  TherapistAvailabilityUpdateDto,\n} from 'mentara-commons';\nimport { EventBusService } from '../common/events/event-bus.service';\nimport { SlotGeneratorService } from './services/slot-generator.service';\nimport { ConflictDetectionService } from './services/conflict-detection.service';\nimport { AvailabilityValidatorService } from './services/availability-validator.service';\nimport {\n  AppointmentBookedEvent,\n  AppointmentCancelledEvent,\n  AppointmentCompletedEvent,\n  AppointmentRescheduledEvent,\n} from '../common/events/booking-events';\n\n@Injectable()\nexport class BookingService {\n  constructor(\n    private readonly prisma: PrismaService,\n    private readonly eventBus: EventBusService,\n    private readonly slotGenerator: SlotGeneratorService,\n    private readonly conflictDetection: ConflictDetectionService,\n    private readonly availabilityValidator: AvailabilityValidatorService,\n  ) {}\n\n  // Meeting Management\n  async createMeeting(createMeetingDto: MeetingCreateDto, clientId: string) {\n    try {\n      const { startTime, therapistId, duration } = createMeetingDto;\n      const startTimeDate = new Date(startTime);\n\n      // Comprehensive validation using our new services\n      await this.availabilityValidator.validateMeetingCreation({\n        therapistId,\n        clientId,\n        startTime: startTimeDate,\n        duration,\n      });\n\n      // Check for conflicts using our dedicated service\n      await this.conflictDetection.validateNoConflicts(\n        therapistId,\n        clientId,\n        startTimeDate,\n        duration,\n      );\n\n      // Create the meeting\n      const meeting = await this.prisma.meeting.create({\n        data: {\n          ...createMeetingDto,\n          status: 'SCHEDULED',\n          clientId,\n        },\n        include: {\n          client: {\n            select: {\n              user: {\n                select: {\n                  firstName: true,\n                  lastName: true,\n                  email: true,\n                },\n              },\n            },\n          },\n          therapist: {\n            select: {\n              user: {\n                select: {\n                  firstName: true,\n                  lastName: true,\n                  email: true,\n                },\n              },\n            },\n          },\n        },\n      });\n\n      // Publish appointment booked event\n      await this.eventBus.emit(\n        new AppointmentBookedEvent({\n          appointmentId: meeting.id,\n          clientId: meeting.clientId,\n          therapistId: meeting.therapistId,\n          startTime: meeting.startTime,\n          meetingType: meeting.meetingType as\n            | 'video'\n            | 'audio'\n            | 'in_person'\n            | 'chat',\n          duration: meeting.duration,\n          title: meeting.title || 'Therapy Session',\n          description: meeting.description || undefined,\n          isInitialConsultation: false,\n        }),\n      );\n\n      return meeting;\n    } catch (error) {\n      throw new BadRequestException(\n        error instanceof Error ? error.message : String(error),\n      );\n    }\n  }\n\n  async getMeetings(userId: string, role: string) {\n    try {\n      const where =\n        role === 'therapist' ? { therapistId: userId } : { clientId: userId };\n\n      return await this.prisma.meeting.findMany({\n        where,\n        include: {\n          client: {\n            select: {\n              user: {\n                select: {\n                  firstName: true,\n                  lastName: true,\n                  email: true,\n                },\n              },\n            },\n          },\n          therapist: {\n            select: {\n              user: {\n                select: {\n                  firstName: true,\n                  lastName: true,\n                  email: true,\n                },\n              },\n            },\n          },\n        },\n        orderBy: { startTime: 'desc' },\n      });\n    } catch (error) {\n      throw new BadRequestException(\n        error instanceof Error ? error.message : String(error),\n      );\n    }\n  }\n\n  async getMeeting(id: string, userId: string, role: string) {\n    try {\n      const meeting = await this.prisma.meeting.findUnique({\n        where: { id },\n        include: {\n          client: {\n            select: {\n              user: {\n                select: {\n                  firstName: true,\n                  lastName: true,\n                  email: true,\n                },\n              },\n            },\n          },\n          therapist: {\n            select: {\n              user: {\n                select: {\n                  firstName: true,\n                  lastName: true,\n                  email: true,\n                },\n              },\n            },\n          },\n        },\n      });\n\n      if (!meeting) {\n        throw new NotFoundException('Meeting not found');\n      }\n\n      // Verify user has access to this meeting\n      if (role === 'therapist' && meeting.therapistId !== userId) {\n        throw new ForbiddenException('Access denied');\n      }\n      if (role === 'client' && meeting.clientId !== userId) {\n        throw new ForbiddenException('Access denied');\n      }\n\n      return meeting;\n    } catch (error) {\n      throw new BadRequestException(\n        error instanceof Error ? error.message : String(error),\n      );\n    }\n  }\n\n  async updateMeeting(\n    id: string,\n    updateMeetingDto: MeetingUpdateDto,\n    userId: string,\n    role: string,\n  ) {\n    try {\n      const meeting = await this.getMeeting(id, userId, role);\n\n      // Only allow updates if meeting is not completed or cancelled\n      if (['COMPLETED', 'CANCELLED'].includes(meeting.status)) {\n        throw new BadRequestException(\n          'Cannot update completed or cancelled meetings',\n        );\n      }\n\n      // If updating time, validate the new schedule\n      if (updateMeetingDto.startTime || updateMeetingDto.duration) {\n        const newStartTime = updateMeetingDto.startTime\n          ? new Date(updateMeetingDto.startTime)\n          : meeting.startTime;\n        const newDuration = updateMeetingDto.duration || meeting.duration;\n\n        // Check for conflicts with the update\n        const conflicts = await this.conflictDetection.checkUpdateConflicts(\n          id,\n          meeting.therapistId,\n          meeting.clientId,\n          newStartTime,\n          newDuration,\n        );\n\n        if (conflicts.hasConflict) {\n          throw new BadRequestException(\n            `Schedule update would cause conflicts: ${conflicts.conflictingMeetings.length} conflicting meetings found`,\n          );\n        }\n\n        // Validate therapist availability for new time\n        if (updateMeetingDto.startTime) {\n          await this.availabilityValidator.validateTherapistAvailability(\n            meeting.therapistId,\n            newStartTime,\n            newDuration,\n          );\n        }\n      }\n\n      const updatedMeeting = await this.prisma.meeting.update({\n        where: { id },\n        data: {\n          title: updateMeetingDto.title,\n          description: updateMeetingDto.description,\n          startTime: updateMeetingDto.startTime,\n          duration: updateMeetingDto.duration,\n          meetingType: updateMeetingDto.meetingType,\n          notes: updateMeetingDto.notes,\n          meetingUrl: updateMeetingDto.meetingUrl,\n          ...(updateMeetingDto.status && {\n            status: updateMeetingDto.status as MeetingStatus,\n          }),\n        },\n        include: {\n          client: {\n            select: {\n              user: {\n                select: {\n                  firstName: true,\n                  lastName: true,\n                  email: true,\n                },\n              },\n            },\n          },\n          therapist: {\n            select: {\n              user: {\n                select: {\n                  firstName: true,\n                  lastName: true,\n                  email: true,\n                },\n              },\n            },\n          },\n        },\n      });\n\n      // Publish appropriate events\n      if (updateMeetingDto.status === 'completed') {\n        await this.eventBus.emit(\n          new AppointmentCompletedEvent({\n            appointmentId: updatedMeeting.id,\n            clientId: updatedMeeting.clientId,\n            therapistId: updatedMeeting.therapistId,\n            completedAt: new Date(),\n            duration: updatedMeeting.duration,\n            sessionNotes: updateMeetingDto.description || '',\n            attendanceStatus: 'ATTENDED',\n          }),\n        );\n      } else if (\n        updateMeetingDto.startTime &&\n        new Date(updateMeetingDto.startTime).getTime() !==\n          meeting.startTime.getTime()\n      ) {\n        await this.eventBus.emit(\n          new AppointmentRescheduledEvent({\n            appointmentId: updatedMeeting.id,\n            clientId: updatedMeeting.clientId,\n            therapistId: updatedMeeting.therapistId,\n            rescheduledBy: userId,\n            originalStartTime: meeting.startTime,\n            newStartTime: new Date(updateMeetingDto.startTime),\n            rescheduleReason: `Rescheduled by ${role}`,\n          }),\n        );\n      }\n\n      return updatedMeeting;\n    } catch (error) {\n      throw new BadRequestException(\n        error instanceof Error ? error.message : String(error),\n      );\n    }\n  }\n\n  async cancelMeeting(id: string, userId: string, role: string) {\n    try {\n      const meeting = await this.getMeeting(id, userId, role);\n\n      if (meeting.status === 'CANCELLED') {\n        throw new BadRequestException('Meeting is already cancelled');\n      }\n\n      if (meeting.status === 'COMPLETED') {\n        throw new BadRequestException('Cannot cancel completed meetings');\n      }\n\n      const cancelledMeeting = await this.prisma.meeting.update({\n        where: { id },\n        data: { status: 'CANCELLED' },\n        include: {\n          client: {\n            select: {\n              user: {\n                select: {\n                  firstName: true,\n                  lastName: true,\n                  email: true,\n                },\n              },\n            },\n          },\n          therapist: {\n            select: {\n              user: {\n                select: {\n                  firstName: true,\n                  lastName: true,\n                  email: true,\n                },\n              },\n            },\n          },\n        },\n      });\n\n      // Calculate cancellation notice\n      const cancellationNotice = Math.floor(\n        (meeting.startTime.getTime() - Date.now()) / (1000 * 60 * 60),\n      );\n\n      // Publish cancellation event\n      await this.eventBus.emit(\n        new AppointmentCancelledEvent({\n          appointmentId: cancelledMeeting.id,\n          clientId: cancelledMeeting.clientId,\n          therapistId: cancelledMeeting.therapistId,\n          cancelledBy: userId,\n          cancellationReason:\n            role === 'client'\n              ? 'Cancelled by client'\n              : 'Cancelled by therapist',\n          originalStartTime: meeting.startTime,\n          cancelledAt: new Date(),\n          cancellationNotice: Math.max(0, cancellationNotice),\n        }),\n      );\n\n      return cancelledMeeting;\n    } catch (error) {\n      throw new BadRequestException(\n        error instanceof Error ? error.message : String(error),\n      );\n    }\n  }\n\n  // Availability Management\n  async createAvailability(\n    createAvailabilityDto: TherapistAvailabilityCreateDto,\n    therapistId: string,\n  ) {\n    try {\n      const { dayOfWeek, startTime, endTime, notes } = createAvailabilityDto;\n\n      // Validate using our new service\n      await this.availabilityValidator.validateAvailabilityCreation({\n        therapistId,\n        dayOfWeek,\n        startTime,\n        endTime,\n      });\n\n      return this.prisma.therapistAvailability.create({\n        data: {\n          therapistId,\n          dayOfWeek,\n          startTime,\n          endTime,\n          notes,\n        },\n      });\n    } catch (error) {\n      throw new BadRequestException(\n        error instanceof Error ? error.message : String(error),\n      );\n    }\n  }\n\n  async getAvailability(therapistId: string) {\n    try {\n      return await this.prisma.therapistAvailability.findMany({\n        where: { therapistId },\n        orderBy: [{ dayOfWeek: 'asc' }, { startTime: 'asc' }],\n      });\n    } catch (error) {\n      throw new BadRequestException(\n        error instanceof Error ? error.message : String(error),\n      );\n    }\n  }\n\n  async updateAvailability(\n    id: string,\n    updateAvailabilityDto: TherapistAvailabilityUpdateDto,\n    therapistId: string,\n  ) {\n    try {\n      const availability = await this.prisma.therapistAvailability.findFirst({\n        where: { id, therapistId },\n      });\n\n      if (!availability) {\n        throw new NotFoundException('Availability slot not found');\n      }\n\n      return this.prisma.therapistAvailability.update({\n        where: { id },\n        data: updateAvailabilityDto,\n      });\n    } catch (error) {\n      throw new BadRequestException(\n        error instanceof Error ? error.message : String(error),\n      );\n    }\n  }\n\n  async deleteAvailability(id: string, therapistId: string) {\n    try {\n      const availability = await this.prisma.therapistAvailability.findFirst({\n        where: { id, therapistId },\n      });\n\n      if (!availability) {\n        throw new NotFoundException('Availability slot not found');\n      }\n\n      return this.prisma.therapistAvailability.delete({\n        where: { id },\n      });\n    } catch (error) {\n      throw new BadRequestException(\n        error instanceof Error ? error.message : String(error),\n      );\n    }\n  }\n\n  // Simplified slot generation using our new service\n  async getAvailableSlots(therapistId: string, date: string) {\n    try {\n      return await this.slotGenerator.generateAvailableSlots(therapistId, date);\n    } catch (error) {\n      throw new BadRequestException(\n        error instanceof Error ? error.message : String(error),\n      );\n    }\n  }\n\n  // Duration management\n  getDurations() {\n    return [\n      { id: '30', name: '30 minutes', duration: 30 },\n      { id: '60', name: '60 minutes', duration: 60 },\n      { id: '90', name: '90 minutes', duration: 90 },\n      { id: '120', name: '120 minutes', duration: 120 },\n    ];\n  }\n\n  // Enhanced validation method using our services\n  async validateMeetingTime(\n    therapistId: string,\n    clientId: string,\n    startTime: string | Date,\n    duration: number,\n  ) {\n    const startTimeDate = new Date(startTime);\n\n    await this.availabilityValidator.validateMeetingCreation({\n      therapistId,\n      clientId,\n      startTime: startTimeDate,\n      duration,\n    });\n\n    await this.conflictDetection.validateNoConflicts(\n      therapistId,\n      clientId,\n      startTimeDate,\n      duration,\n    );\n\n    return true;\n  }\n}\n"],"version":3}