5b255469755c7d968c943cbb434d4cea
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var EventBusService_1;
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
exports.EventBusService = void 0;
const common_1 = require("@nestjs/common");
const event_emitter_1 = require("@nestjs/event-emitter");
let EventBusService = EventBusService_1 = class EventBusService {
    eventEmitter;
    logger = new common_1.Logger(EventBusService_1.name);
    constructor(eventEmitter) {
        this.eventEmitter = eventEmitter;
    }
    async emit(event) {
        try {
            this.logger.debug(`Emitting event: ${event.eventType}`, {
                eventId: event.eventId,
                aggregateId: event.aggregateId,
                aggregateType: event.aggregateType,
                correlationId: event.metadata.correlationId,
            });
            // Emit the specific event type
            await this.eventEmitter.emitAsync(event.eventType, event);
            // Emit a wildcard event for global listeners
            await this.eventEmitter.emitAsync('*', event);
            // Emit aggregate-specific events for aggregate listeners
            await this.eventEmitter.emitAsync(`${event.aggregateType}.*`, event);
            this.logger.debug(`Event emitted successfully: ${event.eventType}`);
        }
        catch (error) {
            this.logger.error(`Failed to emit event: ${event.eventType}`, {
                eventId: event.eventId,
                error: error instanceof Error ? error.message : String(error),
                stack: error instanceof Error ? error.stack : undefined,
            });
            throw error;
        }
    }
    subscribe(eventType, handler, options = {}) {
        this.logger.debug(`Subscribing to event: ${eventType}`, {
            handlerName: handler.name,
            options,
        });
        const wrappedHandler = async (event) => {
            try {
                this.logger.debug(`Handling event: ${event.eventType}`, {
                    eventId: event.eventId,
                    handlerName: handler.name,
                });
                await handler(event);
                this.logger.debug(`Event handled successfully: ${event.eventType}`, {
                    eventId: event.eventId,
                    handlerName: handler.name,
                });
            }
            catch (error) {
                this.logger.error(`Event handler failed: ${event.eventType}`, {
                    eventId: event.eventId,
                    handlerName: handler.name,
                    error: error instanceof Error ? error.message : String(error),
                    stack: error instanceof Error ? error.stack : undefined,
                });
                // Re-throw to allow EventEmitter2 to handle retry logic
                throw error;
            }
        };
        if (options.async !== false) {
            this.eventEmitter.on(eventType, (event) => {
                void wrappedHandler(event);
            });
        }
        else {
            // For synchronous handlers, we still use async but without await
            this.eventEmitter.on(eventType, (event) => {
                void wrappedHandler(event).catch((error) => {
                    this.logger.error(`Async event handler error: ${event.eventType}`, error);
                });
            });
        }
    }
    unsubscribe(eventType, handler) {
        this.logger.debug(`Unsubscribing from event: ${eventType}`, {
            handlerName: handler.name,
        });
        this.eventEmitter.off(eventType, handler);
    }
    // Additional utility methods
    /**
     * Subscribe to all events of a specific aggregate type
     */
    subscribeToAggregate(aggregateType, handler, options = {}) {
        const eventPattern = `${aggregateType}.*`;
        this.subscribe(eventPattern, handler, options);
    }
    /**
     * Subscribe to all events (wildcard subscription)
     */
    subscribeToAll(handler, options = {}) {
        this.subscribe('*', handler, options);
    }
    /**
     * Get event statistics
     */
    getEventStats() {
        const eventNames = this.eventEmitter.eventNames();
        return {
            totalListeners: eventNames.reduce((total, eventName) => total + this.eventEmitter.listenerCount(eventName), 0),
            eventTypes: eventNames,
        };
    }
    /**
     * Check if there are listeners for a specific event type
     */
    hasListeners(eventType) {
        return this.eventEmitter.listenerCount(eventType) > 0;
    }
    /**
     * Remove all listeners for a specific event type
     */
    removeAllListeners(eventType) {
        if (eventType) {
            this.logger.debug(`Removing all listeners for event: ${eventType}`);
            this.eventEmitter.removeAllListeners(eventType);
        }
        else {
            this.logger.debug('Removing all event listeners');
            this.eventEmitter.removeAllListeners();
        }
    }
};
exports.EventBusService = EventBusService;
exports.EventBusService = EventBusService = EventBusService_1 = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [typeof (_a = typeof event_emitter_1.EventEmitter2 !== "undefined" && event_emitter_1.EventEmitter2) === "function" ? _a : Object])
], EventBusService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL2NvbW1vbi9ldmVudHMvZXZlbnQtYnVzLnNlcnZpY2UudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7QUFBQSwyQ0FBb0Q7QUFDcEQseURBQXNEO0FBUS9DLElBQU0sZUFBZSx1QkFBckIsTUFBTSxlQUFlO0lBR0c7SUFGWixNQUFNLEdBQUcsSUFBSSxlQUFNLENBQUMsaUJBQWUsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUUzRCxZQUE2QixZQUEyQjtRQUEzQixpQkFBWSxHQUFaLFlBQVksQ0FBZTtJQUFHLENBQUM7SUFFNUQsS0FBSyxDQUFDLElBQUksQ0FBVSxLQUFxQjtRQUN2QyxJQUFJLENBQUM7WUFDSCxJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxtQkFBbUIsS0FBSyxDQUFDLFNBQVMsRUFBRSxFQUFFO2dCQUN0RCxPQUFPLEVBQUUsS0FBSyxDQUFDLE9BQU87Z0JBQ3RCLFdBQVcsRUFBRSxLQUFLLENBQUMsV0FBVztnQkFDOUIsYUFBYSxFQUFFLEtBQUssQ0FBQyxhQUFhO2dCQUNsQyxhQUFhLEVBQUUsS0FBSyxDQUFDLFFBQVEsQ0FBQyxhQUFhO2FBQzVDLENBQUMsQ0FBQztZQUVILCtCQUErQjtZQUMvQixNQUFNLElBQUksQ0FBQyxZQUFZLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxTQUFTLEVBQUUsS0FBSyxDQUFDLENBQUM7WUFFMUQsNkNBQTZDO1lBQzdDLE1BQU0sSUFBSSxDQUFDLFlBQVksQ0FBQyxTQUFTLENBQUMsR0FBRyxFQUFFLEtBQUssQ0FBQyxDQUFDO1lBRTlDLHlEQUF5RDtZQUN6RCxNQUFNLElBQUksQ0FBQyxZQUFZLENBQUMsU0FBUyxDQUFDLEdBQUcsS0FBSyxDQUFDLGFBQWEsSUFBSSxFQUFFLEtBQUssQ0FBQyxDQUFDO1lBRXJFLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLCtCQUErQixLQUFLLENBQUMsU0FBUyxF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YUFBYSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUN4RCxDQUFDO0lBRUQ7O09BRUc7SUFDSCxrQkFBa0IsQ0FBQyxTQUFrQjtRQUNuQyxJQUFJLFNBQVMsRUFBRSxDQUFDO1lBQ2QsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMscUNBQXFDLFNBQVMsRUFBRSxDQUFDLENBQUM7WUFDcEUsSUFBSSxDQUFDLFlBQVksQ0FBQyxrQkFBa0IsQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUNsRCxDQUFDO2FBQU0sQ0FBQztZQUNOLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLDhCQUE4QixDQUFDLENBQUM7WUFDbEQsSUFBSSxDQUFDLFlBQVksQ0FBQyxrQkFBa0IsRUFBRSxDQUFDO1FBQ3pDLENBQUM7SUFDSCxDQUFDO0NBQ0YsQ0FBQTtBQTVKWSwwQ0FBZTswQkFBZixlQUFlO0lBRDNCLElBQUEsbUJBQVUsR0FBRTt5REFJZ0MsNkJBQWEsb0JBQWIsNkJBQWE7R0FIN0MsZUFBZSxDQTRKM0IiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL2NvbW1vbi9ldmVudHMvZXZlbnQtYnVzLnNlcnZpY2UudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSwgTG9nZ2VyIH0gZnJvbSAnQG5lc3Rqcy9jb21tb24nO1xuaW1wb3J0IHsgRXZlbnRFbWl0dGVyMiB9IGZyb20gJ0BuZXN0anMvZXZlbnQtZW1pdHRlcic7XG5pbXBvcnQge1xuICBEb21haW5FdmVudCxcbiAgSUV2ZW50QnVzLFxuICBFdmVudEhhbmRsZXJPcHRpb25zLFxufSBmcm9tICcuL2ludGVyZmFjZXMvZG9tYWluLWV2ZW50LmludGVyZmFjZSc7XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBFdmVudEJ1c1NlcnZpY2UgaW1wbGVtZW50cyBJRXZlbnRCdXMge1xuICBwcml2YXRlIHJlYWRvbmx5IGxvZ2dlciA9IG5ldyBMb2dnZXIoRXZlbnRCdXNTZXJ2aWNlLm5hbWUpO1xuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgcmVhZG9ubHkgZXZlbnRFbWl0dGVyOiBFdmVudEVtaXR0ZXIyKSB7fVxuXG4gIGFzeW5jIGVtaXQ8VCA9IGFueT4oZXZlbnQ6IERvbWFpbkV2ZW50PFQ+KTogUHJvbWlzZTx2b2lkPiB7XG4gICAgdHJ5IHtcbiAgICAgIHRoaXMubG9nZ2VyLmRlYnVnKGBFbWl0dGluZyBldmVudDogJHtldmVudC5ldmVudFR5cGV9YCwge1xuICAgICAgICBldmVudElkOiBldmVudC5ldmVudElkLFxuICAgICAgICBhZ2dyZWdhdGVJZDogZXZlbnQuYWdncmVnYXRlSWQsXG4gICAgICAgIGFnZ3JlZ2F0ZVR5cGU6IGV2ZW50LmFnZ3JlZ2F0ZVR5cGUsXG4gICAgICAgIGNvcnJlbGF0aW9uSWQ6IGV2ZW50Lm1ldGFkYXRhLmNvcnJlbGF0aW9uSWQsXG4gICAgICB9KTtcblxuICAgICAgLy8gRW1pdCB0aGUgc3BlY2lmaWMgZXZlbnQgdHlwZVxuICAgICAgYXdhaXQgdGhpcy5ldmVudEVtaXR0ZXIuZW1pdEFzeW5jKGV2ZW50LmV2ZW50VHlwZSwgZXZlbnQpO1xuXG4gICAgICAvLyBFbWl0IGEgd2lsZGNhcmQgZXZlbnQgZm9yIGdsb2JhbCBsaXN0ZW5lcnNcbiAgICAgIGF3YWl0IHRoaXMuZXZlbnRFbWl0dGVyLmVtaXRBc3luYygnKicsIGV2ZW50KTtcblxuICAgICAgLy8gRW1pdCBhZ2dyZWdhdGUtc3BlY2lmaWMgZXZlbnRzIGZvciBhZ2dyZWdhdGUgbGlzdGVuZXJzXG4gICAgICBhd2FpdCB0aGlzLmV2ZW50RW1pdHRlci5lbWl0QXN5bmMoYCR7ZXZlbnQuYWdncmVnYXRlVHlwZX0uKmAsIGV2ZW50KTtcblxuICAgICAgdGhpcy5sb2dnZXIuZGVidWcoYEV2ZW50IGVtaXR0ZWQgc3VjY2Vzc2Z1bGx5OiAke2V2ZW50LmV2ZW50VHlwZX1gKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoYEZhaWxlZCB0byBlbWl0IGV2ZW50OiAke2V2ZW50LmV2ZW50VHlwZX1gLCB7XG4gICAgICAgIGV2ZW50SWQ6IGV2ZW50LmV2ZW50SWQsXG4gICAgICAgIGVycm9yOiBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6IFN0cmluZyhlcnJvciksXG4gICAgICAgIHN0YWNrOiBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3Iuc3RhY2sgOiB1bmRlZmluZWQsXG4gICAgICB9KTtcbiAgICAgIHRocm93IGVycm9yO1xuICAgIH1cbiAgfVxuXG4gIHN1YnNjcmliZTxUID0gYW55PihcbiAgICBldmVudFR5cGU6IHN0cmluZyxcbiAgICBoYW5kbGVyOiAoZXZlbnQ6IERvbWFpbkV2ZW50PFQ+KSA9PiBQcm9taXNlPHZvaWQ+LFxuICAgIG9wdGlvbnM6IEV2ZW50SGFuZGxlck9wdGlvbnMgPSB7fSxcbiAgKTogdm9pZCB7XG4gICAgdGhpcy5sb2dnZXIuZGVidWcoYFN1YnNjcmliaW5nIHRvIGV2ZW50OiAke2V2ZW50VHlwZX1gLCB7XG4gICAgICBoYW5kbGVyTmFtZTogaGFuZGxlci5uYW1lLFxuICAgICAgb3B0aW9ucyxcbiAgICB9KTtcblxuICAgIGNvbnN0IHdyYXBwZWRIYW5kbGVyID0gYXN5bmMgKGV2ZW50OiBEb21haW5FdmVudDxUPikgPT4ge1xuICAgICAgdHJ5IHtcbiAgICAgICAgdGhpcy5sb2dnZXIuZGVidWcoYEhhbmRsaW5nIGV2ZW50OiAke2V2ZW50LmV2ZW50VHlwZX1gLCB7XG4gICAgICAgICAgZXZlbnRJZDogZXZlbnQuZXZlbnRJZCxcbiAgICAgICAgICBoYW5kbGVyTmFtZTogaGFuZGxlci5uYW1lLFxuICAgICAgICB9KTtcblxuICAgICAgICBhd2FpdCBoYW5kbGVyKGV2ZW50KTtcblxuICAgICAgICB0aGlzLmxvZ2dlci5kZWJ1ZyhgRXZlbnQgaGFuZGxlZCBzdWNjZXNzZnVsbHk6ICR7ZXZlbnQuZXZlbnRUeXBlfWAsIHtcbiAgICAgICAgICBldmVudElkOiBldmVudC5ldmVudElkLFxuICAgICAgICAgIGhhbmRsZXJOYW1lOiBoYW5kbGVyLm5hbWUsXG4gICAgICAgIH0pO1xuICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoYEV2ZW50IGhhbmRsZXIgZmFpbGVkOiAke2V2ZW50LmV2ZW50VHlwZX1gLCB7XG4gICAgICAgICAgZXZlbnRJZDogZXZlbnQuZXZlbnRJZCxcbiAgICAgICAgICBoYW5kbGVyTmFtZTogaGFuZGxlci5uYW1lLFxuICAgICAgICAgIGVycm9yOiBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6IFN0cmluZyhlcnJvciksXG4gICAgICAgICAgc3RhY2s6IGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5zdGFjayA6IHVuZGVmaW5lZCxcbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy8gUmUtdGhyb3cgdG8gYWxsb3cgRXZlbnRFbWl0dGVyMiB0byBoYW5kbGUgcmV0cnkgbG9naWNcbiAgICAgICAgdGhyb3cgZXJyb3I7XG4gICAgICB9XG4gICAgfTtcblxuICAgIGlmIChvcHRpb25zLmFzeW5jICE9PSBmYWxzZSkge1xuICAgICAgdGhpcy5ldmVudEVtaXR0ZXIub24oZXZlbnRUeXBlLCAoZXZlbnQ6IERvbWFpbkV2ZW50PFQ+KSA9PiB7XG4gICAgICAgIHZvaWQgd3JhcHBlZEhhbmRsZXIoZXZlbnQpO1xuICAgICAgfSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIEZvciBzeW5jaHJvbm91cyBoYW5kbGVycywgd2Ugc3RpbGwgdXNlIGFzeW5jIGJ1dCB3aXRob3V0IGF3YWl0XG4gICAgICB0aGlzLmV2ZW50RW1pdHRlci5vbihldmVudFR5cGUsIChldmVudDogRG9tYWluRXZlbnQ8VD4pID0+IHtcbiAgICAgICAgdm9pZCB3cmFwcGVkSGFuZGxlcihldmVudCkuY2F0Y2goKGVycm9yKSA9PiB7XG4gICAgICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoXG4gICAgICAgICAgICBgQXN5bmMgZXZlbnQgaGFuZGxlciBlcnJvcjogJHtldmVudC5ldmVudFR5cGV9YCxcbiAgICAgICAgICAgIGVycm9yLFxuICAgICAgICAgICk7XG4gICAgICAgIH0pO1xuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgdW5zdWJzY3JpYmUoZXZlbnRUeXBlOiBzdHJpbmcsIGhhbmRsZXI6ICguLi5hcmdzOiBhbnlbXSkgPT4gYW55KTogdm9pZCB7XG4gICAgdGhpcy5sb2dnZXIuZGVidWcoYFVuc3Vic2NyaWJpbmcgZnJvbSBldmVudDogJHtldmVudFR5cGV9YCwge1xuICAgICAgaGFuZGxlck5hbWU6IGhhbmRsZXIubmFtZSxcbiAgICB9KTtcblxuICAgIHRoaXMuZXZlbnRFbWl0dGVyLm9mZihldmVudFR5cGUsIGhhbmRsZXIpO1xuICB9XG5cbiAgLy8gQWRkaXRpb25hbCB1dGlsaXR5IG1ldGhvZHNcblxuICAvKipcbiAgICogU3Vic2NyaWJlIHRvIGFsbCBldmVudHMgb2YgYSBzcGVjaWZpYyBhZ2dyZWdhdGUgdHlwZVxuICAgKi9cbiAgc3Vic2NyaWJlVG9BZ2dyZWdhdGU8VCA9IGFueT4oXG4gICAgYWdncmVnYXRlVHlwZTogc3RyaW5nLFxuICAgIGhhbmRsZXI6IChldmVudDogRG9tYWluRXZlbnQ8VD4pID0+IFByb21pc2U8dm9pZD4sXG4gICAgb3B0aW9uczogRXZlbnRIYW5kbGVyT3B0aW9ucyA9IHt9LFxuICApOiB2b2lkIHtcbiAgICBjb25zdCBldmVudFBhdHRlcm4gPSBgJHthZ2dyZWdhdGVUeXBlfS4qYDtcbiAgICB0aGlzLnN1YnNjcmliZShldmVudFBhdHRlcm4sIGhhbmRsZXIsIG9wdGlvbnMpO1xuICB9XG5cbiAgLyoqXG4gICAqIFN1YnNjcmliZSB0byBhbGwgZXZlbnRzICh3aWxkY2FyZCBzdWJzY3JpcHRpb24pXG4gICAqL1xuICBzdWJzY3JpYmVUb0FsbDxUID0gYW55PihcbiAgICBoYW5kbGVyOiAoZXZlbnQ6IERvbWFpbkV2ZW50PFQ+KSA9PiBQcm9taXNlPHZvaWQ+LFxuICAgIG9wdGlvbnM6IEV2ZW50SGFuZGxlck9wdGlvbnMgPSB7fSxcbiAgKTogdm9pZCB7XG4gICAgdGhpcy5zdWJzY3JpYmUoJyonLCBoYW5kbGVyLCBvcHRpb25zKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgZXZlbnQgc3RhdGlzdGljc1xuICAgKi9cbiAgZ2V0RXZlbnRTdGF0cygpOiB7XG4gICAgdG90YWxMaXN0ZW5lcnM6IG51bWJlcjtcbiAgICBldmVudFR5cGVzOiBzdHJpbmdbXTtcbiAgfSB7XG4gICAgY29uc3QgZXZlbnROYW1lcyA9IHRoaXMuZXZlbnRFbWl0dGVyLmV2ZW50TmFtZXMoKTtcbiAgICByZXR1cm4ge1xuICAgICAgdG90YWxMaXN0ZW5lcnM6IGV2ZW50TmFtZXMucmVkdWNlKFxuICAgICAgICAodG90YWwsIGV2ZW50TmFtZSkgPT5cbiAgICAgICAgICB0b3RhbCArIHRoaXMuZXZlbnRFbWl0dGVyLmxpc3RlbmVyQ291bnQoZXZlbnROYW1lKSxcbiAgICAgICAgMCxcbiAgICAgICksXG4gICAgICBldmVudFR5cGVzOiBldmVudE5hbWVzIGFzIHN0cmluZ1tdLFxuICAgIH07XG4gIH1cblxuICAvKipcbiAgICogQ2hlY2sgaWYgdGhlcmUgYXJlIGxpc3RlbmVycyBmb3IgYSBzcGVjaWZpYyBldmVudCB0eXBlXG4gICAqL1xuICBoYXNMaXN0ZW5lcnMoZXZlbnRUeXBlOiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICByZXR1cm4gdGhpcy5ldmVudEVtaXR0ZXIubGlzdGVuZXJDb3VudChldmVudFR5cGUpID4gMDtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZW1vdmUgYWxsIGxpc3RlbmVycyBmb3IgYSBzcGVjaWZpYyBldmVudCB0eXBlXG4gICAqL1xuICByZW1vdmVBbGxMaXN0ZW5lcnMoZXZlbnRUeXBlPzogc3RyaW5nKTogdm9pZCB7XG4gICAgaWYgKGV2ZW50VHlwZSkge1xuICAgICAgdGhpcy5sb2dnZXIuZGVidWcoYFJlbW92aW5nIGFsbCBsaXN0ZW5lcnMgZm9yIGV2ZW50OiAke2V2ZW50VHlwZX1gKTtcbiAgICAgIHRoaXMuZXZlbnRFbWl0dGVyLnJlbW92ZUFsbExpc3RlbmVycyhldmVudFR5cGUpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmxvZ2dlci5kZWJ1ZygnUmVtb3ZpbmcgYWxsIGV2ZW50IGxpc3RlbmVycycpO1xuICAgICAgdGhpcy5ldmVudEVtaXR0ZXIucmVtb3ZlQWxsTGlzdGVuZXJzKCk7XG4gICAgfVxuICB9XG59XG4iXSwidmVyc2lvbiI6M30=