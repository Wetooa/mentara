{"file":"/home/wetooa/Documents/code/projects/mentara/mentara-api/src/communities/services/enhanced-community.service.ts","mappings":"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","names":[],"sources":["/home/wetooa/Documents/code/projects/mentara/mentara-api/src/communities/services/enhanced-community.service.ts"],"sourcesContent":["import {\n  Injectable,\n  Logger,\n  BadRequestException,\n  NotFoundException,\n} from '@nestjs/common';\nimport { PrismaService } from '../../providers/prisma-client.provider';\nimport { EventEmitter2 } from '@nestjs/event-emitter';\n\nexport interface CommunitySearchFilters {\n  query?: string;\n  tags?: string[];\n  minMembers?: number;\n  maxMembers?: number;\n  sortBy?: 'relevance' | 'members' | 'activity' | 'newest' | 'alphabetical';\n  sortOrder?: 'asc' | 'desc';\n  hasDescription?: boolean;\n  hasImage?: boolean;\n  membershipRequired?: boolean;\n}\n\nexport interface CommunitySearchResult {\n  id: string;\n  name: string;\n  slug: string;\n  description: string;\n  imageUrl: string;\n  memberCount: number;\n  recentActivity: {\n    postCount: number;\n    commentCount: number;\n    lastActivityAt: Date | null;\n  };\n  compatibility?: {\n    score: number;\n    reasoning: string;\n  };\n  membershipStatus: 'member' | 'pending' | 'none';\n  createdAt: Date;\n  tags?: string[];\n}\n\nexport interface EnhancedCommunityDetails {\n  id: string;\n  name: string;\n  slug: string;\n  description: string;\n  imageUrl: string;\n  createdAt: Date;\n  updatedAt: Date;\n  memberCount: number;\n  stats: {\n    totalPosts: number;\n    totalComments: number;\n    activeMembers: number;\n    recentActivity: {\n      postsThisWeek: number;\n      commentsThisWeek: number;\n      newMembersThisWeek: number;\n    };\n  };\n  recentPosts: {\n    id: string;\n    title: string;\n    content: string;\n    author: {\n      id: string;\n      firstName: string;\n      lastName: string;\n      avatarUrl?: string;\n    };\n    createdAt: Date;\n    heartCount: number;\n    commentCount: number;\n  }[];\n  topContributors: {\n    id: string;\n    firstName: string;\n    lastName: string;\n    avatarUrl?: string;\n    contributionScore: number;\n    postCount: number;\n    commentCount: number;\n  }[];\n  moderators: {\n    id: string;\n    firstName: string;\n    lastName: string;\n    avatarUrl?: string;\n    assignedAt: Date;\n  }[];\n  membershipStatus: 'member' | 'pending' | 'none';\n  userPermissions: {\n    canPost: boolean;\n    canComment: boolean;\n    canModerate: boolean;\n  };\n}\n\nexport interface CommunityTrendingData {\n  growthRate: number; // percentage growth in members\n  activityScore: number; // based on posts, comments, hearts\n  engagementRate: number; // comments per post ratio\n  retentionRate: number; // members active in last 30 days\n}\n\ninterface CommunityRecommendationContext {\n  userId: string;\n  includeSimilar?: boolean;\n  excludeJoined?: boolean;\n  maxResults?: number;\n}\n\n@Injectable()\nexport class EnhancedCommunityService {\n  private readonly logger = new Logger(EnhancedCommunityService.name);\n\n  constructor(\n    private readonly prisma: PrismaService,\n    private readonly eventEmitter: EventEmitter2,\n  ) {}\n\n  /**\n   * Advanced community search with filtering and ranking\n   */\n  async searchCommunities(\n    filters: CommunitySearchFilters,\n    userId?: string,\n    page = 1,\n    limit = 20,\n  ): Promise<{\n    communities: CommunitySearchResult[];\n    total: number;\n    page: number;\n    limit: number;\n    totalPages: number;\n    facets: {\n      memberRanges: { range: string; count: number }[];\n      commonTags: { tag: string; count: number }[];\n    };\n  }> {\n    try {\n      const offset = (page - 1) * limit;\n\n      // Build the search query\n      const where: any = {};\n      const orderBy: any = [];\n\n      // Text search\n      if (filters.query) {\n        where.OR = [\n          { name: { contains: filters.query, mode: 'insensitive' } },\n          { description: { contains: filters.query, mode: 'insensitive' } },\n        ];\n      }\n\n      // Filter by description/image presence\n      if (filters.hasDescription !== undefined) {\n        where.description = filters.hasDescription ? { not: '' } : '';\n      }\n      if (filters.hasImage !== undefined) {\n        where.imageUrl = filters.hasImage ? { not: '' } : '';\n      }\n\n      // Get communities with member counts and recent activity\n      const communities = await this.prisma.community.findMany({\n        where,\n        include: {\n          _count: {\n            select: {\n              memberships: true,\n            },\n          },\n          memberships: userId\n            ? {\n                where: { userId },\n                select: { id: true },\n              }\n            : false,\n        },\n        skip: offset,\n        take: limit,\n      });\n\n      // Apply member count filters and calculate activity\n      const filteredCommunities = communities.filter((community) => {\n        const memberCount = community._count.memberships;\n\n        if (filters.minMembers && memberCount < filters.minMembers)\n          return false;\n        if (filters.maxMembers && memberCount > filters.maxMembers)\n          return false;\n\n        return true;\n      });\n\n      // Join requests removed - simplified community system\n      const pendingRequests: string[] = [];\n\n      // Transform to search results\n      const searchResults: CommunitySearchResult[] = filteredCommunities.map(\n        (community) => {\n          const memberCount = community._count.memberships;\n          const postCount = 0; // Posts are in rooms, not direct community relation\n          const commentCount = 0; // Comments are in posts in rooms\n          const lastActivityAt = null; // Activity tracking simplified\n\n          // Determine membership status\n          let membershipStatus: 'member' | 'pending' | 'none' = 'none';\n          if (userId) {\n            if (community.memberships && community.memberships.length > 0) {\n              membershipStatus = 'member';\n            } else if (pendingRequests.includes(community.id)) {\n              membershipStatus = 'pending';\n            }\n          }\n\n          return {\n            id: community.id,\n            name: community.name,\n            slug: community.slug,\n            description: community.description,\n            imageUrl: community.imageUrl,\n            memberCount,\n            recentActivity: {\n              postCount,\n              commentCount,\n              lastActivityAt,\n            },\n            membershipStatus,\n            createdAt: community.createdAt,\n            tags: [], // Could be implemented with a tags system\n          };\n        },\n      );\n\n      // Apply sorting\n      this.applySorting(searchResults, filters.sortBy, filters.sortOrder);\n\n      // Calculate facets for filtering UI\n      const facets = await this.calculateSearchFacets(where);\n\n      // Get total count for pagination\n      const total = await this.prisma.community.count({ where });\n\n      return {\n        communities: searchResults,\n        total,\n        page,\n        limit,\n        totalPages: Math.ceil(total / limit),\n        facets,\n      };\n    } catch (error) {\n      this.logger.error(`Error searching communities:`, error);\n      throw error;\n    }\n  }\n\n  /**\n   * Get enhanced community details with comprehensive stats\n   */\n  async getCommunityDetails(\n    communityId: string,\n    userId?: string,\n  ): Promise<EnhancedCommunityDetails> {\n    try {\n      const community = await this.prisma.community.findUnique({\n        where: { id: communityId },\n        include: {\n          _count: {\n            select: {\n              memberships: true,\n            },\n          },\n          roomGroups: {\n            include: {\n              rooms: {\n                include: {\n                  posts: {\n                    include: {\n                      user: {\n                        select: {\n                          id: true,\n                          firstName: true,\n                          lastName: true,\n                          avatarUrl: true,\n                        },\n                      },\n                      _count: {\n                        select: {\n                          comments: true,\n                          hearts: true,\n                        },\n                      },\n                    },\n                    orderBy: { createdAt: 'desc' },\n                    take: 5,\n                  },\n                },\n              },\n            },\n          },\n          moderatorCommunities: {\n            include: {\n              moderator: {\n                include: {\n                  user: {\n                    select: {\n                      id: true,\n                      firstName: true,\n                      lastName: true,\n                      avatarUrl: true,\n                    },\n                  },\n                },\n              },\n            },\n          },\n          memberships: userId\n            ? {\n                where: { userId },\n                select: { id: true },\n              }\n            : false,\n        },\n      });\n\n      if (!community) {\n        throw new NotFoundException(`Community ${communityId} not found`);\n      }\n\n      // Calculate time ranges\n      const now = new Date();\n      const oneWeekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);\n      const oneMonthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);\n\n      // Get all posts from this community's rooms for statistics\n      const communityRoomIds = community.roomGroups.flatMap((rg) =>\n        rg.rooms.map((r) => r.id),\n      );\n\n      // Get detailed statistics\n      const [\n        totalComments,\n        weeklyPosts,\n        weeklyComments,\n        weeklyMembers,\n        activeMembers,\n        topContributors,\n      ] = await Promise.all([\n        this.prisma.comment.count({\n          where: {\n            post: { roomId: { in: communityRoomIds } },\n          },\n        }),\n        this.prisma.post.count({\n          where: {\n            roomId: { in: communityRoomIds },\n            createdAt: { gte: oneWeekAgo },\n          },\n        }),\n        this.prisma.comment.count({\n          where: {\n            post: { roomId: { in: communityRoomIds } },\n            createdAt: { gte: oneWeekAgo },\n          },\n        }),\n        this.prisma.membership.count({\n          where: {\n            communityId,\n            joinedAt: { gte: oneWeekAgo },\n          },\n        }),\n        this.prisma.membership.count({\n          where: {\n            communityId,\n            user: {\n              updatedAt: { gte: oneMonthAgo }, // Use updatedAt as proxy for activity\n            },\n          },\n        }),\n        this.getTopContributors(communityId, 5),\n      ]);\n\n      // Determine membership status and permissions\n      let membershipStatus: 'member' | 'pending' | 'none' = 'none';\n      let userPermissions = {\n        canPost: false,\n        canComment: false,\n        canModerate: false,\n      };\n\n      if (userId) {\n        const membership = community.memberships?.[0];\n        if (membership) {\n          membershipStatus = 'member';\n\n          // Check if user can moderate based on global role and community moderator assignment\n          const canModerate = await this.checkModerationPermissions(userId, communityId);\n\n          userPermissions = {\n            canPost: true,\n            canComment: true,\n            canModerate,\n          };\n        } else {\n          // Join requests removed - users are automatically assigned communities\n          // No pending status since users get immediate membership\n          membershipStatus = 'none';\n        }\n      }\n\n      return {\n        id: community.id,\n        name: community.name,\n        slug: community.slug,\n        description: community.description,\n        imageUrl: community.imageUrl,\n        createdAt: community.createdAt,\n        updatedAt: community.updatedAt,\n        memberCount: community._count.memberships,\n        stats: {\n          totalPosts: community.roomGroups.reduce(\n            (total, rg) =>\n              total +\n              rg.rooms.reduce(\n                (roomTotal, room) => roomTotal + room.posts.length,\n                0,\n              ),\n            0,\n          ),\n          totalComments,\n          activeMembers,\n          recentActivity: {\n            postsThisWeek: weeklyPosts,\n            commentsThisWeek: weeklyComments,\n            newMembersThisWeek: weeklyMembers,\n          },\n        },\n        recentPosts: community.roomGroups\n          .flatMap((rg) => rg.rooms.flatMap((room) => room.posts))\n          .sort((a, b) => b.createdAt.getTime() - a.createdAt.getTime())\n          .slice(0, 5)\n          .map((post) => ({\n            id: post.id,\n            title: post.title,\n            content: post.content,\n            author: post.user\n              ? {\n                  id: post.user.id,\n                  firstName: post.user.firstName,\n                  lastName: post.user.lastName,\n                  avatarUrl: post.user.avatarUrl || undefined,\n                }\n              : {\n                  id: 'unknown',\n                  firstName: 'Unknown',\n                  lastName: 'User',\n                  avatarUrl: undefined,\n                },\n            createdAt: post.createdAt,\n            heartCount: post._count.hearts,\n            commentCount: post._count.comments,\n          })),\n        topContributors,\n        moderators: community.moderatorCommunities.map((mc) => ({\n          id: mc.moderator.user.id,\n          firstName: mc.moderator.user.firstName,\n          lastName: mc.moderator.user.lastName,\n          avatarUrl: mc.moderator.user.avatarUrl || undefined,\n          assignedAt: mc.assignedAt,\n        })),\n        membershipStatus,\n        userPermissions,\n      };\n    } catch (error) {\n      this.logger.error(\n        `Error getting community details for ${communityId}:`,\n        error,\n      );\n      throw error;\n    }\n  }\n\n  /**\n   * Get trending communities based on growth and activity\n   */\n  async getTrendingCommunities(\n    limit = 10,\n    timeframe: 'week' | 'month' = 'week',\n  ): Promise<\n    (CommunitySearchResult & { trendingData: CommunityTrendingData })[]\n  > {\n    try {\n      const now = new Date();\n      const timeframeMs =\n        timeframe === 'week'\n          ? 7 * 24 * 60 * 60 * 1000\n          : 30 * 24 * 60 * 60 * 1000;\n      const startDate = new Date(now.getTime() - timeframeMs);\n      const previousStartDate = new Date(startDate.getTime() - timeframeMs);\n\n      const communities = await this.prisma.community.findMany({\n        include: {\n          _count: {\n            select: { memberships: true },\n          },\n          memberships: {\n            where: {\n              joinedAt: { gte: startDate },\n            },\n            select: { joinedAt: true },\n          },\n          roomGroups: {\n            include: {\n              rooms: {\n                include: {\n                  posts: {\n                    where: {\n                      createdAt: { gte: startDate },\n                    },\n                    include: {\n                      _count: {\n                        select: { comments: true, hearts: true },\n                      },\n                    },\n                  },\n                },\n              },\n            },\n          },\n        },\n      });\n\n      // Calculate trending data for each community\n      const trendingCommunities = await Promise.all(\n        communities.map(async (community) => {\n          const allPosts = community.roomGroups.flatMap((rg) =>\n            rg.rooms.flatMap((room) => room.posts),\n          );\n\n          const trendingData = await this.calculateTrendingData(\n            { ...community, posts: allPosts },\n            startDate,\n            previousStartDate,\n          );\n\n          return {\n            id: community.id,\n            name: community.name,\n            slug: community.slug,\n            description: community.description,\n            imageUrl: community.imageUrl,\n            memberCount: community._count.memberships,\n            recentActivity: {\n              postCount: allPosts.length,\n              commentCount: allPosts.reduce(\n                (sum, post) => sum + post._count.comments,\n                0,\n              ),\n              lastActivityAt:\n                allPosts.length > 0\n                  ? allPosts.reduce(\n                      (latest, post) =>\n                        post.createdAt > latest ? post.createdAt : latest,\n                      allPosts[0].createdAt,\n                    )\n                  : null,\n            },\n            membershipStatus: 'none' as const,\n            createdAt: community.createdAt,\n            trendingData,\n          };\n        }),\n      );\n\n      // Sort by trending score (combination of growth rate and activity)\n      trendingCommunities.sort((a, b) => {\n        const scoreA =\n          a.trendingData.growthRate * 0.4 +\n          a.trendingData.activityScore * 0.4 +\n          a.trendingData.engagementRate * 0.2;\n        const scoreB =\n          b.trendingData.growthRate * 0.4 +\n          b.trendingData.activityScore * 0.4 +\n          b.trendingData.engagementRate * 0.2;\n        return scoreB - scoreA;\n      });\n\n      return trendingCommunities.slice(0, limit);\n    } catch (error) {\n      this.logger.error(`Error getting trending communities:`, error);\n      throw error;\n    }\n  }\n\n  /**\n   * Get similar communities based on user activity and preferences\n   */\n  async getSimilarCommunities(\n    communityId: string,\n    context: CommunityRecommendationContext,\n  ): Promise<CommunitySearchResult[]> {\n    try {\n      const { userId, excludeJoined = true, maxResults = 5 } = context;\n\n      // Get the reference community\n      const refCommunity = await this.prisma.community.findUnique({\n        where: { id: communityId },\n        include: {\n          memberships: {\n            include: {\n              user: {\n                include: {\n                  memberships: {\n                    include: { community: true },\n                  },\n                },\n              },\n            },\n          },\n        },\n      });\n\n      if (!refCommunity) {\n        throw new NotFoundException(`Community ${communityId} not found`);\n      }\n\n      // Find communities that other members of this community have joined\n      const memberCommunities = new Map<string, number>();\n\n      refCommunity.memberships.forEach((membership) => {\n        if (membership.user) {\n          membership.user.memberships.forEach((userMembership) => {\n            if (userMembership.communityId !== communityId) {\n              const count =\n                memberCommunities.get(userMembership.communityId) || 0;\n              memberCommunities.set(userMembership.communityId, count + 1);\n            }\n          });\n        }\n      });\n\n      // Sort by overlap count and get top communities\n      const sortedCommunities = Array.from(memberCommunities.entries())\n        .sort((a, b) => b[1] - a[1])\n        .slice(0, maxResults * 2); // Get more to filter out joined ones\n\n      // Get community details\n      const communityIds = sortedCommunities.map(([id]) => id);\n      const communities = await this.prisma.community.findMany({\n        where: { id: { in: communityIds } },\n        include: {\n          _count: { select: { memberships: true } },\n          roomGroups: {\n            include: {\n              rooms: {\n                include: {\n                  _count: { select: { posts: true } },\n                },\n              },\n            },\n          },\n        },\n      });\n\n      // Get user's joined communities if excluding them\n      let userCommunityIds: string[] = [];\n      if (excludeJoined && userId) {\n        const userMemberships = await this.prisma.membership.findMany({\n          where: { userId },\n          select: { communityId: true },\n        });\n        userCommunityIds = userMemberships.map((m) => m.communityId);\n      }\n\n      // Filter and format results\n      const similarCommunities = communities\n        .filter((community) => !userCommunityIds.includes(community.id))\n        .map((community) => ({\n          id: community.id,\n          name: community.name,\n          slug: community.slug,\n          description: community.description,\n          imageUrl: community.imageUrl,\n          memberCount: community._count.memberships,\n          recentActivity: {\n            postCount: community.roomGroups.reduce(\n              (total, rg) =>\n                total +\n                rg.rooms.reduce(\n                  (roomTotal, room) => roomTotal + room._count.posts,\n                  0,\n                ),\n              0,\n            ),\n            commentCount: 0, // Could be calculated if needed\n            lastActivityAt: null,\n          },\n          membershipStatus: 'none' as const,\n          createdAt: community.createdAt,\n        }))\n        .slice(0, maxResults);\n\n      return similarCommunities;\n    } catch (error) {\n      this.logger.error(\n        `Error getting similar communities for ${communityId}:`,\n        error,\n      );\n      throw error;\n    }\n  }\n\n  /**\n   * Private helper methods\n   */\n  private applySorting(\n    communities: CommunitySearchResult[],\n    sortBy: string = 'relevance',\n    sortOrder: string = 'desc',\n  ): void {\n    const ascending = sortOrder === 'asc';\n\n    switch (sortBy) {\n      case 'members':\n        communities.sort((a, b) =>\n          ascending\n            ? a.memberCount - b.memberCount\n            : b.memberCount - a.memberCount,\n        );\n        break;\n\n      case 'activity':\n        communities.sort((a, b) => {\n          const activityA =\n            a.recentActivity.postCount + a.recentActivity.commentCount;\n          const activityB =\n            b.recentActivity.postCount + b.recentActivity.commentCount;\n          return ascending ? activityA - activityB : activityB - activityA;\n        });\n        break;\n\n      case 'newest':\n        communities.sort((a, b) =>\n          ascending\n            ? a.createdAt.getTime() - b.createdAt.getTime()\n            : b.createdAt.getTime() - a.createdAt.getTime(),\n        );\n        break;\n\n      case 'alphabetical':\n        communities.sort((a, b) =>\n          ascending\n            ? a.name.localeCompare(b.name)\n            : b.name.localeCompare(a.name),\n        );\n        break;\n\n      default: // relevance\n        // Default sorting by member count for now\n        communities.sort((a, b) => b.memberCount - a.memberCount);\n        break;\n    }\n  }\n\n  private async calculateSearchFacets(where: any): Promise<{\n    memberRanges: { range: string; count: number }[];\n    commonTags: { tag: string; count: number }[];\n  }> {\n    try {\n      // Calculate member range distribution\n      const memberRanges = [\n        { range: '1-10', min: 1, max: 10 },\n        { range: '11-50', min: 11, max: 50 },\n        { range: '51-100', min: 51, max: 100 },\n        { range: '101-500', min: 101, max: 500 },\n        { range: '500+', min: 501, max: 999999 },\n      ];\n\n      const memberRangeCounts = await Promise.all(\n        memberRanges.map(async (range) => {\n          const count = await this.prisma.community.count({\n            where: {\n              ...where,\n              memberships: {\n                _count: {\n                  gte: range.min,\n                  ...(range.max < 999999 ? { lte: range.max } : {}),\n                },\n              },\n            },\n          });\n          return { range: range.range, count };\n        }),\n      );\n\n      return {\n        memberRanges: memberRangeCounts,\n        commonTags: [], // Could be implemented with a tag system\n      };\n    } catch (error) {\n      this.logger.error('Error calculating search facets:', error);\n      return {\n        memberRanges: [],\n        commonTags: [],\n      };\n    }\n  }\n\n  private async calculateTrendingData(\n    community: any,\n    startDate: Date,\n    previousStartDate: Date,\n  ): Promise<CommunityTrendingData> {\n    try {\n      // Calculate growth rate\n      const currentMembers = community.memberships.length;\n      const previousMembers = await this.prisma.membership.count({\n        where: {\n          communityId: community.id,\n          joinedAt: {\n            gte: previousStartDate,\n            lt: startDate,\n          },\n        },\n      });\n\n      const growthRate =\n        previousMembers > 0\n          ? ((currentMembers - previousMembers) / previousMembers) * 100\n          : currentMembers > 0\n            ? 100\n            : 0;\n\n      // Calculate activity score\n      const totalInteractions = community.posts.reduce(\n        (sum: number, post: any) =>\n          sum + post._count.comments + post._count.hearts,\n        0,\n      );\n      const activityScore = Math.min(\n        (totalInteractions / Math.max(community._count.memberships, 1)) * 10,\n        100,\n      );\n\n      // Calculate engagement rate\n      const totalPosts = community.posts.length;\n      const totalComments = community.posts.reduce(\n        (sum: number, post: any) => sum + post._count.comments,\n        0,\n      );\n      const engagementRate =\n        totalPosts > 0 ? (totalComments / totalPosts) * 10 : 0;\n\n      // Calculate retention rate (simplified)\n      const retentionRate = Math.min(\n        (currentMembers / Math.max(community._count.memberships, 1)) * 100,\n        100,\n      );\n\n      return {\n        growthRate: Math.max(0, growthRate),\n        activityScore: Math.max(0, activityScore),\n        engagementRate: Math.max(0, engagementRate),\n        retentionRate: Math.max(0, retentionRate),\n      };\n    } catch (error) {\n      this.logger.error('Error calculating trending data:', error);\n      return {\n        growthRate: 0,\n        activityScore: 0,\n        engagementRate: 0,\n        retentionRate: 0,\n      };\n    }\n  }\n\n  private async getTopContributors(\n    communityId: string,\n    limit: number,\n  ): Promise<\n    {\n      id: string;\n      firstName: string;\n      lastName: string;\n      avatarUrl?: string;\n      contributionScore: number;\n      postCount: number;\n      commentCount: number;\n    }[]\n  > {\n    try {\n      // Get room IDs for this community\n      const community = await this.prisma.community.findUnique({\n        where: { id: communityId },\n        include: {\n          roomGroups: {\n            include: {\n              rooms: { select: { id: true } },\n            },\n          },\n        },\n      });\n\n      if (!community) return [];\n\n      const roomIds = community.roomGroups.flatMap((rg) =>\n        rg.rooms.map((r) => r.id),\n      );\n\n      // Get users with their contribution counts\n      const contributors = await this.prisma.user.findMany({\n        where: {\n          memberships: {\n            some: { communityId },\n          },\n        },\n        select: {\n          id: true,\n          firstName: true,\n          lastName: true,\n          avatarUrl: true,\n          _count: {\n            select: {\n              posts: {\n                where: { roomId: { in: roomIds } },\n              },\n              comments: {\n                where: {\n                  post: { roomId: { in: roomIds } },\n                },\n              },\n            },\n          },\n        },\n        take: limit * 2, // Get more to calculate scores\n      });\n\n      // Calculate contribution scores and sort\n      const scoredContributors = contributors\n        .map((contributor) => {\n          const postCount = contributor._count.posts;\n          const commentCount = contributor._count.comments;\n          const contributionScore = postCount * 3 + commentCount * 1; // Posts worth more than comments\n\n          return {\n            id: contributor.id,\n            firstName: contributor.firstName,\n            lastName: contributor.lastName,\n            avatarUrl: contributor.avatarUrl || undefined,\n            contributionScore,\n            postCount: Number(postCount),\n            commentCount: Number(commentCount),\n          };\n        })\n        .filter((contributor) => contributor.contributionScore > 0)\n        .sort((a, b) => b.contributionScore - a.contributionScore)\n        .slice(0, limit);\n\n      return scoredContributors;\n    } catch (error) {\n      this.logger.error(\n        `Error getting top contributors for community ${communityId}:`,\n        error,\n      );\n      return [];\n    }\n  }\n\n  /**\n   * Check if user can moderate a specific community\n   */\n  private async checkModerationPermissions(\n    userId: string,\n    communityId: string,\n  ): Promise<boolean> {\n    try {\n      // Check if user is a global admin\n      const user = await this.prisma.user.findUnique({\n        where: { id: userId },\n        select: { role: true },\n      });\n\n      if (user?.role === 'admin') {\n        return true; // Global admins can moderate all communities\n      }\n\n      // Check if user is assigned as a moderator for this specific community\n      const moderatorCommunity = await this.prisma.moderatorCommunity.findFirst({\n        where: {\n          moderatorId: userId,\n          communityId,\n        },\n      });\n\n      return !!moderatorCommunity;\n    } catch (error) {\n      this.logger.error(\n        `Error checking moderation permissions for user ${userId} in community ${communityId}:`,\n        error,\n      );\n      return false;\n    }\n  }\n}\n"],"version":3}