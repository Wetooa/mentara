{"file":"/home/wetooa/Documents/code/projects/mentara/mentara-api/src/messaging/services/websocket-event.service.ts","mappings":"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","names":[],"sources":["/home/wetooa/Documents/code/projects/mentara/mentara-api/src/messaging/services/websocket-event.service.ts"],"sourcesContent":["import { Injectable, Logger, OnModuleInit } from '@nestjs/common';\nimport { EventBusService } from '../../common/events/event-bus.service';\nimport { DomainEvent } from '../../common/events/interfaces/domain-event.interface';\nimport {\n  MessageSentEvent,\n  MessageReadEvent,\n  ConversationCreatedEvent,\n  ParticipantJoinedEvent,\n  ParticipantLeftEvent,\n  TypingIndicatorEvent,\n} from '../../common/events/messaging-events';\nimport {\n  AppointmentBookedEvent,\n  AppointmentCancelledEvent,\n} from '../../common/events/booking-events';\nimport {\n  UserRegisteredEvent,\n  UserProfileUpdatedEvent,\n} from '../../common/events/user-events';\nimport {\n  PostCreatedEvent,\n  CommentAddedEvent,\n} from '../../common/events/social-events';\nimport { MessagingGateway } from '../messaging.gateway';\n\n@Injectable()\nexport class WebSocketEventService implements OnModuleInit {\n  private readonly logger = new Logger(WebSocketEventService.name);\n\n  constructor(\n    private readonly eventBus: EventBusService,\n    private readonly messagingGateway: MessagingGateway,\n  ) {}\n\n  onModuleInit() {\n    this.subscribeToEvents();\n    this.logger.log('WebSocket event handlers initialized successfully');\n  }\n\n  private subscribeToEvents(): void {\n    // Subscribe to messaging events\n    this.subscribeToMessagingEvents();\n\n    // Subscribe to booking events\n    this.subscribeToBookingEvents();\n\n    // Subscribe to user events\n    this.subscribeToUserEvents();\n\n    // Subscribe to social events\n    this.subscribeToSocialEvents();\n\n    this.logger.log('Subscribed to all WebSocket event handlers');\n  }\n\n  private subscribeToMessagingEvents(): void {\n    // Message sent event - broadcast to conversation participants\n    this.eventBus.subscribe(\n      'MessageSentEvent',\n      async (event: DomainEvent<any>) => {\n        try {\n          const messageEvent = event as MessageSentEvent;\n          const {\n            conversationId,\n            messageId,\n            senderId,\n            content,\n            messageType,\n            sentAt,\n            recipientIds,\n          } = messageEvent.eventData;\n\n          this.logger.debug('MessageSentEvent received:', {\n            conversationId,\n            messageId,\n            recipientIds,\n            recipientIdsType: typeof recipientIds,\n            isArray: Array.isArray(recipientIds),\n          });\n\n          // Broadcast message to conversation participants via WebSocket\n          // Frontend expects MessageEventData format with 'message' property\n          this.messagingGateway.broadcastMessage(conversationId, {\n            message: {\n              id: messageId,\n              conversationId,\n              senderId,\n              content,\n              messageType,\n              sentAt,\n              createdAt: sentAt,\n              updatedAt: sentAt,\n              isRead: false,\n              isEdited: false,\n              isDeleted: false,\n              replyToId: messageEvent.eventData.replyToMessageId || null,\n              attachmentUrls: messageEvent.eventData.fileAttachments || [],\n              attachmentNames: [],\n              attachmentSizes: [],\n              editedAt: null,\n              sender: null, // Will be populated by client\n              replyTo: null,\n              reactions: [],\n              readReceipts: [],\n            },\n            eventType: 'message_sent',\n          });\n\n          // Send delivery confirmations with safe iteration\n          const safeRecipientIds = this.ensureArray(recipientIds, 'recipientIds');\n          for (const recipientId of safeRecipientIds) {\n            if (recipientId && typeof recipientId === 'string') {\n              this.messagingGateway.server\n                .to(this.getUserSocketRoom(recipientId))\n                .emit('message_delivered', {\n                  messageId,\n                  conversationId,\n                  deliveredAt: new Date(),\n                  eventType: 'message_delivered',\n                });\n            } else {\n              this.logger.warn(`Invalid recipientId in MessageSentEvent: ${recipientId}`, {\n                messageId,\n                conversationId,\n                recipientId,\n                type: typeof recipientId,\n              });\n            }\n          }\n\n          this.logger.debug(`Broadcasted message sent event: ${messageId} to ${safeRecipientIds.length} recipients`);\n        } catch (error) {\n          this.logger.error('Error handling MessageSentEvent:', {\n            error: error.message,\n            stack: error.stack,\n            eventData: event.eventData,\n          });\n        }\n      },\n    );\n\n    // Message read event - broadcast read receipt\n    this.eventBus.subscribe(\n      'MessageReadEvent',\n      async (event: DomainEvent<any>) => {\n        try {\n          const readEvent = event as MessageReadEvent;\n          const { messageId, conversationId, readBy } = readEvent.eventData;\n\n          this.messagingGateway.broadcastReadReceipt(\n            conversationId,\n            messageId,\n            readBy,\n          );\n\n          this.logger.debug(\n            `Broadcasted message read event: ${messageId} by ${readBy}`,\n          );\n        } catch (error) {\n          this.logger.error('Error handling MessageReadEvent:', {\n            error: error.message,\n            eventData: event.eventData,\n          });\n        }\n      },\n    );\n\n    // Conversation created event - notify participants\n    this.eventBus.subscribe(\n      'ConversationCreatedEvent',\n      async (event: DomainEvent<any>) => {\n        try {\n          const conversationEvent = event as ConversationCreatedEvent;\n          const {\n            conversationId,\n            createdBy,\n            participantIds,\n            conversationType,\n            title,\n          } = conversationEvent.eventData;\n\n          // Enhanced debugging for the problematic participantIds\n          this.logger.debug('ConversationCreatedEvent received:', {\n            conversationId,\n            createdBy,\n            participantIds,\n            participantIdsType: typeof participantIds,\n            isArray: Array.isArray(participantIds),\n            participantIdsLength: participantIds?.length,\n            fullEventData: event.eventData,\n          });\n\n          // Ensure participantIds is always an array with safe iteration\n          const safeParticipantIds = this.ensureArray(participantIds, 'participantIds');\n\n          if (safeParticipantIds.length === 0) {\n            this.logger.warn('ConversationCreatedEvent has no valid participants:', {\n              conversationId,\n              originalParticipantIds: participantIds,\n              eventData: event.eventData,\n            });\n            return;\n          }\n\n          // Notify all participants about new conversation\n          for (const participantId of safeParticipantIds) {\n            if (participantId && typeof participantId === 'string') {\n              this.messagingGateway.server\n                .to(this.getUserSocketRoom(participantId))\n                .emit('conversation_created', {\n                  conversationId,\n                  createdBy,\n                  conversationType,\n                  title,\n                  participantIds: safeParticipantIds, // Send normalized array\n                  eventType: 'conversation_created',\n                  timestamp: new Date(),\n                });\n            } else {\n              this.logger.warn(`Invalid participantId in ConversationCreatedEvent: ${participantId}`, {\n                conversationId,\n                participantId,\n                type: typeof participantId,\n                originalParticipantIds: participantIds,\n              });\n            }\n          }\n\n          this.logger.debug(\n            `Broadcasted conversation created event: ${conversationId} to ${safeParticipantIds.length} participants`,\n          );\n        } catch (error) {\n          this.logger.error('Error handling ConversationCreatedEvent:', {\n            error: error.message,\n            stack: error.stack,\n            eventData: event.eventData,\n          });\n        }\n      },\n    );\n\n    // Participant joined event - notify conversation\n    this.eventBus.subscribe(\n      'ParticipantJoinedEvent',\n      async (event: DomainEvent<any>) => {\n        try {\n          const joinEvent = event as ParticipantJoinedEvent;\n          const { conversationId, participantId, addedBy, joinedAt, role } =\n            joinEvent.eventData;\n\n          this.messagingGateway.server\n            .to(conversationId)\n            .emit('participant_joined', {\n              conversationId,\n              participantId,\n              addedBy,\n              joinedAt,\n              role,\n              eventType: 'participant_joined',\n            });\n\n          this.logger.debug(\n            `Broadcasted participant joined event: ${participantId} to ${conversationId}`,\n          );\n        } catch (error) {\n          this.logger.error('Error handling ParticipantJoinedEvent:', {\n            error: error.message,\n            eventData: event.eventData,\n          });\n        }\n      },\n    );\n\n    // Participant left event - notify conversation\n    this.eventBus.subscribe(\n      'ParticipantLeftEvent',\n      async (event: DomainEvent<any>) => {\n        try {\n          const leftEvent = event as ParticipantLeftEvent;\n          const { conversationId, participantId, leftAt, leftReason } =\n            leftEvent.eventData;\n\n          this.messagingGateway.server\n            .to(conversationId)\n            .emit('participant_left', {\n              conversationId,\n              participantId,\n              leftAt,\n              leftReason,\n              eventType: 'participant_left',\n            });\n\n          this.logger.debug(\n            `Broadcasted participant left event: ${participantId} from ${conversationId}`,\n          );\n        } catch (error) {\n          this.logger.error('Error handling ParticipantLeftEvent:', {\n            error: error.message,\n            eventData: event.eventData,\n          });\n        }\n      },\n    );\n\n    // Typing indicator event - relay to conversation\n    this.eventBus.subscribe(\n      'TypingIndicatorEvent',\n      async (event: DomainEvent<any>) => {\n        try {\n          const typingEvent = event as TypingIndicatorEvent;\n          const { conversationId, userId, isTyping, timestamp } =\n            typingEvent.eventData;\n\n          this.messagingGateway.server\n            .to(conversationId)\n            .emit('typing_indicator', {\n              conversationId,\n              userId,\n              isTyping,\n              timestamp,\n              eventType: 'typing_indicator',\n            });\n\n          this.logger.debug(\n            `Relayed typing indicator: ${userId} in ${conversationId} - ${isTyping}`,\n          );\n        } catch (error) {\n          this.logger.error('Error handling TypingIndicatorEvent:', {\n            error: error.message,\n            eventData: event.eventData,\n          });\n        }\n      },\n    );\n  }\n\n  private subscribeToBookingEvents(): void {\n    // Appointment booked event - notify therapist and client\n    this.eventBus.subscribe(\n      'AppointmentBookedEvent',\n      async (event: DomainEvent<any>) => {\n        const appointmentEvent = event as AppointmentBookedEvent;\n        const {\n          appointmentId,\n          clientId,\n          therapistId,\n          startTime,\n          meetingType,\n          isInitialConsultation,\n        } = appointmentEvent.eventData;\n\n        const appointmentNotification = {\n          appointmentId,\n          clientId,\n          therapistId,\n          startTime,\n          meetingType,\n          isInitialConsultation,\n          eventType: 'appointment_booked',\n          timestamp: new Date(),\n        };\n\n        // Notify client\n        this.messagingGateway.server\n          .to(this.getUserSocketRoom(clientId))\n          .emit('appointment_notification', {\n            ...appointmentNotification,\n            message:\n              'Your appointment has been booked and is pending confirmation.',\n          });\n\n        // Notify therapist\n        this.messagingGateway.server\n          .to(this.getUserSocketRoom(therapistId))\n          .emit('appointment_notification', {\n            ...appointmentNotification,\n            message:\n              'You have a new appointment request that requires confirmation.',\n          });\n\n        this.logger.debug(\n          `Broadcasted appointment booked event: ${appointmentId}`,\n        );\n      },\n    );\n\n    // Appointment cancelled event - notify both parties\n    this.eventBus.subscribe(\n      'AppointmentCancelledEvent',\n      async (event: DomainEvent<any>) => {\n        const cancelEvent = event as AppointmentCancelledEvent;\n        const {\n          appointmentId,\n          clientId,\n          therapistId,\n          cancelledBy,\n          cancellationReason,\n          cancelledAt,\n        } = cancelEvent.eventData;\n\n        const cancellationNotification = {\n          appointmentId,\n          clientId,\n          therapistId,\n          cancelledBy,\n          cancellationReason,\n          cancelledAt,\n          eventType: 'appointment_cancelled',\n          timestamp: new Date(),\n        };\n\n        // Determine message based on who cancelled\n        const clientMessage =\n          cancelledBy === clientId\n            ? 'You have cancelled your appointment.'\n            : 'Your appointment has been cancelled by the therapist.';\n\n        const therapistMessage =\n          cancelledBy === therapistId\n            ? 'You have cancelled the appointment.'\n            : 'The client has cancelled their appointment.';\n\n        // Notify client\n        this.messagingGateway.server\n          .to(this.getUserSocketRoom(clientId))\n          .emit('appointment_notification', {\n            ...cancellationNotification,\n            message: clientMessage,\n          });\n\n        // Notify therapist\n        this.messagingGateway.server\n          .to(this.getUserSocketRoom(therapistId))\n          .emit('appointment_notification', {\n            ...cancellationNotification,\n            message: therapistMessage,\n          });\n\n        this.logger.debug(\n          `Broadcasted appointment cancelled event: ${appointmentId}`,\n        );\n      },\n    );\n  }\n\n  private subscribeToUserEvents(): void {\n    // User registered event - welcome notification\n    this.eventBus.subscribe(\n      'UserRegisteredEvent',\n      async (event: DomainEvent<any>) => {\n        const registrationEvent = event as UserRegisteredEvent;\n        const { userId, firstName, lastName, role } =\n          registrationEvent.eventData;\n\n        // Send welcome notification to the new user\n        this.messagingGateway.server\n          .to(this.getUserSocketRoom(userId))\n          .emit('welcome_notification', {\n            userId,\n            firstName,\n            lastName,\n            role,\n            eventType: 'user_registered',\n            message: `Welcome to Mentara, ${firstName}! Your account has been successfully created.`,\n            timestamp: new Date(),\n          });\n\n        this.logger.debug(`Sent welcome notification to new user: ${userId}`);\n      },\n    );\n\n    // User profile updated event - notify relevant connections\n    this.eventBus.subscribe(\n      'UserProfileUpdatedEvent',\n      async (event: DomainEvent<any>) => {\n        const profileEvent = event as UserProfileUpdatedEvent;\n        const { userId, updatedFields, newValues } = profileEvent.eventData;\n\n        // Notify conversations where profile info might be displayed\n        this.messagingGateway.server.emit('user_profile_updated', {\n          userId,\n          updatedFields,\n          profileData: newValues,\n          eventType: 'user_profile_updated',\n          timestamp: new Date(),\n        });\n\n        this.logger.debug(`Broadcasted user profile update: ${userId}`);\n      },\n    );\n  }\n\n  private subscribeToSocialEvents(): void {\n    // Post created event - notify community members\n    this.eventBus.subscribe(\n      'PostCreatedEvent',\n      async (event: DomainEvent<any>) => {\n        const postEvent = event as PostCreatedEvent;\n        const {\n          postId,\n          authorId,\n          communityId,\n          title,\n          content,\n          tags,\n          postType,\n          isAnonymous,\n        } = postEvent.eventData;\n\n        // Broadcast to community room\n        if (communityId) {\n          this.messagingGateway.server\n            .to(`community_${communityId}`)\n            .emit('new_post', {\n              postId,\n              authorId: isAnonymous ? null : authorId, // Hide author if anonymous\n              communityId,\n              title,\n              content,\n              tags,\n              postType,\n              isAnonymous,\n              eventType: 'post_created',\n              timestamp: new Date(),\n            });\n        }\n\n        this.logger.debug(`Broadcasted post created event: ${postId}`);\n      },\n    );\n\n    // Comment added event - notify post author and participants\n    this.eventBus.subscribe(\n      'CommentAddedEvent',\n      async (event: DomainEvent<any>) => {\n        const commentEvent = event as CommentAddedEvent;\n        const { commentId, postId, authorId, content } = commentEvent.eventData;\n\n        // Broadcast to post room\n        this.messagingGateway.server\n          .to(`post_${postId}`)\n          .emit('post_interaction', {\n            commentId,\n            postId,\n            authorId,\n            content,\n            interactionType: 'comment',\n            eventType: 'comment_created',\n            message: 'Someone commented on your post',\n            timestamp: new Date(),\n          });\n\n        // Broadcast to post viewers\n        this.messagingGateway.server.to(`post_${postId}`).emit('new_comment', {\n          commentId,\n          postId,\n          authorId,\n          content,\n          eventType: 'comment_created',\n          timestamp: new Date(),\n        });\n\n        this.logger.debug(\n          `Broadcasted comment created event: ${commentId} on post ${postId}`,\n        );\n      },\n    );\n  }\n\n  /**\n   * Helper method to get user socket room name\n   */\n  private getUserSocketRoom(userId: string): string {\n    return `user_${userId}`;\n  }\n\n  /**\n   * Safely ensure a value is an array for iteration\n   * Prevents \"not iterable\" errors by normalizing input to array format\n   */\n  private ensureArray(value: any, fieldName: string = 'value'): string[] {\n    try {\n      // Handle null or undefined\n      if (value == null) {\n        this.logger.warn(`${fieldName} is null/undefined, returning empty array`);\n        return [];\n      }\n\n      // Already an array - validate it's an array of strings\n      if (Array.isArray(value)) {\n        const validItems = value.filter(item => \n          item != null && typeof item === 'string' && item.trim().length > 0\n        );\n        \n        if (validItems.length !== value.length) {\n          this.logger.warn(`${fieldName} array contains invalid items:`, {\n            original: value,\n            filtered: validItems,\n            removed: value.length - validItems.length,\n          });\n        }\n        \n        return validItems;\n      }\n\n      // Single string value - convert to array\n      if (typeof value === 'string' && value.trim().length > 0) {\n        this.logger.warn(`${fieldName} is a single string, converting to array:`, value);\n        return [value.trim()];\n      }\n\n      // Object - try to extract meaningful values\n      if (typeof value === 'object') {\n        this.logger.warn(`${fieldName} is an object, attempting to extract values:`, value);\n        \n        // Try common object patterns\n        if (value.participantIds && Array.isArray(value.participantIds)) {\n          return this.ensureArray(value.participantIds, `${fieldName}.participantIds`);\n        }\n        \n        if (value.ids && Array.isArray(value.ids)) {\n          return this.ensureArray(value.ids, `${fieldName}.ids`);\n        }\n        \n        // Try Object.values if it looks like a map\n        const objectValues = Object.values(value);\n        if (objectValues.length > 0 && objectValues.every(v => typeof v === 'string')) {\n          this.logger.warn(`${fieldName} object converted using Object.values:`, objectValues);\n          return objectValues as string[];\n        }\n      }\n\n      // Fallback for unexpected types\n      this.logger.error(`${fieldName} has unexpected type, returning empty array:`, {\n        value,\n        type: typeof value,\n        constructor: value?.constructor?.name,\n      });\n      \n      return [];\n    } catch (error) {\n      this.logger.error(`Error in ensureArray for ${fieldName}:`, {\n        error: error.message,\n        value,\n        type: typeof value,\n      });\n      return [];\n    }\n  }\n\n  /**\n   * Subscribe users to their personal notification rooms\n   */\n  subscribeUserToPersonalRoom(userId: string, socketId: string): void {\n    const userRoom = this.getUserSocketRoom(userId);\n    this.messagingGateway.server.in(socketId).socketsJoin(userRoom);\n    this.logger.debug(\n      `User ${userId} subscribed to personal room: ${userRoom}`,\n    );\n  }\n\n  /**\n   * Unsubscribe users from their personal notification rooms\n   */\n  unsubscribeUserFromPersonalRoom(userId: string, socketId: string): void {\n    const userRoom = this.getUserSocketRoom(userId);\n    this.messagingGateway.server.in(socketId).socketsLeave(userRoom);\n    this.logger.debug(\n      `User ${userId} unsubscribed from personal room: ${userRoom}`,\n    );\n  }\n\n  /**\n   * Subscribe user to community room for post notifications\n   */\n  subscribeUserToCommunityRoom(\n    userId: string,\n    communityId: string,\n    socketId: string,\n  ): void {\n    const communityRoom = `community_${communityId}`;\n    this.messagingGateway.server.in(socketId).socketsJoin(communityRoom);\n    this.logger.debug(\n      `User ${userId} subscribed to community room: ${communityRoom}`,\n    );\n  }\n\n  /**\n   * Subscribe user to post room for comment notifications\n   */\n  subscribeUserToPostRoom(\n    userId: string,\n    postId: string,\n    socketId: string,\n  ): void {\n    const postRoom = `post_${postId}`;\n    this.messagingGateway.server.in(socketId).socketsJoin(postRoom);\n    this.logger.debug(`User ${userId} subscribed to post room: ${postRoom}`);\n  }\n\n  /**\n   * Get connection statistics\n   */\n  getConnectionStats(): {\n    totalConnections: number;\n    eventSubscriptions: number;\n  } {\n    return {\n      totalConnections: this.messagingGateway.server.sockets.sockets.size,\n      eventSubscriptions: this.eventBus.getEventStats().totalListeners,\n    };\n  }\n\n  /**\n   * Broadcast system-wide announcement\n   */\n  broadcastSystemAnnouncement(\n    message: string,\n    priority: 'low' | 'medium' | 'high' = 'medium',\n  ): void {\n    this.messagingGateway.server.emit('system_announcement', {\n      message,\n      priority,\n      eventType: 'system_announcement',\n      timestamp: new Date(),\n    });\n\n    this.logger.log(\n      `Broadcasted system announcement: ${message} (priority: ${priority})`,\n    );\n  }\n\n  /**\n   * Send targeted notification to specific users\n   */\n  sendTargetedNotification(userIds: string[], notification: any): void {\n    for (const userId of userIds) {\n      this.messagingGateway.server\n        .to(this.getUserSocketRoom(userId))\n        .emit('targeted_notification', {\n          ...notification,\n          eventType: 'targeted_notification',\n          timestamp: new Date(),\n        });\n    }\n\n    this.logger.debug(`Sent targeted notification to ${userIds.length} users`);\n  }\n}\n"],"version":3}