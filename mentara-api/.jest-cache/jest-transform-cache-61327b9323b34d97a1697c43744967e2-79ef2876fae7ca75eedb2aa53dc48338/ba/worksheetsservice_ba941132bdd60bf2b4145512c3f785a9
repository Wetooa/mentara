e78929d8bb59d32a2b09a7dc1d5a3112
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
exports.WorksheetsService = void 0;
const common_1 = require("@nestjs/common");
const prisma_client_provider_1 = require("src/providers/prisma-client.provider");
let WorksheetsService = class WorksheetsService {
    prisma;
    constructor(prisma) {
        this.prisma = prisma;
    }
    async findAll(userId, therapistId, status, limit) {
        const where = {};
        if (userId) {
            where['clientId'] = userId; // Use clientId for proper relation
        }
        if (therapistId) {
            where['therapistId'] = therapistId;
        }
        if (status) {
            where['status'] = status;
        }
        // Get total count for pagination
        const total = await this.prisma.worksheet.count({ where });
        // Apply limit if specified
        const take = limit ? Number(limit) : undefined;
        const worksheets = await this.prisma.worksheet.findMany({
            where,
            take,
            include: {
                client: {
                    include: {
                        user: {
                            select: {
                                id: true,
                                firstName: true,
                                lastName: true,
                                avatarUrl: true,
                            },
                        },
                    },
                },
                therapist: {
                    include: {
                        user: {
                            select: {
                                id: true,
                                firstName: true,
                                lastName: true,
                                avatarUrl: true,
                            },
                        },
                    },
                },
                submission: true,
            },
            orderBy: {
                createdAt: 'desc',
            },
        });
        const hasMore = limit ? worksheets.length >= limit : false;
        return {
            worksheets,
            total,
            hasMore,
        };
    }
    async findById(id) {
        const worksheet = await this.prisma.worksheet.findUnique({
            where: { id },
            include: {
                client: {
                    include: {
                        user: {
                            select: {
                                id: true,
                                firstName: true,
                                lastName: true,
                                avatarUrl: true,
                            },
                        },
                    },
                },
                therapist: {
                    include: {
                        user: {
                            select: {
                                id: true,
                                firstName: true,
                                lastName: true,
                                avatarUrl: true,
                            },
                        },
                    },
                },
                submission: true,
            },
        });
        if (!worksheet) {
            throw new common_1.NotFoundException(`Worksheet with ID ${id} not found`);
        }
        // Add submission data if exists
        return {
            ...worksheet,
            materials: worksheet.materialUrls.map((url, index) => ({
                id: `material-${index}`,
                filename: worksheet.materialNames[index] || 'Unknown',
                url,
                fileType: 'application/octet-stream',
                fileSize: 0, // File size not available in current schema
            })),
            submission: worksheet.submission || null,
        };
    }
    async create(data, clientId, therapistId, files = []) {
        // Create the worksheet
        const worksheet = await this.prisma.worksheet.create({
            data: {
                title: data.title,
                instructions: data.instructions || '',
                dueDate: data.dueDate || new Date(),
                status: data.status || 'ASSIGNED',
                clientId,
                therapistId,
                // Material files can be uploaded separately
                materialUrls: [],
                materialNames: [],
            },
        });
        // Return the newly created worksheet
        return this.findById(worksheet.id);
    }
    async update(id, data) {
        // Check if worksheet exists
        const exists = await this.prisma.worksheet.findUnique({
            where: { id },
        });
        if (!exists) {
            throw new common_1.NotFoundException(`Worksheet with ID ${id} not found`);
        }
        // Update the worksheet
        await this.prisma.worksheet.update({
            where: { id },
            data,
        });
        // Return the updated worksheet
        return this.findById(id);
    }
    async delete(id) {
        // Check if worksheet exists
        const exists = await this.prisma.worksheet.findUnique({
            where: { id },
        });
        if (!exists) {
            throw new common_1.NotFoundException(`Worksheet with ID ${id} not found`);
        }
        // Delete the worksheet (files in Supabase Storage should be cleaned up separately if needed)
        await this.prisma.worksheet.delete({
            where: { id },
        });
        return { success: true, message: 'Worksheet deleted successfully' };
    }
    async addSubmission(data, clientId) {
        // Check if worksheet exists
        const worksheet = await this.prisma.worksheet.findUnique({
            where: { id: data.worksheetId },
            include: { client: true },
        });
        if (!worksheet) {
            throw new common_1.NotFoundException(`Worksheet with ID ${data.worksheetId} not found`);
        }
        // Create a submission using the WorksheetSubmission model
        const submission = await this.prisma.worksheetSubmission.create({
            data: {
                worksheetId: data.worksheetId,
                fileUrls: data.fileUrls || [],
                fileNames: data.fileNames || [],
                fileSizes: data.fileSizes || [],
                feedback: data.notes || null,
            },
        });
        // Update the worksheet status to SUBMITTED
        const updatedWorksheet = await this.prisma.worksheet.update({
            where: { id: data.worksheetId },
            data: {
                status: 'SUBMITTED',
            },
        });
        return {
            id: submission.id,
            worksheetId: data.worksheetId,
            clientId,
            status: updatedWorksheet.status,
            submittedAt: submission.submittedAt,
        };
    }
    async submitWorksheet(id, data, clientId) {
        // Check if worksheet exists
        const worksheet = await this.prisma.worksheet.findUnique({
            where: { id },
            include: { submission: true },
        });
        if (!worksheet) {
            throw new common_1.NotFoundException(`Worksheet with ID ${id} not found`);
        }
        // Create or update submission
        let submission;
        if (worksheet.submission) {
            // Update existing submission
            submission = await this.prisma.worksheetSubmission.update({
                where: { worksheetId: id },
                data: {
                    fileUrls: data.fileUrls || [],
                    fileNames: data.fileNames || [],
                    fileSizes: data.fileSizes || [],
                    feedback: data.notes || null,
                },
            });
        }
        else {
            // Create new submission
            submission = await this.prisma.worksheetSubmission.create({
                data: {
                    worksheetId: id,
                    fileUrls: data.fileUrls || [],
                    fileNames: data.fileNames || [],
                    fileSizes: data.fileSizes || [],
                    feedback: data.notes || null,
                },
            });
        }
        // Update worksheet status to SUBMITTED
        const updatedWorksheet = await this.prisma.worksheet.update({
            where: { id },
            data: {
                status: 'SUBMITTED',
            },
        });
        return {
            worksheetId: id,
            submissionId: submission.id,
            status: updatedWorksheet.status,
            submittedAt: submission.submittedAt,
            message: 'Worksheet submitted successfully',
        };
    }
    async deleteSubmission(id) {
        // Find worksheet with submission
        const worksheet = await this.prisma.worksheet.findUnique({
            where: { id },
            include: { submission: true },
        });
        if (!worksheet) {
            throw new common_1.NotFoundException(`Worksheet with ID ${id} not found`);
        }
        if (!worksheet.submission) {
            throw new common_1.NotFoundException(`No submission found for worksheet with ID ${id}`);
        }
        // Delete the submission
        await this.prisma.worksheetSubmission.delete({
            where: { worksheetId: id },
        });
        // Reset worksheet status back to ASSIGNED
        await this.prisma.worksheet.update({
            where: { id },
            data: {
                status: 'ASSIGNED',
            },
        });
        return { success: true, message: 'Submission deleted successfully' };
    }
};
exports.WorksheetsService = WorksheetsService;
exports.WorksheetsService = WorksheetsService = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [typeof (_a = typeof prisma_client_provider_1.PrismaService !== "undefined" && prisma_client_provider_1.PrismaService) === "function" ? _a : Object])
], WorksheetsService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL3dvcmtzaGVldHMvd29ya3NoZWV0cy5zZXJ2aWNlLnRzIiwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7QUFBQSwyQ0FBK0Q7QUFDL0QsaUZBQXFFO0FBUTlELElBQU0saUJBQWlCLEdBQXZCLE1BQU0saUJBQWlCO0lBQ0M7SUFBN0IsWUFBNkIsTUFBcUI7UUFBckIsV0FBTSxHQUFOLE1BQU0sQ0FBZTtJQUFHLENBQUM7SUFFdEQsS0FBSyxDQUFDLE9BQU8sQ0FDWCxNQUFlLEVBQ2YsV0FBb0IsRUFDcEIsTUFBZSxFQUNmLEtBQWM7UUFFZCxNQUFNLEtBQUssR0FBRyxFQUFFLENBQUM7UUFFakIsSUFBSSxNQUFNLEVBQUUsQ0FBQztZQUNYLEtBQUssQ0FBQyxVQUFVLENBQUMsR0FBRyxNQUFNLENBQUMsQ0FBQyxtQ0FBbUM7UUFDakUsQ0FBQztRQUVELElBQUksV0FBVyxFQUFFLENBQUM7WUFDaEIsS0FBSyxDQUFDLGFBQWEsQ0FBQyxHQUFHLFdBQVcsQ0FBQztRQUNyQyxDQUFDO1FBRUQsSUFBSSxNQUFNLEVBQUUsQ0FBQztZQUNYLEtBQUssQ0FBQyxRQUFRLENBQUMsR0FBRyxNQUFNLENBQUM7UUFDM0IsQ0FBQztRQUVELGlDQUFpQztRQUNqQyxNQUFNLEtBQUssR0FBRyxNQUFNLElBQUksQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxFQUFFLEtBQUssRUFBRSxDQUFDLENBQUM7UUFFM0QsMkJBQTJCO1FBQzNCLE1BQU0sSUFBSSxHQUFHLEtBQUssQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUM7UUFFL0MsTUFBTSxVQUFVLEdBQUcsTUFBTSxJQUFJLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxRQUFRLENBQUM7WUFDdEQsS0FBSztZQUNMLElBQUk7WUFDSixPQUFPLEVBQUU7Z0JBQ1AsTUFBTSxF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LElBQUksQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDLFVBQVUsQ0FBQztZQUN2RCxLQUFLLEVBQUUsRUFBRSxFQUFFLEVBQUU7WUFDYixPQUFPLEVBQUUsRUFBRSxVQUFVLEVBQUUsSUFBSSxFQUFFO1NBQzlCLENBQUMsQ0FBQztRQUVILElBQUksQ0FBQyxTQUFTLEVBQUUsQ0FBQztZQUNmLE1BQU0sSUFBSSwwQkFBaUIsQ0FBQyxxQkFBcUIsRUFBRSxZQUFZLENBQUMsQ0FBQztRQUNuRSxDQUFDO1FBRUQsSUFBSSxDQUFDLFNBQVMsQ0FBQyxVQUFVLEVBQUUsQ0FBQztZQUMxQixNQUFNLElBQUksMEJBQWlCLENBQUMsNkNBQTZDLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFDakYsQ0FBQztRQUVELHdCQUF3QjtRQUN4QixNQUFNLElBQUksQ0FBQyxNQUFNLENBQUMsbUJBQW1CLENBQUMsTUFBTSxDQUFDO1lBQzNDLEtBQUssRUFBRSxFQUFFLFdBQVcsRUFBRSxFQUFFLEVBQUU7U0FDM0IsQ0FBQyxDQUFDO1FBRUgsMENBQTBDO1FBQzFDLE1BQU0sSUFBSSxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDO1lBQ2pDLEtBQUssRUFBRSxFQUFFLEVBQUUsRUFBRTtZQUNiLElBQUksRUFBRTtnQkFDSixNQUFNLEVBQUUsVUFBVTthQUNuQjtTQUNGLENBQUMsQ0FBQztRQUVILE9BQU8sRUFBRSxPQUFPLEVBQUUsSUFBSSxFQUFFLE9BQU8sRUFBRSxpQ0FBaUMsRUFBRSxDQUFDO0lBQ3ZFLENBQUM7Q0FDRixDQUFBO0FBOVRZLDhDQUFpQjs0QkFBakIsaUJBQWlCO0lBRDdCLElBQUEsbUJBQVUsR0FBRTt5REFFMEIsc0NBQWEsb0JBQWIsc0NBQWE7R0FEdkMsaUJBQWlCLENBOFQ3QiIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvaG9tZS93ZXRvb2EvRG9jdW1lbnRzL2NvZGUvcHJvamVjdHMvbWVudGFyYS9tZW50YXJhLWFwaS9zcmMvd29ya3NoZWV0cy93b3Jrc2hlZXRzLnNlcnZpY2UudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSwgTm90Rm91bmRFeGNlcHRpb24gfSBmcm9tICdAbmVzdGpzL2NvbW1vbic7XG5pbXBvcnQgeyBQcmlzbWFTZXJ2aWNlIH0gZnJvbSAnc3JjL3Byb3ZpZGVycy9wcmlzbWEtY2xpZW50LnByb3ZpZGVyJztcbmltcG9ydCB0eXBlIHtcbiAgV29ya3NoZWV0Q3JlYXRlSW5wdXREdG8sXG4gIFdvcmtzaGVldFN1Ym1pc3Npb25DcmVhdGVJbnB1dER0byxcbiAgV29ya3NoZWV0VXBkYXRlSW5wdXREdG8sXG59IGZyb20gJy4vdHlwZXMnO1xuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgV29ya3NoZWV0c1NlcnZpY2Uge1xuICBjb25zdHJ1Y3Rvcihwcml2YXRlIHJlYWRvbmx5IHByaXNtYTogUHJpc21hU2VydmljZSkge31cblxuICBhc3luYyBmaW5kQWxsKFxuICAgIHVzZXJJZD86IHN0cmluZyxcbiAgICB0aGVyYXBpc3RJZD86IHN0cmluZyxcbiAgICBzdGF0dXM/OiBzdHJpbmcsXG4gICAgbGltaXQ/OiBudW1iZXIsXG4gICk6IFByb21pc2U8eyB3b3Jrc2hlZXRzOiBhbnlbXTsgdG90YWw6IG51bWJlcjsgaGFzTW9yZTogYm9vbGVhbiB9PiB7XG4gICAgY29uc3Qgd2hlcmUgPSB7fTtcblxuICAgIGlmICh1c2VySWQpIHtcbiAgICAgIHdoZXJlWydjbGllbnRJZCddID0gdXNlcklkOyAvLyBVc2UgY2xpZW50SWQgZm9yIHByb3BlciByZWxhdGlvblxuICAgIH1cblxuICAgIGlmICh0aGVyYXBpc3RJZCkge1xuICAgICAgd2hlcmVbJ3RoZXJhcGlzdElkJ10gPSB0aGVyYXBpc3RJZDtcbiAgICB9XG5cbiAgICBpZiAoc3RhdHVzKSB7XG4gICAgICB3aGVyZVsnc3RhdHVzJ10gPSBzdGF0dXM7XG4gICAgfVxuXG4gICAgLy8gR2V0IHRvdGFsIGNvdW50IGZvciBwYWdpbmF0aW9uXG4gICAgY29uc3QgdG90YWwgPSBhd2FpdCB0aGlzLnByaXNtYS53b3Jrc2hlZXQuY291bnQoeyB3aGVyZSB9KTtcblxuICAgIC8vIEFwcGx5IGxpbWl0IGlmIHNwZWNpZmllZFxuICAgIGNvbnN0IHRha2UgPSBsaW1pdCA/IE51bWJlcihsaW1pdCkgOiB1bmRlZmluZWQ7XG5cbiAgICBjb25zdCB3b3Jrc2hlZXRzID0gYXdhaXQgdGhpcy5wcmlzbWEud29ya3NoZWV0LmZpbmRNYW55KHtcbiAgICAgIHdoZXJlLFxuICAgICAgdGFrZSxcbiAgICAgIGluY2x1ZGU6IHtcbiAgICAgICAgY2xpZW50OiB7XG4gICAgICAgICAgaW5jbHVkZToge1xuICAgICAgICAgICAgdXNlcjoge1xuICAgICAgICAgICAgICBzZWxlY3Q6IHtcbiAgICAgICAgICAgICAgICBpZDogdHJ1ZSxcbiAgICAgICAgICAgICAgICBmaXJzdE5hbWU6IHRydWUsXG4gICAgICAgICAgICAgICAgbGFzdE5hbWU6IHRydWUsXG4gICAgICAgICAgICAgICAgYXZhdGFyVXJsOiB0cnVlLFxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgICB0aGVyYXBpc3Q6IHtcbiAgICAgICAgICBpbmNsdWRlOiB7XG4gICAgICAgICAgICB1c2VyOiB7XG4gICAgICAgICAgICAgIHNlbGVjdDoge1xuICAgICAgICAgICAgICAgIGlkOiB0cnVlLFxuICAgICAgICAgICAgICAgIGZpcnN0TmFtZTogdHJ1ZSxcbiAgICAgICAgICAgICAgICBsYXN0TmFtZTogdHJ1ZSxcbiAgICAgICAgICAgICAgICBhdmF0YXJVcmw6IHRydWUsXG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICAgIHN1Ym1pc3Npb246IHRydWUsXG4gICAgICB9LFxuICAgICAgb3JkZXJCeToge1xuICAgICAgICBjcmVhdGVkQXQ6ICdkZXNjJyxcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICBjb25zdCBoYXNNb3JlID0gbGltaXQgPyB3b3Jrc2hlZXRzLmxlbmd0aCA+PSBsaW1pdCA6IGZhbHNlO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIHdvcmtzaGVldHMsXG4gICAgICB0b3RhbCxcbiAgICAgIGhhc01vcmUsXG4gICAgfTtcbiAgfVxuXG4gIGFzeW5jIGZpbmRCeUlkKGlkOiBzdHJpbmcpIHtcbiAgICBjb25zdCB3b3Jrc2hlZXQgPSBhd2FpdCB0aGlzLnByaXNtYS53b3Jrc2hlZXQuZmluZFVuaXF1ZSh7XG4gICAgICB3aGVyZTogeyBpZCB9LFxuICAgICAgaW5jbHVkZToge1xuICAgICAgICBjbGllbnQ6IHtcbiAgICAgICAgICBpbmNsdWRlOiB7XG4gICAgICAgICAgICB1c2VyOiB7XG4gICAgICAgICAgICAgIHNlbGVjdDoge1xuICAgICAgICAgICAgICAgIGlkOiB0cnVlLFxuICAgICAgICAgICAgICAgIGZpcnN0TmFtZTogdHJ1ZSxcbiAgICAgICAgICAgICAgICBsYXN0TmFtZTogdHJ1ZSxcbiAgICAgICAgICAgICAgICBhdmF0YXJVcmw6IHRydWUsXG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICAgIHRoZXJhcGlzdDoge1xuICAgICAgICAgIGluY2x1ZGU6IHtcbiAgICAgICAgICAgIHVzZXI6IHtcbiAgICAgICAgICAgICAgc2VsZWN0OiB7XG4gICAgICAgICAgICAgICAgaWQ6IHRydWUsXG4gICAgICAgICAgICAgICAgZmlyc3ROYW1lOiB0cnVlLFxuICAgICAgICAgICAgICAgIGxhc3ROYW1lOiB0cnVlLFxuICAgICAgICAgICAgICAgIGF2YXRhclVybDogdHJ1ZSxcbiAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgICAgc3VibWlzc2lvbjogdHJ1ZSxcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICBpZiAoIXdvcmtzaGVldCkge1xuICAgICAgdGhyb3cgbmV3IE5vdEZvdW5kRXhjZXB0aW9uKGBXb3Jrc2hlZXQgd2l0aCBJRCAke2lkfSBub3QgZm91bmRgKTtcbiAgICB9XG5cbiAgICAvLyBBZGQgc3VibWlzc2lvbiBkYXRhIGlmIGV4aXN0c1xuICAgIHJldHVybiB7XG4gICAgICAuLi53b3Jrc2hlZXQsXG4gICAgICBtYXRlcmlhbHM6IHdvcmtzaGVldC5tYXRlcmlhbFVybHMubWFwKCh1cmwsIGluZGV4KSA9PiAoe1xuICAgICAgICBpZDogYG1hdGVyaWFsLSR7aW5kZXh9YCxcbiAgICAgICAgZmlsZW5hbWU6IHdvcmtzaGVldC5tYXRlcmlhbE5hbWVzW2luZGV4XSB8fCAnVW5rbm93bicsXG4gICAgICAgIHVybCxcbiAgICAgICAgZmlsZVR5cGU6ICdhcHBsaWNhdGlvbi9vY3RldC1zdHJlYW0nLFxuICAgICAgICBmaWxlU2l6ZTogMCwgLy8gRmlsZSBzaXplIG5vdCBhdmFpbGFibGUgaW4gY3VycmVudCBzY2hlbWFcbiAgICAgIH0pKSxcbiAgICAgIHN1Ym1pc3Npb246IHdvcmtzaGVldC5zdWJtaXNzaW9uIHx8IG51bGwsXG4gICAgfTtcbiAgfVxuXG4gIGFzeW5jIGNyZWF0ZShcbiAgICBkYXRhOiBXb3Jrc2hlZXRDcmVhdGVJbnB1dER0byxcbiAgICBjbGllbnRJZDogc3RyaW5nLFxuICAgIHRoZXJhcGlzdElkOiBzdHJpbmcsXG4gICAgZmlsZXM6IEV4cHJlc3MuTXVsdGVyLkZpbGVbXSA9IFtdLFxuICApIHtcbiAgICAvLyBDcmVhdGUgdGhlIHdvcmtzaGVldFxuICAgIGNvbnN0IHdvcmtzaGVldCA9IGF3YWl0IHRoaXMucHJpc21hLndvcmtzaGVldC5jcmVhdGUoe1xuICAgICAgZGF0YToge1xuICAgICAgICB0aXRsZTogZGF0YS50aXRsZSxcbiAgICAgICAgaW5zdHJ1Y3Rpb25zOiBkYXRhLmluc3RydWN0aW9ucyB8fCAnJyxcbiAgICAgICAgZHVlRGF0ZTogZGF0YS5kdWVEYXRlIHx8IG5ldyBEYXRlKCksXG4gICAgICAgIHN0YXR1czogKGRhdGEgYXMgYW55KS5zdGF0dXMgfHwgJ0FTU0lHTkVEJyxcbiAgICAgICAgY2xpZW50SWQsXG4gICAgICAgIHRoZXJhcGlzdElkLFxuICAgICAgICAvLyBNYXRlcmlhbCBmaWxlcyBjYW4gYmUgdXBsb2FkZWQgc2VwYXJhdGVseVxuICAgICAgICBtYXRlcmlhbFVybHM6IFtdLFxuICAgICAgICBtYXRlcmlhbE5hbWVzOiBbXSxcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICAvLyBSZXR1cm4gdGhlIG5ld2x5IGNyZWF0ZWQgd29ya3NoZWV0XG4gICAgcmV0dXJuIHRoaXMuZmluZEJ5SWQod29ya3NoZWV0LmlkKTtcbiAgfVxuXG4gIGFzeW5jIHVwZGF0ZShpZDogc3RyaW5nLCBkYXRhOiBXb3Jrc2hlZXRVcGRhdGVJbnB1dER0bykge1xuICAgIC8vIENoZWNrIGlmIHdvcmtzaGVldCBleGlzdHNcbiAgICBjb25zdCBleGlzdHMgPSBhd2FpdCB0aGlzLnByaXNtYS53b3Jrc2hlZXQuZmluZFVuaXF1ZSh7XG4gICAgICB3aGVyZTogeyBpZCB9LFxuICAgIH0pO1xuXG4gICAgaWYgKCFleGlzdHMpIHtcbiAgICAgIHRocm93IG5ldyBOb3RGb3VuZEV4Y2VwdGlvbihgV29ya3NoZWV0IHdpdGggSUQgJHtpZH0gbm90IGZvdW5kYCk7XG4gICAgfVxuXG4gICAgLy8gVXBkYXRlIHRoZSB3b3Jrc2hlZXRcbiAgICBhd2FpdCB0aGlzLnByaXNtYS53b3Jrc2hlZXQudXBkYXRlKHtcbiAgICAgIHdoZXJlOiB7IGlkIH0sXG4gICAgICBkYXRhLFxuICAgIH0pO1xuXG4gICAgLy8gUmV0dXJuIHRoZSB1cGRhdGVkIHdvcmtzaGVldFxuICAgIHJldHVybiB0aGlzLmZpbmRCeUlkKGlkKTtcbiAgfVxuXG4gIGFzeW5jIGRlbGV0ZShpZDogc3RyaW5nKSB7XG4gICAgLy8gQ2hlY2sgaWYgd29ya3NoZWV0IGV4aXN0c1xuICAgIGNvbnN0IGV4aXN0cyA9IGF3YWl0IHRoaXMucHJpc21hLndvcmtzaGVldC5maW5kVW5pcXVlKHtcbiAgICAgIHdoZXJlOiB7IGlkIH0sXG4gICAgfSk7XG5cbiAgICBpZiAoIWV4aXN0cykge1xuICAgICAgdGhyb3cgbmV3IE5vdEZvdW5kRXhjZXB0aW9uKGBXb3Jrc2hlZXQgd2l0aCBJRCAke2lkfSBub3QgZm91bmRgKTtcbiAgICB9XG5cbiAgICAvLyBEZWxldGUgdGhlIHdvcmtzaGVldCAoZmlsZXMgaW4gU3VwYWJhc2UgU3RvcmFnZSBzaG91bGQgYmUgY2xlYW5lZCB1cCBzZXBhcmF0ZWx5IGlmIG5lZWRlZClcbiAgICBhd2FpdCB0aGlzLnByaXNtYS53b3Jrc2hlZXQuZGVsZXRlKHtcbiAgICAgIHdoZXJlOiB7IGlkIH0sXG4gICAgfSk7XG5cbiAgICByZXR1cm4geyBzdWNjZXNzOiB0cnVlLCBtZXNzYWdlOiAnV29ya3NoZWV0IGRlbGV0ZWQgc3VjY2Vzc2Z1bGx5JyB9O1xuICB9XG5cbiAgYXN5bmMgYWRkU3VibWlzc2lvbihcbiAgICBkYXRhOiBXb3Jrc2hlZXRTdWJtaXNzaW9uQ3JlYXRlSW5wdXREdG8sXG4gICAgY2xpZW50SWQ6IHN0cmluZyxcbiAgKSB7XG4gICAgLy8gQ2hlY2sgaWYgd29ya3NoZWV0IGV4aXN0c1xuICAgIGNvbnN0IHdvcmtzaGVldCA9IGF3YWl0IHRoaXMucHJpc21hLndvcmtzaGVldC5maW5kVW5pcXVlKHtcbiAgICAgIHdoZXJlOiB7IGlkOiBkYXRhLndvcmtzaGVldElkIH0sXG4gICAgICBpbmNsdWRlOiB7IGNsaWVudDogdHJ1ZSB9LFxuICAgIH0pO1xuXG4gICAgaWYgKCF3b3Jrc2hlZXQpIHtcbiAgICAgIHRocm93IG5ldyBOb3RGb3VuZEV4Y2VwdGlvbihcbiAgICAgICAgYFdvcmtzaGVldCB3aXRoIElEICR7ZGF0YS53b3Jrc2hlZXRJZH0gbm90IGZvdW5kYCxcbiAgICAgICk7XG4gICAgfVxuXG4gICAgLy8gQ3JlYXRlIGEgc3VibWlzc2lvbiB1c2luZyB0aGUgV29ya3NoZWV0U3VibWlzc2lvbiBtb2RlbFxuICAgIGNvbnN0IHN1Ym1pc3Npb24gPSBhd2FpdCB0aGlzLnByaXNtYS53b3Jrc2hlZXRTdWJtaXNzaW9uLmNyZWF0ZSh7XG4gICAgICBkYXRhOiB7XG4gICAgICAgIHdvcmtzaGVldElkOiBkYXRhLndvcmtzaGVldElkLFxuICAgICAgICBmaWxlVXJsczogKGRhdGEgYXMgYW55KS5maWxlVXJscyB8fCBbXSxcbiAgICAgICAgZmlsZU5hbWVzOiAoZGF0YSBhcyBhbnkpLmZpbGVOYW1lcyB8fCBbXSxcbiAgICAgICAgZmlsZVNpemVzOiAoZGF0YSBhcyBhbnkpLmZpbGVTaXplcyB8fCBbXSxcbiAgICAgICAgZmVlZGJhY2s6IChkYXRhIGFzIGFueSkubm90ZXMgfHwgbnVsbCxcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICAvLyBVcGRhdGUgdGhlIHdvcmtzaGVldCBzdGF0dXMgdG8gU1VCTUlUVEVEXG4gICAgY29uc3QgdXBkYXRlZFdvcmtzaGVldCA9IGF3YWl0IHRoaXMucHJpc21hLndvcmtzaGVldC51cGRhdGUoe1xuICAgICAgd2hlcmU6IHsgaWQ6IGRhdGEud29ya3NoZWV0SWQgfSxcbiAgICAgIGRhdGE6IHtcbiAgICAgICAgc3RhdHVzOiAnU1VCTUlUVEVEJyxcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICByZXR1cm4ge1xuICAgICAgaWQ6IHN1Ym1pc3Npb24uaWQsXG4gICAgICB3b3Jrc2hlZXRJZDogZGF0YS53b3Jrc2hlZXRJZCxcbiAgICAgIGNsaWVudElkLFxuICAgICAgc3RhdHVzOiB1cGRhdGVkV29ya3NoZWV0LnN0YXR1cyxcbiAgICAgIHN1Ym1pdHRlZEF0OiBzdWJtaXNzaW9uLnN1Ym1pdHRlZEF0LFxuICAgIH07XG4gIH1cblxuICBhc3luYyBzdWJtaXRXb3Jrc2hlZXQoXG4gICAgaWQ6IHN0cmluZyxcbiAgICBkYXRhOiBXb3Jrc2hlZXRTdWJtaXNzaW9uQ3JlYXRlSW5wdXREdG8sXG4gICAgY2xpZW50SWQ6IHN0cmluZyxcbiAgKSB7XG4gICAgLy8gQ2hlY2sgaWYgd29ya3NoZWV0IGV4aXN0c1xuICAgIGNvbnN0IHdvcmtzaGVldCA9IGF3YWl0IHRoaXMucHJpc21hLndvcmtzaGVldC5maW5kVW5pcXVlKHtcbiAgICAgIHdoZXJlOiB7IGlkIH0sXG4gICAgICBpbmNsdWRlOiB7IHN1Ym1pc3Npb246IHRydWUgfSxcbiAgICB9KTtcblxuICAgIGlmICghd29ya3NoZWV0KSB7XG4gICAgICB0aHJvdyBuZXcgTm90Rm91bmRFeGNlcHRpb24oYFdvcmtzaGVldCB3aXRoIElEICR7aWR9IG5vdCBmb3VuZGApO1xuICAgIH1cblxuICAgIC8vIENyZWF0ZSBvciB1cGRhdGUgc3VibWlzc2lvblxuICAgIGxldCBzdWJtaXNzaW9uO1xuICAgIGlmICh3b3Jrc2hlZXQuc3VibWlzc2lvbikge1xuICAgICAgLy8gVXBkYXRlIGV4aXN0aW5nIHN1Ym1pc3Npb25cbiAgICAgIHN1Ym1pc3Npb24gPSBhd2FpdCB0aGlzLnByaXNtYS53b3Jrc2hlZXRTdWJtaXNzaW9uLnVwZGF0ZSh7XG4gICAgICAgIHdoZXJlOiB7IHdvcmtzaGVldElkOiBpZCB9LFxuICAgICAgICBkYXRhOiB7XG4gICAgICAgICAgZmlsZVVybHM6IChkYXRhIGFzIGFueSkuZmlsZVVybHMgfHwgW10sXG4gICAgICAgICAgZmlsZU5hbWVzOiAoZGF0YSBhcyBhbnkpLmZpbGVOYW1lcyB8fCBbXSxcbiAgICAgICAgICBmaWxlU2l6ZXM6IChkYXRhIGFzIGFueSkuZmlsZVNpemVzIHx8IFtdLFxuICAgICAgICAgIGZlZWRiYWNrOiAoZGF0YSBhcyBhbnkpLm5vdGVzIHx8IG51bGwsXG4gICAgICAgIH0sXG4gICAgICB9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgLy8gQ3JlYXRlIG5ldyBzdWJtaXNzaW9uXG4gICAgICBzdWJtaXNzaW9uID0gYXdhaXQgdGhpcy5wcmlzbWEud29ya3NoZWV0U3VibWlzc2lvbi5jcmVhdGUoe1xuICAgICAgICBkYXRhOiB7XG4gICAgICAgICAgd29ya3NoZWV0SWQ6IGlkLFxuICAgICAgICAgIGZpbGVVcmxzOiAoZGF0YSBhcyBhbnkpLmZpbGVVcmxzIHx8IFtdLFxuICAgICAgICAgIGZpbGVOYW1lczogKGRhdGEgYXMgYW55KS5maWxlTmFtZXMgfHwgW10sXG4gICAgICAgICAgZmlsZVNpemVzOiAoZGF0YSBhcyBhbnkpLmZpbGVTaXplcyB8fCBbXSxcbiAgICAgICAgICBmZWVkYmFjazogKGRhdGEgYXMgYW55KS5ub3RlcyB8fCBudWxsLFxuICAgICAgICB9LFxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgLy8gVXBkYXRlIHdvcmtzaGVldCBzdGF0dXMgdG8gU1VCTUlUVEVEXG4gICAgY29uc3QgdXBkYXRlZFdvcmtzaGVldCA9IGF3YWl0IHRoaXMucHJpc21hLndvcmtzaGVldC51cGRhdGUoe1xuICAgICAgd2hlcmU6IHsgaWQgfSxcbiAgICAgIGRhdGE6IHtcbiAgICAgICAgc3RhdHVzOiAnU1VCTUlUVEVEJyxcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICByZXR1cm4ge1xuICAgICAgd29ya3NoZWV0SWQ6IGlkLFxuICAgICAgc3VibWlzc2lvbklkOiBzdWJtaXNzaW9uLmlkLFxuICAgICAgc3RhdHVzOiB1cGRhdGVkV29ya3NoZWV0LnN0YXR1cyxcbiAgICAgIHN1Ym1pdHRlZEF0OiBzdWJtaXNzaW9uLnN1Ym1pdHRlZEF0LFxuICAgICAgbWVzc2FnZTogJ1dvcmtzaGVldCBzdWJtaXR0ZWQgc3VjY2Vzc2Z1bGx5JyxcbiAgICB9O1xuICB9XG5cbiAgYXN5bmMgZGVsZXRlU3VibWlzc2lvbihpZDogc3RyaW5nKSB7XG4gICAgLy8gRmluZCB3b3Jrc2hlZXQgd2l0aCBzdWJtaXNzaW9uXG4gICAgY29uc3Qgd29ya3NoZWV0ID0gYXdhaXQgdGhpcy5wcmlzbWEud29ya3NoZWV0LmZpbmRVbmlxdWUoe1xuICAgICAgd2hlcmU6IHsgaWQgfSxcbiAgICAgIGluY2x1ZGU6IHsgc3VibWlzc2lvbjogdHJ1ZSB9LFxuICAgIH0pO1xuXG4gICAgaWYgKCF3b3Jrc2hlZXQpIHtcbiAgICAgIHRocm93IG5ldyBOb3RGb3VuZEV4Y2VwdGlvbihgV29ya3NoZWV0IHdpdGggSUQgJHtpZH0gbm90IGZvdW5kYCk7XG4gICAgfVxuXG4gICAgaWYgKCF3b3Jrc2hlZXQuc3VibWlzc2lvbikge1xuICAgICAgdGhyb3cgbmV3IE5vdEZvdW5kRXhjZXB0aW9uKGBObyBzdWJtaXNzaW9uIGZvdW5kIGZvciB3b3Jrc2hlZXQgd2l0aCBJRCAke2lkfWApO1xuICAgIH1cblxuICAgIC8vIERlbGV0ZSB0aGUgc3VibWlzc2lvblxuICAgIGF3YWl0IHRoaXMucHJpc21hLndvcmtzaGVldFN1Ym1pc3Npb24uZGVsZXRlKHtcbiAgICAgIHdoZXJlOiB7IHdvcmtzaGVldElkOiBpZCB9LFxuICAgIH0pO1xuXG4gICAgLy8gUmVzZXQgd29ya3NoZWV0IHN0YXR1cyBiYWNrIHRvIEFTU0lHTkVEXG4gICAgYXdhaXQgdGhpcy5wcmlzbWEud29ya3NoZWV0LnVwZGF0ZSh7XG4gICAgICB3aGVyZTogeyBpZCB9LFxuICAgICAgZGF0YToge1xuICAgICAgICBzdGF0dXM6ICdBU1NJR05FRCcsXG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgcmV0dXJuIHsgc3VjY2VzczogdHJ1ZSwgbWVzc2FnZTogJ1N1Ym1pc3Npb24gZGVsZXRlZCBzdWNjZXNzZnVsbHknIH07XG4gIH1cbn1cbiJdLCJ2ZXJzaW9uIjozfQ==