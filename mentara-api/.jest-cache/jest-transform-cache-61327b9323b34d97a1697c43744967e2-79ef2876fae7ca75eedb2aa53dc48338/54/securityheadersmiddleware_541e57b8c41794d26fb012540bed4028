19d56fe57169b55a0ee8ebe326abfe35
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.SecurityHeadersMiddleware = void 0;
const common_1 = require("@nestjs/common");
let SecurityHeadersMiddleware = class SecurityHeadersMiddleware {
    use(req, res, next) {
        // Remove server information
        res.removeHeader('X-Powered-By');
        res.removeHeader('Server');
        // Content Security Policy
        const frontendUrl = process.env.FRONTEND_URL || 'http://localhost:3000';
        const cspPolicy = [
            "default-src 'self'",
            `connect-src 'self' ${frontendUrl} https://*.clerk.accounts.dev https://*.supabase.co wss://`,
            "script-src 'self' 'unsafe-inline' 'unsafe-eval' https://unpkg.com",
            "style-src 'self' 'unsafe-inline' https://fonts.googleapis.com",
            "font-src 'self' https://fonts.gstatic.com data:",
            "img-src 'self' data: https: blob:",
            "media-src 'self' blob:",
            "object-src 'none'",
            "base-uri 'self'",
            "form-action 'self'",
            "frame-ancestors 'none'",
            'upgrade-insecure-requests',
        ].join('; ');
        // Security Headers
        res.setHeader('Content-Security-Policy', cspPolicy);
        res.setHeader('X-Content-Type-Options', 'nosniff');
        res.setHeader('X-Frame-Options', 'DENY');
        res.setHeader('X-XSS-Protection', '1; mode=block');
        res.setHeader('Referrer-Policy', 'strict-origin-when-cross-origin');
        res.setHeader('Permissions-Policy', 'camera=(), microphone=(), geolocation=()');
        // HSTS (HTTP Strict Transport Security)
        if (process.env.NODE_ENV === 'production') {
            res.setHeader('Strict-Transport-Security', 'max-age=31536000; includeSubDomains; preload');
        }
        // Cache Control for sensitive endpoints
        if (this.isSensitiveEndpoint(req.path)) {
            res.setHeader('Cache-Control', 'no-store, no-cache, must-revalidate, private');
            res.setHeader('Pragma', 'no-cache');
            res.setHeader('Expires', '0');
        }
        // CORS headers (if not handled by NestJS CORS)
        const allowedOrigins = [
            frontendUrl,
            'http://localhost:3000',
            'http://localhost:3001',
        ];
        const origin = req.headers.origin;
        if (origin && allowedOrigins.includes(origin)) {
            res.setHeader('Access-Control-Allow-Origin', origin);
        }
        res.setHeader('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE, OPTIONS, PATCH');
        res.setHeader('Access-Control-Allow-Headers', 'Content-Type, Authorization, X-Requested-With');
        res.setHeader('Access-Control-Allow-Credentials', 'true');
        res.setHeader('Access-Control-Max-Age', '86400'); // 24 hours
        // Handle preflight requests
        if (req.method === 'OPTIONS') {
            res.status(200).end();
            return;
        }
        next();
    }
    isSensitiveEndpoint(path) {
        const sensitivePatterns = [
            '/auth',
            '/admin',
            '/billing',
            '/files',
            '/pre-assessment',
            '/sessions',
            '/messaging',
        ];
        return sensitivePatterns.some((pattern) => path.startsWith(pattern));
    }
};
exports.SecurityHeadersMiddleware = SecurityHeadersMiddleware;
exports.SecurityHeadersMiddleware = SecurityHeadersMiddleware = __decorate([
    (0, common_1.Injectable)()
], SecurityHeadersMiddleware);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL2NvbW1vbi9taWRkbGV3YXJlL3NlY3VyaXR5LWhlYWRlcnMubWlkZGxld2FyZS50cyIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7QUFBQSwyQ0FBNEQ7QUFJckQsSUFBTSx5QkFBeUIsR0FBL0IsTUFBTSx5QkFBeUI7SUFDcEMsR0FBRyxDQUFDLEdBQVksRUFBRSxHQUFhLEVBQUUsSUFBa0I7UUFDakQsNEJBQTRCO1FBQzVCLEdBQUcsQ0FBQyxZQUFZLENBQUMsY0FBYyxDQUFDLENBQUM7UUFDakMsR0FBRyxDQUFDLFlBQVksQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUUzQiwwQkFBMEI7UUFDMUIsTUFBTSxXQUFXLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxZQUFZLElBQUksdUJBQXVCLENBQUM7UUFDeEUsTUFBTSxTQUFTLEdBQUc7WUFDaEIsb0JBQW9CO1lBQ3BCLHNCQUFzQixXQUFXLDREQUE0RDtZQUM3RixtRUFBbUU7WUFDbkUsK0RBQStEO1lBQy9ELGlEQUFpRDtZQUNqRCxtQ0FBbUM7WUFDbkMsd0JBQXdCO1lBQ3hCLG1CQUFtQjtZQUNuQixpQkFBaUI7WUFDakIsb0JBQW9CO1lBQ3BCLHdCQUF3QjtZQUN4QiwyQkFBMkI7U0FDNUIsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7UUFFYixtQkFBbUI7UUFDbkIsR0FBRyxDQUFDLFNBQVMsQ0FBQyx5QkFBeUIsRUFBRSxTQUFTLENBQUMsQ0FBQztRQUNwRCxHQUFHLENBQUMsU0FBUyxDQUFDLHdCQUF3QixFQUFFLFNBQVMsQ0FBQyxDQUFDO1FBQ25ELEdBQUcsQ0FBQyxTQUFTLENBQUMsaUJBQWlCLEVBQUUsTUFBTSxDQUFDLENBQUM7UUFDekMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxrQkFBa0IsRUFBRSxlQUFlLENBQUMsQ0FBQztRQUNuRCxHQUFHLENBQUMsU0FBUyxDQUFDLGlCQUFpQixFQUFFLGlDQUFpQyxDQUFDLENBQUM7UUFDcEUsR0FBRyxDQUFDLFNBQVMsQ0FDWCxvQkFBb0IsRUFDcEIsMENBQTBDLENBQzNDLENBQUM7UUFFRix3Q0FBd0M7UUFDeEMsSUFBSSxPQUFPLENBQUMsR0FBRyxDQUFDLFFBQVEsS0FBSyxZQUFZLEVBQUUsQ0FBQztZQUMxQyxHQUFHLENBQUMsU0FBUyxDQUNYLDJCQUEyQixFQUMzQiw4Q0FBOEMsQ0FDL0MsQ0FBQztRQUNKLENBQUM7UUFFRCx3Q0FBd0M7UUFDeEMsSUFBSSxJQUFJLENBQUMsbUJBQW1CLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUM7WUFDdkMsR0FBRyxDQUFDLFNBQVMsQ0FDWCxlQUFlLEVBQ2YsOENBQThDLENBQy9DLENBQUM7WUFDRixHQUFHLENBQUMsU0FBUyxDQUFDLFFBQVEsRUFBRSxVQUFVLENBQUMsQ0FBQztZQUNwQyxHQUFHLENBQUMsU0FBUyxDQUFDLFNBQVMsRUFBRSxHQUFHLENBQUMsQ0FBQztRQUNoQyxDQUFDO1FBRUQsK0NBQStDO1FBQy9DLE1BQU0sY0FBYyxHQUFHO1lBQ3JCLFdBQVc7WUFDWCx1QkFBdUI7WUFDdkIsdUJBQXVCO1NBQ3hCLENBQUM7UUFFRixNQUFNLE1BQU0sR0FBRyxHQUFHLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQztRQUNsQyxJQUFJLE1BQU0sSUFBSSxjQUFjLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUM7WUFDOUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyw2QkFBNkIsRUFBRSxNQUFNLENBQUMsQ0FBQztRQUN2RCxDQUFDO1FBRUQsR0FBRyxDQUFDLFNBQVMsQ0FDWCw4QkFBOEIsRUFDOUIsd0NBQXdDLENBQ3pDLENBQUM7UUFDRixHQUFHLENBQUMsU0FBUyxDQUNYLDhCQUE4QixFQUM5QiwrQ0FBK0MsQ0FDaEQsQ0FBQztRQUNGLEdBQUcsQ0FBQyxTQUFTLENBQUMsa0NBQWtDLEVBQUUsTUFBTSxDQUFDLENBQUM7UUFDMUQsR0FBRyxDQUFDLFNBQVMsQ0FBQyx3QkFBd0IsRUFBRSxPQUFPLENBQUMsQ0FBQyxDQUFDLFdBQVc7UUFFN0QsNEJBQTRCO1FBQzVCLElBQUksR0FBRyxDQUFDLE1BQU0sS0FBSyxTQUFTLEVBQUUsQ0FBQztZQUM3QixHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsRUFBRSxDQUFDO1lBQ3RCLE9BQU87UUFDVCxDQUFDO1FBRUQsSUFBSSxFQUFFLENBQUM7SUFDVCxDQUFDO0lBRU8sbUJBQW1CLENBQUMsSUFBWTtRQUN0QyxNQUFNLGlCQUFpQixHQUFHO1lBQ3hCLE9BQU87WUFDUCxRQUFRO1lBQ1IsVUFBVTtZQUNWLFFBQVE7WUFDUixpQkFBaUI7WUFDakIsV0FBVztZQUNYLFlBQVk7U0FDYixDQUFDO1FBRUYsT0FBTyxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsQ0FBQyxPQUFPLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQztJQUN2RSxDQUFDO0NBQ0YsQ0FBQTtBQWpHWSw4REFBeUI7b0NBQXpCLHlCQUF5QjtJQURyQyxJQUFBLG1CQUFVLEdBQUU7R0FDQSx5QkFBeUIsQ0FpR3JDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9ob21lL3dldG9vYS9Eb2N1bWVudHMvY29kZS9wcm9qZWN0cy9tZW50YXJhL21lbnRhcmEtYXBpL3NyYy9jb21tb24vbWlkZGxld2FyZS9zZWN1cml0eS1oZWFkZXJzLm1pZGRsZXdhcmUudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSwgTmVzdE1pZGRsZXdhcmUgfSBmcm9tICdAbmVzdGpzL2NvbW1vbic7XG5pbXBvcnQgeyBSZXF1ZXN0LCBSZXNwb25zZSwgTmV4dEZ1bmN0aW9uIH0gZnJvbSAnZXhwcmVzcyc7XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBTZWN1cml0eUhlYWRlcnNNaWRkbGV3YXJlIGltcGxlbWVudHMgTmVzdE1pZGRsZXdhcmUge1xuICB1c2UocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlLCBuZXh0OiBOZXh0RnVuY3Rpb24pOiB2b2lkIHtcbiAgICAvLyBSZW1vdmUgc2VydmVyIGluZm9ybWF0aW9uXG4gICAgcmVzLnJlbW92ZUhlYWRlcignWC1Qb3dlcmVkLUJ5Jyk7XG4gICAgcmVzLnJlbW92ZUhlYWRlcignU2VydmVyJyk7XG5cbiAgICAvLyBDb250ZW50IFNlY3VyaXR5IFBvbGljeVxuICAgIGNvbnN0IGZyb250ZW5kVXJsID0gcHJvY2Vzcy5lbnYuRlJPTlRFTkRfVVJMIHx8ICdodHRwOi8vbG9jYWxob3N0OjMwMDAnO1xuICAgIGNvbnN0IGNzcFBvbGljeSA9IFtcbiAgICAgIFwiZGVmYXVsdC1zcmMgJ3NlbGYnXCIsXG4gICAgICBgY29ubmVjdC1zcmMgJ3NlbGYnICR7ZnJvbnRlbmRVcmx9IGh0dHBzOi8vKi5jbGVyay5hY2NvdW50cy5kZXYgaHR0cHM6Ly8qLnN1cGFiYXNlLmNvIHdzczovL2AsXG4gICAgICBcInNjcmlwdC1zcmMgJ3NlbGYnICd1bnNhZmUtaW5saW5lJyAndW5zYWZlLWV2YWwnIGh0dHBzOi8vdW5wa2cuY29tXCIsXG4gICAgICBcInN0eWxlLXNyYyAnc2VsZicgJ3Vuc2FmZS1pbmxpbmUnIGh0dHBzOi8vZm9udHMuZ29vZ2xlYXBpcy5jb21cIixcbiAgICAgIFwiZm9udC1zcmMgJ3NlbGYnIGh0dHBzOi8vZm9udHMuZ3N0YXRpYy5jb20gZGF0YTpcIixcbiAgICAgIFwiaW1nLXNyYyAnc2VsZicgZGF0YTogaHR0cHM6IGJsb2I6XCIsXG4gICAgICBcIm1lZGlhLXNyYyAnc2VsZicgYmxvYjpcIixcbiAgICAgIFwib2JqZWN0LXNyYyAnbm9uZSdcIixcbiAgICAgIFwiYmFzZS11cmkgJ3NlbGYnXCIsXG4gICAgICBcImZvcm0tYWN0aW9uICdzZWxmJ1wiLFxuICAgICAgXCJmcmFtZS1hbmNlc3RvcnMgJ25vbmUnXCIsXG4gICAgICAndXBncmFkZS1pbnNlY3VyZS1yZXF1ZXN0cycsXG4gICAgXS5qb2luKCc7ICcpO1xuXG4gICAgLy8gU2VjdXJpdHkgSGVhZGVyc1xuICAgIHJlcy5zZXRIZWFkZXIoJ0NvbnRlbnQtU2VjdXJpdHktUG9saWN5JywgY3NwUG9saWN5KTtcbiAgICByZXMuc2V0SGVhZGVyKCdYLUNvbnRlbnQtVHlwZS1PcHRpb25zJywgJ25vc25pZmYnKTtcbiAgICByZXMuc2V0SGVhZGVyKCdYLUZyYW1lLU9wdGlvbnMnLCAnREVOWScpO1xuICAgIHJlcy5zZXRIZWFkZXIoJ1gtWFNTLVByb3RlY3Rpb24nLCAnMTsgbW9kZT1ibG9jaycpO1xuICAgIHJlcy5zZXRIZWFkZXIoJ1JlZmVycmVyLVBvbGljeScsICdzdHJpY3Qtb3JpZ2luLXdoZW4tY3Jvc3Mtb3JpZ2luJyk7XG4gICAgcmVzLnNldEhlYWRlcihcbiAgICAgICdQZXJtaXNzaW9ucy1Qb2xpY3knLFxuICAgICAgJ2NhbWVyYT0oKSwgbWljcm9waG9uZT0oKSwgZ2VvbG9jYXRpb249KCknLFxuICAgICk7XG5cbiAgICAvLyBIU1RTIChIVFRQIFN0cmljdCBUcmFuc3BvcnQgU2VjdXJpdHkpXG4gICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WID09PSAncHJvZHVjdGlvbicpIHtcbiAgICAgIHJlcy5zZXRIZWFkZXIoXG4gICAgICAgICdTdHJpY3QtVHJhbnNwb3J0LVNlY3VyaXR5JyxcbiAgICAgICAgJ21heC1hZ2U9MzE1MzYwMDA7IGluY2x1ZGVTdWJEb21haW5zOyBwcmVsb2FkJyxcbiAgICAgICk7XG4gICAgfVxuXG4gICAgLy8gQ2FjaGUgQ29udHJvbCBmb3Igc2Vuc2l0aXZlIGVuZHBvaW50c1xuICAgIGlmICh0aGlzLmlzU2Vuc2l0aXZlRW5kcG9pbnQocmVxLnBhdGgpKSB7XG4gICAgICByZXMuc2V0SGVhZGVyKFxuICAgICAgICAnQ2FjaGUtQ29udHJvbCcsXG4gICAgICAgICduby1zdG9yZSwgbm8tY2FjaGUsIG11c3QtcmV2YWxpZGF0ZSwgcHJpdmF0ZScsXG4gICAgICApO1xuICAgICAgcmVzLnNldEhlYWRlcignUHJhZ21hJywgJ25vLWNhY2hlJyk7XG4gICAgICByZXMuc2V0SGVhZGVyKCdFeHBpcmVzJywgJzAnKTtcbiAgICB9XG5cbiAgICAvLyBDT1JTIGhlYWRlcnMgKGlmIG5vdCBoYW5kbGVkIGJ5IE5lc3RKUyBDT1JTKVxuICAgIGNvbnN0IGFsbG93ZWRPcmlnaW5zID0gW1xuICAgICAgZnJvbnRlbmRVcmwsXG4gICAgICAnaHR0cDovL2xvY2FsaG9zdDozMDAwJyxcbiAgICAgICdodHRwOi8vbG9jYWxob3N0OjMwMDEnLFxuICAgIF07XG5cbiAgICBjb25zdCBvcmlnaW4gPSByZXEuaGVhZGVycy5vcmlnaW47XG4gICAgaWYgKG9yaWdpbiAmJiBhbGxvd2VkT3JpZ2lucy5pbmNsdWRlcyhvcmlnaW4pKSB7XG4gICAgICByZXMuc2V0SGVhZGVyKCdBY2Nlc3MtQ29udHJvbC1BbGxvdy1PcmlnaW4nLCBvcmlnaW4pO1xuICAgIH1cblxuICAgIHJlcy5zZXRIZWFkZXIoXG4gICAgICAnQWNjZXNzLUNvbnRyb2wtQWxsb3ctTWV0aG9kcycsXG4gICAgICAnR0VULCBQT1NULCBQVVQsIERFTEVURSwgT1BUSU9OUywgUEFUQ0gnLFxuICAgICk7XG4gICAgcmVzLnNldEhlYWRlcihcbiAgICAgICdBY2Nlc3MtQ29udHJvbC1BbGxvdy1IZWFkZXJzJyxcbiAgICAgICdDb250ZW50LVR5cGUsIEF1dGhvcml6YXRpb24sIFgtUmVxdWVzdGVkLVdpdGgnLFxuICAgICk7XG4gICAgcmVzLnNldEhlYWRlcignQWNjZXNzLUNvbnRyb2wtQWxsb3ctQ3JlZGVudGlhbHMnLCAndHJ1ZScpO1xuICAgIHJlcy5zZXRIZWFkZXIoJ0FjY2Vzcy1Db250cm9sLU1heC1BZ2UnLCAnODY0MDAnKTsgLy8gMjQgaG91cnNcblxuICAgIC8vIEhhbmRsZSBwcmVmbGlnaHQgcmVxdWVzdHNcbiAgICBpZiAocmVxLm1ldGhvZCA9PT0gJ09QVElPTlMnKSB7XG4gICAgICByZXMuc3RhdHVzKDIwMCkuZW5kKCk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgbmV4dCgpO1xuICB9XG5cbiAgcHJpdmF0ZSBpc1NlbnNpdGl2ZUVuZHBvaW50KHBhdGg6IHN0cmluZyk6IGJvb2xlYW4ge1xuICAgIGNvbnN0IHNlbnNpdGl2ZVBhdHRlcm5zID0gW1xuICAgICAgJy9hdXRoJyxcbiAgICAgICcvYWRtaW4nLFxuICAgICAgJy9iaWxsaW5nJyxcbiAgICAgICcvZmlsZXMnLFxuICAgICAgJy9wcmUtYXNzZXNzbWVudCcsXG4gICAgICAnL3Nlc3Npb25zJyxcbiAgICAgICcvbWVzc2FnaW5nJyxcbiAgICBdO1xuXG4gICAgcmV0dXJuIHNlbnNpdGl2ZVBhdHRlcm5zLnNvbWUoKHBhdHRlcm4pID0+IHBhdGguc3RhcnRzV2l0aChwYXR0ZXJuKSk7XG4gIH1cbn1cbiJdLCJ2ZXJzaW9uIjozfQ==