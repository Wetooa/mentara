{"file":"/home/wetooa/Documents/code/projects/mentara/mentara-api/src/common/middleware/security-headers.middleware.ts","mappings":"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","names":[],"sources":["/home/wetooa/Documents/code/projects/mentara/mentara-api/src/common/middleware/security-headers.middleware.ts"],"sourcesContent":["import { Injectable, NestMiddleware } from '@nestjs/common';\nimport { Request, Response, NextFunction } from 'express';\n\n@Injectable()\nexport class SecurityHeadersMiddleware implements NestMiddleware {\n  use(req: Request, res: Response, next: NextFunction): void {\n    // Remove server information\n    res.removeHeader('X-Powered-By');\n    res.removeHeader('Server');\n\n    // Content Security Policy\n    const frontendUrl = process.env.FRONTEND_URL || 'http://localhost:3000';\n    const cspPolicy = [\n      \"default-src 'self'\",\n      `connect-src 'self' ${frontendUrl} https://*.clerk.accounts.dev https://*.supabase.co wss://`,\n      \"script-src 'self' 'unsafe-inline' 'unsafe-eval' https://unpkg.com\",\n      \"style-src 'self' 'unsafe-inline' https://fonts.googleapis.com\",\n      \"font-src 'self' https://fonts.gstatic.com data:\",\n      \"img-src 'self' data: https: blob:\",\n      \"media-src 'self' blob:\",\n      \"object-src 'none'\",\n      \"base-uri 'self'\",\n      \"form-action 'self'\",\n      \"frame-ancestors 'none'\",\n      'upgrade-insecure-requests',\n    ].join('; ');\n\n    // Security Headers\n    res.setHeader('Content-Security-Policy', cspPolicy);\n    res.setHeader('X-Content-Type-Options', 'nosniff');\n    res.setHeader('X-Frame-Options', 'DENY');\n    res.setHeader('X-XSS-Protection', '1; mode=block');\n    res.setHeader('Referrer-Policy', 'strict-origin-when-cross-origin');\n    res.setHeader(\n      'Permissions-Policy',\n      'camera=(), microphone=(), geolocation=()',\n    );\n\n    // HSTS (HTTP Strict Transport Security)\n    if (process.env.NODE_ENV === 'production') {\n      res.setHeader(\n        'Strict-Transport-Security',\n        'max-age=31536000; includeSubDomains; preload',\n      );\n    }\n\n    // Cache Control for sensitive endpoints\n    if (this.isSensitiveEndpoint(req.path)) {\n      res.setHeader(\n        'Cache-Control',\n        'no-store, no-cache, must-revalidate, private',\n      );\n      res.setHeader('Pragma', 'no-cache');\n      res.setHeader('Expires', '0');\n    }\n\n    // CORS headers (if not handled by NestJS CORS)\n    const allowedOrigins = [\n      frontendUrl,\n      'http://localhost:3000',\n      'http://localhost:3001',\n    ];\n\n    const origin = req.headers.origin;\n    if (origin && allowedOrigins.includes(origin)) {\n      res.setHeader('Access-Control-Allow-Origin', origin);\n    }\n\n    res.setHeader(\n      'Access-Control-Allow-Methods',\n      'GET, POST, PUT, DELETE, OPTIONS, PATCH',\n    );\n    res.setHeader(\n      'Access-Control-Allow-Headers',\n      'Content-Type, Authorization, X-Requested-With',\n    );\n    res.setHeader('Access-Control-Allow-Credentials', 'true');\n    res.setHeader('Access-Control-Max-Age', '86400'); // 24 hours\n\n    // Handle preflight requests\n    if (req.method === 'OPTIONS') {\n      res.status(200).end();\n      return;\n    }\n\n    next();\n  }\n\n  private isSensitiveEndpoint(path: string): boolean {\n    const sensitivePatterns = [\n      '/auth',\n      '/admin',\n      '/billing',\n      '/files',\n      '/pre-assessment',\n      '/sessions',\n      '/messaging',\n    ];\n\n    return sensitivePatterns.some((pattern) => path.startsWith(pattern));\n  }\n}\n"],"version":3}