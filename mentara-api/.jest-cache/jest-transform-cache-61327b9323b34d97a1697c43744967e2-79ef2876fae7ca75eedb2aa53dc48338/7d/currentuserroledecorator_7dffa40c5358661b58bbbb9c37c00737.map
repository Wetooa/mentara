{"version":3,"names":["cov_1zr17ohhwz","actualCoverage","s","common_1","require","prisma_client_provider_1","exports","CurrentUserRole","createParamDecorator","_","context","f","request","switchToHttp","getRequest","clerkId","userId","b","userRole","prisma","PrismaService","user","findUnique","where","id","select","role","$disconnect","error","console","Error","message"],"sources":["/home/wetooa/Documents/code/projects/mentara/mentara-api/src/auth/decorators/current-user-role.decorator.ts"],"sourcesContent":["import { createParamDecorator, type ExecutionContext } from '@nestjs/common';\nimport { type Request } from 'express';\nimport { PrismaService } from 'src/providers/prisma-client.provider';\nimport '../../types';\n\nexport const CurrentUserRole = createParamDecorator(\n  async (_, context: ExecutionContext) => {\n    const request = context.switchToHttp().getRequest<Request>();\n    const clerkId = request.userId;\n\n    if (!clerkId) {\n      return null;\n    }\n\n    // First, check if role was extracted from JWT token by JwtAuthGuard\n    if (request.userRole) {\n      return request.userRole;\n    }\n\n    // Fallback to database lookup for backwards compatibility\n    try {\n      const prisma = new PrismaService();\n      const user = await prisma.user.findUnique({\n        where: { id: clerkId },\n        select: { role: true },\n      });\n\n      await prisma.$disconnect();\n      return user?.role ?? null;\n    } catch (error) {\n      console.error(\n        'Error getting user role from database:',\n        error instanceof Error ? error.message : error,\n      );\n      return null;\n    }\n  },\n);\n"],"mappings":"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","ignoreList":[]}