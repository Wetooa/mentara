{"file":"/home/wetooa/Documents/code/projects/mentara/mentara-api/src/auth/auth.service.ts","mappings":"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","names":[],"sources":["/home/wetooa/Documents/code/projects/mentara/mentara-api/src/auth/auth.service.ts"],"sourcesContent":["import {\n  ConflictException,\n  Injectable,\n  InternalServerErrorException,\n  UnauthorizedException,\n  BadRequestException,\n} from '@nestjs/common';\nimport { PrismaService } from 'src/providers/prisma-client.provider';\n// Event bus and token services for auth operations\nimport { EventBusService } from '../common/events/event-bus.service';\nimport { UserRegisteredEvent } from '../common/events/user-events';\nimport { TokenService, SimpleToken } from './services/token.service';\nimport { EmailVerificationService } from './services/email-verification.service';\nimport { PasswordResetService } from './services/password-reset.service';\n\n@Injectable()\nexport class AuthService {\n  constructor(\n    private readonly prisma: PrismaService,\n    private readonly eventBus: EventBusService,\n    private readonly tokenService: TokenService,\n    private readonly emailVerificationService: EmailVerificationService,\n    private readonly passwordResetService: PasswordResetService,\n  ) {}\n\n  async registerClient(\n    email: string,\n    password: string,\n    firstName: string,\n    lastName: string,\n    additionalData?: any,\n  ): Promise<{ user: any; token: string; message: string }> {\n    try {\n      // Use the existing local registration method\n      const { user } = await this.registerUserWithEmail(\n        email,\n        password,\n        firstName,\n        lastName,\n        'client',\n        additionalData,\n      );\n\n      // Generate single token for immediate login after registration\n      const { token } = await this.tokenService.generateToken(\n        user.id,\n        user.email,\n        user.role,\n      );\n\n      return {\n        user,\n        token,\n        message:\n          'Client registered successfully. Please check your email to verify your account.',\n      };\n    } catch (error) {\n      console.error(\n        'Client registration error:',\n        error instanceof Error ? error.message : error,\n      );\n      if (error instanceof ConflictException) {\n        throw error;\n      }\n      throw new InternalServerErrorException('Client registration failed');\n    }\n  }\n\n  async registerTherapist(\n    email: string,\n    password: string,\n    firstName: string,\n    lastName: string,\n    additionalData?: any,\n  ): Promise<{ user: any; token: string; message: string }> {\n    try {\n      // Use the existing local registration method\n      const { user } = await this.registerUserWithEmail(\n        email,\n        password,\n        firstName,\n        lastName,\n        'therapist',\n        additionalData,\n      );\n\n      // Generate single token for immediate login after registration\n      const { token } = await this.tokenService.generateToken(\n        user.id,\n        user.email,\n        user.role,\n      );\n\n      return {\n        user,\n        token,\n        message:\n          'Therapist registered successfully. Please check your email to verify your account. Your application is pending approval.',\n      };\n    } catch (error) {\n      console.error(\n        'Therapist registration error:',\n        error instanceof Error ? error.message : error,\n      );\n      if (error instanceof ConflictException) {\n        throw error;\n      }\n      throw new InternalServerErrorException('Therapist registration failed');\n    }\n  }\n\n  async getUsers() {\n    return this.prisma.user.findMany({\n      where: {\n        deactivatedAt: null,\n      },\n      select: {\n        id: true,\n        email: true,\n        firstName: true,\n        lastName: true,\n        role: true,\n        emailVerified: true,\n        createdAt: true,\n        updatedAt: true,\n        client: {\n          select: {\n            userId: true,\n          },\n        },\n        therapist: {\n          select: {\n            userId: true,\n            status: true,\n          },\n        },\n      },\n      orderBy: {\n        createdAt: 'desc',\n      },\n    });\n  }\n\n  async getUser(userId: string) {\n    const user = await this.prisma.user.findUnique({\n      where: {\n        id: userId,\n        deactivatedAt: null,\n      },\n      select: {\n        id: true,\n        email: true,\n        firstName: true,\n        lastName: true,\n        role: true,\n        emailVerified: true,\n        createdAt: true,\n        updatedAt: true,\n        client: {\n          select: {\n            userId: true,\n          },\n        },\n        therapist: {\n          select: {\n            userId: true,\n            status: true,\n          },\n        },\n      },\n    });\n\n    if (!user) {\n      throw new UnauthorizedException('User not found');\n    }\n\n    return user;\n  }\n\n  async forceLogout(userId: string) {\n    try {\n      // Simple logout - just update last activity\n      await this.tokenService.logout(userId);\n\n      return { success: true, message: 'User logged out successfully' };\n    } catch (error) {\n      console.error(\n        'Force logout error:',\n        error instanceof Error ? error.message : error,\n      );\n      throw new InternalServerErrorException('Force logout failed');\n    }\n  }\n\n  /**\n   * Check if a user exists by email\n   * @param email - User's email address\n   * @returns Object containing user existence status, role, and verification status\n   */\n  async checkUserExists(email: string): Promise<{\n    exists: boolean;\n    role?: string;\n    emailVerified?: boolean;\n  }> {\n    try {\n      const user = await this.prisma.user.findUnique({\n        where: { email },\n        select: {\n          id: true,\n          email: true,\n          role: true,\n          emailVerified: true,\n          isActive: true,\n        },\n      });\n\n      if (!user) {\n        return { exists: false };\n      }\n\n      // Only return user info if account is active\n      if (!user.isActive) {\n        return { exists: false };\n      }\n\n      return {\n        exists: true,\n        role: user.role,\n        emailVerified: user.emailVerified,\n      };\n    } catch (error) {\n      console.error('Error checking user existence:', error);\n      // Return false for any database errors to prevent information leakage\n      return { exists: false };\n    }\n  }\n\n  // Local Authentication Methods\n  async registerUserWithEmail(\n    email: string,\n    password: string,\n    firstName: string,\n    lastName: string,\n    role: 'client' | 'therapist' = 'client',\n    additionalData?: any,\n  ): Promise<{ user: any; message: string }> {\n    // Check if user already exists\n    const existingUser = await this.prisma.user.findUnique({\n      where: { email },\n    });\n\n    if (existingUser) {\n      throw new ConflictException('User with this email already exists');\n    }\n\n    // Hash password\n    const hashedPassword = await this.tokenService.hashPassword(password);\n\n    // Generate email verification token\n    const { hashedToken, expiresAt } =\n      await this.tokenService.generateEmailVerificationToken();\n\n    // Create user\n    const userData = {\n      email,\n      password: hashedPassword,\n      firstName,\n      lastName,\n      role,\n      emailVerifyToken: hashedToken,\n      emailVerifyTokenExp: expiresAt,\n      ...additionalData,\n    };\n\n    const user = await this.prisma.user.create({\n      data: userData,\n      select: {\n        id: true,\n        email: true,\n        firstName: true,\n        lastName: true,\n        role: true,\n        emailVerified: true,\n      },\n    });\n\n    // Create role-specific record\n    if (role === 'client') {\n      await this.prisma.client.create({\n        data: { userId: user.id },\n      });\n    } else if (role === 'therapist') {\n      await this.prisma.therapist.create({\n        data: {\n          userId: user.id,\n          status: 'PENDING',\n          mobile: '',\n          province: '',\n          providerType: '',\n          professionalLicenseType: '',\n          isPRCLicensed: '',\n          prcLicenseNumber: '',\n          expirationDateOfLicense: new Date(),\n          practiceStartDate: new Date(),\n          sessionLength: '60 minutes', // Default\n          hourlyRate: 0,\n          providedOnlineTherapyBefore: false,\n          comfortableUsingVideoConferencing: false,\n          compliesWithDataPrivacyAct: false,\n          willingToAbideByPlatformGuidelines: false,\n          treatmentSuccessRates: {},\n        },\n      });\n    }\n\n    // Send verification email\n    await this.emailVerificationService.sendVerificationEmail(user.id);\n\n    // Publish registration event\n    await this.eventBus.emit(\n      new UserRegisteredEvent({\n        userId: user.id,\n        email: user.email,\n        firstName: user.firstName,\n        lastName: user.lastName,\n        role,\n        registrationMethod: 'email',\n      }),\n    );\n\n    return {\n      user,\n      message:\n        'User registered successfully. Please check your email to verify your account.',\n    };\n  }\n\n  async loginWithEmail(\n    email: string,\n    password: string,\n    ipAddress?: string,\n    userAgent?: string,\n  ): Promise<{ user: any; token: string }> {\n    const user = await this.prisma.user.findUnique({\n      where: { email },\n      select: {\n        id: true,\n        email: true,\n        firstName: true,\n        lastName: true,\n        role: true,\n        password: true,\n        emailVerified: true,\n        deactivatedAt: true,\n        lockoutUntil: true,\n        failedLoginCount: true,\n        client: {\n          select: {\n            hasSeenTherapistRecommendations: true,\n          },\n        },\n        therapist: true,\n      },\n    });\n\n    if (!user) {\n      throw new UnauthorizedException('Invalid credentials');\n    }\n\n    if (user.deactivatedAt) {\n      throw new UnauthorizedException('Account has been deactivated');\n    }\n\n    if (!user.password) {\n      throw new UnauthorizedException(\n        'Please complete account setup or reset your password',\n      );\n    }\n\n    // Check account lockout\n    const isLockedOut = await this.tokenService.checkAccountLockout(user.id);\n    if (isLockedOut) {\n      throw new UnauthorizedException(\n        'Account is temporarily locked due to too many failed login attempts',\n      );\n    }\n\n    // Verify password\n    const isPasswordValid = await this.tokenService.comparePassword(\n      password,\n      user.password,\n    );\n    if (!isPasswordValid) {\n      await this.tokenService.handleFailedLogin(user.id);\n      throw new UnauthorizedException('Invalid credentials');\n    }\n\n    // Check email verification\n    if (!user.emailVerified) {\n      throw new UnauthorizedException(\n        'Please verify your email address before logging in',\n      );\n    }\n\n    // Reset failed login count and update last login\n    await this.tokenService.resetFailedLoginCount(user.id);\n\n    // Generate single token\n    const { token } = await this.tokenService.generateToken(\n      user.id,\n      user.email,\n      user.role,\n    );\n\n    // Remove sensitive data from user object\n    const {\n      password: _,\n      lockoutUntil: __,\n      failedLoginCount: ___,\n      ...safeUser\n    } = user;\n\n    return { user: safeUser, token };\n  }\n\n  // Simplified logout - no refresh tokens to manage\n  async logout(userId: string): Promise<void> {\n    await this.tokenService.logout(userId);\n  }\n\n  async validateUser(userId: string) {\n    return this.prisma.user.findUnique({\n      where: {\n        id: userId,\n        deactivatedAt: null,\n      },\n      select: {\n        id: true,\n        email: true,\n        firstName: true,\n        lastName: true,\n        role: true,\n        emailVerified: true,\n        createdAt: true,\n        updatedAt: true,\n        client: true,\n        therapist: true,\n      },\n    });\n  }\n\n  /**\n   * Validates a JWT token and returns user information\n   * @param token - The JWT token to validate\n   * @returns Promise with validation result and user data\n   */\n  /**\n   * Validates a JWT token and returns user information\n   * @param token - The JWT token to validate\n   * @returns Promise with validation result and user data\n   */\n  async validateToken(token: string): Promise<{\n    valid: boolean;\n    user?: any;\n    error?: string;\n  }> {\n    try {\n      // Validate token using TokenService (simplified - no expiration)\n      const tokenValidation = await this.tokenService.validateToken(token);\n\n      if (!tokenValidation.valid) {\n        return {\n          valid: false,\n          error: tokenValidation.error,\n        };\n      }\n\n      // Get user information from the token payload\n      const payload = tokenValidation.payload;\n      const userId = payload.sub;\n\n      // Fetch user from database to ensure they still exist and are active\n      const user = await this.prisma.user.findUnique({\n        where: {\n          id: userId,\n          deactivatedAt: null, // Ensure user is not deactivated\n        },\n        select: {\n          id: true,\n          email: true,\n          firstName: true,\n          lastName: true,\n          role: true,\n          emailVerified: true,\n          client: {\n            select: {\n              userId: true,\n            },\n          },\n          therapist: {\n            select: {\n              userId: true,\n              status: true,\n            },\n          },\n        },\n      });\n\n      if (!user) {\n        return {\n          valid: false,\n          error: 'User not found or deactivated',\n        };\n      }\n\n      // Verify role matches token\n      if (user.role !== payload.role) {\n        return {\n          valid: false,\n          error: 'Role mismatch - token invalid',\n        };\n      }\n\n      // Structure user data based on role\n      let roleSpecificUser;\n\n      if (user.role === 'client') {\n        roleSpecificUser = {\n          id: user.id,\n          email: user.email,\n          firstName: user.firstName,\n          lastName: user.lastName,\n          role: user.role,\n          emailVerified: user.emailVerified,\n          isOnboardingComplete: false, // Default for now\n          profile: {\n            userId: user.id,\n            isOnboardingComplete: false, // Default for now\n          },\n        };\n      } else if (user.role === 'therapist') {\n        roleSpecificUser = {\n          id: user.id,\n          email: user.email,\n          firstName: user.firstName,\n          lastName: user.lastName,\n          role: user.role,\n          emailVerified: user.emailVerified,\n          status: user.therapist?.status || 'PENDING',\n          profile: {\n            userId: user.id,\n            status: user.therapist?.status || 'PENDING',\n          },\n        };\n      } else {\n        // For admin/moderator roles, return basic user info\n        roleSpecificUser = {\n          id: user.id,\n          email: user.email,\n          firstName: user.firstName,\n          lastName: user.lastName,\n          role: user.role,\n          emailVerified: user.emailVerified,\n        };\n      }\n\n      return {\n        valid: true,\n        user: roleSpecificUser,\n      };\n    } catch (error) {\n      console.error('Token validation error:', error);\n      return {\n        valid: false,\n        error: 'Token validation failed',\n      };\n    }\n  }\n\n  // Email verification methods\n  async verifyEmail(\n    token: string,\n  ): Promise<{ success: boolean; message: string }> {\n    return this.emailVerificationService.verifyEmail(token);\n  }\n\n  async resendVerificationEmail(email: string): Promise<void> {\n    return this.emailVerificationService.resendVerificationEmail(email);\n  }\n\n  // Password reset methods\n  async requestPasswordReset(email: string): Promise<void> {\n    return this.passwordResetService.requestPasswordReset(email);\n  }\n\n  async resetPassword(\n    token: string,\n    newPassword: string,\n  ): Promise<{ success: boolean; message: string }> {\n    return this.passwordResetService.resetPassword(token, newPassword);\n  }\n\n  async validateResetToken(\n    token: string,\n  ): Promise<{ valid: boolean; email?: string }> {\n    return this.passwordResetService.validateResetToken(token);\n  }\n\n  // Account management methods\n  async changePassword(\n    userId: string,\n    currentPassword: string,\n    newPassword: string,\n  ): Promise<{ success: boolean; message: string }> {\n    const user = await this.prisma.user.findUnique({\n      where: { id: userId },\n      select: { password: true, deactivatedAt: true },\n    });\n\n    if (!user || user.deactivatedAt) {\n      throw new UnauthorizedException('User not found or deactivated');\n    }\n\n    if (!user.password) {\n      throw new BadRequestException('Please complete account setup first');\n    }\n\n    // Verify current password\n    const isCurrentPasswordValid = await this.tokenService.comparePassword(\n      currentPassword,\n      user.password,\n    );\n    if (!isCurrentPasswordValid) {\n      throw new UnauthorizedException('Current password is incorrect');\n    }\n\n    // Check if new password is different\n    const isSamePassword = await this.tokenService.comparePassword(\n      newPassword,\n      user.password,\n    );\n    if (isSamePassword) {\n      throw new BadRequestException(\n        'New password must be different from current password',\n      );\n    }\n\n    // Hash new password\n    const hashedPassword = await this.tokenService.hashPassword(newPassword);\n\n    // Update password\n    await this.prisma.user.update({\n      where: { id: userId },\n      data: { password: hashedPassword },\n    });\n\n    // Simple logout after password change\n    await this.tokenService.logout(userId);\n\n    return {\n      success: true,\n      message: 'Password changed successfully. Please log in again.',\n    };\n  }\n\n  async deactivateAccount(\n    userId: string,\n    reason?: string,\n    deactivatedBy?: string,\n  ): Promise<{ success: boolean; message: string }> {\n    await this.prisma.user.update({\n      where: { id: userId },\n      data: {\n        deactivatedAt: new Date(),\n        deactivatedBy,\n        deactivationReason: reason,\n      },\n    });\n\n    // Simple logout for deactivated account\n    await this.tokenService.logout(userId);\n\n    return {\n      success: true,\n      message: 'Account deactivated successfully',\n    };\n  }\n\n  async reactivateAccount(\n    userId: string,\n  ): Promise<{ success: boolean; message: string }> {\n    await this.prisma.user.update({\n      where: { id: userId },\n      data: {\n        deactivatedAt: null,\n        deactivatedBy: null,\n        deactivationReason: null,\n        failedLoginCount: 0,\n        lockoutUntil: null,\n      },\n    });\n\n    return {\n      success: true,\n      message: 'Account reactivated successfully',\n    };\n  }\n\n  async handleOAuthLogin(\n    oauthUser: any,\n    provider: string,\n    role: string = 'client',\n  ) {\n    try {\n      // Check if user exists\n      const existingUser = await this.prisma.user.findUnique({\n        where: { email: oauthUser.email },\n        include: {\n          client: true,\n          therapist: true,\n        },\n      });\n\n      if (existingUser) {\n        // User exists, generate token and return\n        const { token } = await this.tokenService.generateToken(\n          existingUser.id,\n          existingUser.email,\n          existingUser.role,\n        );\n\n        return {\n          user: {\n            id: existingUser.id,\n            email: existingUser.email,\n            firstName: existingUser.firstName,\n            lastName: existingUser.lastName,\n            role: existingUser.role,\n            emailVerified: existingUser.emailVerified,\n          },\n          token,\n          message: 'Login successful',\n        };\n      } else {\n        // Validate role for new user creation\n        const validRole = ['client', 'therapist'].includes(role)\n          ? role\n          : 'client';\n\n        // Create new user from OAuth data\n        const newUser = await this.prisma.user.create({\n          data: {\n            email: oauthUser.email,\n            firstName: oauthUser.firstName,\n            lastName: oauthUser.lastName,\n            role: validRole,\n            emailVerified: true, // OAuth emails are pre-verified\n            avatarUrl: oauthUser.picture,\n          },\n          select: {\n            id: true,\n            email: true,\n            firstName: true,\n            lastName: true,\n            role: true,\n            emailVerified: true,\n          },\n        });\n\n        // Create role-specific record for new user\n        if (validRole === 'client') {\n          await this.prisma.client.create({\n            data: { userId: newUser.id },\n          });\n        } else if (validRole === 'therapist') {\n          await this.prisma.therapist.create({\n            data: {\n              userId: newUser.id,\n              status: 'PENDING',\n              mobile: '',\n              province: '',\n              providerType: '',\n              professionalLicenseType: '',\n              isPRCLicensed: '',\n              prcLicenseNumber: '',\n              expirationDateOfLicense: new Date(),\n              practiceStartDate: new Date(),\n              sessionLength: '60 minutes', // Default\n              hourlyRate: 0,\n              providedOnlineTherapyBefore: false,\n              comfortableUsingVideoConferencing: false,\n              compliesWithDataPrivacyAct: false,\n              willingToAbideByPlatformGuidelines: false,\n              treatmentSuccessRates: {},\n            },\n          });\n        }\n\n        const { token } = await this.tokenService.generateToken(\n          newUser.id,\n          newUser.email,\n          newUser.role,\n        );\n\n        // Emit user registration event\n        this.eventBus.emit(\n          new UserRegisteredEvent({\n            userId: newUser.id,\n            email: newUser.email,\n            firstName: newUser.firstName,\n            lastName: newUser.lastName,\n            role: newUser.role as\n              | 'client'\n              | 'therapist'\n              | 'moderator'\n              | 'admin',\n            registrationMethod: 'oauth',\n          }),\n        );\n\n        return {\n          user: newUser,\n          token,\n          message: 'Account created successfully',\n        };\n      }\n    } catch (error) {\n      throw new InternalServerErrorException(\n        `OAuth login failed: ${error instanceof Error ? error.message : 'Unknown error'}`,\n      );\n    }\n  }\n\n  // ===== FIRST-TIME USER FLOW METHODS =====\n\n  async getFirstSignInStatus(userId: string) {\n    const client = await this.prisma.client.findUnique({\n      where: { userId },\n      select: {\n        hasSeenTherapistRecommendations: true,\n        createdAt: true,\n      },\n    });\n\n    if (!client) {\n      throw new UnauthorizedException('Client profile not found');\n    }\n\n    return {\n      isFirstTime: !client.hasSeenTherapistRecommendations,\n      needsWelcomeFlow: !client.hasSeenTherapistRecommendations,\n      memberSince: client.createdAt,\n    };\n  }\n\n  async markRecommendationsSeen(userId: string) {\n    const updatedClient = await this.prisma.client.update({\n      where: { userId },\n      data: { hasSeenTherapistRecommendations: true },\n      select: {\n        hasSeenTherapistRecommendations: true,\n        updatedAt: true,\n      },\n    });\n\n    return {\n      success: true,\n      hasSeenRecommendations: updatedClient.hasSeenTherapistRecommendations,\n      markedAt: updatedClient.updatedAt,\n      message: 'Recommendations marked as seen successfully',\n    };\n  }\n\n  // Removed session management - using single tokens now\n}\n"],"version":3}