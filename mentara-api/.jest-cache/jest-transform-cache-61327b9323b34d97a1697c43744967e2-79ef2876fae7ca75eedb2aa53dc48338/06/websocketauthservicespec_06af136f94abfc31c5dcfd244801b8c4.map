{"file":"/home/wetooa/Documents/code/projects/mentara/mentara-api/src/messaging/services/websocket-auth.service.spec.ts","mappings":"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","names":[],"sources":["/home/wetooa/Documents/code/projects/mentara/mentara-api/src/messaging/services/websocket-auth.service.spec.ts"],"sourcesContent":["import { Test, TestingModule } from '@nestjs/testing';\nimport { WebSocketAuthService, AuthenticatedUser } from './websocket-auth.service';\nimport { JwtService } from '@nestjs/jwt';\nimport { PrismaService } from '../../providers/prisma-client.provider';\nimport { Socket } from 'socket.io';\nimport { Logger } from '@nestjs/common';\n\ndescribe('WebSocketAuthService', () => {\n  let service: WebSocketAuthService;\n  let jwtService: jest.Mocked<JwtService>;\n  let prismaService: jest.Mocked<PrismaService>;\n  let mockSocket: Partial<Socket>;\n\n  const mockUser = {\n    id: 'user-123',\n    role: 'client',\n    emailVerified: true,\n    lockoutUntil: null,\n    failedLoginCount: 0,\n  };\n\n  const mockJwtPayload = {\n    sub: 'user-123',\n    email: 'user@example.com',\n    iat: Math.floor(Date.now() / 1000) - 3600, // 1 hour ago\n    exp: Math.floor(Date.now() / 1000) + 3600, // 1 hour from now\n  };\n\n  beforeEach(async () => {\n    const module: TestingModule = await Test.createTestingModule({\n      providers: [\n        WebSocketAuthService,\n        {\n          provide: JwtService,\n          useValue: {\n            verify: jest.fn(),\n          },\n        },\n        {\n          provide: PrismaService,\n          useValue: {\n            user: {\n              findUnique: jest.fn(),\n            },\n          },\n        },\n      ],\n    }).compile();\n\n    service = module.get<WebSocketAuthService>(WebSocketAuthService);\n    jwtService = module.get(JwtService);\n    prismaService = module.get(PrismaService);\n\n    // Mock socket with default properties\n    mockSocket = {\n      id: 'socket-123',\n      handshake: {\n        headers: {\n          authorization: 'Bearer valid-token',\n        },\n        auth: {},\n        query: {},\n        address: '127.0.0.1',\n      },\n      conn: {\n        remoteAddress: '127.0.0.1',\n      },\n    };\n\n    // Clear any existing intervals\n    jest.clearAllTimers();\n    jest.useFakeTimers();\n  });\n\n  afterEach(() => {\n    jest.clearAllMocks();\n    jest.clearAllTimers();\n    jest.useRealTimers();\n  });\n\n  it('should be defined', () => {\n    expect(service).toBeDefined();\n  });\n\n  describe('authenticateSocket', () => {\n    beforeEach(() => {\n      jwtService.verify.mockReturnValue(mockJwtPayload);\n      prismaService.user.findUnique.mockResolvedValue(mockUser);\n    });\n\n    it('should authenticate socket successfully', async () => {\n      const result = await service.authenticateSocket(mockSocket as Socket);\n\n      expect(result).toEqual({\n        userId: 'user-123',\n        role: 'client',\n        lastAuthenticated: expect.any(Date),\n        connectionCount: 1,\n      });\n      expect(jwtService.verify).toHaveBeenCalledWith('valid-token', {\n        algorithms: ['HS256'],\n      });\n      expect(prismaService.user.findUnique).toHaveBeenCalledWith({\n        where: {\n          id: 'user-123',\n          deactivatedAt: null,\n          isActive: true,\n        },\n        select: {\n          id: true,\n          role: true,\n          emailVerified: true,\n          lockoutUntil: true,\n          failedLoginCount: true,\n        },\n      });\n    });\n\n    it('should return null when no token is provided', async () => {\n      mockSocket.handshake!.headers = {};\n\n      const result = await service.authenticateSocket(mockSocket as Socket);\n\n      expect(result).toBeNull();\n      expect(jwtService.verify).not.toHaveBeenCalled();\n    });\n\n    it('should return null when token verification fails', async () => {\n      jwtService.verify.mockImplementation(() => {\n        throw new Error('Invalid token');\n      });\n\n      const result = await service.authenticateSocket(mockSocket as Socket);\n\n      expect(result).toBeNull();\n      expect(prismaService.user.findUnique).not.toHaveBeenCalled();\n    });\n\n    it('should return null when token payload is invalid', async () => {\n      jwtService.verify.mockReturnValue({\n        sub: null,\n        email: null,\n        iat: Date.now() / 1000,\n      });\n\n      const result = await service.authenticateSocket(mockSocket as Socket);\n\n      expect(result).toBeNull();\n      expect(prismaService.user.findUnique).not.toHaveBeenCalled();\n    });\n\n    it('should return null when token is stale', async () => {\n      jwtService.verify.mockReturnValue({\n        sub: 'user-123',\n        email: 'user@example.com',\n        iat: Math.floor(Date.now() / 1000) - 25 * 60 * 60, // 25 hours ago\n      });\n\n      const result = await service.authenticateSocket(mockSocket as Socket);\n\n      expect(result).toBeNull();\n      expect(prismaService.user.findUnique).not.toHaveBeenCalled();\n    });\n\n    it('should return null when user is not found', async () => {\n      prismaService.user.findUnique.mockResolvedValue(null);\n\n      const result = await service.authenticateSocket(mockSocket as Socket);\n\n      expect(result).toBeNull();\n    });\n\n    it('should return null when user account is locked', async () => {\n      const lockedUser = {\n        ...mockUser,\n        lockoutUntil: new Date(Date.now() + 60 * 60 * 1000), // 1 hour from now\n      };\n      prismaService.user.findUnique.mockResolvedValue(lockedUser);\n\n      const result = await service.authenticateSocket(mockSocket as Socket);\n\n      expect(result).toBeNull();\n    });\n\n    it('should allow connection when lockout period has expired', async () => {\n      const unlockedUser = {\n        ...mockUser,\n        lockoutUntil: new Date(Date.now() - 60 * 60 * 1000), // 1 hour ago\n      };\n      prismaService.user.findUnique.mockResolvedValue(unlockedUser);\n\n      const result = await service.authenticateSocket(mockSocket as Socket);\n\n      expect(result).toEqual({\n        userId: 'user-123',\n        role: 'client',\n        lastAuthenticated: expect.any(Date),\n        connectionCount: 1,\n      });\n    });\n\n    it('should return null when connection limit is exceeded', async () => {\n      // First, create max allowed connections\n      const maxConnections = 5;\n      for (let i = 0; i < maxConnections; i++) {\n        const socketId = `socket-${i}`;\n        await service.authenticateSocket({\n          ...mockSocket,\n          id: socketId,\n        } as Socket);\n      }\n\n      // Try to create one more connection (should fail)\n      const result = await service.authenticateSocket({\n        ...mockSocket,\n        id: 'socket-overflow',\n      } as Socket);\n\n      expect(result).toBeNull();\n    });\n\n    it('should handle database errors gracefully', async () => {\n      prismaService.user.findUnique.mockRejectedValue(new Error('Database error'));\n\n      const result = await service.authenticateSocket(mockSocket as Socket);\n\n      expect(result).toBeNull();\n    });\n\n    it('should log successful authentication', async () => {\n      const loggerSpy = jest.spyOn(Logger.prototype, 'log');\n\n      await service.authenticateSocket(mockSocket as Socket);\n\n      expect(loggerSpy).toHaveBeenCalledWith(\n        'Socket socket-123 authenticated as user user-123 with role client (1 connections)',\n      );\n    });\n\n    it('should log authentication failures', async () => {\n      const loggerSpy = jest.spyOn(Logger.prototype, 'warn');\n      mockSocket.handshake!.headers = {}; // No token\n\n      await service.authenticateSocket(mockSocket as Socket);\n\n      expect(loggerSpy).toHaveBeenCalledWith(\n        'Socket socket-123 connected without valid token',\n      );\n    });\n  });\n\n  describe('Token Extraction', () => {\n    it('should extract token from Authorization header', async () => {\n      mockSocket.handshake!.headers = {\n        authorization: 'Bearer test-token',\n      };\n\n      await service.authenticateSocket(mockSocket as Socket);\n\n      expect(jwtService.verify).toHaveBeenCalledWith('test-token', {\n        algorithms: ['HS256'],\n      });\n    });\n\n    it('should extract token from auth object', async () => {\n      mockSocket.handshake!.headers = {};\n      mockSocket.handshake!.auth = { token: 'auth-token' };\n\n      await service.authenticateSocket(mockSocket as Socket);\n\n      expect(jwtService.verify).toHaveBeenCalledWith('auth-token', {\n        algorithms: ['HS256'],\n      });\n    });\n\n    it('should extract token from query parameters', async () => {\n      mockSocket.handshake!.headers = {};\n      mockSocket.handshake!.auth = {};\n      mockSocket.handshake!.query = { token: 'query-token' };\n\n      await service.authenticateSocket(mockSocket as Socket);\n\n      expect(jwtService.verify).toHaveBeenCalledWith('query-token', {\n        algorithms: ['HS256'],\n      });\n    });\n\n    it('should extract token from cookies', async () => {\n      mockSocket.handshake!.headers = {\n        cookie: '__session=cookie-token; other=value',\n      };\n\n      await service.authenticateSocket(mockSocket as Socket);\n\n      expect(jwtService.verify).toHaveBeenCalledWith('cookie-token', {\n        algorithms: ['HS256'],\n      });\n    });\n\n    it('should handle malformed Authorization header', async () => {\n      mockSocket.handshake!.headers = {\n        authorization: 'Invalid header format',\n      };\n\n      const result = await service.authenticateSocket(mockSocket as Socket);\n\n      expect(result).toBeNull();\n      expect(jwtService.verify).not.toHaveBeenCalled();\n    });\n\n    it('should handle empty Bearer token', async () => {\n      mockSocket.handshake!.headers = {\n        authorization: 'Bearer ',\n      };\n\n      const result = await service.authenticateSocket(mockSocket as Socket);\n\n      expect(result).toBeNull();\n      expect(jwtService.verify).not.toHaveBeenCalled();\n    });\n\n    it('should handle complex cookie parsing', async () => {\n      mockSocket.handshake!.headers = {\n        cookie: 'first=value1; __session=session-token; last=value2; __session=duplicate',\n      };\n\n      await service.authenticateSocket(mockSocket as Socket);\n\n      expect(jwtService.verify).toHaveBeenCalledWith('session-token', {\n        algorithms: ['HS256'],\n      });\n    });\n\n    it('should handle URL encoded cookies', async () => {\n      mockSocket.handshake!.headers = {\n        cookie: '__session=encoded%20token%20value',\n      };\n\n      await service.authenticateSocket(mockSocket as Socket);\n\n      expect(jwtService.verify).toHaveBeenCalledWith('encoded token value', {\n        algorithms: ['HS256'],\n      });\n    });\n\n    it('should handle cookie parsing errors gracefully', async () => {\n      const loggerSpy = jest.spyOn(Logger.prototype, 'warn');\n      mockSocket.handshake!.headers = {\n        cookie: '__session=%invalid%encoding',\n      };\n\n      // Mock decodeURIComponent to throw an error\n      const originalDecodeURIComponent = global.decodeURIComponent;\n      global.decodeURIComponent = jest.fn(() => {\n        throw new Error('Invalid encoding');\n      });\n\n      const result = await service.authenticateSocket(mockSocket as Socket);\n\n      expect(result).toBeNull();\n      expect(loggerSpy).toHaveBeenCalledWith(\n        'Failed to extract cookie value for __session:',\n        expect.any(Error),\n      );\n\n      // Restore original function\n      global.decodeURIComponent = originalDecodeURIComponent;\n    });\n  });\n\n  describe('Rate Limiting', () => {\n    it('should allow connections within rate limit', async () => {\n      const ipAddress = '192.168.1.1';\n      mockSocket.handshake!.headers = {\n        'x-forwarded-for': ipAddress,\n        authorization: 'Bearer valid-token',\n      };\n\n      // Make 5 connections (within limit of 10)\n      for (let i = 0; i < 5; i++) {\n        await service.authenticateSocket({\n          ...mockSocket,\n          id: `socket-${i}`,\n        } as Socket);\n      }\n\n      // Should still allow connection\n      const result = await service.authenticateSocket({\n        ...mockSocket,\n        id: 'socket-final',\n      } as Socket);\n\n      expect(result).toEqual({\n        userId: 'user-123',\n        role: 'client',\n        lastAuthenticated: expect.any(Date),\n        connectionCount: 6,\n      });\n    });\n\n    it('should block connections exceeding rate limit', async () => {\n      const ipAddress = '192.168.1.2';\n      mockSocket.handshake!.headers = {\n        'x-forwarded-for': ipAddress,\n        authorization: 'Bearer valid-token',\n      };\n\n      // Make 10 failed connections (at the limit)\n      jwtService.verify.mockImplementation(() => {\n        throw new Error('Invalid token');\n      });\n\n      for (let i = 0; i < 10; i++) {\n        await service.authenticateSocket({\n          ...mockSocket,\n          id: `socket-${i}`,\n        } as Socket);\n      }\n\n      // Reset JWT service to return valid token\n      jwtService.verify.mockReturnValue(mockJwtPayload);\n\n      // Should be blocked due to rate limit\n      const result = await service.authenticateSocket({\n        ...mockSocket,\n        id: 'socket-blocked',\n      } as Socket);\n\n      expect(result).toBeNull();\n    });\n\n    it('should reset rate limit after time window', async () => {\n      const ipAddress = '192.168.1.3';\n      mockSocket.handshake!.headers = {\n        'x-forwarded-for': ipAddress,\n        authorization: 'Bearer valid-token',\n      };\n\n      // Make 10 failed connections to hit rate limit\n      jwtService.verify.mockImplementation(() => {\n        throw new Error('Invalid token');\n      });\n\n      for (let i = 0; i < 10; i++) {\n        await service.authenticateSocket({\n          ...mockSocket,\n          id: `socket-${i}`,\n        } as Socket);\n      }\n\n      // Advance time by 1 minute and 1 second\n      jest.advanceTimersByTime(61 * 1000);\n\n      // Reset JWT service\n      jwtService.verify.mockReturnValue(mockJwtPayload);\n\n      // Should now allow connection\n      const result = await service.authenticateSocket({\n        ...mockSocket,\n        id: 'socket-after-reset',\n      } as Socket);\n\n      expect(result).toEqual({\n        userId: 'user-123',\n        role: 'client',\n        lastAuthenticated: expect.any(Date),\n        connectionCount: 1,\n      });\n    });\n\n    it('should extract IP from various headers', async () => {\n      const testCases = [\n        { header: 'x-forwarded-for', value: '203.0.113.195' },\n        { header: 'x-real-ip', value: '203.0.113.196' },\n      ];\n\n      for (const testCase of testCases) {\n        mockSocket.handshake!.headers = {\n          [testCase.header]: testCase.value,\n          authorization: 'Bearer valid-token',\n        };\n\n        await service.authenticateSocket({\n          ...mockSocket,\n          id: `socket-${testCase.header}`,\n        } as Socket);\n\n        // Should use the IP from header\n        expect(jwtService.verify).toHaveBeenCalled();\n      }\n    });\n\n    it('should use fallback IP when headers are not available', async () => {\n      mockSocket.handshake!.headers = {\n        authorization: 'Bearer valid-token',\n      };\n      mockSocket.handshake!.address = '10.0.0.1';\n\n      await service.authenticateSocket(mockSocket as Socket);\n\n      expect(jwtService.verify).toHaveBeenCalled();\n    });\n\n    it('should handle unknown IP addresses', async () => {\n      mockSocket.handshake!.headers = {\n        authorization: 'Bearer valid-token',\n      };\n      mockSocket.handshake!.address = undefined;\n      mockSocket.conn!.remoteAddress = undefined;\n\n      await service.authenticateSocket(mockSocket as Socket);\n\n      expect(jwtService.verify).toHaveBeenCalled();\n    });\n  });\n\n  describe('validateToken', () => {\n    it('should validate a valid token', async () => {\n      jwtService.verify.mockReturnValue(mockJwtPayload);\n      prismaService.user.findUnique.mockResolvedValue(mockUser);\n\n      const result = await service.validateToken('valid-token');\n\n      expect(result).toBe(true);\n      expect(jwtService.verify).toHaveBeenCalledWith('valid-token');\n      expect(prismaService.user.findUnique).toHaveBeenCalledWith({\n        where: {\n          id: 'user-123',\n          deactivatedAt: null,\n        },\n        select: { id: true },\n      });\n    });\n\n    it('should reject invalid token', async () => {\n      jwtService.verify.mockImplementation(() => {\n        throw new Error('Invalid token');\n      });\n\n      const result = await service.validateToken('invalid-token');\n\n      expect(result).toBe(false);\n      expect(prismaService.user.findUnique).not.toHaveBeenCalled();\n    });\n\n    it('should reject token for non-existent user', async () => {\n      jwtService.verify.mockReturnValue(mockJwtPayload);\n      prismaService.user.findUnique.mockResolvedValue(null);\n\n      const result = await service.validateToken('valid-token');\n\n      expect(result).toBe(false);\n    });\n\n    it('should log validation warnings', async () => {\n      const loggerSpy = jest.spyOn(Logger.prototype, 'warn');\n      jwtService.verify.mockImplementation(() => {\n        throw new Error('Token expired');\n      });\n\n      await service.validateToken('expired-token');\n\n      expect(loggerSpy).toHaveBeenCalledWith(\n        'Token validation failed:',\n        expect.any(Error),\n      );\n    });\n  });\n\n  describe('Connection Management', () => {\n    it('should track multiple connections per user', async () => {\n      // Create multiple connections for the same user\n      for (let i = 0; i < 3; i++) {\n        const result = await service.authenticateSocket({\n          ...mockSocket,\n          id: `socket-${i}`,\n        } as Socket);\n\n        expect(result?.connectionCount).toBe(i + 1);\n      }\n    });\n\n    it('should clean up connection when socket disconnects', async () => {\n      const socketId = 'socket-cleanup';\n      await service.authenticateSocket({\n        ...mockSocket,\n        id: socketId,\n      } as Socket);\n\n      service.cleanupConnection(socketId);\n\n      // Create another connection, should reset count\n      const result = await service.authenticateSocket({\n        ...mockSocket,\n        id: 'socket-new',\n      } as Socket);\n\n      expect(result?.connectionCount).toBe(1);\n    });\n\n    it('should handle cleanup of non-existent connection', () => {\n      // Should not throw error\n      expect(() => service.cleanupConnection('non-existent')).not.toThrow();\n    });\n  });\n\n  describe('Connection Statistics', () => {\n    it('should return accurate connection statistics', async () => {\n      // Create connections for different users\n      for (let i = 0; i < 3; i++) {\n        jwtService.verify.mockReturnValue({\n          ...mockJwtPayload,\n          sub: `user-${i}`,\n        });\n        prismaService.user.findUnique.mockResolvedValue({\n          ...mockUser,\n          id: `user-${i}`,\n        });\n\n        await service.authenticateSocket({\n          ...mockSocket,\n          id: `socket-${i}`,\n        } as Socket);\n      }\n\n      const stats = service.getConnectionStats();\n\n      expect(stats).toEqual({\n        totalConnections: 3,\n        uniqueUsers: 3,\n        trackedIps: 1, // All connections from same IP\n        maxConnectionsPerUser: 5,\n        maxAttemptsPerMinute: 10,\n      });\n    });\n\n    it('should count unique users correctly', async () => {\n      // Create multiple connections for same user\n      for (let i = 0; i < 3; i++) {\n        await service.authenticateSocket({\n          ...mockSocket,\n          id: `socket-${i}`,\n        } as Socket);\n      }\n\n      const stats = service.getConnectionStats();\n\n      expect(stats.totalConnections).toBe(3);\n      expect(stats.uniqueUsers).toBe(1);\n    });\n  });\n\n  describe('Cleanup and Maintenance', () => {\n    it('should clean up connection tracking periodically', () => {\n      const loggerSpy = jest.spyOn(Logger.prototype, 'debug');\n\n      // Trigger the cleanup interval\n      jest.advanceTimersByTime(5 * 60 * 1000); // 5 minutes\n\n      expect(loggerSpy).toHaveBeenCalledWith(\n        'Cleaned up connection tracking data',\n      );\n    });\n\n    it('should remove old connection attempts during cleanup', async () => {\n      const ipAddress = '192.168.1.100';\n      mockSocket.handshake!.headers = {\n        'x-forwarded-for': ipAddress,\n        authorization: 'Bearer invalid-token',\n      };\n\n      // Create some failed attempts\n      jwtService.verify.mockImplementation(() => {\n        throw new Error('Invalid token');\n      });\n\n      await service.authenticateSocket({\n        ...mockSocket,\n        id: 'socket-old',\n      } as Socket);\n\n      // Advance time by more than 1 hour\n      jest.advanceTimersByTime(61 * 60 * 1000);\n\n      // Trigger cleanup\n      jest.advanceTimersByTime(5 * 60 * 1000);\n\n      // Reset JWT service\n      jwtService.verify.mockReturnValue(mockJwtPayload);\n\n      // Should not be rate limited anymore\n      const result = await service.authenticateSocket({\n        ...mockSocket,\n        id: 'socket-new',\n      } as Socket);\n\n      expect(result).toEqual({\n        userId: 'user-123',\n        role: 'client',\n        lastAuthenticated: expect.any(Date),\n        connectionCount: 1,\n      });\n    });\n  });\n\n  describe('Error Handling and Edge Cases', () => {\n    it('should handle JWT verification errors gracefully', async () => {\n      const loggerSpy = jest.spyOn(Logger.prototype, 'error');\n      jwtService.verify.mockImplementation(() => {\n        throw new Error('Token parsing failed');\n      });\n\n      const result = await service.authenticateSocket(mockSocket as Socket);\n\n      expect(result).toBeNull();\n      expect(loggerSpy).toHaveBeenCalledWith(\n        'Socket socket-123 authentication failed:',\n        'Token parsing failed',\n      );\n    });\n\n    it('should handle non-Error exceptions', async () => {\n      const loggerSpy = jest.spyOn(Logger.prototype, 'error');\n      jwtService.verify.mockImplementation(() => {\n        throw 'String error';\n      });\n\n      const result = await service.authenticateSocket(mockSocket as Socket);\n\n      expect(result).toBeNull();\n      expect(loggerSpy).toHaveBeenCalledWith(\n        'Socket socket-123 authentication failed:',\n        'String error',\n      );\n    });\n\n    it('should handle missing socket properties', async () => {\n      const malformedSocket = {\n        id: 'socket-malformed',\n        handshake: {\n          headers: {},\n          auth: {},\n          query: {},\n        },\n      } as Socket;\n\n      const result = await service.authenticateSocket(malformedSocket);\n\n      expect(result).toBeNull();\n    });\n\n    it('should handle arrays in token sources', async () => {\n      mockSocket.handshake!.query = { token: ['token1', 'token2'] };\n\n      const result = await service.authenticateSocket(mockSocket as Socket);\n\n      expect(result).toBeNull();\n      expect(jwtService.verify).not.toHaveBeenCalled();\n    });\n  });\n\n  describe('Security Features', () => {\n    it('should enforce algorithm restriction', async () => {\n      await service.authenticateSocket(mockSocket as Socket);\n\n      expect(jwtService.verify).toHaveBeenCalledWith('valid-token', {\n        algorithms: ['HS256'],\n      });\n    });\n\n    it('should check for required payload fields', async () => {\n      jwtService.verify.mockReturnValue({\n        sub: 'user-123',\n        // Missing email field\n        iat: Date.now() / 1000,\n      });\n\n      const result = await service.authenticateSocket(mockSocket as Socket);\n\n      expect(result).toBeNull();\n    });\n\n    it('should validate token freshness', async () => {\n      jwtService.verify.mockReturnValue({\n        sub: 'user-123',\n        email: 'user@example.com',\n        iat: Math.floor(Date.now() / 1000) - 25 * 60 * 60, // 25 hours ago\n      });\n\n      const result = await service.authenticateSocket(mockSocket as Socket);\n\n      expect(result).toBeNull();\n    });\n\n    it('should check user active status', async () => {\n      prismaService.user.findUnique.mockResolvedValue({\n        ...mockUser,\n        deactivatedAt: new Date(),\n      });\n\n      const result = await service.authenticateSocket(mockSocket as Socket);\n\n      expect(result).toBeNull();\n    });\n  });\n\n  describe('Integration Tests', () => {\n    it('should handle complete authentication flow', async () => {\n      const result = await service.authenticateSocket(mockSocket as Socket);\n\n      expect(result).toEqual({\n        userId: 'user-123',\n        role: 'client',\n        lastAuthenticated: expect.any(Date),\n        connectionCount: 1,\n      });\n\n      const stats = service.getConnectionStats();\n      expect(stats.totalConnections).toBe(1);\n      expect(stats.uniqueUsers).toBe(1);\n\n      service.cleanupConnection('socket-123');\n      const statsAfterCleanup = service.getConnectionStats();\n      expect(statsAfterCleanup.totalConnections).toBe(0);\n    });\n\n    it('should handle multiple concurrent authentication attempts', async () => {\n      const promises = [];\n      for (let i = 0; i < 3; i++) {\n        promises.push(\n          service.authenticateSocket({\n            ...mockSocket,\n            id: `socket-${i}`,\n          } as Socket),\n        );\n      }\n\n      const results = await Promise.all(promises);\n\n      expect(results.every(result => result !== null)).toBe(true);\n      expect(results.map(r => r?.connectionCount)).toEqual([1, 2, 3]);\n    });\n  });\n});"],"version":3}