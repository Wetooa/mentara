89721498e488902c8b4841fe3e2cae2f
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var __param = (this && this.__param) || function (paramIndex, decorator) {
    return function (target, key) { decorator(target, key, paramIndex); }
};
var MessagingGateway_1;
var _a, _b, _c;
Object.defineProperty(exports, "__esModule", { value: true });
exports.MessagingGateway = void 0;
const websockets_1 = require("@nestjs/websockets");
const socket_io_1 = require("socket.io");
const common_1 = require("@nestjs/common");
const prisma_client_provider_1 = require("../providers/prisma-client.provider");
const websocket_auth_service_1 = require("./services/websocket-auth.service");
let MessagingGateway = MessagingGateway_1 = class MessagingGateway {
    prisma;
    webSocketAuth;
    server;
    logger = new common_1.Logger(MessagingGateway_1.name);
    userSockets = new Map(); // userId -> Set of socket IDs
    conversationParticipants = new Map(); // conversationId -> Set of user IDs
    // Connection limits
    MAX_CONNECTIONS_PER_USER = 3; // Limit to 3 concurrent connections per user
    constructor(prisma, webSocketAuth) {
        this.prisma = prisma;
        this.webSocketAuth = webSocketAuth;
    }
    async handleConnection(client) {
        try {
            this.logger.log(`ðŸ”— New WebSocket connection: ${client.id} from ${client.handshake.address}`);
            // Log connection details for debugging
            this.logger.debug(`ðŸ” Connection details for ${client.id}:`, {
                origin: client.handshake.headers.origin,
                userAgent: client.handshake.headers['user-agent'],
                transport: client.conn.transport.name,
                protocol: client.conn.protocol,
                hasAuth: !!client.handshake.auth?.token,
                hasAuthHeader: !!client.handshake.headers.authorization,
                query: client.handshake.query,
            });
            // Authenticate the socket connection using the new auth service
            const authResult = await this.webSocketAuth.authenticateSocket(client);
            if (!authResult) {
                this.logger.warn(`âŒ Authentication failed for client ${client.id}`);
                // Provide more detailed error information
                const errorDetails = {
                    message: 'Authentication failed. Please sign in again.',
                    code: 'AUTH_FAILED',
                    timestamp: new Date().toISOString(),
                    debug: {
                        socketId: client.id,
                        hasToken: !!client.handshake.auth?.token,
                        hasAuthHeader: !!client.handshake.headers.authorization,
                        origin: client.handshake.headers.origin,
                    }
                };
                client.emit('auth_error', errorDetails);
                this.logger.debug(`ðŸ” Auth error details sent to client ${client.id}:`, errorDetails);
                client.disconnect(true);
                return;
            }
            this.logger.log(`âœ… Socket ${client.id} authenticated as user ${authResult.userId} (${authResult.role})`);
            // Attach authenticated user info to socket
            client.userId = authResult.userId;
            client.userRole = authResult.role;
            client.isAuthenticated = true;
            // Verify user exists in database and is active
            const user = await this.prisma.user.findUnique({
                where: {
                    id: authResult.userId,
                    isActive: true, // Only allow active users
                },
                select: { id: true, role: true, isActive: true, email: true },
            });
            if (!user) {
                this.logger.warn(`âŒ User ${authResult.userId} not found or inactive in database`);
                client.emit('auth_error', {
                    message: 'User account not found or inactive',
                    code: 'USER_NOT_FOUND',
                    timestamp: new Date().toISOString(),
                });
                client.disconnect(true);
                return;
            }
            this.logger.log(`ðŸ‘¤ User ${user.id} (${user.email}) verified in database`);
            // Handle connection limits and deduplication
            await this.handleConnectionLimits(client, authResult.userId);
            // Add socket to user's socket set
            if (!this.userSockets.has(authResult.userId)) {
                this.userSockets.set(authResult.userId, new Set());
            }
            this.userSockets.get(authResult.userId).add(client.id);
            // Join user to their conversation rooms
            await this.joinUserConversations(client, authResult.userId);
            // Subscribe user to their personal notification room
            await this.subscribeUserToPersonalRoom(client, authResult.userId);
            // Notify successful connection
            const successResponse = {
                userId: authResult.userId,
                role: user.role,
                message: 'Successfully authenticated and connected',
                timestamp: new Date().toISOString(),
                connectionInfo: {
                    socketId: client.id,
                    transport: client.conn.transport.name,
                    totalConnections: this.userSockets.get(authResult.userId)?.size || 1,
                }
            };
            client.emit('authenticated', successResponse);
            this.logger.log(`ðŸŽ‰ Socket ${client.id} connection completed successfully for user ${authResult.userId}`);
            // Emit user online status to their contacts
            await this.broadcastUserStatus(authResult.userId, 'online');
        }
        catch (error) {
            this.logger.error(`ðŸ’¥ Connection error for client ${client.id}:`, {
                error: error instanceof Error ? error.message : error,
                stack: error instanceof Error ? error.stack : undefined,
                socketId: client.id,
                origin: client.handshake.headers.origin,
                transport: client.conn.transport.name,
            });
            client.emit('connection_error', {
                message: 'Internal server error during connection',
                code: 'INTERNAL_ERROR',
                timestamp: new Date().toISOString(),
                socketId: client.id,
            });
            client.disconnect(true);
        }
    }
    async handleDisconnect(client) {
        try {
            if (client.userId) {
                await this.cleanupUserConnection(client.userId, client.id);
            }
            // Clean up authentication tracking
            this.webSocketAuth.cleanupConnection(client.id);
        }
        catch (error) {
            this.logger.error(`Error during disconnect cleanup for socket ${client.id}:`, error);
            // Force cleanup even if there are errors
            try {
                if (client.userId) {
                    const userSockets = this.userSockets.get(client.userId);
                    if (userSockets) {
                        userSockets.delete(client.id);
                        if (userSockets.size === 0) {
                            this.userSockets.delete(client.userId);
                        }
                    }
                }
                this.webSocketAuth.cleanupConnection(client.id);
            }
            catch (forceError) {
                this.logger.error(`Force cleanup failed for socket ${client.id}:`, forceError);
            }
        }
    }
    async handleJoinConversation(client, data) {
        // Authentication guard
        if (!this.isAuthenticated(client)) {
            return;
        }
        try {
            const { conversationId } = data;
            const userId = client.userId;
            // Verify user is a participant in this conversation
            const participation = await this.prisma.conversationParticipant.findFirst({
                where: {
                    conversationId,
                    userId,
                    isActive: true,
                },
            });
            if (!participation) {
                client.emit('error', { message: 'Access denied to this conversation' });
                return;
            }
            // Join socket to conversation room
            void client.join(conversationId);
            // Add user to conversation participants tracking
            if (!this.conversationParticipants.has(conversationId)) {
                this.conversationParticipants.set(conversationId, new Set());
            }
            this.conversationParticipants.get(conversationId).add(userId);
            // Notify other participants that user joined
            client.to(conversationId).emit('user_joined_conversation', {
                conversationId,
                userId,
            });
            client.emit('conversation_joined', { conversationId });
            this.logger.log(`User ${userId} joined conversation ${conversationId}`);
        }
        catch (error) {
            this.handleSubscriptionError(client, error, 'join_conversation');
        }
    }
    handleLeaveConversation(client, data) {
        // Authentication guard
        if (!this.isAuthenticated(client)) {
            return;
        }
        try {
            const { conversationId } = data;
            const userId = client.userId;
            void client.leave(conversationId);
            // Remove user from conversation participants tracking
            const participants = this.conversationParticipants.get(conversationId);
            if (participants) {
                participants.delete(userId);
                if (participants.size === 0) {
                    this.conversationParticipants.delete(conversationId);
                }
            }
            // Notify other participants that user left
            client.to(conversationId).emit('user_left_conversation', {
                conversationId,
                userId,
            });
            client.emit('conversation_left', { conversationId });
            this.logger.log(`User ${userId} left conversation ${conversationId}`);
        }
        catch (error) {
            this.handleSubscriptionError(client, error, 'leave_conversation');
        }
    }
    async handleTypingIndicator(client, data) {
        // Authentication guard
        if (!this.isAuthenticated(client)) {
            return;
        }
        try {
            const { conversationId, isTyping = true } = data;
            const userId = client.userId;
            // Update typing indicator in database for persistence
            if (isTyping) {
                await this.prisma.typingIndicator.upsert({
                    where: {
                        conversationId_userId: {
                            conversationId,
                            userId,
                        },
                    },
                    create: {
                        conversationId,
                        userId,
                        lastTypingAt: new Date(),
                    },
                    update: {
                        lastTypingAt: new Date(),
                    },
                });
            }
            else {
                // Remove typing indicator when user stops typing
                await this.prisma.typingIndicator.deleteMany({
                    where: {
                        conversationId,
                        userId,
                    },
                });
            }
            // Broadcast typing indicator to other participants in the conversation
            client.to(conversationId).emit('typing_indicator', {
                conversationId,
                userId,
                isTyping,
            });
        }
        catch (error) {
            this.handleSubscriptionError(client, error, 'typing_indicator');
        }
    }
    // Broadcast new message to conversation participants
    broadcastMessage(conversationId, message) {
        this.server.to(conversationId).emit('new_message', message);
        // Send push notification to offline users (implement as needed)
        this.sendPushNotifications(conversationId, message);
    }
    // Broadcast message update (edit/delete)
    broadcastMessageUpdate(conversationId, messageId, update) {
        this.server.to(conversationId).emit('message_updated', {
            messageId,
            ...update,
        });
    }
    // Broadcast read receipt
    broadcastReadReceipt(conversationId, messageId, userId) {
        this.server.to(conversationId).emit('message_read', {
            messageId,
            userId,
            readAt: new Date(),
        });
    }
    // Broadcast message reaction
    broadcastReaction(conversationId, messageId, reaction) {
        this.server.to(conversationId).emit('message_reaction', {
            messageId,
            reaction,
        });
    }
    // Private helper methods
    // Authentication guard for message handlers
    isAuthenticated(client) {
        if (!client.isAuthenticated || !client.userId) {
            this.logger.warn(`Unauthenticated client ${client.id} attempted to perform action`);
            client.emit('auth_error', {
                message: 'Authentication required for this action',
                code: 'AUTH_REQUIRED',
            });
            return false;
        }
        return true;
    }
    async joinUserConversations(client, userId) {
        try {
            // Get all active conversations for the user
            const conversations = await this.prisma.conversation.findMany({
                where: {
                    participants: {
                        some: {
                            userId,
                            isActive: true,
                        },
                    },
                    isActive: true,
                },
                select: {
                    id: true,
                },
            });
            // Join all conversation rooms
            for (const conversation of conversations) {
                void client.join(conversation.id);
                // Add to tracking
                if (!this.conversationParticipants.has(conversation.id)) {
                    this.conversationParticipants.set(conversation.id, new Set());
                }
                this.conversationParticipants.get(conversation.id).add(userId);
            }
            this.logger.log(`User ${userId} joined ${conversations.length} conversation rooms`);
        }
        catch (error) {
            this.logger.error('Error joining user conversations:', error);
        }
    }
    async broadcastUserStatus(userId, status) {
        // Get all conversations this user participates in
        const conversations = await this.prisma.conversation.findMany({
            where: {
                participants: {
                    some: {
                        userId,
                        isActive: true,
                    },
                },
            },
            select: {
                id: true,
            },
        });
        // Broadcast status to all conversation rooms
        for (const conversation of conversations) {
            this.server.to(conversation.id).emit('user_status_changed', {
                userId,
                status,
                timestamp: new Date(),
            });
        }
    }
    async sendPushNotifications(conversationId, message) {
        try {
            // Get all participants in the conversation except the sender
            const conversation = await this.prisma.conversation.findUnique({
                where: { id: conversationId },
                include: {
                    participants: {
                        include: {
                            user: true,
                        },
                    },
                },
            });
            if (!conversation) {
                this.logger.warn(`Conversation ${conversationId} not found for push notifications`);
                return;
            }
            // Filter participants who should receive push notifications
            const eligibleParticipants = conversation.participants.filter((participant) => {
                // Don't send to message sender
                if (participant.userId === message.senderId) {
                    return false;
                }
                // Use default notification settings since notificationSettings model doesn't exist
                // Default to true for push notifications for new messages
                const defaultPushNewMessages = true;
                if (!defaultPushNewMessages) {
                    return false;
                }
                // Note: No device token filtering available (no DeviceToken model)
                // All participants are considered eligible for alternative notifications
                return true;
            });
            if (eligibleParticipants.length === 0) {
                this.logger.log(`No eligible participants for push notifications in conversation ${conversationId}`);
                return;
            }
            // Prepare notification payload
            const notificationPayload = {
                title: 'New Message',
                body: message.content.length > 50
                    ? `${message.content.substring(0, 50)}...`
                    : message.content,
                icon: '/icon-192x192.png',
                badge: '/badge-72x72.png',
                data: {
                    conversationId: conversationId,
                    messageId: message.id,
                    senderId: message.senderId,
                    url: `/user/messages?conversation=${conversationId}`,
                },
            };
            // Alternative notification approach (no device tokens available)
            const pushPromises = eligibleParticipants.map(async (participant) => {
                try {
                    // Log notification attempt (alternative to push notifications)
                    this.logger.log(`Would send push notification to user ${participant.userId} for message ${message.id} (no DeviceToken model available)`);
                    // Here you could implement WebSocket-based real-time notifications
                    // or other alternative notification methods
                }
                catch (error) {
                    const errorMessage = error instanceof Error ? error.message : 'Unknown error';
                    this.logger.error(`Failed to process notification for user ${participant.userId}: ${errorMessage}`);
                }
            });
            await Promise.allSettled(pushPromises);
            this.logger.log(`Push notification processing completed for conversation ${conversationId}`);
        }
        catch (error) {
            this.logger.error(`Failed to send push notifications for conversation ${conversationId}:`, error);
        }
    }
    // Clean up old typing indicators (call this periodically)
    async cleanupTypingIndicators() {
        const fiveMinutesAgo = new Date(Date.now() - 5 * 60 * 1000);
        await this.prisma.typingIndicator.deleteMany({
            where: {
                lastTypingAt: {
                    lt: fiveMinutesAgo,
                },
            },
        });
    }
    // Personal room subscription methods for real-time notifications
    async subscribeUserToPersonalRoom(client, userId) {
        const userRoom = `user:${userId}`;
        await client.join(userRoom);
        this.logger.debug(`User ${userId} subscribed to personal room: ${userRoom}`);
    }
    async unsubscribeUserFromPersonalRoom(client, userId) {
        const userRoom = `user:${userId}`;
        await client.leave(userRoom);
        this.logger.debug(`User ${userId} unsubscribed from personal room: ${userRoom}`);
    }
    // Community and post room subscriptions for social features
    async handleJoinCommunity(client, data) {
        if (!this.isAuthenticated(client)) {
            return;
        }
        const { communityId } = data;
        const userId = client.userId;
        try {
            // Verify user is a member of this community
            const membership = await this.prisma.membership.findFirst({
                where: {
                    communityId,
                    userId,
                },
            });
            if (!membership) {
                client.emit('error', { message: 'Access denied to this community' });
                return;
            }
            const communityRoom = `community_${communityId}`;
            await client.join(communityRoom);
            client.emit('community_joined', { communityId });
            this.logger.log(`User ${userId} joined community room ${communityId}`);
        }
        catch (error) {
            this.handleSubscriptionError(client, error, 'join_community');
        }
    }
    async handleLeaveCommunity(client, data) {
        if (!this.isAuthenticated(client)) {
            return;
        }
        try {
            const { communityId } = data;
            const userId = client.userId;
            const communityRoom = `community_${communityId}`;
            await client.leave(communityRoom);
            client.emit('community_left', { communityId });
            this.logger.log(`User ${userId} left community room ${communityId}`);
        }
        catch (error) {
            this.handleSubscriptionError(client, error, 'leave_community');
        }
    }
    async handleJoinPost(client, data) {
        if (!this.isAuthenticated(client)) {
            return;
        }
        const { postId } = data;
        const userId = client.userId;
        try {
            // Verify post exists and user has access
            const post = await this.prisma.post.findFirst({
                where: {
                    id: postId,
                    room: {
                        roomGroup: {
                            community: {
                                memberships: {
                                    some: {
                                        userId,
                                    },
                                },
                            },
                        },
                    },
                },
            });
            if (!post) {
                client.emit('error', { message: 'Access denied to this post' });
                return;
            }
            const postRoom = `post_${postId}`;
            await client.join(postRoom);
            client.emit('post_joined', { postId });
            this.logger.log(`User ${userId} joined post room ${postId}`);
        }
        catch (error) {
            this.handleSubscriptionError(client, error, 'join_post');
        }
    }
    async handleLeavePost(client, data) {
        if (!this.isAuthenticated(client)) {
            return;
        }
        try {
            const { postId } = data;
            const userId = client.userId;
            const postRoom = `post_${postId}`;
            await client.leave(postRoom);
            client.emit('post_left', { postId });
            this.logger.log(`User ${userId} left post room ${postId}`);
        }
        catch (error) {
            this.handleSubscriptionError(client, error, 'leave_post');
        }
    }
    // Utility method to get server instance for event broadcasting
    getServer() {
        return this.server;
    }
    // Private helper method for connection limits and deduplication
    async handleConnectionLimits(client, userId) {
        const userSocketSet = this.userSockets.get(userId);
        if (userSocketSet && userSocketSet.size >= this.MAX_CONNECTIONS_PER_USER) {
            this.logger.warn(`User ${userId} exceeded connection limit (${this.MAX_CONNECTIONS_PER_USER})`);
            // Close oldest connections to make room for new one
            const socketsToClose = Array.from(userSocketSet).slice(0, userSocketSet.size - this.MAX_CONNECTIONS_PER_USER + 1);
            for (const socketId of socketsToClose) {
                const socketToClose = this.server.sockets.sockets.get(socketId);
                if (socketToClose) {
                    socketToClose.emit('connection_limit_exceeded', {
                        message: 'Connection closed due to too many concurrent connections',
                        maxConnections: this.MAX_CONNECTIONS_PER_USER,
                    });
                    socketToClose.disconnect(true);
                }
                userSocketSet.delete(socketId);
            }
        }
    }
    // Private helper method for user connection cleanup
    async cleanupUserConnection(userId, socketId) {
        try {
            const userSockets = this.userSockets.get(userId);
            if (userSockets) {
                userSockets.delete(socketId);
                // If no more sockets for this user, remove from tracking
                if (userSockets.size === 0) {
                    this.userSockets.delete(userId);
                    // Clean up conversation participants tracking
                    for (const [conversationId, participants] of this.conversationParticipants.entries()) {
                        participants.delete(userId);
                        // Remove empty conversation sets
                        if (participants.size === 0) {
                            this.conversationParticipants.delete(conversationId);
                        }
                    }
                    // Broadcast user offline status to their contacts
                    await this.broadcastUserStatus(userId, 'offline');
                }
            }
        }
        catch (error) {
            this.logger.error(`Error in cleanupUserConnection for user ${userId}:`, error);
            throw error; // Re-throw to let handleDisconnect handle it
        }
    }
    // Enhanced error handling for message subscriptions
    handleSubscriptionError(client, error, action) {
        this.logger.error(`${action} error for client ${client.id}:`, error);
        // Send structured error response to client
        client.emit('subscription_error', {
            action,
            error: error.message || 'Unknown error',
            code: error.code || 'SUBSCRIPTION_ERROR',
            timestamp: new Date().toISOString(),
        });
        // If it's a critical error, disconnect the client
        if (error.name === 'DatabaseError' || error.code === 'ECONNRESET') {
            this.logger.warn(`Critical error detected, disconnecting client ${client.id}`);
            client.disconnect(true);
        }
    }
};
exports.MessagingGateway = MessagingGateway;
__decorate([
    (0, websockets_1.WebSocketServer)(),
    __metadata("design:type", typeof (_c = typeof socket_io_1.Server !== "undefined" && socket_io_1.Server) === "function" ? _c : Object)
], MessagingGateway.prototype, "server", void 0);
__decorate([
    (0, websockets_1.SubscribeMessage)('join_conversation'),
    __param(0, (0, websockets_1.ConnectedSocket)()),
    __param(1, (0, websockets_1.MessageBody)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Object, Object]),
    __metadata("design:returntype", Promise)
], MessagingGateway.prototype, "handleJoinConversation", null);
__decorate([
    (0, websockets_1.SubscribeMessage)('leave_conversation'),
    __param(0, (0, websockets_1.ConnectedSocket)()),
    __param(1, (0, websockets_1.MessageBody)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Object, Object]),
    __metadata("design:returntype", void 0)
], MessagingGateway.prototype, "handleLeaveConversation", null);
__decorate([
    (0, websockets_1.SubscribeMessage)('typing_indicator'),
    __param(0, (0, websockets_1.ConnectedSocket)()),
    __param(1, (0, websockets_1.MessageBody)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Object, Object]),
    __metadata("design:returntype", Promise)
], MessagingGateway.prototype, "handleTypingIndicator", null);
__decorate([
    (0, websockets_1.SubscribeMessage)('join_community'),
    __param(0, (0, websockets_1.ConnectedSocket)()),
    __param(1, (0, websockets_1.MessageBody)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Object, Object]),
    __metadata("design:returntype", Promise)
], MessagingGateway.prototype, "handleJoinCommunity", null);
__decorate([
    (0, websockets_1.SubscribeMessage)('leave_community'),
    __param(0, (0, websockets_1.ConnectedSocket)()),
    __param(1, (0, websockets_1.MessageBody)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Object, Object]),
    __metadata("design:returntype", Promise)
], MessagingGateway.prototype, "handleLeaveCommunity", null);
__decorate([
    (0, websockets_1.SubscribeMessage)('join_post'),
    __param(0, (0, websockets_1.ConnectedSocket)()),
    __param(1, (0, websockets_1.MessageBody)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Object, Object]),
    __metadata("design:returntype", Promise)
], MessagingGateway.prototype, "handleJoinPost", null);
__decorate([
    (0, websockets_1.SubscribeMessage)('leave_post'),
    __param(0, (0, websockets_1.ConnectedSocket)()),
    __param(1, (0, websockets_1.MessageBody)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Object, Object]),
    __metadata("design:returntype", Promise)
], MessagingGateway.prototype, "handleLeavePost", null);
exports.MessagingGateway = MessagingGateway = MessagingGateway_1 = __decorate([
    (0, websockets_1.WebSocketGateway)({
        cors: {
            origin: [
                process.env.FRONTEND_URL || 'http://localhost:3000',
                'http://localhost:3000', // Explicit fallback
                'http://127.0.0.1:3000', // Alternative localhost
                'https://localhost:3000', // HTTPS fallback (for dev SSL)
            ],
            methods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS'],
            credentials: true,
            allowedHeaders: [
                'authorization',
                'content-type',
                'accept',
                'origin',
                'x-requested-with',
                'access-control-allow-origin',
                'access-control-allow-headers',
                'access-control-allow-methods',
                'access-control-allow-credentials'
            ],
            optionsSuccessStatus: 200,
        },
        namespace: '/messaging',
        transports: ['websocket', 'polling'],
        allowEIO3: true, // Allow Engine.IO v3 clients (compatibility)
    }),
    __metadata("design:paramtypes", [typeof (_a = typeof prisma_client_provider_1.PrismaService !== "undefined" && prisma_client_provider_1.PrismaService) === "function" ? _a : Object, typeof (_b = typeof websocket_auth_service_1.WebSocketAuthService !== "undefined" && websocket_auth_service_1.WebSocketAuthService) === "function" ? _b : Object])
], MessagingGateway);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL21lc3NhZ2luZy9tZXNzYWdpbmcuZ2F0ZXdheS50cyIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLG1EQVE0QjtBQUM1Qix5Q0FBMkM7QUFDM0MsMkNBQXdDO0FBQ3hDLGdGQUFvRTtBQUNwRSw4RUFBeUU7QUF3Q2xFLElBQU0sZ0JBQWdCLHdCQUF0QixNQUFNLGdCQUFnQjtJQWNSO0lBQ0E7SUFYbkIsTUFBTSxDQUFVO0lBRUMsTUFBTSxHQUFHLElBQUksZUFBTSxDQUFDLGtCQUFnQixDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ3BELFdBQVcsR0FBRyxJQUFJLEdBQUcsRUFBdUIsQ0FBQyxDQUFDLDhCQUE4QjtJQUM1RSx3QkFBd0IsR0FBRyxJQUFJLEdBQUcsRUFBdUIsQ0FBQyxDQUFDLG9DQUFvQztJQUV2RyxvQkFBb0I7SUFDSCx3QkFBd0IsR0FBRyxDQUFDLENBQUMsQ0FBQyw2Q0FBNkM7SUFFNUYsWUFDbUIsTUFBcUIsRUFDckIsYUFBbUM7UUFEbkMsV0FBTSxHQUFOLE1BQU0sQ0FBZTtRQUNyQixrQkFBYSxHQUFiLGFBQWEsQ0FBc0I7SUFDbkQsQ0FBQztJQUVKLEtBQUssQ0FBQyxnQkFBZ0IsQ0FBQyxNQUEyQjtRQUNoRCxJQUFJLENBQUM7WUFDSCxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxnQ0FBZ0MsTUFBTSxDQUFDLEVBQUUsU0FBUyxNQUFNLENBQUMsU0FBUyxDQUFDLE9BQU8sRUFBRSxDQUFDLENBQUM7WUFFOUYsdUNBQXVDO1lBQ3ZDLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLDZCQUE2QixNQUFNLENBQUMsRUFBRSxHQUFHLEVBQUU7Z0JBQzNELE1BQU0sRUFBRSxNQUFNLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBQyxNQUFNO2dCQUN2QyxTQUFTLEVBQUUsTUFBTSxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsWUFBWSxD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QUFnQixDQTB3QjVCIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9ob21lL3dldG9vYS9Eb2N1bWVudHMvY29kZS9wcm9qZWN0cy9tZW50YXJhL21lbnRhcmEtYXBpL3NyYy9tZXNzYWdpbmcvbWVzc2FnaW5nLmdhdGV3YXkudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgV2ViU29ja2V0R2F0ZXdheSxcbiAgV2ViU29ja2V0U2VydmVyLFxuICBTdWJzY3JpYmVNZXNzYWdlLFxuICBPbkdhdGV3YXlDb25uZWN0aW9uLFxuICBPbkdhdGV3YXlEaXNjb25uZWN0LFxuICBDb25uZWN0ZWRTb2NrZXQsXG4gIE1lc3NhZ2VCb2R5LFxufSBmcm9tICdAbmVzdGpzL3dlYnNvY2tldHMnO1xuaW1wb3J0IHsgU2VydmVyLCBTb2NrZXQgfSBmcm9tICdzb2NrZXQuaW8nO1xuaW1wb3J0IHsgTG9nZ2VyIH0gZnJvbSAnQG5lc3Rqcy9jb21tb24nO1xuaW1wb3J0IHsgUHJpc21hU2VydmljZSB9IGZyb20gJy4uL3Byb3ZpZGVycy9wcmlzbWEtY2xpZW50LnByb3ZpZGVyJztcbmltcG9ydCB7IFdlYlNvY2tldEF1dGhTZXJ2aWNlIH0gZnJvbSAnLi9zZXJ2aWNlcy93ZWJzb2NrZXQtYXV0aC5zZXJ2aWNlJztcbmltcG9ydCB0eXBlIHtcbiAgSm9pbkNvbnZlcnNhdGlvbkR0byxcbiAgTGVhdmVDb252ZXJzYXRpb25EdG8sXG4gIFR5cGluZ0luZGljYXRvckR0byxcbn0gZnJvbSAnLi90eXBlcyc7XG5cbmludGVyZmFjZSBBdXRoZW50aWNhdGVkU29ja2V0IGV4dGVuZHMgU29ja2V0IHtcbiAgdXNlcklkPzogc3RyaW5nO1xuICB1c2VyUm9sZT86IHN0cmluZztcbiAgaXNBdXRoZW50aWNhdGVkPzogYm9vbGVhbjtcbn1cblxuQFdlYlNvY2tldEdhdGV3YXkoe1xuICBjb3JzOiB7XG4gICAgb3JpZ2luOiBbXG4gICAgICBwcm9jZXNzLmVudi5GUk9OVEVORF9VUkwgfHwgJ2h0dHA6Ly9sb2NhbGhvc3Q6MzAwMCcsXG4gICAgICAnaHR0cDovL2xvY2FsaG9zdDozMDAwJywgIC8vIEV4cGxpY2l0IGZhbGxiYWNrXG4gICAgICAnaHR0cDovLzEyNy4wLjAuMTozMDAwJywgIC8vIEFsdGVybmF0aXZlIGxvY2FsaG9zdFxuICAgICAgJ2h0dHBzOi8vbG9jYWxob3N0OjMwMDAnLCAvLyBIVFRQUyBmYWxsYmFjayAoZm9yIGRldiBTU0wpXG4gICAgXSxcbiAgICBtZXRob2RzOiBbJ0dFVCcsICdQT1NUJywgJ1BVVCcsICdERUxFVEUnLCAnT1BUSU9OUyddLFxuICAgIGNyZWRlbnRpYWxzOiB0cnVlLFxuICAgIGFsbG93ZWRIZWFkZXJzOiBbXG4gICAgICAnYXV0aG9yaXphdGlvbicsIFxuICAgICAgJ2NvbnRlbnQtdHlwZScsIFxuICAgICAgJ2FjY2VwdCcsXG4gICAgICAnb3JpZ2luJyxcbiAgICAgICd4LXJlcXVlc3RlZC13aXRoJyxcbiAgICAgICdhY2Nlc3MtY29udHJvbC1hbGxvdy1vcmlnaW4nLFxuICAgICAgJ2FjY2Vzcy1jb250cm9sLWFsbG93LWhlYWRlcnMnLFxuICAgICAgJ2FjY2Vzcy1jb250cm9sLWFsbG93LW1ldGhvZHMnLFxuICAgICAgJ2FjY2Vzcy1jb250cm9sLWFsbG93LWNyZWRlbnRpYWxzJ1xuICAgIF0sXG4gICAgb3B0aW9uc1N1Y2Nlc3NTdGF0dXM6IDIwMCxcbiAgfSxcbiAgbmFtZXNwYWNlOiAnL21lc3NhZ2luZycsXG4gIHRyYW5zcG9ydHM6IFsnd2Vic29ja2V0JywgJ3BvbGxpbmcnXSxcbiAgYWxsb3dFSU8zOiB0cnVlLCAvLyBBbGxvdyBFbmdpbmUuSU8gdjMgY2xpZW50cyAoY29tcGF0aWJpbGl0eSlcbn0pXG5leHBvcnQgY2xhc3MgTWVzc2FnaW5nR2F0ZXdheVxuICBpbXBsZW1lbnRzIE9uR2F0ZXdheUNvbm5lY3Rpb24sIE9uR2F0ZXdheURpc2Nvbm5lY3RcbntcbiAgQFdlYlNvY2tldFNlcnZlcigpXG4gIHNlcnZlciE6IFNlcnZlcjtcblxuICBwcml2YXRlIHJlYWRvbmx5IGxvZ2dlciA9IG5ldyBMb2dnZXIoTWVzc2FnaW5nR2F0ZXdheS5uYW1lKTtcbiAgcHJpdmF0ZSB1c2VyU29ja2V0cyA9IG5ldyBNYXA8c3RyaW5nLCBTZXQ8c3RyaW5nPj4oKTsgLy8gdXNlcklkIC0+IFNldCBvZiBzb2NrZXQgSURzXG4gIHByaXZhdGUgY29udmVyc2F0aW9uUGFydGljaXBhbnRzID0gbmV3IE1hcDxzdHJpbmcsIFNldDxzdHJpbmc+PigpOyAvLyBjb252ZXJzYXRpb25JZCAtPiBTZXQgb2YgdXNlciBJRHNcbiAgXG4gIC8vIENvbm5lY3Rpb24gbGltaXRzXG4gIHByaXZhdGUgcmVhZG9ubHkgTUFYX0NPTk5FQ1RJT05TX1BFUl9VU0VSID0gMzsgLy8gTGltaXQgdG8gMyBjb25jdXJyZW50IGNvbm5lY3Rpb25zIHBlciB1c2VyXG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSByZWFkb25seSBwcmlzbWE6IFByaXNtYVNlcnZpY2UsXG4gICAgcHJpdmF0ZSByZWFkb25seSB3ZWJTb2NrZXRBdXRoOiBXZWJTb2NrZXRBdXRoU2VydmljZSxcbiAgKSB7fVxuXG4gIGFzeW5jIGhhbmRsZUNvbm5lY3Rpb24oY2xpZW50OiBBdXRoZW50aWNhdGVkU29ja2V0KSB7XG4gICAgdHJ5IHtcbiAgICAgIHRoaXMubG9nZ2VyLmxvZyhg8J+UlyBOZXcgV2ViU29ja2V0IGNvbm5lY3Rpb246ICR7Y2xpZW50LmlkfSBmcm9tICR7Y2xpZW50LmhhbmRzaGFrZS5hZGRyZXNzfWApO1xuICAgICAgXG4gICAgICAvLyBMb2cgY29ubmVjdGlvbiBkZXRhaWxzIGZvciBkZWJ1Z2dpbmdcbiAgICAgIHRoaXMubG9nZ2VyLmRlYnVnKGDwn5SNIENvbm5lY3Rpb24gZGV0YWlscyBmb3IgJHtjbGllbnQuaWR9OmAsIHtcbiAgICAgICAgb3JpZ2luOiBjbGllbnQuaGFuZHNoYWtlLmhlYWRlcnMub3JpZ2luLFxuICAgICAgICB1c2VyQWdlbnQ6IGNsaWVudC5oYW5kc2hha2UuaGVhZGVyc1sndXNlci1hZ2VudCddLFxuICAgICAgICB0cmFuc3BvcnQ6IGNsaWVudC5jb25uLnRyYW5zcG9ydC5uYW1lLFxuICAgICAgICBwcm90b2NvbDogY2xpZW50LmNvbm4ucHJvdG9jb2wsXG4gICAgICAgIGhhc0F1dGg6ICEhY2xpZW50LmhhbmRzaGFrZS5hdXRoPy50b2tlbixcbiAgICAgICAgaGFzQXV0aEhlYWRlcjogISFjbGllbnQuaGFuZHNoYWtlLmhlYWRlcnMuYXV0aG9yaXphdGlvbixcbiAgICAgICAgcXVlcnk6IGNsaWVudC5oYW5kc2hha2UucXVlcnksXG4gICAgICB9KTtcblxuICAgICAgLy8gQXV0aGVudGljYXRlIHRoZSBzb2NrZXQgY29ubmVjdGlvbiB1c2luZyB0aGUgbmV3IGF1dGggc2VydmljZVxuICAgICAgY29uc3QgYXV0aFJlc3VsdCA9IGF3YWl0IHRoaXMud2ViU29ja2V0QXV0aC5hdXRoZW50aWNhdGVTb2NrZXQoY2xpZW50KTtcblxuICAgICAgaWYgKCFhdXRoUmVzdWx0KSB7XG4gICAgICAgIHRoaXMubG9nZ2VyLndhcm4oYOKdjCBBdXRoZW50aWNhdGlvbiBmYWlsZWQgZm9yIGNsaWVudCAke2NsaWVudC5pZH1gKTtcbiAgICAgICAgXG4gICAgICAgIC8vIFByb3ZpZGUgbW9yZSBkZXRhaWxlZCBlcnJvciBpbmZvcm1hdGlvblxuICAgICAgICBjb25zdCBlcnJvckRldGFpbHMgPSB7XG4gICAgICAgICAgbWVzc2FnZTogJ0F1dGhlbnRpY2F0aW9uIGZhaWxlZC4gUGxlYXNlIHNpZ24gaW4gYWdhaW4uJyxcbiAgICAgICAgICBjb2RlOiAnQVVUSF9GQUlMRUQnLFxuICAgICAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLFxuICAgICAgICAgIGRlYnVnOiB7XG4gICAgICAgICAgICBzb2NrZXRJZDogY2xpZW50LmlkLFxuICAgICAgICAgICAgaGFzVG9rZW46ICEhY2xpZW50LmhhbmRzaGFrZS5hdXRoPy50b2tlbixcbiAgICAgICAgICAgIGhhc0F1dGhIZWFkZXI6ICEhY2xpZW50LmhhbmRzaGFrZS5oZWFkZXJzLmF1dGhvcml6YXRpb24sXG4gICAgICAgICAgICBvcmlnaW46IGNsaWVudC5oYW5kc2hha2UuaGVhZGVycy5vcmlnaW4sXG4gICAgICAgICAgfVxuICAgICAgICB9O1xuICAgICAgICBcbiAgICAgICAgY2xpZW50LmVtaXQoJ2F1dGhfZXJyb3InLCBlcnJvckRldGFpbHMpO1xuICAgICAgICB0aGlzLmxvZ2dlci5kZWJ1Zyhg8J+UjSBBdXRoIGVycm9yIGRldGFpbHMgc2VudCB0byBjbGllbnQgJHtjbGllbnQuaWR9OmAsIGVycm9yRGV0YWlscyk7XG4gICAgICAgIGNsaWVudC5kaXNjb25uZWN0KHRydWUpO1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG5cbiAgICAgIHRoaXMubG9nZ2VyLmxvZyhg4pyFIFNvY2tldCAke2NsaWVudC5pZH0gYXV0aGVudGljYXRlZCBhcyB1c2VyICR7YXV0aFJlc3VsdC51c2VySWR9ICgke2F1dGhSZXN1bHQucm9sZX0pYCk7XG5cbiAgICAgIC8vIEF0dGFjaCBhdXRoZW50aWNhdGVkIHVzZXIgaW5mbyB0byBzb2NrZXRcbiAgICAgIGNsaWVudC51c2VySWQgPSBhdXRoUmVzdWx0LnVzZXJJZDtcbiAgICAgIGNsaWVudC51c2VyUm9sZSA9IGF1dGhSZXN1bHQucm9sZTtcbiAgICAgIGNsaWVudC5pc0F1dGhlbnRpY2F0ZWQgPSB0cnVlO1xuXG4gICAgICAvLyBWZXJpZnkgdXNlciBleGlzdHMgaW4gZGF0YWJhc2UgYW5kIGlzIGFjdGl2ZVxuICAgICAgY29uc3QgdXNlciA9IGF3YWl0IHRoaXMucHJpc21hLnVzZXIuZmluZFVuaXF1ZSh7XG4gICAgICAgIHdoZXJlOiB7XG4gICAgICAgICAgaWQ6IGF1dGhSZXN1bHQudXNlcklkLFxuICAgICAgICAgIGlzQWN0aXZlOiB0cnVlLCAvLyBPbmx5IGFsbG93IGFjdGl2ZSB1c2Vyc1xuICAgICAgICB9LFxuICAgICAgICBzZWxlY3Q6IHsgaWQ6IHRydWUsIHJvbGU6IHRydWUsIGlzQWN0aXZlOiB0cnVlLCBlbWFpbDogdHJ1ZSB9LFxuICAgICAgfSk7XG5cbiAgICAgIGlmICghdXNlcikge1xuICAgICAgICB0aGlzLmxvZ2dlci53YXJuKGDinYwgVXNlciAke2F1dGhSZXN1bHQudXNlcklkfSBub3QgZm91bmQgb3IgaW5hY3RpdmUgaW4gZGF0YWJhc2VgKTtcbiAgICAgICAgY2xpZW50LmVtaXQoJ2F1dGhfZXJyb3InLCB7XG4gICAgICAgICAgbWVzc2FnZTogJ1VzZXIgYWNjb3VudCBub3QgZm91bmQgb3IgaW5hY3RpdmUnLFxuICAgICAgICAgIGNvZGU6ICdVU0VSX05PVF9GT1VORCcsXG4gICAgICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksXG4gICAgICAgIH0pO1xuICAgICAgICBjbGllbnQuZGlzY29ubmVjdCh0cnVlKTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuXG4gICAgICB0aGlzLmxvZ2dlci5sb2coYPCfkaQgVXNlciAke3VzZXIuaWR9ICgke3VzZXIuZW1haWx9KSB2ZXJpZmllZCBpbiBkYXRhYmFzZWApO1xuXG4gICAgICAvLyBIYW5kbGUgY29ubmVjdGlvbiBsaW1pdHMgYW5kIGRlZHVwbGljYXRpb25cbiAgICAgIGF3YWl0IHRoaXMuaGFuZGxlQ29ubmVjdGlvbkxpbWl0cyhjbGllbnQsIGF1dGhSZXN1bHQudXNlcklkKTtcblxuICAgICAgLy8gQWRkIHNvY2tldCB0byB1c2VyJ3Mgc29ja2V0IHNldFxuICAgICAgaWYgKCF0aGlzLnVzZXJTb2NrZXRzLmhhcyhhdXRoUmVzdWx0LnVzZXJJZCkpIHtcbiAgICAgICAgdGhpcy51c2VyU29ja2V0cy5zZXQoYXV0aFJlc3VsdC51c2VySWQsIG5ldyBTZXQoKSk7XG4gICAgICB9XG4gICAgICB0aGlzLnVzZXJTb2NrZXRzLmdldChhdXRoUmVzdWx0LnVzZXJJZCkhLmFkZChjbGllbnQuaWQpO1xuXG4gICAgICAvLyBKb2luIHVzZXIgdG8gdGhlaXIgY29udmVyc2F0aW9uIHJvb21zXG4gICAgICBhd2FpdCB0aGlzLmpvaW5Vc2VyQ29udmVyc2F0aW9ucyhjbGllbnQsIGF1dGhSZXN1bHQudXNlcklkKTtcblxuICAgICAgLy8gU3Vic2NyaWJlIHVzZXIgdG8gdGhlaXIgcGVyc29uYWwgbm90aWZpY2F0aW9uIHJvb21cbiAgICAgIGF3YWl0IHRoaXMuc3Vic2NyaWJlVXNlclRvUGVyc29uYWxSb29tKGNsaWVudCwgYXV0aFJlc3VsdC51c2VySWQpO1xuXG4gICAgICAvLyBOb3RpZnkgc3VjY2Vzc2Z1bCBjb25uZWN0aW9uXG4gICAgICBjb25zdCBzdWNjZXNzUmVzcG9uc2UgPSB7XG4gICAgICAgIHVzZXJJZDogYXV0aFJlc3VsdC51c2VySWQsXG4gICAgICAgIHJvbGU6IHVzZXIucm9sZSxcbiAgICAgICAgbWVzc2FnZTogJ1N1Y2Nlc3NmdWxseSBhdXRoZW50aWNhdGVkIGFuZCBjb25uZWN0ZWQnLFxuICAgICAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSxcbiAgICAgICAgY29ubmVjdGlvbkluZm86IHtcbiAgICAgICAgICBzb2NrZXRJZDogY2xpZW50LmlkLFxuICAgICAgICAgIHRyYW5zcG9ydDogY2xpZW50LmNvbm4udHJhbnNwb3J0Lm5hbWUsXG4gICAgICAgICAgdG90YWxDb25uZWN0aW9uczogdGhpcy51c2VyU29ja2V0cy5nZXQoYXV0aFJlc3VsdC51c2VySWQpPy5zaXplIHx8IDEsXG4gICAgICAgIH1cbiAgICAgIH07XG4gICAgICBcbiAgICAgIGNsaWVudC5lbWl0KCdhdXRoZW50aWNhdGVkJywgc3VjY2Vzc1Jlc3BvbnNlKTtcbiAgICAgIHRoaXMubG9nZ2VyLmxvZyhg8J+OiSBTb2NrZXQgJHtjbGllbnQuaWR9IGNvbm5lY3Rpb24gY29tcGxldGVkIHN1Y2Nlc3NmdWxseSBmb3IgdXNlciAke2F1dGhSZXN1bHQudXNlcklkfWApO1xuXG4gICAgICAvLyBFbWl0IHVzZXIgb25saW5lIHN0YXR1cyB0byB0aGVpciBjb250YWN0c1xuICAgICAgYXdhaXQgdGhpcy5icm9hZGNhc3RVc2VyU3RhdHVzKGF1dGhSZXN1bHQudXNlcklkLCAnb25saW5lJyk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRoaXMubG9nZ2VyLmVycm9yKGDwn5KlIENvbm5lY3Rpb24gZXJyb3IgZm9yIGNsaWVudCAke2NsaWVudC5pZH06YCwge1xuICAgICAgICBlcnJvcjogZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiBlcnJvcixcbiAgICAgICAgc3RhY2s6IGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5zdGFjayA6IHVuZGVmaW5lZCxcbiAgICAgICAgc29ja2V0SWQ6IGNsaWVudC5pZCxcbiAgICAgICAgb3JpZ2luOiBjbGllbnQuaGFuZHNoYWtlLmhlYWRlcnMub3JpZ2luLFxuICAgICAgICB0cmFuc3BvcnQ6IGNsaWVudC5jb25uLnRyYW5zcG9ydC5uYW1lLFxuICAgICAgfSk7XG4gICAgICBcbiAgICAgIGNsaWVudC5lbWl0KCdjb25uZWN0aW9uX2Vycm9yJywge1xuICAgICAgICBtZXNzYWdlOiAnSW50ZXJuYWwgc2VydmVyIGVycm9yIGR1cmluZyBjb25uZWN0aW9uJyxcbiAgICAgICAgY29kZTogJ0lOVEVSTkFMX0VSUk9SJyxcbiAgICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksXG4gICAgICAgIHNvY2tldElkOiBjbGllbnQuaWQsXG4gICAgICB9KTtcbiAgICAgIGNsaWVudC5kaXNjb25uZWN0KHRydWUpO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGhhbmRsZURpc2Nvbm5lY3QoY2xpZW50OiBBdXRoZW50aWNhdGVkU29ja2V0KSB7XG4gICAgdHJ5IHtcbiAgICAgIGlmIChjbGllbnQudXNlcklkKSB7XG4gICAgICAgIGF3YWl0IHRoaXMuY2xlYW51cFVzZXJDb25uZWN0aW9uKGNsaWVudC51c2VySWQsIGNsaWVudC5pZCk7XG4gICAgICB9XG5cbiAgICAgIC8vIENsZWFuIHVwIGF1dGhlbnRpY2F0aW9uIHRyYWNraW5nXG4gICAgICB0aGlzLndlYlNvY2tldEF1dGguY2xlYW51cENvbm5lY3Rpb24oY2xpZW50LmlkKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoYEVycm9yIGR1cmluZyBkaXNjb25uZWN0IGNsZWFudXAgZm9yIHNvY2tldCAke2NsaWVudC5pZH06YCwgZXJyb3IpO1xuICAgICAgXG4gICAgICAvLyBGb3JjZSBjbGVhbnVwIGV2ZW4gaWYgdGhlcmUgYXJlIGVycm9yc1xuICAgICAgdHJ5IHtcbiAgICAgICAgaWYgKGNsaWVudC51c2VySWQpIHtcbiAgICAgICAgICBjb25zdCB1c2VyU29ja2V0cyA9IHRoaXMudXNlclNvY2tldHMuZ2V0KGNsaWVudC51c2VySWQpO1xuICAgICAgICAgIGlmICh1c2VyU29ja2V0cykge1xuICAgICAgICAgICAgdXNlclNvY2tldHMuZGVsZXRlKGNsaWVudC5pZCk7XG4gICAgICAgICAgICBpZiAodXNlclNvY2tldHMuc2l6ZSA9PT0gMCkge1xuICAgICAgICAgICAgICB0aGlzLnVzZXJTb2NrZXRzLmRlbGV0ZShjbGllbnQudXNlcklkKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy53ZWJTb2NrZXRBdXRoLmNsZWFudXBDb25uZWN0aW9uKGNsaWVudC5pZCk7XG4gICAgICB9IGNhdGNoIChmb3JjZUVycm9yKSB7XG4gICAgICAgIHRoaXMubG9nZ2VyLmVycm9yKGBGb3JjZSBjbGVhbnVwIGZhaWxlZCBmb3Igc29ja2V0ICR7Y2xpZW50LmlkfTpgLCBmb3JjZUVycm9yKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBAU3Vic2NyaWJlTWVzc2FnZSgnam9pbl9jb252ZXJzYXRpb24nKVxuICBhc3luYyBoYW5kbGVKb2luQ29udmVyc2F0aW9uKFxuICAgIEBDb25uZWN0ZWRTb2NrZXQoKSBjbGllbnQ6IEF1dGhlbnRpY2F0ZWRTb2NrZXQsXG4gICAgQE1lc3NhZ2VCb2R5KCkgZGF0YTogSm9pbkNvbnZlcnNhdGlvbkR0byxcbiAgKSB7XG4gICAgLy8gQXV0aGVudGljYXRpb24gZ3VhcmRcbiAgICBpZiAoIXRoaXMuaXNBdXRoZW50aWNhdGVkKGNsaWVudCkpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICB0cnkge1xuICAgICAgY29uc3QgeyBjb252ZXJzYXRpb25JZCB9ID0gZGF0YTtcbiAgICAgIGNvbnN0IHVzZXJJZCA9IGNsaWVudC51c2VySWQhO1xuXG4gICAgICAvLyBWZXJpZnkgdXNlciBpcyBhIHBhcnRpY2lwYW50IGluIHRoaXMgY29udmVyc2F0aW9uXG4gICAgICBjb25zdCBwYXJ0aWNpcGF0aW9uID0gYXdhaXQgdGhpcy5wcmlzbWEuY29udmVyc2F0aW9uUGFydGljaXBhbnQuZmluZEZpcnN0KFxuICAgICAgICB7XG4gICAgICAgICAgd2hlcmU6IHtcbiAgICAgICAgICAgIGNvbnZlcnNhdGlvbklkLFxuICAgICAgICAgICAgdXNlcklkLFxuICAgICAgICAgICAgaXNBY3RpdmU6IHRydWUsXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgICk7XG5cbiAgICAgIGlmICghcGFydGljaXBhdGlvbikge1xuICAgICAgICBjbGllbnQuZW1pdCgnZXJyb3InLCB7IG1lc3NhZ2U6ICdBY2Nlc3MgZGVuaWVkIHRvIHRoaXMgY29udmVyc2F0aW9uJyB9KTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuXG4gICAgICAvLyBKb2luIHNvY2tldCB0byBjb252ZXJzYXRpb24gcm9vbVxuICAgICAgdm9pZCBjbGllbnQuam9pbihjb252ZXJzYXRpb25JZCk7XG5cbiAgICAgIC8vIEFkZCB1c2VyIHRvIGNvbnZlcnNhdGlvbiBwYXJ0aWNpcGFudHMgdHJhY2tpbmdcbiAgICAgIGlmICghdGhpcy5jb252ZXJzYXRpb25QYXJ0aWNpcGFudHMuaGFzKGNvbnZlcnNhdGlvbklkKSkge1xuICAgICAgICB0aGlzLmNvbnZlcnNhdGlvblBhcnRpY2lwYW50cy5zZXQoY29udmVyc2F0aW9uSWQsIG5ldyBTZXQoKSk7XG4gICAgICB9XG4gICAgICB0aGlzLmNvbnZlcnNhdGlvblBhcnRpY2lwYW50cy5nZXQoY29udmVyc2F0aW9uSWQpIS5hZGQodXNlcklkKTtcblxuICAgICAgLy8gTm90aWZ5IG90aGVyIHBhcnRpY2lwYW50cyB0aGF0IHVzZXIgam9pbmVkXG4gICAgICBjbGllbnQudG8oY29udmVyc2F0aW9uSWQpLmVtaXQoJ3VzZXJfam9pbmVkX2NvbnZlcnNhdGlvbicsIHtcbiAgICAgICAgY29udmVyc2F0aW9uSWQsXG4gICAgICAgIHVzZXJJZCxcbiAgICAgIH0pO1xuXG4gICAgICBjbGllbnQuZW1pdCgnY29udmVyc2F0aW9uX2pvaW5lZCcsIHsgY29udmVyc2F0aW9uSWQgfSk7XG4gICAgICB0aGlzLmxvZ2dlci5sb2coYFVzZXIgJHt1c2VySWR9IGpvaW5lZCBjb252ZXJzYXRpb24gJHtjb252ZXJzYXRpb25JZH1gKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhpcy5oYW5kbGVTdWJzY3JpcHRpb25FcnJvcihjbGllbnQsIGVycm9yLCAnam9pbl9jb252ZXJzYXRpb24nKTtcbiAgICB9XG4gIH1cblxuICBAU3Vic2NyaWJlTWVzc2FnZSgnbGVhdmVfY29udmVyc2F0aW9uJylcbiAgaGFuZGxlTGVhdmVDb252ZXJzYXRpb24oXG4gICAgQENvbm5lY3RlZFNvY2tldCgpIGNsaWVudDogQXV0aGVudGljYXRlZFNvY2tldCxcbiAgICBATWVzc2FnZUJvZHkoKSBkYXRhOiBMZWF2ZUNvbnZlcnNhdGlvbkR0byxcbiAgKSB7XG4gICAgLy8gQXV0aGVudGljYXRpb24gZ3VhcmRcbiAgICBpZiAoIXRoaXMuaXNBdXRoZW50aWNhdGVkKGNsaWVudCkpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICB0cnkge1xuICAgICAgY29uc3QgeyBjb252ZXJzYXRpb25JZCB9ID0gZGF0YTtcbiAgICAgIGNvbnN0IHVzZXJJZCA9IGNsaWVudC51c2VySWQhO1xuXG4gICAgICB2b2lkIGNsaWVudC5sZWF2ZShjb252ZXJzYXRpb25JZCk7XG5cbiAgICAgIC8vIFJlbW92ZSB1c2VyIGZyb20gY29udmVyc2F0aW9uIHBhcnRpY2lwYW50cyB0cmFja2luZ1xuICAgICAgY29uc3QgcGFydGljaXBhbnRzID0gdGhpcy5jb252ZXJzYXRpb25QYXJ0aWNpcGFudHMuZ2V0KGNvbnZlcnNhdGlvbklkKTtcbiAgICAgIGlmIChwYXJ0aWNpcGFudHMpIHtcbiAgICAgICAgcGFydGljaXBhbnRzLmRlbGV0ZSh1c2VySWQpO1xuICAgICAgICBpZiAocGFydGljaXBhbnRzLnNpemUgPT09IDApIHtcbiAgICAgICAgICB0aGlzLmNvbnZlcnNhdGlvblBhcnRpY2lwYW50cy5kZWxldGUoY29udmVyc2F0aW9uSWQpO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIC8vIE5vdGlmeSBvdGhlciBwYXJ0aWNpcGFudHMgdGhhdCB1c2VyIGxlZnRcbiAgICAgIGNsaWVudC50byhjb252ZXJzYXRpb25JZCkuZW1pdCgndXNlcl9sZWZ0X2NvbnZlcnNhdGlvbicsIHtcbiAgICAgICAgY29udmVyc2F0aW9uSWQsXG4gICAgICAgIHVzZXJJZCxcbiAgICAgIH0pO1xuXG4gICAgICBjbGllbnQuZW1pdCgnY29udmVyc2F0aW9uX2xlZnQnLCB7IGNvbnZlcnNhdGlvbklkIH0pO1xuICAgICAgdGhpcy5sb2dnZXIubG9nKGBVc2VyICR7dXNlcklkfSBsZWZ0IGNvbnZlcnNhdGlvbiAke2NvbnZlcnNhdGlvbklkfWApO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aGlzLmhhbmRsZVN1YnNjcmlwdGlvbkVycm9yKGNsaWVudCwgZXJyb3IsICdsZWF2ZV9jb252ZXJzYXRpb24nKTtcbiAgICB9XG4gIH1cblxuICBAU3Vic2NyaWJlTWVzc2FnZSgndHlwaW5nX2luZGljYXRvcicpXG4gIGFzeW5jIGhhbmRsZVR5cGluZ0luZGljYXRvcihcbiAgICBAQ29ubmVjdGVkU29ja2V0KCkgY2xpZW50OiBBdXRoZW50aWNhdGVkU29ja2V0LFxuICAgIEBNZXNzYWdlQm9keSgpIGRhdGE6IFR5cGluZ0luZGljYXRvckR0byxcbiAgKSB7XG4gICAgLy8gQXV0aGVudGljYXRpb24gZ3VhcmRcbiAgICBpZiAoIXRoaXMuaXNBdXRoZW50aWNhdGVkKGNsaWVudCkpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICB0cnkge1xuICAgICAgY29uc3QgeyBjb252ZXJzYXRpb25JZCwgaXNUeXBpbmcgPSB0cnVlIH0gPSBkYXRhO1xuICAgICAgY29uc3QgdXNlcklkID0gY2xpZW50LnVzZXJJZCE7XG5cbiAgICAgIC8vIFVwZGF0ZSB0eXBpbmcgaW5kaWNhdG9yIGluIGRhdGFiYXNlIGZvciBwZXJzaXN0ZW5jZVxuICAgICAgaWYgKGlzVHlwaW5nKSB7XG4gICAgICAgIGF3YWl0IHRoaXMucHJpc21hLnR5cGluZ0luZGljYXRvci51cHNlcnQoe1xuICAgICAgICAgIHdoZXJlOiB7XG4gICAgICAgICAgICBjb252ZXJzYXRpb25JZF91c2VySWQ6IHtcbiAgICAgICAgICAgICAgY29udmVyc2F0aW9uSWQsXG4gICAgICAgICAgICAgIHVzZXJJZCxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgICBjcmVhdGU6IHtcbiAgICAgICAgICAgIGNvbnZlcnNhdGlvbklkLFxuICAgICAgICAgICAgdXNlcklkLFxuICAgICAgICAgICAgbGFzdFR5cGluZ0F0OiBuZXcgRGF0ZSgpLFxuICAgICAgICAgIH0sXG4gICAgICAgICAgdXBkYXRlOiB7XG4gICAgICAgICAgICBsYXN0VHlwaW5nQXQ6IG5ldyBEYXRlKCksXG4gICAgICAgICAgfSxcbiAgICAgICAgfSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICAvLyBSZW1vdmUgdHlwaW5nIGluZGljYXRvciB3aGVuIHVzZXIgc3RvcHMgdHlwaW5nXG4gICAgICAgIGF3YWl0IHRoaXMucHJpc21hLnR5cGluZ0luZGljYXRvci5kZWxldGVNYW55KHtcbiAgICAgICAgICB3aGVyZToge1xuICAgICAgICAgICAgY29udmVyc2F0aW9uSWQsXG4gICAgICAgICAgICB1c2VySWQsXG4gICAgICAgICAgfSxcbiAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIC8vIEJyb2FkY2FzdCB0eXBpbmcgaW5kaWNhdG9yIHRvIG90aGVyIHBhcnRpY2lwYW50cyBpbiB0aGUgY29udmVyc2F0aW9uXG4gICAgICBjbGllbnQudG8oY29udmVyc2F0aW9uSWQpLmVtaXQoJ3R5cGluZ19pbmRpY2F0b3InLCB7XG4gICAgICAgIGNvbnZlcnNhdGlvbklkLFxuICAgICAgICB1c2VySWQsXG4gICAgICAgIGlzVHlwaW5nLFxuICAgICAgfSk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRoaXMuaGFuZGxlU3Vic2NyaXB0aW9uRXJyb3IoY2xpZW50LCBlcnJvciwgJ3R5cGluZ19pbmRpY2F0b3InKTtcbiAgICB9XG4gIH1cblxuICAvLyBCcm9hZGNhc3QgbmV3IG1lc3NhZ2UgdG8gY29udmVyc2F0aW9uIHBhcnRpY2lwYW50c1xuICBicm9hZGNhc3RNZXNzYWdlKGNvbnZlcnNhdGlvbklkOiBzdHJpbmcsIG1lc3NhZ2U6IGFueSkge1xuICAgIHRoaXMuc2VydmVyLnRvKGNvbnZlcnNhdGlvbklkKS5lbWl0KCduZXdfbWVzc2FnZScsIG1lc3NhZ2UpO1xuXG4gICAgLy8gU2VuZCBwdXNoIG5vdGlmaWNhdGlvbiB0byBvZmZsaW5lIHVzZXJzIChpbXBsZW1lbnQgYXMgbmVlZGVkKVxuICAgIHRoaXMuc2VuZFB1c2hOb3RpZmljYXRpb25zKGNvbnZlcnNhdGlvbklkLCBtZXNzYWdlKTtcbiAgfVxuXG4gIC8vIEJyb2FkY2FzdCBtZXNzYWdlIHVwZGF0ZSAoZWRpdC9kZWxldGUpXG4gIGJyb2FkY2FzdE1lc3NhZ2VVcGRhdGUoXG4gICAgY29udmVyc2F0aW9uSWQ6IHN0cmluZyxcbiAgICBtZXNzYWdlSWQ6IHN0cmluZyxcbiAgICB1cGRhdGU6IGFueSxcbiAgKSB7XG4gICAgdGhpcy5zZXJ2ZXIudG8oY29udmVyc2F0aW9uSWQpLmVtaXQoJ21lc3NhZ2VfdXBkYXRlZCcsIHtcbiAgICAgIG1lc3NhZ2VJZCxcbiAgICAgIC4uLnVwZGF0ZSxcbiAgICB9KTtcbiAgfVxuXG4gIC8vIEJyb2FkY2FzdCByZWFkIHJlY2VpcHRcbiAgYnJvYWRjYXN0UmVhZFJlY2VpcHQoXG4gICAgY29udmVyc2F0aW9uSWQ6IHN0cmluZyxcbiAgICBtZXNzYWdlSWQ6IHN0cmluZyxcbiAgICB1c2VySWQ6IHN0cmluZyxcbiAgKSB7XG4gICAgdGhpcy5zZXJ2ZXIudG8oY29udmVyc2F0aW9uSWQpLmVtaXQoJ21lc3NhZ2VfcmVhZCcsIHtcbiAgICAgIG1lc3NhZ2VJZCxcbiAgICAgIHVzZXJJZCxcbiAgICAgIHJlYWRBdDogbmV3IERhdGUoKSxcbiAgICB9KTtcbiAgfVxuXG4gIC8vIEJyb2FkY2FzdCBtZXNzYWdlIHJlYWN0aW9uXG4gIGJyb2FkY2FzdFJlYWN0aW9uKGNvbnZlcnNhdGlvbklkOiBzdHJpbmcsIG1lc3NhZ2VJZDogc3RyaW5nLCByZWFjdGlvbjogYW55KSB7XG4gICAgdGhpcy5zZXJ2ZXIudG8oY29udmVyc2F0aW9uSWQpLmVtaXQoJ21lc3NhZ2VfcmVhY3Rpb24nLCB7XG4gICAgICBtZXNzYWdlSWQsXG4gICAgICByZWFjdGlvbixcbiAgICB9KTtcbiAgfVxuXG4gIC8vIFByaXZhdGUgaGVscGVyIG1ldGhvZHNcbiAgLy8gQXV0aGVudGljYXRpb24gZ3VhcmQgZm9yIG1lc3NhZ2UgaGFuZGxlcnNcbiAgcHJpdmF0ZSBpc0F1dGhlbnRpY2F0ZWQoY2xpZW50OiBBdXRoZW50aWNhdGVkU29ja2V0KTogYm9vbGVhbiB7XG4gICAgaWYgKCFjbGllbnQuaXNBdXRoZW50aWNhdGVkIHx8ICFjbGllbnQudXNlcklkKSB7XG4gICAgICB0aGlzLmxvZ2dlci53YXJuKFxuICAgICAgICBgVW5hdXRoZW50aWNhdGVkIGNsaWVudCAke2NsaWVudC5pZH0gYXR0ZW1wdGVkIHRvIHBlcmZvcm0gYWN0aW9uYCxcbiAgICAgICk7XG4gICAgICBjbGllbnQuZW1pdCgnYXV0aF9lcnJvcicsIHtcbiAgICAgICAgbWVzc2FnZTogJ0F1dGhlbnRpY2F0aW9uIHJlcXVpcmVkIGZvciB0aGlzIGFjdGlvbicsXG4gICAgICAgIGNvZGU6ICdBVVRIX1JFUVVJUkVEJyxcbiAgICAgIH0pO1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgam9pblVzZXJDb252ZXJzYXRpb25zKFxuICAgIGNsaWVudDogQXV0aGVudGljYXRlZFNvY2tldCxcbiAgICB1c2VySWQ6IHN0cmluZyxcbiAgKSB7XG4gICAgdHJ5IHtcbiAgICAgIC8vIEdldCBhbGwgYWN0aXZlIGNvbnZlcnNhdGlvbnMgZm9yIHRoZSB1c2VyXG4gICAgICBjb25zdCBjb252ZXJzYXRpb25zID0gYXdhaXQgdGhpcy5wcmlzbWEuY29udmVyc2F0aW9uLmZpbmRNYW55KHtcbiAgICAgICAgd2hlcmU6IHtcbiAgICAgICAgICBwYXJ0aWNpcGFudHM6IHtcbiAgICAgICAgICAgIHNvbWU6IHtcbiAgICAgICAgICAgICAgdXNlcklkLFxuICAgICAgICAgICAgICBpc0FjdGl2ZTogdHJ1ZSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgICBpc0FjdGl2ZTogdHJ1ZSxcbiAgICAgICAgfSxcbiAgICAgICAgc2VsZWN0OiB7XG4gICAgICAgICAgaWQ6IHRydWUsXG4gICAgICAgIH0sXG4gICAgICB9KTtcblxuICAgICAgLy8gSm9pbiBhbGwgY29udmVyc2F0aW9uIHJvb21zXG4gICAgICBmb3IgKGNvbnN0IGNvbnZlcnNhdGlvbiBvZiBjb252ZXJzYXRpb25zKSB7XG4gICAgICAgIHZvaWQgY2xpZW50LmpvaW4oY29udmVyc2F0aW9uLmlkKTtcblxuICAgICAgICAvLyBBZGQgdG8gdHJhY2tpbmdcbiAgICAgICAgaWYgKCF0aGlzLmNvbnZlcnNhdGlvblBhcnRpY2lwYW50cy5oYXMoY29udmVyc2F0aW9uLmlkKSkge1xuICAgICAgICAgIHRoaXMuY29udmVyc2F0aW9uUGFydGljaXBhbnRzLnNldChjb252ZXJzYXRpb24uaWQsIG5ldyBTZXQoKSk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5jb252ZXJzYXRpb25QYXJ0aWNpcGFudHMuZ2V0KGNvbnZlcnNhdGlvbi5pZCkhLmFkZCh1c2VySWQpO1xuICAgICAgfVxuXG4gICAgICB0aGlzLmxvZ2dlci5sb2coXG4gICAgICAgIGBVc2VyICR7dXNlcklkfSBqb2luZWQgJHtjb252ZXJzYXRpb25zLmxlbmd0aH0gY29udmVyc2F0aW9uIHJvb21zYCxcbiAgICAgICk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRoaXMubG9nZ2VyLmVycm9yKCdFcnJvciBqb2luaW5nIHVzZXIgY29udmVyc2F0aW9uczonLCBlcnJvcik7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBicm9hZGNhc3RVc2VyU3RhdHVzKFxuICAgIHVzZXJJZDogc3RyaW5nLFxuICAgIHN0YXR1czogJ29ubGluZScgfCAnb2ZmbGluZScsXG4gICkge1xuICAgIC8vIEdldCBhbGwgY29udmVyc2F0aW9ucyB0aGlzIHVzZXIgcGFydGljaXBhdGVzIGluXG4gICAgY29uc3QgY29udmVyc2F0aW9ucyA9IGF3YWl0IHRoaXMucHJpc21hLmNvbnZlcnNhdGlvbi5maW5kTWFueSh7XG4gICAgICB3aGVyZToge1xuICAgICAgICBwYXJ0aWNpcGFudHM6IHtcbiAgICAgICAgICBzb21lOiB7XG4gICAgICAgICAgICB1c2VySWQsXG4gICAgICAgICAgICBpc0FjdGl2ZTogdHJ1ZSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgfSxcbiAgICAgIHNlbGVjdDoge1xuICAgICAgICBpZDogdHJ1ZSxcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICAvLyBCcm9hZGNhc3Qgc3RhdHVzIHRvIGFsbCBjb252ZXJzYXRpb24gcm9vbXNcbiAgICBmb3IgKGNvbnN0IGNvbnZlcnNhdGlvbiBvZiBjb252ZXJzYXRpb25zKSB7XG4gICAgICB0aGlzLnNlcnZlci50byhjb252ZXJzYXRpb24uaWQpLmVtaXQoJ3VzZXJfc3RhdHVzX2NoYW5nZWQnLCB7XG4gICAgICAgIHVzZXJJZCxcbiAgICAgICAgc3RhdHVzLFxuICAgICAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKCksXG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIHNlbmRQdXNoTm90aWZpY2F0aW9ucyhjb252ZXJzYXRpb25JZDogc3RyaW5nLCBtZXNzYWdlOiBhbnkpIHtcbiAgICB0cnkge1xuICAgICAgLy8gR2V0IGFsbCBwYXJ0aWNpcGFudHMgaW4gdGhlIGNvbnZlcnNhdGlvbiBleGNlcHQgdGhlIHNlbmRlclxuICAgICAgY29uc3QgY29udmVyc2F0aW9uID0gYXdhaXQgdGhpcy5wcmlzbWEuY29udmVyc2F0aW9uLmZpbmRVbmlxdWUoe1xuICAgICAgICB3aGVyZTogeyBpZDogY29udmVyc2F0aW9uSWQgfSxcbiAgICAgICAgaW5jbHVkZToge1xuICAgICAgICAgIHBhcnRpY2lwYW50czoge1xuICAgICAgICAgICAgaW5jbHVkZToge1xuICAgICAgICAgICAgICB1c2VyOiB0cnVlLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgfSk7XG5cbiAgICAgIGlmICghY29udmVyc2F0aW9uKSB7XG4gICAgICAgIHRoaXMubG9nZ2VyLndhcm4oXG4gICAgICAgICAgYENvbnZlcnNhdGlvbiAke2NvbnZlcnNhdGlvbklkfSBub3QgZm91bmQgZm9yIHB1c2ggbm90aWZpY2F0aW9uc2AsXG4gICAgICAgICk7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cblxuICAgICAgLy8gRmlsdGVyIHBhcnRpY2lwYW50cyB3aG8gc2hvdWxkIHJlY2VpdmUgcHVzaCBub3RpZmljYXRpb25zXG4gICAgICBjb25zdCBlbGlnaWJsZVBhcnRpY2lwYW50cyA9IGNvbnZlcnNhdGlvbi5wYXJ0aWNpcGFudHMuZmlsdGVyKFxuICAgICAgICAocGFydGljaXBhbnQpID0+IHtcbiAgICAgICAgICAvLyBEb24ndCBzZW5kIHRvIG1lc3NhZ2Ugc2VuZGVyXG4gICAgICAgICAgaWYgKHBhcnRpY2lwYW50LnVzZXJJZCA9PT0gbWVzc2FnZS5zZW5kZXJJZCkge1xuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIC8vIFVzZSBkZWZhdWx0IG5vdGlmaWNhdGlvbiBzZXR0aW5ncyBzaW5jZSBub3RpZmljYXRpb25TZXR0aW5ncyBtb2RlbCBkb2Vzbid0IGV4aXN0XG4gICAgICAgICAgLy8gRGVmYXVsdCB0byB0cnVlIGZvciBwdXNoIG5vdGlmaWNhdGlvbnMgZm9yIG5ldyBtZXNzYWdlc1xuICAgICAgICAgIGNvbnN0IGRlZmF1bHRQdXNoTmV3TWVzc2FnZXMgPSB0cnVlO1xuICAgICAgICAgIGlmICghZGVmYXVsdFB1c2hOZXdNZXNzYWdlcykge1xuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIC8vIE5vdGU6IE5vIGRldmljZSB0b2tlbiBmaWx0ZXJpbmcgYXZhaWxhYmxlIChubyBEZXZpY2VUb2tlbiBtb2RlbClcbiAgICAgICAgICAvLyBBbGwgcGFydGljaXBhbnRzIGFyZSBjb25zaWRlcmVkIGVsaWdpYmxlIGZvciBhbHRlcm5hdGl2ZSBub3RpZmljYXRpb25zXG4gICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH0sXG4gICAgICApO1xuXG4gICAgICBpZiAoZWxpZ2libGVQYXJ0aWNpcGFudHMubGVuZ3RoID09PSAwKSB7XG4gICAgICAgIHRoaXMubG9nZ2VyLmxvZyhcbiAgICAgICAgICBgTm8gZWxpZ2libGUgcGFydGljaXBhbnRzIGZvciBwdXNoIG5vdGlmaWNhdGlvbnMgaW4gY29udmVyc2F0aW9uICR7Y29udmVyc2F0aW9uSWR9YCxcbiAgICAgICAgKTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuXG4gICAgICAvLyBQcmVwYXJlIG5vdGlmaWNhdGlvbiBwYXlsb2FkXG4gICAgICBjb25zdCBub3RpZmljYXRpb25QYXlsb2FkID0ge1xuICAgICAgICB0aXRsZTogJ05ldyBNZXNzYWdlJyxcbiAgICAgICAgYm9keTpcbiAgICAgICAgICBtZXNzYWdlLmNvbnRlbnQubGVuZ3RoID4gNTBcbiAgICAgICAgICAgID8gYCR7bWVzc2FnZS5jb250ZW50LnN1YnN0cmluZygwLCA1MCl9Li4uYFxuICAgICAgICAgICAgOiBtZXNzYWdlLmNvbnRlbnQsXG4gICAgICAgIGljb246ICcvaWNvbi0xOTJ4MTkyLnBuZycsXG4gICAgICAgIGJhZGdlOiAnL2JhZGdlLTcyeDcyLnBuZycsXG4gICAgICAgIGRhdGE6IHtcbiAgICAgICAgICBjb252ZXJzYXRpb25JZDogY29udmVyc2F0aW9uSWQsXG4gICAgICAgICAgbWVzc2FnZUlkOiBtZXNzYWdlLmlkLFxuICAgICAgICAgIHNlbmRlcklkOiBtZXNzYWdlLnNlbmRlcklkLFxuICAgICAgICAgIHVybDogYC91c2VyL21lc3NhZ2VzP2NvbnZlcnNhdGlvbj0ke2NvbnZlcnNhdGlvbklkfWAsXG4gICAgICAgIH0sXG4gICAgICB9O1xuXG4gICAgICAvLyBBbHRlcm5hdGl2ZSBub3RpZmljYXRpb24gYXBwcm9hY2ggKG5vIGRldmljZSB0b2tlbnMgYXZhaWxhYmxlKVxuICAgICAgY29uc3QgcHVzaFByb21pc2VzID0gZWxpZ2libGVQYXJ0aWNpcGFudHMubWFwKGFzeW5jIChwYXJ0aWNpcGFudCkgPT4ge1xuICAgICAgICB0cnkge1xuICAgICAgICAgIC8vIExvZyBub3RpZmljYXRpb24gYXR0ZW1wdCAoYWx0ZXJuYXRpdmUgdG8gcHVzaCBub3RpZmljYXRpb25zKVxuICAgICAgICAgIHRoaXMubG9nZ2VyLmxvZyhcbiAgICAgICAgICAgIGBXb3VsZCBzZW5kIHB1c2ggbm90aWZpY2F0aW9uIHRvIHVzZXIgJHtwYXJ0aWNpcGFudC51c2VySWR9IGZvciBtZXNzYWdlICR7bWVzc2FnZS5pZH0gKG5vIERldmljZVRva2VuIG1vZGVsIGF2YWlsYWJsZSlgLFxuICAgICAgICAgICk7XG4gICAgICAgICAgXG4gICAgICAgICAgLy8gSGVyZSB5b3UgY291bGQgaW1wbGVtZW50IFdlYlNvY2tldC1iYXNlZCByZWFsLXRpbWUgbm90aWZpY2F0aW9uc1xuICAgICAgICAgIC8vIG9yIG90aGVyIGFsdGVybmF0aXZlIG5vdGlmaWNhdGlvbiBtZXRob2RzXG4gICAgICAgICAgXG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgY29uc3QgZXJyb3JNZXNzYWdlID1cbiAgICAgICAgICAgIGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogJ1Vua25vd24gZXJyb3InO1xuICAgICAgICAgIHRoaXMubG9nZ2VyLmVycm9yKFxuICAgICAgICAgICAgYEZhaWxlZCB0byBwcm9jZXNzIG5vdGlmaWNhdGlvbiBmb3IgdXNlciAke3BhcnRpY2lwYW50LnVzZXJJZH06ICR7ZXJyb3JNZXNzYWdlfWAsXG4gICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG5cbiAgICAgIGF3YWl0IFByb21pc2UuYWxsU2V0dGxlZChwdXNoUHJvbWlzZXMpO1xuXG4gICAgICB0aGlzLmxvZ2dlci5sb2coXG4gICAgICAgIGBQdXNoIG5vdGlmaWNhdGlvbiBwcm9jZXNzaW5nIGNvbXBsZXRlZCBmb3IgY29udmVyc2F0aW9uICR7Y29udmVyc2F0aW9uSWR9YCxcbiAgICAgICk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRoaXMubG9nZ2VyLmVycm9yKFxuICAgICAgICBgRmFpbGVkIHRvIHNlbmQgcHVzaCBub3RpZmljYXRpb25zIGZvciBjb252ZXJzYXRpb24gJHtjb252ZXJzYXRpb25JZH06YCxcbiAgICAgICAgZXJyb3IsXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIC8vIENsZWFuIHVwIG9sZCB0eXBpbmcgaW5kaWNhdG9ycyAoY2FsbCB0aGlzIHBlcmlvZGljYWxseSlcbiAgYXN5bmMgY2xlYW51cFR5cGluZ0luZGljYXRvcnMoKSB7XG4gICAgY29uc3QgZml2ZU1pbnV0ZXNBZ28gPSBuZXcgRGF0ZShEYXRlLm5vdygpIC0gNSAqIDYwICogMTAwMCk7XG5cbiAgICBhd2FpdCB0aGlzLnByaXNtYS50eXBpbmdJbmRpY2F0b3IuZGVsZXRlTWFueSh7XG4gICAgICB3aGVyZToge1xuICAgICAgICBsYXN0VHlwaW5nQXQ6IHtcbiAgICAgICAgICBsdDogZml2ZU1pbnV0ZXNBZ28sXG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgIH0pO1xuICB9XG5cbiAgLy8gUGVyc29uYWwgcm9vbSBzdWJzY3JpcHRpb24gbWV0aG9kcyBmb3IgcmVhbC10aW1lIG5vdGlmaWNhdGlvbnNcbiAgYXN5bmMgc3Vic2NyaWJlVXNlclRvUGVyc29uYWxSb29tKFxuICAgIGNsaWVudDogQXV0aGVudGljYXRlZFNvY2tldCxcbiAgICB1c2VySWQ6IHN0cmluZyxcbiAgKSB7XG4gICAgY29uc3QgdXNlclJvb20gPSBgdXNlcjoke3VzZXJJZH1gO1xuICAgIGF3YWl0IGNsaWVudC5qb2luKHVzZXJSb29tKTtcbiAgICB0aGlzLmxvZ2dlci5kZWJ1ZyhcbiAgICAgIGBVc2VyICR7dXNlcklkfSBzdWJzY3JpYmVkIHRvIHBlcnNvbmFsIHJvb206ICR7dXNlclJvb219YCxcbiAgICApO1xuICB9XG5cbiAgYXN5bmMgdW5zdWJzY3JpYmVVc2VyRnJvbVBlcnNvbmFsUm9vbShcbiAgICBjbGllbnQ6IEF1dGhlbnRpY2F0ZWRTb2NrZXQsXG4gICAgdXNlcklkOiBzdHJpbmcsXG4gICkge1xuICAgIGNvbnN0IHVzZXJSb29tID0gYHVzZXI6JHt1c2VySWR9YDtcbiAgICBhd2FpdCBjbGllbnQubGVhdmUodXNlclJvb20pO1xuICAgIHRoaXMubG9nZ2VyLmRlYnVnKFxuICAgICAgYFVzZXIgJHt1c2VySWR9IHVuc3Vic2NyaWJlZCBmcm9tIHBlcnNvbmFsIHJvb206ICR7dXNlclJvb219YCxcbiAgICApO1xuICB9XG5cbiAgLy8gQ29tbXVuaXR5IGFuZCBwb3N0IHJvb20gc3Vic2NyaXB0aW9ucyBmb3Igc29jaWFsIGZlYXR1cmVzXG4gIEBTdWJzY3JpYmVNZXNzYWdlKCdqb2luX2NvbW11bml0eScpXG4gIGFzeW5jIGhhbmRsZUpvaW5Db21tdW5pdHkoXG4gICAgQENvbm5lY3RlZFNvY2tldCgpIGNsaWVudDogQXV0aGVudGljYXRlZFNvY2tldCxcbiAgICBATWVzc2FnZUJvZHkoKSBkYXRhOiB7IGNvbW11bml0eUlkOiBzdHJpbmcgfSxcbiAgKSB7XG4gICAgaWYgKCF0aGlzLmlzQXV0aGVudGljYXRlZChjbGllbnQpKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgeyBjb21tdW5pdHlJZCB9ID0gZGF0YTtcbiAgICBjb25zdCB1c2VySWQgPSBjbGllbnQudXNlcklkITtcblxuICAgIHRyeSB7XG4gICAgICAvLyBWZXJpZnkgdXNlciBpcyBhIG1lbWJlciBvZiB0aGlzIGNvbW11bml0eVxuICAgICAgY29uc3QgbWVtYmVyc2hpcCA9IGF3YWl0IHRoaXMucHJpc21hLm1lbWJlcnNoaXAuZmluZEZpcnN0KHtcbiAgICAgICAgd2hlcmU6IHtcbiAgICAgICAgICBjb21tdW5pdHlJZCxcbiAgICAgICAgICB1c2VySWQsXG4gICAgICAgIH0sXG4gICAgICB9KTtcblxuICAgICAgaWYgKCFtZW1iZXJzaGlwKSB7XG4gICAgICAgIGNsaWVudC5lbWl0KCdlcnJvcicsIHsgbWVzc2FnZTogJ0FjY2VzcyBkZW5pZWQgdG8gdGhpcyBjb21tdW5pdHknIH0pO1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IGNvbW11bml0eVJvb20gPSBgY29tbXVuaXR5XyR7Y29tbXVuaXR5SWR9YDtcbiAgICAgIGF3YWl0IGNsaWVudC5qb2luKGNvbW11bml0eVJvb20pO1xuXG4gICAgICBjbGllbnQuZW1pdCgnY29tbXVuaXR5X2pvaW5lZCcsIHsgY29tbXVuaXR5SWQgfSk7XG4gICAgICB0aGlzLmxvZ2dlci5sb2coYFVzZXIgJHt1c2VySWR9IGpvaW5lZCBjb21tdW5pdHkgcm9vbSAke2NvbW11bml0eUlkfWApO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aGlzLmhhbmRsZVN1YnNjcmlwdGlvbkVycm9yKGNsaWVudCwgZXJyb3IsICdqb2luX2NvbW11bml0eScpO1xuICAgIH1cbiAgfVxuXG4gIEBTdWJzY3JpYmVNZXNzYWdlKCdsZWF2ZV9jb21tdW5pdHknKVxuICBhc3luYyBoYW5kbGVMZWF2ZUNvbW11bml0eShcbiAgICBAQ29ubmVjdGVkU29ja2V0KCkgY2xpZW50OiBBdXRoZW50aWNhdGVkU29ja2V0LFxuICAgIEBNZXNzYWdlQm9keSgpIGRhdGE6IHsgY29tbXVuaXR5SWQ6IHN0cmluZyB9LFxuICApIHtcbiAgICBpZiAoIXRoaXMuaXNBdXRoZW50aWNhdGVkKGNsaWVudCkpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICB0cnkge1xuICAgICAgY29uc3QgeyBjb21tdW5pdHlJZCB9ID0gZGF0YTtcbiAgICAgIGNvbnN0IHVzZXJJZCA9IGNsaWVudC51c2VySWQhO1xuXG4gICAgICBjb25zdCBjb21tdW5pdHlSb29tID0gYGNvbW11bml0eV8ke2NvbW11bml0eUlkfWA7XG4gICAgICBhd2FpdCBjbGllbnQubGVhdmUoY29tbXVuaXR5Um9vbSk7XG5cbiAgICAgIGNsaWVudC5lbWl0KCdjb21tdW5pdHlfbGVmdCcsIHsgY29tbXVuaXR5SWQgfSk7XG4gICAgICB0aGlzLmxvZ2dlci5sb2coYFVzZXIgJHt1c2VySWR9IGxlZnQgY29tbXVuaXR5IHJvb20gJHtjb21tdW5pdHlJZH1gKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhpcy5oYW5kbGVTdWJzY3JpcHRpb25FcnJvcihjbGllbnQsIGVycm9yLCAnbGVhdmVfY29tbXVuaXR5Jyk7XG4gICAgfVxuICB9XG5cbiAgQFN1YnNjcmliZU1lc3NhZ2UoJ2pvaW5fcG9zdCcpXG4gIGFzeW5jIGhhbmRsZUpvaW5Qb3N0KFxuICAgIEBDb25uZWN0ZWRTb2NrZXQoKSBjbGllbnQ6IEF1dGhlbnRpY2F0ZWRTb2NrZXQsXG4gICAgQE1lc3NhZ2VCb2R5KCkgZGF0YTogeyBwb3N0SWQ6IHN0cmluZyB9LFxuICApIHtcbiAgICBpZiAoIXRoaXMuaXNBdXRoZW50aWNhdGVkKGNsaWVudCkpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjb25zdCB7IHBvc3RJZCB9ID0gZGF0YTtcbiAgICBjb25zdCB1c2VySWQgPSBjbGllbnQudXNlcklkITtcblxuICAgIHRyeSB7XG4gICAgICAvLyBWZXJpZnkgcG9zdCBleGlzdHMgYW5kIHVzZXIgaGFzIGFjY2Vzc1xuICAgICAgY29uc3QgcG9zdCA9IGF3YWl0IHRoaXMucHJpc21hLnBvc3QuZmluZEZpcnN0KHtcbiAgICAgICAgd2hlcmU6IHtcbiAgICAgICAgICBpZDogcG9zdElkLFxuICAgICAgICAgIHJvb206IHtcbiAgICAgICAgICAgIHJvb21Hcm91cDoge1xuICAgICAgICAgICAgICBjb21tdW5pdHk6IHtcbiAgICAgICAgICAgICAgICBtZW1iZXJzaGlwczoge1xuICAgICAgICAgICAgICAgICAgc29tZToge1xuICAgICAgICAgICAgICAgICAgICB1c2VySWQsXG4gICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICB9KTtcblxuICAgICAgaWYgKCFwb3N0KSB7XG4gICAgICAgIGNsaWVudC5lbWl0KCdlcnJvcicsIHsgbWVzc2FnZTogJ0FjY2VzcyBkZW5pZWQgdG8gdGhpcyBwb3N0JyB9KTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBwb3N0Um9vbSA9IGBwb3N0XyR7cG9zdElkfWA7XG4gICAgICBhd2FpdCBjbGllbnQuam9pbihwb3N0Um9vbSk7XG5cbiAgICAgIGNsaWVudC5lbWl0KCdwb3N0X2pvaW5lZCcsIHsgcG9zdElkIH0pO1xuICAgICAgdGhpcy5sb2dnZXIubG9nKGBVc2VyICR7dXNlcklkfSBqb2luZWQgcG9zdCByb29tICR7cG9zdElkfWApO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aGlzLmhhbmRsZVN1YnNjcmlwdGlvbkVycm9yKGNsaWVudCwgZXJyb3IsICdqb2luX3Bvc3QnKTtcbiAgICB9XG4gIH1cblxuICBAU3Vic2NyaWJlTWVzc2FnZSgnbGVhdmVfcG9zdCcpXG4gIGFzeW5jIGhhbmRsZUxlYXZlUG9zdChcbiAgICBAQ29ubmVjdGVkU29ja2V0KCkgY2xpZW50OiBBdXRoZW50aWNhdGVkU29ja2V0LFxuICAgIEBNZXNzYWdlQm9keSgpIGRhdGE6IHsgcG9zdElkOiBzdHJpbmcgfSxcbiAgKSB7XG4gICAgaWYgKCF0aGlzLmlzQXV0aGVudGljYXRlZChjbGllbnQpKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHsgcG9zdElkIH0gPSBkYXRhO1xuICAgICAgY29uc3QgdXNlcklkID0gY2xpZW50LnVzZXJJZCE7XG5cbiAgICAgIGNvbnN0IHBvc3RSb29tID0gYHBvc3RfJHtwb3N0SWR9YDtcbiAgICAgIGF3YWl0IGNsaWVudC5sZWF2ZShwb3N0Um9vbSk7XG5cbiAgICAgIGNsaWVudC5lbWl0KCdwb3N0X2xlZnQnLCB7IHBvc3RJZCB9KTtcbiAgICAgIHRoaXMubG9nZ2VyLmxvZyhgVXNlciAke3VzZXJJZH0gbGVmdCBwb3N0IHJvb20gJHtwb3N0SWR9YCk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRoaXMuaGFuZGxlU3Vic2NyaXB0aW9uRXJyb3IoY2xpZW50LCBlcnJvciwgJ2xlYXZlX3Bvc3QnKTtcbiAgICB9XG4gIH1cblxuICAvLyBVdGlsaXR5IG1ldGhvZCB0byBnZXQgc2VydmVyIGluc3RhbmNlIGZvciBldmVudCBicm9hZGNhc3RpbmdcbiAgZ2V0U2VydmVyKCk6IFNlcnZlciB7XG4gICAgcmV0dXJuIHRoaXMuc2VydmVyO1xuICB9XG5cbiAgLy8gUHJpdmF0ZSBoZWxwZXIgbWV0aG9kIGZvciBjb25uZWN0aW9uIGxpbWl0cyBhbmQgZGVkdXBsaWNhdGlvblxuICBwcml2YXRlIGFzeW5jIGhhbmRsZUNvbm5lY3Rpb25MaW1pdHMoY2xpZW50OiBBdXRoZW50aWNhdGVkU29ja2V0LCB1c2VySWQ6IHN0cmluZykge1xuICAgIGNvbnN0IHVzZXJTb2NrZXRTZXQgPSB0aGlzLnVzZXJTb2NrZXRzLmdldCh1c2VySWQpO1xuICAgIFxuICAgIGlmICh1c2VyU29ja2V0U2V0ICYmIHVzZXJTb2NrZXRTZXQuc2l6ZSA+PSB0aGlzLk1BWF9DT05ORUNUSU9OU19QRVJfVVNFUikge1xuICAgICAgdGhpcy5sb2dnZXIud2FybihgVXNlciAke3VzZXJJZH0gZXhjZWVkZWQgY29ubmVjdGlvbiBsaW1pdCAoJHt0aGlzLk1BWF9DT05ORUNUSU9OU19QRVJfVVNFUn0pYCk7XG4gICAgICBcbiAgICAgIC8vIENsb3NlIG9sZGVzdCBjb25uZWN0aW9ucyB0byBtYWtlIHJvb20gZm9yIG5ldyBvbmVcbiAgICAgIGNvbnN0IHNvY2tldHNUb0Nsb3NlID0gQXJyYXkuZnJvbSh1c2VyU29ja2V0U2V0KS5zbGljZSgwLCB1c2VyU29ja2V0U2V0LnNpemUgLSB0aGlzLk1BWF9DT05ORUNUSU9OU19QRVJfVVNFUiArIDEpO1xuICAgICAgXG4gICAgICBmb3IgKGNvbnN0IHNvY2tldElkIG9mIHNvY2tldHNUb0Nsb3NlKSB7XG4gICAgICAgIGNvbnN0IHNvY2tldFRvQ2xvc2UgPSB0aGlzLnNlcnZlci5zb2NrZXRzLnNvY2tldHMuZ2V0KHNvY2tldElkKTtcbiAgICAgICAgaWYgKHNvY2tldFRvQ2xvc2UpIHtcbiAgICAgICAgICBzb2NrZXRUb0Nsb3NlLmVtaXQoJ2Nvbm5lY3Rpb25fbGltaXRfZXhjZWVkZWQnLCB7XG4gICAgICAgICAgICBtZXNzYWdlOiAnQ29ubmVjdGlvbiBjbG9zZWQgZHVlIHRvIHRvbyBtYW55IGNvbmN1cnJlbnQgY29ubmVjdGlvbnMnLFxuICAgICAgICAgICAgbWF4Q29ubmVjdGlvbnM6IHRoaXMuTUFYX0NPTk5FQ1RJT05TX1BFUl9VU0VSLFxuICAgICAgICAgIH0pO1xuICAgICAgICAgIHNvY2tldFRvQ2xvc2UuZGlzY29ubmVjdCh0cnVlKTtcbiAgICAgICAgfVxuICAgICAgICB1c2VyU29ja2V0U2V0LmRlbGV0ZShzb2NrZXRJZCk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgLy8gUHJpdmF0ZSBoZWxwZXIgbWV0aG9kIGZvciB1c2VyIGNvbm5lY3Rpb24gY2xlYW51cFxuICBwcml2YXRlIGFzeW5jIGNsZWFudXBVc2VyQ29ubmVjdGlvbih1c2VySWQ6IHN0cmluZywgc29ja2V0SWQ6IHN0cmluZykge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCB1c2VyU29ja2V0cyA9IHRoaXMudXNlclNvY2tldHMuZ2V0KHVzZXJJZCk7XG4gICAgICBpZiAodXNlclNvY2tldHMpIHtcbiAgICAgICAgdXNlclNvY2tldHMuZGVsZXRlKHNvY2tldElkKTtcblxuICAgICAgICAvLyBJZiBubyBtb3JlIHNvY2tldHMgZm9yIHRoaXMgdXNlciwgcmVtb3ZlIGZyb20gdHJhY2tpbmdcbiAgICAgICAgaWYgKHVzZXJTb2NrZXRzLnNpemUgPT09IDApIHtcbiAgICAgICAgICB0aGlzLnVzZXJTb2NrZXRzLmRlbGV0ZSh1c2VySWQpO1xuXG4gICAgICAgICAgLy8gQ2xlYW4gdXAgY29udmVyc2F0aW9uIHBhcnRpY2lwYW50cyB0cmFja2luZ1xuICAgICAgICAgIGZvciAoY29uc3QgW2NvbnZlcnNhdGlvbklkLCBwYXJ0aWNpcGFudHNdIG9mIHRoaXMuY29udmVyc2F0aW9uUGFydGljaXBhbnRzLmVudHJpZXMoKSkge1xuICAgICAgICAgICAgcGFydGljaXBhbnRzLmRlbGV0ZSh1c2VySWQpO1xuICAgICAgICAgICAgLy8gUmVtb3ZlIGVtcHR5IGNvbnZlcnNhdGlvbiBzZXRzXG4gICAgICAgICAgICBpZiAocGFydGljaXBhbnRzLnNpemUgPT09IDApIHtcbiAgICAgICAgICAgICAgdGhpcy5jb252ZXJzYXRpb25QYXJ0aWNpcGFudHMuZGVsZXRlKGNvbnZlcnNhdGlvbklkKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG5cbiAgICAgICAgICAvLyBCcm9hZGNhc3QgdXNlciBvZmZsaW5lIHN0YXR1cyB0byB0aGVpciBjb250YWN0c1xuICAgICAgICAgIGF3YWl0IHRoaXMuYnJvYWRjYXN0VXNlclN0YXR1cyh1c2VySWQsICdvZmZsaW5lJyk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoYEVycm9yIGluIGNsZWFudXBVc2VyQ29ubmVjdGlvbiBmb3IgdXNlciAke3VzZXJJZH06YCwgZXJyb3IpO1xuICAgICAgdGhyb3cgZXJyb3I7IC8vIFJlLXRocm93IHRvIGxldCBoYW5kbGVEaXNjb25uZWN0IGhhbmRsZSBpdFxuICAgIH1cbiAgfVxuXG4gIC8vIEVuaGFuY2VkIGVycm9yIGhhbmRsaW5nIGZvciBtZXNzYWdlIHN1YnNjcmlwdGlvbnNcbiAgcHJpdmF0ZSBoYW5kbGVTdWJzY3JpcHRpb25FcnJvcihjbGllbnQ6IEF1dGhlbnRpY2F0ZWRTb2NrZXQsIGVycm9yOiBhbnksIGFjdGlvbjogc3RyaW5nKSB7XG4gICAgdGhpcy5sb2dnZXIuZXJyb3IoYCR7YWN0aW9ufSBlcnJvciBmb3IgY2xpZW50ICR7Y2xpZW50LmlkfTpgLCBlcnJvcik7XG4gICAgXG4gICAgLy8gU2VuZCBzdHJ1Y3R1cmVkIGVycm9yIHJlc3BvbnNlIHRvIGNsaWVudFxuICAgIGNsaWVudC5lbWl0KCdzdWJzY3JpcHRpb25fZXJyb3InLCB7XG4gICAgICBhY3Rpb24sXG4gICAgICBlcnJvcjogZXJyb3IubWVzc2FnZSB8fCAnVW5rbm93biBlcnJvcicsXG4gICAgICBjb2RlOiBlcnJvci5jb2RlIHx8ICdTVUJTQ1JJUFRJT05fRVJST1InLFxuICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksXG4gICAgfSk7XG4gICAgXG4gICAgLy8gSWYgaXQncyBhIGNyaXRpY2FsIGVycm9yLCBkaXNjb25uZWN0IHRoZSBjbGllbnRcbiAgICBpZiAoZXJyb3IubmFtZSA9PT0gJ0RhdGFiYXNlRXJyb3InIHx8IGVycm9yLmNvZGUgPT09ICdFQ09OTlJFU0VUJykge1xuICAgICAgdGhpcy5sb2dnZXIud2FybihgQ3JpdGljYWwgZXJyb3IgZGV0ZWN0ZWQsIGRpc2Nvbm5lY3RpbmcgY2xpZW50ICR7Y2xpZW50LmlkfWApO1xuICAgICAgY2xpZW50LmRpc2Nvbm5lY3QodHJ1ZSk7XG4gICAgfVxuICB9XG59XG4iXSwidmVyc2lvbiI6M30=