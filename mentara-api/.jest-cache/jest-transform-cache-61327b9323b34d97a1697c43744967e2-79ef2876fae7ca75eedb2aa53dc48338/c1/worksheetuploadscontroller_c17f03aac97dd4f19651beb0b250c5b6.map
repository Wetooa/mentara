{"version":3,"names":["common_1","cov_o9nloagcd","s","require","platform_express_1","prisma_client_provider_1","supabase_storage_service_1","WorksheetUploadsController","prisma","supabaseStorageService","constructor","f","uploadFile","file","worksheetId","type","b","BadRequestException","includes","worksheet","findUnique","where","id","allowedMimeTypes","validation","validateFile","isValid","error","uploadResult","SupabaseStorageService","getSupportedBuckets","WORKSHEETS","update","data","materialUrls","push","url","materialNames","originalname","existingSubmission","worksheetSubmission","fileUrls","fileNames","fileSizes","size","create","filename","fileSize","fileType","mimetype","HttpException","Error","message","HttpStatus","INTERNAL_SERVER_ERROR","exports","__decorate","Post","UseInterceptors","FileInterceptor","__param","UploadedFile","Body","Express","_c","Multer","File","_d","Object","String","Controller","PrismaService","_a","_b"],"sources":["/home/wetooa/Documents/code/projects/mentara/mentara-api/src/worksheets/worksheet-uploads.controller.ts"],"sourcesContent":["import {\n  Controller,\n  Post,\n  UseInterceptors,\n  UploadedFile,\n  Body,\n  BadRequestException,\n  HttpException,\n  HttpStatus,\n} from '@nestjs/common';\nimport { FileInterceptor } from '@nestjs/platform-express';\nimport { PrismaService } from '../providers/prisma-client.provider';\nimport { SupabaseStorageService } from '../common/services/supabase-storage.service';\n\n@Controller('worksheets/upload')\nexport class WorksheetUploadsController {\n  constructor(\n    private prisma: PrismaService,\n    private readonly supabaseStorageService: SupabaseStorageService,\n  ) {}\n\n  @Post()\n  @UseInterceptors(FileInterceptor('file'))\n  async uploadFile(\n    @UploadedFile() file: Express.Multer.File,\n    @Body('worksheetId') worksheetId: string,\n    @Body('type') type: 'material' | 'submission',\n  ) {\n    if (!file) {\n      throw new BadRequestException('No file uploaded');\n    }\n\n    if (!worksheetId) {\n      throw new BadRequestException('Worksheet ID is required');\n    }\n\n    if (!type || !['material', 'submission'].includes(type)) {\n      throw new BadRequestException(\n        'Type must be either \"material\" or \"submission\"',\n      );\n    }\n\n    try {\n      // Check if the worksheet exists\n      const worksheet = await this.prisma.worksheet.findUnique({\n        where: { id: worksheetId },\n      });\n\n      if (!worksheet) {\n        throw new BadRequestException(\n          `Worksheet with ID ${worksheetId} not found`,\n        );\n      }\n\n      // Validate file\n      const allowedMimeTypes = [\n        'application/pdf', // PDF files\n        'application/msword', // DOC files\n        'application/vnd.openxmlformats-officedocument.wordprocessingml.document', // DOCX files\n        'text/plain', // Text files\n        'image/jpeg', // JPEG images\n        'image/png', // PNG images\n      ];\n\n      const validation = this.supabaseStorageService.validateFile(\n        file,\n        5 * 1024 * 1024, // 5MB limit\n        allowedMimeTypes,\n      );\n\n      if (!validation.isValid) {\n        throw new BadRequestException(\n          `File validation failed: ${validation.error}`,\n        );\n      }\n\n      // Upload file to Supabase Storage\n      const uploadResult = await this.supabaseStorageService.uploadFile(\n        file,\n        SupabaseStorageService.getSupportedBuckets().WORKSHEETS,\n      );\n\n      // Update the worksheet with the new file information\n      if (type === 'material') {\n        // Add to material arrays\n        await this.prisma.worksheet.update({\n          where: { id: worksheetId },\n          data: {\n            materialUrls: {\n              push: uploadResult.url,\n            },\n            materialNames: {\n              push: file.originalname,\n            },\n\n          },\n        });\n      } else {\n        // For submissions, create or update WorksheetSubmission\n        const existingSubmission = await this.prisma.worksheetSubmission.findUnique({\n          where: { worksheetId },\n        });\n\n        if (existingSubmission) {\n          // Update existing submission\n          await this.prisma.worksheetSubmission.update({\n            where: { worksheetId },\n            data: {\n              fileUrls: {\n                push: uploadResult.url,\n              },\n              fileNames: {\n                push: file.originalname,\n              },\n              fileSizes: {\n                push: file.size,\n              },\n            },\n          });\n        } else {\n          // Create new submission\n          await this.prisma.worksheetSubmission.create({\n            data: {\n              worksheetId,\n              fileUrls: [uploadResult.url],\n              fileNames: [file.originalname],\n              fileSizes: [file.size],\n            },\n          });\n        }\n      }\n\n      // Return the expected response format\n      return {\n        id: uploadResult.filename, // Use the unique filename as ID\n        filename: file.originalname,\n        url: uploadResult.url,\n        fileSize: file.size,\n        fileType: file.mimetype,\n      };\n    } catch (error) {\n      if (error instanceof BadRequestException) {\n        throw error;\n      }\n\n      throw new HttpException(\n        `Failed to upload file: ${error instanceof Error ? error.message : 'Unknown error'}`,\n        HttpStatus.INTERNAL_SERVER_ERROR,\n      );\n    }\n  }\n}\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;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","ignoreList":[]}