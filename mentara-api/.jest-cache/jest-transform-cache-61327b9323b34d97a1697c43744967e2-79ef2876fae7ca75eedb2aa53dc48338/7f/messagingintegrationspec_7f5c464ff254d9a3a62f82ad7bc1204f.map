{"file":"/home/wetooa/Documents/code/projects/mentara/mentara-api/src/test-utils/integration-tests/messaging.integration.spec.ts","mappings":"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","names":[],"sources":["/home/wetooa/Documents/code/projects/mentara/mentara-api/src/test-utils/integration-tests/messaging.integration.spec.ts"],"sourcesContent":["import { Test, TestingModule } from '@nestjs/testing';\nimport { INestApplication } from '@nestjs/common';\nimport * as request from 'supertest';\nimport { PrismaService } from '../../providers/prisma-client.provider';\nimport { MessagingModule } from '../../messaging/messaging.module';\nimport { DatabaseTestSetup } from '../database-test.setup';\nimport { MessageType, ConversationType } from '@prisma/client';\n\ndescribe('Messaging Integration Tests', () => {\n  let app: INestApplication;\n  let prisma: PrismaService;\n  let moduleRef: TestingModule;\n  let clientId: string;\n  let therapistId: string;\n  let conversationId: string;\n\n  beforeAll(async () => {\n    // Setup test database\n    prisma = await DatabaseTestSetup.setupTestDatabase();\n\n    moduleRef = await Test.createTestingModule({\n      imports: [MessagingModule],\n      providers: [\n        {\n          provide: PrismaService,\n          useValue: prisma,\n        },\n      ],\n    }).compile();\n\n    app = moduleRef.createNestApplication();\n    await app.init();\n\n    // Create test users and conversation\n    await setupTestData();\n  });\n\n  afterEach(async () => {\n    // Clean messages after each test but keep users and conversation\n    await prisma.message.deleteMany();\n  });\n\n  afterAll(async () => {\n    await DatabaseTestSetup.stopContainer();\n    await app.close();\n    await moduleRef.close();\n  });\n\n  async function setupTestData() {\n    // Create users\n    const clientUser = await prisma.user.create({\n      data: {\n        id: 'client-msg-123',\n        email: 'client.msg@test.com',\n        firstName: 'Client',\n        lastName: 'User',\n        role: 'client',\n      },\n    });\n    clientId = clientUser.id;\n\n    const therapistUser = await prisma.user.create({\n      data: {\n        id: 'therapist-msg-123',\n        email: 'therapist.msg@test.com',\n        firstName: 'Therapist',\n        lastName: 'User',\n        role: 'therapist',\n      },\n    });\n    therapistId = therapistUser.id;\n\n    // Create conversation\n    const conversation = await prisma.conversation.create({\n      data: {\n        id: 'test-conversation-123',\n        type: ConversationType.DIRECT,\n      },\n    });\n    conversationId = conversation.id;\n\n    // Create conversation participants\n    await prisma.conversationParticipant.createMany({\n      data: [\n        {\n          id: 'participant-1',\n          conversationId: conversationId,\n          userId: clientId,\n          joinedAt: new Date(),\n        },\n        {\n          id: 'participant-2',\n          conversationId: conversationId,\n          userId: therapistId,\n          joinedAt: new Date(),\n        },\n      ],\n    });\n  }\n\n  describe('POST /messaging/conversations/:id/messages', () => {\n    it('should send a message successfully', async () => {\n      const messageData = {\n        content: 'Hello, this is a test message',\n        messageType: MessageType.TEXT,\n      };\n\n      const response = await request(app.getHttpServer())\n        .post(`/messaging/conversations/${conversationId}/messages`)\n        .set('x-user-id', clientId)\n        .send(messageData)\n        .expect(201);\n\n      expect(response.body).toMatchObject({\n        success: true,\n        data: expect.objectContaining({\n          id: expect.any(String),\n          content: 'Hello, this is a test message',\n          senderId: clientId,\n          conversationId: conversationId,\n          messageType: MessageType.TEXT,\n        }),\n      });\n\n      // Verify in database\n      const message = await prisma.message.findFirst({\n        where: { conversationId: conversationId },\n      });\n\n      expect(message).toBeTruthy();\n      expect(message?.content).toBe('Hello, this is a test message');\n      expect(message?.senderId).toBe(clientId);\n    });\n\n    it('should reject messages from non-participants', async () => {\n      // Create a non-participant user\n      const outsiderUser = await prisma.user.create({\n        data: {\n          id: 'outsider-123',\n          email: 'outsider@test.com',\n          firstName: 'Outsider',\n          lastName: 'User',\n          role: 'client',\n        },\n      });\n\n      const messageData = {\n        content: 'This should be rejected',\n        messageType: MessageType.TEXT,\n      };\n\n      await request(app.getHttpServer())\n        .post(`/messaging/conversations/${conversationId}/messages`)\n        .set('x-user-id', outsiderUser.id)\n        .send(messageData)\n        .expect(403);\n    });\n\n    it('should validate message content', async () => {\n      const invalidMessageData = {\n        content: '', // Empty content\n        messageType: MessageType.TEXT,\n      };\n\n      await request(app.getHttpServer())\n        .post(`/messaging/conversations/${conversationId}/messages`)\n        .set('x-user-id', clientId)\n        .send(invalidMessageData)\n        .expect(400);\n    });\n\n    it('should handle different message types', async () => {\n      const imageMessageData = {\n        content: 'image.jpg',\n        messageType: 'IMAGE',\n        metadata: JSON.stringify({\n          fileName: 'image.jpg',\n          fileSize: 1024,\n          mimeType: 'image/jpeg',\n        }),\n      };\n\n      const response = await request(app.getHttpServer())\n        .post(`/messaging/conversations/${conversationId}/messages`)\n        .set('x-user-id', clientId)\n        .send(imageMessageData)\n        .expect(201);\n\n      expect(response.body.data.messageType).toBe('IMAGE');\n      expect(JSON.parse(response.body.data.metadata || '{}')).toMatchObject({\n        fileName: 'image.jpg',\n        fileSize: 1024,\n      });\n    });\n  });\n\n  describe('GET /messaging/conversations/:id/messages', () => {\n    beforeEach(async () => {\n      // Create test messages\n      const messages = [\n        {\n          id: 'msg-1',\n          conversationId: conversationId,\n          senderId: clientId,\n          content: 'First message',\n          messageType: MessageType.TEXT,\n          createdAt: new Date('2024-01-01T10:00:00Z'),\n        },\n        {\n          id: 'msg-2',\n          conversationId: conversationId,\n          senderId: therapistId,\n          content: 'Second message',\n          messageType: MessageType.TEXT,\n          createdAt: new Date('2024-01-01T10:01:00Z'),\n        },\n        {\n          id: 'msg-3',\n          conversationId: conversationId,\n          senderId: clientId,\n          content: 'Third message',\n          messageType: MessageType.TEXT,\n          createdAt: new Date('2024-01-01T10:02:00Z'),\n        },\n      ];\n\n      await prisma.message.createMany({ data: messages });\n    });\n\n    it('should retrieve conversation messages', async () => {\n      const response = await request(app.getHttpServer())\n        .get(`/messaging/conversations/${conversationId}/messages`)\n        .set('x-user-id', clientId)\n        .expect(200);\n\n      expect(response.body.success).toBe(true);\n      expect(response.body.data).toHaveLength(3);\n\n      // Should be ordered by createdAt desc (newest first)\n      const messages = response.body.data;\n      expect(messages[0].content).toBe('Third message');\n      expect(messages[1].content).toBe('Second message');\n      expect(messages[2].content).toBe('First message');\n    });\n\n    it('should support pagination', async () => {\n      const response = await request(app.getHttpServer())\n        .get(\n          `/messaging/conversations/${conversationId}/messages?limit=2&offset=1`,\n        )\n        .set('x-user-id', clientId)\n        .expect(200);\n\n      expect(response.body.data).toHaveLength(2);\n      expect(response.body.data[0].content).toBe('Second message');\n      expect(response.body.data[1].content).toBe('First message');\n    });\n\n    it('should include sender information', async () => {\n      const response = await request(app.getHttpServer())\n        .get(`/messaging/conversations/${conversationId}/messages`)\n        .set('x-user-id', clientId)\n        .expect(200);\n\n      expect(response.body.data[0]).toMatchObject({\n        senderId: clientId,\n        sender: expect.objectContaining({\n          id: clientId,\n          firstName: 'Client',\n          lastName: 'User',\n        }),\n      });\n    });\n\n    it('should reject access from non-participants', async () => {\n      const outsiderUser = await prisma.user.create({\n        data: {\n          id: 'outsider-msg-123',\n          email: 'outsider.msg@test.com',\n          firstName: 'Outsider',\n          lastName: 'User',\n          role: 'client',\n        },\n      });\n\n      await request(app.getHttpServer())\n        .get(`/messaging/conversations/${conversationId}/messages`)\n        .set('x-user-id', outsiderUser.id)\n        .expect(403);\n    });\n  });\n\n  describe('PUT /messaging/messages/:id', () => {\n    let messageId: string;\n\n    beforeEach(async () => {\n      const message = await prisma.message.create({\n        data: {\n          id: 'editable-msg-123',\n          conversationId: conversationId,\n          senderId: clientId,\n          content: 'Original message',\n          messageType: MessageType.TEXT,\n          createdAt: new Date(),\n        },\n      });\n      messageId = message.id;\n    });\n\n    it('should edit own message successfully', async () => {\n      const updateData = {\n        content: 'Edited message content',\n      };\n\n      const response = await request(app.getHttpServer())\n        .put(`/messaging/messages/${messageId}`)\n        .set('x-user-id', clientId)\n        .send(updateData)\n        .expect(200);\n\n      expect(response.body).toMatchObject({\n        success: true,\n        data: expect.objectContaining({\n          id: messageId,\n          content: 'Edited message content',\n          isEdited: true,\n          editedAt: expect.any(String),\n        }),\n      });\n\n      // Verify in database\n      const updatedMessage = await prisma.message.findUnique({\n        where: { id: messageId },\n      });\n\n      expect(updatedMessage?.content).toBe('Edited message content');\n      expect(updatedMessage?.isEdited).toBe(true);\n      expect(updatedMessage?.editedAt).toBeTruthy();\n    });\n\n    it('should prevent editing others messages', async () => {\n      const updateData = {\n        content: 'Should not be able to edit this',\n      };\n\n      await request(app.getHttpServer())\n        .put(`/messaging/messages/${messageId}`)\n        .set('x-user-id', therapistId) // Different user\n        .send(updateData)\n        .expect(403);\n    });\n\n    it('should prevent editing old messages', async () => {\n      // Create an old message (more than edit time limit)\n      const oldMessage = await prisma.message.create({\n        data: {\n          id: 'old-msg-123',\n          conversationId: conversationId,\n          senderId: clientId,\n          content: 'Old message',\n          messageType: MessageType.TEXT,\n          createdAt: new Date(Date.now() - 25 * 60 * 60 * 1000), // 25 hours ago\n        },\n      });\n\n      const updateData = {\n        content: 'Trying to edit old message',\n      };\n\n      await request(app.getHttpServer())\n        .put(`/messaging/messages/${oldMessage.id}`)\n        .set('x-user-id', clientId)\n        .send(updateData)\n        .expect(400);\n    });\n  });\n\n  describe('DELETE /messaging/messages/:id', () => {\n    let messageId: string;\n\n    beforeEach(async () => {\n      const message = await prisma.message.create({\n        data: {\n          id: 'deletable-msg-123',\n          conversationId: conversationId,\n          senderId: clientId,\n          content: 'Message to delete',\n          messageType: MessageType.TEXT,\n          createdAt: new Date(),\n        },\n      });\n      messageId = message.id;\n    });\n\n    it('should delete own message successfully', async () => {\n      await request(app.getHttpServer())\n        .delete(`/messaging/messages/${messageId}`)\n        .set('x-user-id', clientId)\n        .expect(200);\n\n      // Verify soft deletion in database\n      const deletedMessage = await prisma.message.findUnique({\n        where: { id: messageId },\n      });\n\n      expect(deletedMessage?.isDeleted).toBe(true);\n    });\n\n    it('should prevent deleting others messages', async () => {\n      await request(app.getHttpServer())\n        .delete(`/messaging/messages/${messageId}`)\n        .set('x-user-id', therapistId) // Different user\n        .expect(403);\n    });\n\n    it('should handle already deleted messages', async () => {\n      // First deletion\n      await request(app.getHttpServer())\n        .delete(`/messaging/messages/${messageId}`)\n        .set('x-user-id', clientId)\n        .expect(200);\n\n      // Second deletion attempt\n      await request(app.getHttpServer())\n        .delete(`/messaging/messages/${messageId}`)\n        .set('x-user-id', clientId)\n        .expect(400);\n    });\n  });\n\n  describe('Message Read Receipts', () => {\n    let messageId: string;\n\n    beforeEach(async () => {\n      const message = await prisma.message.create({\n        data: {\n          id: 'readable-msg-123',\n          conversationId: conversationId,\n          senderId: clientId,\n          content: 'Message to mark as read',\n          messageType: MessageType.TEXT,\n        },\n      });\n      messageId = message.id;\n    });\n\n    it('should mark message as read', async () => {\n      await request(app.getHttpServer())\n        .post(`/messaging/messages/${messageId}/read`)\n        .set('x-user-id', therapistId)\n        .expect(200);\n\n      // Verify read receipt in database\n      const readReceipt = await prisma.messageReadReceipt.findFirst({\n        where: {\n          messageId: messageId,\n          userId: therapistId,\n        },\n      });\n\n      expect(readReceipt).toBeTruthy();\n      expect(readReceipt?.readAt).toBeTruthy();\n    });\n\n    it('should handle duplicate read receipts', async () => {\n      // First read\n      await request(app.getHttpServer())\n        .post(`/messaging/messages/${messageId}/read`)\n        .set('x-user-id', therapistId)\n        .expect(200);\n\n      // Second read (should be idempotent)\n      await request(app.getHttpServer())\n        .post(`/messaging/messages/${messageId}/read`)\n        .set('x-user-id', therapistId)\n        .expect(200);\n\n      // Should still have only one read receipt\n      const readReceipts = await prisma.messageReadReceipt.findMany({\n        where: {\n          messageId: messageId,\n          userId: therapistId,\n        },\n      });\n\n      expect(readReceipts).toHaveLength(1);\n    });\n\n    it('should not allow marking own messages as read', async () => {\n      await request(app.getHttpServer())\n        .post(`/messaging/messages/${messageId}/read`)\n        .set('x-user-id', clientId) // Same as sender\n        .expect(400);\n    });\n  });\n\n  describe('Performance and Concurrency', () => {\n    it('should handle concurrent message sending', async () => {\n      const messagePromises = Array.from({ length: 10 }, (_, i) =>\n        request(app.getHttpServer())\n          .post(`/messaging/conversations/${conversationId}/messages`)\n          .set('x-user-id', i % 2 === 0 ? clientId : therapistId)\n          .send({\n            content: `Concurrent message ${i}`,\n            messageType: MessageType.TEXT,\n          }),\n      );\n\n      const results = await Promise.allSettled(messagePromises);\n      const successful = results.filter(\n        (r) => r.status === 'fulfilled' && (r.value as any).status === 201,\n      );\n\n      expect(successful.length).toBe(10); // All should succeed\n    });\n\n    it('should maintain message order consistency', async () => {\n      // Send messages sequentially\n      const messageContents = ['First', 'Second', 'Third', 'Fourth', 'Fifth'];\n\n      for (const content of messageContents) {\n        await request(app.getHttpServer())\n          .post(`/messaging/conversations/${conversationId}/messages`)\n          .set('x-user-id', clientId)\n          .send({\n            content: content,\n            messageType: MessageType.TEXT,\n          });\n      }\n\n      // Retrieve messages\n      const response = await request(app.getHttpServer())\n        .get(`/messaging/conversations/${conversationId}/messages`)\n        .set('x-user-id', clientId)\n        .expect(200);\n\n      const messages = response.body.data;\n      expect(messages).toHaveLength(5);\n\n      // Should be in reverse chronological order (newest first)\n      expect(messages[0].content).toBe('Fifth');\n      expect(messages[4].content).toBe('First');\n    });\n\n    it('should handle large conversation history efficiently', async () => {\n      // Create many messages\n      const messages = Array.from({ length: 100 }, (_, i) => ({\n        id: `bulk-msg-${i}`,\n        conversationId: conversationId,\n        senderId: i % 2 === 0 ? clientId : therapistId,\n        content: `Bulk message ${i}`,\n        messageType: MessageType.TEXT,\n        createdAt: new Date(Date.now() + i * 1000),\n      }));\n\n      await prisma.message.createMany({ data: messages });\n\n      const startTime = Date.now();\n\n      const response = await request(app.getHttpServer())\n        .get(`/messaging/conversations/${conversationId}/messages?limit=20`)\n        .set('x-user-id', clientId)\n        .expect(200);\n\n      const endTime = Date.now();\n      const duration = endTime - startTime;\n\n      expect(response.body.data).toHaveLength(20);\n      expect(duration).toBeLessThan(1000); // Should complete within 1 second\n    });\n  });\n\n  describe('Edge Cases', () => {\n    it('should handle non-existent conversation', async () => {\n      await request(app.getHttpServer())\n        .get('/messaging/conversations/non-existent-id/messages')\n        .set('x-user-id', clientId)\n        .expect(404);\n    });\n\n    it('should handle non-existent message', async () => {\n      await request(app.getHttpServer())\n        .put('/messaging/messages/non-existent-id')\n        .set('x-user-id', clientId)\n        .send({ content: 'Updated content' })\n        .expect(404);\n    });\n\n    it('should validate message content length', async () => {\n      const longContent = 'a'.repeat(10001); // Exceed max length\n\n      await request(app.getHttpServer())\n        .post(`/messaging/conversations/${conversationId}/messages`)\n        .set('x-user-id', clientId)\n        .send({\n          content: longContent,\n          messageType: MessageType.TEXT,\n        })\n        .expect(400);\n    });\n\n    it('should handle malformed JSON metadata', async () => {\n      await request(app.getHttpServer())\n        .post(`/messaging/conversations/${conversationId}/messages`)\n        .set('x-user-id', clientId)\n        .send({\n          content: 'Message with invalid metadata',\n          messageType: 'FILE',\n          metadata: 'invalid-json-string',\n        })\n        .expect(400);\n    });\n  });\n});\n"],"version":3}