6ff9d8859450b0880b1b0c05de44ea4f
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var __param = (this && this.__param) || function (paramIndex, decorator) {
    return function (target, key) { decorator(target, key, paramIndex); }
};
var _a, _b;
Object.defineProperty(exports, "__esModule", { value: true });
exports.MessagingController = void 0;
const common_1 = require("@nestjs/common");
const platform_express_1 = require("@nestjs/platform-express");
const messaging_service_1 = require("./messaging.service");
const jwt_auth_guard_1 = require("../auth/guards/jwt-auth.guard");
const current_user_id_decorator_1 = require("../auth/decorators/current-user-id.decorator");
const supabase_storage_service_1 = require("../common/services/supabase-storage.service");
let MessagingController = class MessagingController {
    messagingService;
    supabaseStorageService;
    constructor(messagingService, supabaseStorageService) {
        this.messagingService = messagingService;
        this.supabaseStorageService = supabaseStorageService;
    }
    // Health check endpoint for WebSocket connectivity
    async checkHealth(userId) {
        return {
            success: true,
            message: 'Messaging service is healthy',
            timestamp: new Date().toISOString(),
            userId,
            environment: process.env.NODE_ENV || 'unknown',
            frontendUrl: process.env.FRONTEND_URL || 'not_configured',
        };
    }
    // Conversation endpoints
    async createConversation(userId, createConversationDto) {
        return this.messagingService.createConversation(userId, createConversationDto);
    }
    async getUserConversations(userId, params) {
        console.log('ðŸš€ [MESSAGING CONTROLLER] getUserConversations endpoint called');
        console.log('ðŸ‘¤ [USER ID]', userId);
        console.log('ðŸ“Š [QUERY PARAMS]', params);
        try {
            const result = await this.messagingService.getUserConversations(userId, params.page || 1, params.limit || 20);
            console.log('âœ… [CONTROLLER RESPONSE] Returning', result.length, 'conversations');
            console.log('ðŸ“ [RESPONSE SUMMARY]:', result.map((conv) => ({
                id: conv.id,
                type: conv.type,
                title: conv.title,
                participantCount: conv.participants?.length || 0,
                messageCount: conv.messages?.length || 0,
            })));
            return result;
        }
        catch (error) {
            console.error('âŒ [CONTROLLER ERROR] getUserConversations failed:', error);
            throw error;
        }
    }
    async getRecentCommunications(userId, limit) {
        console.log('ðŸ“ž [MESSAGING CONTROLLER] getRecentCommunications endpoint called');
        console.log('ðŸ‘¤ [USER ID]', userId);
        console.log('ðŸ“Š [LIMIT]', limit);
        try {
            const limitNum = limit ? Number(limit) : 5;
            const result = await this.messagingService.getRecentCommunications(userId, limitNum);
            console.log('âœ… [CONTROLLER RESPONSE] Returning', result.length, 'recent communications');
            console.log('ðŸ“± [RESPONSE SUMMARY]:', result.map(comm => ({
                id: comm?.id,
                name: comm?.name,
                role: comm?.role,
                hasLastMessage: !!comm?.lastMessage,
                unreadCount: comm?.unreadCount
            })));
            return result;
        }
        catch (error) {
            console.error('âŒ [CONTROLLER ERROR] getRecentCommunications failed:', error);
            throw error;
        }
    }
    async getConversationMessages(userId, conversationId, params) {
        const pageNum = params.page || 1;
        const limitNum = params.limit || 50;
        return this.messagingService.getConversationMessages(userId, conversationId, pageNum, limitNum);
    }
    // Message endpoints
    async sendMessage(userId, conversationId, sendMessageDto, files = []) {
        // Validate and upload files if provided
        const fileResults = [];
        if (files && files.length > 0) {
            for (const file of files) {
                const validation = this.supabaseStorageService.validateFile(file);
                if (!validation.isValid) {
                    throw new common_1.HttpException(`File validation failed: ${validation.error}`, common_1.HttpStatus.BAD_REQUEST);
                }
            }
            // Upload files to Supabase
            const uploadResults = await this.supabaseStorageService.uploadFiles(files, supabase_storage_service_1.SupabaseStorageService.getSupportedBuckets().MESSAGES);
            fileResults.push(...uploadResults);
        }
        return this.messagingService.sendMessage(userId, conversationId, sendMessageDto, fileResults.map((f) => f.url), fileResults.map((f) => f.filename), files.map((f) => f.size));
    }
    async updateMessage(userId, messageId, updateMessageDto) {
        return this.messagingService.updateMessage(userId, messageId, updateMessageDto);
    }
    async deleteMessage(userId, messageId) {
        return this.messagingService.deleteMessage(userId, messageId);
    }
    // Read receipts
    async markMessageAsRead(userId, messageId) {
        return this.messagingService.markMessageAsRead(userId, messageId);
    }
    // Message reactions
    async addMessageReaction(userId, messageId, addReactionDto) {
        return this.messagingService.addMessageReaction(userId, messageId, addReactionDto.emoji);
    }
    async removeMessageReaction(userId, messageId, emoji) {
        return this.messagingService.removeMessageReaction(userId, messageId, emoji);
    }
    // User blocking
    async blockUser(userId, blockUserDto) {
        return this.messagingService.blockUser(userId, blockUserDto.userId, blockUserDto.reason);
    }
    async unblockUser(userId, blockedUserId) {
        return this.messagingService.unblockUser(userId, blockedUserId);
    }
    // Search messages
    async searchMessages(userId, searchDto) {
        const { query, conversationId, page, limit } = searchDto;
        const pageNum = page ? Number(page) : 1;
        const limitNum = limit ? Number(limit) : 20;
        return this.messagingService.searchMessages(userId, query || '', conversationId, pageNum, limitNum);
    }
};
exports.MessagingController = MessagingController;
__decorate([
    (0, common_1.Get)('health'),
    (0, common_1.HttpCode)(common_1.HttpStatus.OK),
    __param(0, (0, current_user_id_decorator_1.CurrentUserId)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [String]),
    __metadata("design:returntype", Promise)
], MessagingController.prototype, "checkHealth", null);
__decorate([
    (0, common_1.Post)('conversations'),
    (0, common_1.HttpCode)(common_1.HttpStatus.CREATED),
    __param(0, (0, current_user_id_decorator_1.CurrentUserId)()),
    __param(1, (0, common_1.Body)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [String, Object]),
    __metadata("design:returntype", Promise)
], MessagingController.prototype, "createConversation", null);
__decorate([
    (0, common_1.Get)('conversations'),
    __param(0, (0, current_user_id_decorator_1.CurrentUserId)()),
    __param(1, (0, common_1.Query)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [String, Object]),
    __metadata("design:returntype", Promise)
], MessagingController.prototype, "getUserConversations", null);
__decorate([
    (0, common_1.Get)('recent-communications'),
    __param(0, (0, current_user_id_decorator_1.CurrentUserId)()),
    __param(1, (0, common_1.Query)('limit')),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [String, String]),
    __metadata("design:returntype", Promise)
], MessagingController.prototype, "getRecentCommunications", null);
__decorate([
    (0, common_1.Get)('conversations/:conversationId/messages'),
    __param(0, (0, current_user_id_decorator_1.CurrentUserId)()),
    __param(1, (0, common_1.Param)('conversationId')),
    __param(2, (0, common_1.Query)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [String, String, Object]),
    __metadata("design:returntype", Promise)
], MessagingController.prototype, "getConversationMessages", null);
__decorate([
    (0, common_1.Post)('conversations/:conversationId/messages'),
    (0, common_1.UseInterceptors)((0, platform_express_1.FilesInterceptor)('files', 3)) // Support up to 3 files
    ,
    (0, common_1.HttpCode)(common_1.HttpStatus.CREATED),
    __param(0, (0, current_user_id_decorator_1.CurrentUserId)()),
    __param(1, (0, common_1.Param)('conversationId')),
    __param(2, (0, common_1.Body)()),
    __param(3, (0, common_1.UploadedFiles)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [String, String, Object, Array]),
    __metadata("design:returntype", Promise)
], MessagingController.prototype, "sendMessage", null);
__decorate([
    (0, common_1.Put)('messages/:messageId'),
    __param(0, (0, current_user_id_decorator_1.CurrentUserId)()),
    __param(1, (0, common_1.Param)('messageId')),
    __param(2, (0, common_1.Body)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [String, String, Object]),
    __metadata("design:returntype", Promise)
], MessagingController.prototype, "updateMessage", null);
__decorate([
    (0, common_1.Delete)('messages/:messageId'),
    (0, common_1.HttpCode)(common_1.HttpStatus.NO_CONTENT),
    __param(0, (0, current_user_id_decorator_1.CurrentUserId)()),
    __param(1, (0, common_1.Param)('messageId')),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [String, String]),
    __metadata("design:returntype", Promise)
], MessagingController.prototype, "deleteMessage", null);
__decorate([
    (0, common_1.Post)('messages/:messageId/read'),
    (0, common_1.HttpCode)(common_1.HttpStatus.OK),
    __param(0, (0, current_user_id_decorator_1.CurrentUserId)()),
    __param(1, (0, common_1.Param)('messageId')),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [String, String]),
    __metadata("design:returntype", Promise)
], MessagingController.prototype, "markMessageAsRead", null);
__decorate([
    (0, common_1.Post)('messages/:messageId/reactions'),
    (0, common_1.HttpCode)(common_1.HttpStatus.CREATED),
    __param(0, (0, current_user_id_decorator_1.CurrentUserId)()),
    __param(1, (0, common_1.Param)('messageId')),
    __param(2, (0, common_1.Body)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [String, String, Object]),
    __metadata("design:returntype", Promise)
], MessagingController.prototype, "addMessageReaction", null);
__decorate([
    (0, common_1.Delete)('messages/:messageId/reactions/:emoji'),
    (0, common_1.HttpCode)(common_1.HttpStatus.NO_CONTENT),
    __param(0, (0, current_user_id_decorator_1.CurrentUserId)()),
    __param(1, (0, common_1.Param)('messageId')),
    __param(2, (0, common_1.Param)('emoji')),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [String, String, String]),
    __metadata("design:returntype", Promise)
], MessagingController.prototype, "removeMessageReaction", null);
__decorate([
    (0, common_1.Post)('block'),
    (0, common_1.HttpCode)(common_1.HttpStatus.CREATED),
    __param(0, (0, current_user_id_decorator_1.CurrentUserId)()),
    __param(1, (0, common_1.Body)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [String, Object]),
    __metadata("design:returntype", Promise)
], MessagingController.prototype, "blockUser", null);
__decorate([
    (0, common_1.Delete)('block/:blockedUserId'),
    (0, common_1.HttpCode)(common_1.HttpStatus.NO_CONTENT),
    __param(0, (0, current_user_id_decorator_1.CurrentUserId)()),
    __param(1, (0, common_1.Param)('blockedUserId')),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [String, String]),
    __metadata("design:returntype", Promise)
], MessagingController.prototype, "unblockUser", null);
__decorate([
    (0, common_1.Get)('search'),
    __param(0, (0, current_user_id_decorator_1.CurrentUserId)()),
    __param(1, (0, common_1.Query)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [String, Object]),
    __metadata("design:returntype", Promise)
], MessagingController.prototype, "searchMessages", null);
exports.MessagingController = MessagingController = __decorate([
    (0, common_1.Controller)('messaging'),
    (0, common_1.UseGuards)(jwt_auth_guard_1.JwtAuthGuard),
    __metadata("design:paramtypes", [typeof (_a = typeof messaging_service_1.MessagingService !== "undefined" && messaging_service_1.MessagingService) === "function" ? _a : Object, typeof (_b = typeof supabase_storage_service_1.SupabaseStorageService !== "undefined" && supabase_storage_service_1.SupabaseStorageService) === "function" ? _b : Object])
], MessagingController);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL21lc3NhZ2luZy9tZXNzYWdpbmcuY29udHJvbGxlci50cyIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsMkNBZXdCO0FBQ3hCLCtEQUE0RDtBQUM1RCwyREFBdUQ7QUFDdkQsa0VBQTZEO0FBQzdELDRGQUE2RTtBQUM3RSwwRkFHcUQ7QUFhOUMsSUFBTSxtQkFBbUIsR0FBekIsTUFBTSxtQkFBbUI7SUFFWDtJQUNBO0lBRm5CLFlBQ21CLGdCQUFrQyxFQUNsQyxzQkFBOEM7UUFEOUMscUJBQWdCLEdBQWhCLGdCQUFnQixDQUFrQjtRQUNsQywyQkFBc0IsR0FBdEIsc0JBQXNCLENBQXdCO0lBQzlELENBQUM7SUFFSixtREFBbUQ7SUFHN0MsQUFBTixLQUFLLENBQUMsV0FBVyxDQUFrQixNQUFjO1FBQy9DLE9BQU87WUFDTCxPQUFPLEVBQUUsSUFBSTtZQUNiLE9BQU8sRUFBRSw4QkFBOEI7WUFDdkMsU0FBUyxFQUFFLElBQUksSUFBSSxFQUFFLENBQUMsV0FBVyxFQUFFO1lBQ25DLE1BQU07WUFDTixXQUFXLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxRQUFRLElBQUksU0FBUztZQUM5QyxXQUFXLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxZQUFZLElBQUksZ0JBQWdCO1NBQzFELENBQUM7SUFDSixDQUFDO0lBRUQseUJBQXlCO0lBR25CLEFBQU4sS0FBSyxDQUFDLGtCQUFrQixDQUNMLE1BQWMsRUFDdkIscUJBQTRDO1FBRXBELE9BQU8sSUFBSSxDQUFDLGdCQUFnQixDQUFDLGtCQUFrQixDQUM3QyxNQUFNLEVBQ04scUJBQXFCLENBQ3RCLENBQUM7SUFDSixDQUFDO0lBR0ssQUFBTixLQUFLLENBQUMsb0JBQW9CLENBQ1AsTUFBYyxFQUN0QixNQUE4QjtRQUV2QyxPQUFPLENBQUMsR0FBRyxDQUNULGdFQUFnRSxDQUNqRSxDQUFDO1FBQ0YsT0FBTyxDQUFD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O0FBSUs7SUFGTCxJQUFBLGVBQU0sRUFBQyxzQkFBc0IsQ0FBQztJQUM5QixJQUFBLGlCQUFRLEVBQUMsbUJBQVUsQ0FBQyxVQUFVLENBQUM7SUFFN0IsV0FBQSxJQUFBLHlDQUFhLEdBQUUsQ0FBQTtJQUNmLFdBQUEsSUFBQSxjQUFLLEVBQUMsZUFBZSxDQUFDLENBQUE7Ozs7c0RBR3hCO0FBSUs7SUFETCxJQUFBLFlBQUcsRUFBQyxRQUFRLENBQUM7SUFFWCxXQUFBLElBQUEseUNBQWEsR0FBRSxDQUFBO0lBQ2YsV0FBQSxJQUFBLGNBQUssR0FBRSxDQUFBOzs7O3lEQVlUOzhCQTFRVSxtQkFBbUI7SUFGL0IsSUFBQSxtQkFBVSxFQUFDLFdBQVcsQ0FBQztJQUN2QixJQUFBLGtCQUFTLEVBQUMsNkJBQVksQ0FBQzt5REFHZSxvQ0FBZ0Isb0JBQWhCLG9DQUFnQixvREFDVixpREFBc0Isb0JBQXRCLGlEQUFzQjtHQUh0RCxtQkFBbUIsQ0EyUS9CIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9ob21lL3dldG9vYS9Eb2N1bWVudHMvY29kZS9wcm9qZWN0cy9tZW50YXJhL21lbnRhcmEtYXBpL3NyYy9tZXNzYWdpbmcvbWVzc2FnaW5nLmNvbnRyb2xsZXIudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgQ29udHJvbGxlcixcbiAgR2V0LFxuICBQb3N0LFxuICBQdXQsXG4gIERlbGV0ZSxcbiAgUGFyYW0sXG4gIFF1ZXJ5LFxuICBCb2R5LFxuICBVc2VHdWFyZHMsXG4gIFVzZUludGVyY2VwdG9ycyxcbiAgVXBsb2FkZWRGaWxlcyxcbiAgSHR0cENvZGUsXG4gIEh0dHBTdGF0dXMsXG4gIEh0dHBFeGNlcHRpb24sXG59IGZyb20gJ0BuZXN0anMvY29tbW9uJztcbmltcG9ydCB7IEZpbGVzSW50ZXJjZXB0b3IgfSBmcm9tICdAbmVzdGpzL3BsYXRmb3JtLWV4cHJlc3MnO1xuaW1wb3J0IHsgTWVzc2FnaW5nU2VydmljZSB9IGZyb20gJy4vbWVzc2FnaW5nLnNlcnZpY2UnO1xuaW1wb3J0IHsgSnd0QXV0aEd1YXJkIH0gZnJvbSAnLi4vYXV0aC9ndWFyZHMvand0LWF1dGguZ3VhcmQnO1xuaW1wb3J0IHsgQ3VycmVudFVzZXJJZCB9IGZyb20gJy4uL2F1dGgvZGVjb3JhdG9ycy9jdXJyZW50LXVzZXItaWQuZGVjb3JhdG9yJztcbmltcG9ydCB7XG4gIFN1cGFiYXNlU3RvcmFnZVNlcnZpY2UsXG4gIEZpbGVVcGxvYWRSZXN1bHQsXG59IGZyb20gJy4uL2NvbW1vbi9zZXJ2aWNlcy9zdXBhYmFzZS1zdG9yYWdlLnNlcnZpY2UnO1xuaW1wb3J0IHR5cGUge1xuICBDcmVhdGVDb252ZXJzYXRpb25EdG8sXG4gIFNlbmRNZXNzYWdlRHRvLFxuICBVcGRhdGVNZXNzYWdlRHRvLFxuICBBZGRSZWFjdGlvbkR0byxcbiAgQmxvY2tVc2VyRHRvLFxuICBTZWFyY2hNZXNzYWdlc0R0byxcbiAgQ29udmVyc2F0aW9uTGlzdFBhcmFtcyxcbn0gZnJvbSAnLi90eXBlcyc7XG5cbkBDb250cm9sbGVyKCdtZXNzYWdpbmcnKVxuQFVzZUd1YXJkcyhKd3RBdXRoR3VhcmQpXG5leHBvcnQgY2xhc3MgTWVzc2FnaW5nQ29udHJvbGxlciB7XG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgcmVhZG9ubHkgbWVzc2FnaW5nU2VydmljZTogTWVzc2FnaW5nU2VydmljZSxcbiAgICBwcml2YXRlIHJlYWRvbmx5IHN1cGFiYXNlU3RvcmFnZVNlcnZpY2U6IFN1cGFiYXNlU3RvcmFnZVNlcnZpY2UsXG4gICkge31cblxuICAvLyBIZWFsdGggY2hlY2sgZW5kcG9pbnQgZm9yIFdlYlNvY2tldCBjb25uZWN0aXZpdHlcbiAgQEdldCgnaGVhbHRoJylcbiAgQEh0dHBDb2RlKEh0dHBTdGF0dXMuT0spXG4gIGFzeW5jIGNoZWNrSGVhbHRoKEBDdXJyZW50VXNlcklkKCkgdXNlcklkOiBzdHJpbmcpIHtcbiAgICByZXR1cm4ge1xuICAgICAgc3VjY2VzczogdHJ1ZSxcbiAgICAgIG1lc3NhZ2U6ICdNZXNzYWdpbmcgc2VydmljZSBpcyBoZWFsdGh5JyxcbiAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLFxuICAgICAgdXNlcklkLFxuICAgICAgZW52aXJvbm1lbnQ6IHByb2Nlc3MuZW52Lk5PREVfRU5WIHx8ICd1bmtub3duJyxcbiAgICAgIGZyb250ZW5kVXJsOiBwcm9jZXNzLmVudi5GUk9OVEVORF9VUkwgfHwgJ25vdF9jb25maWd1cmVkJyxcbiAgICB9O1xuICB9XG5cbiAgLy8gQ29udmVyc2F0aW9uIGVuZHBvaW50c1xuICBAUG9zdCgnY29udmVyc2F0aW9ucycpXG4gIEBIdHRwQ29kZShIdHRwU3RhdHVzLkNSRUFURUQpXG4gIGFzeW5jIGNyZWF0ZUNvbnZlcnNhdGlvbihcbiAgICBAQ3VycmVudFVzZXJJZCgpIHVzZXJJZDogc3RyaW5nLFxuICAgIEBCb2R5KCkgY3JlYXRlQ29udmVyc2F0aW9uRHRvOiBDcmVhdGVDb252ZXJzYXRpb25EdG8sXG4gICkge1xuICAgIHJldHVybiB0aGlzLm1lc3NhZ2luZ1NlcnZpY2UuY3JlYXRlQ29udmVyc2F0aW9uKFxuICAgICAgdXNlcklkLFxuICAgICAgY3JlYXRlQ29udmVyc2F0aW9uRHRvLFxuICAgICk7XG4gIH1cblxuICBAR2V0KCdjb252ZXJzYXRpb25zJylcbiAgYXN5bmMgZ2V0VXNlckNvbnZlcnNhdGlvbnMoXG4gICAgQEN1cnJlbnRVc2VySWQoKSB1c2VySWQ6IHN0cmluZyxcbiAgICBAUXVlcnkoKSBwYXJhbXM6IENvbnZlcnNhdGlvbkxpc3RQYXJhbXMsXG4gICkge1xuICAgIGNvbnNvbGUubG9nKFxuICAgICAgJ/CfmoAgW01FU1NBR0lORyBDT05UUk9MTEVSXSBnZXRVc2VyQ29udmVyc2F0aW9ucyBlbmRwb2ludCBjYWxsZWQnLFxuICAgICk7XG4gICAgY29uc29sZS5sb2coJ/CfkaQgW1VTRVIgSURdJywgdXNlcklkKTtcbiAgICBjb25zb2xlLmxvZygn8J+TiiBbUVVFUlkgUEFSQU1TXScsIHBhcmFtcyk7XG5cbiAgICB0cnkge1xuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgdGhpcy5tZXNzYWdpbmdTZXJ2aWNlLmdldFVzZXJDb252ZXJzYXRpb25zKFxuICAgICAgICB1c2VySWQsXG4gICAgICAgIHBhcmFtcy5wYWdlIHx8IDEsXG4gICAgICAgIHBhcmFtcy5saW1pdCB8fCAyMCxcbiAgICAgICk7XG5cbiAgICAgIGNvbnNvbGUubG9nKFxuICAgICAgICAn4pyFIFtDT05UUk9MTEVSIFJFU1BPTlNFXSBSZXR1cm5pbmcnLFxuICAgICAgICByZXN1bHQubGVuZ3RoLFxuICAgICAgICAnY29udmVyc2F0aW9ucycsXG4gICAgICApO1xuICAgICAgY29uc29sZS5sb2coXG4gICAgICAgICfwn5OdIFtSRVNQT05TRSBTVU1NQVJZXTonLFxuICAgICAgICByZXN1bHQubWFwKChjb252KSA9PiAoe1xuICAgICAgICAgIGlkOiBjb252LmlkLFxuICAgICAgICAgIHR5cGU6IGNvbnYudHlwZSxcbiAgICAgICAgICB0aXRsZTogY29udi50aXRsZSxcbiAgICAgICAgICBwYXJ0aWNpcGFudENvdW50OiBjb252LnBhcnRpY2lwYW50cz8ubGVuZ3RoIHx8IDAsXG4gICAgICAgICAgbWVzc2FnZUNvdW50OiBjb252Lm1lc3NhZ2VzPy5sZW5ndGggfHwgMCxcbiAgICAgICAgfSkpLFxuICAgICAgKTtcblxuICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc29sZS5lcnJvcihcbiAgICAgICAgJ+KdjCBbQ09OVFJPTExFUiBFUlJPUl0gZ2V0VXNlckNvbnZlcnNhdGlvbnMgZmFpbGVkOicsXG4gICAgICAgIGVycm9yLFxuICAgICAgKTtcbiAgICAgIHRocm93IGVycm9yO1xuICAgIH1cbiAgfVxuXG4gIEBHZXQoJ3JlY2VudC1jb21tdW5pY2F0aW9ucycpXG4gIGFzeW5jIGdldFJlY2VudENvbW11bmljYXRpb25zKFxuICAgIEBDdXJyZW50VXNlcklkKCkgdXNlcklkOiBzdHJpbmcsXG4gICAgQFF1ZXJ5KCdsaW1pdCcpIGxpbWl0Pzogc3RyaW5nLFxuICApIHtcbiAgICBjb25zb2xlLmxvZygn8J+TniBbTUVTU0FHSU5HIENPTlRST0xMRVJdIGdldFJlY2VudENvbW11bmljYXRpb25zIGVuZHBvaW50IGNhbGxlZCcpO1xuICAgIGNvbnNvbGUubG9nKCfwn5GkIFtVU0VSIElEXScsIHVzZXJJZCk7XG4gICAgY29uc29sZS5sb2coJ/Cfk4ogW0xJTUlUXScsIGxpbWl0KTtcbiAgICBcbiAgICB0cnkge1xuICAgICAgY29uc3QgbGltaXROdW0gPSBsaW1pdCA/IE51bWJlcihsaW1pdCkgOiA1O1xuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgdGhpcy5tZXNzYWdpbmdTZXJ2aWNlLmdldFJlY2VudENvbW11bmljYXRpb25zKFxuICAgICAgICB1c2VySWQsXG4gICAgICAgIGxpbWl0TnVtLFxuICAgICAgKTtcbiAgICAgIFxuICAgICAgY29uc29sZS5sb2coJ+KchSBbQ09OVFJPTExFUiBSRVNQT05TRV0gUmV0dXJuaW5nJywgcmVzdWx0Lmxlbmd0aCwgJ3JlY2VudCBjb21tdW5pY2F0aW9ucycpO1xuICAgICAgY29uc29sZS5sb2coJ/Cfk7EgW1JFU1BPTlNFIFNVTU1BUlldOicsIHJlc3VsdC5tYXAoY29tbSA9PiAoe1xuICAgICAgICBpZDogY29tbT8uaWQsXG4gICAgICAgIG5hbWU6IGNvbW0/Lm5hbWUsXG4gICAgICAgIHJvbGU6IGNvbW0/LnJvbGUsXG4gICAgICAgIGhhc0xhc3RNZXNzYWdlOiAhIWNvbW0/Lmxhc3RNZXNzYWdlLFxuICAgICAgICB1bnJlYWRDb3VudDogY29tbT8udW5yZWFkQ291bnRcbiAgICAgIH0pKSk7XG4gICAgICBcbiAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ+KdjCBbQ09OVFJPTExFUiBFUlJPUl0gZ2V0UmVjZW50Q29tbXVuaWNhdGlvbnMgZmFpbGVkOicsIGVycm9yKTtcbiAgICAgIHRocm93IGVycm9yO1xuICAgIH1cbiAgfVxuXG4gIEBHZXQoJ2NvbnZlcnNhdGlvbnMvOmNvbnZlcnNhdGlvbklkL21lc3NhZ2VzJylcbiAgYXN5bmMgZ2V0Q29udmVyc2F0aW9uTWVzc2FnZXMoXG4gICAgQEN1cnJlbnRVc2VySWQoKSB1c2VySWQ6IHN0cmluZyxcbiAgICBAUGFyYW0oJ2NvbnZlcnNhdGlvbklkJykgY29udmVyc2F0aW9uSWQ6IHN0cmluZyxcbiAgICBAUXVlcnkoKSBwYXJhbXM6IENvbnZlcnNhdGlvbkxpc3RQYXJhbXMsXG4gICkge1xuICAgIGNvbnN0IHBhZ2VOdW0gPSBwYXJhbXMucGFnZSB8fCAxO1xuICAgIGNvbnN0IGxpbWl0TnVtID0gcGFyYW1zLmxpbWl0IHx8IDUwO1xuICAgIHJldHVybiB0aGlzLm1lc3NhZ2luZ1NlcnZpY2UuZ2V0Q29udmVyc2F0aW9uTWVzc2FnZXMoXG4gICAgICB1c2VySWQsXG4gICAgICBjb252ZXJzYXRpb25JZCxcbiAgICAgIHBhZ2VOdW0sXG4gICAgICBsaW1pdE51bSxcbiAgICApO1xuICB9XG5cbiAgLy8gTWVzc2FnZSBlbmRwb2ludHNcbiAgQFBvc3QoJ2NvbnZlcnNhdGlvbnMvOmNvbnZlcnNhdGlvbklkL21lc3NhZ2VzJylcbiAgQFVzZUludGVyY2VwdG9ycyhGaWxlc0ludGVyY2VwdG9yKCdmaWxlcycsIDMpKSAvLyBTdXBwb3J0IHVwIHRvIDMgZmlsZXNcbiAgQEh0dHBDb2RlKEh0dHBTdGF0dXMuQ1JFQVRFRClcbiAgYXN5bmMgc2VuZE1lc3NhZ2UoXG4gICAgQEN1cnJlbnRVc2VySWQoKSB1c2VySWQ6IHN0cmluZyxcbiAgICBAUGFyYW0oJ2NvbnZlcnNhdGlvbklkJykgY29udmVyc2F0aW9uSWQ6IHN0cmluZyxcbiAgICBAQm9keSgpIHNlbmRNZXNzYWdlRHRvOiBTZW5kTWVzc2FnZUR0byxcbiAgICBAVXBsb2FkZWRGaWxlcygpIGZpbGVzOiBFeHByZXNzLk11bHRlci5GaWxlW10gPSBbXSwgLy8gT3B0aW9uYWwgZmlsZXNcbiAgKSB7XG4gICAgLy8gVmFsaWRhdGUgYW5kIHVwbG9hZCBmaWxlcyBpZiBwcm92aWRlZFxuICAgIGNvbnN0IGZpbGVSZXN1bHRzOiBGaWxlVXBsb2FkUmVzdWx0W10gPSBbXTtcbiAgICBpZiAoZmlsZXMgJiYgZmlsZXMubGVuZ3RoID4gMCkge1xuICAgICAgZm9yIChjb25zdCBmaWxlIG9mIGZpbGVzKSB7XG4gICAgICAgIGNvbnN0IHZhbGlkYXRpb24gPSB0aGlzLnN1cGFiYXNlU3RvcmFnZVNlcnZpY2UudmFsaWRhdGVGaWxlKGZpbGUpO1xuICAgICAgICBpZiAoIXZhbGlkYXRpb24uaXNWYWxpZCkge1xuICAgICAgICAgIHRocm93IG5ldyBIdHRwRXhjZXB0aW9uKFxuICAgICAgICAgICAgYEZpbGUgdmFsaWRhdGlvbiBmYWlsZWQ6ICR7dmFsaWRhdGlvbi5lcnJvcn1gLFxuICAgICAgICAgICAgSHR0cFN0YXR1cy5CQURfUkVRVUVTVCxcbiAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIC8vIFVwbG9hZCBmaWxlcyB0byBTdXBhYmFzZVxuICAgICAgY29uc3QgdXBsb2FkUmVzdWx0cyA9IGF3YWl0IHRoaXMuc3VwYWJhc2VTdG9yYWdlU2VydmljZS51cGxvYWRGaWxlcyhcbiAgICAgICAgZmlsZXMsXG4gICAgICAgIFN1cGFiYXNlU3RvcmFnZVNlcnZpY2UuZ2V0U3VwcG9ydGVkQnVja2V0cygpLk1FU1NBR0VTLFxuICAgICAgKTtcbiAgICAgIGZpbGVSZXN1bHRzLnB1c2goLi4udXBsb2FkUmVzdWx0cyk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXMubWVzc2FnaW5nU2VydmljZS5zZW5kTWVzc2FnZShcbiAgICAgIHVzZXJJZCxcbiAgICAgIGNvbnZlcnNhdGlvbklkLFxuICAgICAgc2VuZE1lc3NhZ2VEdG8sXG4gICAgICBmaWxlUmVzdWx0cy5tYXAoKGYpID0+IGYudXJsKSxcbiAgICAgIGZpbGVSZXN1bHRzLm1hcCgoZikgPT4gZi5maWxlbmFtZSksXG4gICAgICBmaWxlcy5tYXAoKGYpID0+IGYuc2l6ZSksXG4gICAgKTtcbiAgfVxuXG4gIEBQdXQoJ21lc3NhZ2VzLzptZXNzYWdlSWQnKVxuICBhc3luYyB1cGRhdGVNZXNzYWdlKFxuICAgIEBDdXJyZW50VXNlcklkKCkgdXNlcklkOiBzdHJpbmcsXG4gICAgQFBhcmFtKCdtZXNzYWdlSWQnKSBtZXNzYWdlSWQ6IHN0cmluZyxcbiAgICBAQm9keSgpIHVwZGF0ZU1lc3NhZ2VEdG86IFVwZGF0ZU1lc3NhZ2VEdG8sXG4gICkge1xuICAgIHJldHVybiB0aGlzLm1lc3NhZ2luZ1NlcnZpY2UudXBkYXRlTWVzc2FnZShcbiAgICAgIHVzZXJJZCxcbiAgICAgIG1lc3NhZ2VJZCxcbiAgICAgIHVwZGF0ZU1lc3NhZ2VEdG8sXG4gICAgKTtcbiAgfVxuXG4gIEBEZWxldGUoJ21lc3NhZ2VzLzptZXNzYWdlSWQnKVxuICBASHR0cENvZGUoSHR0cFN0YXR1cy5OT19DT05URU5UKVxuICBhc3luYyBkZWxldGVNZXNzYWdlKFxuICAgIEBDdXJyZW50VXNlcklkKCkgdXNlcklkOiBzdHJpbmcsXG4gICAgQFBhcmFtKCdtZXNzYWdlSWQnKSBtZXNzYWdlSWQ6IHN0cmluZyxcbiAgKSB7XG4gICAgcmV0dXJuIHRoaXMubWVzc2FnaW5nU2VydmljZS5kZWxldGVNZXNzYWdlKHVzZXJJZCwgbWVzc2FnZUlkKTtcbiAgfVxuXG4gIC8vIFJlYWQgcmVjZWlwdHNcbiAgQFBvc3QoJ21lc3NhZ2VzLzptZXNzYWdlSWQvcmVhZCcpXG4gIEBIdHRwQ29kZShIdHRwU3RhdHVzLk9LKVxuICBhc3luYyBtYXJrTWVzc2FnZUFzUmVhZChcbiAgICBAQ3VycmVudFVzZXJJZCgpIHVzZXJJZDogc3RyaW5nLFxuICAgIEBQYXJhbSgnbWVzc2FnZUlkJykgbWVzc2FnZUlkOiBzdHJpbmcsXG4gICkge1xuICAgIHJldHVybiB0aGlzLm1lc3NhZ2luZ1NlcnZpY2UubWFya01lc3NhZ2VBc1JlYWQodXNlcklkLCBtZXNzYWdlSWQpO1xuICB9XG5cbiAgLy8gTWVzc2FnZSByZWFjdGlvbnNcbiAgQFBvc3QoJ21lc3NhZ2VzLzptZXNzYWdlSWQvcmVhY3Rpb25zJylcbiAgQEh0dHBDb2RlKEh0dHBTdGF0dXMuQ1JFQVRFRClcbiAgYXN5bmMgYWRkTWVzc2FnZVJlYWN0aW9uKFxuICAgIEBDdXJyZW50VXNlcklkKCkgdXNlcklkOiBzdHJpbmcsXG4gICAgQFBhcmFtKCdtZXNzYWdlSWQnKSBtZXNzYWdlSWQ6IHN0cmluZyxcbiAgICBAQm9keSgpIGFkZFJlYWN0aW9uRHRvOiBBZGRSZWFjdGlvbkR0byxcbiAgKSB7XG4gICAgcmV0dXJuIHRoaXMubWVzc2FnaW5nU2VydmljZS5hZGRNZXNzYWdlUmVhY3Rpb24oXG4gICAgICB1c2VySWQsXG4gICAgICBtZXNzYWdlSWQsXG4gICAgICBhZGRSZWFjdGlvbkR0by5lbW9qaSxcbiAgICApO1xuICB9XG5cbiAgQERlbGV0ZSgnbWVzc2FnZXMvOm1lc3NhZ2VJZC9yZWFjdGlvbnMvOmVtb2ppJylcbiAgQEh0dHBDb2RlKEh0dHBTdGF0dXMuTk9fQ09OVEVOVClcbiAgYXN5bmMgcmVtb3ZlTWVzc2FnZVJlYWN0aW9uKFxuICAgIEBDdXJyZW50VXNlcklkKCkgdXNlcklkOiBzdHJpbmcsXG4gICAgQFBhcmFtKCdtZXNzYWdlSWQnKSBtZXNzYWdlSWQ6IHN0cmluZyxcbiAgICBAUGFyYW0oJ2Vtb2ppJykgZW1vamk6IHN0cmluZyxcbiAgKSB7XG4gICAgcmV0dXJuIHRoaXMubWVzc2FnaW5nU2VydmljZS5yZW1vdmVNZXNzYWdlUmVhY3Rpb24oXG4gICAgICB1c2VySWQsXG4gICAgICBtZXNzYWdlSWQsXG4gICAgICBlbW9qaSxcbiAgICApO1xuICB9XG5cbiAgLy8gVXNlciBibG9ja2luZ1xuICBAUG9zdCgnYmxvY2snKVxuICBASHR0cENvZGUoSHR0cFN0YXR1cy5DUkVBVEVEKVxuICBhc3luYyBibG9ja1VzZXIoXG4gICAgQEN1cnJlbnRVc2VySWQoKSB1c2VySWQ6IHN0cmluZyxcbiAgICBAQm9keSgpIGJsb2NrVXNlckR0bzogQmxvY2tVc2VyRHRvLFxuICApIHtcbiAgICByZXR1cm4gdGhpcy5tZXNzYWdpbmdTZXJ2aWNlLmJsb2NrVXNlcihcbiAgICAgIHVzZXJJZCxcbiAgICAgIGJsb2NrVXNlckR0by51c2VySWQsXG4gICAgICBibG9ja1VzZXJEdG8ucmVhc29uLFxuICAgICk7XG4gIH1cblxuICBARGVsZXRlKCdibG9jay86YmxvY2tlZFVzZXJJZCcpXG4gIEBIdHRwQ29kZShIdHRwU3RhdHVzLk5PX0NPTlRFTlQpXG4gIGFzeW5jIHVuYmxvY2tVc2VyKFxuICAgIEBDdXJyZW50VXNlcklkKCkgdXNlcklkOiBzdHJpbmcsXG4gICAgQFBhcmFtKCdibG9ja2VkVXNlcklkJykgYmxvY2tlZFVzZXJJZDogc3RyaW5nLFxuICApIHtcbiAgICByZXR1cm4gdGhpcy5tZXNzYWdpbmdTZXJ2aWNlLnVuYmxvY2tVc2VyKHVzZXJJZCwgYmxvY2tlZFVzZXJJZCk7XG4gIH1cblxuICAvLyBTZWFyY2ggbWVzc2FnZXNcbiAgQEdldCgnc2VhcmNoJylcbiAgYXN5bmMgc2VhcmNoTWVzc2FnZXMoXG4gICAgQEN1cnJlbnRVc2VySWQoKSB1c2VySWQ6IHN0cmluZyxcbiAgICBAUXVlcnkoKSBzZWFyY2hEdG86IFNlYXJjaE1lc3NhZ2VzRHRvLFxuICApIHtcbiAgICBjb25zdCB7IHF1ZXJ5LCBjb252ZXJzYXRpb25JZCwgcGFnZSwgbGltaXQgfSA9IHNlYXJjaER0bztcbiAgICBjb25zdCBwYWdlTnVtID0gcGFnZSA/IE51bWJlcihwYWdlKSA6IDE7XG4gICAgY29uc3QgbGltaXROdW0gPSBsaW1pdCA/IE51bWJlcihsaW1pdCkgOiAyMDtcbiAgICByZXR1cm4gdGhpcy5tZXNzYWdpbmdTZXJ2aWNlLnNlYXJjaE1lc3NhZ2VzKFxuICAgICAgdXNlcklkLFxuICAgICAgcXVlcnkgfHwgJycsXG4gICAgICBjb252ZXJzYXRpb25JZCxcbiAgICAgIHBhZ2VOdW0sXG4gICAgICBsaW1pdE51bSxcbiAgICApO1xuICB9XG59XG4iXSwidmVyc2lvbiI6M30=