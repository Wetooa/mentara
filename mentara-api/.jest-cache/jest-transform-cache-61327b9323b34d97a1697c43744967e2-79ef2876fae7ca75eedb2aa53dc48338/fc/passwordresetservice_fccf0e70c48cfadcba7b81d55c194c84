f04838cd6826895dc07d5be55817ba4f
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var _a, _b, _c;
Object.defineProperty(exports, "__esModule", { value: true });
exports.PasswordResetService = void 0;
const common_1 = require("@nestjs/common");
const prisma_client_provider_1 = require("../../providers/prisma-client.provider");
const email_service_1 = require("../../services/email.service");
const token_service_1 = require("./token.service");
const crypto = require("crypto");
let PasswordResetService = class PasswordResetService {
    prisma;
    emailService;
    tokenService;
    constructor(prisma, emailService, tokenService) {
        this.prisma = prisma;
        this.emailService = emailService;
        this.tokenService = tokenService;
    }
    async requestPasswordReset(email) {
        const user = await this.prisma.user.findUnique({
            where: { email },
            select: {
                id: true,
                email: true,
                firstName: true,
                deactivatedAt: true,
                resetToken: true,
                resetTokenExpiry: true,
            },
        });
        if (!user) {
            // Don't reveal if email exists for security
            return;
        }
        if (user.deactivatedAt) {
            throw new common_1.BadRequestException('Account is deactivated');
        }
        // Check if there's an existing valid token (prevent spam)
        if (user.resetToken &&
            user.resetTokenExpiry &&
            user.resetTokenExpiry > new Date()) {
            const timeDiff = user.resetTokenExpiry.getTime() - new Date().getTime();
            if (timeDiff > 50 * 60 * 1000) {
                // More than 50 minutes remaining
                throw new common_1.BadRequestException('Password reset email already sent. Please check your email or wait before requesting again.');
            }
        }
        // Generate new reset token
        const { token, hashedToken, expiresAt } = await this.tokenService.generatePasswordResetToken();
        // Update user with reset token
        await this.prisma.user.update({
            where: { id: user.id },
            data: {
                resetToken: hashedToken,
                resetTokenExpiry: expiresAt,
            },
        });
        // Send password reset email
        await this.sendPasswordResetEmail(user.email, user.firstName, token);
    }
    async resetPassword(token, newPassword) {
        if (!token || !newPassword) {
            throw new common_1.BadRequestException('Reset token and new password are required');
        }
        // Validate password strength
        this.validatePasswordStrength(newPassword);
        const hashedToken = crypto.createHash('sha256').update(token).digest('hex');
        const user = await this.prisma.user.findUnique({
            where: { resetToken: hashedToken },
            select: {
                id: true,
                email: true,
                resetTokenExpiry: true,
                deactivatedAt: true,
                password: true,
            },
        });
        if (!user) {
            throw new common_1.BadRequestException('Invalid or expired reset token');
        }
        if (user.deactivatedAt) {
            throw new common_1.BadRequestException('Account is deactivated');
        }
        if (!user.resetTokenExpiry || user.resetTokenExpiry < new Date()) {
            // Clean up expired token
            await this.prisma.user.update({
                where: { id: user.id },
                data: {
                    resetToken: null,
                    resetTokenExpiry: null,
                },
            });
            throw new common_1.BadRequestException('Reset token has expired');
        }
        // Check if new password is different from current (if user has one)
        if (user.password) {
            const isSamePassword = await this.tokenService.comparePassword(newPassword, user.password);
            if (isSamePassword) {
                throw new common_1.BadRequestException('New password must be different from current password');
            }
        }
        // Hash new password
        const hashedPassword = await this.tokenService.hashPassword(newPassword);
        // Update password and clear reset token
        await this.prisma.user.update({
            where: { id: user.id },
            data: {
                password: hashedPassword,
                resetToken: null,
                resetTokenExpiry: null,
                failedLoginCount: 0, // Reset failed login attempts
                lockoutUntil: null, // Clear any lockout
            },
        });
        // Revoke all existing refresh tokens for security
        await this.tokenService.revokeAllUserTokens(user.id);
        // Send confirmation email
        await this.sendPasswordResetConfirmationEmail(user.email);
        return {
            success: true,
            message: 'Password reset successfully',
        };
    }
    async validateResetToken(token) {
        if (!token) {
            return { valid: false };
        }
        const hashedToken = crypto.createHash('sha256').update(token).digest('hex');
        const user = await this.prisma.user.findUnique({
            where: { resetToken: hashedToken },
            select: {
                email: true,
                resetTokenExpiry: true,
                deactivatedAt: true,
            },
        });
        if (!user || user.deactivatedAt) {
            return { valid: false };
        }
        if (!user.resetTokenExpiry || user.resetTokenExpiry < new Date()) {
            return { valid: false };
        }
        return {
            valid: true,
            email: user.email,
        };
    }
    validatePasswordStrength(password) {
        const minLength = parseInt(process.env.MIN_PASSWORD_LENGTH || '8');
        if (password.length < minLength) {
            throw new common_1.BadRequestException(`Password must be at least ${minLength} characters long`);
        }
        // Check for at least one uppercase letter
        if (!/[A-Z]/.test(password)) {
            throw new common_1.BadRequestException('Password must contain at least one uppercase letter');
        }
        // Check for at least one lowercase letter
        if (!/[a-z]/.test(password)) {
            throw new common_1.BadRequestException('Password must contain at least one lowercase letter');
        }
        // Check for at least one number
        if (!/\d/.test(password)) {
            throw new common_1.BadRequestException('Password must contain at least one number');
        }
        // Check for at least one special character
        if (!/[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password)) {
            throw new common_1.BadRequestException('Password must contain at least one special character');
        }
        // Check for common weak passwords
        const commonPasswords = [
            'password',
            'password123',
            '123456',
            'qwerty',
            'abc123',
            'letmein',
            'welcome',
            'monkey',
            '1234567890',
            'admin',
        ];
        if (commonPasswords.includes(password.toLowerCase())) {
            throw new common_1.BadRequestException('Password is too common. Please choose a more secure password');
        }
    }
    async sendPasswordResetEmail(email, firstName, token) {
        const resetUrl = `${process.env.FRONTEND_URL}/reset-password?token=${token}`;
        try {
            await this.emailService.sendGenericEmail({
                to: email,
                subject: 'Reset Your Mentara Password',
                template: 'password-reset',
                data: {
                    firstName,
                    resetUrl,
                    expiryTime: '1 hour',
                    supportEmail: process.env.SUPPORT_EMAIL || 'support@mentara.com',
                },
            });
        }
        catch (error) {
            console.error('Failed to send password reset email:', error);
            throw new common_1.BadRequestException('Failed to send password reset email');
        }
    }
    async sendPasswordResetConfirmationEmail(email) {
        try {
            await this.emailService.sendGenericEmail({
                to: email,
                subject: 'Password Reset Successful',
                template: 'password-reset-confirmation',
                data: {
                    supportEmail: process.env.SUPPORT_EMAIL || 'support@mentara.com',
                    loginUrl: `${process.env.FRONTEND_URL}/login`,
                },
            });
        }
        catch (error) {
            console.error('Failed to send password reset confirmation email:', error);
            // Don't throw error here as password reset was successful
        }
    }
    async cleanupExpiredTokens() {
        await this.prisma.user.updateMany({
            where: {
                resetTokenExpiry: {
                    lt: new Date(),
                },
            },
            data: {
                resetToken: null,
                resetTokenExpiry: null,
            },
        });
    }
};
exports.PasswordResetService = PasswordResetService;
exports.PasswordResetService = PasswordResetService = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [typeof (_a = typeof prisma_client_provider_1.PrismaService !== "undefined" && prisma_client_provider_1.PrismaService) === "function" ? _a : Object, typeof (_b = typeof email_service_1.EmailService !== "undefined" && email_service_1.EmailService) === "function" ? _b : Object, typeof (_c = typeof token_service_1.TokenService !== "undefined" && token_service_1.TokenService) === "function" ? _c : Object])
], PasswordResetService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL2F1dGgvc2VydmljZXMvcGFzc3dvcmQtcmVzZXQuc2VydmljZS50cyIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7O0FBQUEsMkNBSXdCO0FBQ3hCLG1GQUF1RTtBQUN2RSxnRUFBNEQ7QUFDNUQsbURBQStDO0FBQy9DLGlDQUFpQztBQUcxQixJQUFNLG9CQUFvQixHQUExQixNQUFNLG9CQUFvQjtJQUVaO0lBQ0E7SUFDQTtJQUhuQixZQUNtQixNQUFxQixFQUNyQixZQUEwQixFQUMxQixZQUEwQjtRQUYxQixXQUFNLEdBQU4sTUFBTSxDQUFlO1FBQ3JCLGlCQUFZLEdBQVosWUFBWSxDQUFjO1FBQzFCLGlCQUFZLEdBQVosWUFBWSxDQUFjO0lBQzFDLENBQUM7SUFFSixLQUFLLENBQUMsb0JBQW9CLENBQUMsS0FBYTtRQUN0QyxNQUFNLElBQUksR0FBRyxNQUFNLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQztZQUM3QyxLQUFLLEVBQUUsRUFBRSxLQUFLLEVBQUU7WUFDaEIsTUFBTSxFQUFFO2dCQUNOLEVBQUUsRUFBRSxJQUFJO2dCQUNSLEtBQUssRUFBRSxJQUFJO2dCQUNYLFNBQVMsRUFBRSxJQUFJO2dCQUNmLGFBQWEsRUFBRSxJQUFJO2dCQUNuQixVQUFVLEVBQUUsSUFBSTtnQkFDaEIsZ0JBQWdCLEVBQUUsSUFBSTthQUN2QjtTQUNGLENBQUMsQ0FBQztRQUVILElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQztZQUNWLDRDQUE0QztZQUM1QyxPQUFPO1FBQ1QsQ0FBQztRQUVELElBQUksSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO1lBQ3ZCLE1BQU0sSUFBSSw0QkFBbUIsQ0FBQyx3QkFBd0IsQ0FBQyxDQUFDO1FBQzFELENBQUM7UUFFRCwwREFBMEQ7UUFDMUQsSUFDRSxJQUFJLENBQUMsVUFBVTtZQUNmLElBQUksQ0FBQyxnQkFBZ0I7WUFDckIs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QkFBZ0IsRUFBRTtvQkFDaEIsRUFBRSxFQUFFLElBQUksSUFBSSxFQUFFO2lCQUNmO2FBQ0Y7WUFDRCxJQUFJLEVBQUU7Z0JBQ0osVUFBVSxFQUFFLElBQUk7Z0JBQ2hCLGdCQUFnQixFQUFFLElBQUk7YUFDdkI7U0FDRixDQUFDLENBQUM7SUFDTCxDQUFDO0NBQ0YsQ0FBQTtBQXRTWSxvREFBb0I7K0JBQXBCLG9CQUFvQjtJQURoQyxJQUFBLG1CQUFVLEdBQUU7eURBR2dCLHNDQUFhLG9CQUFiLHNDQUFhLG9EQUNQLDRCQUFZLG9CQUFaLDRCQUFZLG9EQUNaLDRCQUFZLG9CQUFaLDRCQUFZO0dBSmxDLG9CQUFvQixDQXNTaEMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL2F1dGgvc2VydmljZXMvcGFzc3dvcmQtcmVzZXQuc2VydmljZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBJbmplY3RhYmxlLFxuICBCYWRSZXF1ZXN0RXhjZXB0aW9uLFxuICBOb3RGb3VuZEV4Y2VwdGlvbixcbn0gZnJvbSAnQG5lc3Rqcy9jb21tb24nO1xuaW1wb3J0IHsgUHJpc21hU2VydmljZSB9IGZyb20gJy4uLy4uL3Byb3ZpZGVycy9wcmlzbWEtY2xpZW50LnByb3ZpZGVyJztcbmltcG9ydCB7IEVtYWlsU2VydmljZSB9IGZyb20gJy4uLy4uL3NlcnZpY2VzL2VtYWlsLnNlcnZpY2UnO1xuaW1wb3J0IHsgVG9rZW5TZXJ2aWNlIH0gZnJvbSAnLi90b2tlbi5zZXJ2aWNlJztcbmltcG9ydCAqIGFzIGNyeXB0byBmcm9tICdjcnlwdG8nO1xuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgUGFzc3dvcmRSZXNldFNlcnZpY2Uge1xuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHJlYWRvbmx5IHByaXNtYTogUHJpc21hU2VydmljZSxcbiAgICBwcml2YXRlIHJlYWRvbmx5IGVtYWlsU2VydmljZTogRW1haWxTZXJ2aWNlLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgdG9rZW5TZXJ2aWNlOiBUb2tlblNlcnZpY2UsXG4gICkge31cblxuICBhc3luYyByZXF1ZXN0UGFzc3dvcmRSZXNldChlbWFpbDogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgY29uc3QgdXNlciA9IGF3YWl0IHRoaXMucHJpc21hLnVzZXIuZmluZFVuaXF1ZSh7XG4gICAgICB3aGVyZTogeyBlbWFpbCB9LFxuICAgICAgc2VsZWN0OiB7XG4gICAgICAgIGlkOiB0cnVlLFxuICAgICAgICBlbWFpbDogdHJ1ZSxcbiAgICAgICAgZmlyc3ROYW1lOiB0cnVlLFxuICAgICAgICBkZWFjdGl2YXRlZEF0OiB0cnVlLFxuICAgICAgICByZXNldFRva2VuOiB0cnVlLFxuICAgICAgICByZXNldFRva2VuRXhwaXJ5OiB0cnVlLFxuICAgICAgfSxcbiAgICB9KTtcblxuICAgIGlmICghdXNlcikge1xuICAgICAgLy8gRG9uJ3QgcmV2ZWFsIGlmIGVtYWlsIGV4aXN0cyBmb3Igc2VjdXJpdHlcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpZiAodXNlci5kZWFjdGl2YXRlZEF0KSB7XG4gICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdEV4Y2VwdGlvbignQWNjb3VudCBpcyBkZWFjdGl2YXRlZCcpO1xuICAgIH1cblxuICAgIC8vIENoZWNrIGlmIHRoZXJlJ3MgYW4gZXhpc3RpbmcgdmFsaWQgdG9rZW4gKHByZXZlbnQgc3BhbSlcbiAgICBpZiAoXG4gICAgICB1c2VyLnJlc2V0VG9rZW4gJiZcbiAgICAgIHVzZXIucmVzZXRUb2tlbkV4cGlyeSAmJlxuICAgICAgdXNlci5yZXNldFRva2VuRXhwaXJ5ID4gbmV3IERhdGUoKVxuICAgICkge1xuICAgICAgY29uc3QgdGltZURpZmYgPSB1c2VyLnJlc2V0VG9rZW5FeHBpcnkuZ2V0VGltZSgpIC0gbmV3IERhdGUoKS5nZXRUaW1lKCk7XG4gICAgICBpZiAodGltZURpZmYgPiA1MCAqIDYwICogMTAwMCkge1xuICAgICAgICAvLyBNb3JlIHRoYW4gNTAgbWludXRlcyByZW1haW5pbmdcbiAgICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFeGNlcHRpb24oXG4gICAgICAgICAgJ1Bhc3N3b3JkIHJlc2V0IGVtYWlsIGFscmVhZHkgc2VudC4gUGxlYXNlIGNoZWNrIHlvdXIgZW1haWwgb3Igd2FpdCBiZWZvcmUgcmVxdWVzdGluZyBhZ2Fpbi4nLFxuICAgICAgICApO1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vIEdlbmVyYXRlIG5ldyByZXNldCB0b2tlblxuICAgIGNvbnN0IHsgdG9rZW4sIGhhc2hlZFRva2VuLCBleHBpcmVzQXQgfSA9XG4gICAgICBhd2FpdCB0aGlzLnRva2VuU2VydmljZS5nZW5lcmF0ZVBhc3N3b3JkUmVzZXRUb2tlbigpO1xuXG4gICAgLy8gVXBkYXRlIHVzZXIgd2l0aCByZXNldCB0b2tlblxuICAgIGF3YWl0IHRoaXMucHJpc21hLnVzZXIudXBkYXRlKHtcbiAgICAgIHdoZXJlOiB7IGlkOiB1c2VyLmlkIH0sXG4gICAgICBkYXRhOiB7XG4gICAgICAgIHJlc2V0VG9rZW46IGhhc2hlZFRva2VuLFxuICAgICAgICByZXNldFRva2VuRXhwaXJ5OiBleHBpcmVzQXQsXG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgLy8gU2VuZCBwYXNzd29yZCByZXNldCBlbWFpbFxuICAgIGF3YWl0IHRoaXMuc2VuZFBhc3N3b3JkUmVzZXRFbWFpbCh1c2VyLmVtYWlsLCB1c2VyLmZpcnN0TmFtZSwgdG9rZW4pO1xuICB9XG5cbiAgYXN5bmMgcmVzZXRQYXNzd29yZChcbiAgICB0b2tlbjogc3RyaW5nLFxuICAgIG5ld1Bhc3N3b3JkOiBzdHJpbmcsXG4gICk6IFByb21pc2U8eyBzdWNjZXNzOiBib29sZWFuOyBtZXNzYWdlOiBzdHJpbmcgfT4ge1xuICAgIGlmICghdG9rZW4gfHwgIW5ld1Bhc3N3b3JkKSB7XG4gICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdEV4Y2VwdGlvbihcbiAgICAgICAgJ1Jlc2V0IHRva2VuIGFuZCBuZXcgcGFzc3dvcmQgYXJlIHJlcXVpcmVkJyxcbiAgICAgICk7XG4gICAgfVxuXG4gICAgLy8gVmFsaWRhdGUgcGFzc3dvcmQgc3RyZW5ndGhcbiAgICB0aGlzLnZhbGlkYXRlUGFzc3dvcmRTdHJlbmd0aChuZXdQYXNzd29yZCk7XG5cbiAgICBjb25zdCBoYXNoZWRUb2tlbiA9IGNyeXB0by5jcmVhdGVIYXNoKCdzaGEyNTYnKS51cGRhdGUodG9rZW4pLmRpZ2VzdCgnaGV4Jyk7XG5cbiAgICBjb25zdCB1c2VyID0gYXdhaXQgdGhpcy5wcmlzbWEudXNlci5maW5kVW5pcXVlKHtcbiAgICAgIHdoZXJlOiB7IHJlc2V0VG9rZW46IGhhc2hlZFRva2VuIH0sXG4gICAgICBzZWxlY3Q6IHtcbiAgICAgICAgaWQ6IHRydWUsXG4gICAgICAgIGVtYWlsOiB0cnVlLFxuICAgICAgICByZXNldFRva2VuRXhwaXJ5OiB0cnVlLFxuICAgICAgICBkZWFjdGl2YXRlZEF0OiB0cnVlLFxuICAgICAgICBwYXNzd29yZDogdHJ1ZSxcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICBpZiAoIXVzZXIpIHtcbiAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0RXhjZXB0aW9uKCdJbnZhbGlkIG9yIGV4cGlyZWQgcmVzZXQgdG9rZW4nKTtcbiAgICB9XG5cbiAgICBpZiAodXNlci5kZWFjdGl2YXRlZEF0KSB7XG4gICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdEV4Y2VwdGlvbignQWNjb3VudCBpcyBkZWFjdGl2YXRlZCcpO1xuICAgIH1cblxuICAgIGlmICghdXNlci5yZXNldFRva2VuRXhwaXJ5IHx8IHVzZXIucmVzZXRUb2tlbkV4cGlyeSA8IG5ldyBEYXRlKCkpIHtcbiAgICAgIC8vIENsZWFuIHVwIGV4cGlyZWQgdG9rZW5cbiAgICAgIGF3YWl0IHRoaXMucHJpc21hLnVzZXIudXBkYXRlKHtcbiAgICAgICAgd2hlcmU6IHsgaWQ6IHVzZXIuaWQgfSxcbiAgICAgICAgZGF0YToge1xuICAgICAgICAgIHJlc2V0VG9rZW46IG51bGwsXG4gICAgICAgICAgcmVzZXRUb2tlbkV4cGlyeTogbnVsbCxcbiAgICAgICAgfSxcbiAgICAgIH0pO1xuICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFeGNlcHRpb24oJ1Jlc2V0IHRva2VuIGhhcyBleHBpcmVkJyk7XG4gICAgfVxuXG4gICAgLy8gQ2hlY2sgaWYgbmV3IHBhc3N3b3JkIGlzIGRpZmZlcmVudCBmcm9tIGN1cnJlbnQgKGlmIHVzZXIgaGFzIG9uZSlcbiAgICBpZiAodXNlci5wYXNzd29yZCkge1xuICAgICAgY29uc3QgaXNTYW1lUGFzc3dvcmQgPSBhd2FpdCB0aGlzLnRva2VuU2VydmljZS5jb21wYXJlUGFzc3dvcmQoXG4gICAgICAgIG5ld1Bhc3N3b3JkLFxuICAgICAgICB1c2VyLnBhc3N3b3JkLFxuICAgICAgKTtcbiAgICAgIGlmIChpc1NhbWVQYXNzd29yZCkge1xuICAgICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdEV4Y2VwdGlvbihcbiAgICAgICAgICAnTmV3IHBhc3N3b3JkIG11c3QgYmUgZGlmZmVyZW50IGZyb20gY3VycmVudCBwYXNzd29yZCcsXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gSGFzaCBuZXcgcGFzc3dvcmRcbiAgICBjb25zdCBoYXNoZWRQYXNzd29yZCA9IGF3YWl0IHRoaXMudG9rZW5TZXJ2aWNlLmhhc2hQYXNzd29yZChuZXdQYXNzd29yZCk7XG5cbiAgICAvLyBVcGRhdGUgcGFzc3dvcmQgYW5kIGNsZWFyIHJlc2V0IHRva2VuXG4gICAgYXdhaXQgdGhpcy5wcmlzbWEudXNlci51cGRhdGUoe1xuICAgICAgd2hlcmU6IHsgaWQ6IHVzZXIuaWQgfSxcbiAgICAgIGRhdGE6IHtcbiAgICAgICAgcGFzc3dvcmQ6IGhhc2hlZFBhc3N3b3JkLFxuICAgICAgICByZXNldFRva2VuOiBudWxsLFxuICAgICAgICByZXNldFRva2VuRXhwaXJ5OiBudWxsLFxuICAgICAgICBmYWlsZWRMb2dpbkNvdW50OiAwLCAvLyBSZXNldCBmYWlsZWQgbG9naW4gYXR0ZW1wdHNcbiAgICAgICAgbG9ja291dFVudGlsOiBudWxsLCAvLyBDbGVhciBhbnkgbG9ja291dFxuICAgICAgfSxcbiAgICB9KTtcblxuICAgIC8vIFJldm9rZSBhbGwgZXhpc3RpbmcgcmVmcmVzaCB0b2tlbnMgZm9yIHNlY3VyaXR5XG4gICAgYXdhaXQgdGhpcy50b2tlblNlcnZpY2UucmV2b2tlQWxsVXNlclRva2Vucyh1c2VyLmlkKTtcblxuICAgIC8vIFNlbmQgY29uZmlybWF0aW9uIGVtYWlsXG4gICAgYXdhaXQgdGhpcy5zZW5kUGFzc3dvcmRSZXNldENvbmZpcm1hdGlvbkVtYWlsKHVzZXIuZW1haWwpO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICBtZXNzYWdlOiAnUGFzc3dvcmQgcmVzZXQgc3VjY2Vzc2Z1bGx5JyxcbiAgICB9O1xuICB9XG5cbiAgYXN5bmMgdmFsaWRhdGVSZXNldFRva2VuKFxuICAgIHRva2VuOiBzdHJpbmcsXG4gICk6IFByb21pc2U8eyB2YWxpZDogYm9vbGVhbjsgZW1haWw/OiBzdHJpbmcgfT4ge1xuICAgIGlmICghdG9rZW4pIHtcbiAgICAgIHJldHVybiB7IHZhbGlkOiBmYWxzZSB9O1xuICAgIH1cblxuICAgIGNvbnN0IGhhc2hlZFRva2VuID0gY3J5cHRvLmNyZWF0ZUhhc2goJ3NoYTI1NicpLnVwZGF0ZSh0b2tlbikuZGlnZXN0KCdoZXgnKTtcblxuICAgIGNvbnN0IHVzZXIgPSBhd2FpdCB0aGlzLnByaXNtYS51c2VyLmZpbmRVbmlxdWUoe1xuICAgICAgd2hlcmU6IHsgcmVzZXRUb2tlbjogaGFzaGVkVG9rZW4gfSxcbiAgICAgIHNlbGVjdDoge1xuICAgICAgICBlbWFpbDogdHJ1ZSxcbiAgICAgICAgcmVzZXRUb2tlbkV4cGlyeTogdHJ1ZSxcbiAgICAgICAgZGVhY3RpdmF0ZWRBdDogdHJ1ZSxcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICBpZiAoIXVzZXIgfHwgdXNlci5kZWFjdGl2YXRlZEF0KSB7XG4gICAgICByZXR1cm4geyB2YWxpZDogZmFsc2UgfTtcbiAgICB9XG5cbiAgICBpZiAoIXVzZXIucmVzZXRUb2tlbkV4cGlyeSB8fCB1c2VyLnJlc2V0VG9rZW5FeHBpcnkgPCBuZXcgRGF0ZSgpKSB7XG4gICAgICByZXR1cm4geyB2YWxpZDogZmFsc2UgfTtcbiAgICB9XG5cbiAgICByZXR1cm4ge1xuICAgICAgdmFsaWQ6IHRydWUsXG4gICAgICBlbWFpbDogdXNlci5lbWFpbCxcbiAgICB9O1xuICB9XG5cbiAgcHJpdmF0ZSB2YWxpZGF0ZVBhc3N3b3JkU3RyZW5ndGgocGFzc3dvcmQ6IHN0cmluZyk6IHZvaWQge1xuICAgIGNvbnN0IG1pbkxlbmd0aCA9IHBhcnNlSW50KHByb2Nlc3MuZW52Lk1JTl9QQVNTV09SRF9MRU5HVEggfHwgJzgnKTtcblxuICAgIGlmIChwYXNzd29yZC5sZW5ndGggPCBtaW5MZW5ndGgpIHtcbiAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0RXhjZXB0aW9uKFxuICAgICAgICBgUGFzc3dvcmQgbXVzdCBiZSBhdCBsZWFzdCAke21pbkxlbmd0aH0gY2hhcmFjdGVycyBsb25nYCxcbiAgICAgICk7XG4gICAgfVxuXG4gICAgLy8gQ2hlY2sgZm9yIGF0IGxlYXN0IG9uZSB1cHBlcmNhc2UgbGV0dGVyXG4gICAgaWYgKCEvW0EtWl0vLnRlc3QocGFzc3dvcmQpKSB7XG4gICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdEV4Y2VwdGlvbihcbiAgICAgICAgJ1Bhc3N3b3JkIG11c3QgY29udGFpbiBhdCBsZWFzdCBvbmUgdXBwZXJjYXNlIGxldHRlcicsXG4gICAgICApO1xuICAgIH1cblxuICAgIC8vIENoZWNrIGZvciBhdCBsZWFzdCBvbmUgbG93ZXJjYXNlIGxldHRlclxuICAgIGlmICghL1thLXpdLy50ZXN0KHBhc3N3b3JkKSkge1xuICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFeGNlcHRpb24oXG4gICAgICAgICdQYXNzd29yZCBtdXN0IGNvbnRhaW4gYXQgbGVhc3Qgb25lIGxvd2VyY2FzZSBsZXR0ZXInLFxuICAgICAgKTtcbiAgICB9XG5cbiAgICAvLyBDaGVjayBmb3IgYXQgbGVhc3Qgb25lIG51bWJlclxuICAgIGlmICghL1xcZC8udGVzdChwYXNzd29yZCkpIHtcbiAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0RXhjZXB0aW9uKFxuICAgICAgICAnUGFzc3dvcmQgbXVzdCBjb250YWluIGF0IGxlYXN0IG9uZSBudW1iZXInLFxuICAgICAgKTtcbiAgICB9XG5cbiAgICAvLyBDaGVjayBmb3IgYXQgbGVhc3Qgb25lIHNwZWNpYWwgY2hhcmFjdGVyXG4gICAgaWYgKCEvWyFAIyQlXiYqKClfK1xcLT1cXFtcXF17fTsnOlwiXFxcXHwsLjw+XFwvP10vLnRlc3QocGFzc3dvcmQpKSB7XG4gICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdEV4Y2VwdGlvbihcbiAgICAgICAgJ1Bhc3N3b3JkIG11c3QgY29udGFpbiBhdCBsZWFzdCBvbmUgc3BlY2lhbCBjaGFyYWN0ZXInLFxuICAgICAgKTtcbiAgICB9XG5cbiAgICAvLyBDaGVjayBmb3IgY29tbW9uIHdlYWsgcGFzc3dvcmRzXG4gICAgY29uc3QgY29tbW9uUGFzc3dvcmRzID0gW1xuICAgICAgJ3Bhc3N3b3JkJyxcbiAgICAgICdwYXNzd29yZDEyMycsXG4gICAgICAnMTIzNDU2JyxcbiAgICAgICdxd2VydHknLFxuICAgICAgJ2FiYzEyMycsXG4gICAgICAnbGV0bWVpbicsXG4gICAgICAnd2VsY29tZScsXG4gICAgICAnbW9ua2V5JyxcbiAgICAgICcxMjM0NTY3ODkwJyxcbiAgICAgICdhZG1pbicsXG4gICAgXTtcblxuICAgIGlmIChjb21tb25QYXNzd29yZHMuaW5jbHVkZXMocGFzc3dvcmQudG9Mb3dlckNhc2UoKSkpIHtcbiAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0RXhjZXB0aW9uKFxuICAgICAgICAnUGFzc3dvcmQgaXMgdG9vIGNvbW1vbi4gUGxlYXNlIGNob29zZSBhIG1vcmUgc2VjdXJlIHBhc3N3b3JkJyxcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBzZW5kUGFzc3dvcmRSZXNldEVtYWlsKFxuICAgIGVtYWlsOiBzdHJpbmcsXG4gICAgZmlyc3ROYW1lOiBzdHJpbmcsXG4gICAgdG9rZW46IHN0cmluZyxcbiAgKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgY29uc3QgcmVzZXRVcmwgPSBgJHtwcm9jZXNzLmVudi5GUk9OVEVORF9VUkx9L3Jlc2V0LXBhc3N3b3JkP3Rva2VuPSR7dG9rZW59YDtcblxuICAgIHRyeSB7XG4gICAgICBhd2FpdCB0aGlzLmVtYWlsU2VydmljZS5zZW5kR2VuZXJpY0VtYWlsKHtcbiAgICAgICAgdG86IGVtYWlsLFxuICAgICAgICBzdWJqZWN0OiAnUmVzZXQgWW91ciBNZW50YXJhIFBhc3N3b3JkJyxcbiAgICAgICAgdGVtcGxhdGU6ICdwYXNzd29yZC1yZXNldCcsXG4gICAgICAgIGRhdGE6IHtcbiAgICAgICAgICBmaXJzdE5hbWUsXG4gICAgICAgICAgcmVzZXRVcmwsXG4gICAgICAgICAgZXhwaXJ5VGltZTogJzEgaG91cicsXG4gICAgICAgICAgc3VwcG9ydEVtYWlsOiBwcm9jZXNzLmVudi5TVVBQT1JUX0VNQUlMIHx8ICdzdXBwb3J0QG1lbnRhcmEuY29tJyxcbiAgICAgICAgfSxcbiAgICAgIH0pO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBjb25zb2xlLmVycm9yKCdGYWlsZWQgdG8gc2VuZCBwYXNzd29yZCByZXNldCBlbWFpbDonLCBlcnJvcik7XG4gICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdEV4Y2VwdGlvbignRmFpbGVkIHRvIHNlbmQgcGFzc3dvcmQgcmVzZXQgZW1haWwnKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIHNlbmRQYXNzd29yZFJlc2V0Q29uZmlybWF0aW9uRW1haWwoXG4gICAgZW1haWw6IHN0cmluZyxcbiAgKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IHRoaXMuZW1haWxTZXJ2aWNlLnNlbmRHZW5lcmljRW1haWwoe1xuICAgICAgICB0bzogZW1haWwsXG4gICAgICAgIHN1YmplY3Q6ICdQYXNzd29yZCBSZXNldCBTdWNjZXNzZnVsJyxcbiAgICAgICAgdGVtcGxhdGU6ICdwYXNzd29yZC1yZXNldC1jb25maXJtYXRpb24nLFxuICAgICAgICBkYXRhOiB7XG4gICAgICAgICAgc3VwcG9ydEVtYWlsOiBwcm9jZXNzLmVudi5TVVBQT1JUX0VNQUlMIHx8ICdzdXBwb3J0QG1lbnRhcmEuY29tJyxcbiAgICAgICAgICBsb2dpblVybDogYCR7cHJvY2Vzcy5lbnYuRlJPTlRFTkRfVVJMfS9sb2dpbmAsXG4gICAgICAgIH0sXG4gICAgICB9KTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc29sZS5lcnJvcignRmFpbGVkIHRvIHNlbmQgcGFzc3dvcmQgcmVzZXQgY29uZmlybWF0aW9uIGVtYWlsOicsIGVycm9yKTtcbiAgICAgIC8vIERvbid0IHRocm93IGVycm9yIGhlcmUgYXMgcGFzc3dvcmQgcmVzZXQgd2FzIHN1Y2Nlc3NmdWxcbiAgICB9XG4gIH1cblxuICBhc3luYyBjbGVhbnVwRXhwaXJlZFRva2VucygpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBhd2FpdCB0aGlzLnByaXNtYS51c2VyLnVwZGF0ZU1hbnkoe1xuICAgICAgd2hlcmU6IHtcbiAgICAgICAgcmVzZXRUb2tlbkV4cGlyeToge1xuICAgICAgICAgIGx0OiBuZXcgRGF0ZSgpLFxuICAgICAgICB9LFxuICAgICAgfSxcbiAgICAgIGRhdGE6IHtcbiAgICAgICAgcmVzZXRUb2tlbjogbnVsbCxcbiAgICAgICAgcmVzZXRUb2tlbkV4cGlyeTogbnVsbCxcbiAgICAgIH0sXG4gICAgfSk7XG4gIH1cbn1cbiJdLCJ2ZXJzaW9uIjozfQ==