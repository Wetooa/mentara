4e066b7f5bf1df52042f63ad990d1d92
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var ModerationService_1;
var _a, _b;
Object.defineProperty(exports, "__esModule", { value: true });
exports.ModerationService = void 0;
const common_1 = require("@nestjs/common");
const axios_1 = require("@nestjs/axios");
const rxjs_1 = require("rxjs");
const config_1 = require("@nestjs/config");
let ModerationService = ModerationService_1 = class ModerationService {
    httpService;
    configService;
    logger = new common_1.Logger(ModerationService_1.name);
    moderationApiUrl;
    enabled;
    timeout;
    constructor(httpService, configService) {
        this.httpService = httpService;
        this.configService = configService;
        this.moderationApiUrl = this.configService.get('MODERATION_API_URL', 'http://localhost:5001');
        this.enabled = this.configService.get('MODERATION_ENABLED', true);
        this.timeout = this.configService.get('MODERATION_TIMEOUT', 5000);
    }
    /**
     * Classify content using the AI moderation service
     */
    async classifyContent(text, context) {
        if (!this.enabled) {
            return this.createSafeResult(text);
        }
        try {
            const startTime = Date.now();
            const response = await (0, rxjs_1.firstValueFrom)(this.httpService.post(`${this.moderationApiUrl}/api/v1/classify`, {
                text,
                context: context.context,
                user_id: context.userId,
                user_role: context.userRole,
                conversation_id: context.conversationId,
                community_id: context.communityId,
                timestamp: context.timestamp?.toISOString(),
            }, {
                timeout: this.timeout,
                headers: {
                    'Content-Type': 'application/json',
                },
            }));
            const processingTime = Date.now() - startTime;
            const result = {
                ...response.data,
                processingTime,
            };
            // Log crisis detection for immediate escalation
            if (result.crisisLevel === 'critical' || result.immediateEscalation) {
                this.logger.warn(`CRISIS DETECTED: User ${context.userId} in ${context.context}`, {
                    text: text.substring(0, 100),
                    crisisLevel: result.crisisLevel,
                    confidence: result.confidence,
                    flags: result.flags,
                });
            }
            // Log toxic content detection
            if (result.classification === 'toxic') {
                this.logger.warn(`TOXIC CONTENT DETECTED: User ${context.userId} in ${context.context}`, {
                    text: text.substring(0, 100),
                    confidence: result.confidence,
                    flags: result.flags,
                });
            }
            return result;
        }
        catch (error) {
            this.logger.error('Moderation service error:', error);
            // Fallback to safe classification if service is unavailable
            return this.createSafeResult(text, {
                flags: ['service_unavailable'],
                processingTime: Date.now() - Date.now(),
            });
        }
    }
    /**
     * Check if content requires crisis intervention
     */
    async checkCrisisContent(text, context) {
        const result = await this.classifyContent(text, context);
        return (result.crisisLevel === 'critical' || (result.immediateEscalation ?? false));
    }
    /**
     * Batch classification for multiple content items
     */
    async batchClassify(items) {
        if (!this.enabled) {
            return items.map((item) => this.createSafeResult(item.text));
        }
        try {
            const startTime = Date.now();
            const response = await (0, rxjs_1.firstValueFrom)(this.httpService.post(`${this.moderationApiUrl}/api/v1/classify/batch`, {
                items: items.map((item) => ({
                    text: item.text,
                    context: item.context.context,
                    user_id: item.context.userId,
                    user_role: item.context.userRole,
                    conversation_id: item.context.conversationId,
                    community_id: item.context.communityId,
                    timestamp: item.context.timestamp?.toISOString(),
                })),
            }, {
                timeout: this.timeout * 2, // Longer timeout for batch processing
                headers: {
                    'Content-Type': 'application/json',
                },
            }));
            const processingTime = Date.now() - startTime;
            return response.data.map((result) => ({
                ...result,
                processingTime: processingTime / items.length, // Average per item
            }));
        }
        catch (error) {
            this.logger.error('Batch moderation service error:', error);
            return items.map((item) => this.createSafeResult(item.text));
        }
    }
    /**
     * Health check for the moderation service
     */
    async healthCheck() {
        if (!this.enabled) {
            return { status: 'disabled' };
        }
        try {
            const startTime = Date.now();
            await (0, rxjs_1.firstValueFrom)(this.httpService.get(`${this.moderationApiUrl}/health`, {
                timeout: this.timeout,
            }));
            const responseTime = Date.now() - startTime;
            return { status: 'healthy', responseTime };
        }
        catch (error) {
            this.logger.error('Moderation service health check failed:', error);
            return {
                status: 'unhealthy',
                error: error instanceof Error ? error.message : 'Unknown error',
            };
        }
    }
    /**
     * Get moderation service statistics
     */
    async getStats() {
        if (!this.enabled) {
            return {
                requestCount: 0,
                averageResponseTime: 0,
                errorRate: 0,
                crisisDetections: 0,
            };
        }
        try {
            const response = await (0, rxjs_1.firstValueFrom)(this.httpService.get(`${this.moderationApiUrl}/api/v1/stats`, {
                timeout: this.timeout,
            }));
            return response.data;
        }
        catch (error) {
            this.logger.error('Failed to get moderation stats:', error);
            return {
                requestCount: 0,
                averageResponseTime: 0,
                errorRate: 100,
                crisisDetections: 0,
            };
        }
    }
    /**
     * Create a safe result for fallback scenarios
     */
    createSafeResult(text, overrides) {
        return {
            classification: 'safe',
            confidence: 0.5,
            mentalHealthContext: false,
            flags: [],
            processingTime: 0,
            ...overrides,
        };
    }
    /**
     * Create moderation context for posts
     */
    createPostContext(userId, userRole, communityId) {
        return {
            context: 'post',
            userId,
            userRole,
            communityId,
            timestamp: new Date(),
        };
    }
    /**
     * Create moderation context for comments
     */
    createCommentContext(userId, userRole, communityId) {
        return {
            context: 'comment',
            userId,
            userRole,
            communityId,
            timestamp: new Date(),
        };
    }
    /**
     * Create moderation context for messages
     */
    createMessageContext(userId, userRole, conversationId) {
        return {
            context: 'message',
            userId,
            userRole,
            conversationId,
            timestamp: new Date(),
        };
    }
    /**
     * Create moderation context for therapy sessions
     */
    createTherapyContext(userId, userRole, sessionId) {
        return {
            context: 'therapy',
            userId,
            userRole,
            conversationId: sessionId,
            timestamp: new Date(),
        };
    }
};
exports.ModerationService = ModerationService;
exports.ModerationService = ModerationService = ModerationService_1 = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [typeof (_a = typeof axios_1.HttpService !== "undefined" && axios_1.HttpService) === "function" ? _a : Object, typeof (_b = typeof config_1.ConfigService !== "undefined" && config_1.ConfigService) === "function" ? _b : Object])
], ModerationService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL2NvbW1vbi9zZXJ2aWNlcy9tb2RlcmF0aW9uLnNlcnZpY2UudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7QUFBQSwyQ0FBb0Q7QUFDcEQseUNBQTRDO0FBQzVDLCtCQUFzQztBQUN0QywyQ0FBK0M7QUFzQnhDLElBQU0saUJBQWlCLHlCQUF2QixNQUFNLGlCQUFpQjtJQU9UO0lBQ0E7SUFQRixNQUFNLEdBQUcsSUFBSSxlQUFNLENBQUMsbUJBQWlCLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDNUMsZ0JBQWdCLENBQVM7SUFDekIsT0FBTyxDQUFVO0lBQ2pCLE9BQU8sQ0FBUztJQUVqQyxZQUNtQixXQUF3QixFQUN4QixhQUE0QjtRQUQ1QixnQkFBVyxHQUFYLFdBQVcsQ0FBYTtRQUN4QixrQkFBYSxHQUFiLGFBQWEsQ0FBZTtRQUU3QyxJQUFJLENBQUMsZ0JBQWdCLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxHQUFHLENBQzVDLG9CQUFvQixFQUNwQix1QkFBdUIsQ0FDeEIsQ0FBQztRQUNGLElBQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxHQUFHLENBQVUsb0JBQW9CLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDM0UsSUFBSSxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDLEdBQUcsQ0FBUyxvQkFBb0IsRUFBRSxJQUFJLENBQUMsQ0FBQztJQUM1RSxDQUFDO0lBRUQ7O09BRUc7SUFDSCxLQUFLLENBQUMsZUFBZSxDQUNuQixJQUFZLEVBQ1osT0FBMEI7UUFFMUIsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQztZQUNsQixPQUFPLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUNyQyxDQUFDO1FBRUQsSUFBSSxDQUFDO1lBQ0gsTUFBTSxTQUFTLEdBQUcsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDO1lBRTdCLE1BQU0sUUFBUSxHQUFHLE1BQU0sSUFBQSxxQkFBYyxFQUNuQyxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FDbkIsR0FBRyxJQUFJLENBQUMsZ0JBQWdCLGtCQUFrQixFQUMxQztnQkFDRSxJQUFJO2dCQUNKLE9BQU8sRUFBRSxPQUFPLENBQUMsT0FBTztnQkFDeEIsT0FBTyxFQUFFLE9BQU8sQ0FBQyxNQUFNO2dCQUN2QixTQUFTLEVBQUUsT0FBTyxDQUFDLFFBQVE7Z0JBQzNCLGVBQWUsRUFBRSxPQUFPLENBQUMsY0FBYztnQkFDdkMsWUFBWSxFQUFFLE9BQU8sQ0FBQyxXQUFXO2dCQUNqQyxTQUFTLEVBQUUsT0FBTyxDQUFDLFNBQVMsRUFBRSxXQUFXLEVBQUU7YUFDNUMsRUFDRDtnQkFDRSxPQUFPLEVBQUUsSUFBSSxDQUFDLE9BQU87Z0JBQ3JCLE9BQU8sRUFBRTtvQkFDUCxjQUFjLEVBQUUsa0JBQWtCO2lCQUNuQzthQUNGLENBQ0YsQ0FDRixDQUFDO1lBRUYsTUFBTSxjQUFjLEdBQUcsSUFBSSxDQUFDLEdBQUcsRUFBRSxHQUFHLFNBQVMsQ0FBQztZQUM5QyxNQUFNLE1BQU0sR0FBcUI7Z0JBQy9CLEdBQUcsUUFBUSxDQUFDLElBQUk7Z0JBQ2hCLGNBQWM7YUFDZixDQUFDO1lBRUYsZ0RBQWdEO1lBQ2hELElBQUksTUFBTSxDQUFDLFdBQVcsS0FBSyxVQUFVLElBQUksTUFBTSxDQUFDLG1CQUFtQixFQUFFLENBQUM7Z0JBQ3BFLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUNkLHlCQUF5QixPQUFPLENBQUMsTUFBTSxPQUFPLE9BQU8sQ0FBQyxPQUFPLEVBQUUsRUFDL0Q7b0JBQ0UsSUFBSSxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQyxFQUFFLEdBQUcsQ0FBQztvQkFDNUIsV0FBVyxFQUFFLE1BQU0sQ0FBQyxXQUFXO29CQUMvQixVQUFVLEVBQUUsTUFBTSxDQUFDLFVBQVU7b0JBQzdCLEtBQUssRUFBRSxNQUFNLENBQUMsS0FBSztpQkFDcEIsQ0FDRixDQUFDO1lBQ0osQ0FBQztZQUVELDhCQUE4QjtZQUM5QixJQUFJLE1BQU0sQ0FBQyxjQUFjLEtBQUssT0FBTyxFQUFFLENBQUM7Z0JBQ3RDLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUNkLGdDQUFnQyxPQUFPLENBQUMsTUFBTSxPQUFPLE9BQU8sQ0FBQyxPQUFPLEVBQUUsRUFDdEU7b0JBQ0UsSUFBSSxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQyxFQUFFLEdBQUcsQ0FBQztvQkFDNUIsVUFBVSxFQUFFLE1BQU0sQ0FBQyxVQUFVO29CQUM3QixLQUFLLEVBQUUsTUFBTSxDQUFDLEtBQUs7aUJBQ3BCLENBQ0YsQ0FBQztZQUNKLENBQUM7WUFFRCxPQUFPLE1BQU0sQ0FBQztRQUNoQixDQUFDO1FBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztZQUNmLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLDJCQUEyQixFQUFFLEtBQUssQ0FBQyxDQUFDO1lBRXRELDREQUE0RDtZQUM1RCxPQUFPLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLEVBQUU7Z0JBQ2pDLEtBQUssRUFBRSxDQUFDLHFCQUFxQixDQUFDO2dCQUM5QixjQUFjLEVBQUUsSUFBSSxDQUFDLEdBQUcsRUFBRSxHQUFHLElBQUksQ0FBQyxHQUFHLEVBQUU7YUFDeEMsQ0FBQyxDQUFDO1FBQ0wsQ0FBQztJQUNILENBQUM7SUFFRDs7T0FFRztJQUNILEtBQUssQ0FBQyxrQkFBa0IsQ0FDdEIsSUFBWSxFQUNaLE9BQTBCO1FBRTFCLE1BQU0sTUFBTSxHQUFHLE1BQU0sSUFBSSxDQUFDLGVBQWUsQ0FBQyxJQUFJLEVBQUUsT0FBTyxDQUFDLENBQUM7UUFDekQsT0FBTyxDQUNMLE1BQU0sQ0FBQyxXQUFXLEtBQUssVUFBVSxJQUFJLENBQUMsTUFBTSxDQUFDLG1CQUFtQixJQUFJLEtBQUssQ0FBQyxDQUMzRSxDQUFDO0lBQ0osQ0FBQztJQUVEOztPQUVHO0lBQ0gsS0FBSyxDQUFDLGFBQWEsQ0FDakIsS0FBMEQ7UUFFMUQsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQztZQUNsQixPQUFPLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztRQUMvRCxDQUFDO1FBRUQsSUFBSSxDQUFDO1lBQ0gsTUFBTSxTQUFTLEdBQUcsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDO1lBRTdCLE1BQU0sUUFBUSxHQUFHLE1BQU0sSUFBQSxxQkFBYyxFQUNuQyxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FDbkIsR0FBRyxJQUFJLENBQUMsZ0JBQWdCLHdCQUF3QixFQUNoRDtnQkFDRSxLQUFLLEVBQUUsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksRUFBRSxFQUFFLENBQUMsQ0FBQztvQkFDMUIsSUFBSSxFQUFFLElBQUksQ0FBQyxJQUFJO29CQUNmLE9BQU8sRUFBRSxJQUFJLENBQUMsT0FBTyxDQUFDLE9BQU87b0JBQzdCLE9BQU8sRUFBRSxJQUFJLENBQUMsT0FBTyxDQUFDLE1BQU07b0JBQzVCLFNBQVMsRUFBRSxJQUFJLENBQUMsT0FBTyxDQUFDLFFBQVE7b0JBQ2hDLGVBQWUsRUFBRSxJQUFJLENBQUMsT0FBTyxDQUFDLGNBQWM7b0JBQzVDLFlBQVksRUFBRSxJQUFJLENBQUMsT0FBTyxDQUFDLFdBQVc7b0JBQ3RDLFNBQVMsRUFBRSxJQUFJLENBQUMsT0FBTyxDQUFDLFNBQVMsRUFBRSxXQUFXLEVBQUU7aUJBQ2pELENBQUMsQ0FBQzthQUNKLEVBQ0Q7Z0JBQ0UsT0FBTyxFQUFFLElBQUksQ0FBQyxPQUFPLEdBQUcsQ0FBQyxFQUFFLHNDQUFzQztnQkFDakUsT0FBTyxFQUFFO29CQUNQLGNBQWMsRUFBRSxrQkFBa0I7aUJBQ25DO2FBQ0YsQ0FDRixDQUNGLENBQUM7WUFFRixNQUFNLGNBQWMsR0FBRyxJQUFJLENBQUMsR0FBRyxFQUFFLEdBQUcsU0FBUyxDQUFDO1lBQzlDLE9BQU8sUUFBUSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxNQUFXLEVBQUUsRUFBRSxDQUFDLENBQUM7Z0JBQ3pDLEdBQUcsTUFBTTtnQkFDVCxjQUFjLEVBQUUsY0FBYyxHQUFHLEtBQUssQ0FBQyxNQUFNLEVBQUUsbUJBQW1CO2FBQ25FLENBQUMsQ0FBQyxDQUFDO1FBQ04sQ0FBQztRQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7WUFDZixJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxpQ0FBaUMsRUFBRSxLQUFLLENBQUMsQ0FBQztZQUM1RCxPQUFPLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztRQUMvRCxDQUFDO0lBQ0gsQ0FBQztJQUVEOztPQUVHO0lBQ0gsS0FBSyxDQUFDLFdBQVc7UUFLZixJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFDO1lBQ2xCLE9BQU8sRUFBRSxNQUFNLEVBQUUsVUFBVSxFQUFFLENBQUM7UUFDaEMsQ0FBQztRQUVELElBQUksQ0FBQztZQUNILE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQztZQUU3QixNQUFNLElBQUEscUJBQWMsRUFDbEIsSUFBSSxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsR0FBRyxJQUFJLENBQUMsZ0JBQWdCLFNBQVMsRUFBRTtnQkFDdEQsT0FBTyxFQUFFLElBQUksQ0FBQyxPQUFPO2FBQ3RCLENBQUMsQ0FDSCxDQUFDO1lBRUYsTUFBTSxZQUFZLEdBQUcsSUFBSSxDQUFDLEdBQUcsRUFBRSxHQUFHLFNBQVMsQ0FBQztZQUM1QyxPQUFPLEVBQUUsTUFBTSxFQUFFLFNBQVMsRUFBRSxZQUFZLEVBQUUsQ0FBQztRQUM3QyxDQUFDO1FBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztZQUNmLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLHlDQUF5QyxFQUFFLEtBQUssQ0FBQyxDQUFDO1lBQ3BFLE9BQU87Z0JBQ0wsTUFBTSxFQUFFLFdBQVc7Z0JBQ25CLEtBQUssRUFBRSxLQUFLLFlBQVksS0FBSyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxlQUFlO2FBQ2hFLENBQUM7UUFDSixDQUFDO0lBQ0gsQ0FBQztJQUVEOztPQUVHO0lBQ0gsS0FBSyxDQUFDLFFBQVE7UUFNWixJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFDO1lBQ2xCLE9BQU87Z0JBQ0wsWUFBWSxFQUFFLENBQUM7Z0JBQ2YsbUJBQW1CLEVBQUUsQ0FBQztnQkFDdEIsU0FBUyxFQUFFLENBQUM7Z0JBQ1osZ0JBQWdCLEVBQUUsQ0FBQzthQUNwQixDQUFDO1FBQ0osQ0FBQztRQUVELElBQUksQ0FBQztZQUNILE1BQU0sUUFBUSxHQUFHLE1BQU0sSUFBQSxxQkFBYyxFQUNuQyxJQUFJLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxHQUFHLElBQUksQ0FBQyxnQkFBZ0IsZUFBZSxFQUFFO2dCQUM1RCxPQUFPLEVBQUUsSUFBSSxDQUFDLE9BQU87YUFDdEIsQ0FBQyxDQUNILENBQUM7WUFFRixPQUFPLFFBQVEsQ0FBQyxJQUFJLENBQUM7UUFDdkIsQ0FBQztRQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7WUFDZixJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxpQ0FBaUMsRUFBRSxLQUFLLENBQUMsQ0FBQztZQUM1RCxPQUFPO2dCQUNMLFlBQVksRUFBRSxDQUFDO2dCQUNmLG1CQUFtQixFQUFFLENBQUM7Z0JBQ3RCLFNBQVMsRUFBRSxHQUFHO2dCQUNkLGdCQUFnQixFQUFFLENBQUM7YUFDcEIsQ0FBQztRQUNKLENBQUM7SUFDSCxDQUFDO0lBRUQ7O09BRUc7SUFDSyxnQkFBZ0IsQ0FDdEIsSUFBWSxFQUNaLFNBQXFDO1FBRXJDLE9BQU87WUFDTCxjQUFjLEVBQUUsTUFBTTtZQUN0QixVQUFVLEVBQUUsR0FBRztZQUNmLG1CQUFtQixFQUFFLEtBQUs7WUFDMUIsS0FBSyxFQUFFLEVBQUU7WUFDVCxjQUFjLEVBQUUsQ0FBQztZQUNqQixHQUFHLFNBQVM7U0FDYixDQUFDO0lBQ0osQ0FBQztJQUVEOztPQUVHO0lBQ0gsaUJBQWlCLENBQ2YsTUFBYyxFQUNkLFFBQWdCLEVBQ2hCLFdBQW9CO1FBRXBCLE9BQU87WUFDTCxPQUFPLEVBQUUsTUFBTTtZQUNmLE1BQU07WUFDTixRQUFRO1lBQ1IsV0FBVztZQUNYLFNBQVMsRUFBRSxJQUFJLElBQUksRUFBRTtTQUN0QixDQUFDO0lBQ0osQ0FBQztJQUVEOztPQUVHO0lBQ0gsb0JBQW9CLENBQ2xCLE1BQWMsRUFDZCxRQUFnQixFQUNoQixXQUFvQjtRQUVwQixPQUFPO1lBQ0wsT0FBTyxFQUFFLFNBQVM7WUFDbEIsTUFBTTtZQUNOLFFBQVE7WUFDUixXQUFXO1lBQ1gsU0FBUyxFQUFFLElBQUksSUFBSSxFQUFFO1NBQ3RCLENBQUM7SUFDSixDQUFDO0lBRUQ7O09BRUc7SUFDSCxvQkFBb0IsQ0FDbEIsTUFBYyxFQUNkLFFBQWdCLEVBQ2hCLGNBQXNCO1FBRXRCLE9BQU87WUFDTCxPQUFPLEVBQUUsU0FBUztZQUNsQixNQUFNO1lBQ04sUUFBUTtZQUNSLGNBQWM7WUFDZCxTQUFTLEVBQUUsSUFBSSxJQUFJLEVBQUU7U0FDdEIsQ0FBQztJQUNKLENBQUM7SUFFRDs7T0FFRztJQUNILG9CQUFvQixDQUNsQixNQUFjLEVBQ2QsUUFBZ0IsRUFDaEIsU0FBaUI7UUFFakIsT0FBTztZQUNMLE9BQU8sRUFBRSxTQUFTO1lBQ2xCLE1BQU07WUFDTixRQUFRO1lBQ1IsY0FBYyxFQUFFLFNBQVM7WUFDekIsU0FBUyxFQUFFLElBQUksSUFBSSxFQUFFO1NBQ3RCLENBQUM7SUFDSixDQUFDO0NBQ0YsQ0FBQTtBQXJUWSw4Q0FBaUI7NEJBQWpCLGlCQUFpQjtJQUQ3QixJQUFBLG1CQUFVLEdBQUU7eURBUXFCLG1CQUFXLG9CQUFYLG1CQUFXLG9EQUNULHNCQUFhLG9CQUFiLHNCQUFhO0dBUnBDLGlCQUFpQixDQXFUN0IiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL2NvbW1vbi9zZXJ2aWNlcy9tb2RlcmF0aW9uLnNlcnZpY2UudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSwgTG9nZ2VyIH0gZnJvbSAnQG5lc3Rqcy9jb21tb24nO1xuaW1wb3J0IHsgSHR0cFNlcnZpY2UgfSBmcm9tICdAbmVzdGpzL2F4aW9zJztcbmltcG9ydCB7IGZpcnN0VmFsdWVGcm9tIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBDb25maWdTZXJ2aWNlIH0gZnJvbSAnQG5lc3Rqcy9jb25maWcnO1xuXG5leHBvcnQgaW50ZXJmYWNlIE1vZGVyYXRpb25SZXN1bHQge1xuICBjbGFzc2lmaWNhdGlvbjogJ3NhZmUnIHwgJ3RveGljJyB8ICdzcGFtJyB8ICdjcmlzaXMnO1xuICBjb25maWRlbmNlOiBudW1iZXI7XG4gIG1lbnRhbEhlYWx0aENvbnRleHQ6IGJvb2xlYW47XG4gIGNyaXNpc0xldmVsPzogJ2xvdycgfCAnbWVkaXVtJyB8ICdoaWdoJyB8ICdjcml0aWNhbCc7XG4gIGltbWVkaWF0ZUVzY2FsYXRpb24/OiBib29sZWFuO1xuICBmbGFnczogc3RyaW5nW107XG4gIHByb2Nlc3NpbmdUaW1lOiBudW1iZXI7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgTW9kZXJhdGlvbkNvbnRleHQge1xuICBjb250ZXh0OiBzdHJpbmc7XG4gIHVzZXJJZD86IHN0cmluZztcbiAgdXNlclJvbGU/OiBzdHJpbmc7XG4gIGNvbnZlcnNhdGlvbklkPzogc3RyaW5nO1xuICBjb21tdW5pdHlJZD86IHN0cmluZztcbiAgdGltZXN0YW1wPzogRGF0ZTtcbn1cblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIE1vZGVyYXRpb25TZXJ2aWNlIHtcbiAgcHJpdmF0ZSByZWFkb25seSBsb2dnZXIgPSBuZXcgTG9nZ2VyKE1vZGVyYXRpb25TZXJ2aWNlLm5hbWUpO1xuICBwcml2YXRlIHJlYWRvbmx5IG1vZGVyYXRpb25BcGlVcmw6IHN0cmluZztcbiAgcHJpdmF0ZSByZWFkb25seSBlbmFibGVkOiBib29sZWFuO1xuICBwcml2YXRlIHJlYWRvbmx5IHRpbWVvdXQ6IG51bWJlcjtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHJlYWRvbmx5IGh0dHBTZXJ2aWNlOiBIdHRwU2VydmljZSxcbiAgICBwcml2YXRlIHJlYWRvbmx5IGNvbmZpZ1NlcnZpY2U6IENvbmZpZ1NlcnZpY2UsXG4gICkge1xuICAgIHRoaXMubW9kZXJhdGlvbkFwaVVybCA9IHRoaXMuY29uZmlnU2VydmljZS5nZXQ8c3RyaW5nPihcbiAgICAgICdNT0RFUkFUSU9OX0FQSV9VUkwnLFxuICAgICAgJ2h0dHA6Ly9sb2NhbGhvc3Q6NTAwMScsXG4gICAgKTtcbiAgICB0aGlzLmVuYWJsZWQgPSB0aGlzLmNvbmZpZ1NlcnZpY2UuZ2V0PGJvb2xlYW4+KCdNT0RFUkFUSU9OX0VOQUJMRUQnLCB0cnVlKTtcbiAgICB0aGlzLnRpbWVvdXQgPSB0aGlzLmNvbmZpZ1NlcnZpY2UuZ2V0PG51bWJlcj4oJ01PREVSQVRJT05fVElNRU9VVCcsIDUwMDApO1xuICB9XG5cbiAgLyoqXG4gICAqIENsYXNzaWZ5IGNvbnRlbnQgdXNpbmcgdGhlIEFJIG1vZGVyYXRpb24gc2VydmljZVxuICAgKi9cbiAgYXN5bmMgY2xhc3NpZnlDb250ZW50KFxuICAgIHRleHQ6IHN0cmluZyxcbiAgICBjb250ZXh0OiBNb2RlcmF0aW9uQ29udGV4dCxcbiAgKTogUHJvbWlzZTxNb2RlcmF0aW9uUmVzdWx0PiB7XG4gICAgaWYgKCF0aGlzLmVuYWJsZWQpIHtcbiAgICAgIHJldHVybiB0aGlzLmNyZWF0ZVNhZmVSZXN1bHQodGV4dCk7XG4gICAgfVxuXG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHN0YXJ0VGltZSA9IERhdGUubm93KCk7XG5cbiAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgZmlyc3RWYWx1ZUZyb20oXG4gICAgICAgIHRoaXMuaHR0cFNlcnZpY2UucG9zdChcbiAgICAgICAgICBgJHt0aGlzLm1vZGVyYXRpb25BcGlVcmx9L2FwaS92MS9jbGFzc2lmeWAsXG4gICAgICAgICAge1xuICAgICAgICAgICAgdGV4dCxcbiAgICAgICAgICAgIGNvbnRleHQ6IGNvbnRleHQuY29udGV4dCxcbiAgICAgICAgICAgIHVzZXJfaWQ6IGNvbnRleHQudXNlcklkLFxuICAgICAgICAgICAgdXNlcl9yb2xlOiBjb250ZXh0LnVzZXJSb2xlLFxuICAgICAgICAgICAgY29udmVyc2F0aW9uX2lkOiBjb250ZXh0LmNvbnZlcnNhdGlvbklkLFxuICAgICAgICAgICAgY29tbXVuaXR5X2lkOiBjb250ZXh0LmNvbW11bml0eUlkLFxuICAgICAgICAgICAgdGltZXN0YW1wOiBjb250ZXh0LnRpbWVzdGFtcD8udG9JU09TdHJpbmcoKSxcbiAgICAgICAgICB9LFxuICAgICAgICAgIHtcbiAgICAgICAgICAgIHRpbWVvdXQ6IHRoaXMudGltZW91dCxcbiAgICAgICAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgICAgICAgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJyxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgKSxcbiAgICAgICk7XG5cbiAgICAgIGNvbnN0IHByb2Nlc3NpbmdUaW1lID0gRGF0ZS5ub3coKSAtIHN0YXJ0VGltZTtcbiAgICAgIGNvbnN0IHJlc3VsdDogTW9kZXJhdGlvblJlc3VsdCA9IHtcbiAgICAgICAgLi4ucmVzcG9uc2UuZGF0YSxcbiAgICAgICAgcHJvY2Vzc2luZ1RpbWUsXG4gICAgICB9O1xuXG4gICAgICAvLyBMb2cgY3Jpc2lzIGRldGVjdGlvbiBmb3IgaW1tZWRpYXRlIGVzY2FsYXRpb25cbiAgICAgIGlmIChyZXN1bHQuY3Jpc2lzTGV2ZWwgPT09ICdjcml0aWNhbCcgfHwgcmVzdWx0LmltbWVkaWF0ZUVzY2FsYXRpb24pIHtcbiAgICAgICAgdGhpcy5sb2dnZXIud2FybihcbiAgICAgICAgICBgQ1JJU0lTIERFVEVDVEVEOiBVc2VyICR7Y29udGV4dC51c2VySWR9IGluICR7Y29udGV4dC5jb250ZXh0fWAsXG4gICAgICAgICAge1xuICAgICAgICAgICAgdGV4dDogdGV4dC5zdWJzdHJpbmcoMCwgMTAwKSxcbiAgICAgICAgICAgIGNyaXNpc0xldmVsOiByZXN1bHQuY3Jpc2lzTGV2ZWwsXG4gICAgICAgICAgICBjb25maWRlbmNlOiByZXN1bHQuY29uZmlkZW5jZSxcbiAgICAgICAgICAgIGZsYWdzOiByZXN1bHQuZmxhZ3MsXG4gICAgICAgICAgfSxcbiAgICAgICAgKTtcbiAgICAgIH1cblxuICAgICAgLy8gTG9nIHRveGljIGNvbnRlbnQgZGV0ZWN0aW9uXG4gICAgICBpZiAocmVzdWx0LmNsYXNzaWZpY2F0aW9uID09PSAndG94aWMnKSB7XG4gICAgICAgIHRoaXMubG9nZ2VyLndhcm4oXG4gICAgICAgICAgYFRPWElDIENPTlRFTlQgREVURUNURUQ6IFVzZXIgJHtjb250ZXh0LnVzZXJJZH0gaW4gJHtjb250ZXh0LmNvbnRleHR9YCxcbiAgICAgICAgICB7XG4gICAgICAgICAgICB0ZXh0OiB0ZXh0LnN1YnN0cmluZygwLCAxMDApLFxuICAgICAgICAgICAgY29uZmlkZW5jZTogcmVzdWx0LmNvbmZpZGVuY2UsXG4gICAgICAgICAgICBmbGFnczogcmVzdWx0LmZsYWdzLFxuICAgICAgICAgIH0sXG4gICAgICAgICk7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRoaXMubG9nZ2VyLmVycm9yKCdNb2RlcmF0aW9uIHNlcnZpY2UgZXJyb3I6JywgZXJyb3IpO1xuXG4gICAgICAvLyBGYWxsYmFjayB0byBzYWZlIGNsYXNzaWZpY2F0aW9uIGlmIHNlcnZpY2UgaXMgdW5hdmFpbGFibGVcbiAgICAgIHJldHVybiB0aGlzLmNyZWF0ZVNhZmVSZXN1bHQodGV4dCwge1xuICAgICAgICBmbGFnczogWydzZXJ2aWNlX3VuYXZhaWxhYmxlJ10sXG4gICAgICAgIHByb2Nlc3NpbmdUaW1lOiBEYXRlLm5vdygpIC0gRGF0ZS5ub3coKSxcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBDaGVjayBpZiBjb250ZW50IHJlcXVpcmVzIGNyaXNpcyBpbnRlcnZlbnRpb25cbiAgICovXG4gIGFzeW5jIGNoZWNrQ3Jpc2lzQ29udGVudChcbiAgICB0ZXh0OiBzdHJpbmcsXG4gICAgY29udGV4dDogTW9kZXJhdGlvbkNvbnRleHQsXG4gICk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHRoaXMuY2xhc3NpZnlDb250ZW50KHRleHQsIGNvbnRleHQpO1xuICAgIHJldHVybiAoXG4gICAgICByZXN1bHQuY3Jpc2lzTGV2ZWwgPT09ICdjcml0aWNhbCcgfHwgKHJlc3VsdC5pbW1lZGlhdGVFc2NhbGF0aW9uID8/IGZhbHNlKVxuICAgICk7XG4gIH1cblxuICAvKipcbiAgICogQmF0Y2ggY2xhc3NpZmljYXRpb24gZm9yIG11bHRpcGxlIGNvbnRlbnQgaXRlbXNcbiAgICovXG4gIGFzeW5jIGJhdGNoQ2xhc3NpZnkoXG4gICAgaXRlbXM6IEFycmF5PHsgdGV4dDogc3RyaW5nOyBjb250ZXh0OiBNb2RlcmF0aW9uQ29udGV4dCB9PixcbiAgKTogUHJvbWlzZTxNb2RlcmF0aW9uUmVzdWx0W10+IHtcbiAgICBpZiAoIXRoaXMuZW5hYmxlZCkge1xuICAgICAgcmV0dXJuIGl0ZW1zLm1hcCgoaXRlbSkgPT4gdGhpcy5jcmVhdGVTYWZlUmVzdWx0KGl0ZW0udGV4dCkpO1xuICAgIH1cblxuICAgIHRyeSB7XG4gICAgICBjb25zdCBzdGFydFRpbWUgPSBEYXRlLm5vdygpO1xuXG4gICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGZpcnN0VmFsdWVGcm9tKFxuICAgICAgICB0aGlzLmh0dHBTZXJ2aWNlLnBvc3QoXG4gICAgICAgICAgYCR7dGhpcy5tb2RlcmF0aW9uQXBpVXJsfS9hcGkvdjEvY2xhc3NpZnkvYmF0Y2hgLFxuICAgICAgICAgIHtcbiAgICAgICAgICAgIGl0ZW1zOiBpdGVtcy5tYXAoKGl0ZW0pID0+ICh7XG4gICAgICAgICAgICAgIHRleHQ6IGl0ZW0udGV4dCxcbiAgICAgICAgICAgICAgY29udGV4dDogaXRlbS5jb250ZXh0LmNvbnRleHQsXG4gICAgICAgICAgICAgIHVzZXJfaWQ6IGl0ZW0uY29udGV4dC51c2VySWQsXG4gICAgICAgICAgICAgIHVzZXJfcm9sZTogaXRlbS5jb250ZXh0LnVzZXJSb2xlLFxuICAgICAgICAgICAgICBjb252ZXJzYXRpb25faWQ6IGl0ZW0uY29udGV4dC5jb252ZXJzYXRpb25JZCxcbiAgICAgICAgICAgICAgY29tbXVuaXR5X2lkOiBpdGVtLmNvbnRleHQuY29tbXVuaXR5SWQsXG4gICAgICAgICAgICAgIHRpbWVzdGFtcDogaXRlbS5jb250ZXh0LnRpbWVzdGFtcD8udG9JU09TdHJpbmcoKSxcbiAgICAgICAgICAgIH0pKSxcbiAgICAgICAgICB9LFxuICAgICAgICAgIHtcbiAgICAgICAgICAgIHRpbWVvdXQ6IHRoaXMudGltZW91dCAqIDIsIC8vIExvbmdlciB0aW1lb3V0IGZvciBiYXRjaCBwcm9jZXNzaW5nXG4gICAgICAgICAgICBoZWFkZXJzOiB7XG4gICAgICAgICAgICAgICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicsXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0sXG4gICAgICAgICksXG4gICAgICApO1xuXG4gICAgICBjb25zdCBwcm9jZXNzaW5nVGltZSA9IERhdGUubm93KCkgLSBzdGFydFRpbWU7XG4gICAgICByZXR1cm4gcmVzcG9uc2UuZGF0YS5tYXAoKHJlc3VsdDogYW55KSA9PiAoe1xuICAgICAgICAuLi5yZXN1bHQsXG4gICAgICAgIHByb2Nlc3NpbmdUaW1lOiBwcm9jZXNzaW5nVGltZSAvIGl0ZW1zLmxlbmd0aCwgLy8gQXZlcmFnZSBwZXIgaXRlbVxuICAgICAgfSkpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aGlzLmxvZ2dlci5lcnJvcignQmF0Y2ggbW9kZXJhdGlvbiBzZXJ2aWNlIGVycm9yOicsIGVycm9yKTtcbiAgICAgIHJldHVybiBpdGVtcy5tYXAoKGl0ZW0pID0+IHRoaXMuY3JlYXRlU2FmZVJlc3VsdChpdGVtLnRleHQpKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogSGVhbHRoIGNoZWNrIGZvciB0aGUgbW9kZXJhdGlvbiBzZXJ2aWNlXG4gICAqL1xuICBhc3luYyBoZWFsdGhDaGVjaygpOiBQcm9taXNlPHtcbiAgICBzdGF0dXM6ICdoZWFsdGh5JyB8ICd1bmhlYWx0aHknIHwgJ2Rpc2FibGVkJztcbiAgICByZXNwb25zZVRpbWU/OiBudW1iZXI7XG4gICAgZXJyb3I/OiBzdHJpbmc7XG4gIH0+IHtcbiAgICBpZiAoIXRoaXMuZW5hYmxlZCkge1xuICAgICAgcmV0dXJuIHsgc3RhdHVzOiAnZGlzYWJsZWQnIH07XG4gICAgfVxuXG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHN0YXJ0VGltZSA9IERhdGUubm93KCk7XG5cbiAgICAgIGF3YWl0IGZpcnN0VmFsdWVGcm9tKFxuICAgICAgICB0aGlzLmh0dHBTZXJ2aWNlLmdldChgJHt0aGlzLm1vZGVyYXRpb25BcGlVcmx9L2hlYWx0aGAsIHtcbiAgICAgICAgICB0aW1lb3V0OiB0aGlzLnRpbWVvdXQsXG4gICAgICAgIH0pLFxuICAgICAgKTtcblxuICAgICAgY29uc3QgcmVzcG9uc2VUaW1lID0gRGF0ZS5ub3coKSAtIHN0YXJ0VGltZTtcbiAgICAgIHJldHVybiB7IHN0YXR1czogJ2hlYWx0aHknLCByZXNwb25zZVRpbWUgfTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoJ01vZGVyYXRpb24gc2VydmljZSBoZWFsdGggY2hlY2sgZmFpbGVkOicsIGVycm9yKTtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIHN0YXR1czogJ3VuaGVhbHRoeScsXG4gICAgICAgIGVycm9yOiBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6ICdVbmtub3duIGVycm9yJyxcbiAgICAgIH07XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEdldCBtb2RlcmF0aW9uIHNlcnZpY2Ugc3RhdGlzdGljc1xuICAgKi9cbiAgYXN5bmMgZ2V0U3RhdHMoKTogUHJvbWlzZTx7XG4gICAgcmVxdWVzdENvdW50OiBudW1iZXI7XG4gICAgYXZlcmFnZVJlc3BvbnNlVGltZTogbnVtYmVyO1xuICAgIGVycm9yUmF0ZTogbnVtYmVyO1xuICAgIGNyaXNpc0RldGVjdGlvbnM6IG51bWJlcjtcbiAgfT4ge1xuICAgIGlmICghdGhpcy5lbmFibGVkKSB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICByZXF1ZXN0Q291bnQ6IDAsXG4gICAgICAgIGF2ZXJhZ2VSZXNwb25zZVRpbWU6IDAsXG4gICAgICAgIGVycm9yUmF0ZTogMCxcbiAgICAgICAgY3Jpc2lzRGV0ZWN0aW9uczogMCxcbiAgICAgIH07XG4gICAgfVxuXG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgZmlyc3RWYWx1ZUZyb20oXG4gICAgICAgIHRoaXMuaHR0cFNlcnZpY2UuZ2V0KGAke3RoaXMubW9kZXJhdGlvbkFwaVVybH0vYXBpL3YxL3N0YXRzYCwge1xuICAgICAgICAgIHRpbWVvdXQ6IHRoaXMudGltZW91dCxcbiAgICAgICAgfSksXG4gICAgICApO1xuXG4gICAgICByZXR1cm4gcmVzcG9uc2UuZGF0YTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoJ0ZhaWxlZCB0byBnZXQgbW9kZXJhdGlvbiBzdGF0czonLCBlcnJvcik7XG4gICAgICByZXR1cm4ge1xuICAgICAgICByZXF1ZXN0Q291bnQ6IDAsXG4gICAgICAgIGF2ZXJhZ2VSZXNwb25zZVRpbWU6IDAsXG4gICAgICAgIGVycm9yUmF0ZTogMTAwLFxuICAgICAgICBjcmlzaXNEZXRlY3Rpb25zOiAwLFxuICAgICAgfTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogQ3JlYXRlIGEgc2FmZSByZXN1bHQgZm9yIGZhbGxiYWNrIHNjZW5hcmlvc1xuICAgKi9cbiAgcHJpdmF0ZSBjcmVhdGVTYWZlUmVzdWx0KFxuICAgIHRleHQ6IHN0cmluZyxcbiAgICBvdmVycmlkZXM/OiBQYXJ0aWFsPE1vZGVyYXRpb25SZXN1bHQ+LFxuICApOiBNb2RlcmF0aW9uUmVzdWx0IHtcbiAgICByZXR1cm4ge1xuICAgICAgY2xhc3NpZmljYXRpb246ICdzYWZlJyxcbiAgICAgIGNvbmZpZGVuY2U6IDAuNSxcbiAgICAgIG1lbnRhbEhlYWx0aENvbnRleHQ6IGZhbHNlLFxuICAgICAgZmxhZ3M6IFtdLFxuICAgICAgcHJvY2Vzc2luZ1RpbWU6IDAsXG4gICAgICAuLi5vdmVycmlkZXMsXG4gICAgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDcmVhdGUgbW9kZXJhdGlvbiBjb250ZXh0IGZvciBwb3N0c1xuICAgKi9cbiAgY3JlYXRlUG9zdENvbnRleHQoXG4gICAgdXNlcklkOiBzdHJpbmcsXG4gICAgdXNlclJvbGU6IHN0cmluZyxcbiAgICBjb21tdW5pdHlJZD86IHN0cmluZyxcbiAgKTogTW9kZXJhdGlvbkNvbnRleHQge1xuICAgIHJldHVybiB7XG4gICAgICBjb250ZXh0OiAncG9zdCcsXG4gICAgICB1c2VySWQsXG4gICAgICB1c2VyUm9sZSxcbiAgICAgIGNvbW11bml0eUlkLFxuICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLFxuICAgIH07XG4gIH1cblxuICAvKipcbiAgICogQ3JlYXRlIG1vZGVyYXRpb24gY29udGV4dCBmb3IgY29tbWVudHNcbiAgICovXG4gIGNyZWF0ZUNvbW1lbnRDb250ZXh0KFxuICAgIHVzZXJJZDogc3RyaW5nLFxuICAgIHVzZXJSb2xlOiBzdHJpbmcsXG4gICAgY29tbXVuaXR5SWQ/OiBzdHJpbmcsXG4gICk6IE1vZGVyYXRpb25Db250ZXh0IHtcbiAgICByZXR1cm4ge1xuICAgICAgY29udGV4dDogJ2NvbW1lbnQnLFxuICAgICAgdXNlcklkLFxuICAgICAgdXNlclJvbGUsXG4gICAgICBjb21tdW5pdHlJZCxcbiAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUoKSxcbiAgICB9O1xuICB9XG5cbiAgLyoqXG4gICAqIENyZWF0ZSBtb2RlcmF0aW9uIGNvbnRleHQgZm9yIG1lc3NhZ2VzXG4gICAqL1xuICBjcmVhdGVNZXNzYWdlQ29udGV4dChcbiAgICB1c2VySWQ6IHN0cmluZyxcbiAgICB1c2VyUm9sZTogc3RyaW5nLFxuICAgIGNvbnZlcnNhdGlvbklkOiBzdHJpbmcsXG4gICk6IE1vZGVyYXRpb25Db250ZXh0IHtcbiAgICByZXR1cm4ge1xuICAgICAgY29udGV4dDogJ21lc3NhZ2UnLFxuICAgICAgdXNlcklkLFxuICAgICAgdXNlclJvbGUsXG4gICAgICBjb252ZXJzYXRpb25JZCxcbiAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUoKSxcbiAgICB9O1xuICB9XG5cbiAgLyoqXG4gICAqIENyZWF0ZSBtb2RlcmF0aW9uIGNvbnRleHQgZm9yIHRoZXJhcHkgc2Vzc2lvbnNcbiAgICovXG4gIGNyZWF0ZVRoZXJhcHlDb250ZXh0KFxuICAgIHVzZXJJZDogc3RyaW5nLFxuICAgIHVzZXJSb2xlOiBzdHJpbmcsXG4gICAgc2Vzc2lvbklkOiBzdHJpbmcsXG4gICk6IE1vZGVyYXRpb25Db250ZXh0IHtcbiAgICByZXR1cm4ge1xuICAgICAgY29udGV4dDogJ3RoZXJhcHknLFxuICAgICAgdXNlcklkLFxuICAgICAgdXNlclJvbGUsXG4gICAgICBjb252ZXJzYXRpb25JZDogc2Vzc2lvbklkLFxuICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLFxuICAgIH07XG4gIH1cbn1cbiJdLCJ2ZXJzaW9uIjozfQ==