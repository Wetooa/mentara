{"file":"/home/wetooa/Documents/code/projects/mentara/mentara-api/src/common/services/moderation.service.ts","mappings":"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","names":[],"sources":["/home/wetooa/Documents/code/projects/mentara/mentara-api/src/common/services/moderation.service.ts"],"sourcesContent":["import { Injectable, Logger } from '@nestjs/common';\nimport { HttpService } from '@nestjs/axios';\nimport { firstValueFrom } from 'rxjs';\nimport { ConfigService } from '@nestjs/config';\n\nexport interface ModerationResult {\n  classification: 'safe' | 'toxic' | 'spam' | 'crisis';\n  confidence: number;\n  mentalHealthContext: boolean;\n  crisisLevel?: 'low' | 'medium' | 'high' | 'critical';\n  immediateEscalation?: boolean;\n  flags: string[];\n  processingTime: number;\n}\n\nexport interface ModerationContext {\n  context: string;\n  userId?: string;\n  userRole?: string;\n  conversationId?: string;\n  communityId?: string;\n  timestamp?: Date;\n}\n\n@Injectable()\nexport class ModerationService {\n  private readonly logger = new Logger(ModerationService.name);\n  private readonly moderationApiUrl: string;\n  private readonly enabled: boolean;\n  private readonly timeout: number;\n\n  constructor(\n    private readonly httpService: HttpService,\n    private readonly configService: ConfigService,\n  ) {\n    this.moderationApiUrl = this.configService.get<string>(\n      'MODERATION_API_URL',\n      'http://localhost:5001',\n    );\n    this.enabled = this.configService.get<boolean>('MODERATION_ENABLED', true);\n    this.timeout = this.configService.get<number>('MODERATION_TIMEOUT', 5000);\n  }\n\n  /**\n   * Classify content using the AI moderation service\n   */\n  async classifyContent(\n    text: string,\n    context: ModerationContext,\n  ): Promise<ModerationResult> {\n    if (!this.enabled) {\n      return this.createSafeResult(text);\n    }\n\n    try {\n      const startTime = Date.now();\n\n      const response = await firstValueFrom(\n        this.httpService.post(\n          `${this.moderationApiUrl}/api/v1/classify`,\n          {\n            text,\n            context: context.context,\n            user_id: context.userId,\n            user_role: context.userRole,\n            conversation_id: context.conversationId,\n            community_id: context.communityId,\n            timestamp: context.timestamp?.toISOString(),\n          },\n          {\n            timeout: this.timeout,\n            headers: {\n              'Content-Type': 'application/json',\n            },\n          },\n        ),\n      );\n\n      const processingTime = Date.now() - startTime;\n      const result: ModerationResult = {\n        ...response.data,\n        processingTime,\n      };\n\n      // Log crisis detection for immediate escalation\n      if (result.crisisLevel === 'critical' || result.immediateEscalation) {\n        this.logger.warn(\n          `CRISIS DETECTED: User ${context.userId} in ${context.context}`,\n          {\n            text: text.substring(0, 100),\n            crisisLevel: result.crisisLevel,\n            confidence: result.confidence,\n            flags: result.flags,\n          },\n        );\n      }\n\n      // Log toxic content detection\n      if (result.classification === 'toxic') {\n        this.logger.warn(\n          `TOXIC CONTENT DETECTED: User ${context.userId} in ${context.context}`,\n          {\n            text: text.substring(0, 100),\n            confidence: result.confidence,\n            flags: result.flags,\n          },\n        );\n      }\n\n      return result;\n    } catch (error) {\n      this.logger.error('Moderation service error:', error);\n\n      // Fallback to safe classification if service is unavailable\n      return this.createSafeResult(text, {\n        flags: ['service_unavailable'],\n        processingTime: Date.now() - Date.now(),\n      });\n    }\n  }\n\n  /**\n   * Check if content requires crisis intervention\n   */\n  async checkCrisisContent(\n    text: string,\n    context: ModerationContext,\n  ): Promise<boolean> {\n    const result = await this.classifyContent(text, context);\n    return (\n      result.crisisLevel === 'critical' || (result.immediateEscalation ?? false)\n    );\n  }\n\n  /**\n   * Batch classification for multiple content items\n   */\n  async batchClassify(\n    items: Array<{ text: string; context: ModerationContext }>,\n  ): Promise<ModerationResult[]> {\n    if (!this.enabled) {\n      return items.map((item) => this.createSafeResult(item.text));\n    }\n\n    try {\n      const startTime = Date.now();\n\n      const response = await firstValueFrom(\n        this.httpService.post(\n          `${this.moderationApiUrl}/api/v1/classify/batch`,\n          {\n            items: items.map((item) => ({\n              text: item.text,\n              context: item.context.context,\n              user_id: item.context.userId,\n              user_role: item.context.userRole,\n              conversation_id: item.context.conversationId,\n              community_id: item.context.communityId,\n              timestamp: item.context.timestamp?.toISOString(),\n            })),\n          },\n          {\n            timeout: this.timeout * 2, // Longer timeout for batch processing\n            headers: {\n              'Content-Type': 'application/json',\n            },\n          },\n        ),\n      );\n\n      const processingTime = Date.now() - startTime;\n      return response.data.map((result: any) => ({\n        ...result,\n        processingTime: processingTime / items.length, // Average per item\n      }));\n    } catch (error) {\n      this.logger.error('Batch moderation service error:', error);\n      return items.map((item) => this.createSafeResult(item.text));\n    }\n  }\n\n  /**\n   * Health check for the moderation service\n   */\n  async healthCheck(): Promise<{\n    status: 'healthy' | 'unhealthy' | 'disabled';\n    responseTime?: number;\n    error?: string;\n  }> {\n    if (!this.enabled) {\n      return { status: 'disabled' };\n    }\n\n    try {\n      const startTime = Date.now();\n\n      await firstValueFrom(\n        this.httpService.get(`${this.moderationApiUrl}/health`, {\n          timeout: this.timeout,\n        }),\n      );\n\n      const responseTime = Date.now() - startTime;\n      return { status: 'healthy', responseTime };\n    } catch (error) {\n      this.logger.error('Moderation service health check failed:', error);\n      return {\n        status: 'unhealthy',\n        error: error instanceof Error ? error.message : 'Unknown error',\n      };\n    }\n  }\n\n  /**\n   * Get moderation service statistics\n   */\n  async getStats(): Promise<{\n    requestCount: number;\n    averageResponseTime: number;\n    errorRate: number;\n    crisisDetections: number;\n  }> {\n    if (!this.enabled) {\n      return {\n        requestCount: 0,\n        averageResponseTime: 0,\n        errorRate: 0,\n        crisisDetections: 0,\n      };\n    }\n\n    try {\n      const response = await firstValueFrom(\n        this.httpService.get(`${this.moderationApiUrl}/api/v1/stats`, {\n          timeout: this.timeout,\n        }),\n      );\n\n      return response.data;\n    } catch (error) {\n      this.logger.error('Failed to get moderation stats:', error);\n      return {\n        requestCount: 0,\n        averageResponseTime: 0,\n        errorRate: 100,\n        crisisDetections: 0,\n      };\n    }\n  }\n\n  /**\n   * Create a safe result for fallback scenarios\n   */\n  private createSafeResult(\n    text: string,\n    overrides?: Partial<ModerationResult>,\n  ): ModerationResult {\n    return {\n      classification: 'safe',\n      confidence: 0.5,\n      mentalHealthContext: false,\n      flags: [],\n      processingTime: 0,\n      ...overrides,\n    };\n  }\n\n  /**\n   * Create moderation context for posts\n   */\n  createPostContext(\n    userId: string,\n    userRole: string,\n    communityId?: string,\n  ): ModerationContext {\n    return {\n      context: 'post',\n      userId,\n      userRole,\n      communityId,\n      timestamp: new Date(),\n    };\n  }\n\n  /**\n   * Create moderation context for comments\n   */\n  createCommentContext(\n    userId: string,\n    userRole: string,\n    communityId?: string,\n  ): ModerationContext {\n    return {\n      context: 'comment',\n      userId,\n      userRole,\n      communityId,\n      timestamp: new Date(),\n    };\n  }\n\n  /**\n   * Create moderation context for messages\n   */\n  createMessageContext(\n    userId: string,\n    userRole: string,\n    conversationId: string,\n  ): ModerationContext {\n    return {\n      context: 'message',\n      userId,\n      userRole,\n      conversationId,\n      timestamp: new Date(),\n    };\n  }\n\n  /**\n   * Create moderation context for therapy sessions\n   */\n  createTherapyContext(\n    userId: string,\n    userRole: string,\n    sessionId: string,\n  ): ModerationContext {\n    return {\n      context: 'therapy',\n      userId,\n      userRole,\n      conversationId: sessionId,\n      timestamp: new Date(),\n    };\n  }\n}\n"],"version":3}