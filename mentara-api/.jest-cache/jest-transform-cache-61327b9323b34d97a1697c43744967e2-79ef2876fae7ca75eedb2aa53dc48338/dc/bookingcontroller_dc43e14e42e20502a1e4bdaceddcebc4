49d01256cbc5556a6937b6b28a3b64f7
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var __param = (this && this.__param) || function (paramIndex, decorator) {
    return function (target, key) { decorator(target, key, paramIndex); }
};
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
exports.BookingController = void 0;
const common_1 = require("@nestjs/common");
const jwt_auth_guard_1 = require("../auth/guards/jwt-auth.guard");
const current_user_id_decorator_1 = require("../auth/decorators/current-user-id.decorator");
const current_user_role_decorator_1 = require("../auth/decorators/current-user-role.decorator");
const zod_validation_pipe_1 = require("../common/pipes/zod-validation.pipe");
const booking_service_1 = require("./booking.service");
const booking_schemas_1 = require("./validation/booking.schemas");
let BookingController = class BookingController {
    bookingService;
    constructor(bookingService) {
        this.bookingService = bookingService;
    }
    // Meeting endpoints
    async createMeeting(createMeetingDto, userId, role) {
        // Only clients can book meetings, but we'll validate the relationship in the service
        if (role !== 'client') {
            throw new common_1.ForbiddenException('Only clients can book meetings');
        }
        return this.bookingService.createMeeting(createMeetingDto, userId);
    }
    async getMeetings(userId, role, status, limit, offset) {
        return this.bookingService.getMeetings(userId, role, {
            status,
            limit,
            offset,
        });
    }
    async getMeeting(params, userId, role) {
        return this.bookingService.getMeeting(params.id, userId, role);
    }
    async updateMeeting(params, updateMeetingDto, userId, role) {
        return this.bookingService.updateMeeting(params.id, updateMeetingDto, userId, role);
    }
    async cancelMeeting(params, userId, role) {
        return this.bookingService.cancelMeeting(params.id, userId, role);
    }
    // Availability endpoints (therapist only)
    async createAvailability(createAvailabilityDto, therapistId, role) {
        if (role !== 'therapist') {
            throw new common_1.UnauthorizedException('Only therapists can manage availability');
        }
        return this.bookingService.createAvailability(createAvailabilityDto, therapistId);
    }
    async getAvailability(therapistId, role) {
        if (role !== 'therapist') {
            throw new common_1.UnauthorizedException('Only therapists can view their availability');
        }
        return this.bookingService.getAvailability(therapistId);
    }
    async updateAvailability(params, updateAvailabilityDto, therapistId, role) {
        if (role !== 'therapist') {
            throw new common_1.UnauthorizedException('Only therapists can update availability');
        }
        return this.bookingService.updateAvailability(params.id, updateAvailabilityDto, therapistId);
    }
    async deleteAvailability(params, therapistId, role) {
        if (role !== 'therapist') {
            throw new common_1.UnauthorizedException('Only therapists can delete availability');
        }
        return this.bookingService.deleteAvailability(params.id, therapistId);
    }
    // Duration endpoints (public)
    getDurations() {
        return this.bookingService.getDurations();
    }
    // Available slots endpoint
    async getAvailableSlots(query) {
        return this.bookingService.getAvailableSlots(query.therapistId, query.date);
    }
};
exports.BookingController = BookingController;
__decorate([
    (0, common_1.Post)('meetings'),
    __param(0, (0, common_1.Body)()),
    __param(1, (0, current_user_id_decorator_1.CurrentUserId)()),
    __param(2, (0, current_user_role_decorator_1.CurrentUserRole)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Object, String, String]),
    __metadata("design:returntype", Promise)
], BookingController.prototype, "createMeeting", null);
__decorate([
    (0, common_1.Get)('meetings'),
    __param(0, (0, current_user_id_decorator_1.CurrentUserId)()),
    __param(1, (0, current_user_role_decorator_1.CurrentUserRole)()),
    __param(2, (0, common_1.Query)('status')),
    __param(3, (0, common_1.Query)('limit', new common_1.ParseIntPipe({ optional: true }))),
    __param(4, (0, common_1.Query)('offset', new common_1.ParseIntPipe({ optional: true }))),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [String, String, String, Number, Number]),
    __metadata("design:returntype", Promise)
], BookingController.prototype, "getMeetings", null);
__decorate([
    (0, common_1.Get)('meetings/:id'),
    __param(0, (0, common_1.Param)(new zod_validation_pipe_1.ZodValidationPipe(booking_schemas_1.BookingMeetingParamsDtoSchema))),
    __param(1, (0, current_user_id_decorator_1.CurrentUserId)()),
    __param(2, (0, current_user_role_decorator_1.CurrentUserRole)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Object, String, String]),
    __metadata("design:returntype", Promise)
], BookingController.prototype, "getMeeting", null);
__decorate([
    (0, common_1.Put)('meetings/:id'),
    __param(0, (0, common_1.Param)(new zod_validation_pipe_1.ZodValidationPipe(booking_schemas_1.BookingMeetingParamsDtoSchema))),
    __param(1, (0, common_1.Body)()),
    __param(2, (0, current_user_id_decorator_1.CurrentUserId)()),
    __param(3, (0, current_user_role_decorator_1.CurrentUserRole)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Object, Object, String, String]),
    __metadata("design:returntype", Promise)
], BookingController.prototype, "updateMeeting", null);
__decorate([
    (0, common_1.Delete)('meetings/:id/cancel'),
    __param(0, (0, common_1.Param)(new zod_validation_pipe_1.ZodValidationPipe(booking_schemas_1.BookingMeetingParamsDtoSchema))),
    __param(1, (0, current_user_id_decorator_1.CurrentUserId)()),
    __param(2, (0, current_user_role_decorator_1.CurrentUserRole)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Object, String, String]),
    __metadata("design:returntype", Promise)
], BookingController.prototype, "cancelMeeting", null);
__decorate([
    (0, common_1.Post)('availability'),
    __param(0, (0, common_1.Body)()),
    __param(1, (0, current_user_id_decorator_1.CurrentUserId)()),
    __param(2, (0, current_user_role_decorator_1.CurrentUserRole)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Object, String, String]),
    __metadata("design:returntype", Promise)
], BookingController.prototype, "createAvailability", null);
__decorate([
    (0, common_1.Get)('availability'),
    __param(0, (0, current_user_id_decorator_1.CurrentUserId)()),
    __param(1, (0, current_user_role_decorator_1.CurrentUserRole)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [String, String]),
    __metadata("design:returntype", Promise)
], BookingController.prototype, "getAvailability", null);
__decorate([
    (0, common_1.Put)('availability/:id'),
    __param(0, (0, common_1.Param)(new zod_validation_pipe_1.ZodValidationPipe(booking_schemas_1.AvailabilityParamsDtoSchema))),
    __param(1, (0, common_1.Body)()),
    __param(2, (0, current_user_id_decorator_1.CurrentUserId)()),
    __param(3, (0, current_user_role_decorator_1.CurrentUserRole)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Object, Object, String, String]),
    __metadata("design:returntype", Promise)
], BookingController.prototype, "updateAvailability", null);
__decorate([
    (0, common_1.Delete)('availability/:id'),
    __param(0, (0, common_1.Param)(new zod_validation_pipe_1.ZodValidationPipe(booking_schemas_1.AvailabilityParamsDtoSchema))),
    __param(1, (0, current_user_id_decorator_1.CurrentUserId)()),
    __param(2, (0, current_user_role_decorator_1.CurrentUserRole)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Object, String, String]),
    __metadata("design:returntype", Promise)
], BookingController.prototype, "deleteAvailability", null);
__decorate([
    (0, common_1.Get)('durations'),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", []),
    __metadata("design:returntype", void 0)
], BookingController.prototype, "getDurations", null);
__decorate([
    (0, common_1.Get)('slots'),
    __param(0, (0, common_1.Query)(new zod_validation_pipe_1.ZodValidationPipe(booking_schemas_1.GetAvailableSlotsQueryDtoSchema))),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Object]),
    __metadata("design:returntype", Promise)
], BookingController.prototype, "getAvailableSlots", null);
exports.BookingController = BookingController = __decorate([
    (0, common_1.Controller)('booking'),
    (0, common_1.UseGuards)(jwt_auth_guard_1.JwtAuthGuard),
    __metadata("design:paramtypes", [typeof (_a = typeof booking_service_1.BookingService !== "undefined" && booking_service_1.BookingService) === "function" ? _a : Object])
], BookingController);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL2Jvb2tpbmcvYm9va2luZy5jb250cm9sbGVyLnRzIiwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQSwyQ0Fhd0I7QUFDeEIsa0VBQTZEO0FBQzdELDRGQUE2RTtBQUM3RSxnR0FBaUY7QUFDakYsNkVBQXdFO0FBQ3hFLHVEQUFtRDtBQUNuRCxrRUFJc0M7QUFhL0IsSUFBTSxpQkFBaUIsR0FBdkIsTUFBTSxpQkFBaUI7SUFDQztJQUE3QixZQUE2QixjQUE4QjtRQUE5QixtQkFBYyxHQUFkLGNBQWMsQ0FBZ0I7SUFBRyxDQUFDO0lBRS9ELG9CQUFvQjtJQUVkLEFBQU4sS0FBSyxDQUFDLGFBQWEsQ0FDVCxnQkFBa0MsRUFDekIsTUFBYyxFQUNaLElBQVk7UUFFL0IscUZBQXFGO1FBQ3JGLElBQUksSUFBSSxLQUFLLFFBQVEsRUFBRSxDQUFDO1lBQ3RCLE1BQU0sSUFBSSwyQkFBa0IsQ0FBQyxnQ0FBZ0MsQ0FBQyxDQUFDO1FBQ2pFLENBQUM7UUFDRCxPQUFPLElBQUksQ0FBQyxjQUFjLENBQUMsYUFBYSxDQUFDLGdCQUFnQixFQUFFLE1BQU0sQ0FBQyxDQUFDO0lBQ3JFLENBQUM7SUFHSyxBQUFOLEtBQUssQ0FBQyxXQUFXLENBQ0UsTUFBYyxFQUNaLElBQVksRUFDZCxNQUFlLEVBQ3NCLEtBQWMsRUFDYixNQUFlO1FBRXRFLE9BQU8sSUFBSSxDQUFDLGNBQWMsQ0FBQyxXQUFXLENBQUMsTUFBTSxFQUFFLElBQUksRUFBRTtZQUNuRCxNQUFNO1lBQ04sS0FBSztZQUNMLE1BQU07U0FDUCxDQUFDLENBQUM7SUFDTCxDQUFDO0lBR0ssQUFBTixLQUFLLENBQUMsVUFBVSxDQUVkLE1BQStCLEVBQ2QsTUFBYyxFQUNaLElBQVk7UUFFL0IsT0FBTyxJQUFJLENBQUMsY0FBYyxDQUFDLFVBQVUsQ0FBQyxNQUFNLENBQUMsRUFBRSxFQUFFLE1BQU0sRUFBRSxJQUFJLENBQUMs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QSw2Q0FBZSxHQUFFLENBQUE7Ozs7MkRBV25CO0FBR0s7SUFETCxJQUFBLFlBQUcsRUFBQyxjQUFjLENBQUM7SUFFakIsV0FBQSxJQUFBLHlDQUFhLEdBQUUsQ0FBQTtJQUNmLFdBQUEsSUFBQSw2Q0FBZSxHQUFFLENBQUE7Ozs7d0RBUW5CO0FBR0s7SUFETCxJQUFBLFlBQUcsRUFBQyxrQkFBa0IsQ0FBQztJQUVyQixXQUFBLElBQUEsY0FBSyxFQUFDLElBQUksdUNBQWlCLENBQUMsNkNBQTJCLENBQUMsQ0FBQyxDQUFBO0lBRXpELFdBQUEsSUFBQSxhQUFJLEdBQUUsQ0FBQTtJQUNOLFdBQUEsSUFBQSx5Q0FBYSxHQUFFLENBQUE7SUFDZixXQUFBLElBQUEsNkNBQWUsR0FBRSxDQUFBOzs7OzJEQVluQjtBQUdLO0lBREwsSUFBQSxlQUFNLEVBQUMsa0JBQWtCLENBQUM7SUFFeEIsV0FBQSxJQUFBLGNBQUssRUFBQyxJQUFJLHVDQUFpQixDQUFDLDZDQUEyQixDQUFDLENBQUMsQ0FBQTtJQUV6RCxXQUFBLElBQUEseUNBQWEsR0FBRSxDQUFBO0lBQ2YsV0FBQSxJQUFBLDZDQUFlLEdBQUUsQ0FBQTs7OzsyREFRbkI7QUFJRDtJQURDLElBQUEsWUFBRyxFQUFDLFdBQVcsQ0FBQzs7OztxREFHaEI7QUFJSztJQURMLElBQUEsWUFBRyxFQUFDLE9BQU8sQ0FBQztJQUVWLFdBQUEsSUFBQSxjQUFLLEVBQUMsSUFBSSx1Q0FBaUIsQ0FBQyxpREFBK0IsQ0FBQyxDQUFDLENBQUE7Ozs7MERBSS9EOzRCQW5KVSxpQkFBaUI7SUFGN0IsSUFBQSxtQkFBVSxFQUFDLFNBQVMsQ0FBQztJQUNyQixJQUFBLGtCQUFTLEVBQUMsNkJBQVksQ0FBQzt5REFFdUIsZ0NBQWMsb0JBQWQsZ0NBQWM7R0FEaEQsaUJBQWlCLENBb0o3QiIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvaG9tZS93ZXRvb2EvRG9jdW1lbnRzL2NvZGUvcHJvamVjdHMvbWVudGFyYS9tZW50YXJhLWFwaS9zcmMvYm9va2luZy9ib29raW5nLmNvbnRyb2xsZXIudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgQm9keSxcbiAgQ29udHJvbGxlcixcbiAgRGVsZXRlLFxuICBHZXQsXG4gIFBhcmFtLFxuICBQb3N0LFxuICBQdXQsXG4gIFF1ZXJ5LFxuICBVc2VHdWFyZHMsXG4gIFVuYXV0aG9yaXplZEV4Y2VwdGlvbixcbiAgRm9yYmlkZGVuRXhjZXB0aW9uLFxuICBQYXJzZUludFBpcGUsXG59IGZyb20gJ0BuZXN0anMvY29tbW9uJztcbmltcG9ydCB7IEp3dEF1dGhHdWFyZCB9IGZyb20gJy4uL2F1dGgvZ3VhcmRzL2p3dC1hdXRoLmd1YXJkJztcbmltcG9ydCB7IEN1cnJlbnRVc2VySWQgfSBmcm9tICcuLi9hdXRoL2RlY29yYXRvcnMvY3VycmVudC11c2VyLWlkLmRlY29yYXRvcic7XG5pbXBvcnQgeyBDdXJyZW50VXNlclJvbGUgfSBmcm9tICcuLi9hdXRoL2RlY29yYXRvcnMvY3VycmVudC11c2VyLXJvbGUuZGVjb3JhdG9yJztcbmltcG9ydCB7IFpvZFZhbGlkYXRpb25QaXBlIH0gZnJvbSAnLi4vY29tbW9uL3BpcGVzL3pvZC12YWxpZGF0aW9uLnBpcGUnO1xuaW1wb3J0IHsgQm9va2luZ1NlcnZpY2UgfSBmcm9tICcuL2Jvb2tpbmcuc2VydmljZSc7XG5pbXBvcnQge1xuICBCb29raW5nTWVldGluZ1BhcmFtc0R0b1NjaGVtYSxcbiAgQXZhaWxhYmlsaXR5UGFyYW1zRHRvU2NoZW1hLFxuICBHZXRBdmFpbGFibGVTbG90c1F1ZXJ5RHRvU2NoZW1hLFxufSBmcm9tICcuL3ZhbGlkYXRpb24vYm9va2luZy5zY2hlbWFzJztcbmltcG9ydCB0eXBlIHtcbiAgVGhlcmFwaXN0QXZhaWxhYmlsaXR5Q3JlYXRlRHRvLFxuICBUaGVyYXBpc3RBdmFpbGFiaWxpdHlVcGRhdGVEdG8sXG4gIE1lZXRpbmdDcmVhdGVEdG8sXG4gIE1lZXRpbmdVcGRhdGVEdG8sXG4gIEJvb2tpbmdNZWV0aW5nUGFyYW1zRHRvLFxuICBBdmFpbGFiaWxpdHlQYXJhbXNEdG8sXG4gIEdldEF2YWlsYWJsZVNsb3RzUXVlcnlEdG8sXG59IGZyb20gJy4vdHlwZXMnO1xuXG5AQ29udHJvbGxlcignYm9va2luZycpXG5AVXNlR3VhcmRzKEp3dEF1dGhHdWFyZClcbmV4cG9ydCBjbGFzcyBCb29raW5nQ29udHJvbGxlciB7XG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgcmVhZG9ubHkgYm9va2luZ1NlcnZpY2U6IEJvb2tpbmdTZXJ2aWNlKSB7fVxuXG4gIC8vIE1lZXRpbmcgZW5kcG9pbnRzXG4gIEBQb3N0KCdtZWV0aW5ncycpXG4gIGFzeW5jIGNyZWF0ZU1lZXRpbmcoXG4gICAgQEJvZHkoKSBjcmVhdGVNZWV0aW5nRHRvOiBNZWV0aW5nQ3JlYXRlRHRvLFxuICAgIEBDdXJyZW50VXNlcklkKCkgdXNlcklkOiBzdHJpbmcsXG4gICAgQEN1cnJlbnRVc2VyUm9sZSgpIHJvbGU6IHN0cmluZyxcbiAgKSB7XG4gICAgLy8gT25seSBjbGllbnRzIGNhbiBib29rIG1lZXRpbmdzLCBidXQgd2UnbGwgdmFsaWRhdGUgdGhlIHJlbGF0aW9uc2hpcCBpbiB0aGUgc2VydmljZVxuICAgIGlmIChyb2xlICE9PSAnY2xpZW50Jykge1xuICAgICAgdGhyb3cgbmV3IEZvcmJpZGRlbkV4Y2VwdGlvbignT25seSBjbGllbnRzIGNhbiBib29rIG1lZXRpbmdzJyk7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLmJvb2tpbmdTZXJ2aWNlLmNyZWF0ZU1lZXRpbmcoY3JlYXRlTWVldGluZ0R0bywgdXNlcklkKTtcbiAgfVxuXG4gIEBHZXQoJ21lZXRpbmdzJylcbiAgYXN5bmMgZ2V0TWVldGluZ3MoXG4gICAgQEN1cnJlbnRVc2VySWQoKSB1c2VySWQ6IHN0cmluZyxcbiAgICBAQ3VycmVudFVzZXJSb2xlKCkgcm9sZTogc3RyaW5nLFxuICAgIEBRdWVyeSgnc3RhdHVzJykgc3RhdHVzPzogc3RyaW5nLFxuICAgIEBRdWVyeSgnbGltaXQnLCBuZXcgUGFyc2VJbnRQaXBlKHsgb3B0aW9uYWw6IHRydWUgfSkpIGxpbWl0PzogbnVtYmVyLFxuICAgIEBRdWVyeSgnb2Zmc2V0JywgbmV3IFBhcnNlSW50UGlwZSh7IG9wdGlvbmFsOiB0cnVlIH0pKSBvZmZzZXQ/OiBudW1iZXIsXG4gICkge1xuICAgIHJldHVybiB0aGlzLmJvb2tpbmdTZXJ2aWNlLmdldE1lZXRpbmdzKHVzZXJJZCwgcm9sZSwge1xuICAgICAgc3RhdHVzLFxuICAgICAgbGltaXQsXG4gICAgICBvZmZzZXQsXG4gICAgfSk7XG4gIH1cblxuICBAR2V0KCdtZWV0aW5ncy86aWQnKVxuICBhc3luYyBnZXRNZWV0aW5nKFxuICAgIEBQYXJhbShuZXcgWm9kVmFsaWRhdGlvblBpcGUoQm9va2luZ01lZXRpbmdQYXJhbXNEdG9TY2hlbWEpKVxuICAgIHBhcmFtczogQm9va2luZ01lZXRpbmdQYXJhbXNEdG8sXG4gICAgQEN1cnJlbnRVc2VySWQoKSB1c2VySWQ6IHN0cmluZyxcbiAgICBAQ3VycmVudFVzZXJSb2xlKCkgcm9sZTogc3RyaW5nLFxuICApIHtcbiAgICByZXR1cm4gdGhpcy5ib29raW5nU2VydmljZS5nZXRNZWV0aW5nKHBhcmFtcy5pZCwgdXNlcklkLCByb2xlKTtcbiAgfVxuXG4gIEBQdXQoJ21lZXRpbmdzLzppZCcpXG4gIGFzeW5jIHVwZGF0ZU1lZXRpbmcoXG4gICAgQFBhcmFtKG5ldyBab2RWYWxpZGF0aW9uUGlwZShCb29raW5nTWVldGluZ1BhcmFtc0R0b1NjaGVtYSkpXG4gICAgcGFyYW1zOiBCb29raW5nTWVldGluZ1BhcmFtc0R0byxcbiAgICBAQm9keSgpIHVwZGF0ZU1lZXRpbmdEdG86IE1lZXRpbmdVcGRhdGVEdG8sXG4gICAgQEN1cnJlbnRVc2VySWQoKSB1c2VySWQ6IHN0cmluZyxcbiAgICBAQ3VycmVudFVzZXJSb2xlKCkgcm9sZTogc3RyaW5nLFxuICApIHtcbiAgICByZXR1cm4gdGhpcy5ib29raW5nU2VydmljZS51cGRhdGVNZWV0aW5nKFxuICAgICAgcGFyYW1zLmlkLFxuICAgICAgdXBkYXRlTWVldGluZ0R0byxcbiAgICAgIHVzZXJJZCxcbiAgICAgIHJvbGUsXG4gICAgKTtcbiAgfVxuXG4gIEBEZWxldGUoJ21lZXRpbmdzLzppZC9jYW5jZWwnKVxuICBhc3luYyBjYW5jZWxNZWV0aW5nKFxuICAgIEBQYXJhbShuZXcgWm9kVmFsaWRhdGlvblBpcGUoQm9va2luZ01lZXRpbmdQYXJhbXNEdG9TY2hlbWEpKVxuICAgIHBhcmFtczogQm9va2luZ01lZXRpbmdQYXJhbXNEdG8sXG4gICAgQEN1cnJlbnRVc2VySWQoKSB1c2VySWQ6IHN0cmluZyxcbiAgICBAQ3VycmVudFVzZXJSb2xlKCkgcm9sZTogc3RyaW5nLFxuICApIHtcbiAgICByZXR1cm4gdGhpcy5ib29raW5nU2VydmljZS5jYW5jZWxNZWV0aW5nKHBhcmFtcy5pZCwgdXNlcklkLCByb2xlKTtcbiAgfVxuXG4gIC8vIEF2YWlsYWJpbGl0eSBlbmRwb2ludHMgKHRoZXJhcGlzdCBvbmx5KVxuICBAUG9zdCgnYXZhaWxhYmlsaXR5JylcbiAgYXN5bmMgY3JlYXRlQXZhaWxhYmlsaXR5KFxuICAgIEBCb2R5KCkgY3JlYXRlQXZhaWxhYmlsaXR5RHRvOiBUaGVyYXBpc3RBdmFpbGFiaWxpdHlDcmVhdGVEdG8sXG4gICAgQEN1cnJlbnRVc2VySWQoKSB0aGVyYXBpc3RJZDogc3RyaW5nLFxuICAgIEBDdXJyZW50VXNlclJvbGUoKSByb2xlOiBzdHJpbmcsXG4gICkge1xuICAgIGlmIChyb2xlICE9PSAndGhlcmFwaXN0Jykge1xuICAgICAgdGhyb3cgbmV3IFVuYXV0aG9yaXplZEV4Y2VwdGlvbihcbiAgICAgICAgJ09ubHkgdGhlcmFwaXN0cyBjYW4gbWFuYWdlIGF2YWlsYWJpbGl0eScsXG4gICAgICApO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy5ib29raW5nU2VydmljZS5jcmVhdGVBdmFpbGFiaWxpdHkoXG4gICAgICBjcmVhdGVBdmFpbGFiaWxpdHlEdG8sXG4gICAgICB0aGVyYXBpc3RJZCxcbiAgICApO1xuICB9XG5cbiAgQEdldCgnYXZhaWxhYmlsaXR5JylcbiAgYXN5bmMgZ2V0QXZhaWxhYmlsaXR5KFxuICAgIEBDdXJyZW50VXNlcklkKCkgdGhlcmFwaXN0SWQ6IHN0cmluZyxcbiAgICBAQ3VycmVudFVzZXJSb2xlKCkgcm9sZTogc3RyaW5nLFxuICApIHtcbiAgICBpZiAocm9sZSAhPT0gJ3RoZXJhcGlzdCcpIHtcbiAgICAgIHRocm93IG5ldyBVbmF1dGhvcml6ZWRFeGNlcHRpb24oXG4gICAgICAgICdPbmx5IHRoZXJhcGlzdHMgY2FuIHZpZXcgdGhlaXIgYXZhaWxhYmlsaXR5JyxcbiAgICAgICk7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLmJvb2tpbmdTZXJ2aWNlLmdldEF2YWlsYWJpbGl0eSh0aGVyYXBpc3RJZCk7XG4gIH1cblxuICBAUHV0KCdhdmFpbGFiaWxpdHkvOmlkJylcbiAgYXN5bmMgdXBkYXRlQXZhaWxhYmlsaXR5KFxuICAgIEBQYXJhbShuZXcgWm9kVmFsaWRhdGlvblBpcGUoQXZhaWxhYmlsaXR5UGFyYW1zRHRvU2NoZW1hKSlcbiAgICBwYXJhbXM6IEF2YWlsYWJpbGl0eVBhcmFtc0R0byxcbiAgICBAQm9keSgpIHVwZGF0ZUF2YWlsYWJpbGl0eUR0bzogVGhlcmFwaXN0QXZhaWxhYmlsaXR5VXBkYXRlRHRvLFxuICAgIEBDdXJyZW50VXNlcklkKCkgdGhlcmFwaXN0SWQ6IHN0cmluZyxcbiAgICBAQ3VycmVudFVzZXJSb2xlKCkgcm9sZTogc3RyaW5nLFxuICApIHtcbiAgICBpZiAocm9sZSAhPT0gJ3RoZXJhcGlzdCcpIHtcbiAgICAgIHRocm93IG5ldyBVbmF1dGhvcml6ZWRFeGNlcHRpb24oXG4gICAgICAgICdPbmx5IHRoZXJhcGlzdHMgY2FuIHVwZGF0ZSBhdmFpbGFiaWxpdHknLFxuICAgICAgKTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuYm9va2luZ1NlcnZpY2UudXBkYXRlQXZhaWxhYmlsaXR5KFxuICAgICAgcGFyYW1zLmlkLFxuICAgICAgdXBkYXRlQXZhaWxhYmlsaXR5RHRvLFxuICAgICAgdGhlcmFwaXN0SWQsXG4gICAgKTtcbiAgfVxuXG4gIEBEZWxldGUoJ2F2YWlsYWJpbGl0eS86aWQnKVxuICBhc3luYyBkZWxldGVBdmFpbGFiaWxpdHkoXG4gICAgQFBhcmFtKG5ldyBab2RWYWxpZGF0aW9uUGlwZShBdmFpbGFiaWxpdHlQYXJhbXNEdG9TY2hlbWEpKVxuICAgIHBhcmFtczogQXZhaWxhYmlsaXR5UGFyYW1zRHRvLFxuICAgIEBDdXJyZW50VXNlcklkKCkgdGhlcmFwaXN0SWQ6IHN0cmluZyxcbiAgICBAQ3VycmVudFVzZXJSb2xlKCkgcm9sZTogc3RyaW5nLFxuICApIHtcbiAgICBpZiAocm9sZSAhPT0gJ3RoZXJhcGlzdCcpIHtcbiAgICAgIHRocm93IG5ldyBVbmF1dGhvcml6ZWRFeGNlcHRpb24oXG4gICAgICAgICdPbmx5IHRoZXJhcGlzdHMgY2FuIGRlbGV0ZSBhdmFpbGFiaWxpdHknLFxuICAgICAgKTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuYm9va2luZ1NlcnZpY2UuZGVsZXRlQXZhaWxhYmlsaXR5KHBhcmFtcy5pZCwgdGhlcmFwaXN0SWQpO1xuICB9XG5cbiAgLy8gRHVyYXRpb24gZW5kcG9pbnRzIChwdWJsaWMpXG4gIEBHZXQoJ2R1cmF0aW9ucycpXG4gIGdldER1cmF0aW9ucygpIHtcbiAgICByZXR1cm4gdGhpcy5ib29raW5nU2VydmljZS5nZXREdXJhdGlvbnMoKTtcbiAgfVxuXG4gIC8vIEF2YWlsYWJsZSBzbG90cyBlbmRwb2ludFxuICBAR2V0KCdzbG90cycpXG4gIGFzeW5jIGdldEF2YWlsYWJsZVNsb3RzKFxuICAgIEBRdWVyeShuZXcgWm9kVmFsaWRhdGlvblBpcGUoR2V0QXZhaWxhYmxlU2xvdHNRdWVyeUR0b1NjaGVtYSkpXG4gICAgcXVlcnk6IEdldEF2YWlsYWJsZVNsb3RzUXVlcnlEdG8sXG4gICkge1xuICAgIHJldHVybiB0aGlzLmJvb2tpbmdTZXJ2aWNlLmdldEF2YWlsYWJsZVNsb3RzKHF1ZXJ5LnRoZXJhcGlzdElkLCBxdWVyeS5kYXRlKTtcbiAgfVxufVxuIl0sInZlcnNpb24iOjN9