b86535c1980939c8ecf967cb281d1b54
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
exports.SlotGeneratorService = void 0;
const common_1 = require("@nestjs/common");
const prisma_client_provider_1 = require("../../providers/prisma-client.provider");
let SlotGeneratorService = class SlotGeneratorService {
    prisma;
    defaultConfig = {
        slotInterval: 30,
        maxAdvanceBooking: 90,
        minAdvanceBooking: 0.5,
    };
    constructor(prisma) {
        this.prisma = prisma;
    }
    getDurations() {
        return [
            { id: '30', name: '30 minutes', duration: 30 },
            { id: '60', name: '60 minutes', duration: 60 },
            { id: '90', name: '90 minutes', duration: 90 },
            { id: '120', name: '120 minutes', duration: 120 },
        ];
    }
    /**
     * Generate available time slots for a therapist on a specific date
     */
    async generateAvailableSlots(therapistId, date, config = {}) {
        const finalConfig = { ...this.defaultConfig, ...config };
        const targetDate = new Date(date);
        const dayOfWeek = targetDate.getDay();
        // Validate date is within booking window
        this.validateBookingDate(targetDate, finalConfig);
        // Get therapist availability for this day
        const availability = await this.getTherapistAvailability(therapistId, dayOfWeek);
        if (availability.length === 0) {
            return [];
        }
        // Get existing bookings for this date
        const existingBookings = await this.getExistingBookings(therapistId, targetDate);
        // Generate slots for each availability window
        const allSlots = [];
        for (const avail of availability) {
            const slots = this.generateSlotsForAvailabilityWindow(targetDate, avail, existingBookings, finalConfig);
            allSlots.push(...slots);
        }
        return allSlots.sort((a, b) => new Date(a.startTime).getTime() - new Date(b.startTime).getTime());
    }
    validateBookingDate(date, config) {
        const now = new Date();
        const maxDate = new Date(now.getTime() + config.maxAdvanceBooking * 24 * 60 * 60 * 1000);
        const minDate = new Date(now.getTime() + config.minAdvanceBooking * 60 * 60 * 1000);
        if (date < minDate) {
            throw new common_1.BadRequestException(`Bookings must be made at least ${config.minAdvanceBooking} hours in advance`);
        }
        if (date > maxDate) {
            throw new common_1.BadRequestException(`Bookings can only be made up to ${config.maxAdvanceBooking} days in advance`);
        }
    }
    async getTherapistAvailability(therapistId, dayOfWeek) {
        return this.prisma.therapistAvailability.findMany({
            where: {
                therapistId,
                dayOfWeek: dayOfWeek.toString(),
                isAvailable: true,
            },
            orderBy: { startTime: 'asc' },
        });
    }
    async getExistingBookings(therapistId, date) {
        const startOfDay = new Date(date);
        startOfDay.setHours(0, 0, 0, 0);
        const endOfDay = new Date(date);
        endOfDay.setHours(23, 59, 59, 999);
        return this.prisma.meeting.findMany({
            where: {
                therapistId,
                startTime: { gte: startOfDay, lte: endOfDay },
                status: { in: ['SCHEDULED', 'CONFIRMED'] },
            },
            orderBy: { startTime: 'asc' },
        });
    }
    generateSlotsForAvailabilityWindow(date, availability, existingBookings, config) {
        const slots = [];
        const durations = this.getDurations();
        const startTime = this.createDateTime(date, availability.startTime);
        const endTime = this.createDateTime(date, availability.endTime);
        let currentTime = new Date(startTime);
        while (currentTime < endTime) {
            const slotEnd = new Date(currentTime.getTime() + config.slotInterval * 60000);
            if (slotEnd <= endTime) {
                // Check if this slot conflicts with existing bookings
                if (!this.hasConflictWithBookings(currentTime, slotEnd, existingBookings)) {
                    // Find which durations fit in this slot
                    const availableDurations = this.getAvailableDurations(currentTime, endTime, existingBookings, durations);
                    if (availableDurations.length > 0) {
                        slots.push({
                            startTime: currentTime.toISOString(),
                            availableDurations,
                        });
                    }
                }
            }
            currentTime = new Date(currentTime.getTime() + config.slotInterval * 60000);
        }
        return slots;
    }
    createDateTime(date, timeString) {
        const [hours, minutes] = timeString.split(':').map(Number);
        const dateTime = new Date(date);
        dateTime.setHours(hours, minutes, 0, 0);
        return dateTime;
    }
    hasConflictWithBookings(slotStart, slotEnd, bookings) {
        return bookings.some((booking) => {
            const bookingEnd = new Date(booking.startTime.getTime() + booking.duration * 60000);
            return this.hasTimeOverlap(slotStart, slotEnd, booking.startTime, bookingEnd);
        });
    }
    getAvailableDurations(slotStart, availabilityEnd, existingBookings, durations) {
        return durations.filter((duration) => {
            const durationEnd = new Date(slotStart.getTime() + duration.duration * 60000);
            // Check if duration fits within availability window
            if (durationEnd > availabilityEnd) {
                return false;
            }
            // Check if duration conflicts with existing bookings
            return !this.hasConflictWithBookings(slotStart, durationEnd, existingBookings);
        });
    }
    hasTimeOverlap(start1, end1, start2, end2) {
        return start1 < end2 && end1 > start2;
    }
    /**
     * Check if a specific time slot is available
     */
    async isSlotAvailable(therapistId, startTime, duration) {
        const endTime = new Date(startTime.getTime() + duration * 60000);
        const dayOfWeek = startTime.getDay();
        // Check therapist availability
        const availability = await this.prisma.therapistAvailability.findFirst({
            where: {
                therapistId,
                dayOfWeek: dayOfWeek.toString(),
                isAvailable: true,
            },
        });
        if (!availability) {
            return false;
        }
        // Check if time fits within availability window
        const availStart = this.createDateTime(startTime, availability.startTime);
        const availEnd = this.createDateTime(startTime, availability.endTime);
        if (startTime < availStart || endTime > availEnd) {
            return false;
        }
        // Check for conflicts with existing bookings
        const existingBookings = await this.getExistingBookings(therapistId, startTime);
        return !this.hasConflictWithBookings(startTime, endTime, existingBookings);
    }
};
exports.SlotGeneratorService = SlotGeneratorService;
exports.SlotGeneratorService = SlotGeneratorService = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [typeof (_a = typeof prisma_client_provider_1.PrismaService !== "undefined" && prisma_client_provider_1.PrismaService) === "function" ? _a : Object])
], SlotGeneratorService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL2Jvb2tpbmcvc2VydmljZXMvc2xvdC1nZW5lcmF0b3Iuc2VydmljZS50cyIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7O0FBQUEsMkNBQWlFO0FBQ2pFLG1GQUF1RTtBQWtCaEUsSUFBTSxvQkFBb0IsR0FBMUIsTUFBTSxvQkFBb0I7SUFPRjtJQU5aLGFBQWEsR0FBeUI7UUFDckQsWUFBWSxFQUFFLEVBQUU7UUFDaEIsaUJBQWlCLEVBQUUsRUFBRTtRQUNyQixpQkFBaUIsRUFBRSxHQUFHO0tBQ3ZCLENBQUM7SUFFRixZQUE2QixNQUFxQjtRQUFyQixXQUFNLEdBQU4sTUFBTSxDQUFlO0lBQUcsQ0FBQztJQUU5QyxZQUFZO1FBQ2xCLE9BQU87WUFDTCxFQUFFLEVBQUUsRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLFlBQVksRUFBRSxRQUFRLEVBQUUsRUFBRSxFQUFFO1lBQzlDLEVBQUUsRUFBRSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsWUFBWSxFQUFFLFFBQVEsRUFBRSxFQUFFLEVBQUU7WUFDOUMsRUFBRSxFQUFFLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxZQUFZLEVBQUUsUUFBUSxFQUFFLEVBQUUsRUFBRTtZQUM5QyxFQUFFLEVBQUUsRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLGFBQWEsRUFBRSxRQUFRLEVBQUUsR0FBRyxFQUFFO1NBQ2xELENBQUM7SUFDSixDQUFDO0lBRUQ7O09BRUc7SUFDSCxLQUFLLENBQUMsc0JBQXNCLENBQzFCLFdBQW1CLEVBQ25CLElBQVksRUFDWixTQUF3QyxFQUFFO1FBRTFDLE1BQU0sV0FBVyxHQUFHLEVBQUUsR0FBRyxJQUFJLENBQUMsYUFBYSxFQUFFLEdBQUcsTUFBTSxFQUFFLENBQUM7UUFDekQsTUFBTSxVQUFVLEdBQUcsSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDbEMsTUFBTSxTQUFTLEdBQUcsVUFBVSxD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QU0sWUFBWSxHQUFHLE1BQU0sSUFBSSxDQUFDLE1BQU0sQ0FBQyxxQkFBcUIsQ0FBQyxTQUFTLENBQUM7WUFDckUsS0FBSyxFQUFFO2dCQUNMLFdBQVc7Z0JBQ1gsU0FBUyxFQUFFLFNBQVMsQ0FBQyxRQUFRLEVBQUU7Z0JBQy9CLFdBQVcsRUFBRSxJQUFJO2FBQ2xCO1NBQ0YsQ0FBQyxDQUFDO1FBRUgsSUFBSSxDQUFDLFlBQVksRUFBRSxDQUFDO1lBQ2xCLE9BQU8sS0FBSyxDQUFDO1FBQ2YsQ0FBQztRQUVELGdEQUFnRDtRQUNoRCxNQUFNLFVBQVUsR0FBRyxJQUFJLENBQUMsY0FBYyxDQUFDLFNBQVMsRUFBRSxZQUFZLENBQUMsU0FBUyxDQUFDLENBQUM7UUFDMUUsTUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLGNBQWMsQ0FBQyxTQUFTLEVBQUUsWUFBWSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBRXRFLElBQUksU0FBUyxHQUFHLFVBQVUsSUFBSSxPQUFPLEdBQUcsUUFBUSxFQUFFLENBQUM7WUFDakQsT0FBTyxLQUFLLENBQUM7UUFDZixDQUFDO1FBRUQsNkNBQTZDO1FBQzdDLE1BQU0sZ0JBQWdCLEdBQUcsTUFBTSxJQUFJLENBQUMsbUJBQW1CLENBQ3JELFdBQVcsRUFDWCxTQUFTLENBQ1YsQ0FBQztRQUVGLE9BQU8sQ0FBQyxJQUFJLENBQUMsdUJBQXVCLENBQUMsU0FBUyxFQUFFLE9BQU8sRUFBRSxnQkFBZ0IsQ0FBQyxDQUFDO0lBQzdFLENBQUM7Q0FDRixDQUFBO0FBMVFZLG9EQUFvQjsrQkFBcEIsb0JBQW9CO0lBRGhDLElBQUEsbUJBQVUsR0FBRTt5REFRMEIsc0NBQWEsb0JBQWIsc0NBQWE7R0FQdkMsb0JBQW9CLENBMFFoQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvaG9tZS93ZXRvb2EvRG9jdW1lbnRzL2NvZGUvcHJvamVjdHMvbWVudGFyYS9tZW50YXJhLWFwaS9zcmMvYm9va2luZy9zZXJ2aWNlcy9zbG90LWdlbmVyYXRvci5zZXJ2aWNlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUsIEJhZFJlcXVlc3RFeGNlcHRpb24gfSBmcm9tICdAbmVzdGpzL2NvbW1vbic7XG5pbXBvcnQgeyBQcmlzbWFTZXJ2aWNlIH0gZnJvbSAnLi4vLi4vcHJvdmlkZXJzL3ByaXNtYS1jbGllbnQucHJvdmlkZXInO1xuXG5leHBvcnQgaW50ZXJmYWNlIFRpbWVTbG90IHtcbiAgc3RhcnRUaW1lOiBzdHJpbmc7XG4gIGF2YWlsYWJsZUR1cmF0aW9uczoge1xuICAgIGlkOiBzdHJpbmc7XG4gICAgbmFtZTogc3RyaW5nO1xuICAgIGR1cmF0aW9uOiBudW1iZXI7XG4gIH1bXTtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBTbG90R2VuZXJhdGlvbkNvbmZpZyB7XG4gIHNsb3RJbnRlcnZhbDogbnVtYmVyOyAvLyBtaW51dGVzXG4gIG1heEFkdmFuY2VCb29raW5nOiBudW1iZXI7IC8vIGRheXNcbiAgbWluQWR2YW5jZUJvb2tpbmc6IG51bWJlcjsgLy8gaG91cnNcbn1cblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIFNsb3RHZW5lcmF0b3JTZXJ2aWNlIHtcbiAgcHJpdmF0ZSByZWFkb25seSBkZWZhdWx0Q29uZmlnOiBTbG90R2VuZXJhdGlvbkNvbmZpZyA9IHtcbiAgICBzbG90SW50ZXJ2YWw6IDMwLFxuICAgIG1heEFkdmFuY2VCb29raW5nOiA5MCxcbiAgICBtaW5BZHZhbmNlQm9va2luZzogMC41LFxuICB9O1xuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgcmVhZG9ubHkgcHJpc21hOiBQcmlzbWFTZXJ2aWNlKSB7fVxuXG4gIHByaXZhdGUgZ2V0RHVyYXRpb25zKCkge1xuICAgIHJldHVybiBbXG4gICAgICB7IGlkOiAnMzAnLCBuYW1lOiAnMzAgbWludXRlcycsIGR1cmF0aW9uOiAzMCB9LFxuICAgICAgeyBpZDogJzYwJywgbmFtZTogJzYwIG1pbnV0ZXMnLCBkdXJhdGlvbjogNjAgfSxcbiAgICAgIHsgaWQ6ICc5MCcsIG5hbWU6ICc5MCBtaW51dGVzJywgZHVyYXRpb246IDkwIH0sXG4gICAgICB7IGlkOiAnMTIwJywgbmFtZTogJzEyMCBtaW51dGVzJywgZHVyYXRpb246IDEyMCB9LFxuICAgIF07XG4gIH1cblxuICAvKipcbiAgICogR2VuZXJhdGUgYXZhaWxhYmxlIHRpbWUgc2xvdHMgZm9yIGEgdGhlcmFwaXN0IG9uIGEgc3BlY2lmaWMgZGF0ZVxuICAgKi9cbiAgYXN5bmMgZ2VuZXJhdGVBdmFpbGFibGVTbG90cyhcbiAgICB0aGVyYXBpc3RJZDogc3RyaW5nLFxuICAgIGRhdGU6IHN0cmluZyxcbiAgICBjb25maWc6IFBhcnRpYWw8U2xvdEdlbmVyYXRpb25Db25maWc+ID0ge30sXG4gICk6IFByb21pc2U8VGltZVNsb3RbXT4ge1xuICAgIGNvbnN0IGZpbmFsQ29uZmlnID0geyAuLi50aGlzLmRlZmF1bHRDb25maWcsIC4uLmNvbmZpZyB9O1xuICAgIGNvbnN0IHRhcmdldERhdGUgPSBuZXcgRGF0ZShkYXRlKTtcbiAgICBjb25zdCBkYXlPZldlZWsgPSB0YXJnZXREYXRlLmdldERheSgpO1xuXG4gICAgLy8gVmFsaWRhdGUgZGF0ZSBpcyB3aXRoaW4gYm9va2luZyB3aW5kb3dcbiAgICB0aGlzLnZhbGlkYXRlQm9va2luZ0RhdGUodGFyZ2V0RGF0ZSwgZmluYWxDb25maWcpO1xuXG4gICAgLy8gR2V0IHRoZXJhcGlzdCBhdmFpbGFiaWxpdHkgZm9yIHRoaXMgZGF5XG4gICAgY29uc3QgYXZhaWxhYmlsaXR5ID0gYXdhaXQgdGhpcy5nZXRUaGVyYXBpc3RBdmFpbGFiaWxpdHkoXG4gICAgICB0aGVyYXBpc3RJZCxcbiAgICAgIGRheU9mV2VlayxcbiAgICApO1xuICAgIGlmIChhdmFpbGFiaWxpdHkubGVuZ3RoID09PSAwKSB7XG4gICAgICByZXR1cm4gW107XG4gICAgfVxuXG4gICAgLy8gR2V0IGV4aXN0aW5nIGJvb2tpbmdzIGZvciB0aGlzIGRhdGVcbiAgICBjb25zdCBleGlzdGluZ0Jvb2tpbmdzID0gYXdhaXQgdGhpcy5nZXRFeGlzdGluZ0Jvb2tpbmdzKFxuICAgICAgdGhlcmFwaXN0SWQsXG4gICAgICB0YXJnZXREYXRlLFxuICAgICk7XG5cbiAgICAvLyBHZW5lcmF0ZSBzbG90cyBmb3IgZWFjaCBhdmFpbGFiaWxpdHkgd2luZG93XG4gICAgY29uc3QgYWxsU2xvdHM6IFRpbWVTbG90W10gPSBbXTtcbiAgICBmb3IgKGNvbnN0IGF2YWlsIG9mIGF2YWlsYWJpbGl0eSkge1xuICAgICAgY29uc3Qgc2xvdHMgPSB0aGlzLmdlbmVyYXRlU2xvdHNGb3JBdmFpbGFiaWxpdHlXaW5kb3coXG4gICAgICAgIHRhcmdldERhdGUsXG4gICAgICAgIGF2YWlsLFxuICAgICAgICBleGlzdGluZ0Jvb2tpbmdzLFxuICAgICAgICBmaW5hbENvbmZpZyxcbiAgICAgICk7XG4gICAgICBhbGxTbG90cy5wdXNoKC4uLnNsb3RzKTtcbiAgICB9XG5cbiAgICByZXR1cm4gYWxsU2xvdHMuc29ydChcbiAgICAgIChhLCBiKSA9PlxuICAgICAgICBuZXcgRGF0ZShhLnN0YXJ0VGltZSkuZ2V0VGltZSgpIC0gbmV3IERhdGUoYi5zdGFydFRpbWUpLmdldFRpbWUoKSxcbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSB2YWxpZGF0ZUJvb2tpbmdEYXRlKGRhdGU6IERhdGUsIGNvbmZpZzogU2xvdEdlbmVyYXRpb25Db25maWcpOiB2b2lkIHtcbiAgICBjb25zdCBub3cgPSBuZXcgRGF0ZSgpO1xuICAgIGNvbnN0IG1heERhdGUgPSBuZXcgRGF0ZShcbiAgICAgIG5vdy5nZXRUaW1lKCkgKyBjb25maWcubWF4QWR2YW5jZUJvb2tpbmcgKiAyNCAqIDYwICogNjAgKiAxMDAwLFxuICAgICk7XG4gICAgY29uc3QgbWluRGF0ZSA9IG5ldyBEYXRlKFxuICAgICAgbm93LmdldFRpbWUoKSArIGNvbmZpZy5taW5BZHZhbmNlQm9va2luZyAqIDYwICogNjAgKiAxMDAwLFxuICAgICk7XG5cbiAgICBpZiAoZGF0ZSA8IG1pbkRhdGUpIHtcbiAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0RXhjZXB0aW9uKFxuICAgICAgICBgQm9va2luZ3MgbXVzdCBiZSBtYWRlIGF0IGxlYXN0ICR7Y29uZmlnLm1pbkFkdmFuY2VCb29raW5nfSBob3VycyBpbiBhZHZhbmNlYCxcbiAgICAgICk7XG4gICAgfVxuXG4gICAgaWYgKGRhdGUgPiBtYXhEYXRlKSB7XG4gICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdEV4Y2VwdGlvbihcbiAgICAgICAgYEJvb2tpbmdzIGNhbiBvbmx5IGJlIG1hZGUgdXAgdG8gJHtjb25maWcubWF4QWR2YW5jZUJvb2tpbmd9IGRheXMgaW4gYWR2YW5jZWAsXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgZ2V0VGhlcmFwaXN0QXZhaWxhYmlsaXR5KFxuICAgIHRoZXJhcGlzdElkOiBzdHJpbmcsXG4gICAgZGF5T2ZXZWVrOiBudW1iZXIsXG4gICkge1xuICAgIHJldHVybiB0aGlzLnByaXNtYS50aGVyYXBpc3RBdmFpbGFiaWxpdHkuZmluZE1hbnkoe1xuICAgICAgd2hlcmU6IHtcbiAgICAgICAgdGhlcmFwaXN0SWQsXG4gICAgICAgIGRheU9mV2VlazogZGF5T2ZXZWVrLnRvU3RyaW5nKCksXG4gICAgICAgIGlzQXZhaWxhYmxlOiB0cnVlLFxuICAgICAgfSxcbiAgICAgIG9yZGVyQnk6IHsgc3RhcnRUaW1lOiAnYXNjJyB9LFxuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBnZXRFeGlzdGluZ0Jvb2tpbmdzKHRoZXJhcGlzdElkOiBzdHJpbmcsIGRhdGU6IERhdGUpIHtcbiAgICBjb25zdCBzdGFydE9mRGF5ID0gbmV3IERhdGUoZGF0ZSk7XG4gICAgc3RhcnRPZkRheS5zZXRIb3VycygwLCAwLCAwLCAwKTtcbiAgICBjb25zdCBlbmRPZkRheSA9IG5ldyBEYXRlKGRhdGUpO1xuICAgIGVuZE9mRGF5LnNldEhvdXJzKDIzLCA1OSwgNTksIDk5OSk7XG5cbiAgICByZXR1cm4gdGhpcy5wcmlzbWEubWVldGluZy5maW5kTWFueSh7XG4gICAgICB3aGVyZToge1xuICAgICAgICB0aGVyYXBpc3RJZCxcbiAgICAgICAgc3RhcnRUaW1lOiB7IGd0ZTogc3RhcnRPZkRheSwgbHRlOiBlbmRPZkRheSB9LFxuICAgICAgICBzdGF0dXM6IHsgaW46IFsnU0NIRURVTEVEJywgJ0NPTkZJUk1FRCddIH0sXG4gICAgICB9LFxuICAgICAgb3JkZXJCeTogeyBzdGFydFRpbWU6ICdhc2MnIH0sXG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIGdlbmVyYXRlU2xvdHNGb3JBdmFpbGFiaWxpdHlXaW5kb3coXG4gICAgZGF0ZTogRGF0ZSxcbiAgICBhdmFpbGFiaWxpdHk6IGFueSxcbiAgICBleGlzdGluZ0Jvb2tpbmdzOiBhbnlbXSxcbiAgICBjb25maWc6IFNsb3RHZW5lcmF0aW9uQ29uZmlnLFxuICApOiBUaW1lU2xvdFtdIHtcbiAgICBjb25zdCBzbG90czogVGltZVNsb3RbXSA9IFtdO1xuICAgIGNvbnN0IGR1cmF0aW9ucyA9IHRoaXMuZ2V0RHVyYXRpb25zKCk7XG5cbiAgICBjb25zdCBzdGFydFRpbWUgPSB0aGlzLmNyZWF0ZURhdGVUaW1lKGRhdGUsIGF2YWlsYWJpbGl0eS5zdGFydFRpbWUpO1xuICAgIGNvbnN0IGVuZFRpbWUgPSB0aGlzLmNyZWF0ZURhdGVUaW1lKGRhdGUsIGF2YWlsYWJpbGl0eS5lbmRUaW1lKTtcblxuICAgIGxldCBjdXJyZW50VGltZSA9IG5ldyBEYXRlKHN0YXJ0VGltZSk7XG5cbiAgICB3aGlsZSAoY3VycmVudFRpbWUgPCBlbmRUaW1lKSB7XG4gICAgICBjb25zdCBzbG90RW5kID0gbmV3IERhdGUoXG4gICAgICAgIGN1cnJlbnRUaW1lLmdldFRpbWUoKSArIGNvbmZpZy5zbG90SW50ZXJ2YWwgKiA2MDAwMCxcbiAgICAgICk7XG5cbiAgICAgIGlmIChzbG90RW5kIDw9IGVuZFRpbWUpIHtcbiAgICAgICAgLy8gQ2hlY2sgaWYgdGhpcyBzbG90IGNvbmZsaWN0cyB3aXRoIGV4aXN0aW5nIGJvb2tpbmdzXG4gICAgICAgIGlmIChcbiAgICAgICAgICAhdGhpcy5oYXNDb25mbGljdFdpdGhCb29raW5ncyhjdXJyZW50VGltZSwgc2xvdEVuZCwgZXhpc3RpbmdCb29raW5ncylcbiAgICAgICAgKSB7XG4gICAgICAgICAgLy8gRmluZCB3aGljaCBkdXJhdGlvbnMgZml0IGluIHRoaXMgc2xvdFxuICAgICAgICAgIGNvbnN0IGF2YWlsYWJsZUR1cmF0aW9ucyA9IHRoaXMuZ2V0QXZhaWxhYmxlRHVyYXRpb25zKFxuICAgICAgICAgICAgY3VycmVudFRpbWUsXG4gICAgICAgICAgICBlbmRUaW1lLFxuICAgICAgICAgICAgZXhpc3RpbmdCb29raW5ncyxcbiAgICAgICAgICAgIGR1cmF0aW9ucyxcbiAgICAgICAgICApO1xuXG4gICAgICAgICAgaWYgKGF2YWlsYWJsZUR1cmF0aW9ucy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICBzbG90cy5wdXNoKHtcbiAgICAgICAgICAgICAgc3RhcnRUaW1lOiBjdXJyZW50VGltZS50b0lTT1N0cmluZygpLFxuICAgICAgICAgICAgICBhdmFpbGFibGVEdXJhdGlvbnMsXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgY3VycmVudFRpbWUgPSBuZXcgRGF0ZShcbiAgICAgICAgY3VycmVudFRpbWUuZ2V0VGltZSgpICsgY29uZmlnLnNsb3RJbnRlcnZhbCAqIDYwMDAwLFxuICAgICAgKTtcbiAgICB9XG5cbiAgICByZXR1cm4gc2xvdHM7XG4gIH1cblxuICBwcml2YXRlIGNyZWF0ZURhdGVUaW1lKGRhdGU6IERhdGUsIHRpbWVTdHJpbmc6IHN0cmluZyk6IERhdGUge1xuICAgIGNvbnN0IFtob3VycywgbWludXRlc10gPSB0aW1lU3RyaW5nLnNwbGl0KCc6JykubWFwKE51bWJlcik7XG4gICAgY29uc3QgZGF0ZVRpbWUgPSBuZXcgRGF0ZShkYXRlKTtcbiAgICBkYXRlVGltZS5zZXRIb3Vycyhob3VycywgbWludXRlcywgMCwgMCk7XG4gICAgcmV0dXJuIGRhdGVUaW1lO1xuICB9XG5cbiAgcHJpdmF0ZSBoYXNDb25mbGljdFdpdGhCb29raW5ncyhcbiAgICBzbG90U3RhcnQ6IERhdGUsXG4gICAgc2xvdEVuZDogRGF0ZSxcbiAgICBib29raW5nczogYW55W10sXG4gICk6IGJvb2xlYW4ge1xuICAgIHJldHVybiBib29raW5ncy5zb21lKChib29raW5nKSA9PiB7XG4gICAgICBjb25zdCBib29raW5nRW5kID0gbmV3IERhdGUoXG4gICAgICAgIGJvb2tpbmcuc3RhcnRUaW1lLmdldFRpbWUoKSArIGJvb2tpbmcuZHVyYXRpb24gKiA2MDAwMCxcbiAgICAgICk7XG4gICAgICByZXR1cm4gdGhpcy5oYXNUaW1lT3ZlcmxhcChcbiAgICAgICAgc2xvdFN0YXJ0LFxuICAgICAgICBzbG90RW5kLFxuICAgICAgICBib29raW5nLnN0YXJ0VGltZSxcbiAgICAgICAgYm9va2luZ0VuZCxcbiAgICAgICk7XG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIGdldEF2YWlsYWJsZUR1cmF0aW9ucyhcbiAgICBzbG90U3RhcnQ6IERhdGUsXG4gICAgYXZhaWxhYmlsaXR5RW5kOiBEYXRlLFxuICAgIGV4aXN0aW5nQm9va2luZ3M6IGFueVtdLFxuICAgIGR1cmF0aW9uczogYW55W10sXG4gICkge1xuICAgIHJldHVybiBkdXJhdGlvbnMuZmlsdGVyKChkdXJhdGlvbikgPT4ge1xuICAgICAgY29uc3QgZHVyYXRpb25FbmQgPSBuZXcgRGF0ZShcbiAgICAgICAgc2xvdFN0YXJ0LmdldFRpbWUoKSArIGR1cmF0aW9uLmR1cmF0aW9uICogNjAwMDAsXG4gICAgICApO1xuXG4gICAgICAvLyBDaGVjayBpZiBkdXJhdGlvbiBmaXRzIHdpdGhpbiBhdmFpbGFiaWxpdHkgd2luZG93XG4gICAgICBpZiAoZHVyYXRpb25FbmQgPiBhdmFpbGFiaWxpdHlFbmQpIHtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgfVxuXG4gICAgICAvLyBDaGVjayBpZiBkdXJhdGlvbiBjb25mbGljdHMgd2l0aCBleGlzdGluZyBib29raW5nc1xuICAgICAgcmV0dXJuICF0aGlzLmhhc0NvbmZsaWN0V2l0aEJvb2tpbmdzKFxuICAgICAgICBzbG90U3RhcnQsXG4gICAgICAgIGR1cmF0aW9uRW5kLFxuICAgICAgICBleGlzdGluZ0Jvb2tpbmdzLFxuICAgICAgKTtcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgaGFzVGltZU92ZXJsYXAoXG4gICAgc3RhcnQxOiBEYXRlLFxuICAgIGVuZDE6IERhdGUsXG4gICAgc3RhcnQyOiBEYXRlLFxuICAgIGVuZDI6IERhdGUsXG4gICk6IGJvb2xlYW4ge1xuICAgIHJldHVybiBzdGFydDEgPCBlbmQyICYmIGVuZDEgPiBzdGFydDI7XG4gIH1cblxuICAvKipcbiAgICogQ2hlY2sgaWYgYSBzcGVjaWZpYyB0aW1lIHNsb3QgaXMgYXZhaWxhYmxlXG4gICAqL1xuICBhc3luYyBpc1Nsb3RBdmFpbGFibGUoXG4gICAgdGhlcmFwaXN0SWQ6IHN0cmluZyxcbiAgICBzdGFydFRpbWU6IERhdGUsXG4gICAgZHVyYXRpb246IG51bWJlcixcbiAgKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgY29uc3QgZW5kVGltZSA9IG5ldyBEYXRlKHN0YXJ0VGltZS5nZXRUaW1lKCkgKyBkdXJhdGlvbiAqIDYwMDAwKTtcbiAgICBjb25zdCBkYXlPZldlZWsgPSBzdGFydFRpbWUuZ2V0RGF5KCk7XG5cbiAgICAvLyBDaGVjayB0aGVyYXBpc3QgYXZhaWxhYmlsaXR5XG4gICAgY29uc3QgYXZhaWxhYmlsaXR5ID0gYXdhaXQgdGhpcy5wcmlzbWEudGhlcmFwaXN0QXZhaWxhYmlsaXR5LmZpbmRGaXJzdCh7XG4gICAgICB3aGVyZToge1xuICAgICAgICB0aGVyYXBpc3RJZCxcbiAgICAgICAgZGF5T2ZXZWVrOiBkYXlPZldlZWsudG9TdHJpbmcoKSxcbiAgICAgICAgaXNBdmFpbGFibGU6IHRydWUsXG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgaWYgKCFhdmFpbGFiaWxpdHkpIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICAvLyBDaGVjayBpZiB0aW1lIGZpdHMgd2l0aGluIGF2YWlsYWJpbGl0eSB3aW5kb3dcbiAgICBjb25zdCBhdmFpbFN0YXJ0ID0gdGhpcy5jcmVhdGVEYXRlVGltZShzdGFydFRpbWUsIGF2YWlsYWJpbGl0eS5zdGFydFRpbWUpO1xuICAgIGNvbnN0IGF2YWlsRW5kID0gdGhpcy5jcmVhdGVEYXRlVGltZShzdGFydFRpbWUsIGF2YWlsYWJpbGl0eS5lbmRUaW1lKTtcblxuICAgIGlmIChzdGFydFRpbWUgPCBhdmFpbFN0YXJ0IHx8IGVuZFRpbWUgPiBhdmFpbEVuZCkge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cblxuICAgIC8vIENoZWNrIGZvciBjb25mbGljdHMgd2l0aCBleGlzdGluZyBib29raW5nc1xuICAgIGNvbnN0IGV4aXN0aW5nQm9va2luZ3MgPSBhd2FpdCB0aGlzLmdldEV4aXN0aW5nQm9va2luZ3MoXG4gICAgICB0aGVyYXBpc3RJZCxcbiAgICAgIHN0YXJ0VGltZSxcbiAgICApO1xuXG4gICAgcmV0dXJuICF0aGlzLmhhc0NvbmZsaWN0V2l0aEJvb2tpbmdzKHN0YXJ0VGltZSwgZW5kVGltZSwgZXhpc3RpbmdCb29raW5ncyk7XG4gIH1cbn1cbiJdLCJ2ZXJzaW9uIjozfQ==