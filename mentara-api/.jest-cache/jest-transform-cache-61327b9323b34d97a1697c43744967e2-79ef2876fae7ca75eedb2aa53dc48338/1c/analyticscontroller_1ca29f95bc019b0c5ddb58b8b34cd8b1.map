{"version":3,"names":["common_1","cov_21sm6uxihp","s","require","analytics_service_1","jwt_auth_guard_1","current_user_id_decorator_1","current_user_role_decorator_1","zod_validation_pipe_1","analytics_schemas_1","AnalyticsController","analyticsService","constructor","f","getPlatformAnalytics","role","query","b","ForbiddenException","start","dateFrom","Date","undefined","end","dateTo","getTherapistAnalytics","userId","targetTherapistId","therapistId","getClientAnalytics","targetClientId","clientId","exports","__decorate","Get","__param","CurrentUserRole","Query","ZodValidationPipe","PlatformAnalyticsQueryDtoSchema","CurrentUserId","TherapistAnalyticsQueryDtoSchema","ClientAnalyticsQueryDtoSchema","Controller","UseGuards","JwtAuthGuard","AnalyticsService","_a","Object"],"sources":["/home/wetooa/Documents/code/projects/mentara/mentara-api/src/analytics/analytics.controller.ts"],"sourcesContent":["import {\n  Controller,\n  Get,\n  Query,\n  UseGuards,\n  ForbiddenException,\n} from '@nestjs/common';\nimport { AnalyticsService } from './analytics.service';\nimport { JwtAuthGuard } from '../auth/guards/jwt-auth.guard';\nimport { CurrentUserId } from '../auth/decorators/current-user-id.decorator';\nimport { CurrentUserRole } from '../auth/decorators/current-user-role.decorator';\nimport { ZodValidationPipe } from '../common/pipes/zod-validation.pipe';\nimport {\n  PlatformAnalyticsQueryDtoSchema,\n  TherapistAnalyticsQueryDtoSchema,\n  ClientAnalyticsQueryDtoSchema,\n} from './validation/analytics.schemas';\nimport type {\n  PlatformAnalyticsQueryDto,\n  TherapistAnalyticsQueryDto,\n  ClientAnalyticsQueryDto,\n} from './types';\n\n@Controller('analytics')\n@UseGuards(JwtAuthGuard)\nexport class AnalyticsController {\n  constructor(private readonly analyticsService: AnalyticsService) {}\n\n  @Get('platform')\n  getPlatformAnalytics(\n    @CurrentUserRole() role: string,\n    @Query(new ZodValidationPipe(PlatformAnalyticsQueryDtoSchema))\n    query: PlatformAnalyticsQueryDto,\n  ) {\n    if (role !== 'admin') {\n      throw new ForbiddenException('Access denied: Admin role required');\n    }\n\n    const start = query.dateFrom ? new Date(query.dateFrom) : undefined;\n    const end = query.dateTo ? new Date(query.dateTo) : undefined;\n\n    return this.analyticsService.getPlatformAnalytics(start, end);\n  }\n\n  @Get('therapist')\n  getTherapistAnalytics(\n    @CurrentUserId() userId: string,\n    @CurrentUserRole() role: string,\n    @Query(new ZodValidationPipe(TherapistAnalyticsQueryDtoSchema))\n    query: TherapistAnalyticsQueryDto,\n  ) {\n    // Allow therapists to view their own analytics or admins to view any\n    const targetTherapistId = query.therapistId || userId;\n\n    if (role === 'therapist' && targetTherapistId !== userId) {\n      throw new ForbiddenException(\n        'Access denied: Can only view your own analytics',\n      );\n    }\n\n    if (role !== 'therapist' && role !== 'admin') {\n      throw new ForbiddenException(\n        'Access denied: Therapist or Admin role required',\n      );\n    }\n\n    const start = query.dateFrom ? new Date(query.dateFrom) : undefined;\n    const end = query.dateTo ? new Date(query.dateTo) : undefined;\n\n    return this.analyticsService.getTherapistAnalytics(\n      targetTherapistId,\n      start,\n      end,\n    );\n  }\n\n  @Get('client')\n  getClientAnalytics(\n    @CurrentUserId() userId: string,\n    @CurrentUserRole() role: string,\n    @Query(new ZodValidationPipe(ClientAnalyticsQueryDtoSchema))\n    query: ClientAnalyticsQueryDto,\n  ) {\n    // Allow clients to view their own analytics or admins/therapists to view assigned clients\n    const targetClientId = query.clientId || userId;\n\n    if (role === 'user' && targetClientId !== userId) {\n      throw new ForbiddenException(\n        'Access denied: Can only view your own analytics',\n      );\n    }\n\n    if (role !== 'user' && role !== 'therapist' && role !== 'admin') {\n      throw new ForbiddenException('Access denied: Invalid role');\n    }\n\n    const start = query.dateFrom ? new Date(query.dateFrom) : undefined;\n    const end = query.dateTo ? new Date(query.dateTo) : undefined;\n\n    return this.analyticsService.getClientAnalytics(targetClientId, start, end);\n  }\n}\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;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","ignoreList":[]}