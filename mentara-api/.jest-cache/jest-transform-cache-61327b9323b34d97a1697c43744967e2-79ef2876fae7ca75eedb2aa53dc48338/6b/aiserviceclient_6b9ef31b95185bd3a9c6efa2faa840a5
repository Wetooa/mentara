69bb3a3e49e5073dfe1948434b64dff0
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var AiServiceClient_1;
Object.defineProperty(exports, "__esModule", { value: true });
exports.AiServiceClient = void 0;
const common_1 = require("@nestjs/common");
const config_1 = require("@nestjs/config");
const axios_1 = require("axios");
const class_validator_1 = require("class-validator");
// DTO for AI service input validation
class AiPredictionInputDto {
    inputs;
}
__decorate([
    (0, class_validator_1.IsArray)(),
    (0, class_validator_1.ArrayMinSize)(201, { message: 'Input array must contain exactly 201 values' }),
    (0, class_validator_1.ArrayMaxSize)(201, { message: 'Input array must contain exactly 201 values' }),
    (0, class_validator_1.IsNumber)({}, { each: true, message: 'All values must be numbers' }),
    (0, class_validator_1.Min)(0, { each: true, message: 'All values must be non-negative' }),
    (0, class_validator_1.Max)(10, { each: true, message: 'All values must be 10 or less' }),
    __metadata("design:type", Array)
], AiPredictionInputDto.prototype, "inputs", void 0);
let AiServiceClient = AiServiceClient_1 = class AiServiceClient {
    configService;
    logger = new common_1.Logger(AiServiceClient_1.name);
    axiosInstance;
    maxRetries = 3;
    timeoutMs = 30000; // 30 seconds
    baseURL;
    requestCount = 0;
    maxRequestsPerMinute = 60; // Rate limiting
    lastResetTime = Date.now();
    constructor(configService) {
        this.configService = configService;
        // Get AI service URL from environment with fallback
        this.baseURL =
            this.configService.get('AI_SERVICE_URL') ||
                'http://localhost:5000';
        this.axiosInstance = axios_1.default.create({
            baseURL: this.baseURL,
            timeout: this.timeoutMs,
            headers: {
                'Content-Type': 'application/json',
                'User-Agent': 'Mentara-API/1.0',
            },
        });
        // Add request interceptor for logging
        this.axiosInstance.interceptors.request.use((config) => {
            this.logger.debug(`Making AI service request to ${config.url}`);
            return config;
        }, (error) => {
            this.logger.error('AI service request interceptor error:', error);
            return Promise.reject(new Error(String(error)));
        });
        // Add response interceptor for logging
        this.axiosInstance.interceptors.response.use((response) => {
            this.logger.debug(`AI service response received: ${response.status}`);
            return response;
        }, (error) => {
            this.logger.error('AI service response error:', error?.response?.status || error.message);
            return Promise.reject(new Error(String(error)));
        });
    }
    validateInput(flatAnswers) {
        const inputDto = new AiPredictionInputDto();
        inputDto.inputs = flatAnswers;
        const errors = (0, class_validator_1.validateSync)(inputDto);
        if (errors.length > 0) {
            this.logger.warn('AI service input validation failed:', errors.map((e) => e.toString()));
            return false;
        }
        return true;
    }
    isRateLimited() {
        const now = Date.now();
        // Reset counter every minute
        if (now - this.lastResetTime > 60000) {
            this.requestCount = 0;
            this.lastResetTime = now;
        }
        if (this.requestCount >= this.maxRequestsPerMinute) {
            this.logger.warn('AI service rate limit exceeded');
            return true;
        }
        this.requestCount++;
        return false;
    }
    sanitizeInput(flatAnswers) {
        // Sanitize input values to prevent injection attacks
        return flatAnswers.map((value) => {
            // Ensure value is a finite number
            if (!Number.isFinite(value)) {
                this.logger.warn(`Invalid value detected: ${value}, replacing with 0`);
                return 0;
            }
            // Clamp values to expected range
            return Math.max(0, Math.min(10, Math.round(value * 100) / 100)); // Round to 2 decimal places
        });
    }
    async predict(flatAnswers) {
        const startTime = Date.now();
        try {
            // Rate limiting check
            if (this.isRateLimited()) {
                return {
                    success: false,
                    error: 'Rate limit exceeded. Please try again later.',
                };
            }
            // Input validation
            if (!this.validateInput(flatAnswers)) {
                return {
                    success: false,
                    error: 'Invalid input data for AI prediction',
                };
            }
            // Sanitize input
            const sanitizedInput = this.sanitizeInput(flatAnswers);
            // Make the prediction with retry logic
            const result = await this.makeRequestWithRetry(sanitizedInput);
            const responseTime = Date.now() - startTime;
            this.logger.log(`AI prediction completed in ${responseTime}ms`);
            return {
                success: true,
                predictions: result,
                responseTime,
            };
        }
        catch (error) {
            const responseTime = Date.now() - startTime;
            this.logger.error(`AI prediction failed after ${responseTime}ms:`, error);
            return {
                success: false,
                error: this.getErrorMessage(error),
                responseTime,
            };
        }
    }
    async makeRequestWithRetry(sanitizedInput, attempt = 1) {
        try {
            const response = await this.axiosInstance.post('/predict', {
                inputs: sanitizedInput,
            });
            // Validate response structure
            if (!response.data || typeof response.data !== 'object') {
                throw new Error('Invalid response format from AI service');
            }
            return response.data;
        }
        catch (error) {
            if (attempt < this.maxRetries && this.isRetryableError(error)) {
                this.logger.warn(`AI service request failed (attempt ${attempt}/${this.maxRetries}), retrying...`);
                // Exponential backoff
                const delay = Math.min(1000 * Math.pow(2, attempt - 1), 5000);
                await new Promise((resolve) => setTimeout(resolve, delay));
                return this.makeRequestWithRetry(sanitizedInput, attempt + 1);
            }
            throw error;
        }
    }
    isRetryableError(error) {
        if (error instanceof axios_1.AxiosError) {
            // Retry on network errors, timeouts, and 5xx server errors
            return (!error.response ||
                error.response.status >= 500 ||
                error.code === 'ECONNRESET' ||
                error.code === 'ETIMEDOUT');
        }
        return false;
    }
    getErrorMessage(error) {
        if (error instanceof axios_1.AxiosError) {
            if (error.code === 'ECONNREFUSED') {
                return 'AI service is currently unavailable';
            }
            if (error.code === 'ETIMEDOUT') {
                return 'AI service request timed out';
            }
            if (error.response?.status === 400) {
                return 'Invalid request to AI service';
            }
            if (error.response?.status === 429) {
                return 'AI service rate limit exceeded';
            }
            if (error.response?.status && error.response.status >= 500) {
                return 'AI service internal error';
            }
        }
        return 'Unknown error occurred while contacting AI service';
    }
    async healthCheck() {
        try {
            const response = await this.axiosInstance.get('/health', {
                timeout: 5000,
            });
            return response.status === 200;
        }
        catch (error) {
            this.logger.warn('AI service health check failed:', error);
            return false;
        }
    }
    getServiceInfo() {
        return {
            baseURL: this.baseURL,
            timeout: this.timeoutMs,
            maxRetries: this.maxRetries,
        };
    }
};
exports.AiServiceClient = AiServiceClient;
exports.AiServiceClient = AiServiceClient = AiServiceClient_1 = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [config_1.ConfigService])
], AiServiceClient);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL3ByZS1hc3Nlc3NtZW50L3NlcnZpY2VzL2FpLXNlcnZpY2UuY2xpZW50LnRzIiwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7QUFBQSwyQ0FBb0Q7QUFDcEQsMkNBQStDO0FBQy9DLGlDQUF5RDtBQUN6RCxxREFReUI7QUFFekIsc0NBQXNDO0FBQ3RDLE1BQU0sb0JBQW9CO0lBT3hCLE1BQU0sQ0FBWTtDQUNuQjtBQURDO0lBTkMsSUFBQSx5QkFBTyxHQUFFO0lBQ1QsSUFBQSw4QkFBWSxFQUFDLEdBQUcsRUFBRSxFQUFFLE9BQU8sRUFBRSw2Q0FBNkMsRUFBRSxDQUFDO0lBQzdFLElBQUEsOEJBQVksRUFBQyxHQUFHLEVBQUUsRUFBRSxPQUFPLEVBQUUsNkNBQTZDLEVBQUUsQ0FBQztJQUM3RSxJQUFBLDBCQUFRLEVBQUMsRUFBRSxFQUFFLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxPQUFPLEVBQUUsNEJBQTRCLEVBQUUsQ0FBQztJQUNuRSxJQUFBLHFCQUFHLEVBQUMsQ0FBQyxFQUFFLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxPQUFPLEVBQUUsaUNBQWlDLEVBQUUsQ0FBQztJQUNsRSxJQUFBLHFCQUFHLEVBQUMsRUFBRSxFQUFFLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxPQUFPLEVBQUUsK0JBQStCLEVBQUUsQ0FBQzs7b0RBQ2hEO0FBV2IsSUFBTSxlQUFlLHVCQUFyQixNQUFNLGVBQWU7SUFVRztJQVRaLE1BQU0sR0FBRyxJQUFJLGVBQU0sQ0FBQyxpQkFBZSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQzFDLGFBQWEsQ0FBZ0I7SUFDN0IsVUFBVSxHQUFXLENBQUMsQ0FBQztJQUN2QixTQUFTLEdBQVcsS0FBSyxDQUFDLENBQUMsYUFBYTtJQUN4QyxPQUFPLENBQVM7SUFDekIsWUFBWSxHQUFHLENBQUMsQ0FBQztJQUNSLG9CQUFvQixHQUFHLEVBQUUsQ0FBQyxD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Q0FBQyxpQ0FBaUMsRUFBRSxLQUFLLENBQUMsQ0FBQztZQUMzRCxPQUFPLEtBQUssQ0FBQztRQUNmLENBQUM7SUFDSCxDQUFDO0lBRUQsY0FBYztRQUNaLE9BQU87WUFDTCxPQUFPLEVBQUUsSUFBSSxDQUFDLE9BQU87WUFDckIsT0FBTyxFQUFFLElBQUksQ0FBQyxTQUFTO1lBQ3ZCLFVBQVUsRUFBRSxJQUFJLENBQUMsVUFBVTtTQUM1QixDQUFDO0lBQ0osQ0FBQztDQUNGLENBQUE7QUExT1ksMENBQWU7MEJBQWYsZUFBZTtJQUQzQixJQUFBLG1CQUFVLEdBQUU7cUNBV2lDLHNCQUFhO0dBVjlDLGVBQWUsQ0EwTzNCIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9ob21lL3dldG9vYS9Eb2N1bWVudHMvY29kZS9wcm9qZWN0cy9tZW50YXJhL21lbnRhcmEtYXBpL3NyYy9wcmUtYXNzZXNzbWVudC9zZXJ2aWNlcy9haS1zZXJ2aWNlLmNsaWVudC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlLCBMb2dnZXIgfSBmcm9tICdAbmVzdGpzL2NvbW1vbic7XG5pbXBvcnQgeyBDb25maWdTZXJ2aWNlIH0gZnJvbSAnQG5lc3Rqcy9jb25maWcnO1xuaW1wb3J0IGF4aW9zLCB7IEF4aW9zSW5zdGFuY2UsIEF4aW9zRXJyb3IgfSBmcm9tICdheGlvcyc7XG5pbXBvcnQge1xuICBJc0FycmF5LFxuICBJc051bWJlcixcbiAgdmFsaWRhdGVTeW5jLFxuICBNaW4sXG4gIE1heCxcbiAgQXJyYXlNaW5TaXplLFxuICBBcnJheU1heFNpemUsXG59IGZyb20gJ2NsYXNzLXZhbGlkYXRvcic7XG5cbi8vIERUTyBmb3IgQUkgc2VydmljZSBpbnB1dCB2YWxpZGF0aW9uXG5jbGFzcyBBaVByZWRpY3Rpb25JbnB1dER0byB7XG4gIEBJc0FycmF5KClcbiAgQEFycmF5TWluU2l6ZSgyMDEsIHsgbWVzc2FnZTogJ0lucHV0IGFycmF5IG11c3QgY29udGFpbiBleGFjdGx5IDIwMSB2YWx1ZXMnIH0pXG4gIEBBcnJheU1heFNpemUoMjAxLCB7IG1lc3NhZ2U6ICdJbnB1dCBhcnJheSBtdXN0IGNvbnRhaW4gZXhhY3RseSAyMDEgdmFsdWVzJyB9KVxuICBASXNOdW1iZXIoe30sIHsgZWFjaDogdHJ1ZSwgbWVzc2FnZTogJ0FsbCB2YWx1ZXMgbXVzdCBiZSBudW1iZXJzJyB9KVxuICBATWluKDAsIHsgZWFjaDogdHJ1ZSwgbWVzc2FnZTogJ0FsbCB2YWx1ZXMgbXVzdCBiZSBub24tbmVnYXRpdmUnIH0pXG4gIEBNYXgoMTAsIHsgZWFjaDogdHJ1ZSwgbWVzc2FnZTogJ0FsbCB2YWx1ZXMgbXVzdCBiZSAxMCBvciBsZXNzJyB9KVxuICBpbnB1dHMhOiBudW1iZXJbXTtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBBaVByZWRpY3Rpb25SZXN1bHQge1xuICBzdWNjZXNzOiBib29sZWFuO1xuICBwcmVkaWN0aW9ucz86IFJlY29yZDxzdHJpbmcsIGJvb2xlYW4+O1xuICBlcnJvcj86IHN0cmluZztcbiAgcmVzcG9uc2VUaW1lPzogbnVtYmVyO1xufVxuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgQWlTZXJ2aWNlQ2xpZW50IHtcbiAgcHJpdmF0ZSByZWFkb25seSBsb2dnZXIgPSBuZXcgTG9nZ2VyKEFpU2VydmljZUNsaWVudC5uYW1lKTtcbiAgcHJpdmF0ZSByZWFkb25seSBheGlvc0luc3RhbmNlOiBBeGlvc0luc3RhbmNlO1xuICBwcml2YXRlIHJlYWRvbmx5IG1heFJldHJpZXM6IG51bWJlciA9IDM7XG4gIHByaXZhdGUgcmVhZG9ubHkgdGltZW91dE1zOiBudW1iZXIgPSAzMDAwMDsgLy8gMzAgc2Vjb25kc1xuICBwcml2YXRlIHJlYWRvbmx5IGJhc2VVUkw6IHN0cmluZztcbiAgcHJpdmF0ZSByZXF1ZXN0Q291bnQgPSAwO1xuICBwcml2YXRlIHJlYWRvbmx5IG1heFJlcXVlc3RzUGVyTWludXRlID0gNjA7IC8vIFJhdGUgbGltaXRpbmdcbiAgcHJpdmF0ZSBsYXN0UmVzZXRUaW1lID0gRGF0ZS5ub3coKTtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIHJlYWRvbmx5IGNvbmZpZ1NlcnZpY2U6IENvbmZpZ1NlcnZpY2UpIHtcbiAgICAvLyBHZXQgQUkgc2VydmljZSBVUkwgZnJvbSBlbnZpcm9ubWVudCB3aXRoIGZhbGxiYWNrXG4gICAgdGhpcy5iYXNlVVJMID1cbiAgICAgIHRoaXMuY29uZmlnU2VydmljZS5nZXQ8c3RyaW5nPignQUlfU0VSVklDRV9VUkwnKSB8fFxuICAgICAgJ2h0dHA6Ly9sb2NhbGhvc3Q6NTAwMCc7XG5cbiAgICB0aGlzLmF4aW9zSW5zdGFuY2UgPSBheGlvcy5jcmVhdGUoe1xuICAgICAgYmFzZVVSTDogdGhpcy5iYXNlVVJMLFxuICAgICAgdGltZW91dDogdGhpcy50aW1lb3V0TXMsXG4gICAgICBoZWFkZXJzOiB7XG4gICAgICAgICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicsXG4gICAgICAgICdVc2VyLUFnZW50JzogJ01lbnRhcmEtQVBJLzEuMCcsXG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgLy8gQWRkIHJlcXVlc3QgaW50ZXJjZXB0b3IgZm9yIGxvZ2dpbmdcbiAgICB0aGlzLmF4aW9zSW5zdGFuY2UuaW50ZXJjZXB0b3JzLnJlcXVlc3QudXNlKFxuICAgICAgKGNvbmZpZykgPT4ge1xuICAgICAgICB0aGlzLmxvZ2dlci5kZWJ1ZyhgTWFraW5nIEFJIHNlcnZpY2UgcmVxdWVzdCB0byAke2NvbmZpZy51cmx9YCk7XG4gICAgICAgIHJldHVybiBjb25maWc7XG4gICAgICB9LFxuICAgICAgKGVycm9yKSA9PiB7XG4gICAgICAgIHRoaXMubG9nZ2VyLmVycm9yKCdBSSBzZXJ2aWNlIHJlcXVlc3QgaW50ZXJjZXB0b3IgZXJyb3I6JywgZXJyb3IpO1xuICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QobmV3IEVycm9yKFN0cmluZyhlcnJvcikpKTtcbiAgICAgIH0sXG4gICAgKTtcblxuICAgIC8vIEFkZCByZXNwb25zZSBpbnRlcmNlcHRvciBmb3IgbG9nZ2luZ1xuICAgIHRoaXMuYXhpb3NJbnN0YW5jZS5pbnRlcmNlcHRvcnMucmVzcG9uc2UudXNlKFxuICAgICAgKHJlc3BvbnNlKSA9PiB7XG4gICAgICAgIHRoaXMubG9nZ2VyLmRlYnVnKGBBSSBzZXJ2aWNlIHJlc3BvbnNlIHJlY2VpdmVkOiAke3Jlc3BvbnNlLnN0YXR1c31gKTtcbiAgICAgICAgcmV0dXJuIHJlc3BvbnNlO1xuICAgICAgfSxcbiAgICAgIChlcnJvcikgPT4ge1xuICAgICAgICB0aGlzLmxvZ2dlci5lcnJvcihcbiAgICAgICAgICAnQUkgc2VydmljZSByZXNwb25zZSBlcnJvcjonLFxuICAgICAgICAgIGVycm9yPy5yZXNwb25zZT8uc3RhdHVzIHx8IGVycm9yLm1lc3NhZ2UsXG4gICAgICAgICk7XG4gICAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdChuZXcgRXJyb3IoU3RyaW5nKGVycm9yKSkpO1xuICAgICAgfSxcbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSB2YWxpZGF0ZUlucHV0KGZsYXRBbnN3ZXJzOiBudW1iZXJbXSk6IGJvb2xlYW4ge1xuICAgIGNvbnN0IGlucHV0RHRvID0gbmV3IEFpUHJlZGljdGlvbklucHV0RHRvKCk7XG4gICAgaW5wdXREdG8uaW5wdXRzID0gZmxhdEFuc3dlcnM7XG5cbiAgICBjb25zdCBlcnJvcnMgPSB2YWxpZGF0ZVN5bmMoaW5wdXREdG8pO1xuXG4gICAgaWYgKGVycm9ycy5sZW5ndGggPiAwKSB7XG4gICAgICB0aGlzLmxvZ2dlci53YXJuKFxuICAgICAgICAnQUkgc2VydmljZSBpbnB1dCB2YWxpZGF0aW9uIGZhaWxlZDonLFxuICAgICAgICBlcnJvcnMubWFwKChlKSA9PiBlLnRvU3RyaW5nKCkpLFxuICAgICAgKTtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuXG4gIHByaXZhdGUgaXNSYXRlTGltaXRlZCgpOiBib29sZWFuIHtcbiAgICBjb25zdCBub3cgPSBEYXRlLm5vdygpO1xuXG4gICAgLy8gUmVzZXQgY291bnRlciBldmVyeSBtaW51dGVcbiAgICBpZiAobm93IC0gdGhpcy5sYXN0UmVzZXRUaW1lID4gNjAwMDApIHtcbiAgICAgIHRoaXMucmVxdWVzdENvdW50ID0gMDtcbiAgICAgIHRoaXMubGFzdFJlc2V0VGltZSA9IG5vdztcbiAgICB9XG5cbiAgICBpZiAodGhpcy5yZXF1ZXN0Q291bnQgPj0gdGhpcy5tYXhSZXF1ZXN0c1Blck1pbnV0ZSkge1xuICAgICAgdGhpcy5sb2dnZXIud2FybignQUkgc2VydmljZSByYXRlIGxpbWl0IGV4Y2VlZGVkJyk7XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG5cbiAgICB0aGlzLnJlcXVlc3RDb3VudCsrO1xuICAgIHJldHVybiBmYWxzZTtcbiAgfVxuXG4gIHByaXZhdGUgc2FuaXRpemVJbnB1dChmbGF0QW5zd2VyczogbnVtYmVyW10pOiBudW1iZXJbXSB7XG4gICAgLy8gU2FuaXRpemUgaW5wdXQgdmFsdWVzIHRvIHByZXZlbnQgaW5qZWN0aW9uIGF0dGFja3NcbiAgICByZXR1cm4gZmxhdEFuc3dlcnMubWFwKCh2YWx1ZSkgPT4ge1xuICAgICAgLy8gRW5zdXJlIHZhbHVlIGlzIGEgZmluaXRlIG51bWJlclxuICAgICAgaWYgKCFOdW1iZXIuaXNGaW5pdGUodmFsdWUpKSB7XG4gICAgICAgIHRoaXMubG9nZ2VyLndhcm4oYEludmFsaWQgdmFsdWUgZGV0ZWN0ZWQ6ICR7dmFsdWV9LCByZXBsYWNpbmcgd2l0aCAwYCk7XG4gICAgICAgIHJldHVybiAwO1xuICAgICAgfVxuXG4gICAgICAvLyBDbGFtcCB2YWx1ZXMgdG8gZXhwZWN0ZWQgcmFuZ2VcbiAgICAgIHJldHVybiBNYXRoLm1heCgwLCBNYXRoLm1pbigxMCwgTWF0aC5yb3VuZCh2YWx1ZSAqIDEwMCkgLyAxMDApKTsgLy8gUm91bmQgdG8gMiBkZWNpbWFsIHBsYWNlc1xuICAgIH0pO1xuICB9XG5cbiAgYXN5bmMgcHJlZGljdChmbGF0QW5zd2VyczogbnVtYmVyW10pOiBQcm9taXNlPEFpUHJlZGljdGlvblJlc3VsdD4ge1xuICAgIGNvbnN0IHN0YXJ0VGltZSA9IERhdGUubm93KCk7XG5cbiAgICB0cnkge1xuICAgICAgLy8gUmF0ZSBsaW1pdGluZyBjaGVja1xuICAgICAgaWYgKHRoaXMuaXNSYXRlTGltaXRlZCgpKSB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgICAgZXJyb3I6ICdSYXRlIGxpbWl0IGV4Y2VlZGVkLiBQbGVhc2UgdHJ5IGFnYWluIGxhdGVyLicsXG4gICAgICAgIH07XG4gICAgICB9XG5cbiAgICAgIC8vIElucHV0IHZhbGlkYXRpb25cbiAgICAgIGlmICghdGhpcy52YWxpZGF0ZUlucHV0KGZsYXRBbnN3ZXJzKSkge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICAgIGVycm9yOiAnSW52YWxpZCBpbnB1dCBkYXRhIGZvciBBSSBwcmVkaWN0aW9uJyxcbiAgICAgICAgfTtcbiAgICAgIH1cblxuICAgICAgLy8gU2FuaXRpemUgaW5wdXRcbiAgICAgIGNvbnN0IHNhbml0aXplZElucHV0ID0gdGhpcy5zYW5pdGl6ZUlucHV0KGZsYXRBbnN3ZXJzKTtcblxuICAgICAgLy8gTWFrZSB0aGUgcHJlZGljdGlvbiB3aXRoIHJldHJ5IGxvZ2ljXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCB0aGlzLm1ha2VSZXF1ZXN0V2l0aFJldHJ5KHNhbml0aXplZElucHV0KTtcblxuICAgICAgY29uc3QgcmVzcG9uc2VUaW1lID0gRGF0ZS5ub3coKSAtIHN0YXJ0VGltZTtcbiAgICAgIHRoaXMubG9nZ2VyLmxvZyhgQUkgcHJlZGljdGlvbiBjb21wbGV0ZWQgaW4gJHtyZXNwb25zZVRpbWV9bXNgKTtcblxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgc3VjY2VzczogdHJ1ZSxcbiAgICAgICAgcHJlZGljdGlvbnM6IHJlc3VsdCxcbiAgICAgICAgcmVzcG9uc2VUaW1lLFxuICAgICAgfTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc3QgcmVzcG9uc2VUaW1lID0gRGF0ZS5ub3coKSAtIHN0YXJ0VGltZTtcbiAgICAgIHRoaXMubG9nZ2VyLmVycm9yKGBBSSBwcmVkaWN0aW9uIGZhaWxlZCBhZnRlciAke3Jlc3BvbnNlVGltZX1tczpgLCBlcnJvcik7XG5cbiAgICAgIHJldHVybiB7XG4gICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICBlcnJvcjogdGhpcy5nZXRFcnJvck1lc3NhZ2UoZXJyb3IpLFxuICAgICAgICByZXNwb25zZVRpbWUsXG4gICAgICB9O1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgbWFrZVJlcXVlc3RXaXRoUmV0cnkoXG4gICAgc2FuaXRpemVkSW5wdXQ6IG51bWJlcltdLFxuICAgIGF0dGVtcHQ6IG51bWJlciA9IDEsXG4gICk6IFByb21pc2U8UmVjb3JkPHN0cmluZywgYm9vbGVhbj4+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCB0aGlzLmF4aW9zSW5zdGFuY2UucG9zdCgnL3ByZWRpY3QnLCB7XG4gICAgICAgIGlucHV0czogc2FuaXRpemVkSW5wdXQsXG4gICAgICB9KTtcblxuICAgICAgLy8gVmFsaWRhdGUgcmVzcG9uc2Ugc3RydWN0dXJlXG4gICAgICBpZiAoIXJlc3BvbnNlLmRhdGEgfHwgdHlwZW9mIHJlc3BvbnNlLmRhdGEgIT09ICdvYmplY3QnKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignSW52YWxpZCByZXNwb25zZSBmb3JtYXQgZnJvbSBBSSBzZXJ2aWNlJyk7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiByZXNwb25zZS5kYXRhIGFzIFJlY29yZDxzdHJpbmcsIGJvb2xlYW4+O1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBpZiAoYXR0ZW1wdCA8IHRoaXMubWF4UmV0cmllcyAmJiB0aGlzLmlzUmV0cnlhYmxlRXJyb3IoZXJyb3IpKSB7XG4gICAgICAgIHRoaXMubG9nZ2VyLndhcm4oXG4gICAgICAgICAgYEFJIHNlcnZpY2UgcmVxdWVzdCBmYWlsZWQgKGF0dGVtcHQgJHthdHRlbXB0fS8ke3RoaXMubWF4UmV0cmllc30pLCByZXRyeWluZy4uLmAsXG4gICAgICAgICk7XG5cbiAgICAgICAgLy8gRXhwb25lbnRpYWwgYmFja29mZlxuICAgICAgICBjb25zdCBkZWxheSA9IE1hdGgubWluKDEwMDAgKiBNYXRoLnBvdygyLCBhdHRlbXB0IC0gMSksIDUwMDApO1xuICAgICAgICBhd2FpdCBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gc2V0VGltZW91dChyZXNvbHZlLCBkZWxheSkpO1xuXG4gICAgICAgIHJldHVybiB0aGlzLm1ha2VSZXF1ZXN0V2l0aFJldHJ5KHNhbml0aXplZElucHV0LCBhdHRlbXB0ICsgMSk7XG4gICAgICB9XG5cbiAgICAgIHRocm93IGVycm9yO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgaXNSZXRyeWFibGVFcnJvcihlcnJvcjogdW5rbm93bik6IGJvb2xlYW4ge1xuICAgIGlmIChlcnJvciBpbnN0YW5jZW9mIEF4aW9zRXJyb3IpIHtcbiAgICAgIC8vIFJldHJ5IG9uIG5ldHdvcmsgZXJyb3JzLCB0aW1lb3V0cywgYW5kIDV4eCBzZXJ2ZXIgZXJyb3JzXG4gICAgICByZXR1cm4gKFxuICAgICAgICAhZXJyb3IucmVzcG9uc2UgfHxcbiAgICAgICAgZXJyb3IucmVzcG9uc2Uuc3RhdHVzID49IDUwMCB8fFxuICAgICAgICBlcnJvci5jb2RlID09PSAnRUNPTk5SRVNFVCcgfHxcbiAgICAgICAgZXJyb3IuY29kZSA9PT0gJ0VUSU1FRE9VVCdcbiAgICAgICk7XG4gICAgfVxuICAgIHJldHVybiBmYWxzZTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0RXJyb3JNZXNzYWdlKGVycm9yOiB1bmtub3duKTogc3RyaW5nIHtcbiAgICBpZiAoZXJyb3IgaW5zdGFuY2VvZiBBeGlvc0Vycm9yKSB7XG4gICAgICBpZiAoZXJyb3IuY29kZSA9PT0gJ0VDT05OUkVGVVNFRCcpIHtcbiAgICAgICAgcmV0dXJuICdBSSBzZXJ2aWNlIGlzIGN1cnJlbnRseSB1bmF2YWlsYWJsZSc7XG4gICAgICB9XG4gICAgICBpZiAoZXJyb3IuY29kZSA9PT0gJ0VUSU1FRE9VVCcpIHtcbiAgICAgICAgcmV0dXJuICdBSSBzZXJ2aWNlIHJlcXVlc3QgdGltZWQgb3V0JztcbiAgICAgIH1cbiAgICAgIGlmIChlcnJvci5yZXNwb25zZT8uc3RhdHVzID09PSA0MDApIHtcbiAgICAgICAgcmV0dXJuICdJbnZhbGlkIHJlcXVlc3QgdG8gQUkgc2VydmljZSc7XG4gICAgICB9XG4gICAgICBpZiAoZXJyb3IucmVzcG9uc2U/LnN0YXR1cyA9PT0gNDI5KSB7XG4gICAgICAgIHJldHVybiAnQUkgc2VydmljZSByYXRlIGxpbWl0IGV4Y2VlZGVkJztcbiAgICAgIH1cbiAgICAgIGlmIChlcnJvci5yZXNwb25zZT8uc3RhdHVzICYmIGVycm9yLnJlc3BvbnNlLnN0YXR1cyA+PSA1MDApIHtcbiAgICAgICAgcmV0dXJuICdBSSBzZXJ2aWNlIGludGVybmFsIGVycm9yJztcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gJ1Vua25vd24gZXJyb3Igb2NjdXJyZWQgd2hpbGUgY29udGFjdGluZyBBSSBzZXJ2aWNlJztcbiAgfVxuXG4gIGFzeW5jIGhlYWx0aENoZWNrKCk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHRoaXMuYXhpb3NJbnN0YW5jZS5nZXQoJy9oZWFsdGgnLCB7XG4gICAgICAgIHRpbWVvdXQ6IDUwMDAsXG4gICAgICB9KTtcbiAgICAgIHJldHVybiByZXNwb25zZS5zdGF0dXMgPT09IDIwMDtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhpcy5sb2dnZXIud2FybignQUkgc2VydmljZSBoZWFsdGggY2hlY2sgZmFpbGVkOicsIGVycm9yKTtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gIH1cblxuICBnZXRTZXJ2aWNlSW5mbygpOiB7IGJhc2VVUkw6IHN0cmluZzsgdGltZW91dDogbnVtYmVyOyBtYXhSZXRyaWVzOiBudW1iZXIgfSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIGJhc2VVUkw6IHRoaXMuYmFzZVVSTCxcbiAgICAgIHRpbWVvdXQ6IHRoaXMudGltZW91dE1zLFxuICAgICAgbWF4UmV0cmllczogdGhpcy5tYXhSZXRyaWVzLFxuICAgIH07XG4gIH1cbn1cbiJdLCJ2ZXJzaW9uIjozfQ==