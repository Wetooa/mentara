f1fe5efcbca8a550dab38d6e3fdf4747
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var __param = (this && this.__param) || function (paramIndex, decorator) {
    return function (target, key) { decorator(target, key, paramIndex); }
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.BookingController = void 0;
const common_1 = require("@nestjs/common");
const clerk_auth_guard_1 = require("../guards/clerk-auth.guard");
const current_user_id_decorator_1 = require("../decorators/current-user-id.decorator");
const current_user_role_decorator_1 = require("../decorators/current-user-role.decorator");
const booking_service_1 = require("./booking.service");
const booking_1 = require("../../schema/booking");
let BookingController = class BookingController {
    bookingService;
    constructor(bookingService) {
        this.bookingService = bookingService;
    }
    // Meeting endpoints
    async createMeeting(createMeetingDto, userId, role) {
        // Only clients can book meetings, but we'll validate the relationship in the service
        if (role !== 'client') {
            throw new common_1.ForbiddenException('Only clients can book meetings');
        }
        return this.bookingService.createMeeting(createMeetingDto, userId);
    }
    async getMeetings(userId, role) {
        return this.bookingService.getMeetings(userId, role);
    }
    async getMeeting(id, userId, role) {
        return this.bookingService.getMeeting(id, userId, role);
    }
    async updateMeeting(id, updateMeetingDto, userId, role) {
        return this.bookingService.updateMeeting(id, updateMeetingDto, userId, role);
    }
    async cancelMeeting(id, userId, role) {
        return this.bookingService.cancelMeeting(id, userId, role);
    }
    // Availability endpoints (therapist only)
    async createAvailability(createAvailabilityDto, therapistId, role) {
        if (role !== 'therapist') {
            throw new common_1.UnauthorizedException('Only therapists can manage availability');
        }
        return this.bookingService.createAvailability(createAvailabilityDto, therapistId);
    }
    async getAvailability(therapistId, role) {
        if (role !== 'therapist') {
            throw new common_1.UnauthorizedException('Only therapists can view their availability');
        }
        return this.bookingService.getAvailability(therapistId);
    }
    async updateAvailability(id, updateAvailabilityDto, therapistId, role) {
        if (role !== 'therapist') {
            throw new common_1.UnauthorizedException('Only therapists can update availability');
        }
        return this.bookingService.updateAvailability(id, updateAvailabilityDto, therapistId);
    }
    async deleteAvailability(id, therapistId, role) {
        if (role !== 'therapist') {
            throw new common_1.UnauthorizedException('Only therapists can delete availability');
        }
        return this.bookingService.deleteAvailability(id, therapistId);
    }
    // Duration endpoints (public)
    getDurations() {
        return this.bookingService.getDurations();
    }
    // Available slots endpoint
    async getAvailableSlots(therapistId, date) {
        return this.bookingService.getAvailableSlots(therapistId, date);
    }
};
exports.BookingController = BookingController;
__decorate([
    (0, common_1.Post)('meetings'),
    __param(0, (0, common_1.Body)()),
    __param(1, (0, current_user_id_decorator_1.CurrentUserId)()),
    __param(2, (0, current_user_role_decorator_1.CurrentUserRole)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [booking_1.MeetingCreateDto, String, String]),
    __metadata("design:returntype", Promise)
], BookingController.prototype, "createMeeting", null);
__decorate([
    (0, common_1.Get)('meetings'),
    __param(0, (0, current_user_id_decorator_1.CurrentUserId)()),
    __param(1, (0, current_user_role_decorator_1.CurrentUserRole)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [String, String]),
    __metadata("design:returntype", Promise)
], BookingController.prototype, "getMeetings", null);
__decorate([
    (0, common_1.Get)('meetings/:id'),
    __param(0, (0, common_1.Param)('id')),
    __param(1, (0, current_user_id_decorator_1.CurrentUserId)()),
    __param(2, (0, current_user_role_decorator_1.CurrentUserRole)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [String, String, String]),
    __metadata("design:returntype", Promise)
], BookingController.prototype, "getMeeting", null);
__decorate([
    (0, common_1.Put)('meetings/:id'),
    __param(0, (0, common_1.Param)('id')),
    __param(1, (0, common_1.Body)()),
    __param(2, (0, current_user_id_decorator_1.CurrentUserId)()),
    __param(3, (0, current_user_role_decorator_1.CurrentUserRole)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [String, booking_1.MeetingUpdateDto, String, String]),
    __metadata("design:returntype", Promise)
], BookingController.prototype, "updateMeeting", null);
__decorate([
    (0, common_1.Delete)('meetings/:id/cancel'),
    __param(0, (0, common_1.Param)('id')),
    __param(1, (0, current_user_id_decorator_1.CurrentUserId)()),
    __param(2, (0, current_user_role_decorator_1.CurrentUserRole)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [String, String, String]),
    __metadata("design:returntype", Promise)
], BookingController.prototype, "cancelMeeting", null);
__decorate([
    (0, common_1.Post)('availability'),
    __param(0, (0, common_1.Body)()),
    __param(1, (0, current_user_id_decorator_1.CurrentUserId)()),
    __param(2, (0, current_user_role_decorator_1.CurrentUserRole)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [booking_1.TherapistAvailabilityCreateDto, String, String]),
    __metadata("design:returntype", Promise)
], BookingController.prototype, "createAvailability", null);
__decorate([
    (0, common_1.Get)('availability'),
    __param(0, (0, current_user_id_decorator_1.CurrentUserId)()),
    __param(1, (0, current_user_role_decorator_1.CurrentUserRole)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [String, String]),
    __metadata("design:returntype", Promise)
], BookingController.prototype, "getAvailability", null);
__decorate([
    (0, common_1.Put)('availability/:id'),
    __param(0, (0, common_1.Param)('id')),
    __param(1, (0, common_1.Body)()),
    __param(2, (0, current_user_id_decorator_1.CurrentUserId)()),
    __param(3, (0, current_user_role_decorator_1.CurrentUserRole)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [String, booking_1.TherapistAvailabilityUpdateDto, String, String]),
    __metadata("design:returntype", Promise)
], BookingController.prototype, "updateAvailability", null);
__decorate([
    (0, common_1.Delete)('availability/:id'),
    __param(0, (0, common_1.Param)('id')),
    __param(1, (0, current_user_id_decorator_1.CurrentUserId)()),
    __param(2, (0, current_user_role_decorator_1.CurrentUserRole)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [String, String, String]),
    __metadata("design:returntype", Promise)
], BookingController.prototype, "deleteAvailability", null);
__decorate([
    (0, common_1.Get)('durations'),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", []),
    __metadata("design:returntype", void 0)
], BookingController.prototype, "getDurations", null);
__decorate([
    (0, common_1.Get)('slots'),
    __param(0, (0, common_1.Query)('therapistId')),
    __param(1, (0, common_1.Query)('date')),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [String, String]),
    __metadata("design:returntype", Promise)
], BookingController.prototype, "getAvailableSlots", null);
exports.BookingController = BookingController = __decorate([
    (0, common_1.Controller)('booking'),
    (0, common_1.UseGuards)(clerk_auth_guard_1.ClerkAuthGuard),
    __metadata("design:paramtypes", [booking_service_1.BookingService])
], BookingController);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL2Jvb2tpbmcvYm9va2luZy5jb250cm9sbGVyLnRzIiwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7OztBQUFBLDJDQVl3QjtBQUN4QixpRUFBNEQ7QUFDNUQsdUZBQXdFO0FBQ3hFLDJGQUE0RTtBQUM1RSx1REFBbUQ7QUFDbkQsa0RBSzhCO0FBSXZCLElBQU0saUJBQWlCLEdBQXZCLE1BQU0saUJBQWlCO0lBQ0M7SUFBN0IsWUFBNkIsY0FBOEI7UUFBOUIsbUJBQWMsR0FBZCxjQUFjLENBQWdCO0lBQUcsQ0FBQztJQUUvRCxvQkFBb0I7SUFFZCxBQUFOLEtBQUssQ0FBQyxhQUFhLENBQ1QsZ0JBQWtDLEVBQ3pCLE1BQWMsRUFDWixJQUFZO1FBRS9CLHFGQUFxRjtRQUNyRixJQUFJLElBQUksS0FBSyxRQUFRLEVBQUUsQ0FBQztZQUN0QixNQUFNLElBQUksMkJBQWtCLENBQUMsZ0NBQWdDLENBQUMsQ0FBQztRQUNqRSxDQUFDO1FBQ0QsT0FBTyxJQUFJLENBQUMsY0FBYyxDQUFDLGFBQWEsQ0FBQyxnQkFBZ0IsRUFBRSxNQUFNLENBQUMsQ0FBQztJQUNyRSxDQUFDO0lBR0ssQUFBTixLQUFLLENBQUMsV0FBVyxDQUNFLE1BQWMsRUFDWixJQUFZO1FBRS9CLE9BQU8sSUFBSSxDQUFDLGNBQWMsQ0FBQyxXQUFXLENBQUMsTUFBTSxFQUFFLElBQUksQ0FBQyxDQUFDO0lBQ3ZELENBQUM7SUFHSyxBQUFOLEtBQUssQ0FBQyxVQUFVLENBQ0QsRUFBVSxFQUNOLE1BQWMsRUFDWixJQUFZO1FBRS9CLE9BQU8sSUFBSSxDQUFDLGNBQWMsQ0FBQyxVQUFVLENBQUMsRUFBRSxFQUFFLE1BQU0sRUFBRSxJQUFJLENBQUMsQ0FBQztJQUMxRCxDQUFDO0lBR0ssQUFBTixLQUFLLENBQUMsYUFBYSxDQUNKLEVBQVUsRUFDZixnQkFBa0MsRUFDekIsTUFBYyxFQUNaLElBQVk7UUFFL0IsT0FBTyxJ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QSx5Q0FBYSxHQUFFLENBQUE7SUFDZixXQUFBLElBQUEsNkNBQWUsR0FBRSxDQUFBOzs7OzJEQVFuQjtBQUlEO0lBREMsSUFBQSxZQUFHLEVBQUMsV0FBVyxDQUFDOzs7O3FEQUdoQjtBQUlLO0lBREwsSUFBQSxZQUFHLEVBQUMsT0FBTyxDQUFDO0lBRVYsV0FBQSxJQUFBLGNBQUssRUFBQyxhQUFhLENBQUMsQ0FBQTtJQUNwQixXQUFBLElBQUEsY0FBSyxFQUFDLE1BQU0sQ0FBQyxDQUFBOzs7OzBEQUdmOzRCQXZJVSxpQkFBaUI7SUFGN0IsSUFBQSxtQkFBVSxFQUFDLFNBQVMsQ0FBQztJQUNyQixJQUFBLGtCQUFTLEVBQUMsaUNBQWMsQ0FBQztxQ0FFcUIsZ0NBQWM7R0FEaEQsaUJBQWlCLENBd0k3QiIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvaG9tZS93ZXRvb2EvRG9jdW1lbnRzL2NvZGUvcHJvamVjdHMvbWVudGFyYS9tZW50YXJhLWFwaS9zcmMvYm9va2luZy9ib29raW5nLmNvbnRyb2xsZXIudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgQm9keSxcbiAgQ29udHJvbGxlcixcbiAgRGVsZXRlLFxuICBHZXQsXG4gIFBhcmFtLFxuICBQb3N0LFxuICBQdXQsXG4gIFF1ZXJ5LFxuICBVc2VHdWFyZHMsXG4gIFVuYXV0aG9yaXplZEV4Y2VwdGlvbixcbiAgRm9yYmlkZGVuRXhjZXB0aW9uLFxufSBmcm9tICdAbmVzdGpzL2NvbW1vbic7XG5pbXBvcnQgeyBDbGVya0F1dGhHdWFyZCB9IGZyb20gJy4uL2d1YXJkcy9jbGVyay1hdXRoLmd1YXJkJztcbmltcG9ydCB7IEN1cnJlbnRVc2VySWQgfSBmcm9tICcuLi9kZWNvcmF0b3JzL2N1cnJlbnQtdXNlci1pZC5kZWNvcmF0b3InO1xuaW1wb3J0IHsgQ3VycmVudFVzZXJSb2xlIH0gZnJvbSAnLi4vZGVjb3JhdG9ycy9jdXJyZW50LXVzZXItcm9sZS5kZWNvcmF0b3InO1xuaW1wb3J0IHsgQm9va2luZ1NlcnZpY2UgfSBmcm9tICcuL2Jvb2tpbmcuc2VydmljZSc7XG5pbXBvcnQge1xuICBUaGVyYXBpc3RBdmFpbGFiaWxpdHlDcmVhdGVEdG8sXG4gIFRoZXJhcGlzdEF2YWlsYWJpbGl0eVVwZGF0ZUR0byxcbiAgTWVldGluZ0NyZWF0ZUR0byxcbiAgTWVldGluZ1VwZGF0ZUR0byxcbn0gZnJvbSAnLi4vLi4vc2NoZW1hL2Jvb2tpbmcnO1xuXG5AQ29udHJvbGxlcignYm9va2luZycpXG5AVXNlR3VhcmRzKENsZXJrQXV0aEd1YXJkKVxuZXhwb3J0IGNsYXNzIEJvb2tpbmdDb250cm9sbGVyIHtcbiAgY29uc3RydWN0b3IocHJpdmF0ZSByZWFkb25seSBib29raW5nU2VydmljZTogQm9va2luZ1NlcnZpY2UpIHt9XG5cbiAgLy8gTWVldGluZyBlbmRwb2ludHNcbiAgQFBvc3QoJ21lZXRpbmdzJylcbiAgYXN5bmMgY3JlYXRlTWVldGluZyhcbiAgICBAQm9keSgpIGNyZWF0ZU1lZXRpbmdEdG86IE1lZXRpbmdDcmVhdGVEdG8sXG4gICAgQEN1cnJlbnRVc2VySWQoKSB1c2VySWQ6IHN0cmluZyxcbiAgICBAQ3VycmVudFVzZXJSb2xlKCkgcm9sZTogc3RyaW5nLFxuICApIHtcbiAgICAvLyBPbmx5IGNsaWVudHMgY2FuIGJvb2sgbWVldGluZ3MsIGJ1dCB3ZSdsbCB2YWxpZGF0ZSB0aGUgcmVsYXRpb25zaGlwIGluIHRoZSBzZXJ2aWNlXG4gICAgaWYgKHJvbGUgIT09ICdjbGllbnQnKSB7XG4gICAgICB0aHJvdyBuZXcgRm9yYmlkZGVuRXhjZXB0aW9uKCdPbmx5IGNsaWVudHMgY2FuIGJvb2sgbWVldGluZ3MnKTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuYm9va2luZ1NlcnZpY2UuY3JlYXRlTWVldGluZyhjcmVhdGVNZWV0aW5nRHRvLCB1c2VySWQpO1xuICB9XG5cbiAgQEdldCgnbWVldGluZ3MnKVxuICBhc3luYyBnZXRNZWV0aW5ncyhcbiAgICBAQ3VycmVudFVzZXJJZCgpIHVzZXJJZDogc3RyaW5nLFxuICAgIEBDdXJyZW50VXNlclJvbGUoKSByb2xlOiBzdHJpbmcsXG4gICkge1xuICAgIHJldHVybiB0aGlzLmJvb2tpbmdTZXJ2aWNlLmdldE1lZXRpbmdzKHVzZXJJZCwgcm9sZSk7XG4gIH1cblxuICBAR2V0KCdtZWV0aW5ncy86aWQnKVxuICBhc3luYyBnZXRNZWV0aW5nKFxuICAgIEBQYXJhbSgnaWQnKSBpZDogc3RyaW5nLFxuICAgIEBDdXJyZW50VXNlcklkKCkgdXNlcklkOiBzdHJpbmcsXG4gICAgQEN1cnJlbnRVc2VyUm9sZSgpIHJvbGU6IHN0cmluZyxcbiAgKSB7XG4gICAgcmV0dXJuIHRoaXMuYm9va2luZ1NlcnZpY2UuZ2V0TWVldGluZyhpZCwgdXNlcklkLCByb2xlKTtcbiAgfVxuXG4gIEBQdXQoJ21lZXRpbmdzLzppZCcpXG4gIGFzeW5jIHVwZGF0ZU1lZXRpbmcoXG4gICAgQFBhcmFtKCdpZCcpIGlkOiBzdHJpbmcsXG4gICAgQEJvZHkoKSB1cGRhdGVNZWV0aW5nRHRvOiBNZWV0aW5nVXBkYXRlRHRvLFxuICAgIEBDdXJyZW50VXNlcklkKCkgdXNlcklkOiBzdHJpbmcsXG4gICAgQEN1cnJlbnRVc2VyUm9sZSgpIHJvbGU6IHN0cmluZyxcbiAgKSB7XG4gICAgcmV0dXJuIHRoaXMuYm9va2luZ1NlcnZpY2UudXBkYXRlTWVldGluZyhcbiAgICAgIGlkLFxuICAgICAgdXBkYXRlTWVldGluZ0R0byxcbiAgICAgIHVzZXJJZCxcbiAgICAgIHJvbGUsXG4gICAgKTtcbiAgfVxuXG4gIEBEZWxldGUoJ21lZXRpbmdzLzppZC9jYW5jZWwnKVxuICBhc3luYyBjYW5jZWxNZWV0aW5nKFxuICAgIEBQYXJhbSgnaWQnKSBpZDogc3RyaW5nLFxuICAgIEBDdXJyZW50VXNlcklkKCkgdXNlcklkOiBzdHJpbmcsXG4gICAgQEN1cnJlbnRVc2VyUm9sZSgpIHJvbGU6IHN0cmluZyxcbiAgKSB7XG4gICAgcmV0dXJuIHRoaXMuYm9va2luZ1NlcnZpY2UuY2FuY2VsTWVldGluZyhpZCwgdXNlcklkLCByb2xlKTtcbiAgfVxuXG4gIC8vIEF2YWlsYWJpbGl0eSBlbmRwb2ludHMgKHRoZXJhcGlzdCBvbmx5KVxuICBAUG9zdCgnYXZhaWxhYmlsaXR5JylcbiAgYXN5bmMgY3JlYXRlQXZhaWxhYmlsaXR5KFxuICAgIEBCb2R5KCkgY3JlYXRlQXZhaWxhYmlsaXR5RHRvOiBUaGVyYXBpc3RBdmFpbGFiaWxpdHlDcmVhdGVEdG8sXG4gICAgQEN1cnJlbnRVc2VySWQoKSB0aGVyYXBpc3RJZDogc3RyaW5nLFxuICAgIEBDdXJyZW50VXNlclJvbGUoKSByb2xlOiBzdHJpbmcsXG4gICkge1xuICAgIGlmIChyb2xlICE9PSAndGhlcmFwaXN0Jykge1xuICAgICAgdGhyb3cgbmV3IFVuYXV0aG9yaXplZEV4Y2VwdGlvbihcbiAgICAgICAgJ09ubHkgdGhlcmFwaXN0cyBjYW4gbWFuYWdlIGF2YWlsYWJpbGl0eScsXG4gICAgICApO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy5ib29raW5nU2VydmljZS5jcmVhdGVBdmFpbGFiaWxpdHkoXG4gICAgICBjcmVhdGVBdmFpbGFiaWxpdHlEdG8sXG4gICAgICB0aGVyYXBpc3RJZCxcbiAgICApO1xuICB9XG5cbiAgQEdldCgnYXZhaWxhYmlsaXR5JylcbiAgYXN5bmMgZ2V0QXZhaWxhYmlsaXR5KFxuICAgIEBDdXJyZW50VXNlcklkKCkgdGhlcmFwaXN0SWQ6IHN0cmluZyxcbiAgICBAQ3VycmVudFVzZXJSb2xlKCkgcm9sZTogc3RyaW5nLFxuICApIHtcbiAgICBpZiAocm9sZSAhPT0gJ3RoZXJhcGlzdCcpIHtcbiAgICAgIHRocm93IG5ldyBVbmF1dGhvcml6ZWRFeGNlcHRpb24oXG4gICAgICAgICdPbmx5IHRoZXJhcGlzdHMgY2FuIHZpZXcgdGhlaXIgYXZhaWxhYmlsaXR5JyxcbiAgICAgICk7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLmJvb2tpbmdTZXJ2aWNlLmdldEF2YWlsYWJpbGl0eSh0aGVyYXBpc3RJZCk7XG4gIH1cblxuICBAUHV0KCdhdmFpbGFiaWxpdHkvOmlkJylcbiAgYXN5bmMgdXBkYXRlQXZhaWxhYmlsaXR5KFxuICAgIEBQYXJhbSgnaWQnKSBpZDogc3RyaW5nLFxuICAgIEBCb2R5KCkgdXBkYXRlQXZhaWxhYmlsaXR5RHRvOiBUaGVyYXBpc3RBdmFpbGFiaWxpdHlVcGRhdGVEdG8sXG4gICAgQEN1cnJlbnRVc2VySWQoKSB0aGVyYXBpc3RJZDogc3RyaW5nLFxuICAgIEBDdXJyZW50VXNlclJvbGUoKSByb2xlOiBzdHJpbmcsXG4gICkge1xuICAgIGlmIChyb2xlICE9PSAndGhlcmFwaXN0Jykge1xuICAgICAgdGhyb3cgbmV3IFVuYXV0aG9yaXplZEV4Y2VwdGlvbihcbiAgICAgICAgJ09ubHkgdGhlcmFwaXN0cyBjYW4gdXBkYXRlIGF2YWlsYWJpbGl0eScsXG4gICAgICApO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy5ib29raW5nU2VydmljZS51cGRhdGVBdmFpbGFiaWxpdHkoXG4gICAgICBpZCxcbiAgICAgIHVwZGF0ZUF2YWlsYWJpbGl0eUR0byxcbiAgICAgIHRoZXJhcGlzdElkLFxuICAgICk7XG4gIH1cblxuICBARGVsZXRlKCdhdmFpbGFiaWxpdHkvOmlkJylcbiAgYXN5bmMgZGVsZXRlQXZhaWxhYmlsaXR5KFxuICAgIEBQYXJhbSgnaWQnKSBpZDogc3RyaW5nLFxuICAgIEBDdXJyZW50VXNlcklkKCkgdGhlcmFwaXN0SWQ6IHN0cmluZyxcbiAgICBAQ3VycmVudFVzZXJSb2xlKCkgcm9sZTogc3RyaW5nLFxuICApIHtcbiAgICBpZiAocm9sZSAhPT0gJ3RoZXJhcGlzdCcpIHtcbiAgICAgIHRocm93IG5ldyBVbmF1dGhvcml6ZWRFeGNlcHRpb24oXG4gICAgICAgICdPbmx5IHRoZXJhcGlzdHMgY2FuIGRlbGV0ZSBhdmFpbGFiaWxpdHknLFxuICAgICAgKTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuYm9va2luZ1NlcnZpY2UuZGVsZXRlQXZhaWxhYmlsaXR5KGlkLCB0aGVyYXBpc3RJZCk7XG4gIH1cblxuICAvLyBEdXJhdGlvbiBlbmRwb2ludHMgKHB1YmxpYylcbiAgQEdldCgnZHVyYXRpb25zJylcbiAgZ2V0RHVyYXRpb25zKCkge1xuICAgIHJldHVybiB0aGlzLmJvb2tpbmdTZXJ2aWNlLmdldER1cmF0aW9ucygpO1xuICB9XG5cbiAgLy8gQXZhaWxhYmxlIHNsb3RzIGVuZHBvaW50XG4gIEBHZXQoJ3Nsb3RzJylcbiAgYXN5bmMgZ2V0QXZhaWxhYmxlU2xvdHMoXG4gICAgQFF1ZXJ5KCd0aGVyYXBpc3RJZCcpIHRoZXJhcGlzdElkOiBzdHJpbmcsXG4gICAgQFF1ZXJ5KCdkYXRlJykgZGF0ZTogc3RyaW5nLFxuICApIHtcbiAgICByZXR1cm4gdGhpcy5ib29raW5nU2VydmljZS5nZXRBdmFpbGFibGVTbG90cyh0aGVyYXBpc3RJZCwgZGF0ZSk7XG4gIH1cbn1cbiJdLCJ2ZXJzaW9uIjozfQ==