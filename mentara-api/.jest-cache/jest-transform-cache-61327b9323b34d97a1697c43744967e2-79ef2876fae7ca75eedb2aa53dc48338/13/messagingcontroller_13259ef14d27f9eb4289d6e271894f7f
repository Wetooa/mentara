6c7a4da003251436823906f1002db7c8
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var __param = (this && this.__param) || function (paramIndex, decorator) {
    return function (target, key) { decorator(target, key, paramIndex); }
};
var _a, _b;
Object.defineProperty(exports, "__esModule", { value: true });
exports.MessagingController = void 0;
const common_1 = require("@nestjs/common");
const platform_express_1 = require("@nestjs/platform-express");
const messaging_service_1 = require("./messaging.service");
const jwt_auth_guard_1 = require("../auth/guards/jwt-auth.guard");
const current_user_id_decorator_1 = require("../auth/decorators/current-user-id.decorator");
const supabase_storage_service_1 = require("../common/services/supabase-storage.service");
let MessagingController = class MessagingController {
    messagingService;
    supabaseStorageService;
    constructor(messagingService, supabaseStorageService) {
        this.messagingService = messagingService;
        this.supabaseStorageService = supabaseStorageService;
    }
    // Conversation endpoints
    async createConversation(userId, createConversationDto) {
        return this.messagingService.createConversation(userId, createConversationDto);
    }
    async getUserConversations(userId, params) {
        console.log('ðŸš€ [MESSAGING CONTROLLER] getUserConversations endpoint called');
        console.log('ðŸ‘¤ [USER ID]', userId);
        console.log('ðŸ“Š [QUERY PARAMS]', params);
        try {
            const result = await this.messagingService.getUserConversations(userId, params.page || 1, params.limit || 20);
            console.log('âœ… [CONTROLLER RESPONSE] Returning', result.length, 'conversations');
            console.log('ðŸ“ [RESPONSE SUMMARY]:', result.map((conv) => ({
                id: conv.id,
                type: conv.type,
                title: conv.title,
                participantCount: conv.participants?.length || 0,
                messageCount: conv.messages?.length || 0,
            })));
            return result;
        }
        catch (error) {
            console.error('âŒ [CONTROLLER ERROR] getUserConversations failed:', error);
            throw error;
        }
    }
    async getRecentCommunications(userId, limit) {
        console.log('ðŸ“ž [MESSAGING CONTROLLER] getRecentCommunications endpoint called');
        console.log('ðŸ‘¤ [USER ID]', userId);
        console.log('ðŸ“Š [LIMIT]', limit);
        try {
            const limitNum = limit ? Number(limit) : 5;
            const result = await this.messagingService.getRecentCommunications(userId, limitNum);
            console.log('âœ… [CONTROLLER RESPONSE] Returning', result.length, 'recent communications');
            console.log('ðŸ“± [RESPONSE SUMMARY]:', result.map(comm => ({
                id: comm?.id,
                name: comm?.name,
                role: comm?.role,
                hasLastMessage: !!comm?.lastMessage,
                unreadCount: comm?.unreadCount
            })));
            return result;
        }
        catch (error) {
            console.error('âŒ [CONTROLLER ERROR] getRecentCommunications failed:', error);
            throw error;
        }
    }
    async getConversationMessages(userId, conversationId, params) {
        const pageNum = params.page || 1;
        const limitNum = params.limit || 50;
        return this.messagingService.getConversationMessages(userId, conversationId, pageNum, limitNum);
    }
    // Message endpoints
    async sendMessage(userId, conversationId, sendMessageDto, files = []) {
        // Validate and upload files if provided
        const fileResults = [];
        if (files && files.length > 0) {
            for (const file of files) {
                const validation = this.supabaseStorageService.validateFile(file);
                if (!validation.isValid) {
                    throw new common_1.HttpException(`File validation failed: ${validation.error}`, common_1.HttpStatus.BAD_REQUEST);
                }
            }
            // Upload files to Supabase
            const uploadResults = await this.supabaseStorageService.uploadFiles(files, supabase_storage_service_1.SupabaseStorageService.getSupportedBuckets().MESSAGES);
            fileResults.push(...uploadResults);
        }
        return this.messagingService.sendMessage(userId, conversationId, sendMessageDto, fileResults.map((f) => f.url), fileResults.map((f) => f.filename), files.map((f) => f.size));
    }
    async updateMessage(userId, messageId, updateMessageDto) {
        return this.messagingService.updateMessage(userId, messageId, updateMessageDto);
    }
    async deleteMessage(userId, messageId) {
        return this.messagingService.deleteMessage(userId, messageId);
    }
    // Read receipts
    async markMessageAsRead(userId, messageId) {
        return this.messagingService.markMessageAsRead(userId, messageId);
    }
    // Message reactions
    async addMessageReaction(userId, messageId, addReactionDto) {
        return this.messagingService.addMessageReaction(userId, messageId, addReactionDto.emoji);
    }
    async removeMessageReaction(userId, messageId, emoji) {
        return this.messagingService.removeMessageReaction(userId, messageId, emoji);
    }
    // User blocking
    async blockUser(userId, blockUserDto) {
        return this.messagingService.blockUser(userId, blockUserDto.userId, blockUserDto.reason);
    }
    async unblockUser(userId, blockedUserId) {
        return this.messagingService.unblockUser(userId, blockedUserId);
    }
    // Search messages
    async searchMessages(userId, searchDto) {
        const { query, conversationId, page, limit } = searchDto;
        const pageNum = page ? Number(page) : 1;
        const limitNum = limit ? Number(limit) : 20;
        return this.messagingService.searchMessages(userId, query || '', conversationId, pageNum, limitNum);
    }
};
exports.MessagingController = MessagingController;
__decorate([
    (0, common_1.Post)('conversations'),
    (0, common_1.HttpCode)(common_1.HttpStatus.CREATED),
    __param(0, (0, current_user_id_decorator_1.CurrentUserId)()),
    __param(1, (0, common_1.Body)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [String, Object]),
    __metadata("design:returntype", Promise)
], MessagingController.prototype, "createConversation", null);
__decorate([
    (0, common_1.Get)('conversations'),
    __param(0, (0, current_user_id_decorator_1.CurrentUserId)()),
    __param(1, (0, common_1.Query)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [String, Object]),
    __metadata("design:returntype", Promise)
], MessagingController.prototype, "getUserConversations", null);
__decorate([
    (0, common_1.Get)('recent-communications'),
    __param(0, (0, current_user_id_decorator_1.CurrentUserId)()),
    __param(1, (0, common_1.Query)('limit')),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [String, String]),
    __metadata("design:returntype", Promise)
], MessagingController.prototype, "getRecentCommunications", null);
__decorate([
    (0, common_1.Get)('conversations/:conversationId/messages'),
    __param(0, (0, current_user_id_decorator_1.CurrentUserId)()),
    __param(1, (0, common_1.Param)('conversationId')),
    __param(2, (0, common_1.Query)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [String, String, Object]),
    __metadata("design:returntype", Promise)
], MessagingController.prototype, "getConversationMessages", null);
__decorate([
    (0, common_1.Post)('conversations/:conversationId/messages'),
    (0, common_1.UseInterceptors)((0, platform_express_1.FilesInterceptor)('files', 3)) // Support up to 3 files
    ,
    (0, common_1.HttpCode)(common_1.HttpStatus.CREATED),
    __param(0, (0, current_user_id_decorator_1.CurrentUserId)()),
    __param(1, (0, common_1.Param)('conversationId')),
    __param(2, (0, common_1.Body)()),
    __param(3, (0, common_1.UploadedFiles)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [String, String, Object, Array]),
    __metadata("design:returntype", Promise)
], MessagingController.prototype, "sendMessage", null);
__decorate([
    (0, common_1.Put)('messages/:messageId'),
    __param(0, (0, current_user_id_decorator_1.CurrentUserId)()),
    __param(1, (0, common_1.Param)('messageId')),
    __param(2, (0, common_1.Body)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [String, String, Object]),
    __metadata("design:returntype", Promise)
], MessagingController.prototype, "updateMessage", null);
__decorate([
    (0, common_1.Delete)('messages/:messageId'),
    (0, common_1.HttpCode)(common_1.HttpStatus.NO_CONTENT),
    __param(0, (0, current_user_id_decorator_1.CurrentUserId)()),
    __param(1, (0, common_1.Param)('messageId')),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [String, String]),
    __metadata("design:returntype", Promise)
], MessagingController.prototype, "deleteMessage", null);
__decorate([
    (0, common_1.Post)('messages/:messageId/read'),
    (0, common_1.HttpCode)(common_1.HttpStatus.OK),
    __param(0, (0, current_user_id_decorator_1.CurrentUserId)()),
    __param(1, (0, common_1.Param)('messageId')),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [String, String]),
    __metadata("design:returntype", Promise)
], MessagingController.prototype, "markMessageAsRead", null);
__decorate([
    (0, common_1.Post)('messages/:messageId/reactions'),
    (0, common_1.HttpCode)(common_1.HttpStatus.CREATED),
    __param(0, (0, current_user_id_decorator_1.CurrentUserId)()),
    __param(1, (0, common_1.Param)('messageId')),
    __param(2, (0, common_1.Body)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [String, String, Object]),
    __metadata("design:returntype", Promise)
], MessagingController.prototype, "addMessageReaction", null);
__decorate([
    (0, common_1.Delete)('messages/:messageId/reactions/:emoji'),
    (0, common_1.HttpCode)(common_1.HttpStatus.NO_CONTENT),
    __param(0, (0, current_user_id_decorator_1.CurrentUserId)()),
    __param(1, (0, common_1.Param)('messageId')),
    __param(2, (0, common_1.Param)('emoji')),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [String, String, String]),
    __metadata("design:returntype", Promise)
], MessagingController.prototype, "removeMessageReaction", null);
__decorate([
    (0, common_1.Post)('block'),
    (0, common_1.HttpCode)(common_1.HttpStatus.CREATED),
    __param(0, (0, current_user_id_decorator_1.CurrentUserId)()),
    __param(1, (0, common_1.Body)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [String, Object]),
    __metadata("design:returntype", Promise)
], MessagingController.prototype, "blockUser", null);
__decorate([
    (0, common_1.Delete)('block/:blockedUserId'),
    (0, common_1.HttpCode)(common_1.HttpStatus.NO_CONTENT),
    __param(0, (0, current_user_id_decorator_1.CurrentUserId)()),
    __param(1, (0, common_1.Param)('blockedUserId')),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [String, String]),
    __metadata("design:returntype", Promise)
], MessagingController.prototype, "unblockUser", null);
__decorate([
    (0, common_1.Get)('search'),
    __param(0, (0, current_user_id_decorator_1.CurrentUserId)()),
    __param(1, (0, common_1.Query)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [String, Object]),
    __metadata("design:returntype", Promise)
], MessagingController.prototype, "searchMessages", null);
exports.MessagingController = MessagingController = __decorate([
    (0, common_1.Controller)('messaging'),
    (0, common_1.UseGuards)(jwt_auth_guard_1.JwtAuthGuard),
    __metadata("design:paramtypes", [typeof (_a = typeof messaging_service_1.MessagingService !== "undefined" && messaging_service_1.MessagingService) === "function" ? _a : Object, typeof (_b = typeof supabase_storage_service_1.SupabaseStorageService !== "undefined" && supabase_storage_service_1.SupabaseStorageService) === "function" ? _b : Object])
], MessagingController);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL21lc3NhZ2luZy9tZXNzYWdpbmcuY29udHJvbGxlci50cyIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsMkNBZXdCO0FBQ3hCLCtEQUE0RDtBQUM1RCwyREFBdUQ7QUFDdkQsa0VBQTZEO0FBQzdELDRGQUE2RTtBQUM3RSwwRkFHcUQ7QUFhOUMsSUFBTSxtQkFBbUIsR0FBekIsTUFBTSxtQkFBbUI7SUFFWDtJQUNBO0lBRm5CLFlBQ21CLGdCQUFrQyxFQUNsQyxzQkFBOEM7UUFEOUMscUJBQWdCLEdBQWhCLGdCQUFnQixDQUFrQjtRQUNsQywyQkFBc0IsR0FBdEIsc0JBQXNCLENBQXdCO0lBQzlELENBQUM7SUFFSix5QkFBeUI7SUFHbkIsQUFBTixLQUFLLENBQUMsa0JBQWtCLENBQ0wsTUFBYyxFQUN2QixxQkFBNEM7UUFFcEQsT0FBTyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsa0JBQWtCLENBQzdDLE1BQU0sRUFDTixxQkFBcUIsQ0FDdEIsQ0FBQztJQUNKLENBQUM7SUFHSyxBQUFOLEtBQUssQ0FBQyxvQkFBb0IsQ0FDUCxNQUFjLEVBQ3RCLE1BQThCO1FBRXZDLE9BQU8sQ0FBQyxHQUFHLENBQ1QsZ0VBQWdFLENBQ2pFLENBQUM7UUFDRixPQUFPLENBQUMsR0FBRyxDQUFDLGNBQWMsRUFBRSxNQUFNLENBQUMsQ0FBQztRQUNwQyxPQUFPLENBQUMsR0FBRyxDQUFDLG1CQUFtQixFQUFFLE1BQU0sQ0FBQyxDQUFDO1FBRXpDLElBQUksQ0FBQztZQUNILE1BQU0sTUFBTSxHQUFHLE1BQU0sSUFBSSxDQUFDLGdCQUFnQixDQUFDLG9CQUFvQixDQUM3RCxNQUFNLEVBQ04sTUFBTSxDQUFDLElBQUksSUFBSSxDQUFDLEVBQ2hCLE1BQU0sQ0FBQyxLQUFLLElBQUksRUFBRSxDQUNuQixDQUFDO1lBRUYsT0FBTyxDQUFDLEdBQUcsQ0FDVCxtQ0FBbUMsRUFDbkMsTUFB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R0FIdEQsbUJBQW1CLENBNlAvQiIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvaG9tZS93ZXRvb2EvRG9jdW1lbnRzL2NvZGUvcHJvamVjdHMvbWVudGFyYS9tZW50YXJhLWFwaS9zcmMvbWVzc2FnaW5nL21lc3NhZ2luZy5jb250cm9sbGVyLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIENvbnRyb2xsZXIsXG4gIEdldCxcbiAgUG9zdCxcbiAgUHV0LFxuICBEZWxldGUsXG4gIFBhcmFtLFxuICBRdWVyeSxcbiAgQm9keSxcbiAgVXNlR3VhcmRzLFxuICBVc2VJbnRlcmNlcHRvcnMsXG4gIFVwbG9hZGVkRmlsZXMsXG4gIEh0dHBDb2RlLFxuICBIdHRwU3RhdHVzLFxuICBIdHRwRXhjZXB0aW9uLFxufSBmcm9tICdAbmVzdGpzL2NvbW1vbic7XG5pbXBvcnQgeyBGaWxlc0ludGVyY2VwdG9yIH0gZnJvbSAnQG5lc3Rqcy9wbGF0Zm9ybS1leHByZXNzJztcbmltcG9ydCB7IE1lc3NhZ2luZ1NlcnZpY2UgfSBmcm9tICcuL21lc3NhZ2luZy5zZXJ2aWNlJztcbmltcG9ydCB7IEp3dEF1dGhHdWFyZCB9IGZyb20gJy4uL2F1dGgvZ3VhcmRzL2p3dC1hdXRoLmd1YXJkJztcbmltcG9ydCB7IEN1cnJlbnRVc2VySWQgfSBmcm9tICcuLi9hdXRoL2RlY29yYXRvcnMvY3VycmVudC11c2VyLWlkLmRlY29yYXRvcic7XG5pbXBvcnQge1xuICBTdXBhYmFzZVN0b3JhZ2VTZXJ2aWNlLFxuICBGaWxlVXBsb2FkUmVzdWx0LFxufSBmcm9tICcuLi9jb21tb24vc2VydmljZXMvc3VwYWJhc2Utc3RvcmFnZS5zZXJ2aWNlJztcbmltcG9ydCB0eXBlIHtcbiAgQ3JlYXRlQ29udmVyc2F0aW9uRHRvLFxuICBTZW5kTWVzc2FnZUR0byxcbiAgVXBkYXRlTWVzc2FnZUR0byxcbiAgQWRkUmVhY3Rpb25EdG8sXG4gIEJsb2NrVXNlckR0byxcbiAgU2VhcmNoTWVzc2FnZXNEdG8sXG4gIENvbnZlcnNhdGlvbkxpc3RQYXJhbXMsXG59IGZyb20gJy4vdHlwZXMnO1xuXG5AQ29udHJvbGxlcignbWVzc2FnaW5nJylcbkBVc2VHdWFyZHMoSnd0QXV0aEd1YXJkKVxuZXhwb3J0IGNsYXNzIE1lc3NhZ2luZ0NvbnRyb2xsZXIge1xuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHJlYWRvbmx5IG1lc3NhZ2luZ1NlcnZpY2U6IE1lc3NhZ2luZ1NlcnZpY2UsXG4gICAgcHJpdmF0ZSByZWFkb25seSBzdXBhYmFzZVN0b3JhZ2VTZXJ2aWNlOiBTdXBhYmFzZVN0b3JhZ2VTZXJ2aWNlLFxuICApIHt9XG5cbiAgLy8gQ29udmVyc2F0aW9uIGVuZHBvaW50c1xuICBAUG9zdCgnY29udmVyc2F0aW9ucycpXG4gIEBIdHRwQ29kZShIdHRwU3RhdHVzLkNSRUFURUQpXG4gIGFzeW5jIGNyZWF0ZUNvbnZlcnNhdGlvbihcbiAgICBAQ3VycmVudFVzZXJJZCgpIHVzZXJJZDogc3RyaW5nLFxuICAgIEBCb2R5KCkgY3JlYXRlQ29udmVyc2F0aW9uRHRvOiBDcmVhdGVDb252ZXJzYXRpb25EdG8sXG4gICkge1xuICAgIHJldHVybiB0aGlzLm1lc3NhZ2luZ1NlcnZpY2UuY3JlYXRlQ29udmVyc2F0aW9uKFxuICAgICAgdXNlcklkLFxuICAgICAgY3JlYXRlQ29udmVyc2F0aW9uRHRvLFxuICAgICk7XG4gIH1cblxuICBAR2V0KCdjb252ZXJzYXRpb25zJylcbiAgYXN5bmMgZ2V0VXNlckNvbnZlcnNhdGlvbnMoXG4gICAgQEN1cnJlbnRVc2VySWQoKSB1c2VySWQ6IHN0cmluZyxcbiAgICBAUXVlcnkoKSBwYXJhbXM6IENvbnZlcnNhdGlvbkxpc3RQYXJhbXMsXG4gICkge1xuICAgIGNvbnNvbGUubG9nKFxuICAgICAgJ/CfmoAgW01FU1NBR0lORyBDT05UUk9MTEVSXSBnZXRVc2VyQ29udmVyc2F0aW9ucyBlbmRwb2ludCBjYWxsZWQnLFxuICAgICk7XG4gICAgY29uc29sZS5sb2coJ/CfkaQgW1VTRVIgSURdJywgdXNlcklkKTtcbiAgICBjb25zb2xlLmxvZygn8J+TiiBbUVVFUlkgUEFSQU1TXScsIHBhcmFtcyk7XG5cbiAgICB0cnkge1xuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgdGhpcy5tZXNzYWdpbmdTZXJ2aWNlLmdldFVzZXJDb252ZXJzYXRpb25zKFxuICAgICAgICB1c2VySWQsXG4gICAgICAgIHBhcmFtcy5wYWdlIHx8IDEsXG4gICAgICAgIHBhcmFtcy5saW1pdCB8fCAyMCxcbiAgICAgICk7XG5cbiAgICAgIGNvbnNvbGUubG9nKFxuICAgICAgICAn4pyFIFtDT05UUk9MTEVSIFJFU1BPTlNFXSBSZXR1cm5pbmcnLFxuICAgICAgICByZXN1bHQubGVuZ3RoLFxuICAgICAgICAnY29udmVyc2F0aW9ucycsXG4gICAgICApO1xuICAgICAgY29uc29sZS5sb2coXG4gICAgICAgICfwn5OdIFtSRVNQT05TRSBTVU1NQVJZXTonLFxuICAgICAgICByZXN1bHQubWFwKChjb252KSA9PiAoe1xuICAgICAgICAgIGlkOiBjb252LmlkLFxuICAgICAgICAgIHR5cGU6IGNvbnYudHlwZSxcbiAgICAgICAgICB0aXRsZTogY29udi50aXRsZSxcbiAgICAgICAgICBwYXJ0aWNpcGFudENvdW50OiBjb252LnBhcnRpY2lwYW50cz8ubGVuZ3RoIHx8IDAsXG4gICAgICAgICAgbWVzc2FnZUNvdW50OiBjb252Lm1lc3NhZ2VzPy5sZW5ndGggfHwgMCxcbiAgICAgICAgfSkpLFxuICAgICAgKTtcblxuICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc29sZS5lcnJvcihcbiAgICAgICAgJ+KdjCBbQ09OVFJPTExFUiBFUlJPUl0gZ2V0VXNlckNvbnZlcnNhdGlvbnMgZmFpbGVkOicsXG4gICAgICAgIGVycm9yLFxuICAgICAgKTtcbiAgICAgIHRocm93IGVycm9yO1xuICAgIH1cbiAgfVxuXG4gIEBHZXQoJ3JlY2VudC1jb21tdW5pY2F0aW9ucycpXG4gIGFzeW5jIGdldFJlY2VudENvbW11bmljYXRpb25zKFxuICAgIEBDdXJyZW50VXNlcklkKCkgdXNlcklkOiBzdHJpbmcsXG4gICAgQFF1ZXJ5KCdsaW1pdCcpIGxpbWl0Pzogc3RyaW5nLFxuICApIHtcbiAgICBjb25zb2xlLmxvZygn8J+TniBbTUVTU0FHSU5HIENPTlRST0xMRVJdIGdldFJlY2VudENvbW11bmljYXRpb25zIGVuZHBvaW50IGNhbGxlZCcpO1xuICAgIGNvbnNvbGUubG9nKCfwn5GkIFtVU0VSIElEXScsIHVzZXJJZCk7XG4gICAgY29uc29sZS5sb2coJ/Cfk4ogW0xJTUlUXScsIGxpbWl0KTtcbiAgICBcbiAgICB0cnkge1xuICAgICAgY29uc3QgbGltaXROdW0gPSBsaW1pdCA/IE51bWJlcihsaW1pdCkgOiA1O1xuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgdGhpcy5tZXNzYWdpbmdTZXJ2aWNlLmdldFJlY2VudENvbW11bmljYXRpb25zKFxuICAgICAgICB1c2VySWQsXG4gICAgICAgIGxpbWl0TnVtLFxuICAgICAgKTtcbiAgICAgIFxuICAgICAgY29uc29sZS5sb2coJ+KchSBbQ09OVFJPTExFUiBSRVNQT05TRV0gUmV0dXJuaW5nJywgcmVzdWx0Lmxlbmd0aCwgJ3JlY2VudCBjb21tdW5pY2F0aW9ucycpO1xuICAgICAgY29uc29sZS5sb2coJ/Cfk7EgW1JFU1BPTlNFIFNVTU1BUlldOicsIHJlc3VsdC5tYXAoY29tbSA9PiAoe1xuICAgICAgICBpZDogY29tbT8uaWQsXG4gICAgICAgIG5hbWU6IGNvbW0/Lm5hbWUsXG4gICAgICAgIHJvbGU6IGNvbW0/LnJvbGUsXG4gICAgICAgIGhhc0xhc3RNZXNzYWdlOiAhIWNvbW0/Lmxhc3RNZXNzYWdlLFxuICAgICAgICB1bnJlYWRDb3VudDogY29tbT8udW5yZWFkQ291bnRcbiAgICAgIH0pKSk7XG4gICAgICBcbiAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ+KdjCBbQ09OVFJPTExFUiBFUlJPUl0gZ2V0UmVjZW50Q29tbXVuaWNhdGlvbnMgZmFpbGVkOicsIGVycm9yKTtcbiAgICAgIHRocm93IGVycm9yO1xuICAgIH1cbiAgfVxuXG4gIEBHZXQoJ2NvbnZlcnNhdGlvbnMvOmNvbnZlcnNhdGlvbklkL21lc3NhZ2VzJylcbiAgYXN5bmMgZ2V0Q29udmVyc2F0aW9uTWVzc2FnZXMoXG4gICAgQEN1cnJlbnRVc2VySWQoKSB1c2VySWQ6IHN0cmluZyxcbiAgICBAUGFyYW0oJ2NvbnZlcnNhdGlvbklkJykgY29udmVyc2F0aW9uSWQ6IHN0cmluZyxcbiAgICBAUXVlcnkoKSBwYXJhbXM6IENvbnZlcnNhdGlvbkxpc3RQYXJhbXMsXG4gICkge1xuICAgIGNvbnN0IHBhZ2VOdW0gPSBwYXJhbXMucGFnZSB8fCAxO1xuICAgIGNvbnN0IGxpbWl0TnVtID0gcGFyYW1zLmxpbWl0IHx8IDUwO1xuICAgIHJldHVybiB0aGlzLm1lc3NhZ2luZ1NlcnZpY2UuZ2V0Q29udmVyc2F0aW9uTWVzc2FnZXMoXG4gICAgICB1c2VySWQsXG4gICAgICBjb252ZXJzYXRpb25JZCxcbiAgICAgIHBhZ2VOdW0sXG4gICAgICBsaW1pdE51bSxcbiAgICApO1xuICB9XG5cbiAgLy8gTWVzc2FnZSBlbmRwb2ludHNcbiAgQFBvc3QoJ2NvbnZlcnNhdGlvbnMvOmNvbnZlcnNhdGlvbklkL21lc3NhZ2VzJylcbiAgQFVzZUludGVyY2VwdG9ycyhGaWxlc0ludGVyY2VwdG9yKCdmaWxlcycsIDMpKSAvLyBTdXBwb3J0IHVwIHRvIDMgZmlsZXNcbiAgQEh0dHBDb2RlKEh0dHBTdGF0dXMuQ1JFQVRFRClcbiAgYXN5bmMgc2VuZE1lc3NhZ2UoXG4gICAgQEN1cnJlbnRVc2VySWQoKSB1c2VySWQ6IHN0cmluZyxcbiAgICBAUGFyYW0oJ2NvbnZlcnNhdGlvbklkJykgY29udmVyc2F0aW9uSWQ6IHN0cmluZyxcbiAgICBAQm9keSgpIHNlbmRNZXNzYWdlRHRvOiBTZW5kTWVzc2FnZUR0byxcbiAgICBAVXBsb2FkZWRGaWxlcygpIGZpbGVzOiBFeHByZXNzLk11bHRlci5GaWxlW10gPSBbXSwgLy8gT3B0aW9uYWwgZmlsZXNcbiAgKSB7XG4gICAgLy8gVmFsaWRhdGUgYW5kIHVwbG9hZCBmaWxlcyBpZiBwcm92aWRlZFxuICAgIGNvbnN0IGZpbGVSZXN1bHRzOiBGaWxlVXBsb2FkUmVzdWx0W10gPSBbXTtcbiAgICBpZiAoZmlsZXMgJiYgZmlsZXMubGVuZ3RoID4gMCkge1xuICAgICAgZm9yIChjb25zdCBmaWxlIG9mIGZpbGVzKSB7XG4gICAgICAgIGNvbnN0IHZhbGlkYXRpb24gPSB0aGlzLnN1cGFiYXNlU3RvcmFnZVNlcnZpY2UudmFsaWRhdGVGaWxlKGZpbGUpO1xuICAgICAgICBpZiAoIXZhbGlkYXRpb24uaXNWYWxpZCkge1xuICAgICAgICAgIHRocm93IG5ldyBIdHRwRXhjZXB0aW9uKFxuICAgICAgICAgICAgYEZpbGUgdmFsaWRhdGlvbiBmYWlsZWQ6ICR7dmFsaWRhdGlvbi5lcnJvcn1gLFxuICAgICAgICAgICAgSHR0cFN0YXR1cy5CQURfUkVRVUVTVCxcbiAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIC8vIFVwbG9hZCBmaWxlcyB0byBTdXBhYmFzZVxuICAgICAgY29uc3QgdXBsb2FkUmVzdWx0cyA9IGF3YWl0IHRoaXMuc3VwYWJhc2VTdG9yYWdlU2VydmljZS51cGxvYWRGaWxlcyhcbiAgICAgICAgZmlsZXMsXG4gICAgICAgIFN1cGFiYXNlU3RvcmFnZVNlcnZpY2UuZ2V0U3VwcG9ydGVkQnVja2V0cygpLk1FU1NBR0VTLFxuICAgICAgKTtcbiAgICAgIGZpbGVSZXN1bHRzLnB1c2goLi4udXBsb2FkUmVzdWx0cyk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXMubWVzc2FnaW5nU2VydmljZS5zZW5kTWVzc2FnZShcbiAgICAgIHVzZXJJZCxcbiAgICAgIGNvbnZlcnNhdGlvbklkLFxuICAgICAgc2VuZE1lc3NhZ2VEdG8sXG4gICAgICBmaWxlUmVzdWx0cy5tYXAoKGYpID0+IGYudXJsKSxcbiAgICAgIGZpbGVSZXN1bHRzLm1hcCgoZikgPT4gZi5maWxlbmFtZSksXG4gICAgICBmaWxlcy5tYXAoKGYpID0+IGYuc2l6ZSksXG4gICAgKTtcbiAgfVxuXG4gIEBQdXQoJ21lc3NhZ2VzLzptZXNzYWdlSWQnKVxuICBhc3luYyB1cGRhdGVNZXNzYWdlKFxuICAgIEBDdXJyZW50VXNlcklkKCkgdXNlcklkOiBzdHJpbmcsXG4gICAgQFBhcmFtKCdtZXNzYWdlSWQnKSBtZXNzYWdlSWQ6IHN0cmluZyxcbiAgICBAQm9keSgpIHVwZGF0ZU1lc3NhZ2VEdG86IFVwZGF0ZU1lc3NhZ2VEdG8sXG4gICkge1xuICAgIHJldHVybiB0aGlzLm1lc3NhZ2luZ1NlcnZpY2UudXBkYXRlTWVzc2FnZShcbiAgICAgIHVzZXJJZCxcbiAgICAgIG1lc3NhZ2VJZCxcbiAgICAgIHVwZGF0ZU1lc3NhZ2VEdG8sXG4gICAgKTtcbiAgfVxuXG4gIEBEZWxldGUoJ21lc3NhZ2VzLzptZXNzYWdlSWQnKVxuICBASHR0cENvZGUoSHR0cFN0YXR1cy5OT19DT05URU5UKVxuICBhc3luYyBkZWxldGVNZXNzYWdlKFxuICAgIEBDdXJyZW50VXNlcklkKCkgdXNlcklkOiBzdHJpbmcsXG4gICAgQFBhcmFtKCdtZXNzYWdlSWQnKSBtZXNzYWdlSWQ6IHN0cmluZyxcbiAgKSB7XG4gICAgcmV0dXJuIHRoaXMubWVzc2FnaW5nU2VydmljZS5kZWxldGVNZXNzYWdlKHVzZXJJZCwgbWVzc2FnZUlkKTtcbiAgfVxuXG4gIC8vIFJlYWQgcmVjZWlwdHNcbiAgQFBvc3QoJ21lc3NhZ2VzLzptZXNzYWdlSWQvcmVhZCcpXG4gIEBIdHRwQ29kZShIdHRwU3RhdHVzLk9LKVxuICBhc3luYyBtYXJrTWVzc2FnZUFzUmVhZChcbiAgICBAQ3VycmVudFVzZXJJZCgpIHVzZXJJZDogc3RyaW5nLFxuICAgIEBQYXJhbSgnbWVzc2FnZUlkJykgbWVzc2FnZUlkOiBzdHJpbmcsXG4gICkge1xuICAgIHJldHVybiB0aGlzLm1lc3NhZ2luZ1NlcnZpY2UubWFya01lc3NhZ2VBc1JlYWQodXNlcklkLCBtZXNzYWdlSWQpO1xuICB9XG5cbiAgLy8gTWVzc2FnZSByZWFjdGlvbnNcbiAgQFBvc3QoJ21lc3NhZ2VzLzptZXNzYWdlSWQvcmVhY3Rpb25zJylcbiAgQEh0dHBDb2RlKEh0dHBTdGF0dXMuQ1JFQVRFRClcbiAgYXN5bmMgYWRkTWVzc2FnZVJlYWN0aW9uKFxuICAgIEBDdXJyZW50VXNlcklkKCkgdXNlcklkOiBzdHJpbmcsXG4gICAgQFBhcmFtKCdtZXNzYWdlSWQnKSBtZXNzYWdlSWQ6IHN0cmluZyxcbiAgICBAQm9keSgpIGFkZFJlYWN0aW9uRHRvOiBBZGRSZWFjdGlvbkR0byxcbiAgKSB7XG4gICAgcmV0dXJuIHRoaXMubWVzc2FnaW5nU2VydmljZS5hZGRNZXNzYWdlUmVhY3Rpb24oXG4gICAgICB1c2VySWQsXG4gICAgICBtZXNzYWdlSWQsXG4gICAgICBhZGRSZWFjdGlvbkR0by5lbW9qaSxcbiAgICApO1xuICB9XG5cbiAgQERlbGV0ZSgnbWVzc2FnZXMvOm1lc3NhZ2VJZC9yZWFjdGlvbnMvOmVtb2ppJylcbiAgQEh0dHBDb2RlKEh0dHBTdGF0dXMuTk9fQ09OVEVOVClcbiAgYXN5bmMgcmVtb3ZlTWVzc2FnZVJlYWN0aW9uKFxuICAgIEBDdXJyZW50VXNlcklkKCkgdXNlcklkOiBzdHJpbmcsXG4gICAgQFBhcmFtKCdtZXNzYWdlSWQnKSBtZXNzYWdlSWQ6IHN0cmluZyxcbiAgICBAUGFyYW0oJ2Vtb2ppJykgZW1vamk6IHN0cmluZyxcbiAgKSB7XG4gICAgcmV0dXJuIHRoaXMubWVzc2FnaW5nU2VydmljZS5yZW1vdmVNZXNzYWdlUmVhY3Rpb24oXG4gICAgICB1c2VySWQsXG4gICAgICBtZXNzYWdlSWQsXG4gICAgICBlbW9qaSxcbiAgICApO1xuICB9XG5cbiAgLy8gVXNlciBibG9ja2luZ1xuICBAUG9zdCgnYmxvY2snKVxuICBASHR0cENvZGUoSHR0cFN0YXR1cy5DUkVBVEVEKVxuICBhc3luYyBibG9ja1VzZXIoXG4gICAgQEN1cnJlbnRVc2VySWQoKSB1c2VySWQ6IHN0cmluZyxcbiAgICBAQm9keSgpIGJsb2NrVXNlckR0bzogQmxvY2tVc2VyRHRvLFxuICApIHtcbiAgICByZXR1cm4gdGhpcy5tZXNzYWdpbmdTZXJ2aWNlLmJsb2NrVXNlcihcbiAgICAgIHVzZXJJZCxcbiAgICAgIGJsb2NrVXNlckR0by51c2VySWQsXG4gICAgICBibG9ja1VzZXJEdG8ucmVhc29uLFxuICAgICk7XG4gIH1cblxuICBARGVsZXRlKCdibG9jay86YmxvY2tlZFVzZXJJZCcpXG4gIEBIdHRwQ29kZShIdHRwU3RhdHVzLk5PX0NPTlRFTlQpXG4gIGFzeW5jIHVuYmxvY2tVc2VyKFxuICAgIEBDdXJyZW50VXNlcklkKCkgdXNlcklkOiBzdHJpbmcsXG4gICAgQFBhcmFtKCdibG9ja2VkVXNlcklkJykgYmxvY2tlZFVzZXJJZDogc3RyaW5nLFxuICApIHtcbiAgICByZXR1cm4gdGhpcy5tZXNzYWdpbmdTZXJ2aWNlLnVuYmxvY2tVc2VyKHVzZXJJZCwgYmxvY2tlZFVzZXJJZCk7XG4gIH1cblxuICAvLyBTZWFyY2ggbWVzc2FnZXNcbiAgQEdldCgnc2VhcmNoJylcbiAgYXN5bmMgc2VhcmNoTWVzc2FnZXMoXG4gICAgQEN1cnJlbnRVc2VySWQoKSB1c2VySWQ6IHN0cmluZyxcbiAgICBAUXVlcnkoKSBzZWFyY2hEdG86IFNlYXJjaE1lc3NhZ2VzRHRvLFxuICApIHtcbiAgICBjb25zdCB7IHF1ZXJ5LCBjb252ZXJzYXRpb25JZCwgcGFnZSwgbGltaXQgfSA9IHNlYXJjaER0bztcbiAgICBjb25zdCBwYWdlTnVtID0gcGFnZSA/IE51bWJlcihwYWdlKSA6IDE7XG4gICAgY29uc3QgbGltaXROdW0gPSBsaW1pdCA/IE51bWJlcihsaW1pdCkgOiAyMDtcbiAgICByZXR1cm4gdGhpcy5tZXNzYWdpbmdTZXJ2aWNlLnNlYXJjaE1lc3NhZ2VzKFxuICAgICAgdXNlcklkLFxuICAgICAgcXVlcnkgfHwgJycsXG4gICAgICBjb252ZXJzYXRpb25JZCxcbiAgICAgIHBhZ2VOdW0sXG4gICAgICBsaW1pdE51bSxcbiAgICApO1xuICB9XG59XG4iXSwidmVyc2lvbiI6M30=