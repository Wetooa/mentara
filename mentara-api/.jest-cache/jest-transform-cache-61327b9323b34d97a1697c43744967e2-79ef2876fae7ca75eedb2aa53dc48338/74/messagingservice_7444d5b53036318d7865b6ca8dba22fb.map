{"file":"/home/wetooa/Documents/code/projects/mentara/mentara-api/src/messaging/messaging.service.ts","mappings":"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","names":[],"sources":["/home/wetooa/Documents/code/projects/mentara/mentara-api/src/messaging/messaging.service.ts"],"sourcesContent":["import {\n  Injectable,\n  Logger,\n  NotFoundException,\n  ForbiddenException,\n  BadRequestException,\n  InternalServerErrorException,\n} from '@nestjs/common';\nimport { PrismaService } from '../providers/prisma-client.provider';\nimport type {\n  CreateConversationDto,\n  SendMessageDto,\n  UpdateMessageDto,\n} from './types';\nimport { ConversationType, MessageType, ParticipantRole } from '@prisma/client';\nimport { EventBusService } from '../common/events/event-bus.service';\nimport {\n  MessageSentEvent,\n  MessageReadEvent,\n  ConversationCreatedEvent,\n} from '../common/events/messaging-events';\n// Note: Encryption functionality removed to match Prisma schema\n// The schema doesn't include encryption fields (encryptionIv, encryptionAuthTag, encryptionKeyId, isEncrypted)\n\n@Injectable()\nexport class MessagingService {\n  private readonly logger = new Logger(MessagingService.name);\n\n  constructor(\n    private readonly prisma: PrismaService,\n    private readonly eventBus: EventBusService,\n  ) {}\n\n  // Conversation Management\n  private mapConversationType(type: string): ConversationType {\n    switch (type) {\n      case 'direct':\n        return ConversationType.DIRECT;\n      case 'group':\n        return ConversationType.GROUP;\n      case 'therapy_session':\n      case 'session':\n        return ConversationType.SESSION;\n      case 'support':\n        return ConversationType.SUPPORT;\n      default:\n        return ConversationType.DIRECT;\n    }\n  }\n\n  private mapMessageType(type: string | MessageType): MessageType {\n    if (typeof type === 'string') {\n      switch (type.toLowerCase()) {\n        case 'text':\n          return MessageType.TEXT;\n        case 'image':\n          return MessageType.IMAGE;\n        case 'audio':\n          return MessageType.AUDIO;\n        case 'video':\n          return MessageType.VIDEO;\n        case 'system':\n          return MessageType.SYSTEM;\n        default:\n          return MessageType.TEXT;\n      }\n    }\n    return type;\n  }\n\n  async createConversation(\n    userId: string,\n    createConversationDto: CreateConversationDto,\n  ) {\n    const {\n      participantIds,\n      type: rawType = 'direct',\n      title,\n    } = createConversationDto;\n\n    console.log(createConversationDto);\n\n    const type = this.mapConversationType(rawType);\n\n    // Validate conversation type and participants\n    if (type === ConversationType.DIRECT && participantIds.length !== 1) {\n      throw new BadRequestException(\n        'Direct conversations must have exactly one other participant',\n      );\n    }\n\n    // Check if direct conversation already exists\n    if (type === ConversationType.DIRECT) {\n      const existingConversation = await this.findDirectConversation(\n        userId,\n        participantIds[0],\n      );\n      if (existingConversation) {\n        return existingConversation;\n      }\n    }\n\n    // Create conversation with participants\n    const conversation = await this.prisma.conversation.create({\n      data: {\n        type,\n        title,\n        participants: {\n          create: [\n            { userId, role: ParticipantRole.ADMIN },\n            ...participantIds.map((participantId) => ({\n              userId: participantId,\n              role: ParticipantRole.MEMBER,\n            })),\n          ],\n        },\n      },\n      include: {\n        participants: {\n          include: {\n            user: {\n              select: {\n                id: true,\n                firstName: true,\n                lastName: true,\n                avatarUrl: true,\n                role: true,\n              },\n            },\n          },\n        },\n        messages: {\n          take: 1,\n          orderBy: { createdAt: 'desc' },\n          include: {\n            sender: {\n              select: {\n                id: true,\n                firstName: true,\n                lastName: true,\n                avatarUrl: true,\n              },\n            },\n          },\n        },\n      },\n    });\n\n    // Publish conversation created event\n    await this.eventBus.emit(\n      new ConversationCreatedEvent({\n        conversationId: conversation.id,\n        createdBy: userId,\n        participantIds: [userId, ...participantIds],\n        conversationType: type.toLowerCase() as\n          | 'direct'\n          | 'group'\n          | 'support'\n          | 'therapy',\n        title: title || undefined,\n        isPrivate: type === ConversationType.DIRECT,\n      }),\n    );\n\n    return conversation;\n  }\n\n  async getUserConversations(userId: string, page = 1, limit = 20) {\n    console.log('ðŸ” [MESSAGING SERVICE] getUserConversations called');\n    console.log('ðŸ“Š [PARAMETERS]', { userId, page, limit });\n\n    const skip = (page - 1) * limit;\n\n    try {\n      console.log('ðŸ—ƒï¸ [DATABASE] Executing conversation query...');\n      const conversations = await this.prisma.conversation.findMany({\n        where: {\n          participants: {\n            some: {\n              userId,\n              isActive: true,\n            },\n          },\n          isActive: true,\n        },\n        include: {\n          participants: {\n            where: { isActive: true },\n            include: {\n              user: {\n                select: {\n                  id: true,\n                  firstName: true,\n                  lastName: true,\n                  avatarUrl: true,\n                  role: true,\n                },\n              },\n            },\n          },\n          messages: {\n            take: 1,\n            orderBy: { createdAt: 'desc' },\n            where: { isDeleted: false },\n            include: {\n              sender: {\n                select: {\n                  id: true,\n                  firstName: true,\n                  lastName: true,\n                  avatarUrl: true,\n                },\n              },\n            },\n          },\n          _count: {\n            select: {\n              messages: {\n                where: {\n                  isDeleted: false,\n                  readReceipts: {\n                    none: { userId },\n                  },\n                },\n              },\n            },\n          },\n        },\n        orderBy: { lastMessageAt: 'desc' },\n        skip,\n        take: limit,\n      });\n\n      console.log(\n        'âœ… [DATABASE RESULT] Found conversations:',\n        conversations.length,\n      );\n      console.log('ðŸ“ [CONVERSATION DETAILS]:');\n      conversations.forEach((conv, index) => {\n        console.log(\n          `   ${index + 1}. ${conv.type} - \"${conv.title || 'Untitled'}\" (ID: ${conv.id})`,\n        );\n        console.log(\n          `      Participants: ${conv.participants.length}, Messages: ${conv.messages.length}`,\n        );\n        if (conv.participants.length > 0) {\n          const otherParticipants = conv.participants.filter(\n            (p) => p.userId !== userId,\n          );\n          console.log(\n            `      Other participants: ${otherParticipants.map((p) => `${p.user.firstName} ${p.user.lastName} (${p.user.role})`).join(', ')}`,\n          );\n        }\n      });\n\n      return conversations;\n    } catch (error) {\n      console.error('âŒ [DATABASE ERROR] getUserConversations failed:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * Get recent communications for dashboard\n   * Returns a simplified format optimized for the dashboard recent communications widget\n   */\n  async getRecentCommunications(userId: string, limit = 5) {\n    console.log('ðŸ“§ [MESSAGING SERVICE] getRecentCommunications called');\n    console.log('ðŸ“Š [PARAMETERS]', { userId, limit });\n\n    try {\n      // Get user's recent conversations with detailed information\n      const conversations = await this.prisma.conversation.findMany({\n        where: {\n          participants: {\n            some: {\n              userId,\n              isActive: true,\n            },\n          },\n          isActive: true,\n          lastMessageAt: { not: null }, // Only conversations with messages\n        },\n        include: {\n          participants: {\n            where: { \n              userId: { not: userId }, // Get other participants only\n              isActive: true \n            },\n            include: {\n              user: {\n                select: {\n                  id: true,\n                  firstName: true,\n                  lastName: true,\n                  avatarUrl: true,\n                  role: true,\n                },\n              },\n            },\n          },\n          messages: {\n            take: 1,\n            orderBy: { createdAt: 'desc' },\n            where: { isDeleted: false },\n            select: {\n              id: true,\n              content: true,\n              createdAt: true,\n              messageType: true,\n              senderId: true,\n            },\n          },\n          _count: {\n            select: {\n              messages: {\n                where: {\n                  isDeleted: false,\n                  readReceipts: {\n                    none: { userId },\n                  },\n                },\n              },\n            },\n          },\n        },\n        orderBy: { lastMessageAt: 'desc' },\n        take: limit,\n      });\n\n      console.log('âœ… [DATABASE RESULT] Found recent communications:', conversations.length);\n\n      // Transform conversations to recent communications format\n      const recentCommunications = conversations.map((conversation) => {\n        const otherParticipant = conversation.participants[0]; // Get the other participant\n        const lastMessage = conversation.messages[0];\n        const unreadCount = conversation._count.messages;\n\n        if (!otherParticipant) {\n          console.log('âš ï¸ [WARNING] Conversation has no other participants:', conversation.id);\n          return null;\n        }\n\n        return {\n          id: otherParticipant.user.id,\n          conversationId: conversation.id,\n          name: `${otherParticipant.user.firstName} ${otherParticipant.user.lastName}`,\n          role: otherParticipant.user.role,\n          avatar: otherParticipant.user.avatarUrl || null,\n          lastMessage: lastMessage ? {\n            content: lastMessage.content,\n            time: lastMessage.createdAt.toISOString(),\n            isFromUser: lastMessage.senderId === userId,\n            messageType: lastMessage.messageType,\n          } : null,\n          unreadCount,\n          status: 'offline', // Default status, could be enhanced with real-time presence\n          conversationType: conversation.type,\n        };\n      }).filter(Boolean); // Remove null entries\n\n      console.log('ðŸ“± [FORMATTED RESULT] Recent communications formatted:', recentCommunications.length);\n\n      return recentCommunications;\n    } catch (error) {\n      console.error('âŒ [DATABASE ERROR] getRecentCommunications failed:', error);\n      throw error;\n    }\n  }\n\n  // Message Management\n  async sendMessage(\n    userId: string,\n    conversationId: string,\n    sendMessageDto: SendMessageDto,\n    attachmentUrls: string[] = [],\n    attachmentNames: string[] = [],\n    attachmentSizes: number[] = [],\n  ) {\n    // Verify user is participant in conversation\n    await this.verifyParticipant(userId, conversationId);\n\n    const {\n      content,\n      messageType: rawMessageType,\n      replyToId,\n      attachmentUrl,\n      attachmentName,\n      attachmentSize,\n    } = sendMessageDto;\n\n    const messageType = this.mapMessageType(rawMessageType || 'text');\n\n    // Verify conversation exists\n    const conversation = await this.prisma.conversation.findUnique({\n      where: { id: conversationId },\n      include: {\n        participants: {\n          include: {\n            user: {\n              select: { role: true },\n            },\n          },\n        },\n      },\n    });\n\n    if (!conversation) {\n      throw new NotFoundException('Conversation not found');\n    }\n\n    // Note: Message encryption functionality removed to match Prisma schema\n    // Messages are stored as plaintext as the schema doesn't support encryption fields\n\n    const message = await this.prisma.message.create({\n      data: {\n        conversationId,\n        senderId: userId,\n        content, // Store content as-is (no encryption)\n        messageType,\n        replyToId,\n        // Use multiple attachment fields (schema only supports these)\n        attachmentUrls:\n          attachmentUrls.length > 0\n            ? attachmentUrls\n            : attachmentUrl\n              ? [attachmentUrl]\n              : [],\n        attachmentNames:\n          attachmentNames.length > 0\n            ? attachmentNames\n            : attachmentName\n              ? [attachmentName]\n              : [],\n        attachmentSizes:\n          attachmentSizes.length > 0\n            ? attachmentSizes\n            : attachmentSize\n              ? [attachmentSize]\n              : [],\n      },\n      include: {\n        sender: {\n          select: {\n            id: true,\n            firstName: true,\n            lastName: true,\n            avatarUrl: true,\n          },\n        },\n        replyTo: {\n          include: {\n            sender: {\n              select: {\n                id: true,\n                firstName: true,\n                lastName: true,\n              },\n            },\n          },\n        },\n        reactions: {\n          include: {\n            user: {\n              select: {\n                id: true,\n                firstName: true,\n                lastName: true,\n              },\n            },\n          },\n        },\n      },\n    });\n\n    // Update conversation lastMessageAt\n    await this.prisma.conversation.update({\n      where: { id: conversationId },\n      data: { lastMessageAt: new Date() },\n    });\n\n    // Note: No encryption - content is stored and transmitted as plaintext\n    const eventContent = content;\n\n    const recipientIds =\n      conversation?.participants\n        .map((p) => p.userId)\n        .filter((id) => id !== userId) || [];\n\n    // Publish message sent event\n    await this.eventBus.emit(\n      new MessageSentEvent({\n        messageId: message.id,\n        conversationId,\n        senderId: userId,\n        content: eventContent, // Content transmitted as-is\n        messageType: message.messageType.toLowerCase() as\n          | 'text'\n          | 'image'\n          | 'file'\n          | 'audio'\n          | 'video'\n          | 'system',\n        sentAt: message.createdAt,\n        recipientIds,\n        replyToMessageId: message.replyToId || undefined,\n        fileAttachments:\n          message.attachmentUrls.length > 0\n            ? message.attachmentUrls\n            : undefined,\n      }),\n    );\n\n    // Return message as-is (no encryption)\n    return message;\n  }\n\n  async getConversationMessages(\n    userId: string,\n    conversationId: string,\n    page = 1,\n    limit = 50,\n  ) {\n    // Verify user is participant in conversation\n    await this.verifyParticipant(userId, conversationId);\n\n    const skip = (page - 1) * limit;\n\n    const messages = await this.prisma.message.findMany({\n      where: {\n        conversationId,\n        isDeleted: false,\n      },\n      include: {\n        sender: {\n          select: {\n            id: true,\n            firstName: true,\n            lastName: true,\n            avatarUrl: true,\n          },\n        },\n        replyTo: {\n          include: {\n            sender: {\n              select: {\n                id: true,\n                firstName: true,\n                lastName: true,\n              },\n            },\n          },\n        },\n        reactions: {\n          include: {\n            user: {\n              select: {\n                id: true,\n                firstName: true,\n                lastName: true,\n              },\n            },\n          },\n        },\n        readReceipts: {\n          include: {\n            user: {\n              select: {\n                id: true,\n                firstName: true,\n                lastName: true,\n              },\n            },\n          },\n        },\n      },\n      orderBy: { createdAt: 'desc' },\n      skip,\n      take: limit,\n    });\n\n    // Return messages as-is (no decryption needed)\n    return messages.reverse(); // Return in chronological order\n  }\n\n  async updateMessage(\n    userId: string,\n    messageId: string,\n    updateMessageDto: UpdateMessageDto,\n  ) {\n    const message = await this.prisma.message.findUnique({\n      where: { id: messageId },\n    });\n\n    if (!message) {\n      throw new NotFoundException('Message not found');\n    }\n\n    if (message.senderId !== userId) {\n      throw new ForbiddenException('You can only edit your own messages');\n    }\n\n    if (message.isDeleted) {\n      throw new BadRequestException('Cannot edit deleted message');\n    }\n\n    const updatedMessage = await this.prisma.message.update({\n      where: { id: messageId },\n      data: {\n        content: updateMessageDto.content,\n        isEdited: true,\n        editedAt: new Date(),\n      },\n      include: {\n        sender: {\n          select: {\n            id: true,\n            firstName: true,\n            lastName: true,\n            avatarUrl: true,\n          },\n        },\n        reactions: {\n          include: {\n            user: {\n              select: {\n                id: true,\n                firstName: true,\n                lastName: true,\n              },\n            },\n          },\n        },\n      },\n    });\n\n    return updatedMessage;\n  }\n\n  async deleteMessage(userId: string, messageId: string) {\n    const message = await this.prisma.message.findUnique({\n      where: { id: messageId },\n    });\n\n    if (!message) {\n      throw new NotFoundException('Message not found');\n    }\n\n    if (message.senderId !== userId) {\n      throw new ForbiddenException('You can only delete your own messages');\n    }\n\n    await this.prisma.message.update({\n      where: { id: messageId },\n      data: { isDeleted: true },\n    });\n\n    return { success: true };\n  }\n\n  // Read Receipts\n  async markMessageAsRead(userId: string, messageId: string) {\n    const message = await this.prisma.message.findUnique({\n      where: { id: messageId },\n    });\n\n    if (!message) {\n      throw new NotFoundException('Message not found');\n    }\n\n    // Don't create read receipt for own messages\n    if (message.senderId === userId) {\n      return;\n    }\n\n    // Verify user is participant in conversation\n    await this.verifyParticipant(userId, message.conversationId);\n\n    await this.prisma.messageReadReceipt.upsert({\n      where: {\n        messageId_userId: {\n          messageId,\n          userId,\n        },\n      },\n      create: {\n        messageId,\n        userId,\n      },\n      update: {\n        readAt: new Date(),\n      },\n    });\n\n    // Update participant's lastReadAt\n    await this.prisma.conversationParticipant.updateMany({\n      where: {\n        conversationId: message.conversationId,\n        userId,\n      },\n      data: {\n        lastReadAt: new Date(),\n      },\n    });\n\n    // Publish message read event\n    await this.eventBus.emit(\n      new MessageReadEvent({\n        messageId,\n        readBy: userId,\n        readAt: new Date(),\n        conversationId: message.conversationId,\n        messagesSinceLastRead: 1, // Could be enhanced to calculate actual count\n      }),\n    );\n  }\n\n  // Message Reactions\n  async addMessageReaction(userId: string, messageId: string, emoji: string) {\n    const message = await this.prisma.message.findUnique({\n      where: { id: messageId },\n    });\n\n    if (!message) {\n      throw new NotFoundException('Message not found');\n    }\n\n    // Verify user is participant in conversation\n    await this.verifyParticipant(userId, message.conversationId);\n\n    const reaction = await this.prisma.messageReaction.upsert({\n      where: {\n        messageId_userId_emoji: {\n          messageId,\n          userId,\n          emoji,\n        },\n      },\n      create: {\n        messageId,\n        userId,\n        emoji,\n      },\n      update: {\n        emoji,\n      },\n      include: {\n        user: {\n          select: {\n            id: true,\n            firstName: true,\n            lastName: true,\n          },\n        },\n      },\n    });\n\n    return reaction;\n  }\n\n  async removeMessageReaction(\n    userId: string,\n    messageId: string,\n    emoji: string,\n  ) {\n    await this.prisma.messageReaction.deleteMany({\n      where: {\n        messageId,\n        userId,\n        emoji,\n      },\n    });\n\n    return { success: true };\n  }\n\n  // User Blocking\n  async blockUser(blockerId: string, blockedId: string, reason?: string) {\n    if (blockerId === blockedId) {\n      throw new BadRequestException('Cannot block yourself');\n    }\n\n    await this.prisma.userBlock.upsert({\n      where: {\n        blockerId_blockedId: {\n          blockerId,\n          blockedId,\n        },\n      },\n      create: {\n        blockerId,\n        blockedId,\n        reason,\n      },\n      update: {\n        reason,\n      },\n    });\n\n    return { success: true };\n  }\n\n  async unblockUser(blockerId: string, blockedId: string) {\n    await this.prisma.userBlock.deleteMany({\n      where: {\n        blockerId,\n        blockedId,\n      },\n    });\n\n    return { success: true };\n  }\n\n  // Helper Methods\n  private async findDirectConversation(user1Id: string, user2Id: string) {\n    return this.prisma.conversation.findFirst({\n      where: {\n        type: ConversationType.DIRECT,\n        participants: {\n          every: {\n            userId: { in: [user1Id, user2Id] },\n          },\n        },\n      },\n      include: {\n        participants: {\n          include: {\n            user: {\n              select: {\n                id: true,\n                firstName: true,\n                lastName: true,\n                avatarUrl: true,\n                role: true,\n              },\n            },\n          },\n        },\n      },\n    });\n  }\n\n  private async verifyParticipant(userId: string, conversationId: string) {\n    const participant = await this.prisma.conversationParticipant.findUnique({\n      where: {\n        conversationId_userId: {\n          conversationId,\n          userId,\n        },\n      },\n    });\n\n    if (!participant || !participant.isActive) {\n      throw new ForbiddenException(\n        'You are not a participant in this conversation',\n      );\n    }\n\n    return participant;\n  }\n\n  // Search Messages\n  // Search messages by content (no encryption limitations)\n  async searchMessages(\n    userId: string,\n    query: string,\n    conversationId?: string,\n    page = 1,\n    limit = 20,\n  ) {\n    const skip = (page - 1) * limit;\n\n    const whereClause: any = {\n      AND: [\n        {\n          content: {\n            contains: query,\n            mode: 'insensitive',\n          },\n        },\n        {\n          isDeleted: false,\n        },\n        {\n          conversation: {\n            participants: {\n              some: {\n                userId,\n                isActive: true,\n              },\n            },\n          },\n        },\n      ],\n    };\n\n    if (conversationId) {\n      whereClause.conversationId = conversationId;\n    }\n\n    const messages = await this.prisma.message.findMany({\n      where: whereClause,\n      include: {\n        sender: {\n          select: {\n            id: true,\n            firstName: true,\n            lastName: true,\n            avatarUrl: true,\n          },\n        },\n        conversation: {\n          select: {\n            id: true,\n            type: true,\n            title: true,\n          },\n        },\n      },\n      orderBy: { createdAt: 'desc' },\n      skip,\n      take: limit,\n    });\n\n    // Return search results\n    return {\n      messages,\n      searchInfo: {\n        query,\n        totalResults: messages.length,\n        note: 'Search performed on message content.',\n      },\n    };\n  }\n}\n"],"version":3}