beb99cc813995fbef5833c26d1168168
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var __param = (this && this.__param) || function (paramIndex, decorator) {
    return function (target, key) { decorator(target, key, paramIndex); }
};
var AdminModerationController_1;
var _a, _b;
Object.defineProperty(exports, "__esModule", { value: true });
exports.AdminModerationController = void 0;
const common_1 = require("@nestjs/common");
const admin_service_1 = require("../admin.service");
const jwt_auth_guard_1 = require("../../auth/guards/jwt-auth.guard");
const admin_auth_guard_1 = require("../../auth/guards/admin-auth.guard");
const admin_only_decorator_1 = require("../../auth/decorators/admin-only.decorator");
const current_user_id_decorator_1 = require("../../auth/decorators/current-user-id.decorator");
const swagger_1 = require("@nestjs/swagger");
const moderation_service_1 = require("../../common/services/moderation.service");
let AdminModerationController = AdminModerationController_1 = class AdminModerationController {
    adminService;
    moderationService;
    logger = new common_1.Logger(AdminModerationController_1.name);
    constructor(adminService, moderationService) {
        this.adminService = adminService;
        this.moderationService = moderationService;
    }
    async getFlaggedContent(currentUserId, type, page, limit) {
        try {
            this.logger.log(`Admin ${currentUserId} retrieving flagged content`);
            const pageNum = page ? parseInt(page) : 1;
            const limitNum = limit ? parseInt(limit) : 10;
            return await this.adminService.getFlaggedContent({
                type,
                page: pageNum,
                limit: limitNum,
            });
        }
        catch (error) {
            this.logger.error('Failed to retrieve flagged content:', error);
            throw new common_1.HttpException('Failed to retrieve flagged content', common_1.HttpStatus.INTERNAL_SERVER_ERROR);
        }
    }
    async moderateContent(currentUserId, contentType, contentId, moderationData) {
        try {
            this.logger.log(`Admin ${currentUserId} moderating ${contentType} ${contentId}`);
            return await this.adminService.moderateContent(contentType, contentId, currentUserId, moderationData.action, moderationData.reason);
        }
        catch (error) {
            this.logger.error('Failed to moderate content:', error);
            throw new common_1.HttpException('Failed to moderate content', common_1.HttpStatus.INTERNAL_SERVER_ERROR);
        }
    }
    // AI Moderation Service Integration
    /**
     * Get moderation service health status
     */
    async getServiceHealthStatus() {
        try {
            return await this.moderationService.healthCheck();
        }
        catch (error) {
            this.logger.error('Failed to get moderation service health:', error);
            throw new common_1.HttpException('Failed to get moderation service health', common_1.HttpStatus.INTERNAL_SERVER_ERROR);
        }
    }
    /**
     * Get moderation service statistics
     */
    async getServiceStats() {
        try {
            return await this.moderationService.getStats();
        }
        catch (error) {
            this.logger.error('Failed to get moderation service stats:', error);
            throw new common_1.HttpException('Failed to get moderation service stats', common_1.HttpStatus.INTERNAL_SERVER_ERROR);
        }
    }
    /**
     * Test content classification (for admin testing)
     */
    async testClassification(adminId, body) {
        try {
            const context = {
                context: body.context,
                userId: adminId,
                userRole: 'admin',
                timestamp: new Date(),
            };
            const result = await this.moderationService.classifyContent(body.text, context);
            return {
                result,
                testInfo: {
                    testedBy: adminId,
                    timestamp: new Date(),
                    inputText: body.text,
                    inputContext: body.context,
                },
            };
        }
        catch (error) {
            this.logger.error('Failed to test content classification:', error);
            throw new common_1.HttpException('Failed to test content classification', common_1.HttpStatus.INTERNAL_SERVER_ERROR);
        }
    }
    /**
     * Check if content would trigger crisis intervention
     */
    async testCrisisDetection(adminId, body) {
        try {
            const context = {
                context: body.context,
                userId: adminId,
                userRole: 'admin',
                timestamp: new Date(),
            };
            const isCrisis = await this.moderationService.checkCrisisContent(body.text, context);
            const fullResult = await this.moderationService.classifyContent(body.text, context);
            return {
                isCrisis,
                crisisLevel: fullResult.crisisLevel,
                immediateEscalation: fullResult.immediateEscalation,
                fullResult,
                testInfo: {
                    testedBy: adminId,
                    timestamp: new Date(),
                    inputText: body.text,
                    inputContext: body.context,
                },
            };
        }
        catch (error) {
            this.logger.error('Failed to test crisis detection:', error);
            throw new common_1.HttpException('Failed to test crisis detection', common_1.HttpStatus.INTERNAL_SERVER_ERROR);
        }
    }
    /**
     * Batch test multiple content items
     */
    async testBatchClassification(adminId, body) {
        try {
            const items = body.items.map((item) => ({
                text: item.text,
                context: {
                    context: item.context,
                    userId: adminId,
                    userRole: 'admin',
                    timestamp: new Date(),
                },
            }));
            const results = await this.moderationService.batchClassify(items);
            return {
                results,
                testInfo: {
                    testedBy: adminId,
                    timestamp: new Date(),
                    itemCount: items.length,
                },
            };
        }
        catch (error) {
            this.logger.error('Failed to test batch classification:', error);
            throw new common_1.HttpException('Failed to test batch classification', common_1.HttpStatus.INTERNAL_SERVER_ERROR);
        }
    }
};
exports.AdminModerationController = AdminModerationController;
__decorate([
    (0, common_1.Get)('flagged'),
    (0, swagger_1.ApiOperation)({
        summary: 'Retrieve get flagged content',
        description: 'Retrieve get flagged content',
    }),
    (0, swagger_1.ApiResponse)({
        status: 200,
        description: 'Retrieved successfully',
    }),
    (0, swagger_1.ApiResponse)({ status: 401, description: 'Unauthorized' }),
    (0, admin_only_decorator_1.AdminOnly)(),
    __param(0, (0, current_user_id_decorator_1.CurrentUserId)()),
    __param(1, (0, common_1.Query)('type')),
    __param(2, (0, common_1.Query)('page')),
    __param(3, (0, common_1.Query)('limit')),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [String, String, String, String]),
    __metadata("design:returntype", Promise)
], AdminModerationController.prototype, "getFlaggedContent", null);
__decorate([
    (0, common_1.Put)(':contentType/:contentId/moderate'),
    (0, swagger_1.ApiOperation)({
        summary: 'Update moderate content',
        description: 'Update moderate content',
    }),
    (0, swagger_1.ApiResponse)({
        status: 200,
        description: 'Updated successfully',
    }),
    (0, swagger_1.ApiResponse)({ status: 401, description: 'Unauthorized' }),
    (0, admin_only_decorator_1.AdminOnly)(),
    __param(0, (0, current_user_id_decorator_1.CurrentUserId)()),
    __param(1, (0, common_1.Param)('contentType')),
    __param(2, (0, common_1.Param)('contentId')),
    __param(3, (0, common_1.Body)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [String, String, String, Object]),
    __metadata("design:returntype", Promise)
], AdminModerationController.prototype, "moderateContent", null);
__decorate([
    (0, common_1.Get)('service/health'),
    (0, swagger_1.ApiOperation)({
        summary: 'Retrieve get service health status',
        description: 'Retrieve get service health status',
    }),
    (0, swagger_1.ApiResponse)({
        status: 200,
        description: 'Retrieved successfully',
    }),
    (0, swagger_1.ApiResponse)({ status: 401, description: 'Unauthorized' }),
    (0, admin_only_decorator_1.AdminOnly)(),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", []),
    __metadata("design:returntype", Promise)
], AdminModerationController.prototype, "getServiceHealthStatus", null);
__decorate([
    (0, common_1.Get)('service/stats'),
    (0, swagger_1.ApiOperation)({
        summary: 'Retrieve get service stats',
        description: 'Retrieve get service stats',
    }),
    (0, swagger_1.ApiResponse)({
        status: 200,
        description: 'Retrieved successfully',
    }),
    (0, swagger_1.ApiResponse)({ status: 401, description: 'Unauthorized' }),
    (0, admin_only_decorator_1.AdminOnly)(),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", []),
    __metadata("design:returntype", Promise)
], AdminModerationController.prototype, "getServiceStats", null);
__decorate([
    (0, common_1.Post)('service/test-classify'),
    (0, swagger_1.ApiOperation)({
        summary: 'Create test classification',
        description: 'Create test classification',
    }),
    (0, swagger_1.ApiResponse)({
        status: 201,
        description: 'Created successfully',
    }),
    (0, swagger_1.ApiResponse)({ status: 401, description: 'Unauthorized' }),
    (0, common_1.HttpCode)(common_1.HttpStatus.OK),
    (0, admin_only_decorator_1.AdminOnly)(),
    __param(0, (0, current_user_id_decorator_1.CurrentUserId)()),
    __param(1, (0, common_1.Body)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [String, Object]),
    __metadata("design:returntype", Promise)
], AdminModerationController.prototype, "testClassification", null);
__decorate([
    (0, common_1.Post)('service/test-crisis'),
    (0, swagger_1.ApiOperation)({
        summary: 'Create test crisis detection',
        description: 'Create test crisis detection',
    }),
    (0, swagger_1.ApiResponse)({
        status: 201,
        description: 'Created successfully',
    }),
    (0, swagger_1.ApiResponse)({ status: 401, description: 'Unauthorized' }),
    (0, common_1.HttpCode)(common_1.HttpStatus.OK),
    (0, admin_only_decorator_1.AdminOnly)(),
    __param(0, (0, current_user_id_decorator_1.CurrentUserId)()),
    __param(1, (0, common_1.Body)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [String, Object]),
    __metadata("design:returntype", Promise)
], AdminModerationController.prototype, "testCrisisDetection", null);
__decorate([
    (0, common_1.Post)('service/test-batch'),
    (0, swagger_1.ApiOperation)({
        summary: 'Create test batch classification',
        description: 'Create test batch classification',
    }),
    (0, swagger_1.ApiResponse)({
        status: 201,
        description: 'Created successfully',
    }),
    (0, swagger_1.ApiResponse)({ status: 401, description: 'Unauthorized' }),
    (0, common_1.HttpCode)(common_1.HttpStatus.OK),
    (0, admin_only_decorator_1.AdminOnly)(),
    __param(0, (0, current_user_id_decorator_1.CurrentUserId)()),
    __param(1, (0, common_1.Body)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [String, Object]),
    __metadata("design:returntype", Promise)
], AdminModerationController.prototype, "testBatchClassification", null);
exports.AdminModerationController = AdminModerationController = AdminModerationController_1 = __decorate([
    (0, swagger_1.ApiTags)('admin-moderation'),
    (0, swagger_1.ApiBearerAuth)('JWT-auth'),
    (0, common_1.Controller)('admin/moderation'),
    (0, common_1.UseGuards)(jwt_auth_guard_1.JwtAuthGuard, admin_auth_guard_1.AdminAuthGuard),
    __metadata("design:paramtypes", [typeof (_a = typeof admin_service_1.AdminService !== "undefined" && admin_service_1.AdminService) === "function" ? _a : Object, typeof (_b = typeof moderation_service_1.ModerationService !== "undefined" && moderation_service_1.ModerationService) === "function" ? _b : Object])
], AdminModerationController);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL2FkbWluL2NvbnRyb2xsZXJzL2FkbWluLW1vZGVyYXRpb24uY29udHJvbGxlci50cyIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLDJDQWF3QjtBQUN4QixvREFBZ0Q7QUFDaEQscUVBQWdFO0FBQ2hFLHlFQUFvRTtBQUNwRSxxRkFBdUU7QUFDdkUsK0ZBQWdGO0FBQ2hGLDZDQVF5QjtBQUN6QixpRkFHa0Q7QUFNM0MsSUFBTSx5QkFBeUIsaUNBQS9CLE1BQU0seUJBQXlCO0lBSWpCO0lBQ0E7SUFKRixNQUFNLEdBQUcsSUFBSSxlQUFNLENBQUMsMkJBQXlCLENBQUMsSUFBSSxDQUFDLENBQUM7SUFFckUsWUFDbUIsWUFBMEIsRUFDMUIsaUJBQW9DO1FBRHBDLGlCQUFZLEdBQVosWUFBWSxDQUFjO1FBQzFCLHNCQUFpQixHQUFqQixpQkFBaUIsQ0FBbUI7SUFDcEQsQ0FBQztJQWVFLEFBQU4sS0FBSyxDQUFDLGlCQUFpQixDQUNKLGFBQXFCLEVBQ3ZCLElBQWEsRUFDYixJQUFhLEVBQ1osS0FBYztRQUU5QixJQUFJLENBQUM7WUFDSCxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxTQUFTLGFBQWEsNkJBQTZCLENBQUMsQ0FBQztZQUNyRSxNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQzFDLE1BQU0sUUFBUSxHQUFHLEtBQUssQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUM7WUFFOUMsT0FBTyxNQUFNLElBQUksQ0FBQyxZQUFZLENBQUMsaUJBQWlCLENBQUM7Z0JBQy9DLElBQUk7Z0JBQ0osSUFBSSxFQUFFLE9BQU87Z0JBQ2IsS0FBSyxFQUFFLFFBQVE7YUFDaEIsQ0FBQyxDQUFDO1FBQ0ws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QSxrQkFBUyxFQUFDLDZCQUFZLEVBQUUsaUNBQWMsQ0FBQzt5REFLTCw0QkFBWSxvQkFBWiw0QkFBWSxvREFDUCxzQ0FBaUIsb0JBQWpCLHNDQUFpQjtHQUw1Qyx5QkFBeUIsQ0FpVHJDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9ob21lL3dldG9vYS9Eb2N1bWVudHMvY29kZS9wcm9qZWN0cy9tZW50YXJhL21lbnRhcmEtYXBpL3NyYy9hZG1pbi9jb250cm9sbGVycy9hZG1pbi1tb2RlcmF0aW9uLmNvbnRyb2xsZXIudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgQ29udHJvbGxlcixcbiAgR2V0LFxuICBQdXQsXG4gIFBvc3QsXG4gIEJvZHksXG4gIFBhcmFtLFxuICBVc2VHdWFyZHMsXG4gIEh0dHBFeGNlcHRpb24sXG4gIEh0dHBTdGF0dXMsXG4gIExvZ2dlcixcbiAgUXVlcnksXG4gIEh0dHBDb2RlLFxufSBmcm9tICdAbmVzdGpzL2NvbW1vbic7XG5pbXBvcnQgeyBBZG1pblNlcnZpY2UgfSBmcm9tICcuLi9hZG1pbi5zZXJ2aWNlJztcbmltcG9ydCB7IEp3dEF1dGhHdWFyZCB9IGZyb20gJy4uLy4uL2F1dGgvZ3VhcmRzL2p3dC1hdXRoLmd1YXJkJztcbmltcG9ydCB7IEFkbWluQXV0aEd1YXJkIH0gZnJvbSAnLi4vLi4vYXV0aC9ndWFyZHMvYWRtaW4tYXV0aC5ndWFyZCc7XG5pbXBvcnQgeyBBZG1pbk9ubHkgfSBmcm9tICcuLi8uLi9hdXRoL2RlY29yYXRvcnMvYWRtaW4tb25seS5kZWNvcmF0b3InO1xuaW1wb3J0IHsgQ3VycmVudFVzZXJJZCB9IGZyb20gJy4uLy4uL2F1dGgvZGVjb3JhdG9ycy9jdXJyZW50LXVzZXItaWQuZGVjb3JhdG9yJztcbmltcG9ydCB7XG4gIEFwaVRhZ3MsXG4gIEFwaU9wZXJhdGlvbixcbiAgQXBpUmVzcG9uc2UsXG4gIEFwaUJvZHksXG4gIEFwaUJlYXJlckF1dGgsXG4gIEFwaVBhcmFtLFxuICBBcGlRdWVyeSxcbn0gZnJvbSAnQG5lc3Rqcy9zd2FnZ2VyJztcbmltcG9ydCB7XG4gIE1vZGVyYXRpb25TZXJ2aWNlLFxuICBNb2RlcmF0aW9uQ29udGV4dCxcbn0gZnJvbSAnLi4vLi4vY29tbW9uL3NlcnZpY2VzL21vZGVyYXRpb24uc2VydmljZSc7XG5cbkBBcGlUYWdzKCdhZG1pbi1tb2RlcmF0aW9uJylcbkBBcGlCZWFyZXJBdXRoKCdKV1QtYXV0aCcpXG5AQ29udHJvbGxlcignYWRtaW4vbW9kZXJhdGlvbicpXG5AVXNlR3VhcmRzKEp3dEF1dGhHdWFyZCwgQWRtaW5BdXRoR3VhcmQpXG5leHBvcnQgY2xhc3MgQWRtaW5Nb2RlcmF0aW9uQ29udHJvbGxlciB7XG4gIHByaXZhdGUgcmVhZG9ubHkgbG9nZ2VyID0gbmV3IExvZ2dlcihBZG1pbk1vZGVyYXRpb25Db250cm9sbGVyLm5hbWUpO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgcmVhZG9ubHkgYWRtaW5TZXJ2aWNlOiBBZG1pblNlcnZpY2UsXG4gICAgcHJpdmF0ZSByZWFkb25seSBtb2RlcmF0aW9uU2VydmljZTogTW9kZXJhdGlvblNlcnZpY2UsXG4gICkge31cblxuICBAR2V0KCdmbGFnZ2VkJylcbiAgQEFwaU9wZXJhdGlvbih7XG4gICAgc3VtbWFyeTogJ1JldHJpZXZlIGdldCBmbGFnZ2VkIGNvbnRlbnQnLFxuXG4gICAgZGVzY3JpcHRpb246ICdSZXRyaWV2ZSBnZXQgZmxhZ2dlZCBjb250ZW50JyxcbiAgfSlcbiAgQEFwaVJlc3BvbnNlKHtcbiAgICBzdGF0dXM6IDIwMCxcblxuICAgIGRlc2NyaXB0aW9uOiAnUmV0cmlldmVkIHN1Y2Nlc3NmdWxseScsXG4gIH0pXG4gIEBBcGlSZXNwb25zZSh7IHN0YXR1czogNDAxLCBkZXNjcmlwdGlvbjogJ1VuYXV0aG9yaXplZCcgfSlcbiAgQEFkbWluT25seSgpXG4gIGFzeW5jIGdldEZsYWdnZWRDb250ZW50KFxuICAgIEBDdXJyZW50VXNlcklkKCkgY3VycmVudFVzZXJJZDogc3RyaW5nLFxuICAgIEBRdWVyeSgndHlwZScpIHR5cGU/OiBzdHJpbmcsXG4gICAgQFF1ZXJ5KCdwYWdlJykgcGFnZT86IHN0cmluZyxcbiAgICBAUXVlcnkoJ2xpbWl0JykgbGltaXQ/OiBzdHJpbmcsXG4gICkge1xuICAgIHRyeSB7XG4gICAgICB0aGlzLmxvZ2dlci5sb2coYEFkbWluICR7Y3VycmVudFVzZXJJZH0gcmV0cmlldmluZyBmbGFnZ2VkIGNvbnRlbnRgKTtcbiAgICAgIGNvbnN0IHBhZ2VOdW0gPSBwYWdlID8gcGFyc2VJbnQocGFnZSkgOiAxO1xuICAgICAgY29uc3QgbGltaXROdW0gPSBsaW1pdCA/IHBhcnNlSW50KGxpbWl0KSA6IDEwO1xuXG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy5hZG1pblNlcnZpY2UuZ2V0RmxhZ2dlZENvbnRlbnQoe1xuICAgICAgICB0eXBlLFxuICAgICAgICBwYWdlOiBwYWdlTnVtLFxuICAgICAgICBsaW1pdDogbGltaXROdW0sXG4gICAgICB9KTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoJ0ZhaWxlZCB0byByZXRyaWV2ZSBmbGFnZ2VkIGNvbnRlbnQ6JywgZXJyb3IpO1xuICAgICAgdGhyb3cgbmV3IEh0dHBFeGNlcHRpb24oXG4gICAgICAgICdGYWlsZWQgdG8gcmV0cmlldmUgZmxhZ2dlZCBjb250ZW50JyxcbiAgICAgICAgSHR0cFN0YXR1cy5JTlRFUk5BTF9TRVJWRVJfRVJST1IsXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIEBQdXQoJzpjb250ZW50VHlwZS86Y29udGVudElkL21vZGVyYXRlJylcbiAgQEFwaU9wZXJhdGlvbih7XG4gICAgc3VtbWFyeTogJ1VwZGF0ZSBtb2RlcmF0ZSBjb250ZW50JyxcblxuICAgIGRlc2NyaXB0aW9uOiAnVXBkYXRlIG1vZGVyYXRlIGNvbnRlbnQnLFxuICB9KVxuICBAQXBpUmVzcG9uc2Uoe1xuICAgIHN0YXR1czogMjAwLFxuXG4gICAgZGVzY3JpcHRpb246ICdVcGRhdGVkIHN1Y2Nlc3NmdWxseScsXG4gIH0pXG4gIEBBcGlSZXNwb25zZSh7IHN0YXR1czogNDAxLCBkZXNjcmlwdGlvbjogJ1VuYXV0aG9yaXplZCcgfSlcbiAgQEFkbWluT25seSgpXG4gIGFzeW5jIG1vZGVyYXRlQ29udGVudChcbiAgICBAQ3VycmVudFVzZXJJZCgpIGN1cnJlbnRVc2VySWQ6IHN0cmluZyxcbiAgICBAUGFyYW0oJ2NvbnRlbnRUeXBlJykgY29udGVudFR5cGU6IHN0cmluZyxcbiAgICBAUGFyYW0oJ2NvbnRlbnRJZCcpIGNvbnRlbnRJZDogc3RyaW5nLFxuICAgIEBCb2R5KClcbiAgICBtb2RlcmF0aW9uRGF0YTogeyBhY3Rpb246ICdhcHByb3ZlJyB8ICdyZW1vdmUnIHwgJ2ZsYWcnOyByZWFzb24/OiBzdHJpbmcgfSxcbiAgKSB7XG4gICAgdHJ5IHtcbiAgICAgIHRoaXMubG9nZ2VyLmxvZyhcbiAgICAgICAgYEFkbWluICR7Y3VycmVudFVzZXJJZH0gbW9kZXJhdGluZyAke2NvbnRlbnRUeXBlfSAke2NvbnRlbnRJZH1gLFxuICAgICAgKTtcbiAgICAgIHJldHVybiBhd2FpdCB0aGlzLmFkbWluU2VydmljZS5tb2RlcmF0ZUNvbnRlbnQoXG4gICAgICAgIGNvbnRlbnRUeXBlLFxuICAgICAgICBjb250ZW50SWQsXG4gICAgICAgIGN1cnJlbnRVc2VySWQsXG4gICAgICAgIG1vZGVyYXRpb25EYXRhLmFjdGlvbixcbiAgICAgICAgbW9kZXJhdGlvbkRhdGEucmVhc29uLFxuICAgICAgKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoJ0ZhaWxlZCB0byBtb2RlcmF0ZSBjb250ZW50OicsIGVycm9yKTtcbiAgICAgIHRocm93IG5ldyBIdHRwRXhjZXB0aW9uKFxuICAgICAgICAnRmFpbGVkIHRvIG1vZGVyYXRlIGNvbnRlbnQnLFxuICAgICAgICBIdHRwU3RhdHVzLklOVEVSTkFMX1NFUlZFUl9FUlJPUixcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgLy8gQUkgTW9kZXJhdGlvbiBTZXJ2aWNlIEludGVncmF0aW9uXG5cbiAgLyoqXG4gICAqIEdldCBtb2RlcmF0aW9uIHNlcnZpY2UgaGVhbHRoIHN0YXR1c1xuICAgKi9cbiAgQEdldCgnc2VydmljZS9oZWFsdGgnKVxuICBAQXBpT3BlcmF0aW9uKHtcbiAgICBzdW1tYXJ5OiAnUmV0cmlldmUgZ2V0IHNlcnZpY2UgaGVhbHRoIHN0YXR1cycsXG5cbiAgICBkZXNjcmlwdGlvbjogJ1JldHJpZXZlIGdldCBzZXJ2aWNlIGhlYWx0aCBzdGF0dXMnLFxuICB9KVxuICBAQXBpUmVzcG9uc2Uoe1xuICAgIHN0YXR1czogMjAwLFxuXG4gICAgZGVzY3JpcHRpb246ICdSZXRyaWV2ZWQgc3VjY2Vzc2Z1bGx5JyxcbiAgfSlcbiAgQEFwaVJlc3BvbnNlKHsgc3RhdHVzOiA0MDEsIGRlc2NyaXB0aW9uOiAnVW5hdXRob3JpemVkJyB9KVxuICBAQWRtaW5Pbmx5KClcbiAgYXN5bmMgZ2V0U2VydmljZUhlYWx0aFN0YXR1cygpIHtcbiAgICB0cnkge1xuICAgICAgcmV0dXJuIGF3YWl0IHRoaXMubW9kZXJhdGlvblNlcnZpY2UuaGVhbHRoQ2hlY2soKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoJ0ZhaWxlZCB0byBnZXQgbW9kZXJhdGlvbiBzZXJ2aWNlIGhlYWx0aDonLCBlcnJvcik7XG4gICAgICB0aHJvdyBuZXcgSHR0cEV4Y2VwdGlvbihcbiAgICAgICAgJ0ZhaWxlZCB0byBnZXQgbW9kZXJhdGlvbiBzZXJ2aWNlIGhlYWx0aCcsXG4gICAgICAgIEh0dHBTdGF0dXMuSU5URVJOQUxfU0VSVkVSX0VSUk9SLFxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogR2V0IG1vZGVyYXRpb24gc2VydmljZSBzdGF0aXN0aWNzXG4gICAqL1xuICBAR2V0KCdzZXJ2aWNlL3N0YXRzJylcbiAgQEFwaU9wZXJhdGlvbih7XG4gICAgc3VtbWFyeTogJ1JldHJpZXZlIGdldCBzZXJ2aWNlIHN0YXRzJyxcblxuICAgIGRlc2NyaXB0aW9uOiAnUmV0cmlldmUgZ2V0IHNlcnZpY2Ugc3RhdHMnLFxuICB9KVxuICBAQXBpUmVzcG9uc2Uoe1xuICAgIHN0YXR1czogMjAwLFxuXG4gICAgZGVzY3JpcHRpb246ICdSZXRyaWV2ZWQgc3VjY2Vzc2Z1bGx5JyxcbiAgfSlcbiAgQEFwaVJlc3BvbnNlKHsgc3RhdHVzOiA0MDEsIGRlc2NyaXB0aW9uOiAnVW5hdXRob3JpemVkJyB9KVxuICBAQWRtaW5Pbmx5KClcbiAgYXN5bmMgZ2V0U2VydmljZVN0YXRzKCkge1xuICAgIHRyeSB7XG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy5tb2RlcmF0aW9uU2VydmljZS5nZXRTdGF0cygpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aGlzLmxvZ2dlci5lcnJvcignRmFpbGVkIHRvIGdldCBtb2RlcmF0aW9uIHNlcnZpY2Ugc3RhdHM6JywgZXJyb3IpO1xuICAgICAgdGhyb3cgbmV3IEh0dHBFeGNlcHRpb24oXG4gICAgICAgICdGYWlsZWQgdG8gZ2V0IG1vZGVyYXRpb24gc2VydmljZSBzdGF0cycsXG4gICAgICAgIEh0dHBTdGF0dXMuSU5URVJOQUxfU0VSVkVSX0VSUk9SLFxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogVGVzdCBjb250ZW50IGNsYXNzaWZpY2F0aW9uIChmb3IgYWRtaW4gdGVzdGluZylcbiAgICovXG4gIEBQb3N0KCdzZXJ2aWNlL3Rlc3QtY2xhc3NpZnknKVxuICBAQXBpT3BlcmF0aW9uKHtcbiAgICBzdW1tYXJ5OiAnQ3JlYXRlIHRlc3QgY2xhc3NpZmljYXRpb24nLFxuXG4gICAgZGVzY3JpcHRpb246ICdDcmVhdGUgdGVzdCBjbGFzc2lmaWNhdGlvbicsXG4gIH0pXG4gIEBBcGlSZXNwb25zZSh7XG4gICAgc3RhdHVzOiAyMDEsXG5cbiAgICBkZXNjcmlwdGlvbjogJ0NyZWF0ZWQgc3VjY2Vzc2Z1bGx5JyxcbiAgfSlcbiAgQEFwaVJlc3BvbnNlKHsgc3RhdHVzOiA0MDEsIGRlc2NyaXB0aW9uOiAnVW5hdXRob3JpemVkJyB9KVxuICBASHR0cENvZGUoSHR0cFN0YXR1cy5PSylcbiAgQEFkbWluT25seSgpXG4gIGFzeW5jIHRlc3RDbGFzc2lmaWNhdGlvbihcbiAgICBAQ3VycmVudFVzZXJJZCgpIGFkbWluSWQ6IHN0cmluZyxcbiAgICBAQm9keSgpIGJvZHk6IHsgdGV4dDogc3RyaW5nOyBjb250ZXh0OiBzdHJpbmcgfSxcbiAgKSB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGNvbnRleHQ6IE1vZGVyYXRpb25Db250ZXh0ID0ge1xuICAgICAgICBjb250ZXh0OiBib2R5LmNvbnRleHQsXG4gICAgICAgIHVzZXJJZDogYWRtaW5JZCxcbiAgICAgICAgdXNlclJvbGU6ICdhZG1pbicsXG4gICAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUoKSxcbiAgICAgIH07XG5cbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHRoaXMubW9kZXJhdGlvblNlcnZpY2UuY2xhc3NpZnlDb250ZW50KFxuICAgICAgICBib2R5LnRleHQsXG4gICAgICAgIGNvbnRleHQsXG4gICAgICApO1xuXG4gICAgICByZXR1cm4ge1xuICAgICAgICByZXN1bHQsXG4gICAgICAgIHRlc3RJbmZvOiB7XG4gICAgICAgICAgdGVzdGVkQnk6IGFkbWluSWQsXG4gICAgICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLFxuICAgICAgICAgIGlucHV0VGV4dDogYm9keS50ZXh0LFxuICAgICAgICAgIGlucHV0Q29udGV4dDogYm9keS5jb250ZXh0LFxuICAgICAgICB9LFxuICAgICAgfTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoJ0ZhaWxlZCB0byB0ZXN0IGNvbnRlbnQgY2xhc3NpZmljYXRpb246JywgZXJyb3IpO1xuICAgICAgdGhyb3cgbmV3IEh0dHBFeGNlcHRpb24oXG4gICAgICAgICdGYWlsZWQgdG8gdGVzdCBjb250ZW50IGNsYXNzaWZpY2F0aW9uJyxcbiAgICAgICAgSHR0cFN0YXR1cy5JTlRFUk5BTF9TRVJWRVJfRVJST1IsXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBDaGVjayBpZiBjb250ZW50IHdvdWxkIHRyaWdnZXIgY3Jpc2lzIGludGVydmVudGlvblxuICAgKi9cbiAgQFBvc3QoJ3NlcnZpY2UvdGVzdC1jcmlzaXMnKVxuICBAQXBpT3BlcmF0aW9uKHtcbiAgICBzdW1tYXJ5OiAnQ3JlYXRlIHRlc3QgY3Jpc2lzIGRldGVjdGlvbicsXG5cbiAgICBkZXNjcmlwdGlvbjogJ0NyZWF0ZSB0ZXN0IGNyaXNpcyBkZXRlY3Rpb24nLFxuICB9KVxuICBAQXBpUmVzcG9uc2Uoe1xuICAgIHN0YXR1czogMjAxLFxuXG4gICAgZGVzY3JpcHRpb246ICdDcmVhdGVkIHN1Y2Nlc3NmdWxseScsXG4gIH0pXG4gIEBBcGlSZXNwb25zZSh7IHN0YXR1czogNDAxLCBkZXNjcmlwdGlvbjogJ1VuYXV0aG9yaXplZCcgfSlcbiAgQEh0dHBDb2RlKEh0dHBTdGF0dXMuT0spXG4gIEBBZG1pbk9ubHkoKVxuICBhc3luYyB0ZXN0Q3Jpc2lzRGV0ZWN0aW9uKFxuICAgIEBDdXJyZW50VXNlcklkKCkgYWRtaW5JZDogc3RyaW5nLFxuICAgIEBCb2R5KCkgYm9keTogeyB0ZXh0OiBzdHJpbmc7IGNvbnRleHQ6IHN0cmluZyB9LFxuICApIHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgY29udGV4dDogTW9kZXJhdGlvbkNvbnRleHQgPSB7XG4gICAgICAgIGNvbnRleHQ6IGJvZHkuY29udGV4dCxcbiAgICAgICAgdXNlcklkOiBhZG1pbklkLFxuICAgICAgICB1c2VyUm9sZTogJ2FkbWluJyxcbiAgICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLFxuICAgICAgfTtcblxuICAgICAgY29uc3QgaXNDcmlzaXMgPSBhd2FpdCB0aGlzLm1vZGVyYXRpb25TZXJ2aWNlLmNoZWNrQ3Jpc2lzQ29udGVudChcbiAgICAgICAgYm9keS50ZXh0LFxuICAgICAgICBjb250ZXh0LFxuICAgICAgKTtcbiAgICAgIGNvbnN0IGZ1bGxSZXN1bHQgPSBhd2FpdCB0aGlzLm1vZGVyYXRpb25TZXJ2aWNlLmNsYXNzaWZ5Q29udGVudChcbiAgICAgICAgYm9keS50ZXh0LFxuICAgICAgICBjb250ZXh0LFxuICAgICAgKTtcblxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgaXNDcmlzaXMsXG4gICAgICAgIGNyaXNpc0xldmVsOiBmdWxsUmVzdWx0LmNyaXNpc0xldmVsLFxuICAgICAgICBpbW1lZGlhdGVFc2NhbGF0aW9uOiBmdWxsUmVzdWx0LmltbWVkaWF0ZUVzY2FsYXRpb24sXG4gICAgICAgIGZ1bGxSZXN1bHQsXG4gICAgICAgIHRlc3RJbmZvOiB7XG4gICAgICAgICAgdGVzdGVkQnk6IGFkbWluSWQsXG4gICAgICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLFxuICAgICAgICAgIGlucHV0VGV4dDogYm9keS50ZXh0LFxuICAgICAgICAgIGlucHV0Q29udGV4dDogYm9keS5jb250ZXh0LFxuICAgICAgICB9LFxuICAgICAgfTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoJ0ZhaWxlZCB0byB0ZXN0IGNyaXNpcyBkZXRlY3Rpb246JywgZXJyb3IpO1xuICAgICAgdGhyb3cgbmV3IEh0dHBFeGNlcHRpb24oXG4gICAgICAgICdGYWlsZWQgdG8gdGVzdCBjcmlzaXMgZGV0ZWN0aW9uJyxcbiAgICAgICAgSHR0cFN0YXR1cy5JTlRFUk5BTF9TRVJWRVJfRVJST1IsXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBCYXRjaCB0ZXN0IG11bHRpcGxlIGNvbnRlbnQgaXRlbXNcbiAgICovXG4gIEBQb3N0KCdzZXJ2aWNlL3Rlc3QtYmF0Y2gnKVxuICBAQXBpT3BlcmF0aW9uKHtcbiAgICBzdW1tYXJ5OiAnQ3JlYXRlIHRlc3QgYmF0Y2ggY2xhc3NpZmljYXRpb24nLFxuXG4gICAgZGVzY3JpcHRpb246ICdDcmVhdGUgdGVzdCBiYXRjaCBjbGFzc2lmaWNhdGlvbicsXG4gIH0pXG4gIEBBcGlSZXNwb25zZSh7XG4gICAgc3RhdHVzOiAyMDEsXG5cbiAgICBkZXNjcmlwdGlvbjogJ0NyZWF0ZWQgc3VjY2Vzc2Z1bGx5JyxcbiAgfSlcbiAgQEFwaVJlc3BvbnNlKHsgc3RhdHVzOiA0MDEsIGRlc2NyaXB0aW9uOiAnVW5hdXRob3JpemVkJyB9KVxuICBASHR0cENvZGUoSHR0cFN0YXR1cy5PSylcbiAgQEFkbWluT25seSgpXG4gIGFzeW5jIHRlc3RCYXRjaENsYXNzaWZpY2F0aW9uKFxuICAgIEBDdXJyZW50VXNlcklkKCkgYWRtaW5JZDogc3RyaW5nLFxuICAgIEBCb2R5KCkgYm9keTogeyBpdGVtczogQXJyYXk8eyB0ZXh0OiBzdHJpbmc7IGNvbnRleHQ6IHN0cmluZyB9PiB9LFxuICApIHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgaXRlbXMgPSBib2R5Lml0ZW1zLm1hcCgoaXRlbSkgPT4gKHtcbiAgICAgICAgdGV4dDogaXRlbS50ZXh0LFxuICAgICAgICBjb250ZXh0OiB7XG4gICAgICAgICAgY29udGV4dDogaXRlbS5jb250ZXh0LFxuICAgICAgICAgIHVzZXJJZDogYWRtaW5JZCxcbiAgICAgICAgICB1c2VyUm9sZTogJ2FkbWluJyBhcyBjb25zdCxcbiAgICAgICAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKCksXG4gICAgICAgIH0sXG4gICAgICB9KSk7XG5cbiAgICAgIGNvbnN0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLm1vZGVyYXRpb25TZXJ2aWNlLmJhdGNoQ2xhc3NpZnkoaXRlbXMpO1xuXG4gICAgICByZXR1cm4ge1xuICAgICAgICByZXN1bHRzLFxuICAgICAgICB0ZXN0SW5mbzoge1xuICAgICAgICAgIHRlc3RlZEJ5OiBhZG1pbklkLFxuICAgICAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUoKSxcbiAgICAgICAgICBpdGVtQ291bnQ6IGl0ZW1zLmxlbmd0aCxcbiAgICAgICAgfSxcbiAgICAgIH07XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRoaXMubG9nZ2VyLmVycm9yKCdGYWlsZWQgdG8gdGVzdCBiYXRjaCBjbGFzc2lmaWNhdGlvbjonLCBlcnJvcik7XG4gICAgICB0aHJvdyBuZXcgSHR0cEV4Y2VwdGlvbihcbiAgICAgICAgJ0ZhaWxlZCB0byB0ZXN0IGJhdGNoIGNsYXNzaWZpY2F0aW9uJyxcbiAgICAgICAgSHR0cFN0YXR1cy5JTlRFUk5BTF9TRVJWRVJfRVJST1IsXG4gICAgICApO1xuICAgIH1cbiAgfVxufVxuIl0sInZlcnNpb24iOjN9