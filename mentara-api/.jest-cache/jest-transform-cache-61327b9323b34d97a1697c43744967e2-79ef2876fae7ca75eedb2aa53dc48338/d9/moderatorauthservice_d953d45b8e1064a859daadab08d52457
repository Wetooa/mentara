d7c3d35e0d6e898d814efeb649c695a0
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var _a, _b, _c;
Object.defineProperty(exports, "__esModule", { value: true });
exports.ModeratorAuthService = void 0;
const common_1 = require("@nestjs/common");
const prisma_client_provider_1 = require("../../providers/prisma-client.provider");
const token_service_1 = require("./token.service");
const email_verification_service_1 = require("./email-verification.service");
const bcrypt = require("bcrypt");
let ModeratorAuthService = class ModeratorAuthService {
    prisma;
    tokenService;
    emailVerificationService;
    constructor(prisma, tokenService, emailVerificationService) {
        this.prisma = prisma;
        this.tokenService = tokenService;
        this.emailVerificationService = emailVerificationService;
    }
    async createModeratorAccount(email, password, firstName, lastName, permissions = [], assignedCommunities = []) {
        // Check if user already exists
        const existingUser = await this.prisma.user.findUnique({
            where: { email },
        });
        if (existingUser) {
            throw new common_1.BadRequestException('User with this email already exists');
        }
        // Hash password
        const hashedPassword = await bcrypt.hash(password, 12);
        // Create user and moderator profile in transaction
        const result = await this.prisma.$transaction(async (tx) => {
            const user = await tx.user.create({
                data: {
                    email,
                    password: hashedPassword,
                    firstName,
                    lastName,
                    role: 'moderator',
                    emailVerified: true, // Moderators are pre-verified
                },
            });
            const moderator = await tx.moderator.create({
                data: {
                    userId: user.id,
                    permissions,
                    assignedCommunities: assignedCommunities.length > 0 ? assignedCommunities : [],
                },
            });
            return { user, moderator };
        });
        return {
            user: result.user,
            message: 'Moderator account created successfully.',
        };
    }
    async loginModerator(email, password, ipAddress, userAgent) {
        // Find user with moderator role
        const user = await this.prisma.user.findFirst({
            where: {
                email,
                role: 'moderator',
            },
            include: {
                moderator: true,
            },
        });
        if (!user) {
            throw new common_1.UnauthorizedException('Invalid credentials');
        }
        // Check if account is locked
        if (user.lockoutUntil && user.lockoutUntil > new Date()) {
            throw new common_1.UnauthorizedException('Account is temporarily locked due to failed login attempts');
        }
        // Verify password
        if (!user.password) {
            throw new common_1.UnauthorizedException('Account setup incomplete');
        }
        const isPasswordValid = await bcrypt.compare(password, user.password);
        if (!isPasswordValid) {
            // Increment failed login count
            await this.handleFailedLogin(user.id);
            throw new common_1.UnauthorizedException('Invalid credentials');
        }
        // Reset failed login count and update last login
        await this.prisma.user.update({
            where: { id: user.id },
            data: {
                failedLoginCount: 0,
                lockoutUntil: null,
                lastLoginAt: new Date(),
            },
        });
        // Generate single token
        const { token } = await this.tokenService.generateToken(user.id, user.email, user.role);
        return {
            user,
            token,
        };
    }
    async getModeratorProfile(userId) {
        const user = await this.prisma.user.findUnique({
            where: { id: userId },
            include: {
                moderator: {
                    include: {
                        moderatorCommunities: {
                            include: {
                                community: {
                                    select: {
                                        id: true,
                                        name: true,
                                        slug: true,
                                    },
                                },
                            },
                        },
                    },
                },
            },
        });
        if (!user || user.role !== 'moderator') {
            throw new common_1.UnauthorizedException('Moderator not found');
        }
        return user;
    }
    async getModeratorPermissions(userId) {
        const moderator = await this.prisma.moderator.findUnique({
            where: { userId },
            select: {
                permissions: true,
                assignedCommunities: true,
            },
        });
        if (!moderator) {
            throw new common_1.UnauthorizedException('Moderator not found');
        }
        return moderator;
    }
    async getAssignedCommunities(userId) {
        const moderator = await this.prisma.moderator.findUnique({
            where: { userId },
            select: {
                assignedCommunities: true,
            },
        });
        if (!moderator) {
            throw new common_1.UnauthorizedException('Moderator not found');
        }
        // If assignedCommunities is stored as JSON array of community IDs
        const communityIds = Array.isArray(moderator.assignedCommunities)
            ? moderator.assignedCommunities
            : [];
        if (communityIds.length === 0) {
            return [];
        }
        // Get the actual community data
        return this.prisma.community.findMany({
            where: {
                id: { in: communityIds },
            },
            select: {
                id: true,
                name: true,
                slug: true,
                description: true,
                createdAt: true,
            },
        });
    }
    async getModeratorDashboardStats(userId) {
        const moderator = await this.prisma.moderator.findUnique({
            where: { userId },
            include: {
                moderatorCommunities: true,
            },
        });
        if (!moderator) {
            throw new common_1.UnauthorizedException('Moderator not found');
        }
        const communityIds = moderator.moderatorCommunities.map((mc) => mc.communityId);
        // Get statistics for communities the moderator manages
        const [totalManagedCommunities, totalMembersInManagedCommunities, totalPostsInManagedCommunities, totalReportsInManagedCommunities,] = await Promise.all([
            this.prisma.community.count({
                where: { id: { in: communityIds } },
            }),
            this.prisma.membership.count({
                where: { communityId: { in: communityIds } },
            }),
            this.prisma.post.count(),
            this.prisma.report.count({
                where: {
                    status: 'PENDING',
                },
            }),
        ]);
        const pendingJoinRequests = 0; // Simplified - no complex join request system
        return {
            totalManagedCommunities,
            totalMembersInManagedCommunities,
            pendingJoinRequests,
            totalPostsInManagedCommunities,
            totalReportsInManagedCommunities,
        };
    }
    async handleFailedLogin(userId) {
        const user = await this.prisma.user.findUnique({
            where: { id: userId },
            select: { failedLoginCount: true },
        });
        const newFailedCount = (user?.failedLoginCount || 0) + 1;
        const maxAttempts = 5;
        const lockoutDuration = 30 * 60 * 1000; // 30 minutes
        const updateData = {
            failedLoginCount: newFailedCount,
        };
        if (newFailedCount >= maxAttempts) {
            updateData.lockoutUntil = new Date(Date.now() + lockoutDuration);
        }
        await this.prisma.user.update({
            where: { id: userId },
            data: updateData,
        });
    }
};
exports.ModeratorAuthService = ModeratorAuthService;
exports.ModeratorAuthService = ModeratorAuthService = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [typeof (_a = typeof prisma_client_provider_1.PrismaService !== "undefined" && prisma_client_provider_1.PrismaService) === "function" ? _a : Object, typeof (_b = typeof token_service_1.TokenService !== "undefined" && token_service_1.TokenService) === "function" ? _b : Object, typeof (_c = typeof email_verification_service_1.EmailVerificationService !== "undefined" && email_verification_service_1.EmailVerificationService) === "function" ? _c : Object])
], ModeratorAuthService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL2F1dGgvc2VydmljZXMvbW9kZXJhdG9yLWF1dGguc2VydmljZS50cyIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7O0FBQUEsMkNBSXdCO0FBQ3hCLG1GQUF1RTtBQUN2RSxtREFBK0M7QUFDL0MsNkVBQXdFO0FBQ3hFLGlDQUFpQztBQUcxQixJQUFNLG9CQUFvQixHQUExQixNQUFNLG9CQUFvQjtJQUVaO0lBQ0E7SUFDQTtJQUhuQixZQUNtQixNQUFxQixFQUNyQixZQUEwQixFQUMxQix3QkFBa0Q7UUFGbEQsV0FBTSxHQUFOLE1BQU0sQ0FBZTtRQUNyQixpQkFBWSxHQUFaLFlBQVksQ0FBYztRQUMxQiw2QkFBd0IsR0FBeEIsd0JBQXdCLENBQTBCO0lBQ2xFLENBQUM7SUFFSixLQUFLLENBQUMsc0JBQXNCLENBQzFCLEtBQWEsRUFDYixRQUFnQixFQUNoQixTQUFpQixFQUNqQixRQUFnQixFQUNoQixjQUF3QixFQUFFLEVBQzFCLHNCQUFnQyxFQUFFO1FBRWxDLCtCQUErQjtRQUMvQixNQUFNLFlBQVksR0FBRyxNQUFNLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQztZQUNyRCxLQUFLLEVBQUUsRUFBRSxLQUFLLEVBQUU7U0FDakIsQ0FBQyxDQUFDO1FBRUgsSUFBSSxZQUFZLEVBQUUsQ0FBQztZQUNqQixNQUFNLElBQUksNEJBQW1CLENBQUMscUNBQXFDLENBQUMsQ0FBQztRQUN2RSxDQUFDO1FBRUQsZ0JBQWdCO1FBQ2hCLE1BQU0sY0FBYyxHQUFHLE1BQU0sTUFBTSxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFFdkQsbURBQW1EO1FBQ25ELE1BQU0sTUFBTSxHQUFHLE1BQU0sSUFBSSxDQUFDLE1BQU0sQ0FBQyxZQUFZLENBQUMsS0FBSyxFQUFFLEVBQUUsRUFBRSxFQUFFO1lBQ3pELE1BQU0sSUFBSSxHQUFHLE1BQU0sRUFBRSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUM7Z0JBQ2hDLElBQUksRUFBRTtvQkFDSixLQUFLO29CQUNMLFFBQVEsRUFBRSxjQUFjO29CQUN4QixTQUFTO29CQUNULFFBQVE7b0JBQ1IsSUFBSSxFQUFFLFdBQVc7b0JBQ2pCLGFBQWEsRUFBRSxJQUFJLEVBQUUsOEJBQThCO2lCQUNwRDthQUNGLENBQUMsQ0FBQztZQUVILE1BQU0sU0FBUyxHQUFHLE1BQU0sRUFBRSxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUM7Z0JBQzFDLElBQUksRUFBRTtvQkFDSixNQUFNLEVBQUUsSUFBSSxDQUFDLEVBQUU7b0JBQ2YsV0FBVztvQkFDWCxtQkFBbUIsRUFDakIsbUJBQW1CLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsbUJBQW1CLENBQUMsQ0FBQyxDQUFDLEVBQUU7aUJBQzVEO2FBQ0YsQ0FBQyxDQUFDO1lBRUgsT0FBTyxFQUFFLElBQUksRUFBRSxTQUFTLEVBQUUsQ0FBQztRQUM3QixDQUFDLENBQUMsQ0FBQztRQUVILE9BQU87WUFDTCxJQUFJLEVBQUUsTUFBTSxDQUFDLElBQUk7WUFDakIsT0FBTyxFQUFFLHlDQUF5QztTQUNuRCxDQUFDO0lBQ0osQ0FBQztJQUVELEtBQUssQ0FBQyxjQUFjLENBQ2xCLEtBQWEsRUFDYixRQUFnQixFQUNoQixTQUFrQixFQUNsQixTQUFrQjtRQUVsQixnQ0FBZ0M7UUFDaEMsTUFBTSxJQUFJLEdBQUcsTUFBTSxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUM7WUFDNUMsS0FBSyxFQUFFO2dCQUNMLEtBQUs7Z0JBQ0wsSUFBSSxFQUFFLFdBQVc7YUFDbEI7WUFDRCxPQUFPLEVBQUU7Z0JBQ1AsU0FBUyxFQUFFLElBQUk7YUFDaEI7U0FDRixDQUFDLENBQUM7UUFFSCxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUM7WUFDVixNQUFNLElBQUksOEJBQXFCLENBQUMscUJBQXFCLENBQUMsQ0FBQztRQUN6RCxDQUFDO1FBRUQsNkJBQTZCO1FBQzdCLElBQUksSUFBSSxDQUFDLFlBQVksSUFBSSxJQUFJLENBQUMsWUFBWSxHQUFHLElBQUksSUFBSSxFQUFFLEVBQUUsQ0FBQztZQUN4RCxNQUFNLElBQUksOEJBQXFCLENBQzdCLDREQUE0RCxDQUM3RCxDQUFDO1FBQ0osQ0FBQztRQUVELGtCQUFrQjtRQUNsQixJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDO1lBQ25CLE1BQU0sSUFBSSw4QkFBcUIsQ0FBQywwQkFBMEIsQ0FBQyxDQUFDO1FBQzlELENBQUM7UUFDRCxNQUFNLGVBQWUsR0FBRyxNQUFNLE1BQU0sQ0FBQyxPQUFPLENBQUMsUUFBUSxFQUFFLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUN0RSxJQUFJLENBQUMsZUFBZSxFQUFFLENBQUM7WUFDckIsK0JBQStCO1lBQy9CLE1BQU0sSUFBSSxDQUFDLGlCQUFpQixDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQztZQUN0QyxNQUFNLElBQUksOEJBQXFCLENBQUMscUJBQXFCLENBQUMsQ0FBQztRQUN6RCxDQUFDO1FBRUQsaURBQWlEO1FBQ2pELE1BQU0sSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDO1lBQzVCLEtBQUssRUFBRSxFQUFFLEVBQUUsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO1lBQ3RCLElBQUksRUFBRTtnQkFDSixnQkFBZ0IsRUFBRSxDQUFDO2dCQUNuQixZQUFZLEVBQUUsSUFBSTtnQkFDbEIsV0FBVyxFQUFFLElBQUksSUFBSSxFQUFFO2FBQ3hCO1NBQ0YsQ0FBQyxDQUFDO1FBRUgsd0JBQXdCO1FBQ3hCLE1BQU0sRUFBRSxLQUFLLEVBQUUsR0FBRyxNQUFNLElBQUksQ0FBQyxZQUFZLENBQUMsYUFBYSxDQUNyRCxJQUFJLENBQUMsRUFBRSxFQUNQLElBQUksQ0FBQyxLQUFLLEVBQ1YsSUFBSSxDQUFDLElBQUksQ0FDVixDQUFDO1FBRUYsT0FBTztZQUNMLElBQUk7WUFDSixLQUFLO1NBQ04sQ0FBQztJQUNKLENBQUM7SUFFRCxLQUFLLENBQUMsbUJBQW1CLENBQUMsTUFBYztRQUN0QyxNQUFNLElBQUksR0FBRyxNQUFNLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQztZQUM3QyxLQUFLLEVBQUUsRUFBRSxFQUFFLEVBQUUsTUFBTSxFQUFFO1lBQ3JCLE9BQU8sRUFBRTtnQkFDUCxTQUFTLEVBQUU7b0JBQ1QsT0FBTyxFQUFFO3dCQUNQLG9CQUFvQixFQUFFOzRCQUNwQixPQUFPLEVBQUU7Z0NBQ1AsU0FBUyxFQUFFO29DQUNULE1BQU0sRUFBRTt3Q0FDTixFQUFFLEVBQUUsSUFBSTt3Q0FDUixJQUFJLEVBQUUsSUFBSTt3Q0FDVixJQUFJLEVBQUUsSUFBSTtxQ0FDWDtpQ0FDRjs2QkFDRjt5QkFDRjtxQkFDRjtpQkFDRjthQUNGO1NBQ0YsQ0FBQyxDQUFDO1FBRUgsSUFBSSxDQUFDLElBQUksSUFBSSxJQUFJLENBQUMsSUFBSSxLQUFLLFdBQVcsRUFBRSxDQUFDO1lBQ3ZDLE1BQU0sSUFBSSw4QkFBcUIsQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDO1FBQ3pELENBQUM7UUFFRCxPQUFPLElBQUksQ0FBQztJQUNkLENBQUM7SUFFRCxLQUFLLENBQUMsdUJBQXVCLENBQUMsTUFBYztRQUMxQyxNQUFNLFNBQVMsR0FBRyxNQUFNLElBQUksQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDLFVBQVUsQ0FBQztZQUN2RCxLQUFLLEVBQUUsRUFBRSxNQUFNLEVBQUU7WUFDakIsTUFBTSxFQUFFO2dCQUNOLFdBQVcsRUFBRSxJQUFJO2dCQUNqQixtQkFBbUIsRUFBRSxJQUFJO2FBQzFCO1NBQ0YsQ0FBQyxDQUFDO1FBRUgsSUFBSSxDQUFDLFNBQVMsRUFBRSxDQUFDO1lBQ2YsTUFBTSxJQUFJLDhCQUFxQixDQUFDLHFCQUFxQixDQUFDLENBQUM7UUFDekQsQ0FBQztRQUVELE9BQU8sU0FBUyxDQUFDO0lBQ25CLENBQUM7SUFFRCxLQUFLLENBQUMsc0JBQXNCLENBQUMsTUFBYztRQUN6QyxNQUFNLFNBQVMsR0FBRyxNQUFNLElBQUksQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDLFVBQVUsQ0FBQztZQUN2RCxLQUFLLEVBQUUsRUFBRSxNQUFNLEVBQUU7WUFDakIsTUFBTSxFQUFFO2dCQUNOLG1CQUFtQixFQUFFLElBQUk7YUFDMUI7U0FDRixDQUFDLENBQUM7UUFFSCxJQUFJLENBQUMsU0FBUyxFQUFFLENBQUM7WUFDZixNQUFNLElBQUksOEJBQXFCLENBQUMscUJBQXFCLENBQUMsQ0FBQztRQUN6RCxDQUFDO1FBRUQsa0VBQWtFO1FBQ2xFLE1BQU0sWUFBWSxHQUFHLEtBQUssQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLG1CQUFtQixDQUFDO1lBQy9ELENBQUMsQ0FBRSxTQUFTLENBQUMsbUJBQWdDO1lBQzdDLENBQUMsQ0FBQyxFQUFFLENBQUM7UUFFUCxJQUFJLFlBQVksQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFLENBQUM7WUFDOUIsT0FBTyxFQUFFLENBQUM7UUFDWixDQUFDO1FBRUQsZ0NBQWdDO1FBQ2hDLE9BQU8sSUFBSSxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDO1lBQ3BDLEtBQUssRUFBRTtnQkFDTCxFQUFFLEVBQUUsRUFBRSxFQUFFLEVBQUUsWUFBWSxFQUFFO2FBQ3pCO1lBQ0QsTUFBTSxFQUFFO2dCQUNOLEVBQUUsRUFBRSxJQUFJO2dCQUNSLElBQUksRUFBRSxJQUFJO2dCQUNWLElBQUksRUFBRSxJQUFJO2dCQUNWLFdBQVcsRUFBRSxJQUFJO2dCQUNqQixTQUFTLEVBQUUsSUFBSTthQUNoQjtTQUNGLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFRCxLQUFLLENBQUMsMEJBQTBCLENBQUMsTUFBYztRQUM3QyxNQUFNLFNBQVMsR0FBRyxNQUFNLElBQUksQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDLFVBQVUsQ0FBQztZQUN2RCxLQUFLLEVBQUUsRUFBRSxNQUFNLEVBQUU7WUFDakIsT0FBTyxFQUFFO2dCQUNQLG9CQUFvQixFQUFFLElBQUk7YUFDM0I7U0FDRixDQUFDLENBQUM7UUFFSCxJQUFJLENBQUMsU0FBUyxFQUFFLENBQUM7WUFDZixNQUFNLElBQUksOEJBQXFCLENBQUMscUJBQXFCLENBQUMsQ0FBQztRQUN6RCxDQUFDO1FBRUQsTUFBTSxZQUFZLEdBQUcsU0FBUyxDQUFDLG9CQUFvQixDQUFDLEdBQUcsQ0FDckQsQ0FBQyxFQUFFLEVBQUUsRUFBRSxDQUFDLEVBQUUsQ0FBQyxXQUFXLENBQ3ZCLENBQUM7UUFFRix1REFBdUQ7UUFDdkQsTUFBTSxDQUNKLHVCQUF1QixFQUN2QixnQ0FBZ0MsRUFDaEMsOEJBQThCLEVBQzlCLGdDQUFnQyxFQUNqQyxHQUFHLE1BQU0sT0FBTyxDQUFDLEdBQUcsQ0FBQztZQUNwQixJQUFJLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUM7Z0JBQzFCLEtBQUssRUFBRSxFQUFFLEVBQUUsRUFBRSxFQUFFLEVBQUUsRUFBRSxZQUFZLEVBQUUsRUFBRTthQUNwQyxDQUFDO1lBQ0YsSUFBSSxDQUFDLE1BQU0sQ0FBQyxVQUFVLENBQUMsS0FBSyxDQUFDO2dCQUMzQixLQUFLLEVBQUUsRUFBRSxXQUFXLEVBQUUsRUFBRSxFQUFFLEVBQUUsWUFBWSxFQUFFLEVBQUU7YUFDN0MsQ0FBQztZQUNGLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEtBQUssRUFBRTtZQUN4QixJQUFJLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUM7Z0JBQ3ZCLEtBQUssRUFBRTtvQkFDTCxNQUFNLEVBQUUsU0FBUztpQkFDbEI7YUFDRixDQUFDO1NBQ0gsQ0FBQyxDQUFDO1FBRUgsTUFBTSxtQkFBbUIsR0FBRyxDQUFDLENBQUMsQ0FBQyw4Q0FBOEM7UUFFN0UsT0FBTztZQUNMLHVCQUF1QjtZQUN2QixnQ0FBZ0M7WUFDaEMsbUJBQW1CO1lBQ25CLDhCQUE4QjtZQUM5QixnQ0FBZ0M7U0FDakMsQ0FBQztJQUNKLENBQUM7SUFFTyxLQUFLLENBQUMsaUJBQWlCLENBQUMsTUFBYztRQUM1QyxNQUFNLElBQUksR0FBRyxNQUFNLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQztZQUM3QyxLQUFLLEVBQUUsRUFBRSxFQUFFLEVBQUUsTUFBTSxFQUFFO1lBQ3JCLE1BQU0sRUFBRSxFQUFFLGdCQUFnQixFQUFFLElBQUksRUFBRTtTQUNuQyxDQUFDLENBQUM7UUFFSCxNQUFNLGNBQWMsR0FBRyxDQUFDLElBQUksRUFBRSxnQkFBZ0IsSUFBSSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDekQsTUFBTSxXQUFXLEdBQUcsQ0FBQyxDQUFDO1FBQ3RCLE1BQU0sZUFBZSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsSUFBSSxDQUFDLENBQUMsYUFBYTtRQUVyRCxNQUFNLFVBQVUsR0FBUTtZQUN0QixnQkFBZ0IsRUFBRSxjQUFjO1NBQ2pDLENBQUM7UUFFRixJQUFJLGNBQWMsSUFBSSxXQUFXLEVBQUUsQ0FBQztZQUNsQyxVQUFVLENBQUMsWUFBWSxHQUFHLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsR0FBRyxlQUFlLENBQUMsQ0FBQztRQUNuRSxDQUFDO1FBRUQsTUFBTSxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUM7WUFDNUIsS0FBSyxFQUFFLEVBQUUsRUFBRSxFQUFFLE1BQU0sRUFBRTtZQUNyQixJQUFJLEVBQUUsVUFBVTtTQUNqQixDQUFDLENBQUM7SUFDTCxDQUFDO0NBQ0YsQ0FBQTtBQWhSWSxvREFBb0I7K0JBQXBCLG9CQUFvQjtJQURoQyxJQUFBLG1CQUFVLEdBQUU7eURBR2dCLHNDQUFhLG9CQUFiLHNDQUFhLG9EQUNQLDRCQUFZLG9CQUFaLDRCQUFZLG9EQUNBLHFEQUF3QixvQkFBeEIscURBQXdCO0dBSjFELG9CQUFvQixDQWdSaEMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL2F1dGgvc2VydmljZXMvbW9kZXJhdG9yLWF1dGguc2VydmljZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBJbmplY3RhYmxlLFxuICBVbmF1dGhvcml6ZWRFeGNlcHRpb24sXG4gIEJhZFJlcXVlc3RFeGNlcHRpb24sXG59IGZyb20gJ0BuZXN0anMvY29tbW9uJztcbmltcG9ydCB7IFByaXNtYVNlcnZpY2UgfSBmcm9tICcuLi8uLi9wcm92aWRlcnMvcHJpc21hLWNsaWVudC5wcm92aWRlcic7XG5pbXBvcnQgeyBUb2tlblNlcnZpY2UgfSBmcm9tICcuL3Rva2VuLnNlcnZpY2UnO1xuaW1wb3J0IHsgRW1haWxWZXJpZmljYXRpb25TZXJ2aWNlIH0gZnJvbSAnLi9lbWFpbC12ZXJpZmljYXRpb24uc2VydmljZSc7XG5pbXBvcnQgKiBhcyBiY3J5cHQgZnJvbSAnYmNyeXB0JztcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIE1vZGVyYXRvckF1dGhTZXJ2aWNlIHtcbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSByZWFkb25seSBwcmlzbWE6IFByaXNtYVNlcnZpY2UsXG4gICAgcHJpdmF0ZSByZWFkb25seSB0b2tlblNlcnZpY2U6IFRva2VuU2VydmljZSxcbiAgICBwcml2YXRlIHJlYWRvbmx5IGVtYWlsVmVyaWZpY2F0aW9uU2VydmljZTogRW1haWxWZXJpZmljYXRpb25TZXJ2aWNlLFxuICApIHt9XG5cbiAgYXN5bmMgY3JlYXRlTW9kZXJhdG9yQWNjb3VudChcbiAgICBlbWFpbDogc3RyaW5nLFxuICAgIHBhc3N3b3JkOiBzdHJpbmcsXG4gICAgZmlyc3ROYW1lOiBzdHJpbmcsXG4gICAgbGFzdE5hbWU6IHN0cmluZyxcbiAgICBwZXJtaXNzaW9uczogc3RyaW5nW10gPSBbXSxcbiAgICBhc3NpZ25lZENvbW11bml0aWVzOiBzdHJpbmdbXSA9IFtdLFxuICApIHtcbiAgICAvLyBDaGVjayBpZiB1c2VyIGFscmVhZHkgZXhpc3RzXG4gICAgY29uc3QgZXhpc3RpbmdVc2VyID0gYXdhaXQgdGhpcy5wcmlzbWEudXNlci5maW5kVW5pcXVlKHtcbiAgICAgIHdoZXJlOiB7IGVtYWlsIH0sXG4gICAgfSk7XG5cbiAgICBpZiAoZXhpc3RpbmdVc2VyKSB7XG4gICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdEV4Y2VwdGlvbignVXNlciB3aXRoIHRoaXMgZW1haWwgYWxyZWFkeSBleGlzdHMnKTtcbiAgICB9XG5cbiAgICAvLyBIYXNoIHBhc3N3b3JkXG4gICAgY29uc3QgaGFzaGVkUGFzc3dvcmQgPSBhd2FpdCBiY3J5cHQuaGFzaChwYXNzd29yZCwgMTIpO1xuXG4gICAgLy8gQ3JlYXRlIHVzZXIgYW5kIG1vZGVyYXRvciBwcm9maWxlIGluIHRyYW5zYWN0aW9uXG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgdGhpcy5wcmlzbWEuJHRyYW5zYWN0aW9uKGFzeW5jICh0eCkgPT4ge1xuICAgICAgY29uc3QgdXNlciA9IGF3YWl0IHR4LnVzZXIuY3JlYXRlKHtcbiAgICAgICAgZGF0YToge1xuICAgICAgICAgIGVtYWlsLFxuICAgICAgICAgIHBhc3N3b3JkOiBoYXNoZWRQYXNzd29yZCxcbiAgICAgICAgICBmaXJzdE5hbWUsXG4gICAgICAgICAgbGFzdE5hbWUsXG4gICAgICAgICAgcm9sZTogJ21vZGVyYXRvcicsXG4gICAgICAgICAgZW1haWxWZXJpZmllZDogdHJ1ZSwgLy8gTW9kZXJhdG9ycyBhcmUgcHJlLXZlcmlmaWVkXG4gICAgICAgIH0sXG4gICAgICB9KTtcblxuICAgICAgY29uc3QgbW9kZXJhdG9yID0gYXdhaXQgdHgubW9kZXJhdG9yLmNyZWF0ZSh7XG4gICAgICAgIGRhdGE6IHtcbiAgICAgICAgICB1c2VySWQ6IHVzZXIuaWQsXG4gICAgICAgICAgcGVybWlzc2lvbnMsXG4gICAgICAgICAgYXNzaWduZWRDb21tdW5pdGllczpcbiAgICAgICAgICAgIGFzc2lnbmVkQ29tbXVuaXRpZXMubGVuZ3RoID4gMCA/IGFzc2lnbmVkQ29tbXVuaXRpZXMgOiBbXSxcbiAgICAgICAgfSxcbiAgICAgIH0pO1xuXG4gICAgICByZXR1cm4geyB1c2VyLCBtb2RlcmF0b3IgfTtcbiAgICB9KTtcblxuICAgIHJldHVybiB7XG4gICAgICB1c2VyOiByZXN1bHQudXNlcixcbiAgICAgIG1lc3NhZ2U6ICdNb2RlcmF0b3IgYWNjb3VudCBjcmVhdGVkIHN1Y2Nlc3NmdWxseS4nLFxuICAgIH07XG4gIH1cblxuICBhc3luYyBsb2dpbk1vZGVyYXRvcihcbiAgICBlbWFpbDogc3RyaW5nLFxuICAgIHBhc3N3b3JkOiBzdHJpbmcsXG4gICAgaXBBZGRyZXNzPzogc3RyaW5nLFxuICAgIHVzZXJBZ2VudD86IHN0cmluZyxcbiAgKSB7XG4gICAgLy8gRmluZCB1c2VyIHdpdGggbW9kZXJhdG9yIHJvbGVcbiAgICBjb25zdCB1c2VyID0gYXdhaXQgdGhpcy5wcmlzbWEudXNlci5maW5kRmlyc3Qoe1xuICAgICAgd2hlcmU6IHtcbiAgICAgICAgZW1haWwsXG4gICAgICAgIHJvbGU6ICdtb2RlcmF0b3InLFxuICAgICAgfSxcbiAgICAgIGluY2x1ZGU6IHtcbiAgICAgICAgbW9kZXJhdG9yOiB0cnVlLFxuICAgICAgfSxcbiAgICB9KTtcblxuICAgIGlmICghdXNlcikge1xuICAgICAgdGhyb3cgbmV3IFVuYXV0aG9yaXplZEV4Y2VwdGlvbignSW52YWxpZCBjcmVkZW50aWFscycpO1xuICAgIH1cblxuICAgIC8vIENoZWNrIGlmIGFjY291bnQgaXMgbG9ja2VkXG4gICAgaWYgKHVzZXIubG9ja291dFVudGlsICYmIHVzZXIubG9ja291dFVudGlsID4gbmV3IERhdGUoKSkge1xuICAgICAgdGhyb3cgbmV3IFVuYXV0aG9yaXplZEV4Y2VwdGlvbihcbiAgICAgICAgJ0FjY291bnQgaXMgdGVtcG9yYXJpbHkgbG9ja2VkIGR1ZSB0byBmYWlsZWQgbG9naW4gYXR0ZW1wdHMnLFxuICAgICAgKTtcbiAgICB9XG5cbiAgICAvLyBWZXJpZnkgcGFzc3dvcmRcbiAgICBpZiAoIXVzZXIucGFzc3dvcmQpIHtcbiAgICAgIHRocm93IG5ldyBVbmF1dGhvcml6ZWRFeGNlcHRpb24oJ0FjY291bnQgc2V0dXAgaW5jb21wbGV0ZScpO1xuICAgIH1cbiAgICBjb25zdCBpc1Bhc3N3b3JkVmFsaWQgPSBhd2FpdCBiY3J5cHQuY29tcGFyZShwYXNzd29yZCwgdXNlci5wYXNzd29yZCk7XG4gICAgaWYgKCFpc1Bhc3N3b3JkVmFsaWQpIHtcbiAgICAgIC8vIEluY3JlbWVudCBmYWlsZWQgbG9naW4gY291bnRcbiAgICAgIGF3YWl0IHRoaXMuaGFuZGxlRmFpbGVkTG9naW4odXNlci5pZCk7XG4gICAgICB0aHJvdyBuZXcgVW5hdXRob3JpemVkRXhjZXB0aW9uKCdJbnZhbGlkIGNyZWRlbnRpYWxzJyk7XG4gICAgfVxuXG4gICAgLy8gUmVzZXQgZmFpbGVkIGxvZ2luIGNvdW50IGFuZCB1cGRhdGUgbGFzdCBsb2dpblxuICAgIGF3YWl0IHRoaXMucHJpc21hLnVzZXIudXBkYXRlKHtcbiAgICAgIHdoZXJlOiB7IGlkOiB1c2VyLmlkIH0sXG4gICAgICBkYXRhOiB7XG4gICAgICAgIGZhaWxlZExvZ2luQ291bnQ6IDAsXG4gICAgICAgIGxvY2tvdXRVbnRpbDogbnVsbCxcbiAgICAgICAgbGFzdExvZ2luQXQ6IG5ldyBEYXRlKCksXG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgLy8gR2VuZXJhdGUgc2luZ2xlIHRva2VuXG4gICAgY29uc3QgeyB0b2tlbiB9ID0gYXdhaXQgdGhpcy50b2tlblNlcnZpY2UuZ2VuZXJhdGVUb2tlbihcbiAgICAgIHVzZXIuaWQsXG4gICAgICB1c2VyLmVtYWlsLFxuICAgICAgdXNlci5yb2xlLFxuICAgICk7XG5cbiAgICByZXR1cm4ge1xuICAgICAgdXNlcixcbiAgICAgIHRva2VuLFxuICAgIH07XG4gIH1cblxuICBhc3luYyBnZXRNb2RlcmF0b3JQcm9maWxlKHVzZXJJZDogc3RyaW5nKSB7XG4gICAgY29uc3QgdXNlciA9IGF3YWl0IHRoaXMucHJpc21hLnVzZXIuZmluZFVuaXF1ZSh7XG4gICAgICB3aGVyZTogeyBpZDogdXNlcklkIH0sXG4gICAgICBpbmNsdWRlOiB7XG4gICAgICAgIG1vZGVyYXRvcjoge1xuICAgICAgICAgIGluY2x1ZGU6IHtcbiAgICAgICAgICAgIG1vZGVyYXRvckNvbW11bml0aWVzOiB7XG4gICAgICAgICAgICAgIGluY2x1ZGU6IHtcbiAgICAgICAgICAgICAgICBjb21tdW5pdHk6IHtcbiAgICAgICAgICAgICAgICAgIHNlbGVjdDoge1xuICAgICAgICAgICAgICAgICAgICBpZDogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgICAgbmFtZTogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgICAgc2x1ZzogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICBpZiAoIXVzZXIgfHwgdXNlci5yb2xlICE9PSAnbW9kZXJhdG9yJykge1xuICAgICAgdGhyb3cgbmV3IFVuYXV0aG9yaXplZEV4Y2VwdGlvbignTW9kZXJhdG9yIG5vdCBmb3VuZCcpO1xuICAgIH1cblxuICAgIHJldHVybiB1c2VyO1xuICB9XG5cbiAgYXN5bmMgZ2V0TW9kZXJhdG9yUGVybWlzc2lvbnModXNlcklkOiBzdHJpbmcpIHtcbiAgICBjb25zdCBtb2RlcmF0b3IgPSBhd2FpdCB0aGlzLnByaXNtYS5tb2RlcmF0b3IuZmluZFVuaXF1ZSh7XG4gICAgICB3aGVyZTogeyB1c2VySWQgfSxcbiAgICAgIHNlbGVjdDoge1xuICAgICAgICBwZXJtaXNzaW9uczogdHJ1ZSxcbiAgICAgICAgYXNzaWduZWRDb21tdW5pdGllczogdHJ1ZSxcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICBpZiAoIW1vZGVyYXRvcikge1xuICAgICAgdGhyb3cgbmV3IFVuYXV0aG9yaXplZEV4Y2VwdGlvbignTW9kZXJhdG9yIG5vdCBmb3VuZCcpO1xuICAgIH1cblxuICAgIHJldHVybiBtb2RlcmF0b3I7XG4gIH1cblxuICBhc3luYyBnZXRBc3NpZ25lZENvbW11bml0aWVzKHVzZXJJZDogc3RyaW5nKSB7XG4gICAgY29uc3QgbW9kZXJhdG9yID0gYXdhaXQgdGhpcy5wcmlzbWEubW9kZXJhdG9yLmZpbmRVbmlxdWUoe1xuICAgICAgd2hlcmU6IHsgdXNlcklkIH0sXG4gICAgICBzZWxlY3Q6IHtcbiAgICAgICAgYXNzaWduZWRDb21tdW5pdGllczogdHJ1ZSxcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICBpZiAoIW1vZGVyYXRvcikge1xuICAgICAgdGhyb3cgbmV3IFVuYXV0aG9yaXplZEV4Y2VwdGlvbignTW9kZXJhdG9yIG5vdCBmb3VuZCcpO1xuICAgIH1cblxuICAgIC8vIElmIGFzc2lnbmVkQ29tbXVuaXRpZXMgaXMgc3RvcmVkIGFzIEpTT04gYXJyYXkgb2YgY29tbXVuaXR5IElEc1xuICAgIGNvbnN0IGNvbW11bml0eUlkcyA9IEFycmF5LmlzQXJyYXkobW9kZXJhdG9yLmFzc2lnbmVkQ29tbXVuaXRpZXMpXG4gICAgICA/IChtb2RlcmF0b3IuYXNzaWduZWRDb21tdW5pdGllcyBhcyBzdHJpbmdbXSlcbiAgICAgIDogW107XG5cbiAgICBpZiAoY29tbXVuaXR5SWRzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgcmV0dXJuIFtdO1xuICAgIH1cblxuICAgIC8vIEdldCB0aGUgYWN0dWFsIGNvbW11bml0eSBkYXRhXG4gICAgcmV0dXJuIHRoaXMucHJpc21hLmNvbW11bml0eS5maW5kTWFueSh7XG4gICAgICB3aGVyZToge1xuICAgICAgICBpZDogeyBpbjogY29tbXVuaXR5SWRzIH0sXG4gICAgICB9LFxuICAgICAgc2VsZWN0OiB7XG4gICAgICAgIGlkOiB0cnVlLFxuICAgICAgICBuYW1lOiB0cnVlLFxuICAgICAgICBzbHVnOiB0cnVlLFxuICAgICAgICBkZXNjcmlwdGlvbjogdHJ1ZSxcbiAgICAgICAgY3JlYXRlZEF0OiB0cnVlLFxuICAgICAgfSxcbiAgICB9KTtcbiAgfVxuXG4gIGFzeW5jIGdldE1vZGVyYXRvckRhc2hib2FyZFN0YXRzKHVzZXJJZDogc3RyaW5nKSB7XG4gICAgY29uc3QgbW9kZXJhdG9yID0gYXdhaXQgdGhpcy5wcmlzbWEubW9kZXJhdG9yLmZpbmRVbmlxdWUoe1xuICAgICAgd2hlcmU6IHsgdXNlcklkIH0sXG4gICAgICBpbmNsdWRlOiB7XG4gICAgICAgIG1vZGVyYXRvckNvbW11bml0aWVzOiB0cnVlLFxuICAgICAgfSxcbiAgICB9KTtcblxuICAgIGlmICghbW9kZXJhdG9yKSB7XG4gICAgICB0aHJvdyBuZXcgVW5hdXRob3JpemVkRXhjZXB0aW9uKCdNb2RlcmF0b3Igbm90IGZvdW5kJyk7XG4gICAgfVxuXG4gICAgY29uc3QgY29tbXVuaXR5SWRzID0gbW9kZXJhdG9yLm1vZGVyYXRvckNvbW11bml0aWVzLm1hcChcbiAgICAgIChtYykgPT4gbWMuY29tbXVuaXR5SWQsXG4gICAgKTtcblxuICAgIC8vIEdldCBzdGF0aXN0aWNzIGZvciBjb21tdW5pdGllcyB0aGUgbW9kZXJhdG9yIG1hbmFnZXNcbiAgICBjb25zdCBbXG4gICAgICB0b3RhbE1hbmFnZWRDb21tdW5pdGllcyxcbiAgICAgIHRvdGFsTWVtYmVyc0luTWFuYWdlZENvbW11bml0aWVzLFxuICAgICAgdG90YWxQb3N0c0luTWFuYWdlZENvbW11bml0aWVzLFxuICAgICAgdG90YWxSZXBvcnRzSW5NYW5hZ2VkQ29tbXVuaXRpZXMsXG4gICAgXSA9IGF3YWl0IFByb21pc2UuYWxsKFtcbiAgICAgIHRoaXMucHJpc21hLmNvbW11bml0eS5jb3VudCh7XG4gICAgICAgIHdoZXJlOiB7IGlkOiB7IGluOiBjb21tdW5pdHlJZHMgfSB9LFxuICAgICAgfSksXG4gICAgICB0aGlzLnByaXNtYS5tZW1iZXJzaGlwLmNvdW50KHtcbiAgICAgICAgd2hlcmU6IHsgY29tbXVuaXR5SWQ6IHsgaW46IGNvbW11bml0eUlkcyB9IH0sXG4gICAgICB9KSxcbiAgICAgIHRoaXMucHJpc21hLnBvc3QuY291bnQoKSxcbiAgICAgIHRoaXMucHJpc21hLnJlcG9ydC5jb3VudCh7XG4gICAgICAgIHdoZXJlOiB7XG4gICAgICAgICAgc3RhdHVzOiAnUEVORElORycsXG4gICAgICAgIH0sXG4gICAgICB9KSxcbiAgICBdKTtcblxuICAgIGNvbnN0IHBlbmRpbmdKb2luUmVxdWVzdHMgPSAwOyAvLyBTaW1wbGlmaWVkIC0gbm8gY29tcGxleCBqb2luIHJlcXVlc3Qgc3lzdGVtXG5cbiAgICByZXR1cm4ge1xuICAgICAgdG90YWxNYW5hZ2VkQ29tbXVuaXRpZXMsXG4gICAgICB0b3RhbE1lbWJlcnNJbk1hbmFnZWRDb21tdW5pdGllcyxcbiAgICAgIHBlbmRpbmdKb2luUmVxdWVzdHMsXG4gICAgICB0b3RhbFBvc3RzSW5NYW5hZ2VkQ29tbXVuaXRpZXMsXG4gICAgICB0b3RhbFJlcG9ydHNJbk1hbmFnZWRDb21tdW5pdGllcyxcbiAgICB9O1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBoYW5kbGVGYWlsZWRMb2dpbih1c2VySWQ6IHN0cmluZykge1xuICAgIGNvbnN0IHVzZXIgPSBhd2FpdCB0aGlzLnByaXNtYS51c2VyLmZpbmRVbmlxdWUoe1xuICAgICAgd2hlcmU6IHsgaWQ6IHVzZXJJZCB9LFxuICAgICAgc2VsZWN0OiB7IGZhaWxlZExvZ2luQ291bnQ6IHRydWUgfSxcbiAgICB9KTtcblxuICAgIGNvbnN0IG5ld0ZhaWxlZENvdW50ID0gKHVzZXI/LmZhaWxlZExvZ2luQ291bnQgfHwgMCkgKyAxO1xuICAgIGNvbnN0IG1heEF0dGVtcHRzID0gNTtcbiAgICBjb25zdCBsb2Nrb3V0RHVyYXRpb24gPSAzMCAqIDYwICogMTAwMDsgLy8gMzAgbWludXRlc1xuXG4gICAgY29uc3QgdXBkYXRlRGF0YTogYW55ID0ge1xuICAgICAgZmFpbGVkTG9naW5Db3VudDogbmV3RmFpbGVkQ291bnQsXG4gICAgfTtcblxuICAgIGlmIChuZXdGYWlsZWRDb3VudCA+PSBtYXhBdHRlbXB0cykge1xuICAgICAgdXBkYXRlRGF0YS5sb2Nrb3V0VW50aWwgPSBuZXcgRGF0ZShEYXRlLm5vdygpICsgbG9ja291dER1cmF0aW9uKTtcbiAgICB9XG5cbiAgICBhd2FpdCB0aGlzLnByaXNtYS51c2VyLnVwZGF0ZSh7XG4gICAgICB3aGVyZTogeyBpZDogdXNlcklkIH0sXG4gICAgICBkYXRhOiB1cGRhdGVEYXRhLFxuICAgIH0pO1xuICB9XG59XG4iXSwidmVyc2lvbiI6M30=