{"file":"/home/wetooa/Documents/code/projects/mentara/mentara-api/src/auth/services/moderator-auth.service.ts","mappings":"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","names":[],"sources":["/home/wetooa/Documents/code/projects/mentara/mentara-api/src/auth/services/moderator-auth.service.ts"],"sourcesContent":["import {\n  Injectable,\n  UnauthorizedException,\n  BadRequestException,\n} from '@nestjs/common';\nimport { PrismaService } from '../../providers/prisma-client.provider';\nimport { TokenService } from './token.service';\nimport { EmailVerificationService } from './email-verification.service';\nimport * as bcrypt from 'bcrypt';\n\n@Injectable()\nexport class ModeratorAuthService {\n  constructor(\n    private readonly prisma: PrismaService,\n    private readonly tokenService: TokenService,\n    private readonly emailVerificationService: EmailVerificationService,\n  ) {}\n\n  async createModeratorAccount(\n    email: string,\n    password: string,\n    firstName: string,\n    lastName: string,\n    permissions: string[] = [],\n    assignedCommunities: string[] = [],\n  ) {\n    // Check if user already exists\n    const existingUser = await this.prisma.user.findUnique({\n      where: { email },\n    });\n\n    if (existingUser) {\n      throw new BadRequestException('User with this email already exists');\n    }\n\n    // Hash password\n    const hashedPassword = await bcrypt.hash(password, 12);\n\n    // Create user and moderator profile in transaction\n    const result = await this.prisma.$transaction(async (tx) => {\n      const user = await tx.user.create({\n        data: {\n          email,\n          password: hashedPassword,\n          firstName,\n          lastName,\n          role: 'moderator',\n          emailVerified: true, // Moderators are pre-verified\n        },\n      });\n\n      const moderator = await tx.moderator.create({\n        data: {\n          userId: user.id,\n          permissions,\n          assignedCommunities:\n            assignedCommunities.length > 0 ? assignedCommunities : [],\n        },\n      });\n\n      return { user, moderator };\n    });\n\n    return {\n      user: result.user,\n      message: 'Moderator account created successfully.',\n    };\n  }\n\n  async loginModerator(\n    email: string,\n    password: string,\n    ipAddress?: string,\n    userAgent?: string,\n  ) {\n    // Find user with moderator role\n    const user = await this.prisma.user.findFirst({\n      where: {\n        email,\n        role: 'moderator',\n      },\n      include: {\n        moderator: true,\n      },\n    });\n\n    if (!user) {\n      throw new UnauthorizedException('Invalid credentials');\n    }\n\n    // Check if account is locked\n    if (user.lockoutUntil && user.lockoutUntil > new Date()) {\n      throw new UnauthorizedException(\n        'Account is temporarily locked due to failed login attempts',\n      );\n    }\n\n    // Verify password\n    if (!user.password) {\n      throw new UnauthorizedException('Account setup incomplete');\n    }\n    const isPasswordValid = await bcrypt.compare(password, user.password);\n    if (!isPasswordValid) {\n      // Increment failed login count\n      await this.handleFailedLogin(user.id);\n      throw new UnauthorizedException('Invalid credentials');\n    }\n\n    // Reset failed login count and update last login\n    await this.prisma.user.update({\n      where: { id: user.id },\n      data: {\n        failedLoginCount: 0,\n        lockoutUntil: null,\n        lastLoginAt: new Date(),\n      },\n    });\n\n    // Generate single token\n    const { token } = await this.tokenService.generateToken(\n      user.id,\n      user.email,\n      user.role,\n    );\n\n    return {\n      user,\n      token,\n    };\n  }\n\n  async getModeratorProfile(userId: string) {\n    const user = await this.prisma.user.findUnique({\n      where: { id: userId },\n      include: {\n        moderator: {\n          include: {\n            moderatorCommunities: {\n              include: {\n                community: {\n                  select: {\n                    id: true,\n                    name: true,\n                    slug: true,\n                  },\n                },\n              },\n            },\n          },\n        },\n      },\n    });\n\n    if (!user || user.role !== 'moderator') {\n      throw new UnauthorizedException('Moderator not found');\n    }\n\n    return user;\n  }\n\n  async getModeratorPermissions(userId: string) {\n    const moderator = await this.prisma.moderator.findUnique({\n      where: { userId },\n      select: {\n        permissions: true,\n        assignedCommunities: true,\n      },\n    });\n\n    if (!moderator) {\n      throw new UnauthorizedException('Moderator not found');\n    }\n\n    return moderator;\n  }\n\n  async getAssignedCommunities(userId: string) {\n    const moderator = await this.prisma.moderator.findUnique({\n      where: { userId },\n      select: {\n        assignedCommunities: true,\n      },\n    });\n\n    if (!moderator) {\n      throw new UnauthorizedException('Moderator not found');\n    }\n\n    // If assignedCommunities is stored as JSON array of community IDs\n    const communityIds = Array.isArray(moderator.assignedCommunities)\n      ? (moderator.assignedCommunities as string[])\n      : [];\n\n    if (communityIds.length === 0) {\n      return [];\n    }\n\n    // Get the actual community data\n    return this.prisma.community.findMany({\n      where: {\n        id: { in: communityIds },\n      },\n      select: {\n        id: true,\n        name: true,\n        slug: true,\n        description: true,\n        createdAt: true,\n      },\n    });\n  }\n\n  async getModeratorDashboardStats(userId: string) {\n    const moderator = await this.prisma.moderator.findUnique({\n      where: { userId },\n      include: {\n        moderatorCommunities: true,\n      },\n    });\n\n    if (!moderator) {\n      throw new UnauthorizedException('Moderator not found');\n    }\n\n    const communityIds = moderator.moderatorCommunities.map(\n      (mc) => mc.communityId,\n    );\n\n    // Get statistics for communities the moderator manages\n    const [\n      totalManagedCommunities,\n      totalMembersInManagedCommunities,\n      totalPostsInManagedCommunities,\n      totalReportsInManagedCommunities,\n    ] = await Promise.all([\n      this.prisma.community.count({\n        where: { id: { in: communityIds } },\n      }),\n      this.prisma.membership.count({\n        where: { communityId: { in: communityIds } },\n      }),\n      this.prisma.post.count(),\n      this.prisma.report.count({\n        where: {\n          status: 'PENDING',\n        },\n      }),\n    ]);\n\n    const pendingJoinRequests = 0; // Simplified - no complex join request system\n\n    return {\n      totalManagedCommunities,\n      totalMembersInManagedCommunities,\n      pendingJoinRequests,\n      totalPostsInManagedCommunities,\n      totalReportsInManagedCommunities,\n    };\n  }\n\n  private async handleFailedLogin(userId: string) {\n    const user = await this.prisma.user.findUnique({\n      where: { id: userId },\n      select: { failedLoginCount: true },\n    });\n\n    const newFailedCount = (user?.failedLoginCount || 0) + 1;\n    const maxAttempts = 5;\n    const lockoutDuration = 30 * 60 * 1000; // 30 minutes\n\n    const updateData: any = {\n      failedLoginCount: newFailedCount,\n    };\n\n    if (newFailedCount >= maxAttempts) {\n      updateData.lockoutUntil = new Date(Date.now() + lockoutDuration);\n    }\n\n    await this.prisma.user.update({\n      where: { id: userId },\n      data: updateData,\n    });\n  }\n}\n"],"version":3}