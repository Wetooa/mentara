{"file":"/home/wetooa/Documents/code/projects/mentara/mentara-api/src/worksheets/worksheets.service.ts","mappings":"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","names":[],"sources":["/home/wetooa/Documents/code/projects/mentara/mentara-api/src/worksheets/worksheets.service.ts"],"sourcesContent":["import { Injectable, NotFoundException } from '@nestjs/common';\nimport { PrismaService } from 'src/providers/prisma-client.provider';\nimport {\n  WorksheetCreateInputDto,\n  WorksheetSubmissionCreateInputDto,\n  WorksheetUpdateInputDto,\n} from 'mentara-commons';\n\n@Injectable()\nexport class WorksheetsService {\n  constructor(private readonly prisma: PrismaService) {}\n\n  async findAll(\n    userId?: string,\n    therapistId?: string,\n    status?: string,\n  ): Promise<any[]> {\n    const where = {};\n\n    if (userId) {\n      where['clientId'] = userId; // Use clientId for proper relation\n    }\n\n    if (therapistId) {\n      where['therapistId'] = therapistId;\n    }\n\n    if (status) {\n      where['status'] = status;\n    }\n\n    const worksheets = await this.prisma.worksheet.findMany({\n      where,\n      include: {\n        client: {\n          include: {\n            user: {\n              select: {\n                id: true,\n                firstName: true,\n                lastName: true,\n                avatarUrl: true,\n              },\n            },\n          },\n        },\n        therapist: {\n          include: {\n            user: {\n              select: {\n                id: true,\n                firstName: true,\n                lastName: true,\n                avatarUrl: true,\n              },\n            },\n          },\n        },\n      },\n      orderBy: {\n        createdAt: 'desc',\n      },\n    });\n\n    return worksheets;\n  }\n\n  async findById(id: string) {\n    const worksheet = await this.prisma.worksheet.findUnique({\n      where: { id },\n      include: {\n        client: {\n          include: {\n            user: {\n              select: {\n                id: true,\n                firstName: true,\n                lastName: true,\n                avatarUrl: true,\n              },\n            },\n          },\n        },\n        therapist: {\n          include: {\n            user: {\n              select: {\n                id: true,\n                firstName: true,\n                lastName: true,\n                avatarUrl: true,\n              },\n            },\n          },\n        },\n      },\n    });\n\n    if (!worksheet) {\n      throw new NotFoundException(`Worksheet with ID ${id} not found`);\n    }\n\n    // Transform the inline arrays into the expected format for backward compatibility\n    return {\n      ...worksheet,\n      materials: worksheet.materialUrls.map((url, index) => ({\n        id: `material-${index}`,\n        filename: worksheet.materialNames[index] || 'Unknown',\n        url,\n        fileType: 'application/octet-stream',\n        fileSize: worksheet.materialSizes[index] || 0,\n      })),\n      submissions: worksheet.submissionUrls.map((url, index) => ({\n        id: `submission-${index}`,\n        filename: worksheet.submissionNames[index] || 'Unknown',\n        url,\n        fileType: 'application/octet-stream',\n        fileSize: worksheet.submissionSizes[index] || 0,\n        submittedAt: worksheet.submittedAt,\n      })),\n    };\n  }\n\n  async create(\n    data: WorksheetCreateInputDto,\n    clientId: string,\n    therapistId: string,\n    files: Express.Multer.File[] = [],\n  ) {\n    // Create the worksheet\n    const worksheet = await this.prisma.worksheet.create({\n      data: {\n        title: data.title,\n        instructions: data.instructions,\n        description: data.description,\n        dueDate: data.dueDate || new Date(),\n        status: (data as any).status || 'assigned',\n        isCompleted: (data as any).isCompleted || false,\n        clientId,\n        therapistId,\n        // Files are now handled separately via upload endpoint\n        // These arrays will be populated when files are uploaded\n        materialUrls: [],\n        materialNames: [],\n        materialSizes: [],\n        submissionUrls: [],\n        submissionNames: [],\n        submissionSizes: [],\n      },\n    });\n\n    // Return the newly created worksheet\n    return this.findById(worksheet.id);\n  }\n\n  async update(id: string, data: WorksheetUpdateInputDto) {\n    // Check if worksheet exists\n    const exists = await this.prisma.worksheet.findUnique({\n      where: { id },\n    });\n\n    if (!exists) {\n      throw new NotFoundException(`Worksheet with ID ${id} not found`);\n    }\n\n    // Update the worksheet\n    await this.prisma.worksheet.update({\n      where: { id },\n      data,\n    });\n\n    // Return the updated worksheet\n    return this.findById(id);\n  }\n\n  async delete(id: string) {\n    // Check if worksheet exists\n    const exists = await this.prisma.worksheet.findUnique({\n      where: { id },\n    });\n\n    if (!exists) {\n      throw new NotFoundException(`Worksheet with ID ${id} not found`);\n    }\n\n    // Delete the worksheet (files in Supabase Storage should be cleaned up separately if needed)\n    await this.prisma.worksheet.delete({\n      where: { id },\n    });\n\n    return { success: true, message: 'Worksheet deleted successfully' };\n  }\n\n  async addSubmission(\n    data: WorksheetSubmissionCreateInputDto,\n    clientId: string,\n  ) {\n    // Check if worksheet exists\n    const worksheet = await this.prisma.worksheet.findUnique({\n      where: { id: data.worksheetId },\n      include: { client: true },\n    });\n\n    if (!worksheet) {\n      throw new NotFoundException(\n        `Worksheet with ID ${data.worksheetId} not found`,\n      );\n    }\n\n    // Note: File uploads are now handled separately via the upload endpoint\n    // This method now primarily handles text-based submissions\n    // The worksheet has already been updated with file attachments if any\n\n    // Update the worksheet with submission data\n    const updatedWorksheet = await this.prisma.worksheet.update({\n      where: { id: data.worksheetId },\n      data: {\n        // Store text-based responses or notes\n        feedback: (data as any).notes || null,\n        // Mark as completed if specified\n        isCompleted: data.isCompleted || false,\n        status: data.isCompleted ? 'completed' : 'assigned',\n        submittedAt: data.isCompleted ? new Date() : null,\n      },\n    });\n\n    return {\n      id: updatedWorksheet.id,\n      worksheetId: data.worksheetId,\n      clientId,\n      status: updatedWorksheet.status,\n      submittedAt: updatedWorksheet.submittedAt,\n    };\n  }\n\n  async submitWorksheet(\n    id: string,\n    data: WorksheetSubmissionCreateInputDto,\n    clientId: string,\n  ) {\n    // Check if worksheet exists\n    const worksheet = await this.prisma.worksheet.findUnique({\n      where: { id },\n    });\n\n    if (!worksheet) {\n      throw new NotFoundException(`Worksheet with ID ${id} not found`);\n    }\n\n    // Update worksheet with submission data and mark as completed\n    const updatedWorksheet = await this.prisma.worksheet.update({\n      where: { id },\n      data: {\n        feedback: (data as any).notes || null,\n        isCompleted: true,\n        status: 'completed',\n        submittedAt: new Date(),\n        // File attachments are handled separately via upload endpoint\n      },\n    });\n\n    return {\n      worksheetId: id,\n      submissionId: id, // Use worksheet ID as submission ID since they're now unified\n      status: updatedWorksheet.status,\n      submittedAt: updatedWorksheet.submittedAt,\n      message: 'Worksheet submitted successfully',\n    };\n  }\n\n  async deleteSubmission(id: string) {\n    // Since submissions are now inline, we reset the worksheet submission status\n    const worksheet = await this.prisma.worksheet.findUnique({\n      where: { id },\n    });\n\n    if (!worksheet) {\n      throw new NotFoundException(`Worksheet with ID ${id} not found`);\n    }\n\n    // Reset submission status\n    await this.prisma.worksheet.update({\n      where: { id },\n      data: {\n        isCompleted: false,\n        status: 'assigned',\n        submittedAt: null,\n        feedback: null,\n        // Clear submission files but keep materials\n        submissionUrls: [],\n        submissionNames: [],\n        submissionSizes: [],\n      },\n    });\n\n    return { success: true, message: 'Submission reset successfully' };\n  }\n}\n"],"version":3}