{"file":"/home/wetooa/Documents/code/projects/mentara/mentara-api/src/posts/posts.controller.ts","mappings":"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","names":[],"sources":["/home/wetooa/Documents/code/projects/mentara/mentara-api/src/posts/posts.controller.ts"],"sourcesContent":["import {\n  Controller,\n  Get,\n  Post,\n  Body,\n  Param,\n  Put,\n  Delete,\n  HttpException,\n  HttpStatus,\n  UseGuards,\n  UseInterceptors,\n  UploadedFiles,\n} from '@nestjs/common';\nimport { FilesInterceptor } from '@nestjs/platform-express';\nimport { JwtAuthGuard } from 'src/auth/guards/jwt-auth.guard';\nimport {\n  CommunityAccessGuard,\n  RequireRoomAccess,\n  RequirePostingRole,\n} from 'src/auth/guards/community-access.guard';\nimport { CurrentUserId } from 'src/auth/decorators/current-user-id.decorator';\nimport {\n  SupabaseStorageService,\n  FileUploadResult,\n} from 'src/common/services/supabase-storage.service';\nimport { PostsService } from './posts.service';\nimport { Post as PostEntity, Prisma } from '@prisma/client';\nimport type { PostCreateInputDto, PostUpdateInputDto } from './types';\n\n@Controller('posts')\n@UseGuards(JwtAuthGuard, CommunityAccessGuard)\nexport class PostsController {\n  constructor(\n    private readonly postsService: PostsService,\n    private readonly supabaseStorageService: SupabaseStorageService,\n  ) {}\n\n  @Get()\n  async findAll(@CurrentUserId() id: string): Promise<PostEntity[]> {\n    try {\n      const user = await this.postsService.findUserById(id);\n\n      return await this.postsService.findAll(user?.id);\n    } catch (error) {\n      throw new HttpException(\n        `Failed to fetch posts: ${error instanceof Error ? error.message : 'Unknown error'}`,\n        HttpStatus.INTERNAL_SERVER_ERROR,\n      );\n    }\n  }\n\n  @Get(':id')\n  @RequireRoomAccess()\n  async findOne(\n    @Param('id') postId: string,\n    @CurrentUserId() userId: string,\n  ): Promise<PostEntity> {\n    try {\n      const post = await this.postsService.findOne(postId, userId);\n\n      if (!post) {\n        throw new HttpException('Post not found', HttpStatus.NOT_FOUND);\n      }\n      return post;\n    } catch (error) {\n      throw new HttpException(\n        `Failed to fetch post: ${error instanceof Error ? error.message : 'Unknown error'}`,\n        HttpStatus.INTERNAL_SERVER_ERROR,\n      );\n    }\n  }\n\n  @Post()\n  @RequirePostingRole()\n  @UseInterceptors(FilesInterceptor('files', 10)) // Support up to 10 files\n  async create(\n    @CurrentUserId() id: string,\n    @Body() postData: PostCreateInputDto,\n    @UploadedFiles() files: Express.Multer.File[] = [], // Optional files\n  ): Promise<PostEntity> {\n    try {\n      const user = await this.postsService.findUserById(id);\n\n      if (!user) {\n        throw new HttpException('User not found', HttpStatus.NOT_FOUND);\n      }\n\n      // Validate and upload files if provided\n      const fileResults: FileUploadResult[] = [];\n      if (files && files.length > 0) {\n        for (const file of files) {\n          const validation = this.supabaseStorageService.validateFile(file);\n          if (!validation.isValid) {\n            throw new HttpException(\n              `File validation failed: ${validation.error}`,\n              HttpStatus.BAD_REQUEST,\n            );\n          }\n        }\n\n        // Upload files to Supabase\n        const uploadResults = await this.supabaseStorageService.uploadFiles(\n          files,\n          SupabaseStorageService.getSupportedBuckets().POST_ATTACHMENTS,\n        );\n        fileResults.push(...uploadResults);\n      }\n\n      const createData: Prisma.PostCreateInput = {\n        title: postData.title,\n        content: postData.content,\n        user: { connect: { id: user.id } },\n        room: { connect: { id: postData.roomId } },\n        attachmentUrls: fileResults.map((f) => f.url),\n        attachmentNames: fileResults.map((f) => f.filename),\n        attachmentSizes: files.map((f) => f.size),\n      };\n      return await this.postsService.create(createData);\n    } catch (error) {\n      throw new HttpException(\n        `Failed to create post: ${error instanceof Error ? error.message : 'Unknown error'}`,\n        HttpStatus.INTERNAL_SERVER_ERROR,\n      );\n    }\n  }\n\n  @Put(':id')\n  @RequireRoomAccess()\n  async update(\n    @CurrentUserId() userId: string,\n    @Param('id') postId: string,\n    @Body() postData: PostUpdateInputDto,\n  ): Promise<PostEntity> {\n    try {\n      return await this.postsService.update(postId, postData, userId);\n    } catch (error) {\n      throw new HttpException(\n        `Failed to update post: ${error instanceof Error ? error.message : 'Unknown error'}`,\n        HttpStatus.INTERNAL_SERVER_ERROR,\n      );\n    }\n  }\n\n  @Delete(':id')\n  @RequireRoomAccess()\n  async remove(\n    @CurrentUserId() userId: string,\n    @Param('id') postId: string,\n  ): Promise<PostEntity> {\n    try {\n      return await this.postsService.remove(postId, userId);\n    } catch (error) {\n      throw new HttpException(\n        `Failed to delete post: ${error instanceof Error ? error.message : 'Unknown error'}`,\n        HttpStatus.INTERNAL_SERVER_ERROR,\n      );\n    }\n  }\n\n  @Get('user/:userId')\n  async findByUserId(@Param('userId') userId: string): Promise<PostEntity[]> {\n    try {\n      return await this.postsService.findByUserId(userId);\n    } catch (error) {\n      throw new HttpException(\n        `Failed to fetch posts for user: ${error instanceof Error ? error.message : 'Unknown error'}`,\n        HttpStatus.INTERNAL_SERVER_ERROR,\n      );\n    }\n  }\n\n  @Get('room/:roomId')\n  @RequireRoomAccess()\n  async findByRoomId(\n    @Param('roomId') roomId: string,\n    @CurrentUserId() userId: string,\n  ): Promise<PostEntity[]> {\n    try {\n      return await this.postsService.findByRoomId(roomId, userId);\n    } catch (error) {\n      throw new HttpException(\n        `Failed to fetch posts for community: ${error instanceof Error ? error.message : 'Unknown error'}`,\n        HttpStatus.INTERNAL_SERVER_ERROR,\n      );\n    }\n  }\n\n  // Heart functionality\n  @Post(':id/heart')\n  @RequireRoomAccess()\n  async heartPost(\n    @CurrentUserId() userId: string,\n    @Param('id') postId: string,\n  ): Promise<{ hearted: boolean }> {\n    try {\n      return await this.postsService.heartPost(postId, userId);\n    } catch (error) {\n      throw new HttpException(\n        `Failed to heart post: ${error instanceof Error ? error.message : 'Unknown error'}`,\n        HttpStatus.INTERNAL_SERVER_ERROR,\n      );\n    }\n  }\n\n  @Get(':id/hearted')\n  async isPostHearted(\n    @CurrentUserId() userId: string,\n    @Param('id') postId: string,\n  ): Promise<{ hearted: boolean }> {\n    try {\n      const hearted = await this.postsService.isPostHeartedByUser(\n        postId,\n        userId,\n      );\n      return { hearted };\n    } catch (error) {\n      throw new HttpException(\n        `Failed to check post heart status: ${error instanceof Error ? error.message : 'Unknown error'}`,\n        HttpStatus.INTERNAL_SERVER_ERROR,\n      );\n    }\n  }\n\n  @Post(':id/report')\n  @RequireRoomAccess()\n  async reportPost(\n    @CurrentUserId() userId: string,\n    @Param('id') postId: string,\n    @Body() reportData: { reason: string; content?: string },\n  ): Promise<{ success: boolean; reportId: string }> {\n    try {\n      const reportId = await this.postsService.reportPost(\n        postId,\n        userId,\n        reportData.reason,\n        reportData.content,\n      );\n      return { success: true, reportId };\n    } catch (error) {\n      throw new HttpException(\n        `Failed to report post: ${error instanceof Error ? error.message : 'Unknown error'}`,\n        HttpStatus.INTERNAL_SERVER_ERROR,\n      );\n    }\n  }\n}\n"],"version":3}