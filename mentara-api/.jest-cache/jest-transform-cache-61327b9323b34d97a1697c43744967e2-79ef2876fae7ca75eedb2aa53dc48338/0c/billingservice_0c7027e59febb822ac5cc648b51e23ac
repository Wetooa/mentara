7028e9cdd0d6b137e4ef44ecb72d45dd
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var BillingService_1;
var _a, _b;
Object.defineProperty(exports, "__esModule", { value: true });
exports.BillingService = void 0;
const common_1 = require("@nestjs/common");
const prisma_client_provider_1 = require("src/providers/prisma-client.provider");
const event_emitter_1 = require("@nestjs/event-emitter");
const client_1 = require("@prisma/client");
let BillingService = BillingService_1 = class BillingService {
    prisma;
    eventEmitter;
    logger = new common_1.Logger(BillingService_1.name);
    constructor(prisma, eventEmitter) {
        this.prisma = prisma;
        this.eventEmitter = eventEmitter;
    }
    // Subscription Management
    async createSubscription(data) {
        const plan = await this.prisma.subscriptionPlan.findUnique({
            where: { id: data.planId },
        });
        if (!plan) {
            throw new common_1.NotFoundException(`Subscription plan with ID ${data.planId} not found`);
        }
        const amount = data.billingCycle === client_1.BillingCycle.YEARLY
            ? plan.yearlyPrice || plan.monthlyPrice
            : plan.monthlyPrice;
        const currentPeriodStart = new Date();
        const currentPeriodEnd = new Date();
        if (data.billingCycle === client_1.BillingCycle.YEARLY) {
            currentPeriodEnd.setFullYear(currentPeriodEnd.getFullYear() + 1);
        }
        else {
            currentPeriodEnd.setMonth(currentPeriodEnd.getMonth() + 1);
        }
        return this.prisma.subscription.create({
            data: {
                userId: data.userId,
                planId: data.planId,
                tier: plan.tier,
                billingCycle: data.billingCycle || client_1.BillingCycle.MONTHLY,
                amount,
                currentPeriodStart,
                currentPeriodEnd,
                trialStart: data.trialStart,
                trialEnd: data.trialEnd,
                defaultPaymentMethodId: data.defaultPaymentMethodId,
                status: data.trialStart
                    ? client_1.SubscriptionStatus.TRIALING
                    : client_1.SubscriptionStatus.ACTIVE,
            },
            include: {
                plan: true,
                defaultPaymentMethod: true,
            },
        });
    }
    async findUserSubscription(userId) {
        return this.prisma.subscription.findUnique({
            where: { userId },
            include: {
                plan: true,
                defaultPaymentMethod: true,
                invoices: {
                    orderBy: { createdAt: 'desc' },
                    take: 5,
                },
            },
        });
    }
    async updateSubscription(userId, data) {
        const subscription = await this.findUserSubscription(userId);
        if (!subscription) {
            throw new common_1.NotFoundException(`Subscription for user ${userId} not found`);
        }
        const updateData = { ...data };
        // If changing plan, update amount
        if (data.planId) {
            const plan = await this.prisma.subscriptionPlan.findUnique({
                where: { id: data.planId },
            });
            if (!plan) {
                throw new common_1.NotFoundException(`Subscription plan with ID ${data.planId} not found`);
            }
            updateData.tier = plan.tier;
            updateData.amount =
                data.billingCycle === client_1.BillingCycle.YEARLY
                    ? plan.yearlyPrice || plan.monthlyPrice
                    : plan.monthlyPrice;
        }
        return this.prisma.subscription.update({
            where: { userId },
            data: updateData,
            include: {
                plan: true,
                defaultPaymentMethod: true,
            },
        });
    }
    async cancelSubscription(userId) {
        return this.updateSubscription(userId, {
            status: client_1.SubscriptionStatus.CANCELED,
        });
    }
    // Subscription Plans
    async createSubscriptionPlan(data) {
        return this.prisma.subscriptionPlan.create({
            data,
        });
    }
    async findAllPlans(isActive = true) {
        return this.prisma.subscriptionPlan.findMany({
            where: { isActive },
            orderBy: { monthlyPrice: 'asc' },
        });
    }
    async updatePlan(id, data) {
        return this.prisma.subscriptionPlan.update({
            where: { id },
            data,
        });
    }
    // Payment Methods
    async createPaymentMethod(data) {
        // If this is set as default, unset other default payment methods
        if (data.isDefault) {
            await this.prisma.paymentMethod.updateMany({
                where: { userId: data.userId, isDefault: true },
                data: { isDefault: false },
            });
        }
        return this.prisma.paymentMethod.create({
            data,
        });
    }
    async findUserPaymentMethods(userId) {
        return this.prisma.paymentMethod.findMany({
            where: { userId, isActive: true },
            orderBy: [{ isDefault: 'desc' }, { createdAt: 'desc' }],
        });
    }
    async updatePaymentMethod(id, data) {
        const paymentMethod = await this.prisma.paymentMethod.findUnique({
            where: { id },
        });
        if (!paymentMethod) {
            throw new common_1.NotFoundException(`Payment method with ID ${id} not found`);
        }
        // If setting as default, unset other defaults for this user
        if (data.isDefault) {
            await this.prisma.paymentMethod.updateMany({
                where: { userId: paymentMethod.userId, isDefault: true },
                data: { isDefault: false },
            });
        }
        return this.prisma.paymentMethod.update({
            where: { id },
            data,
        });
    }
    async deletePaymentMethod(id) {
        return this.prisma.paymentMethod.update({
            where: { id },
            data: { isActive: false },
        });
    }
    // Payments
    async createPayment(data) {
        return this.prisma.payment.create({
            data: {
                ...data,
                status: client_1.PaymentStatus.PENDING,
                currency: data.currency || 'USD',
            },
            include: {
                paymentMethod: true,
                subscription: true,
                invoice: true,
            },
        });
    }
    async updatePaymentStatus(id, status, metadata) {
        const updateData = { status };
        if (status === client_1.PaymentStatus.SUCCEEDED) {
            updateData.processedAt = new Date();
        }
        else if (status === client_1.PaymentStatus.FAILED) {
            updateData.failedAt = new Date();
            if (metadata?.failureCode)
                updateData.failureCode = metadata.failureCode;
            if (metadata?.failureMessage)
                updateData.failureMessage = metadata.failureMessage;
        }
        return this.prisma.payment.update({
            where: { id },
            data: updateData,
        });
    }
    async findPayments(subscriptionId, status, startDate, endDate) {
        const where = {};
        if (subscriptionId)
            where.subscriptionId = subscriptionId;
        if (status)
            where.status = status;
        if (startDate)
            where.createdAt = { ...where.createdAt, gte: startDate };
        if (endDate)
            where.createdAt = { ...where.createdAt, lte: endDate };
        return this.prisma.payment.findMany({
            where,
            include: {
                paymentMethod: true,
                subscription: true,
                invoice: true,
            },
            orderBy: { createdAt: 'desc' },
        });
    }
    // Invoices
    async createInvoice(data) {
        const total = data.subtotal + (data.taxAmount || 0) - (data.discountAmount || 0);
        const invoiceNumber = await this.generateInvoiceNumber();
        return this.prisma.invoice.create({
            data: {
                ...data,
                number: invoiceNumber,
                total,
                amountDue: total,
                status: client_1.InvoiceStatus.OPEN,
            },
            include: {
                subscription: true,
                lineItems: true,
            },
        });
    }
    async findInvoices(subscriptionId, status) {
        const where = {};
        if (subscriptionId)
            where.subscriptionId = subscriptionId;
        if (status)
            where.status = status;
        return this.prisma.invoice.findMany({
            where,
            include: {
                subscription: {
                    include: { user: true },
                },
                lineItems: true,
                payments: true,
            },
            orderBy: { createdAt: 'desc' },
        });
    }
    async markInvoiceAsPaid(id) {
        const invoice = await this.prisma.invoice.findUnique({
            where: { id },
            include: { payments: true },
        });
        if (!invoice) {
            throw new common_1.NotFoundException(`Invoice with ID ${id} not found`);
        }
        const totalPaid = invoice.payments
            .filter((p) => p.status === client_1.PaymentStatus.SUCCEEDED)
            .reduce((sum, p) => sum + Number(p.amount), 0);
        return this.prisma.invoice.update({
            where: { id },
            data: {
                status: totalPaid >= Number(invoice.total)
                    ? client_1.InvoiceStatus.PAID
                    : client_1.InvoiceStatus.OPEN,
                amountPaid: totalPaid,
                paidAt: totalPaid >= Number(invoice.total) ? new Date() : null,
            },
        });
    }
    // Discounts
    async createDiscount(data) {
        return this.prisma.discount.create({
            data: {
                ...data,
                validFrom: data.validFrom || new Date(),
            },
        });
    }
    async validateDiscount(code, userId, amount) {
        const discount = await this.prisma.discount.findUnique({
            where: { code },
            include: {
                redemptions: {
                    where: { userId },
                },
            },
        });
        if (!discount || !discount.isActive) {
            throw new common_1.BadRequestException('Invalid discount code');
        }
        const now = new Date();
        if (discount.validUntil && discount.validUntil < now) {
            throw new common_1.BadRequestException('Discount code has expired');
        }
        if (discount.maxUses && discount.currentUses >= discount.maxUses) {
            throw new common_1.BadRequestException('Discount code usage limit reached');
        }
        if (discount.maxUsesPerUser &&
            discount.redemptions.length >= discount.maxUsesPerUser) {
            throw new common_1.BadRequestException('You have already used this discount code');
        }
        const minAmountNum = Number(discount.minAmount);
        if (discount.minAmount && !isNaN(minAmountNum) && amount < minAmountNum) {
            throw new common_1.BadRequestException(`Minimum amount of ${String(discount.minAmount)} required`);
        }
        return discount;
    }
    async redeemDiscount(discountId, userId, amountSaved) {
        await this.prisma.$transaction(async (tx) => {
            // Create redemption record
            await tx.discountRedemption.create({
                data: {
                    discountId,
                    userId,
                    amountSaved,
                },
            });
            // Update discount usage count
            await tx.discount.update({
                where: { id: discountId },
                data: {
                    currentUses: { increment: 1 },
                },
            });
        });
    }
    // Usage Records
    async recordUsage(data) {
        return this.prisma.usageRecord.create({
            data: {
                ...data,
                usageDate: data.usageDate || new Date(),
            },
        });
    }
    async getUsageRecords(subscriptionId, feature, startDate, endDate) {
        const where = { subscriptionId };
        if (feature)
            where.feature = feature;
        if (startDate)
            where.usageDate = { ...where.usageDate, gte: startDate };
        if (endDate)
            where.usageDate = { ...where.usageDate, lte: endDate };
        return this.prisma.usageRecord.findMany({
            where,
            orderBy: { usageDate: 'desc' },
        });
    }
    // Helper methods
    async generateInvoiceNumber() {
        const year = new Date().getFullYear();
        const lastInvoice = await this.prisma.invoice.findFirst({
            where: {
                number: { startsWith: `INV-${year}-` },
            },
            orderBy: { number: 'desc' },
        });
        let nextNumber = 1;
        if (lastInvoice) {
            const parts = lastInvoice.number.split('-');
            if (parts.length >= 3 && parts[2]) {
                const lastNumber = parseInt(parts[2], 10);
                if (!isNaN(lastNumber)) {
                    nextNumber = lastNumber + 1;
                }
            }
        }
        return `INV-${year}-${nextNumber.toString().padStart(6, '0')}`;
    }
    async getBillingStatistics(startDate, endDate) {
        const where = {};
        if (startDate)
            where.createdAt = { ...where.createdAt, gte: startDate };
        if (endDate)
            where.createdAt = { ...where.createdAt, lte: endDate };
        const [totalRevenue, activeSubscriptions, trialSubscriptions, canceledSubscriptions, subscriptionsByTier,] = await Promise.all([
            this.prisma.payment.aggregate({
                where: { ...where, status: client_1.PaymentStatus.SUCCEEDED },
                _sum: { amount: true },
            }),
            this.prisma.subscription.count({
                where: { status: client_1.SubscriptionStatus.ACTIVE },
            }),
            this.prisma.subscription.count({
                where: { status: client_1.SubscriptionStatus.TRIALING },
            }),
            this.prisma.subscription.count({
                where: { status: client_1.SubscriptionStatus.CANCELED },
            }),
            this.prisma.subscription.groupBy({
                by: ['tier'],
                where: { status: client_1.SubscriptionStatus.ACTIVE },
                _count: { tier: true },
            }),
        ]);
        return {
            totalRevenue: totalRevenue._sum.amount || 0,
            activeSubscriptions,
            trialSubscriptions,
            canceledSubscriptions,
            subscriptionsByTier,
        };
    }
    // ===== ADVANCED SUBSCRIPTION MANAGEMENT =====
    /**
     * Upgrade or downgrade subscription with prorated billing
     */
    async changeSubscriptionPlan(userId, newPlanId, options = {}) {
        const subscription = await this.findUserSubscription(userId);
        if (!subscription) {
            throw new common_1.NotFoundException(`Subscription for user ${userId} not found`);
        }
        const newPlan = await this.prisma.subscriptionPlan.findUnique({
            where: { id: newPlanId },
        });
        if (!newPlan) {
            throw new common_1.NotFoundException(`Plan ${newPlanId} not found`);
        }
        const effectiveDate = options.effectiveDate || new Date();
        const newBillingCycle = options.billingCycle || subscription.billingCycle;
        const newAmount = newBillingCycle === client_1.BillingCycle.YEARLY
            ? newPlan.yearlyPrice || newPlan.monthlyPrice
            : newPlan.monthlyPrice;
        // Calculate proration if needed
        let prorationAmount = 0;
        if (options.prorationBehavior !== 'none') {
            prorationAmount = await this.calculateProration(subscription, Number(newAmount), effectiveDate);
        }
        return await this.prisma.$transaction(async (tx) => {
            // Update subscription
            const updatedSubscription = await tx.subscription.update({
                where: { userId },
                data: {
                    planId: newPlanId,
                    tier: newPlan.tier,
                    billingCycle: newBillingCycle,
                    amount: newAmount,
                    metadata: {
                        ...(typeof subscription.metadata === 'object' &&
                            subscription.metadata !== null
                            ? subscription.metadata
                            : {}),
                        lastPlanChange: effectiveDate.toISOString(),
                        previousPlanId: subscription.planId,
                    },
                },
                include: {
                    plan: true,
                    defaultPaymentMethod: true,
                },
            });
            // Create proration invoice if needed
            if (prorationAmount !== 0 && options.prorationBehavior !== 'none') {
                await this.createProrationInvoice(tx, subscription.id, prorationAmount, effectiveDate);
            }
            // Emit event
            this.eventEmitter.emit('subscription.plan.changed', {
                userId,
                subscriptionId: subscription.id,
                previousPlanId: subscription.planId,
                newPlanId,
                prorationAmount,
                effectiveDate,
            });
            this.logger.log(`User ${userId} changed subscription plan from ${subscription.planId} to ${newPlanId}`);
            return updatedSubscription;
        });
    }
    /**
     * Pause subscription (keep it active but stop billing)
     */
    async pauseSubscription(userId, options = {}) {
        const subscription = await this.findUserSubscription(userId);
        if (!subscription) {
            throw new common_1.NotFoundException(`Subscription for user ${userId} not found`);
        }
        if (subscription.status !== client_1.SubscriptionStatus.ACTIVE) {
            throw new common_1.BadRequestException('Can only pause active subscriptions');
        }
        const updatedSubscription = await this.prisma.subscription.update({
            where: { userId },
            data: {
                status: client_1.SubscriptionStatus.PAUSED,
                metadata: {
                    ...(typeof subscription.metadata === 'object' &&
                        subscription.metadata !== null
                        ? subscription.metadata
                        : {}),
                    pausedAt: new Date().toISOString(),
                    pauseUntil: options.pauseUntil?.toISOString(),
                    pauseReason: options.reason,
                    previousStatus: subscription.status,
                },
            },
            include: {
                plan: true,
                defaultPaymentMethod: true,
            },
        });
        this.eventEmitter.emit('subscription.paused', {
            userId,
            subscriptionId: subscription.id,
            pauseUntil: options.pauseUntil,
            reason: options.reason,
        });
        this.logger.log(`Subscription ${subscription.id} paused for user ${userId}`);
        return updatedSubscription;
    }
    /**
     * Resume paused subscription
     */
    async resumeSubscription(userId) {
        const subscription = await this.findUserSubscription(userId);
        if (!subscription) {
            throw new common_1.NotFoundException(`Subscription for user ${userId} not found`);
        }
        if (subscription.status !== client_1.SubscriptionStatus.PAUSED) {
            throw new common_1.BadRequestException('Can only resume paused subscriptions');
        }
        const metadata = subscription.metadata;
        const previousStatus = metadata?.previousStatus || client_1.SubscriptionStatus.ACTIVE;
        const updatedSubscription = await this.prisma.subscription.update({
            where: { userId },
            data: {
                status: previousStatus,
                metadata: {
                    ...metadata,
                    resumedAt: new Date().toISOString(),
                    pausedAt: undefined,
                    pauseUntil: undefined,
                    pauseReason: undefined,
                    previousStatus: undefined,
                },
            },
            include: {
                plan: true,
                defaultPaymentMethod: true,
            },
        });
        this.eventEmitter.emit('subscription.resumed', {
            userId,
            subscriptionId: subscription.id,
        });
        this.logger.log(`Subscription ${subscription.id} resumed for user ${userId}`);
        return updatedSubscription;
    }
    /**
     * Schedule subscription cancellation at period end
     */
    async scheduleSubscriptionCancellation(userId, options = {}) {
        const subscription = await this.findUserSubscription(userId);
        if (!subscription) {
            throw new common_1.NotFoundException(`Subscription for user ${userId} not found`);
        }
        const cancelAtPeriodEnd = options.cancelAtPeriodEnd ?? true;
        const cancelDate = cancelAtPeriodEnd
            ? subscription.currentPeriodEnd
            : new Date();
        const updatedSubscription = await this.prisma.subscription.update({
            where: { userId },
            data: {
                status: cancelAtPeriodEnd
                    ? subscription.status
                    : client_1.SubscriptionStatus.CANCELED,
                canceledAt: cancelAtPeriodEnd ? null : new Date(),
                endedAt: cancelAtPeriodEnd ? subscription.currentPeriodEnd : new Date(),
                cancelReason: options.reason,
                canceledBy: userId,
                metadata: {
                    ...(typeof subscription.metadata === 'object' &&
                        subscription.metadata !== null
                        ? subscription.metadata
                        : {}),
                    scheduledCancellation: cancelAtPeriodEnd,
                    cancellationFeedback: options.feedback,
                    cancellationScheduledAt: new Date().toISOString(),
                },
            },
            include: {
                plan: true,
                defaultPaymentMethod: true,
            },
        });
        this.eventEmitter.emit('subscription.cancellation.scheduled', {
            userId,
            subscriptionId: subscription.id,
            cancelDate,
            reason: options.reason,
            feedback: options.feedback,
            cancelAtPeriodEnd,
        });
        this.logger.log(`Subscription cancellation scheduled for user ${userId}, effective ${cancelDate}`);
        return updatedSubscription;
    }
    /**
     * Reactivate a canceled subscription
     */
    async reactivateSubscription(userId, newPaymentMethodId) {
        const subscription = await this.findUserSubscription(userId);
        if (!subscription) {
            throw new common_1.NotFoundException(`Subscription for user ${userId} not found`);
        }
        if (subscription.status !== client_1.SubscriptionStatus.CANCELED) {
            throw new common_1.BadRequestException('Can only reactivate canceled subscriptions');
        }
        // Reset period dates
        const currentPeriodStart = new Date();
        const currentPeriodEnd = new Date();
        if (subscription.billingCycle === client_1.BillingCycle.YEARLY) {
            currentPeriodEnd.setFullYear(currentPeriodEnd.getFullYear() + 1);
        }
        else {
            currentPeriodEnd.setMonth(currentPeriodEnd.getMonth() + 1);
        }
        const updatedSubscription = await this.prisma.subscription.update({
            where: { userId },
            data: {
                status: client_1.SubscriptionStatus.ACTIVE,
                currentPeriodStart,
                currentPeriodEnd,
                canceledAt: null,
                endedAt: null,
                cancelReason: null,
                defaultPaymentMethodId: newPaymentMethodId || subscription.defaultPaymentMethodId,
                metadata: {
                    ...(typeof subscription.metadata === 'object' &&
                        subscription.metadata !== null
                        ? subscription.metadata
                        : {}),
                    reactivatedAt: new Date().toISOString(),
                    scheduledCancellation: false,
                },
            },
            include: {
                plan: true,
                defaultPaymentMethod: true,
            },
        });
        this.eventEmitter.emit('subscription.reactivated', {
            userId,
            subscriptionId: subscription.id,
        });
        this.logger.log(`Subscription ${subscription.id} reactivated for user ${userId}`);
        return updatedSubscription;
    }
    /**
     * Apply discount to subscription
     */
    async applyDiscountToSubscription(userId, discountCode) {
        const subscription = await this.findUserSubscription(userId);
        if (!subscription) {
            throw new common_1.NotFoundException(`Subscription for user ${userId} not found`);
        }
        const discount = await this.validateDiscount(discountCode, userId, Number(subscription.amount));
        // Calculate discount amount
        let discountAmount = 0;
        if (discount.type === client_1.DiscountType.PERCENTAGE && discount.percentOff) {
            discountAmount =
                Number(subscription.amount) * (Number(discount.percentOff) / 100);
        }
        else if (discount.type === client_1.DiscountType.FIXED_AMOUNT &&
            discount.amountOff) {
            discountAmount = Number(discount.amountOff);
        }
        const newAmount = Math.max(0, Number(subscription.amount) - discountAmount);
        return await this.prisma.$transaction(async (tx) => {
            // Update subscription amount
            const updatedSubscription = await tx.subscription.update({
                where: { userId },
                data: {
                    amount: newAmount,
                    metadata: {
                        ...(typeof subscription.metadata === 'object' &&
                            subscription.metadata !== null
                            ? subscription.metadata
                            : {}),
                        appliedDiscounts: [
                            ...(subscription.metadata?.appliedDiscounts || []),
                            {
                                discountId: discount.id,
                                code: discountCode,
                                appliedAt: new Date().toISOString(),
                                originalAmount: subscription.amount,
                                discountAmount,
                                newAmount,
                            },
                        ],
                    },
                },
                include: {
                    plan: true,
                    defaultPaymentMethod: true,
                },
            });
            // Record discount redemption
            await this.redeemDiscount(discount.id, userId, discountAmount);
            this.eventEmitter.emit('subscription.discount.applied', {
                userId,
                subscriptionId: subscription.id,
                discountCode,
                discountAmount,
                newAmount,
            });
            return updatedSubscription;
        });
    }
    /**
     * Process subscription renewal
     */
    async processSubscriptionRenewal(subscriptionId) {
        const subscription = await this.prisma.subscription.findUnique({
            where: { id: subscriptionId },
            include: {
                plan: true,
                defaultPaymentMethod: true,
                user: true,
            },
        });
        if (!subscription) {
            throw new common_1.NotFoundException(`Subscription ${subscriptionId} not found`);
        }
        // Check if renewal is due
        const now = new Date();
        if (subscription.currentPeriodEnd > now) {
            throw new common_1.BadRequestException('Subscription renewal not yet due');
        }
        return await this.prisma.$transaction(async (tx) => {
            // Create invoice for next period
            const nextPeriodStart = subscription.currentPeriodEnd;
            const nextPeriodEnd = new Date(nextPeriodStart);
            if (subscription.billingCycle === client_1.BillingCycle.YEARLY) {
                nextPeriodEnd.setFullYear(nextPeriodEnd.getFullYear() + 1);
            }
            else {
                nextPeriodEnd.setMonth(nextPeriodEnd.getMonth() + 1);
            }
            const invoice = await this.createInvoice({
                subscriptionId,
                subtotal: Number(subscription.amount),
                dueDate: nextPeriodStart,
            });
            // Update subscription period
            const updatedSubscription = await tx.subscription.update({
                where: { id: subscriptionId },
                data: {
                    currentPeriodStart: nextPeriodStart,
                    currentPeriodEnd: nextPeriodEnd,
                    metadata: {
                        ...(typeof subscription.metadata === 'object' &&
                            subscription.metadata !== null
                            ? subscription.metadata
                            : {}),
                        lastRenewal: now.toISOString(),
                    },
                },
                include: {
                    plan: true,
                    defaultPaymentMethod: true,
                },
            });
            this.eventEmitter.emit('subscription.renewed', {
                userId: subscription.userId,
                subscriptionId,
                invoiceId: invoice.id,
                nextPeriodStart,
                nextPeriodEnd,
            });
            return { subscription: updatedSubscription, invoice };
        });
    }
    /**
     * Get subscription usage analytics
     */
    async getSubscriptionUsageAnalytics(subscriptionId, startDate, endDate) {
        const subscription = await this.prisma.subscription.findUnique({
            where: { id: subscriptionId },
            include: { plan: true },
        });
        if (!subscription) {
            throw new common_1.NotFoundException(`Subscription ${subscriptionId} not found`);
        }
        const where = { subscriptionId };
        if (startDate)
            where.usageDate = { ...where.usageDate, gte: startDate };
        if (endDate)
            where.usageDate = { ...where.usageDate, lte: endDate };
        const [usageRecords, usageByFeature, totalUsage] = await Promise.all([
            this.prisma.usageRecord.findMany({
                where,
                orderBy: { usageDate: 'desc' },
                take: 100,
            }),
            this.prisma.usageRecord.groupBy({
                by: ['feature'],
                where,
                _sum: { quantity: true },
                _count: { quantity: true },
            }),
            this.prisma.usageRecord.aggregate({
                where,
                _sum: { quantity: true },
                _count: { quantity: true },
            }),
        ]);
        const planLimits = subscription.plan.limits;
        return {
            subscription,
            usageRecords,
            usageByFeature: usageByFeature.map((usage) => ({
                feature: usage.feature,
                totalQuantity: usage._sum.quantity || 0,
                recordCount: usage._count.quantity,
                limit: planLimits?.[usage.feature] || null,
                utilizationPercentage: planLimits?.[usage.feature]
                    ? ((usage._sum.quantity || 0) / planLimits[usage.feature]) * 100
                    : null,
            })),
            totalUsage: {
                totalQuantity: totalUsage._sum.quantity || 0,
                totalRecords: totalUsage._count.quantity,
            },
        };
    }
    // ===== PRIVATE HELPER METHODS =====
    async calculateProration(subscription, newAmount, effectiveDate) {
        const currentAmount = Number(subscription.amount);
        const periodStart = subscription.currentPeriodStart;
        const periodEnd = subscription.currentPeriodEnd;
        const totalPeriodDays = Math.ceil((periodEnd.getTime() - periodStart.getTime()) / (1000 * 60 * 60 * 24));
        const remainingDays = Math.ceil((periodEnd.getTime() - effectiveDate.getTime()) / (1000 * 60 * 60 * 24));
        if (remainingDays <= 0)
            return 0;
        const dailyCurrentRate = currentAmount / totalPeriodDays;
        const dailyNewRate = newAmount / totalPeriodDays;
        const prorationAmount = (dailyNewRate - dailyCurrentRate) * remainingDays;
        return Math.round(prorationAmount * 100) / 100; // Round to 2 decimal places
    }
    async createProrationInvoice(tx, subscriptionId, prorationAmount, effectiveDate) {
        if (prorationAmount === 0)
            return;
        const invoiceNumber = await this.generateInvoiceNumber();
        const description = prorationAmount > 0
            ? 'Proration charge for plan upgrade'
            : 'Proration credit for plan downgrade';
        return await tx.invoice.create({
            data: {
                subscriptionId,
                number: invoiceNumber,
                status: client_1.InvoiceStatus.OPEN,
                subtotal: Math.abs(prorationAmount),
                total: Math.abs(prorationAmount),
                amountDue: prorationAmount > 0 ? prorationAmount : 0,
                dueDate: effectiveDate,
                lineItems: {
                    create: {
                        description,
                        quantity: 1,
                        unitPrice: prorationAmount,
                        amount: prorationAmount,
                    },
                },
            },
        });
    }
};
exports.BillingService = BillingService;
exports.BillingService = BillingService = BillingService_1 = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [typeof (_a = typeof prisma_client_provider_1.PrismaService !== "undefined" && prisma_client_provider_1.PrismaService) === "function" ? _a : Object, typeof (_b = typeof event_emitter_1.EventEmitter2 !== "undefined" && event_emitter_1.EventEmitter2) === "function" ? _b : Object])
], BillingService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL2JpbGxpbmcvYmlsbGluZy5zZXJ2aWNlLnRzIiwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7O0FBQUEsMkNBS3dCO0FBQ3hCLGlGQUFxRTtBQUNyRSx5REFBc0Q7QUFDdEQsMkNBUXdCO0FBR2pCLElBQU0sY0FBYyxzQkFBcEIsTUFBTSxjQUFjO0lBSU47SUFDQTtJQUpGLE1BQU0sR0FBRyxJQUFJLGVBQU0sQ0FBQyxnQkFBYyxDQUFDLElBQUksQ0FBQyxDQUFDO0lBRTFELFlBQ21CLE1BQXFCLEVBQ3JCLFlBQTJCO1FBRDNCLFdBQU0sR0FBTixNQUFNLENBQWU7UUFDckIsaUJBQVksR0FBWixZQUFZLENBQWU7SUFDM0MsQ0FBQztJQUVKLDBCQUEwQjtJQUMxQixLQUFLLENBQUMsa0JBQWtCLENBQUMsSUFPeEI7UUFDQyxNQUFNLElBQUksR0FBRyxNQUFNLElBQUksQ0FBQyxNQUFNLENBQUMsZ0JBQWdCLENBQUMsVUFBVSxDQUFDO1lBQ3pELEtBQUssRUFBRSxFQUFFLEVBQUUsRUFBRSxJQUFJLENBQUMsTUFBTSxFQUFFO1NBQzNCLENBQUMsQ0FBQztRQUVILElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQztZQUNWLE1BQU0sSUFBSSwwQkFBaUIsQ0FDekIsNkJBQTZCLElBQUksQ0FBQyxNQUFNLFlBQVksQ0FDckQsQ0FBQztRQUNKLENBQUM7UUFFRCxNQUFNLE1BQU0sR0FDVixJQUFJLENBQUMsWUFBWSxLQUFLLHFCQUFZLENBQUMsTUFBTTtZQUN2QyxDQUFDLENBQUMsSUFBSSxDQUFDLFdBQVcsSUFBSSxJQUFJLENBQUMsWUFBWTtZQUN2QyxDQUFDLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQztRQUV4QixNQUFNLGtCQUFrQixHQUFHLElBQUksSUFBSSxFQUFFLENBQUM7UUFDdEMsTUFBTSxnQkFBZ0IsR0FBRyxJQUFJLElBQUksRUFBRSxDQUFDO1FBRXBDLElBQUksSUFBSSxD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QUFFLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQztZQUM3QixJQUFJLEVBQUU7Z0JBQ0osY0FBYztnQkFDZCxNQUFNLEVBQUUsYUFBYTtnQkFDckIsTUFBTSxFQUFFLHNCQUFhLENBQUMsSUFBSTtnQkFDMUIsUUFBUSxFQUFFLElBQUksQ0FBQyxHQUFHLENBQUMsZUFBZSxDQUFDO2dCQUNuQyxLQUFLLEVBQUUsSUFBSSxDQUFDLEdBQUcsQ0FBQyxlQUFlLENBQUM7Z0JBQ2hDLFNBQVMsRUFBRSxlQUFlLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxlQUFlLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQ3BELE9BQU8sRUFBRSxhQUFhO2dCQUN0QixTQUFTLEVBQUU7b0JBQ1QsTUFBTSxFQUFFO3dCQUNOLFdBQVc7d0JBQ1gsUUFBUSxFQUFFLENBQUM7d0JBQ1gsU0FBUyxFQUFFLGVBQWU7d0JBQzFCLE1BQU0sRUFBRSxlQUFlO3FCQUN4QjtpQkFDRjthQUNGO1NBQ0YsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztDQUNGLENBQUE7QUF2b0NZLHdDQUFjO3lCQUFkLGNBQWM7SUFEMUIsSUFBQSxtQkFBVSxHQUFFO3lEQUtnQixzQ0FBYSxvQkFBYixzQ0FBYSxvREFDUCw2QkFBYSxvQkFBYiw2QkFBYTtHQUxuQyxjQUFjLENBdW9DMUIiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL2JpbGxpbmcvYmlsbGluZy5zZXJ2aWNlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIEluamVjdGFibGUsXG4gIE5vdEZvdW5kRXhjZXB0aW9uLFxuICBCYWRSZXF1ZXN0RXhjZXB0aW9uLFxuICBMb2dnZXIsXG59IGZyb20gJ0BuZXN0anMvY29tbW9uJztcbmltcG9ydCB7IFByaXNtYVNlcnZpY2UgfSBmcm9tICdzcmMvcHJvdmlkZXJzL3ByaXNtYS1jbGllbnQucHJvdmlkZXInO1xuaW1wb3J0IHsgRXZlbnRFbWl0dGVyMiB9IGZyb20gJ0BuZXN0anMvZXZlbnQtZW1pdHRlcic7XG5pbXBvcnQge1xuICBTdWJzY3JpcHRpb25TdGF0dXMsXG4gIFN1YnNjcmlwdGlvblRpZXIsXG4gIEJpbGxpbmdDeWNsZSxcbiAgUGF5bWVudFN0YXR1cyxcbiAgUGF5bWVudE1ldGhvZFR5cGUsXG4gIEludm9pY2VTdGF0dXMsXG4gIERpc2NvdW50VHlwZSxcbn0gZnJvbSAnQHByaXNtYS9jbGllbnQnO1xuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgQmlsbGluZ1NlcnZpY2Uge1xuICBwcml2YXRlIHJlYWRvbmx5IGxvZ2dlciA9IG5ldyBMb2dnZXIoQmlsbGluZ1NlcnZpY2UubmFtZSk7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSByZWFkb25seSBwcmlzbWE6IFByaXNtYVNlcnZpY2UsXG4gICAgcHJpdmF0ZSByZWFkb25seSBldmVudEVtaXR0ZXI6IEV2ZW50RW1pdHRlcjIsXG4gICkge31cblxuICAvLyBTdWJzY3JpcHRpb24gTWFuYWdlbWVudFxuICBhc3luYyBjcmVhdGVTdWJzY3JpcHRpb24oZGF0YToge1xuICAgIHVzZXJJZDogc3RyaW5nO1xuICAgIHBsYW5JZDogc3RyaW5nO1xuICAgIGJpbGxpbmdDeWNsZT86IEJpbGxpbmdDeWNsZTtcbiAgICBkZWZhdWx0UGF5bWVudE1ldGhvZElkPzogc3RyaW5nO1xuICAgIHRyaWFsU3RhcnQ/OiBEYXRlO1xuICAgIHRyaWFsRW5kPzogRGF0ZTtcbiAgfSkge1xuICAgIGNvbnN0IHBsYW4gPSBhd2FpdCB0aGlzLnByaXNtYS5zdWJzY3JpcHRpb25QbGFuLmZpbmRVbmlxdWUoe1xuICAgICAgd2hlcmU6IHsgaWQ6IGRhdGEucGxhbklkIH0sXG4gICAgfSk7XG5cbiAgICBpZiAoIXBsYW4pIHtcbiAgICAgIHRocm93IG5ldyBOb3RGb3VuZEV4Y2VwdGlvbihcbiAgICAgICAgYFN1YnNjcmlwdGlvbiBwbGFuIHdpdGggSUQgJHtkYXRhLnBsYW5JZH0gbm90IGZvdW5kYCxcbiAgICAgICk7XG4gICAgfVxuXG4gICAgY29uc3QgYW1vdW50ID1cbiAgICAgIGRhdGEuYmlsbGluZ0N5Y2xlID09PSBCaWxsaW5nQ3ljbGUuWUVBUkxZXG4gICAgICAgID8gcGxhbi55ZWFybHlQcmljZSB8fCBwbGFuLm1vbnRobHlQcmljZVxuICAgICAgICA6IHBsYW4ubW9udGhseVByaWNlO1xuXG4gICAgY29uc3QgY3VycmVudFBlcmlvZFN0YXJ0ID0gbmV3IERhdGUoKTtcbiAgICBjb25zdCBjdXJyZW50UGVyaW9kRW5kID0gbmV3IERhdGUoKTtcblxuICAgIGlmIChkYXRhLmJpbGxpbmdDeWNsZSA9PT0gQmlsbGluZ0N5Y2xlLllFQVJMWSkge1xuICAgICAgY3VycmVudFBlcmlvZEVuZC5zZXRGdWxsWWVhcihjdXJyZW50UGVyaW9kRW5kLmdldEZ1bGxZZWFyKCkgKyAxKTtcbiAgICB9IGVsc2Uge1xuICAgICAgY3VycmVudFBlcmlvZEVuZC5zZXRNb250aChjdXJyZW50UGVyaW9kRW5kLmdldE1vbnRoKCkgKyAxKTtcbiAgICB9XG5cbiAgICByZXR1cm4gdGhpcy5wcmlzbWEuc3Vic2NyaXB0aW9uLmNyZWF0ZSh7XG4gICAgICBkYXRhOiB7XG4gICAgICAgIHVzZXJJZDogZGF0YS51c2VySWQsXG4gICAgICAgIHBsYW5JZDogZGF0YS5wbGFuSWQsXG4gICAgICAgIHRpZXI6IHBsYW4udGllcixcbiAgICAgICAgYmlsbGluZ0N5Y2xlOiBkYXRhLmJpbGxpbmdDeWNsZSB8fCBCaWxsaW5nQ3ljbGUuTU9OVEhMWSxcbiAgICAgICAgYW1vdW50LFxuICAgICAgICBjdXJyZW50UGVyaW9kU3RhcnQsXG4gICAgICAgIGN1cnJlbnRQZXJpb2RFbmQsXG4gICAgICAgIHRyaWFsU3RhcnQ6IGRhdGEudHJpYWxTdGFydCxcbiAgICAgICAgdHJpYWxFbmQ6IGRhdGEudHJpYWxFbmQsXG4gICAgICAgIGRlZmF1bHRQYXltZW50TWV0aG9kSWQ6IGRhdGEuZGVmYXVsdFBheW1lbnRNZXRob2RJZCxcbiAgICAgICAgc3RhdHVzOiBkYXRhLnRyaWFsU3RhcnRcbiAgICAgICAgICA/IFN1YnNjcmlwdGlvblN0YXR1cy5UUklBTElOR1xuICAgICAgICAgIDogU3Vic2NyaXB0aW9uU3RhdHVzLkFDVElWRSxcbiAgICAgIH0sXG4gICAgICBpbmNsdWRlOiB7XG4gICAgICAgIHBsYW46IHRydWUsXG4gICAgICAgIGRlZmF1bHRQYXltZW50TWV0aG9kOiB0cnVlLFxuICAgICAgfSxcbiAgICB9KTtcbiAgfVxuXG4gIGFzeW5jIGZpbmRVc2VyU3Vic2NyaXB0aW9uKHVzZXJJZDogc3RyaW5nKSB7XG4gICAgcmV0dXJuIHRoaXMucHJpc21hLnN1YnNjcmlwdGlvbi5maW5kVW5pcXVlKHtcbiAgICAgIHdoZXJlOiB7IHVzZXJJZCB9LFxuICAgICAgaW5jbHVkZToge1xuICAgICAgICBwbGFuOiB0cnVlLFxuICAgICAgICBkZWZhdWx0UGF5bWVudE1ldGhvZDogdHJ1ZSxcbiAgICAgICAgaW52b2ljZXM6IHtcbiAgICAgICAgICBvcmRlckJ5OiB7IGNyZWF0ZWRBdDogJ2Rlc2MnIH0sXG4gICAgICAgICAgdGFrZTogNSxcbiAgICAgICAgfSxcbiAgICAgIH0sXG4gICAgfSk7XG4gIH1cblxuICBhc3luYyB1cGRhdGVTdWJzY3JpcHRpb24oXG4gICAgdXNlcklkOiBzdHJpbmcsXG4gICAgZGF0YToge1xuICAgICAgcGxhbklkPzogc3RyaW5nO1xuICAgICAgYmlsbGluZ0N5Y2xlPzogQmlsbGluZ0N5Y2xlO1xuICAgICAgc3RhdHVzPzogU3Vic2NyaXB0aW9uU3RhdHVzO1xuICAgICAgZGVmYXVsdFBheW1lbnRNZXRob2RJZD86IHN0cmluZztcbiAgICB9LFxuICApIHtcbiAgICBjb25zdCBzdWJzY3JpcHRpb24gPSBhd2FpdCB0aGlzLmZpbmRVc2VyU3Vic2NyaXB0aW9uKHVzZXJJZCk7XG4gICAgaWYgKCFzdWJzY3JpcHRpb24pIHtcbiAgICAgIHRocm93IG5ldyBOb3RGb3VuZEV4Y2VwdGlvbihgU3Vic2NyaXB0aW9uIGZvciB1c2VyICR7dXNlcklkfSBub3QgZm91bmRgKTtcbiAgICB9XG5cbiAgICBjb25zdCB1cGRhdGVEYXRhOiBhbnkgPSB7IC4uLmRhdGEgfTtcblxuICAgIC8vIElmIGNoYW5naW5nIHBsYW4sIHVwZGF0ZSBhbW91bnRcbiAgICBpZiAoZGF0YS5wbGFuSWQpIHtcbiAgICAgIGNvbnN0IHBsYW4gPSBhd2FpdCB0aGlzLnByaXNtYS5zdWJzY3JpcHRpb25QbGFuLmZpbmRVbmlxdWUoe1xuICAgICAgICB3aGVyZTogeyBpZDogZGF0YS5wbGFuSWQgfSxcbiAgICAgIH0pO1xuICAgICAgaWYgKCFwbGFuKSB7XG4gICAgICAgIHRocm93IG5ldyBOb3RGb3VuZEV4Y2VwdGlvbihcbiAgICAgICAgICBgU3Vic2NyaXB0aW9uIHBsYW4gd2l0aCBJRCAke2RhdGEucGxhbklkfSBub3QgZm91bmRgLFxuICAgICAgICApO1xuICAgICAgfVxuXG4gICAgICB1cGRhdGVEYXRhLnRpZXIgPSBwbGFuLnRpZXI7XG4gICAgICB1cGRhdGVEYXRhLmFtb3VudCA9XG4gICAgICAgIGRhdGEuYmlsbGluZ0N5Y2xlID09PSBCaWxsaW5nQ3ljbGUuWUVBUkxZXG4gICAgICAgICAgPyBwbGFuLnllYXJseVByaWNlIHx8IHBsYW4ubW9udGhseVByaWNlXG4gICAgICAgICAgOiBwbGFuLm1vbnRobHlQcmljZTtcbiAgICB9XG5cbiAgICByZXR1cm4gdGhpcy5wcmlzbWEuc3Vic2NyaXB0aW9uLnVwZGF0ZSh7XG4gICAgICB3aGVyZTogeyB1c2VySWQgfSxcbiAgICAgIGRhdGE6IHVwZGF0ZURhdGEsXG4gICAgICBpbmNsdWRlOiB7XG4gICAgICAgIHBsYW46IHRydWUsXG4gICAgICAgIGRlZmF1bHRQYXltZW50TWV0aG9kOiB0cnVlLFxuICAgICAgfSxcbiAgICB9KTtcbiAgfVxuXG4gIGFzeW5jIGNhbmNlbFN1YnNjcmlwdGlvbih1c2VySWQ6IHN0cmluZykge1xuICAgIHJldHVybiB0aGlzLnVwZGF0ZVN1YnNjcmlwdGlvbih1c2VySWQsIHtcbiAgICAgIHN0YXR1czogU3Vic2NyaXB0aW9uU3RhdHVzLkNBTkNFTEVELFxuICAgIH0pO1xuICB9XG5cbiAgLy8gU3Vic2NyaXB0aW9uIFBsYW5zXG4gIGFzeW5jIGNyZWF0ZVN1YnNjcmlwdGlvblBsYW4oZGF0YToge1xuICAgIG5hbWU6IHN0cmluZztcbiAgICBkZXNjcmlwdGlvbj86IHN0cmluZztcbiAgICB0aWVyOiBTdWJzY3JpcHRpb25UaWVyO1xuICAgIG1vbnRobHlQcmljZTogbnVtYmVyO1xuICAgIHllYXJseVByaWNlPzogbnVtYmVyO1xuICAgIGZlYXR1cmVzOiBhbnk7XG4gICAgbGltaXRzOiBhbnk7XG4gICAgdHJpYWxEYXlzPzogbnVtYmVyO1xuICB9KSB7XG4gICAgcmV0dXJuIHRoaXMucHJpc21hLnN1YnNjcmlwdGlvblBsYW4uY3JlYXRlKHtcbiAgICAgIGRhdGEsXG4gICAgfSk7XG4gIH1cblxuICBhc3luYyBmaW5kQWxsUGxhbnMoaXNBY3RpdmUgPSB0cnVlKSB7XG4gICAgcmV0dXJuIHRoaXMucHJpc21hLnN1YnNjcmlwdGlvblBsYW4uZmluZE1hbnkoe1xuICAgICAgd2hlcmU6IHsgaXNBY3RpdmUgfSxcbiAgICAgIG9yZGVyQnk6IHsgbW9udGhseVByaWNlOiAnYXNjJyB9LFxuICAgIH0pO1xuICB9XG5cbiAgYXN5bmMgdXBkYXRlUGxhbihcbiAgICBpZDogc3RyaW5nLFxuICAgIGRhdGE6IFBhcnRpYWw8e1xuICAgICAgbmFtZTogc3RyaW5nO1xuICAgICAgZGVzY3JpcHRpb246IHN0cmluZztcbiAgICAgIG1vbnRobHlQcmljZTogbnVtYmVyO1xuICAgICAgeWVhcmx5UHJpY2U6IG51bWJlcjtcbiAgICAgIGZlYXR1cmVzOiBhbnk7XG4gICAgICBsaW1pdHM6IGFueTtcbiAgICAgIHRyaWFsRGF5czogbnVtYmVyO1xuICAgICAgaXNBY3RpdmU6IGJvb2xlYW47XG4gICAgfT4sXG4gICkge1xuICAgIHJldHVybiB0aGlzLnByaXNtYS5zdWJzY3JpcHRpb25QbGFuLnVwZGF0ZSh7XG4gICAgICB3aGVyZTogeyBpZCB9LFxuICAgICAgZGF0YSxcbiAgICB9KTtcbiAgfVxuXG4gIC8vIFBheW1lbnQgTWV0aG9kc1xuICBhc3luYyBjcmVhdGVQYXltZW50TWV0aG9kKGRhdGE6IHtcbiAgICB1c2VySWQ6IHN0cmluZztcbiAgICB0eXBlOiBQYXltZW50TWV0aG9kVHlwZTtcbiAgICBjYXJkTGFzdDQ/OiBzdHJpbmc7XG4gICAgY2FyZEJyYW5kPzogc3RyaW5nO1xuICAgIGNhcmRFeHBNb250aD86IG51bWJlcjtcbiAgICBjYXJkRXhwWWVhcj86IG51bWJlcjtcbiAgICBzdHJpcGVQYXltZW50TWV0aG9kSWQ/OiBzdHJpbmc7XG4gICAgaXNEZWZhdWx0PzogYm9vbGVhbjtcbiAgfSkge1xuICAgIC8vIElmIHRoaXMgaXMgc2V0IGFzIGRlZmF1bHQsIHVuc2V0IG90aGVyIGRlZmF1bHQgcGF5bWVudCBtZXRob2RzXG4gICAgaWYgKGRhdGEuaXNEZWZhdWx0KSB7XG4gICAgICBhd2FpdCB0aGlzLnByaXNtYS5wYXltZW50TWV0aG9kLnVwZGF0ZU1hbnkoe1xuICAgICAgICB3aGVyZTogeyB1c2VySWQ6IGRhdGEudXNlcklkLCBpc0RlZmF1bHQ6IHRydWUgfSxcbiAgICAgICAgZGF0YTogeyBpc0RlZmF1bHQ6IGZhbHNlIH0sXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICByZXR1cm4gdGhpcy5wcmlzbWEucGF5bWVudE1ldGhvZC5jcmVhdGUoe1xuICAgICAgZGF0YSxcbiAgICB9KTtcbiAgfVxuXG4gIGFzeW5jIGZpbmRVc2VyUGF5bWVudE1ldGhvZHModXNlcklkOiBzdHJpbmcpIHtcbiAgICByZXR1cm4gdGhpcy5wcmlzbWEucGF5bWVudE1ldGhvZC5maW5kTWFueSh7XG4gICAgICB3aGVyZTogeyB1c2VySWQsIGlzQWN0aXZlOiB0cnVlIH0sXG4gICAgICBvcmRlckJ5OiBbeyBpc0RlZmF1bHQ6ICdkZXNjJyB9LCB7IGNyZWF0ZWRBdDogJ2Rlc2MnIH1dLFxuICAgIH0pO1xuICB9XG5cbiAgYXN5bmMgdXBkYXRlUGF5bWVudE1ldGhvZChcbiAgICBpZDogc3RyaW5nLFxuICAgIGRhdGE6IFBhcnRpYWw8e1xuICAgICAgaXNEZWZhdWx0OiBib29sZWFuO1xuICAgICAgaXNBY3RpdmU6IGJvb2xlYW47XG4gICAgfT4sXG4gICkge1xuICAgIGNvbnN0IHBheW1lbnRNZXRob2QgPSBhd2FpdCB0aGlzLnByaXNtYS5wYXltZW50TWV0aG9kLmZpbmRVbmlxdWUoe1xuICAgICAgd2hlcmU6IHsgaWQgfSxcbiAgICB9KTtcblxuICAgIGlmICghcGF5bWVudE1ldGhvZCkge1xuICAgICAgdGhyb3cgbmV3IE5vdEZvdW5kRXhjZXB0aW9uKGBQYXltZW50IG1ldGhvZCB3aXRoIElEICR7aWR9IG5vdCBmb3VuZGApO1xuICAgIH1cblxuICAgIC8vIElmIHNldHRpbmcgYXMgZGVmYXVsdCwgdW5zZXQgb3RoZXIgZGVmYXVsdHMgZm9yIHRoaXMgdXNlclxuICAgIGlmIChkYXRhLmlzRGVmYXVsdCkge1xuICAgICAgYXdhaXQgdGhpcy5wcmlzbWEucGF5bWVudE1ldGhvZC51cGRhdGVNYW55KHtcbiAgICAgICAgd2hlcmU6IHsgdXNlcklkOiBwYXltZW50TWV0aG9kLnVzZXJJZCwgaXNEZWZhdWx0OiB0cnVlIH0sXG4gICAgICAgIGRhdGE6IHsgaXNEZWZhdWx0OiBmYWxzZSB9LFxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXMucHJpc21hLnBheW1lbnRNZXRob2QudXBkYXRlKHtcbiAgICAgIHdoZXJlOiB7IGlkIH0sXG4gICAgICBkYXRhLFxuICAgIH0pO1xuICB9XG5cbiAgYXN5bmMgZGVsZXRlUGF5bWVudE1ldGhvZChpZDogc3RyaW5nKSB7XG4gICAgcmV0dXJuIHRoaXMucHJpc21hLnBheW1lbnRNZXRob2QudXBkYXRlKHtcbiAgICAgIHdoZXJlOiB7IGlkIH0sXG4gICAgICBkYXRhOiB7IGlzQWN0aXZlOiBmYWxzZSB9LFxuICAgIH0pO1xuICB9XG5cbiAgLy8gUGF5bWVudHNcbiAgYXN5bmMgY3JlYXRlUGF5bWVudChkYXRhOiB7XG4gICAgYW1vdW50OiBudW1iZXI7XG4gICAgY3VycmVuY3k/OiBzdHJpbmc7XG4gICAgcGF5bWVudE1ldGhvZElkPzogc3RyaW5nO1xuICAgIHN1YnNjcmlwdGlvbklkPzogc3RyaW5nO1xuICAgIGludm9pY2VJZD86IHN0cmluZztcbiAgICBtZWV0aW5nSWQ/OiBzdHJpbmc7XG4gICAgZGVzY3JpcHRpb24/OiBzdHJpbmc7XG4gICAgcHJvdmlkZXJQYXltZW50SWQ/OiBzdHJpbmc7XG4gIH0pIHtcbiAgICByZXR1cm4gdGhpcy5wcmlzbWEucGF5bWVudC5jcmVhdGUoe1xuICAgICAgZGF0YToge1xuICAgICAgICAuLi5kYXRhLFxuICAgICAgICBzdGF0dXM6IFBheW1lbnRTdGF0dXMuUEVORElORyxcbiAgICAgICAgY3VycmVuY3k6IGRhdGEuY3VycmVuY3kgfHwgJ1VTRCcsXG4gICAgICB9LFxuICAgICAgaW5jbHVkZToge1xuICAgICAgICBwYXltZW50TWV0aG9kOiB0cnVlLFxuICAgICAgICBzdWJzY3JpcHRpb246IHRydWUsXG4gICAgICAgIGludm9pY2U6IHRydWUsXG4gICAgICB9LFxuICAgIH0pO1xuICB9XG5cbiAgYXN5bmMgdXBkYXRlUGF5bWVudFN0YXR1cyhpZDogc3RyaW5nLCBzdGF0dXM6IFBheW1lbnRTdGF0dXMsIG1ldGFkYXRhPzogYW55KSB7XG4gICAgY29uc3QgdXBkYXRlRGF0YTogYW55ID0geyBzdGF0dXMgfTtcblxuICAgIGlmIChzdGF0dXMgPT09IFBheW1lbnRTdGF0dXMuU1VDQ0VFREVEKSB7XG4gICAgICB1cGRhdGVEYXRhLnByb2Nlc3NlZEF0ID0gbmV3IERhdGUoKTtcbiAgICB9IGVsc2UgaWYgKHN0YXR1cyA9PT0gUGF5bWVudFN0YXR1cy5GQUlMRUQpIHtcbiAgICAgIHVwZGF0ZURhdGEuZmFpbGVkQXQgPSBuZXcgRGF0ZSgpO1xuICAgICAgaWYgKG1ldGFkYXRhPy5mYWlsdXJlQ29kZSkgdXBkYXRlRGF0YS5mYWlsdXJlQ29kZSA9IG1ldGFkYXRhLmZhaWx1cmVDb2RlO1xuICAgICAgaWYgKG1ldGFkYXRhPy5mYWlsdXJlTWVzc2FnZSlcbiAgICAgICAgdXBkYXRlRGF0YS5mYWlsdXJlTWVzc2FnZSA9IG1ldGFkYXRhLmZhaWx1cmVNZXNzYWdlO1xuICAgIH1cblxuICAgIHJldHVybiB0aGlzLnByaXNtYS5wYXltZW50LnVwZGF0ZSh7XG4gICAgICB3aGVyZTogeyBpZCB9LFxuICAgICAgZGF0YTogdXBkYXRlRGF0YSxcbiAgICB9KTtcbiAgfVxuXG4gIGFzeW5jIGZpbmRQYXltZW50cyhcbiAgICBzdWJzY3JpcHRpb25JZD86IHN0cmluZyxcbiAgICBzdGF0dXM/OiBQYXltZW50U3RhdHVzLFxuICAgIHN0YXJ0RGF0ZT86IERhdGUsXG4gICAgZW5kRGF0ZT86IERhdGUsXG4gICkge1xuICAgIGNvbnN0IHdoZXJlOiBhbnkgPSB7fTtcblxuICAgIGlmIChzdWJzY3JpcHRpb25JZCkgd2hlcmUuc3Vic2NyaXB0aW9uSWQgPSBzdWJzY3JpcHRpb25JZDtcbiAgICBpZiAoc3RhdHVzKSB3aGVyZS5zdGF0dXMgPSBzdGF0dXM7XG4gICAgaWYgKHN0YXJ0RGF0ZSkgd2hlcmUuY3JlYXRlZEF0ID0geyAuLi53aGVyZS5jcmVhdGVkQXQsIGd0ZTogc3RhcnREYXRlIH07XG4gICAgaWYgKGVuZERhdGUpIHdoZXJlLmNyZWF0ZWRBdCA9IHsgLi4ud2hlcmUuY3JlYXRlZEF0LCBsdGU6IGVuZERhdGUgfTtcblxuICAgIHJldHVybiB0aGlzLnByaXNtYS5wYXltZW50LmZpbmRNYW55KHtcbiAgICAgIHdoZXJlLFxuICAgICAgaW5jbHVkZToge1xuICAgICAgICBwYXltZW50TWV0aG9kOiB0cnVlLFxuICAgICAgICBzdWJzY3JpcHRpb246IHRydWUsXG4gICAgICAgIGludm9pY2U6IHRydWUsXG4gICAgICB9LFxuICAgICAgb3JkZXJCeTogeyBjcmVhdGVkQXQ6ICdkZXNjJyB9LFxuICAgIH0pO1xuICB9XG5cbiAgLy8gSW52b2ljZXNcbiAgYXN5bmMgY3JlYXRlSW52b2ljZShkYXRhOiB7XG4gICAgc3Vic2NyaXB0aW9uSWQ6IHN0cmluZztcbiAgICBzdWJ0b3RhbDogbnVtYmVyO1xuICAgIHRheEFtb3VudD86IG51bWJlcjtcbiAgICBkaXNjb3VudEFtb3VudD86IG51bWJlcjtcbiAgICBkdWVEYXRlOiBEYXRlO1xuICAgIGJpbGxpbmdBZGRyZXNzPzogYW55O1xuICB9KSB7XG4gICAgY29uc3QgdG90YWwgPVxuICAgICAgZGF0YS5zdWJ0b3RhbCArIChkYXRhLnRheEFtb3VudCB8fCAwKSAtIChkYXRhLmRpc2NvdW50QW1vdW50IHx8IDApO1xuICAgIGNvbnN0IGludm9pY2VOdW1iZXIgPSBhd2FpdCB0aGlzLmdlbmVyYXRlSW52b2ljZU51bWJlcigpO1xuXG4gICAgcmV0dXJuIHRoaXMucHJpc21hLmludm9pY2UuY3JlYXRlKHtcbiAgICAgIGRhdGE6IHtcbiAgICAgICAgLi4uZGF0YSxcbiAgICAgICAgbnVtYmVyOiBpbnZvaWNlTnVtYmVyLFxuICAgICAgICB0b3RhbCxcbiAgICAgICAgYW1vdW50RHVlOiB0b3RhbCxcbiAgICAgICAgc3RhdHVzOiBJbnZvaWNlU3RhdHVzLk9QRU4sXG4gICAgICB9LFxuICAgICAgaW5jbHVkZToge1xuICAgICAgICBzdWJzY3JpcHRpb246IHRydWUsXG4gICAgICAgIGxpbmVJdGVtczogdHJ1ZSxcbiAgICAgIH0sXG4gICAgfSk7XG4gIH1cblxuICBhc3luYyBmaW5kSW52b2ljZXMoc3Vic2NyaXB0aW9uSWQ/OiBzdHJpbmcsIHN0YXR1cz86IEludm9pY2VTdGF0dXMpIHtcbiAgICBjb25zdCB3aGVyZTogYW55ID0ge307XG5cbiAgICBpZiAoc3Vic2NyaXB0aW9uSWQpIHdoZXJlLnN1YnNjcmlwdGlvbklkID0gc3Vic2NyaXB0aW9uSWQ7XG4gICAgaWYgKHN0YXR1cykgd2hlcmUuc3RhdHVzID0gc3RhdHVzO1xuXG4gICAgcmV0dXJuIHRoaXMucHJpc21hLmludm9pY2UuZmluZE1hbnkoe1xuICAgICAgd2hlcmUsXG4gICAgICBpbmNsdWRlOiB7XG4gICAgICAgIHN1YnNjcmlwdGlvbjoge1xuICAgICAgICAgIGluY2x1ZGU6IHsgdXNlcjogdHJ1ZSB9LFxuICAgICAgICB9LFxuICAgICAgICBsaW5lSXRlbXM6IHRydWUsXG4gICAgICAgIHBheW1lbnRzOiB0cnVlLFxuICAgICAgfSxcbiAgICAgIG9yZGVyQnk6IHsgY3JlYXRlZEF0OiAnZGVzYycgfSxcbiAgICB9KTtcbiAgfVxuXG4gIGFzeW5jIG1hcmtJbnZvaWNlQXNQYWlkKGlkOiBzdHJpbmcpIHtcbiAgICBjb25zdCBpbnZvaWNlID0gYXdhaXQgdGhpcy5wcmlzbWEuaW52b2ljZS5maW5kVW5pcXVlKHtcbiAgICAgIHdoZXJlOiB7IGlkIH0sXG4gICAgICBpbmNsdWRlOiB7IHBheW1lbnRzOiB0cnVlIH0sXG4gICAgfSk7XG5cbiAgICBpZiAoIWludm9pY2UpIHtcbiAgICAgIHRocm93IG5ldyBOb3RGb3VuZEV4Y2VwdGlvbihgSW52b2ljZSB3aXRoIElEICR7aWR9IG5vdCBmb3VuZGApO1xuICAgIH1cblxuICAgIGNvbnN0IHRvdGFsUGFpZCA9IGludm9pY2UucGF5bWVudHNcbiAgICAgIC5maWx0ZXIoKHApID0+IHAuc3RhdHVzID09PSBQYXltZW50U3RhdHVzLlNVQ0NFRURFRClcbiAgICAgIC5yZWR1Y2UoKHN1bSwgcCkgPT4gc3VtICsgTnVtYmVyKHAuYW1vdW50KSwgMCk7XG5cbiAgICByZXR1cm4gdGhpcy5wcmlzbWEuaW52b2ljZS51cGRhdGUoe1xuICAgICAgd2hlcmU6IHsgaWQgfSxcbiAgICAgIGRhdGE6IHtcbiAgICAgICAgc3RhdHVzOlxuICAgICAgICAgIHRvdGFsUGFpZCA+PSBOdW1iZXIoaW52b2ljZS50b3RhbClcbiAgICAgICAgICAgID8gSW52b2ljZVN0YXR1cy5QQUlEXG4gICAgICAgICAgICA6IEludm9pY2VTdGF0dXMuT1BFTixcbiAgICAgICAgYW1vdW50UGFpZDogdG90YWxQYWlkLFxuICAgICAgICBwYWlkQXQ6IHRvdGFsUGFpZCA+PSBOdW1iZXIoaW52b2ljZS50b3RhbCkgPyBuZXcgRGF0ZSgpIDogbnVsbCxcbiAgICAgIH0sXG4gICAgfSk7XG4gIH1cblxuICAvLyBEaXNjb3VudHNcbiAgYXN5bmMgY3JlYXRlRGlzY291bnQoZGF0YToge1xuICAgIGNvZGU/OiBzdHJpbmc7XG4gICAgbmFtZTogc3RyaW5nO1xuICAgIGRlc2NyaXB0aW9uPzogc3RyaW5nO1xuICAgIHR5cGU6IERpc2NvdW50VHlwZTtcbiAgICBwZXJjZW50T2ZmPzogbnVtYmVyO1xuICAgIGFtb3VudE9mZj86IG51bWJlcjtcbiAgICB2YWxpZEZyb20/OiBEYXRlO1xuICAgIHZhbGlkVW50aWw/OiBEYXRlO1xuICAgIG1heFVzZXM/OiBudW1iZXI7XG4gICAgbWF4VXNlc1BlclVzZXI/OiBudW1iZXI7XG4gICAgYXBwbGljYWJsZVRpZXJzPzogU3Vic2NyaXB0aW9uVGllcltdO1xuICAgIG1pbkFtb3VudD86IG51bWJlcjtcbiAgfSkge1xuICAgIHJldHVybiB0aGlzLnByaXNtYS5kaXNjb3VudC5jcmVhdGUoe1xuICAgICAgZGF0YToge1xuICAgICAgICAuLi5kYXRhLFxuICAgICAgICB2YWxpZEZyb206IGRhdGEudmFsaWRGcm9tIHx8IG5ldyBEYXRlKCksXG4gICAgICB9LFxuICAgIH0pO1xuICB9XG5cbiAgYXN5bmMgdmFsaWRhdGVEaXNjb3VudChjb2RlOiBzdHJpbmcsIHVzZXJJZDogc3RyaW5nLCBhbW91bnQ6IG51bWJlcikge1xuICAgIGNvbnN0IGRpc2NvdW50ID0gYXdhaXQgdGhpcy5wcmlzbWEuZGlzY291bnQuZmluZFVuaXF1ZSh7XG4gICAgICB3aGVyZTogeyBjb2RlIH0sXG4gICAgICBpbmNsdWRlOiB7XG4gICAgICAgIHJlZGVtcHRpb25zOiB7XG4gICAgICAgICAgd2hlcmU6IHsgdXNlcklkIH0sXG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgaWYgKCFkaXNjb3VudCB8fCAhZGlzY291bnQuaXNBY3RpdmUpIHtcbiAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0RXhjZXB0aW9uKCdJbnZhbGlkIGRpc2NvdW50IGNvZGUnKTtcbiAgICB9XG5cbiAgICBjb25zdCBub3cgPSBuZXcgRGF0ZSgpO1xuICAgIGlmIChkaXNjb3VudC52YWxpZFVudGlsICYmIGRpc2NvdW50LnZhbGlkVW50aWwgPCBub3cpIHtcbiAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0RXhjZXB0aW9uKCdEaXNjb3VudCBjb2RlIGhhcyBleHBpcmVkJyk7XG4gICAgfVxuXG4gICAgaWYgKGRpc2NvdW50Lm1heFVzZXMgJiYgZGlzY291bnQuY3VycmVudFVzZXMgPj0gZGlzY291bnQubWF4VXNlcykge1xuICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFeGNlcHRpb24oJ0Rpc2NvdW50IGNvZGUgdXNhZ2UgbGltaXQgcmVhY2hlZCcpO1xuICAgIH1cblxuICAgIGlmIChcbiAgICAgIGRpc2NvdW50Lm1heFVzZXNQZXJVc2VyICYmXG4gICAgICBkaXNjb3VudC5yZWRlbXB0aW9ucy5sZW5ndGggPj0gZGlzY291bnQubWF4VXNlc1BlclVzZXJcbiAgICApIHtcbiAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0RXhjZXB0aW9uKCdZb3UgaGF2ZSBhbHJlYWR5IHVzZWQgdGhpcyBkaXNjb3VudCBjb2RlJyk7XG4gICAgfVxuXG4gICAgY29uc3QgbWluQW1vdW50TnVtID0gTnVtYmVyKGRpc2NvdW50Lm1pbkFtb3VudCk7XG4gICAgaWYgKGRpc2NvdW50Lm1pbkFtb3VudCAmJiAhaXNOYU4obWluQW1vdW50TnVtKSAmJiBhbW91bnQgPCBtaW5BbW91bnROdW0pIHtcbiAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0RXhjZXB0aW9uKFxuICAgICAgICBgTWluaW11bSBhbW91bnQgb2YgJHtTdHJpbmcoZGlzY291bnQubWluQW1vdW50KX0gcmVxdWlyZWRgLFxuICAgICAgKTtcbiAgICB9XG5cbiAgICByZXR1cm4gZGlzY291bnQ7XG4gIH1cblxuICBhc3luYyByZWRlZW1EaXNjb3VudChcbiAgICBkaXNjb3VudElkOiBzdHJpbmcsXG4gICAgdXNlcklkOiBzdHJpbmcsXG4gICAgYW1vdW50U2F2ZWQ6IG51bWJlcixcbiAgKSB7XG4gICAgYXdhaXQgdGhpcy5wcmlzbWEuJHRyYW5zYWN0aW9uKGFzeW5jICh0eCkgPT4ge1xuICAgICAgLy8gQ3JlYXRlIHJlZGVtcHRpb24gcmVjb3JkXG4gICAgICBhd2FpdCB0eC5kaXNjb3VudFJlZGVtcHRpb24uY3JlYXRlKHtcbiAgICAgICAgZGF0YToge1xuICAgICAgICAgIGRpc2NvdW50SWQsXG4gICAgICAgICAgdXNlcklkLFxuICAgICAgICAgIGFtb3VudFNhdmVkLFxuICAgICAgICB9LFxuICAgICAgfSk7XG5cbiAgICAgIC8vIFVwZGF0ZSBkaXNjb3VudCB1c2FnZSBjb3VudFxuICAgICAgYXdhaXQgdHguZGlzY291bnQudXBkYXRlKHtcbiAgICAgICAgd2hlcmU6IHsgaWQ6IGRpc2NvdW50SWQgfSxcbiAgICAgICAgZGF0YToge1xuICAgICAgICAgIGN1cnJlbnRVc2VzOiB7IGluY3JlbWVudDogMSB9LFxuICAgICAgICB9LFxuICAgICAgfSk7XG4gICAgfSk7XG4gIH1cblxuICAvLyBVc2FnZSBSZWNvcmRzXG4gIGFzeW5jIHJlY29yZFVzYWdlKGRhdGE6IHtcbiAgICBzdWJzY3JpcHRpb25JZDogc3RyaW5nO1xuICAgIGZlYXR1cmU6IHN0cmluZztcbiAgICBxdWFudGl0eTogbnVtYmVyO1xuICAgIHVuaXQ6IHN0cmluZztcbiAgICB1c2FnZURhdGU/OiBEYXRlO1xuICAgIG1ldGFkYXRhPzogYW55O1xuICB9KSB7XG4gICAgcmV0dXJuIHRoaXMucHJpc21hLnVzYWdlUmVjb3JkLmNyZWF0ZSh7XG4gICAgICBkYXRhOiB7XG4gICAgICAgIC4uLmRhdGEsXG4gICAgICAgIHVzYWdlRGF0ZTogZGF0YS51c2FnZURhdGUgfHwgbmV3IERhdGUoKSxcbiAgICAgIH0sXG4gICAgfSk7XG4gIH1cblxuICBhc3luYyBnZXRVc2FnZVJlY29yZHMoXG4gICAgc3Vic2NyaXB0aW9uSWQ6IHN0cmluZyxcbiAgICBmZWF0dXJlPzogc3RyaW5nLFxuICAgIHN0YXJ0RGF0ZT86IERhdGUsXG4gICAgZW5kRGF0ZT86IERhdGUsXG4gICkge1xuICAgIGNvbnN0IHdoZXJlOiBhbnkgPSB7IHN1YnNjcmlwdGlvbklkIH07XG5cbiAgICBpZiAoZmVhdHVyZSkgd2hlcmUuZmVhdHVyZSA9IGZlYXR1cmU7XG4gICAgaWYgKHN0YXJ0RGF0ZSkgd2hlcmUudXNhZ2VEYXRlID0geyAuLi53aGVyZS51c2FnZURhdGUsIGd0ZTogc3RhcnREYXRlIH07XG4gICAgaWYgKGVuZERhdGUpIHdoZXJlLnVzYWdlRGF0ZSA9IHsgLi4ud2hlcmUudXNhZ2VEYXRlLCBsdGU6IGVuZERhdGUgfTtcblxuICAgIHJldHVybiB0aGlzLnByaXNtYS51c2FnZVJlY29yZC5maW5kTWFueSh7XG4gICAgICB3aGVyZSxcbiAgICAgIG9yZGVyQnk6IHsgdXNhZ2VEYXRlOiAnZGVzYycgfSxcbiAgICB9KTtcbiAgfVxuXG4gIC8vIEhlbHBlciBtZXRob2RzXG4gIHByaXZhdGUgYXN5bmMgZ2VuZXJhdGVJbnZvaWNlTnVtYmVyKCk6IFByb21pc2U8c3RyaW5nPiB7XG4gICAgY29uc3QgeWVhciA9IG5ldyBEYXRlKCkuZ2V0RnVsbFllYXIoKTtcbiAgICBjb25zdCBsYXN0SW52b2ljZSA9IGF3YWl0IHRoaXMucHJpc21hLmludm9pY2UuZmluZEZpcnN0KHtcbiAgICAgIHdoZXJlOiB7XG4gICAgICAgIG51bWJlcjogeyBzdGFydHNXaXRoOiBgSU5WLSR7eWVhcn0tYCB9LFxuICAgICAgfSxcbiAgICAgIG9yZGVyQnk6IHsgbnVtYmVyOiAnZGVzYycgfSxcbiAgICB9KTtcblxuICAgIGxldCBuZXh0TnVtYmVyID0gMTtcbiAgICBpZiAobGFzdEludm9pY2UpIHtcbiAgICAgIGNvbnN0IHBhcnRzID0gbGFzdEludm9pY2UubnVtYmVyLnNwbGl0KCctJyk7XG4gICAgICBpZiAocGFydHMubGVuZ3RoID49IDMgJiYgcGFydHNbMl0pIHtcbiAgICAgICAgY29uc3QgbGFzdE51bWJlciA9IHBhcnNlSW50KHBhcnRzWzJdLCAxMCk7XG4gICAgICAgIGlmICghaXNOYU4obGFzdE51bWJlcikpIHtcbiAgICAgICAgICBuZXh0TnVtYmVyID0gbGFzdE51bWJlciArIDE7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gYElOVi0ke3llYXJ9LSR7bmV4dE51bWJlci50b1N0cmluZygpLnBhZFN0YXJ0KDYsICcwJyl9YDtcbiAgfVxuXG4gIGFzeW5jIGdldEJpbGxpbmdTdGF0aXN0aWNzKHN0YXJ0RGF0ZT86IERhdGUsIGVuZERhdGU/OiBEYXRlKSB7XG4gICAgY29uc3Qgd2hlcmU6IGFueSA9IHt9O1xuICAgIGlmIChzdGFydERhdGUpIHdoZXJlLmNyZWF0ZWRBdCA9IHsgLi4ud2hlcmUuY3JlYXRlZEF0LCBndGU6IHN0YXJ0RGF0ZSB9O1xuICAgIGlmIChlbmREYXRlKSB3aGVyZS5jcmVhdGVkQXQgPSB7IC4uLndoZXJlLmNyZWF0ZWRBdCwgbHRlOiBlbmREYXRlIH07XG5cbiAgICBjb25zdCBbXG4gICAgICB0b3RhbFJldmVudWUsXG4gICAgICBhY3RpdmVTdWJzY3JpcHRpb25zLFxuICAgICAgdHJpYWxTdWJzY3JpcHRpb25zLFxuICAgICAgY2FuY2VsZWRTdWJzY3JpcHRpb25zLFxuICAgICAgc3Vic2NyaXB0aW9uc0J5VGllcixcbiAgICBdID0gYXdhaXQgUHJvbWlzZS5hbGwoW1xuICAgICAgdGhpcy5wcmlzbWEucGF5bWVudC5hZ2dyZWdhdGUoe1xuICAgICAgICB3aGVyZTogeyAuLi53aGVyZSwgc3RhdHVzOiBQYXltZW50U3RhdHVzLlNVQ0NFRURFRCB9LFxuICAgICAgICBfc3VtOiB7IGFtb3VudDogdHJ1ZSB9LFxuICAgICAgfSksXG4gICAgICB0aGlzLnByaXNtYS5zdWJzY3JpcHRpb24uY291bnQoe1xuICAgICAgICB3aGVyZTogeyBzdGF0dXM6IFN1YnNjcmlwdGlvblN0YXR1cy5BQ1RJVkUgfSxcbiAgICAgIH0pLFxuICAgICAgdGhpcy5wcmlzbWEuc3Vic2NyaXB0aW9uLmNvdW50KHtcbiAgICAgICAgd2hlcmU6IHsgc3RhdHVzOiBTdWJzY3JpcHRpb25TdGF0dXMuVFJJQUxJTkcgfSxcbiAgICAgIH0pLFxuICAgICAgdGhpcy5wcmlzbWEuc3Vic2NyaXB0aW9uLmNvdW50KHtcbiAgICAgICAgd2hlcmU6IHsgc3RhdHVzOiBTdWJzY3JpcHRpb25TdGF0dXMuQ0FOQ0VMRUQgfSxcbiAgICAgIH0pLFxuICAgICAgdGhpcy5wcmlzbWEuc3Vic2NyaXB0aW9uLmdyb3VwQnkoe1xuICAgICAgICBieTogWyd0aWVyJ10sXG4gICAgICAgIHdoZXJlOiB7IHN0YXR1czogU3Vic2NyaXB0aW9uU3RhdHVzLkFDVElWRSB9LFxuICAgICAgICBfY291bnQ6IHsgdGllcjogdHJ1ZSB9LFxuICAgICAgfSksXG4gICAgXSk7XG5cbiAgICByZXR1cm4ge1xuICAgICAgdG90YWxSZXZlbnVlOiB0b3RhbFJldmVudWUuX3N1bS5hbW91bnQgfHwgMCxcbiAgICAgIGFjdGl2ZVN1YnNjcmlwdGlvbnMsXG4gICAgICB0cmlhbFN1YnNjcmlwdGlvbnMsXG4gICAgICBjYW5jZWxlZFN1YnNjcmlwdGlvbnMsXG4gICAgICBzdWJzY3JpcHRpb25zQnlUaWVyLFxuICAgIH07XG4gIH1cblxuICAvLyA9PT09PSBBRFZBTkNFRCBTVUJTQ1JJUFRJT04gTUFOQUdFTUVOVCA9PT09PVxuXG4gIC8qKlxuICAgKiBVcGdyYWRlIG9yIGRvd25ncmFkZSBzdWJzY3JpcHRpb24gd2l0aCBwcm9yYXRlZCBiaWxsaW5nXG4gICAqL1xuICBhc3luYyBjaGFuZ2VTdWJzY3JpcHRpb25QbGFuKFxuICAgIHVzZXJJZDogc3RyaW5nLFxuICAgIG5ld1BsYW5JZDogc3RyaW5nLFxuICAgIG9wdGlvbnM6IHtcbiAgICAgIGJpbGxpbmdDeWNsZT86IEJpbGxpbmdDeWNsZTtcbiAgICAgIHByb3JhdGlvbkJlaGF2aW9yPzogJ2NyZWF0ZV9wcm9yYXRpb25zJyB8ICdub25lJyB8ICdhbHdheXNfaW52b2ljZSc7XG4gICAgICBlZmZlY3RpdmVEYXRlPzogRGF0ZTtcbiAgICB9ID0ge30sXG4gICkge1xuICAgIGNvbnN0IHN1YnNjcmlwdGlvbiA9IGF3YWl0IHRoaXMuZmluZFVzZXJTdWJzY3JpcHRpb24odXNlcklkKTtcbiAgICBpZiAoIXN1YnNjcmlwdGlvbikge1xuICAgICAgdGhyb3cgbmV3IE5vdEZvdW5kRXhjZXB0aW9uKGBTdWJzY3JpcHRpb24gZm9yIHVzZXIgJHt1c2VySWR9IG5vdCBmb3VuZGApO1xuICAgIH1cblxuICAgIGNvbnN0IG5ld1BsYW4gPSBhd2FpdCB0aGlzLnByaXNtYS5zdWJzY3JpcHRpb25QbGFuLmZpbmRVbmlxdWUoe1xuICAgICAgd2hlcmU6IHsgaWQ6IG5ld1BsYW5JZCB9LFxuICAgIH0pO1xuXG4gICAgaWYgKCFuZXdQbGFuKSB7XG4gICAgICB0aHJvdyBuZXcgTm90Rm91bmRFeGNlcHRpb24oYFBsYW4gJHtuZXdQbGFuSWR9IG5vdCBmb3VuZGApO1xuICAgIH1cblxuICAgIGNvbnN0IGVmZmVjdGl2ZURhdGUgPSBvcHRpb25zLmVmZmVjdGl2ZURhdGUgfHwgbmV3IERhdGUoKTtcbiAgICBjb25zdCBuZXdCaWxsaW5nQ3ljbGUgPSBvcHRpb25zLmJpbGxpbmdDeWNsZSB8fCBzdWJzY3JpcHRpb24uYmlsbGluZ0N5Y2xlO1xuICAgIGNvbnN0IG5ld0Ftb3VudCA9XG4gICAgICBuZXdCaWxsaW5nQ3ljbGUgPT09IEJpbGxpbmdDeWNsZS5ZRUFSTFlcbiAgICAgICAgPyBuZXdQbGFuLnllYXJseVByaWNlIHx8IG5ld1BsYW4ubW9udGhseVByaWNlXG4gICAgICAgIDogbmV3UGxhbi5tb250aGx5UHJpY2U7XG5cbiAgICAvLyBDYWxjdWxhdGUgcHJvcmF0aW9uIGlmIG5lZWRlZFxuICAgIGxldCBwcm9yYXRpb25BbW91bnQgPSAwO1xuICAgIGlmIChvcHRpb25zLnByb3JhdGlvbkJlaGF2aW9yICE9PSAnbm9uZScpIHtcbiAgICAgIHByb3JhdGlvbkFtb3VudCA9IGF3YWl0IHRoaXMuY2FsY3VsYXRlUHJvcmF0aW9uKFxuICAgICAgICBzdWJzY3JpcHRpb24sXG4gICAgICAgIE51bWJlcihuZXdBbW91bnQpLFxuICAgICAgICBlZmZlY3RpdmVEYXRlLFxuICAgICAgKTtcbiAgICB9XG5cbiAgICByZXR1cm4gYXdhaXQgdGhpcy5wcmlzbWEuJHRyYW5zYWN0aW9uKGFzeW5jICh0eCkgPT4ge1xuICAgICAgLy8gVXBkYXRlIHN1YnNjcmlwdGlvblxuICAgICAgY29uc3QgdXBkYXRlZFN1YnNjcmlwdGlvbiA9IGF3YWl0IHR4LnN1YnNjcmlwdGlvbi51cGRhdGUoe1xuICAgICAgICB3aGVyZTogeyB1c2VySWQgfSxcbiAgICAgICAgZGF0YToge1xuICAgICAgICAgIHBsYW5JZDogbmV3UGxhbklkLFxuICAgICAgICAgIHRpZXI6IG5ld1BsYW4udGllcixcbiAgICAgICAgICBiaWxsaW5nQ3ljbGU6IG5ld0JpbGxpbmdDeWNsZSxcbiAgICAgICAgICBhbW91bnQ6IG5ld0Ftb3VudCxcbiAgICAgICAgICBtZXRhZGF0YToge1xuICAgICAgICAgICAgLi4uKHR5cGVvZiBzdWJzY3JpcHRpb24ubWV0YWRhdGEgPT09ICdvYmplY3QnICYmXG4gICAgICAgICAgICBzdWJzY3JpcHRpb24ubWV0YWRhdGEgIT09IG51bGxcbiAgICAgICAgICAgICAgPyAoc3Vic2NyaXB0aW9uLm1ldGFkYXRhIGFzIFJlY29yZDxzdHJpbmcsIGFueT4pXG4gICAgICAgICAgICAgIDoge30pLFxuICAgICAgICAgICAgbGFzdFBsYW5DaGFuZ2U6IGVmZmVjdGl2ZURhdGUudG9JU09TdHJpbmcoKSxcbiAgICAgICAgICAgIHByZXZpb3VzUGxhbklkOiBzdWJzY3JpcHRpb24ucGxhbklkLFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICAgIGluY2x1ZGU6IHtcbiAgICAgICAgICBwbGFuOiB0cnVlLFxuICAgICAgICAgIGRlZmF1bHRQYXltZW50TWV0aG9kOiB0cnVlLFxuICAgICAgICB9LFxuICAgICAgfSk7XG5cbiAgICAgIC8vIENyZWF0ZSBwcm9yYXRpb24gaW52b2ljZSBpZiBuZWVkZWRcbiAgICAgIGlmIChwcm9yYXRpb25BbW91bnQgIT09IDAgJiYgb3B0aW9ucy5wcm9yYXRpb25CZWhhdmlvciAhPT0gJ25vbmUnKSB7XG4gICAgICAgIGF3YWl0IHRoaXMuY3JlYXRlUHJvcmF0aW9uSW52b2ljZShcbiAgICAgICAgICB0eCxcbiAgICAgICAgICBzdWJzY3JpcHRpb24uaWQsXG4gICAgICAgICAgcHJvcmF0aW9uQW1vdW50LFxuICAgICAgICAgIGVmZmVjdGl2ZURhdGUsXG4gICAgICAgICk7XG4gICAgICB9XG5cbiAgICAgIC8vIEVtaXQgZXZlbnRcbiAgICAgIHRoaXMuZXZlbnRFbWl0dGVyLmVtaXQoJ3N1YnNjcmlwdGlvbi5wbGFuLmNoYW5nZWQnLCB7XG4gICAgICAgIHVzZXJJZCxcbiAgICAgICAgc3Vic2NyaXB0aW9uSWQ6IHN1YnNjcmlwdGlvbi5pZCxcbiAgICAgICAgcHJldmlvdXNQbGFuSWQ6IHN1YnNjcmlwdGlvbi5wbGFuSWQsXG4gICAgICAgIG5ld1BsYW5JZCxcbiAgICAgICAgcHJvcmF0aW9uQW1vdW50LFxuICAgICAgICBlZmZlY3RpdmVEYXRlLFxuICAgICAgfSk7XG5cbiAgICAgIHRoaXMubG9nZ2VyLmxvZyhcbiAgICAgICAgYFVzZXIgJHt1c2VySWR9IGNoYW5nZWQgc3Vic2NyaXB0aW9uIHBsYW4gZnJvbSAke3N1YnNjcmlwdGlvbi5wbGFuSWR9IHRvICR7bmV3UGxhbklkfWAsXG4gICAgICApO1xuXG4gICAgICByZXR1cm4gdXBkYXRlZFN1YnNjcmlwdGlvbjtcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBQYXVzZSBzdWJzY3JpcHRpb24gKGtlZXAgaXQgYWN0aXZlIGJ1dCBzdG9wIGJpbGxpbmcpXG4gICAqL1xuICBhc3luYyBwYXVzZVN1YnNjcmlwdGlvbihcbiAgICB1c2VySWQ6IHN0cmluZyxcbiAgICBvcHRpb25zOiB7XG4gICAgICBwYXVzZVVudGlsPzogRGF0ZTtcbiAgICAgIHJlYXNvbj86IHN0cmluZztcbiAgICB9ID0ge30sXG4gICkge1xuICAgIGNvbnN0IHN1YnNjcmlwdGlvbiA9IGF3YWl0IHRoaXMuZmluZFVzZXJTdWJzY3JpcHRpb24odXNlcklkKTtcbiAgICBpZiAoIXN1YnNjcmlwdGlvbikge1xuICAgICAgdGhyb3cgbmV3IE5vdEZvdW5kRXhjZXB0aW9uKGBTdWJzY3JpcHRpb24gZm9yIHVzZXIgJHt1c2VySWR9IG5vdCBmb3VuZGApO1xuICAgIH1cblxuICAgIGlmIChzdWJzY3JpcHRpb24uc3RhdHVzICE9PSBTdWJzY3JpcHRpb25TdGF0dXMuQUNUSVZFKSB7XG4gICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdEV4Y2VwdGlvbignQ2FuIG9ubHkgcGF1c2UgYWN0aXZlIHN1YnNjcmlwdGlvbnMnKTtcbiAgICB9XG5cbiAgICBjb25zdCB1cGRhdGVkU3Vic2NyaXB0aW9uID0gYXdhaXQgdGhpcy5wcmlzbWEuc3Vic2NyaXB0aW9uLnVwZGF0ZSh7XG4gICAgICB3aGVyZTogeyB1c2VySWQgfSxcbiAgICAgIGRhdGE6IHtcbiAgICAgICAgc3RhdHVzOiBTdWJzY3JpcHRpb25TdGF0dXMuUEFVU0VELFxuICAgICAgICBtZXRhZGF0YToge1xuICAgICAgICAgIC4uLih0eXBlb2Ygc3Vic2NyaXB0aW9uLm1ldGFkYXRhID09PSAnb2JqZWN0JyAmJlxuICAgICAgICAgIHN1YnNjcmlwdGlvbi5tZXRhZGF0YSAhPT0gbnVsbFxuICAgICAgICAgICAgPyAoc3Vic2NyaXB0aW9uLm1ldGFkYXRhIGFzIFJlY29yZDxzdHJpbmcsIGFueT4pXG4gICAgICAgICAgICA6IHt9KSxcbiAgICAgICAgICBwYXVzZWRBdDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLFxuICAgICAgICAgIHBhdXNlVW50aWw6IG9wdGlvbnMucGF1c2VVbnRpbD8udG9JU09TdHJpbmcoKSxcbiAgICAgICAgICBwYXVzZVJlYXNvbjogb3B0aW9ucy5yZWFzb24sXG4gICAgICAgICAgcHJldmlvdXNTdGF0dXM6IHN1YnNjcmlwdGlvbi5zdGF0dXMsXG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgICAgaW5jbHVkZToge1xuICAgICAgICBwbGFuOiB0cnVlLFxuICAgICAgICBkZWZhdWx0UGF5bWVudE1ldGhvZDogdHJ1ZSxcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICB0aGlzLmV2ZW50RW1pdHRlci5lbWl0KCdzdWJzY3JpcHRpb24ucGF1c2VkJywge1xuICAgICAgdXNlcklkLFxuICAgICAgc3Vic2NyaXB0aW9uSWQ6IHN1YnNjcmlwdGlvbi5pZCxcbiAgICAgIHBhdXNlVW50aWw6IG9wdGlvbnMucGF1c2VVbnRpbCxcbiAgICAgIHJlYXNvbjogb3B0aW9ucy5yZWFzb24sXG4gICAgfSk7XG5cbiAgICB0aGlzLmxvZ2dlci5sb2coXG4gICAgICBgU3Vic2NyaXB0aW9uICR7c3Vic2NyaXB0aW9uLmlkfSBwYXVzZWQgZm9yIHVzZXIgJHt1c2VySWR9YCxcbiAgICApO1xuXG4gICAgcmV0dXJuIHVwZGF0ZWRTdWJzY3JpcHRpb247XG4gIH1cblxuICAvKipcbiAgICogUmVzdW1lIHBhdXNlZCBzdWJzY3JpcHRpb25cbiAgICovXG4gIGFzeW5jIHJlc3VtZVN1YnNjcmlwdGlvbih1c2VySWQ6IHN0cmluZykge1xuICAgIGNvbnN0IHN1YnNjcmlwdGlvbiA9IGF3YWl0IHRoaXMuZmluZFVzZXJTdWJzY3JpcHRpb24odXNlcklkKTtcbiAgICBpZiAoIXN1YnNjcmlwdGlvbikge1xuICAgICAgdGhyb3cgbmV3IE5vdEZvdW5kRXhjZXB0aW9uKGBTdWJzY3JpcHRpb24gZm9yIHVzZXIgJHt1c2VySWR9IG5vdCBmb3VuZGApO1xuICAgIH1cblxuICAgIGlmIChzdWJzY3JpcHRpb24uc3RhdHVzICE9PSBTdWJzY3JpcHRpb25TdGF0dXMuUEFVU0VEKSB7XG4gICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdEV4Y2VwdGlvbignQ2FuIG9ubHkgcmVzdW1lIHBhdXNlZCBzdWJzY3JpcHRpb25zJyk7XG4gICAgfVxuXG4gICAgY29uc3QgbWV0YWRhdGEgPSBzdWJzY3JpcHRpb24ubWV0YWRhdGEgYXMgYW55O1xuICAgIGNvbnN0IHByZXZpb3VzU3RhdHVzID1cbiAgICAgIG1ldGFkYXRhPy5wcmV2aW91c1N0YXR1cyB8fCBTdWJzY3JpcHRpb25TdGF0dXMuQUNUSVZFO1xuXG4gICAgY29uc3QgdXBkYXRlZFN1YnNjcmlwdGlvbiA9IGF3YWl0IHRoaXMucHJpc21hLnN1YnNjcmlwdGlvbi51cGRhdGUoe1xuICAgICAgd2hlcmU6IHsgdXNlcklkIH0sXG4gICAgICBkYXRhOiB7XG4gICAgICAgIHN0YXR1czogcHJldmlvdXNTdGF0dXMsXG4gICAgICAgIG1ldGFkYXRhOiB7XG4gICAgICAgICAgLi4ubWV0YWRhdGEsXG4gICAgICAgICAgcmVzdW1lZEF0OiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksXG4gICAgICAgICAgcGF1c2VkQXQ6IHVuZGVmaW5lZCxcbiAgICAgICAgICBwYXVzZVVudGlsOiB1bmRlZmluZWQsXG4gICAgICAgICAgcGF1c2VSZWFzb246IHVuZGVmaW5lZCxcbiAgICAgICAgICBwcmV2aW91c1N0YXR1czogdW5kZWZpbmVkLFxuICAgICAgICB9LFxuICAgICAgfSxcbiAgICAgIGluY2x1ZGU6IHtcbiAgICAgICAgcGxhbjogdHJ1ZSxcbiAgICAgICAgZGVmYXVsdFBheW1lbnRNZXRob2Q6IHRydWUsXG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgdGhpcy5ldmVudEVtaXR0ZXIuZW1pdCgnc3Vic2NyaXB0aW9uLnJlc3VtZWQnLCB7XG4gICAgICB1c2VySWQsXG4gICAgICBzdWJzY3JpcHRpb25JZDogc3Vic2NyaXB0aW9uLmlkLFxuICAgIH0pO1xuXG4gICAgdGhpcy5sb2dnZXIubG9nKFxuICAgICAgYFN1YnNjcmlwdGlvbiAke3N1YnNjcmlwdGlvbi5pZH0gcmVzdW1lZCBmb3IgdXNlciAke3VzZXJJZH1gLFxuICAgICk7XG5cbiAgICByZXR1cm4gdXBkYXRlZFN1YnNjcmlwdGlvbjtcbiAgfVxuXG4gIC8qKlxuICAgKiBTY2hlZHVsZSBzdWJzY3JpcHRpb24gY2FuY2VsbGF0aW9uIGF0IHBlcmlvZCBlbmRcbiAgICovXG4gIGFzeW5jIHNjaGVkdWxlU3Vic2NyaXB0aW9uQ2FuY2VsbGF0aW9uKFxuICAgIHVzZXJJZDogc3RyaW5nLFxuICAgIG9wdGlvbnM6IHtcbiAgICAgIHJlYXNvbj86IHN0cmluZztcbiAgICAgIGZlZWRiYWNrPzogc3RyaW5nO1xuICAgICAgY2FuY2VsQXRQZXJpb2RFbmQ/OiBib29sZWFuO1xuICAgIH0gPSB7fSxcbiAgKSB7XG4gICAgY29uc3Qgc3Vic2NyaXB0aW9uID0gYXdhaXQgdGhpcy5maW5kVXNlclN1YnNjcmlwdGlvbih1c2VySWQpO1xuICAgIGlmICghc3Vic2NyaXB0aW9uKSB7XG4gICAgICB0aHJvdyBuZXcgTm90Rm91bmRFeGNlcHRpb24oYFN1YnNjcmlwdGlvbiBmb3IgdXNlciAke3VzZXJJZH0gbm90IGZvdW5kYCk7XG4gICAgfVxuXG4gICAgY29uc3QgY2FuY2VsQXRQZXJpb2RFbmQgPSBvcHRpb25zLmNhbmNlbEF0UGVyaW9kRW5kID8/IHRydWU7XG4gICAgY29uc3QgY2FuY2VsRGF0ZSA9IGNhbmNlbEF0UGVyaW9kRW5kXG4gICAgICA/IHN1YnNjcmlwdGlvbi5jdXJyZW50UGVyaW9kRW5kXG4gICAgICA6IG5ldyBEYXRlKCk7XG5cbiAgICBjb25zdCB1cGRhdGVkU3Vic2NyaXB0aW9uID0gYXdhaXQgdGhpcy5wcmlzbWEuc3Vic2NyaXB0aW9uLnVwZGF0ZSh7XG4gICAgICB3aGVyZTogeyB1c2VySWQgfSxcbiAgICAgIGRhdGE6IHtcbiAgICAgICAgc3RhdHVzOiBjYW5jZWxBdFBlcmlvZEVuZFxuICAgICAgICAgID8gc3Vic2NyaXB0aW9uLnN0YXR1c1xuICAgICAgICAgIDogU3Vic2NyaXB0aW9uU3RhdHVzLkNBTkNFTEVELFxuICAgICAgICBjYW5jZWxlZEF0OiBjYW5jZWxBdFBlcmlvZEVuZCA/IG51bGwgOiBuZXcgRGF0ZSgpLFxuICAgICAgICBlbmRlZEF0OiBjYW5jZWxBdFBlcmlvZEVuZCA/IHN1YnNjcmlwdGlvbi5jdXJyZW50UGVyaW9kRW5kIDogbmV3IERhdGUoKSxcbiAgICAgICAgY2FuY2VsUmVhc29uOiBvcHRpb25zLnJlYXNvbixcbiAgICAgICAgY2FuY2VsZWRCeTogdXNlcklkLFxuICAgICAgICBtZXRhZGF0YToge1xuICAgICAgICAgIC4uLih0eXBlb2Ygc3Vic2NyaXB0aW9uLm1ldGFkYXRhID09PSAnb2JqZWN0JyAmJlxuICAgICAgICAgIHN1YnNjcmlwdGlvbi5tZXRhZGF0YSAhPT0gbnVsbFxuICAgICAgICAgICAgPyAoc3Vic2NyaXB0aW9uLm1ldGFkYXRhIGFzIFJlY29yZDxzdHJpbmcsIGFueT4pXG4gICAgICAgICAgICA6IHt9KSxcbiAgICAgICAgICBzY2hlZHVsZWRDYW5jZWxsYXRpb246IGNhbmNlbEF0UGVyaW9kRW5kLFxuICAgICAgICAgIGNhbmNlbGxhdGlvbkZlZWRiYWNrOiBvcHRpb25zLmZlZWRiYWNrLFxuICAgICAgICAgIGNhbmNlbGxhdGlvblNjaGVkdWxlZEF0OiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksXG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgICAgaW5jbHVkZToge1xuICAgICAgICBwbGFuOiB0cnVlLFxuICAgICAgICBkZWZhdWx0UGF5bWVudE1ldGhvZDogdHJ1ZSxcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICB0aGlzLmV2ZW50RW1pdHRlci5lbWl0KCdzdWJzY3JpcHRpb24uY2FuY2VsbGF0aW9uLnNjaGVkdWxlZCcsIHtcbiAgICAgIHVzZXJJZCxcbiAgICAgIHN1YnNjcmlwdGlvbklkOiBzdWJzY3JpcHRpb24uaWQsXG4gICAgICBjYW5jZWxEYXRlLFxuICAgICAgcmVhc29uOiBvcHRpb25zLnJlYXNvbixcbiAgICAgIGZlZWRiYWNrOiBvcHRpb25zLmZlZWRiYWNrLFxuICAgICAgY2FuY2VsQXRQZXJpb2RFbmQsXG4gICAgfSk7XG5cbiAgICB0aGlzLmxvZ2dlci5sb2coXG4gICAgICBgU3Vic2NyaXB0aW9uIGNhbmNlbGxhdGlvbiBzY2hlZHVsZWQgZm9yIHVzZXIgJHt1c2VySWR9LCBlZmZlY3RpdmUgJHtjYW5jZWxEYXRlfWAsXG4gICAgKTtcblxuICAgIHJldHVybiB1cGRhdGVkU3Vic2NyaXB0aW9uO1xuICB9XG5cbiAgLyoqXG4gICAqIFJlYWN0aXZhdGUgYSBjYW5jZWxlZCBzdWJzY3JpcHRpb25cbiAgICovXG4gIGFzeW5jIHJlYWN0aXZhdGVTdWJzY3JpcHRpb24odXNlcklkOiBzdHJpbmcsIG5ld1BheW1lbnRNZXRob2RJZD86IHN0cmluZykge1xuICAgIGNvbnN0IHN1YnNjcmlwdGlvbiA9IGF3YWl0IHRoaXMuZmluZFVzZXJTdWJzY3JpcHRpb24odXNlcklkKTtcbiAgICBpZiAoIXN1YnNjcmlwdGlvbikge1xuICAgICAgdGhyb3cgbmV3IE5vdEZvdW5kRXhjZXB0aW9uKGBTdWJzY3JpcHRpb24gZm9yIHVzZXIgJHt1c2VySWR9IG5vdCBmb3VuZGApO1xuICAgIH1cblxuICAgIGlmIChzdWJzY3JpcHRpb24uc3RhdHVzICE9PSBTdWJzY3JpcHRpb25TdGF0dXMuQ0FOQ0VMRUQpIHtcbiAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0RXhjZXB0aW9uKFxuICAgICAgICAnQ2FuIG9ubHkgcmVhY3RpdmF0ZSBjYW5jZWxlZCBzdWJzY3JpcHRpb25zJyxcbiAgICAgICk7XG4gICAgfVxuXG4gICAgLy8gUmVzZXQgcGVyaW9kIGRhdGVzXG4gICAgY29uc3QgY3VycmVudFBlcmlvZFN0YXJ0ID0gbmV3IERhdGUoKTtcbiAgICBjb25zdCBjdXJyZW50UGVyaW9kRW5kID0gbmV3IERhdGUoKTtcblxuICAgIGlmIChzdWJzY3JpcHRpb24uYmlsbGluZ0N5Y2xlID09PSBCaWxsaW5nQ3ljbGUuWUVBUkxZKSB7XG4gICAgICBjdXJyZW50UGVyaW9kRW5kLnNldEZ1bGxZZWFyKGN1cnJlbnRQZXJpb2RFbmQuZ2V0RnVsbFllYXIoKSArIDEpO1xuICAgIH0gZWxzZSB7XG4gICAgICBjdXJyZW50UGVyaW9kRW5kLnNldE1vbnRoKGN1cnJlbnRQZXJpb2RFbmQuZ2V0TW9udGgoKSArIDEpO1xuICAgIH1cblxuICAgIGNvbnN0IHVwZGF0ZWRTdWJzY3JpcHRpb24gPSBhd2FpdCB0aGlzLnByaXNtYS5zdWJzY3JpcHRpb24udXBkYXRlKHtcbiAgICAgIHdoZXJlOiB7IHVzZXJJZCB9LFxuICAgICAgZGF0YToge1xuICAgICAgICBzdGF0dXM6IFN1YnNjcmlwdGlvblN0YXR1cy5BQ1RJVkUsXG4gICAgICAgIGN1cnJlbnRQZXJpb2RTdGFydCxcbiAgICAgICAgY3VycmVudFBlcmlvZEVuZCxcbiAgICAgICAgY2FuY2VsZWRBdDogbnVsbCxcbiAgICAgICAgZW5kZWRBdDogbnVsbCxcbiAgICAgICAgY2FuY2VsUmVhc29uOiBudWxsLFxuICAgICAgICBkZWZhdWx0UGF5bWVudE1ldGhvZElkOlxuICAgICAgICAgIG5ld1BheW1lbnRNZXRob2RJZCB8fCBzdWJzY3JpcHRpb24uZGVmYXVsdFBheW1lbnRNZXRob2RJZCxcbiAgICAgICAgbWV0YWRhdGE6IHtcbiAgICAgICAgICAuLi4odHlwZW9mIHN1YnNjcmlwdGlvbi5tZXRhZGF0YSA9PT0gJ29iamVjdCcgJiZcbiAgICAgICAgICBzdWJzY3JpcHRpb24ubWV0YWRhdGEgIT09IG51bGxcbiAgICAgICAgICAgID8gKHN1YnNjcmlwdGlvbi5tZXRhZGF0YSBhcyBSZWNvcmQ8c3RyaW5nLCBhbnk+KVxuICAgICAgICAgICAgOiB7fSksXG4gICAgICAgICAgcmVhY3RpdmF0ZWRBdDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLFxuICAgICAgICAgIHNjaGVkdWxlZENhbmNlbGxhdGlvbjogZmFsc2UsXG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgICAgaW5jbHVkZToge1xuICAgICAgICBwbGFuOiB0cnVlLFxuICAgICAgICBkZWZhdWx0UGF5bWVudE1ldGhvZDogdHJ1ZSxcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICB0aGlzLmV2ZW50RW1pdHRlci5lbWl0KCdzdWJzY3JpcHRpb24ucmVhY3RpdmF0ZWQnLCB7XG4gICAgICB1c2VySWQsXG4gICAgICBzdWJzY3JpcHRpb25JZDogc3Vic2NyaXB0aW9uLmlkLFxuICAgIH0pO1xuXG4gICAgdGhpcy5sb2dnZXIubG9nKFxuICAgICAgYFN1YnNjcmlwdGlvbiAke3N1YnNjcmlwdGlvbi5pZH0gcmVhY3RpdmF0ZWQgZm9yIHVzZXIgJHt1c2VySWR9YCxcbiAgICApO1xuXG4gICAgcmV0dXJuIHVwZGF0ZWRTdWJzY3JpcHRpb247XG4gIH1cblxuICAvKipcbiAgICogQXBwbHkgZGlzY291bnQgdG8gc3Vic2NyaXB0aW9uXG4gICAqL1xuICBhc3luYyBhcHBseURpc2NvdW50VG9TdWJzY3JpcHRpb24odXNlcklkOiBzdHJpbmcsIGRpc2NvdW50Q29kZTogc3RyaW5nKSB7XG4gICAgY29uc3Qgc3Vic2NyaXB0aW9uID0gYXdhaXQgdGhpcy5maW5kVXNlclN1YnNjcmlwdGlvbih1c2VySWQpO1xuICAgIGlmICghc3Vic2NyaXB0aW9uKSB7XG4gICAgICB0aHJvdyBuZXcgTm90Rm91bmRFeGNlcHRpb24oYFN1YnNjcmlwdGlvbiBmb3IgdXNlciAke3VzZXJJZH0gbm90IGZvdW5kYCk7XG4gICAgfVxuXG4gICAgY29uc3QgZGlzY291bnQgPSBhd2FpdCB0aGlzLnZhbGlkYXRlRGlzY291bnQoXG4gICAgICBkaXNjb3VudENvZGUsXG4gICAgICB1c2VySWQsXG4gICAgICBOdW1iZXIoc3Vic2NyaXB0aW9uLmFtb3VudCksXG4gICAgKTtcblxuICAgIC8vIENhbGN1bGF0ZSBkaXNjb3VudCBhbW91bnRcbiAgICBsZXQgZGlzY291bnRBbW91bnQgPSAwO1xuICAgIGlmIChkaXNjb3VudC50eXBlID09PSBEaXNjb3VudFR5cGUuUEVSQ0VOVEFHRSAmJiBkaXNjb3VudC5wZXJjZW50T2ZmKSB7XG4gICAgICBkaXNjb3VudEFtb3VudCA9XG4gICAgICAgIE51bWJlcihzdWJzY3JpcHRpb24uYW1vdW50KSAqIChOdW1iZXIoZGlzY291bnQucGVyY2VudE9mZikgLyAxMDApO1xuICAgIH0gZWxzZSBpZiAoXG4gICAgICBkaXNjb3VudC50eXBlID09PSBEaXNjb3VudFR5cGUuRklYRURfQU1PVU5UICYmXG4gICAgICBkaXNjb3VudC5hbW91bnRPZmZcbiAgICApIHtcbiAgICAgIGRpc2NvdW50QW1vdW50ID0gTnVtYmVyKGRpc2NvdW50LmFtb3VudE9mZik7XG4gICAgfVxuXG4gICAgY29uc3QgbmV3QW1vdW50ID0gTWF0aC5tYXgoMCwgTnVtYmVyKHN1YnNjcmlwdGlvbi5hbW91bnQpIC0gZGlzY291bnRBbW91bnQpO1xuXG4gICAgcmV0dXJuIGF3YWl0IHRoaXMucHJpc21hLiR0cmFuc2FjdGlvbihhc3luYyAodHgpID0+IHtcbiAgICAgIC8vIFVwZGF0ZSBzdWJzY3JpcHRpb24gYW1vdW50XG4gICAgICBjb25zdCB1cGRhdGVkU3Vic2NyaXB0aW9uID0gYXdhaXQgdHguc3Vic2NyaXB0aW9uLnVwZGF0ZSh7XG4gICAgICAgIHdoZXJlOiB7IHVzZXJJZCB9LFxuICAgICAgICBkYXRhOiB7XG4gICAgICAgICAgYW1vdW50OiBuZXdBbW91bnQsXG4gICAgICAgICAgbWV0YWRhdGE6IHtcbiAgICAgICAgICAgIC4uLih0eXBlb2Ygc3Vic2NyaXB0aW9uLm1ldGFkYXRhID09PSAnb2JqZWN0JyAmJlxuICAgICAgICAgICAgc3Vic2NyaXB0aW9uLm1ldGFkYXRhICE9PSBudWxsXG4gICAgICAgICAgICAgID8gKHN1YnNjcmlwdGlvbi5tZXRhZGF0YSBhcyBSZWNvcmQ8c3RyaW5nLCBhbnk+KVxuICAgICAgICAgICAgICA6IHt9KSxcbiAgICAgICAgICAgIGFwcGxpZWREaXNjb3VudHM6IFtcbiAgICAgICAgICAgICAgLi4uKChzdWJzY3JpcHRpb24ubWV0YWRhdGEgYXMgYW55KT8uYXBwbGllZERpc2NvdW50cyB8fCBbXSksXG4gICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICBkaXNjb3VudElkOiBkaXNjb3VudC5pZCxcbiAgICAgICAgICAgICAgICBjb2RlOiBkaXNjb3VudENvZGUsXG4gICAgICAgICAgICAgICAgYXBwbGllZEF0OiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksXG4gICAgICAgICAgICAgICAgb3JpZ2luYWxBbW91bnQ6IHN1YnNjcmlwdGlvbi5hbW91bnQsXG4gICAgICAgICAgICAgICAgZGlzY291bnRBbW91bnQsXG4gICAgICAgICAgICAgICAgbmV3QW1vdW50LFxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgXSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgICBpbmNsdWRlOiB7XG4gICAgICAgICAgcGxhbjogdHJ1ZSxcbiAgICAgICAgICBkZWZhdWx0UGF5bWVudE1ldGhvZDogdHJ1ZSxcbiAgICAgICAgfSxcbiAgICAgIH0pO1xuXG4gICAgICAvLyBSZWNvcmQgZGlzY291bnQgcmVkZW1wdGlvblxuICAgICAgYXdhaXQgdGhpcy5yZWRlZW1EaXNjb3VudChkaXNjb3VudC5pZCwgdXNlcklkLCBkaXNjb3VudEFtb3VudCk7XG5cbiAgICAgIHRoaXMuZXZlbnRFbWl0dGVyLmVtaXQoJ3N1YnNjcmlwdGlvbi5kaXNjb3VudC5hcHBsaWVkJywge1xuICAgICAgICB1c2VySWQsXG4gICAgICAgIHN1YnNjcmlwdGlvbklkOiBzdWJzY3JpcHRpb24uaWQsXG4gICAgICAgIGRpc2NvdW50Q29kZSxcbiAgICAgICAgZGlzY291bnRBbW91bnQsXG4gICAgICAgIG5ld0Ftb3VudCxcbiAgICAgIH0pO1xuXG4gICAgICByZXR1cm4gdXBkYXRlZFN1YnNjcmlwdGlvbjtcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBQcm9jZXNzIHN1YnNjcmlwdGlvbiByZW5ld2FsXG4gICAqL1xuICBhc3luYyBwcm9jZXNzU3Vic2NyaXB0aW9uUmVuZXdhbChzdWJzY3JpcHRpb25JZDogc3RyaW5nKSB7XG4gICAgY29uc3Qgc3Vic2NyaXB0aW9uID0gYXdhaXQgdGhpcy5wcmlzbWEuc3Vic2NyaXB0aW9uLmZpbmRVbmlxdWUoe1xuICAgICAgd2hlcmU6IHsgaWQ6IHN1YnNjcmlwdGlvbklkIH0sXG4gICAgICBpbmNsdWRlOiB7XG4gICAgICAgIHBsYW46IHRydWUsXG4gICAgICAgIGRlZmF1bHRQYXltZW50TWV0aG9kOiB0cnVlLFxuICAgICAgICB1c2VyOiB0cnVlLFxuICAgICAgfSxcbiAgICB9KTtcblxuICAgIGlmICghc3Vic2NyaXB0aW9uKSB7XG4gICAgICB0aHJvdyBuZXcgTm90Rm91bmRFeGNlcHRpb24oYFN1YnNjcmlwdGlvbiAke3N1YnNjcmlwdGlvbklkfSBub3QgZm91bmRgKTtcbiAgICB9XG5cbiAgICAvLyBDaGVjayBpZiByZW5ld2FsIGlzIGR1ZVxuICAgIGNvbnN0IG5vdyA9IG5ldyBEYXRlKCk7XG4gICAgaWYgKHN1YnNjcmlwdGlvbi5jdXJyZW50UGVyaW9kRW5kID4gbm93KSB7XG4gICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdEV4Y2VwdGlvbignU3Vic2NyaXB0aW9uIHJlbmV3YWwgbm90IHlldCBkdWUnKTtcbiAgICB9XG5cbiAgICByZXR1cm4gYXdhaXQgdGhpcy5wcmlzbWEuJHRyYW5zYWN0aW9uKGFzeW5jICh0eCkgPT4ge1xuICAgICAgLy8gQ3JlYXRlIGludm9pY2UgZm9yIG5leHQgcGVyaW9kXG4gICAgICBjb25zdCBuZXh0UGVyaW9kU3RhcnQgPSBzdWJzY3JpcHRpb24uY3VycmVudFBlcmlvZEVuZDtcbiAgICAgIGNvbnN0IG5leHRQZXJpb2RFbmQgPSBuZXcgRGF0ZShuZXh0UGVyaW9kU3RhcnQpO1xuXG4gICAgICBpZiAoc3Vic2NyaXB0aW9uLmJpbGxpbmdDeWNsZSA9PT0gQmlsbGluZ0N5Y2xlLllFQVJMWSkge1xuICAgICAgICBuZXh0UGVyaW9kRW5kLnNldEZ1bGxZZWFyKG5leHRQZXJpb2RFbmQuZ2V0RnVsbFllYXIoKSArIDEpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgbmV4dFBlcmlvZEVuZC5zZXRNb250aChuZXh0UGVyaW9kRW5kLmdldE1vbnRoKCkgKyAxKTtcbiAgICAgIH1cblxuICAgICAgY29uc3QgaW52b2ljZSA9IGF3YWl0IHRoaXMuY3JlYXRlSW52b2ljZSh7XG4gICAgICAgIHN1YnNjcmlwdGlvbklkLFxuICAgICAgICBzdWJ0b3RhbDogTnVtYmVyKHN1YnNjcmlwdGlvbi5hbW91bnQpLFxuICAgICAgICBkdWVEYXRlOiBuZXh0UGVyaW9kU3RhcnQsXG4gICAgICB9KTtcblxuICAgICAgLy8gVXBkYXRlIHN1YnNjcmlwdGlvbiBwZXJpb2RcbiAgICAgIGNvbnN0IHVwZGF0ZWRTdWJzY3JpcHRpb24gPSBhd2FpdCB0eC5zdWJzY3JpcHRpb24udXBkYXRlKHtcbiAgICAgICAgd2hlcmU6IHsgaWQ6IHN1YnNjcmlwdGlvbklkIH0sXG4gICAgICAgIGRhdGE6IHtcbiAgICAgICAgICBjdXJyZW50UGVyaW9kU3RhcnQ6IG5leHRQZXJpb2RTdGFydCxcbiAgICAgICAgICBjdXJyZW50UGVyaW9kRW5kOiBuZXh0UGVyaW9kRW5kLFxuICAgICAgICAgIG1ldGFkYXRhOiB7XG4gICAgICAgICAgICAuLi4odHlwZW9mIHN1YnNjcmlwdGlvbi5tZXRhZGF0YSA9PT0gJ29iamVjdCcgJiZcbiAgICAgICAgICAgIHN1YnNjcmlwdGlvbi5tZXRhZGF0YSAhPT0gbnVsbFxuICAgICAgICAgICAgICA/IChzdWJzY3JpcHRpb24ubWV0YWRhdGEgYXMgUmVjb3JkPHN0cmluZywgYW55PilcbiAgICAgICAgICAgICAgOiB7fSksXG4gICAgICAgICAgICBsYXN0UmVuZXdhbDogbm93LnRvSVNPU3RyaW5nKCksXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgICAgaW5jbHVkZToge1xuICAgICAgICAgIHBsYW46IHRydWUsXG4gICAgICAgICAgZGVmYXVsdFBheW1lbnRNZXRob2Q6IHRydWUsXG4gICAgICAgIH0sXG4gICAgICB9KTtcblxuICAgICAgdGhpcy5ldmVudEVtaXR0ZXIuZW1pdCgnc3Vic2NyaXB0aW9uLnJlbmV3ZWQnLCB7XG4gICAgICAgIHVzZXJJZDogc3Vic2NyaXB0aW9uLnVzZXJJZCxcbiAgICAgICAgc3Vic2NyaXB0aW9uSWQsXG4gICAgICAgIGludm9pY2VJZDogaW52b2ljZS5pZCxcbiAgICAgICAgbmV4dFBlcmlvZFN0YXJ0LFxuICAgICAgICBuZXh0UGVyaW9kRW5kLFxuICAgICAgfSk7XG5cbiAgICAgIHJldHVybiB7IHN1YnNjcmlwdGlvbjogdXBkYXRlZFN1YnNjcmlwdGlvbiwgaW52b2ljZSB9O1xuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCBzdWJzY3JpcHRpb24gdXNhZ2UgYW5hbHl0aWNzXG4gICAqL1xuICBhc3luYyBnZXRTdWJzY3JpcHRpb25Vc2FnZUFuYWx5dGljcyhcbiAgICBzdWJzY3JpcHRpb25JZDogc3RyaW5nLFxuICAgIHN0YXJ0RGF0ZT86IERhdGUsXG4gICAgZW5kRGF0ZT86IERhdGUsXG4gICkge1xuICAgIGNvbnN0IHN1YnNjcmlwdGlvbiA9IGF3YWl0IHRoaXMucHJpc21hLnN1YnNjcmlwdGlvbi5maW5kVW5pcXVlKHtcbiAgICAgIHdoZXJlOiB7IGlkOiBzdWJzY3JpcHRpb25JZCB9LFxuICAgICAgaW5jbHVkZTogeyBwbGFuOiB0cnVlIH0sXG4gICAgfSk7XG5cbiAgICBpZiAoIXN1YnNjcmlwdGlvbikge1xuICAgICAgdGhyb3cgbmV3IE5vdEZvdW5kRXhjZXB0aW9uKGBTdWJzY3JpcHRpb24gJHtzdWJzY3JpcHRpb25JZH0gbm90IGZvdW5kYCk7XG4gICAgfVxuXG4gICAgY29uc3Qgd2hlcmU6IGFueSA9IHsgc3Vic2NyaXB0aW9uSWQgfTtcbiAgICBpZiAoc3RhcnREYXRlKSB3aGVyZS51c2FnZURhdGUgPSB7IC4uLndoZXJlLnVzYWdlRGF0ZSwgZ3RlOiBzdGFydERhdGUgfTtcbiAgICBpZiAoZW5kRGF0ZSkgd2hlcmUudXNhZ2VEYXRlID0geyAuLi53aGVyZS51c2FnZURhdGUsIGx0ZTogZW5kRGF0ZSB9O1xuXG4gICAgY29uc3QgW3VzYWdlUmVjb3JkcywgdXNhZ2VCeUZlYXR1cmUsIHRvdGFsVXNhZ2VdID0gYXdhaXQgUHJvbWlzZS5hbGwoW1xuICAgICAgdGhpcy5wcmlzbWEudXNhZ2VSZWNvcmQuZmluZE1hbnkoe1xuICAgICAgICB3aGVyZSxcbiAgICAgICAgb3JkZXJCeTogeyB1c2FnZURhdGU6ICdkZXNjJyB9LFxuICAgICAgICB0YWtlOiAxMDAsXG4gICAgICB9KSxcbiAgICAgIHRoaXMucHJpc21hLnVzYWdlUmVjb3JkLmdyb3VwQnkoe1xuICAgICAgICBieTogWydmZWF0dXJlJ10sXG4gICAgICAgIHdoZXJlLFxuICAgICAgICBfc3VtOiB7IHF1YW50aXR5OiB0cnVlIH0sXG4gICAgICAgIF9jb3VudDogeyBxdWFudGl0eTogdHJ1ZSB9LFxuICAgICAgfSksXG4gICAgICB0aGlzLnByaXNtYS51c2FnZVJlY29yZC5hZ2dyZWdhdGUoe1xuICAgICAgICB3aGVyZSxcbiAgICAgICAgX3N1bTogeyBxdWFudGl0eTogdHJ1ZSB9LFxuICAgICAgICBfY291bnQ6IHsgcXVhbnRpdHk6IHRydWUgfSxcbiAgICAgIH0pLFxuICAgIF0pO1xuXG4gICAgY29uc3QgcGxhbkxpbWl0cyA9IHN1YnNjcmlwdGlvbi5wbGFuLmxpbWl0cyBhcyBhbnk7XG5cbiAgICByZXR1cm4ge1xuICAgICAgc3Vic2NyaXB0aW9uLFxuICAgICAgdXNhZ2VSZWNvcmRzLFxuICAgICAgdXNhZ2VCeUZlYXR1cmU6IHVzYWdlQnlGZWF0dXJlLm1hcCgodXNhZ2UpID0+ICh7XG4gICAgICAgIGZlYXR1cmU6IHVzYWdlLmZlYXR1cmUsXG4gICAgICAgIHRvdGFsUXVhbnRpdHk6IHVzYWdlLl9zdW0ucXVhbnRpdHkgfHwgMCxcbiAgICAgICAgcmVjb3JkQ291bnQ6IHVzYWdlLl9jb3VudC5xdWFudGl0eSxcbiAgICAgICAgbGltaXQ6IHBsYW5MaW1pdHM/Llt1c2FnZS5mZWF0dXJlXSB8fCBudWxsLFxuICAgICAgICB1dGlsaXphdGlvblBlcmNlbnRhZ2U6IHBsYW5MaW1pdHM/Llt1c2FnZS5mZWF0dXJlXVxuICAgICAgICAgID8gKCh1c2FnZS5fc3VtLnF1YW50aXR5IHx8IDApIC8gcGxhbkxpbWl0c1t1c2FnZS5mZWF0dXJlXSkgKiAxMDBcbiAgICAgICAgICA6IG51bGwsXG4gICAgICB9KSksXG4gICAgICB0b3RhbFVzYWdlOiB7XG4gICAgICAgIHRvdGFsUXVhbnRpdHk6IHRvdGFsVXNhZ2UuX3N1bS5xdWFudGl0eSB8fCAwLFxuICAgICAgICB0b3RhbFJlY29yZHM6IHRvdGFsVXNhZ2UuX2NvdW50LnF1YW50aXR5LFxuICAgICAgfSxcbiAgICB9O1xuICB9XG5cbiAgLy8gPT09PT0gUFJJVkFURSBIRUxQRVIgTUVUSE9EUyA9PT09PVxuXG4gIHByaXZhdGUgYXN5bmMgY2FsY3VsYXRlUHJvcmF0aW9uKFxuICAgIHN1YnNjcmlwdGlvbjogYW55LFxuICAgIG5ld0Ftb3VudDogbnVtYmVyLFxuICAgIGVmZmVjdGl2ZURhdGU6IERhdGUsXG4gICk6IFByb21pc2U8bnVtYmVyPiB7XG4gICAgY29uc3QgY3VycmVudEFtb3VudCA9IE51bWJlcihzdWJzY3JpcHRpb24uYW1vdW50KTtcbiAgICBjb25zdCBwZXJpb2RTdGFydCA9IHN1YnNjcmlwdGlvbi5jdXJyZW50UGVyaW9kU3RhcnQ7XG4gICAgY29uc3QgcGVyaW9kRW5kID0gc3Vic2NyaXB0aW9uLmN1cnJlbnRQZXJpb2RFbmQ7XG5cbiAgICBjb25zdCB0b3RhbFBlcmlvZERheXMgPSBNYXRoLmNlaWwoXG4gICAgICAocGVyaW9kRW5kLmdldFRpbWUoKSAtIHBlcmlvZFN0YXJ0LmdldFRpbWUoKSkgLyAoMTAwMCAqIDYwICogNjAgKiAyNCksXG4gICAgKTtcbiAgICBjb25zdCByZW1haW5pbmdEYXlzID0gTWF0aC5jZWlsKFxuICAgICAgKHBlcmlvZEVuZC5nZXRUaW1lKCkgLSBlZmZlY3RpdmVEYXRlLmdldFRpbWUoKSkgLyAoMTAwMCAqIDYwICogNjAgKiAyNCksXG4gICAgKTtcblxuICAgIGlmIChyZW1haW5pbmdEYXlzIDw9IDApIHJldHVybiAwO1xuXG4gICAgY29uc3QgZGFpbHlDdXJyZW50UmF0ZSA9IGN1cnJlbnRBbW91bnQgLyB0b3RhbFBlcmlvZERheXM7XG4gICAgY29uc3QgZGFpbHlOZXdSYXRlID0gbmV3QW1vdW50IC8gdG90YWxQZXJpb2REYXlzO1xuXG4gICAgY29uc3QgcHJvcmF0aW9uQW1vdW50ID0gKGRhaWx5TmV3UmF0ZSAtIGRhaWx5Q3VycmVudFJhdGUpICogcmVtYWluaW5nRGF5cztcblxuICAgIHJldHVybiBNYXRoLnJvdW5kKHByb3JhdGlvbkFtb3VudCAqIDEwMCkgLyAxMDA7IC8vIFJvdW5kIHRvIDIgZGVjaW1hbCBwbGFjZXNcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgY3JlYXRlUHJvcmF0aW9uSW52b2ljZShcbiAgICB0eDogYW55LFxuICAgIHN1YnNjcmlwdGlvbklkOiBzdHJpbmcsXG4gICAgcHJvcmF0aW9uQW1vdW50OiBudW1iZXIsXG4gICAgZWZmZWN0aXZlRGF0ZTogRGF0ZSxcbiAgKSB7XG4gICAgaWYgKHByb3JhdGlvbkFtb3VudCA9PT0gMCkgcmV0dXJuO1xuXG4gICAgY29uc3QgaW52b2ljZU51bWJlciA9IGF3YWl0IHRoaXMuZ2VuZXJhdGVJbnZvaWNlTnVtYmVyKCk7XG4gICAgY29uc3QgZGVzY3JpcHRpb24gPVxuICAgICAgcHJvcmF0aW9uQW1vdW50ID4gMFxuICAgICAgICA/ICdQcm9yYXRpb24gY2hhcmdlIGZvciBwbGFuIHVwZ3JhZGUnXG4gICAgICAgIDogJ1Byb3JhdGlvbiBjcmVkaXQgZm9yIHBsYW4gZG93bmdyYWRlJztcblxuICAgIHJldHVybiBhd2FpdCB0eC5pbnZvaWNlLmNyZWF0ZSh7XG4gICAgICBkYXRhOiB7XG4gICAgICAgIHN1YnNjcmlwdGlvbklkLFxuICAgICAgICBudW1iZXI6IGludm9pY2VOdW1iZXIsXG4gICAgICAgIHN0YXR1czogSW52b2ljZVN0YXR1cy5PUEVOLFxuICAgICAgICBzdWJ0b3RhbDogTWF0aC5hYnMocHJvcmF0aW9uQW1vdW50KSxcbiAgICAgICAgdG90YWw6IE1hdGguYWJzKHByb3JhdGlvbkFtb3VudCksXG4gICAgICAgIGFtb3VudER1ZTogcHJvcmF0aW9uQW1vdW50ID4gMCA/IHByb3JhdGlvbkFtb3VudCA6IDAsXG4gICAgICAgIGR1ZURhdGU6IGVmZmVjdGl2ZURhdGUsXG4gICAgICAgIGxpbmVJdGVtczoge1xuICAgICAgICAgIGNyZWF0ZToge1xuICAgICAgICAgICAgZGVzY3JpcHRpb24sXG4gICAgICAgICAgICBxdWFudGl0eTogMSxcbiAgICAgICAgICAgIHVuaXRQcmljZTogcHJvcmF0aW9uQW1vdW50LFxuICAgICAgICAgICAgYW1vdW50OiBwcm9yYXRpb25BbW91bnQsXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgIH0sXG4gICAgfSk7XG4gIH1cbn1cbiJdLCJ2ZXJzaW9uIjozfQ==