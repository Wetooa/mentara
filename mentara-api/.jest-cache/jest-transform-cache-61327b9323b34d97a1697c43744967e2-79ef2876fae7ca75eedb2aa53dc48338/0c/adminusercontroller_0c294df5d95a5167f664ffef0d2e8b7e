899f1a67f203d9d3fe62392dea9d7760
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var __param = (this && this.__param) || function (paramIndex, decorator) {
    return function (target, key) { decorator(target, key, paramIndex); }
};
var AdminUserController_1;
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
exports.AdminUserController = void 0;
const common_1 = require("@nestjs/common");
const admin_service_1 = require("../admin.service");
const jwt_auth_guard_1 = require("../../auth/guards/jwt-auth.guard");
const current_user_id_decorator_1 = require("../../auth/decorators/current-user-id.decorator");
const current_user_role_decorator_1 = require("../../auth/decorators/current-user-role.decorator");
const zod_validation_pipe_1 = require("../../common/pipes/zod-validation.pipe");
const admin_schemas_1 = require("../validation/admin.schemas");
let AdminUserController = AdminUserController_1 = class AdminUserController {
    adminService;
    logger = new common_1.Logger(AdminUserController_1.name);
    constructor(adminService) {
        this.adminService = adminService;
    }
    async getAllUsers(currentUserId, role, query) {
        if (role !== 'admin') {
            throw new common_1.ForbiddenException('Admin access required');
        }
        try {
            this.logger.log(`Admin ${currentUserId} retrieving users`);
            return await this.adminService.getAllUsers({
                role: query.role,
                page: query.page || 1,
                limit: query.limit || 10,
                search: query.search,
                status: query.status,
                sortBy: query.sortBy,
                sortOrder: query.sortOrder,
            });
        }
        catch (error) {
            this.logger.error('Failed to retrieve users:', error);
            throw new common_1.HttpException('Failed to retrieve users', common_1.HttpStatus.INTERNAL_SERVER_ERROR);
        }
    }
    async getUser(currentUserId, role, userId) {
        if (role !== 'admin') {
            throw new common_1.ForbiddenException('Admin access required');
        }
        try {
            this.logger.log(`Admin ${currentUserId} retrieving user ${userId}`);
            const user = await this.adminService.getUser(userId);
            if (!user) {
                throw new common_1.HttpException('User not found', common_1.HttpStatus.NOT_FOUND);
            }
            return user;
        }
        catch (error) {
            if (error instanceof common_1.HttpException) {
                throw error;
            }
            this.logger.error('Failed to retrieve user:', error);
            throw new common_1.HttpException('Failed to retrieve user', common_1.HttpStatus.INTERNAL_SERVER_ERROR);
        }
    }
    async suspendUser(currentUserId, role, userId, suspensionData) {
        if (role !== 'admin') {
            throw new common_1.ForbiddenException('Admin access required');
        }
        try {
            this.logger.log(`Admin ${currentUserId} suspending user ${userId}`);
            return await this.adminService.suspendUser(userId, currentUserId, suspensionData.reason, suspensionData.duration);
        }
        catch (error) {
            this.logger.error('Failed to suspend user:', error);
            throw new common_1.HttpException('Failed to suspend user', common_1.HttpStatus.INTERNAL_SERVER_ERROR);
        }
    }
    async unsuspendUser(currentUserId, role, userId) {
        if (role !== 'admin') {
            throw new common_1.ForbiddenException('Admin access required');
        }
        try {
            this.logger.log(`Admin ${currentUserId} unsuspending user ${userId}`);
            return await this.adminService.unsuspendUser(userId, currentUserId);
        }
        catch (error) {
            this.logger.error('Failed to unsuspend user:', error);
            throw new common_1.HttpException('Failed to unsuspend user', common_1.HttpStatus.INTERNAL_SERVER_ERROR);
        }
    }
};
exports.AdminUserController = AdminUserController;
__decorate([
    (0, common_1.Get)(),
    __param(0, (0, current_user_id_decorator_1.CurrentUserId)()),
    __param(1, (0, current_user_role_decorator_1.CurrentUserRole)()),
    __param(2, (0, common_1.Query)(new zod_validation_pipe_1.ZodValidationPipe(admin_schemas_1.AdminUserQuerySchema))),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [String, String, Object]),
    __metadata("design:returntype", Promise)
], AdminUserController.prototype, "getAllUsers", null);
__decorate([
    (0, common_1.Get)(':id'),
    __param(0, (0, current_user_id_decorator_1.CurrentUserId)()),
    __param(1, (0, current_user_role_decorator_1.CurrentUserRole)()),
    __param(2, (0, common_1.Param)('id')),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [String, String, String]),
    __metadata("design:returntype", Promise)
], AdminUserController.prototype, "getUser", null);
__decorate([
    (0, common_1.Put)(':id/suspend'),
    __param(0, (0, current_user_id_decorator_1.CurrentUserId)()),
    __param(1, (0, current_user_role_decorator_1.CurrentUserRole)()),
    __param(2, (0, common_1.Param)('id')),
    __param(3, (0, common_1.Body)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [String, String, String, Object]),
    __metadata("design:returntype", Promise)
], AdminUserController.prototype, "suspendUser", null);
__decorate([
    (0, common_1.Put)(':id/unsuspend'),
    __param(0, (0, current_user_id_decorator_1.CurrentUserId)()),
    __param(1, (0, current_user_role_decorator_1.CurrentUserRole)()),
    __param(2, (0, common_1.Param)('id')),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [String, String, String]),
    __metadata("design:returntype", Promise)
], AdminUserController.prototype, "unsuspendUser", null);
exports.AdminUserController = AdminUserController = AdminUserController_1 = __decorate([
    (0, common_1.Controller)('admin/users'),
    (0, common_1.UseGuards)(jwt_auth_guard_1.JwtAuthGuard),
    __metadata("design:paramtypes", [typeof (_a = typeof admin_service_1.AdminService !== "undefined" && admin_service_1.AdminService) === "function" ? _a : Object])
], AdminUserController);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvd2V0b29hL0RvY3VtZW50cy9jb2RlL3Byb2plY3RzL21lbnRhcmEvbWVudGFyYS1hcGkvc3JjL2FkbWluL2NvbnRyb2xsZXJzL2FkbWluLXVzZXIuY29udHJvbGxlci50cyIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLDJDQVl3QjtBQUN4QixvREFBZ0Q7QUFDaEQscUVBQWdFO0FBQ2hFLCtGQUFnRjtBQUNoRixtR0FBb0Y7QUFDcEYsZ0ZBQTJFO0FBQzNFLCtEQUFtRTtBQUs1RCxJQUFNLG1CQUFtQiwyQkFBekIsTUFBTSxtQkFBbUI7SUFHRDtJQUZaLE1BQU0sR0FBRyxJQUFJLGVBQU0sQ0FBQyxxQkFBbUIsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUUvRCxZQUE2QixZQUEwQjtRQUExQixpQkFBWSxHQUFaLFlBQVksQ0FBYztJQUFHLENBQUM7SUFHckQsQUFBTixLQUFLLENBQUMsV0FBVyxDQUNFLGFBQXFCLEVBQ25CLElBQVksRUFDcUIsS0FBcUI7UUFFekUsSUFBSSxJQUFJLEtBQUssT0FBTyxFQUFFLENBQUM7WUFDckIsTUFBTSxJQUFJLDJCQUFrQixDQUFDLHVCQUF1QixDQUFDLENBQUM7UUFDeEQsQ0FBQztRQUNELElBQUksQ0FBQztZQUNILElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLFNBQVMsYUFBYSxtQkFBbUIsQ0FBQyxDQUFDO1lBRTNELE9BQU8sTUFBTSxJQUFJLENBQUMsWUFBWSxDQUFDLFdBQVcsQ0FBQztnQkFDekMsSUFBSSxFQUFFLEtBQUssQ0FBQyxJQUFJO2dCQUNoQixJQUFJLEVBQUUsS0FBSyxDQUFDLElBQUksSUFBSSxDQUFDO2dCQUNyQixLQUFLLEVBQUUsS0FBSyxDQUFDLEtBQUssSUFBSSxFQUFFO2dCQUN4QixNQUFNLEVBQUUsS0FBSyxDQUFDLE1BQU07Z0JBQ3BCLE1BQU0sRUFBRSxLQUFLLENBQUMsTUFBTTtnQkFDcEIsTUFBTSxFQUFFLEtBQUssQ0FBQyxNQUFNO2dCQUNwQixTQUFTLEVBQUUsS0FBSyxDQUFD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QkFBWiw0QkFBWTtHQUg1QyxtQkFBbUIsQ0FnSC9CIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9ob21lL3dldG9vYS9Eb2N1bWVudHMvY29kZS9wcm9qZWN0cy9tZW50YXJhL21lbnRhcmEtYXBpL3NyYy9hZG1pbi9jb250cm9sbGVycy9hZG1pbi11c2VyLmNvbnRyb2xsZXIudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgQ29udHJvbGxlcixcbiAgR2V0LFxuICBQdXQsXG4gIFVzZUd1YXJkcyxcbiAgSHR0cEV4Y2VwdGlvbixcbiAgSHR0cFN0YXR1cyxcbiAgTG9nZ2VyLFxuICBRdWVyeSxcbiAgUGFyYW0sXG4gIEJvZHksXG4gIEZvcmJpZGRlbkV4Y2VwdGlvbixcbn0gZnJvbSAnQG5lc3Rqcy9jb21tb24nO1xuaW1wb3J0IHsgQWRtaW5TZXJ2aWNlIH0gZnJvbSAnLi4vYWRtaW4uc2VydmljZSc7XG5pbXBvcnQgeyBKd3RBdXRoR3VhcmQgfSBmcm9tICcuLi8uLi9hdXRoL2d1YXJkcy9qd3QtYXV0aC5ndWFyZCc7XG5pbXBvcnQgeyBDdXJyZW50VXNlcklkIH0gZnJvbSAnLi4vLi4vYXV0aC9kZWNvcmF0b3JzL2N1cnJlbnQtdXNlci1pZC5kZWNvcmF0b3InO1xuaW1wb3J0IHsgQ3VycmVudFVzZXJSb2xlIH0gZnJvbSAnLi4vLi4vYXV0aC9kZWNvcmF0b3JzL2N1cnJlbnQtdXNlci1yb2xlLmRlY29yYXRvcic7XG5pbXBvcnQgeyBab2RWYWxpZGF0aW9uUGlwZSB9IGZyb20gJy4uLy4uL2NvbW1vbi9waXBlcy96b2QtdmFsaWRhdGlvbi5waXBlJztcbmltcG9ydCB7IEFkbWluVXNlclF1ZXJ5U2NoZW1hIH0gZnJvbSAnLi4vdmFsaWRhdGlvbi9hZG1pbi5zY2hlbWFzJztcbmltcG9ydCB0eXBlIHsgQWRtaW5Vc2VyUXVlcnkgfSBmcm9tICcuLi90eXBlcyc7XG5cbkBDb250cm9sbGVyKCdhZG1pbi91c2VycycpXG5AVXNlR3VhcmRzKEp3dEF1dGhHdWFyZClcbmV4cG9ydCBjbGFzcyBBZG1pblVzZXJDb250cm9sbGVyIHtcbiAgcHJpdmF0ZSByZWFkb25seSBsb2dnZXIgPSBuZXcgTG9nZ2VyKEFkbWluVXNlckNvbnRyb2xsZXIubmFtZSk7XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSByZWFkb25seSBhZG1pblNlcnZpY2U6IEFkbWluU2VydmljZSkge31cblxuICBAR2V0KClcbiAgYXN5bmMgZ2V0QWxsVXNlcnMoXG4gICAgQEN1cnJlbnRVc2VySWQoKSBjdXJyZW50VXNlcklkOiBzdHJpbmcsXG4gICAgQEN1cnJlbnRVc2VyUm9sZSgpIHJvbGU6IHN0cmluZyxcbiAgICBAUXVlcnkobmV3IFpvZFZhbGlkYXRpb25QaXBlKEFkbWluVXNlclF1ZXJ5U2NoZW1hKSkgcXVlcnk6IEFkbWluVXNlclF1ZXJ5LFxuICApIHtcbiAgICBpZiAocm9sZSAhPT0gJ2FkbWluJykge1xuICAgICAgdGhyb3cgbmV3IEZvcmJpZGRlbkV4Y2VwdGlvbignQWRtaW4gYWNjZXNzIHJlcXVpcmVkJyk7XG4gICAgfVxuICAgIHRyeSB7XG4gICAgICB0aGlzLmxvZ2dlci5sb2coYEFkbWluICR7Y3VycmVudFVzZXJJZH0gcmV0cmlldmluZyB1c2Vyc2ApO1xuXG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy5hZG1pblNlcnZpY2UuZ2V0QWxsVXNlcnMoe1xuICAgICAgICByb2xlOiBxdWVyeS5yb2xlLFxuICAgICAgICBwYWdlOiBxdWVyeS5wYWdlIHx8IDEsXG4gICAgICAgIGxpbWl0OiBxdWVyeS5saW1pdCB8fCAxMCxcbiAgICAgICAgc2VhcmNoOiBxdWVyeS5zZWFyY2gsXG4gICAgICAgIHN0YXR1czogcXVlcnkuc3RhdHVzLFxuICAgICAgICBzb3J0Qnk6IHF1ZXJ5LnNvcnRCeSxcbiAgICAgICAgc29ydE9yZGVyOiBxdWVyeS5zb3J0T3JkZXIsXG4gICAgICB9KTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoJ0ZhaWxlZCB0byByZXRyaWV2ZSB1c2VyczonLCBlcnJvcik7XG4gICAgICB0aHJvdyBuZXcgSHR0cEV4Y2VwdGlvbihcbiAgICAgICAgJ0ZhaWxlZCB0byByZXRyaWV2ZSB1c2VycycsXG4gICAgICAgIEh0dHBTdGF0dXMuSU5URVJOQUxfU0VSVkVSX0VSUk9SLFxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICBAR2V0KCc6aWQnKVxuICBhc3luYyBnZXRVc2VyKFxuICAgIEBDdXJyZW50VXNlcklkKCkgY3VycmVudFVzZXJJZDogc3RyaW5nLFxuICAgIEBDdXJyZW50VXNlclJvbGUoKSByb2xlOiBzdHJpbmcsXG4gICAgQFBhcmFtKCdpZCcpIHVzZXJJZDogc3RyaW5nLFxuICApIHtcbiAgICBpZiAocm9sZSAhPT0gJ2FkbWluJykge1xuICAgICAgdGhyb3cgbmV3IEZvcmJpZGRlbkV4Y2VwdGlvbignQWRtaW4gYWNjZXNzIHJlcXVpcmVkJyk7XG4gICAgfVxuICAgIHRyeSB7XG4gICAgICB0aGlzLmxvZ2dlci5sb2coYEFkbWluICR7Y3VycmVudFVzZXJJZH0gcmV0cmlldmluZyB1c2VyICR7dXNlcklkfWApO1xuICAgICAgY29uc3QgdXNlciA9IGF3YWl0IHRoaXMuYWRtaW5TZXJ2aWNlLmdldFVzZXIodXNlcklkKTtcblxuICAgICAgaWYgKCF1c2VyKSB7XG4gICAgICAgIHRocm93IG5ldyBIdHRwRXhjZXB0aW9uKCdVc2VyIG5vdCBmb3VuZCcsIEh0dHBTdGF0dXMuTk9UX0ZPVU5EKTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHVzZXI7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGlmIChlcnJvciBpbnN0YW5jZW9mIEh0dHBFeGNlcHRpb24pIHtcbiAgICAgICAgdGhyb3cgZXJyb3I7XG4gICAgICB9XG4gICAgICB0aGlzLmxvZ2dlci5lcnJvcignRmFpbGVkIHRvIHJldHJpZXZlIHVzZXI6JywgZXJyb3IpO1xuICAgICAgdGhyb3cgbmV3IEh0dHBFeGNlcHRpb24oXG4gICAgICAgICdGYWlsZWQgdG8gcmV0cmlldmUgdXNlcicsXG4gICAgICAgIEh0dHBTdGF0dXMuSU5URVJOQUxfU0VSVkVSX0VSUk9SLFxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICBAUHV0KCc6aWQvc3VzcGVuZCcpXG4gIGFzeW5jIHN1c3BlbmRVc2VyKFxuICAgIEBDdXJyZW50VXNlcklkKCkgY3VycmVudFVzZXJJZDogc3RyaW5nLFxuICAgIEBDdXJyZW50VXNlclJvbGUoKSByb2xlOiBzdHJpbmcsXG4gICAgQFBhcmFtKCdpZCcpIHVzZXJJZDogc3RyaW5nLFxuICAgIEBCb2R5KCkgc3VzcGVuc2lvbkRhdGE6IHsgcmVhc29uOiBzdHJpbmc7IGR1cmF0aW9uPzogbnVtYmVyIH0sXG4gICkge1xuICAgIGlmIChyb2xlICE9PSAnYWRtaW4nKSB7XG4gICAgICB0aHJvdyBuZXcgRm9yYmlkZGVuRXhjZXB0aW9uKCdBZG1pbiBhY2Nlc3MgcmVxdWlyZWQnKTtcbiAgICB9XG4gICAgdHJ5IHtcbiAgICAgIHRoaXMubG9nZ2VyLmxvZyhgQWRtaW4gJHtjdXJyZW50VXNlcklkfSBzdXNwZW5kaW5nIHVzZXIgJHt1c2VySWR9YCk7XG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy5hZG1pblNlcnZpY2Uuc3VzcGVuZFVzZXIoXG4gICAgICAgIHVzZXJJZCxcbiAgICAgICAgY3VycmVudFVzZXJJZCxcbiAgICAgICAgc3VzcGVuc2lvbkRhdGEucmVhc29uLFxuICAgICAgICBzdXNwZW5zaW9uRGF0YS5kdXJhdGlvbixcbiAgICAgICk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRoaXMubG9nZ2VyLmVycm9yKCdGYWlsZWQgdG8gc3VzcGVuZCB1c2VyOicsIGVycm9yKTtcbiAgICAgIHRocm93IG5ldyBIdHRwRXhjZXB0aW9uKFxuICAgICAgICAnRmFpbGVkIHRvIHN1c3BlbmQgdXNlcicsXG4gICAgICAgIEh0dHBTdGF0dXMuSU5URVJOQUxfU0VSVkVSX0VSUk9SLFxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICBAUHV0KCc6aWQvdW5zdXNwZW5kJylcbiAgYXN5bmMgdW5zdXNwZW5kVXNlcihcbiAgICBAQ3VycmVudFVzZXJJZCgpIGN1cnJlbnRVc2VySWQ6IHN0cmluZyxcbiAgICBAQ3VycmVudFVzZXJSb2xlKCkgcm9sZTogc3RyaW5nLFxuICAgIEBQYXJhbSgnaWQnKSB1c2VySWQ6IHN0cmluZyxcbiAgKSB7XG4gICAgaWYgKHJvbGUgIT09ICdhZG1pbicpIHtcbiAgICAgIHRocm93IG5ldyBGb3JiaWRkZW5FeGNlcHRpb24oJ0FkbWluIGFjY2VzcyByZXF1aXJlZCcpO1xuICAgIH1cbiAgICB0cnkge1xuICAgICAgdGhpcy5sb2dnZXIubG9nKGBBZG1pbiAke2N1cnJlbnRVc2VySWR9IHVuc3VzcGVuZGluZyB1c2VyICR7dXNlcklkfWApO1xuICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuYWRtaW5TZXJ2aWNlLnVuc3VzcGVuZFVzZXIodXNlcklkLCBjdXJyZW50VXNlcklkKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoJ0ZhaWxlZCB0byB1bnN1c3BlbmQgdXNlcjonLCBlcnJvcik7XG4gICAgICB0aHJvdyBuZXcgSHR0cEV4Y2VwdGlvbihcbiAgICAgICAgJ0ZhaWxlZCB0byB1bnN1c3BlbmQgdXNlcicsXG4gICAgICAgIEh0dHBTdGF0dXMuSU5URVJOQUxfU0VSVkVSX0VSUk9SLFxuICAgICAgKTtcbiAgICB9XG4gIH1cbn1cbiJdLCJ2ZXJzaW9uIjozfQ==